<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë¨õÂ∏´Ë°å‰∫ãÊõÜÊ™¢Ë¶ñ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: rgba(44, 44, 44, 0.9);
            min-height: 100vh;
            color: rgba(51, 51, 51, 0.9);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü */
        .header {
            background: rgba(44, 44, 44, 0.9);
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
        }

        .header h1 {
            color: rgba(255, 193, 7, 1);
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            animation: glow 3s ease-in-out infinite alternate, titleFloat 4s ease-in-out infinite;
            transform: translateY(0);
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin: 0;
        }

        .header-tim-note {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin: 5px 0 0 0;
            font-style: italic;
            animation: gratitudePulse 2s ease-in-out infinite;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex: 1;
            text-align: center;
        }

        .header-logo {
            height: 50px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }



        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

            .user-info span {
                color: rgba(51, 51, 51, 0.9);
                font-weight: 500;
            }

            .user-details {
                align-items: center;
                text-align: center;
            }

            .user-name {
                font-size: 0.9rem;
                margin-bottom: 3px;
            }

            .user-id {
                font-size: 0.7rem;
                padding: 2px 4px;
            }

            .user-info-section {
                margin-top: 20px;
                padding: 15px;
            }

            .user-info-container h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }


        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .user-name {
            color: rgba(51, 51, 51, 0.9);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .user-id {
            color: rgba(102, 102, 102, 0.8);
            font-size: 0.8rem;
            font-family: monospace;
            background: rgba(248, 249, 250, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }

        /* Áî®Êà∂Ë≥áË®äÂçÄÂüü */
        .user-info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .user-info-container h3 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 15px 0;
            text-align: center;
        }

        /* Êó•ÊúüÊôÇÈñìÈ°ØÁ§∫ÂçÄÂüü */
        .datetime-display {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .datetime-item {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255, 223, 102, 0.3);
            text-align: center;
        }

        .datetime-item i {
            font-size: 1.1rem;
        }

        /* ÈÄ≤Â∫¶ÊåáÁ§∫Âô® */
        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .step.active .step-circle {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
        }

        .step.completed .step-circle {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
        }

        .step.pending .step-circle {
            background: rgba(85, 85, 85, 0.9);
            color: rgba(255, 255, 255, 0.9);
        }

        .step-label {
            color: rgba(204, 204, 204, 0.9);
            font-size: 0.9rem;
            text-align: center;
        }

        .step.active .step-label {
            color: rgba(255, 223, 102, 0.9);
        }

        /* ‰∏ªÂÖßÂÆπÂçÄÂüü */
        .main-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .content-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .content-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .content-header i {
            color: rgba(255, 223, 102, 0.9);
            font-size: 1.3rem;
        }

        /* ÊéßÂà∂Èù¢Êùø */
        .controls {
            background: rgba(248, 249, 250, 0.9);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(233, 236, 239, 0.9);
            animation: slideUp 0.8s ease-out;
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            font-size: 0.9rem;
        }

        select, input {
            padding: 10px 12px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: rgba(51, 51, 51, 0.9);
        }

        select:focus, input:focus {
            outline: none;
            border-color: rgba(255, 223, 102, 0.9);
            box-shadow: 0 0 0 3px rgba(255, 223, 102, 0.2);
        }

        /* Ë¶ñÂúñÊåâÈàïÁµÑ */
        .view-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-primary:hover {
            background: rgba(255, 235, 120, 0.9);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 223, 102, 0.4);
        }

        .btn-primary:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }

        .btn-primary.active {
            background: rgba(255, 193, 7, 1);
            border-color: rgba(255, 193, 7, 1);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5);
            transform: translateY(-2px);
            font-weight: 700;
        }

        .btn-primary.active::after {
            content: '‚úì';
            position: absolute;
            top: -5px;
            right: -5px;
            background: rgba(255, 255, 255, 1);
            color: rgba(255, 193, 7, 1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid rgba(255, 193, 7, 1);
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.9);
            color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(108, 117, 125, 0.9);
        }

        .btn-secondary:hover {
            background: rgba(90, 98, 104, 0.9);
            border-color: rgba(90, 98, 104, 0.9);
            transform: translateY(-1px);
        }

        .btn-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* Áµ±Ë®àÂçÄÂüü */
        .stats {
            background: rgba(248, 249, 250, 0.9);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 16px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80px;
        }

        .stat-item h3 {
            font-size: 2rem;
            margin: 0 0 8px 0;
            font-weight: 700;
            color: rgba(255, 193, 7, 1);
            line-height: 1;
        }

        .stat-item p {
            font-size: 1rem;
            color: rgba(51, 51, 51, 0.9);
            margin: 0;
            font-weight: 600;
            line-height: 1.2;
        }

        .events-container {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr;
        }

        .event-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(233, 236, 239, 0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.6s ease-out forwards;
        }

        .event-card.animated {
            opacity: 1;
            transform: translateY(0);
        }

        .event-card:nth-child(1) { animation-delay: 0.1s; }
        .event-card:nth-child(2) { animation-delay: 0.2s; }
        .event-card:nth-child(3) { animation-delay: 0.3s; }
        .event-card:nth-child(4) { animation-delay: 0.4s; }
        .event-card:nth-child(5) { animation-delay: 0.5s; }

        /* ÂÅúË™≤ÁãÄÊÖãÊ®£Âºè - Âä†Âº∑Áâà */
        .event-card.cancelled-event {
            background: rgba(248, 249, 250, 0.9);
            border: 3px solid #dc3545;
            opacity: 0.8;
            position: relative;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
        }

        .event-card.cancelled-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(220, 53, 69, 0.15) 8px,
                rgba(220, 53, 69, 0.15) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.cancelled-event::after {
            content: '‚ö†Ô∏è ÂÅúË™≤ ‚ö†Ô∏è';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            animation: bounce 1.5s infinite;
        }

        .cancelled-badge {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            animation: pulse 1.5s infinite;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            border: 2px solid white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .event-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .event-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: rgba(255, 223, 102, 0.9);
            border-radius: 2px 0 0 2px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 5px;
        }

        .event-instructor {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(255, 255, 255, 0.95);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(102, 102, 102, 0.9);
            font-size: 0.9rem;
        }

        .event-detail i {
            width: 20px;
            color: rgba(255, 223, 102, 0.9);
            text-align: center;
        }

        .location-link {
            color: rgba(0, 0, 0, 0.9);
            text-decoration: none;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
            background: rgba(255, 193, 7, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            position: relative;
        }

        .location-link:hover {
            color: rgba(255, 255, 255, 1);
            background: rgba(255, 193, 7, 0.9);
            border-bottom: 1px solid rgba(255, 193, 7, 1);
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .location-link:active {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 193, 7, 0.8);
            transform: translateY(0);
        }

        .location-external-icon {
            font-size: 0.7rem;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .location-link:hover .location-external-icon {
            opacity: 1;
            transform: scale(1.1);
        }

        .location-map-icon {
            font-size: 0.8rem;
            opacity: 0.9;
            transition: all 0.3s ease;
        }

        .location-link:hover .location-map-icon {
            opacity: 1;
            transform: scale(1.1);
        }

        .countdown-timer {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            text-align: center;
            font-weight: 600;
            color: rgba(255, 193, 7, 1);
            transition: all 0.3s ease;
        }

        .countdown-timer.upcoming {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.3);
            color: rgba(76, 175, 80, 1);
        }

        .countdown-timer.ongoing {
            background: rgba(33, 150, 243, 0.1);
            border-color: rgba(33, 150, 243, 0.3);
            color: rgba(33, 150, 243, 1);
        }

        .countdown-timer.overdue {
            background: rgba(244, 67, 54, 0.1);
            border-color: rgba(244, 67, 54, 0.3);
            color: rgba(244, 67, 54, 1);
        }

        .countdown-text {
            font-size: 0.9rem;
            margin: 0;
        }

        .countdown-icon {
            margin-right: 6px;
            font-size: 0.8rem;
        }

        .event-description {
            background: rgba(248, 249, 250, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid rgba(255, 223, 102, 0.9);
        }

        .event-description h4 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: 600;
        }

        .event-description p {
            color: rgba(102, 102, 102, 0.9);
            line-height: 1.5;
            font-size: 0.9rem;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .lesson-section {
            margin-top: 15px;
        }

        .lesson-label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .lesson-button {
            display: inline-block;
            background: rgba(255, 223, 102, 0.9);
            color: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .lesson-button:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .no-events i {
            font-size: 4rem;
            color: rgba(255, 223, 102, 0.9);
            margin-bottom: 20px;
        }

        .no-events h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: rgba(51, 51, 51, 0.9);
        }

        .no-events p {
            font-size: 1.1rem;
            color: rgba(102, 102, 102, 0.9);
        }

        /* Ë®≠ÁΩÆÁï´Èù¢Ê®£Âºè */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .settings-modal {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(240, 240, 240, 0.9);
        }

        .settings-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .close-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            transform: scale(1.1);
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .color-picker-item label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            min-width: 80px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .instructor-color-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .instructor-color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .instructor-color-item label {
            font-size: 0.9rem;
            color: rgba(51, 51, 51, 0.9);
            min-width: 60px;
            font-weight: 600;
        }

        .instructor-color-picker {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .instructor-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .instructor-color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .save-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .save-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
                max-width: 100%;
                overflow-x: hidden;
            }

            .header {
                padding: 12px;
                margin-bottom: 12px;
            }

            .header h1 {
                font-size: 1.4rem;
                line-height: 1.2;
            }

            .header-logo {
                height: 35px;
            }

            .header-left {
                gap: 8px;
                justify-content: center;
                text-align: center;
            }


            .control-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .control-group {
                width: 100%;
            }

            .control-group label {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }

            .control-group select,
            .control-group input {
                padding: 8px;
                font-size: 0.9rem;
                border-radius: 6px;
            }

            .view-buttons {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                width: 100%;
            }

            .btn-primary {
                padding: 8px 4px;
                font-size: 0.75rem;
                text-align: center;
                min-height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .events-container {
                gap: 8px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-header {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                margin-bottom: 12px;
            }

            .event-title {
                font-size: 1rem;
                line-height: 1.3;
                word-wrap: break-word;
            }

            .event-instructor {
                padding: 4px 8px;
                font-size: 0.8rem;
                align-self: flex-start;
            }

            .event-details {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-bottom: 12px;
            }

            .event-detail {
                font-size: 0.8rem;
                padding: 4px 0;
            }

            .event-detail i {
                margin-right: 6px;
                width: 14px;
            }

            .event-description {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 6px;
            }

            .event-description h4 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }

            .event-description p {
                font-size: 0.8rem;
                line-height: 1.4;
                word-wrap: break-word;
            }

            .lesson-button {
                padding: 6px 12px;
                font-size: 0.8rem;
                border-radius: 6px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .stat-item {
                padding: 12px 8px;
                border-radius: 6px;
                min-height: 70px;
            }

            .stat-item h3 {
                font-size: 1.5rem;
                margin-bottom: 6px;
            }

            .stat-item p {
                font-size: 0.85rem;
                line-height: 1.2;
            }

            .settings-modal {
                width: 95%;
                padding: 16px;
                margin: 10px auto;
            }

            .color-picker-group {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .instructor-color-group {
                grid-template-columns: 1fr;
            }

            .datetime-display {
                flex-direction: column;
                gap: 6px;
                justify-content: center;
                align-items: center;
            }

            .datetime-item {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .progress-steps {
                gap: 8px;
                margin: 12px 0;
                justify-content: center;
            }

            .progress-step {
                font-size: 0.7rem;
                padding: 6px 8px;
            }
        }

        /* Ë∂ÖÂ∞èÂ±èÂπïÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 480px) {
            .container {
                padding: 6px;
            }

            .header {
                padding: 8px;
                margin-bottom: 8px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .header-logo {
                height: 30px;
            }

            .header-left {
                justify-content: center;
                text-align: center;
            }


            .control-group label {
                font-size: 0.8rem;
            }

            .control-group select,
            .control-group input {
                padding: 6px;
                font-size: 0.85rem;
            }

            .view-buttons {
                gap: 4px;
            }

            .btn-primary {
                padding: 6px 2px;
                font-size: 0.7rem;
                min-height: 32px;
            }

            .events-container {
                gap: 6px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 10px;
                margin-bottom: 6px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-title {
                font-size: 0.9rem;
            }

            .event-instructor {
                padding: 3px 6px;
                font-size: 0.75rem;
            }

            .event-detail {
                font-size: 0.75rem;
            }

            .event-description {
                padding: 8px;
            }

            .event-description h4 {
                font-size: 0.85rem;
            }

            .event-description p {
                font-size: 0.75rem;
            }

            .lesson-button {
                padding: 5px 10px;
                font-size: 0.75rem;
            }

            .stat-item {
                padding: 10px 6px;
                min-height: 60px;
            }

            .stat-item h3 {
                font-size: 1.3rem;
            }

            .stat-item p {
                font-size: 0.75rem;
            }

            .datetime-item {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .progress-step {
                font-size: 0.65rem;
                padding: 4px 6px;
            }

            .user-info-section {
                margin-top: 15px;
                padding: 12px;
            }

            .user-info-container h3 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
        }

        /* ËºâÂÖ•ÂãïÁï´Ê®£Âºè - ÁîüÂãïÁâà */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(44, 44, 44, 0.95), rgba(30, 30, 30, 0.98));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(8px);
        }

        .loading-container {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            max-width: 500px;
            width: 90%;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 223, 102, 0.2);
            border-top: 6px solid #ffdf66;
            border-right: 6px solid #ff6b6b;
            border-bottom: 6px solid #4ecdc4;
            border-left: 6px solid #45b7d1;
            border-radius: 50%;
            animation: spin 1.2s linear infinite, pulse 2s ease-in-out infinite, glow 3s ease-in-out infinite;
            margin: 0 auto 30px;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 223, 102, 0.3);
        }

        .loading-spinner::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 3px solid rgba(255, 223, 102, 0.1);
            border-radius: 50%;
            animation: spin 2.5s linear infinite reverse, pulse 1.5s ease-in-out infinite;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ffdf66, #ff6b6b);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: innerPulse 1s ease-in-out infinite;
        }

        .loading-logs {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 223, 102, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .loading-log-item {
            color: #4ecdc4;
            margin: 5px 0;
            opacity: 0;
            animation: logFadeIn 0.5s ease-in forwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-log-item.success {
            color: #4ecdc4;
        }

        .loading-log-item.warning {
            color: #ffdf66;
        }

        .loading-log-item.error {
            color: #ff6b6b;
        }

        .loading-log-item.info {
            color: #45b7d1;
        }

        .loading-log-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(255, 223, 102, 0.3);
            }
            50% { 
                box-shadow: 0 0 50px rgba(255, 223, 102, 0.6), 0 0 80px rgba(255, 107, 107, 0.3);
            }
        }

        @keyframes innerPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.7;
            }
        }

        @keyframes logFadeIn {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        .loading-text h3 {
            color: rgba(255, 223, 102, 0.9);
            font-size: 1.5rem;
            margin: 0 0 10px 0;
            font-weight: 600;
        }

        .loading-text p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            margin: 0 0 15px 0;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 223, 102, 0.9), rgba(255, 193, 7, 0.9));
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-percentage {
            color: rgba(255, 223, 102, 0.9);
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 500;
        }

        /* ÈÅéÂ†¥ÂãïÁï´ÊïàÊûú */
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.8s ease-out;
        }

        .bounce-in {
            animation: bounceIn 1s ease-out;
        }

        .scale-in {
            animation: scaleIn 0.5s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .float {
            animation: float 3s ease-in-out infinite;
        }

        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        /* ÂãïÁï´ÈóúÈçµÂπÄ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            0% { 
                opacity: 0;
                transform: translateY(30px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(255, 223, 102, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 223, 102, 0.8);
            }
        }

        @keyframes titleFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-8px);
            }
        }

        @keyframes gratitudePulse {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* È¶¨Âç°ÈæçÈÖçËâ≤ËÆäÊï∏ */
        :root {
            --esm-color: #ff6b9d;
            --spm-color: #2c3e50;
            --boost-color: #74b9ff;
            --spike-color: #fdcb6e;
            --ev3-color: #e17055;
            --minecraft-color: #00b894;
        }

        /* ÊïôÊ°àÊåâÈàïÈ°èËâ≤ */
        .lesson-button.esm {
            background: linear-gradient(135deg, var(--esm-color) 0%, #ff8fab 100%);
        }

        .lesson-button.spm {
            background: linear-gradient(135deg, var(--spm-color) 0%, #34495e 100%);
        }

        .lesson-button.boost {
            background: linear-gradient(135deg, var(--boost-color) 0%, #a29bfe 100%);
        }

        .lesson-button.spike {
            background: linear-gradient(135deg, var(--spike-color) 0%, #fdcb6e 100%);
        }

        .lesson-button.ev3 {
            background: linear-gradient(135deg, var(--ev3-color) 0%, #fd79a8 100%);
        }

        .lesson-button.minecraft {
            background: linear-gradient(135deg, var(--minecraft-color) 0%, #55efc4 100%);
        }

        /* Ë¨õÂ∏´Â∫ïËâ≤ */
        .event-instructor.custom-color {
            background: var(--instructor-color) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }
    </style>
</head>
<body>
    <!-- ËºâÂÖ•ÂãïÁï´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                <h3>üöÄ ËºâÂÖ•‰∏≠...</h3>
                <p>Ê≠£Âú®ÂàùÂßãÂåñÁ≥ªÁµ±ÔºåË´ãÁ®çÂÄô</p>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
                <div class="loading-percentage" id="loadingPercentage">0%</div>
            </div>
            <div class="loading-logs" id="loadingLogs">
                <div class="loading-log-item info">
                    <span class="loading-log-icon">‚ÑπÔ∏è</span>
                    <span>Á≥ªÁµ±ÂàùÂßãÂåñ‰∏≠...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <img src="logo.jpg" alt="FLB Logo" class="header-logo">
                    <div>
                        <h1>FLBË¨õÂ∏´Ë°å‰∫ãÊõÜÊ™¢Ë¶ñÁ≥ªÁµ±</h1>
                        <p class="header-subtitle">Âç≥ÊôÇÊü•ÁúãÊâÄÊúâË¨õÂ∏´ÁöÑË°åÁ®ãÂÆâÊéí</p>
                        <p class="header-tim-note">TimÊÑüÊÅ©Êà¥Âæ∑üôèüèª</p>
                    </div>
                </div>
        </div>

            <!-- Êó•ÊúüÊôÇÈñìÈ°ØÁ§∫ -->
            <div class="datetime-display">
                <div class="datetime-item">
                    <i class="fas fa-calendar"></i>
                    <span id="currentDate">2025Âπ¥01Êúà16Êó• ÊòüÊúüÂõõ</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime">13:58:43</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-calendar-week"></i>
                    <span id="currentWeek">2025Âπ¥Á¨¨3ÈÄ±</span>
                </div>
            </div>
            
            <!-- ÈÄ≤Â∫¶ÊåáÁ§∫Âô® -->
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-circle">1</div>
                    <div class="step-label">ÈÅ∏ÊìáË¨õÂ∏´</div>
                </div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">Êü•ÁúãË°å‰∫ãÊõÜ</div>
                </div>
                <div class="step pending">
                    <div class="step-circle">3</div>
                    <div class="step-label">ÁÆ°ÁêÜË°åÁ®ã</div>
                </div>
            </div>
        </div>

        <!-- ‰∏ªÂÖßÂÆπÂçÄÂüü -->
        <div class="main-content">
            <div class="content-header">
                <i class="fas fa-calendar-alt"></i>
                <h2>Ë¨õÂ∏´Ë°å‰∫ãÊõÜÊ™¢Ë¶ñ</h2>
            </div>

            <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="instructorSelect">ÈÅ∏ÊìáË¨õÂ∏´</label>
                    <select id="instructorSelect">
                        <option value="">ÂÖ®ÈÉ®Ë¨õÂ∏´</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="timeFilter">ÊôÇÊÆµÁØ©ÈÅ∏</label>
                        <select id="timeFilter">
                            <option value="">ÂÖ®ÈÉ®ÊôÇÊÆµ</option>
                            <option value="morning">Êó©‰∏ä (06:00-12:00)</option>
                            <option value="afternoon">‰∏ãÂçà (12:00-18:00)</option>
                            <option value="evening">Êôö‰∏ä (18:00-24:00)</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="dateFilter">ÊåáÂÆöÊó•Êúü</label>
                        <input type="date" id="dateFilter" />
                </div>
                <div class="control-group">
                        <label for="sortOrder">ÊéíÂ∫èÊñπÂºè</label>
                        <select id="sortOrder">
                            <option value="time">ÊåâÊôÇÈñìÊéíÂ∫è</option>
                            <option value="instructor">ÊåâË¨õÂ∏´ÊéíÂ∫è</option>
                            <option value="title">ÊåâÊ®ôÈ°åÊéíÂ∫è</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <div class="view-buttons">
                            <button class="btn btn-primary active" data-view="today">‰ªäÊó•</button>
                            <button class="btn btn-primary" data-view="week">Êú¨ÈÄ±</button>
                            <button class="btn btn-primary" data-view="month">Êú¨Êúà</button>
                            <button class="btn btn-primary" data-view="all">ÂÖ®ÈÉ®</button>
                        </div>
                </div>
            </div>
        </div>

            <!-- Áµ±Ë®àÂçÄÂüü -->
        <div class="stats" id="statsContainer">
            <div class="stats-grid">
                <div class="stat-item">
                    <h3 id="totalEvents">0</h3>
                    <p>Á∏Ω‰∫ã‰ª∂Êï∏</p>
                </div>
                <div class="stat-item">
                    <h3 id="instructorCount">0</h3>
                    <p>Ë¨õÂ∏´Êï∏Èáè</p>
                </div>
                <div class="stat-item">
                    <h3 id="dateRange">-</h3>
                    <p>Êó•ÊúüÁØÑÂúç</p>
                </div>
            </div>
        </div>

            <!-- ‰∫ã‰ª∂ÂàóË°® -->
        <div class="events-container" id="eventsContainer">
            <div class="no-events">
                <i class="fas fa-calendar-times"></i>
                <h3>ËºâÂÖ•‰∏≠...</h3>
                <p>Ê≠£Âú®Áç≤ÂèñË°å‰∫ãÊõÜË≥áÊñô</p>
                </div>
            </div>

            <!-- Áî®Êà∂Ë≥áË®äÂçÄÂüü -->
            <div class="user-info-section" id="userInfoGroup" style="display: block;">
                <div class="user-info-container">
                    <h3>LINE Áî®Êà∂Ë≥áË®ä</h3>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="userDisplayName">Êú™Á∂ÅÂÆö</div>
                            <div class="user-id" id="userDisplayId" style="display: none;"></div>
                        </div>
                        <button class="btn btn-secondary" id="bindUserBtn">Á∂ÅÂÆöÂ∏≥Ëôü</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë®≠ÁΩÆÁï´Èù¢ -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <h2><i class="fas fa-palette"></i> È°èËâ≤Ë®≠ÁΩÆ</h2>
                <button class="close-settings" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="settings-section">
                <h3>ÊïôÊ°àÈ°ûÂûãÈ°èËâ≤</h3>
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label>ESM</label>
                        <input type="color" class="color-picker" id="esmColor" value="#ff6b9d">
                    </div>
                    <div class="color-picker-item">
                        <label>SPM</label>
                        <input type="color" class="color-picker" id="spmColor" value="#2c3e50">
                    </div>
                    <div class="color-picker-item">
                        <label>BOOST</label>
                        <input type="color" class="color-picker" id="boostColor" value="#74b9ff">
                    </div>
                    <div class="color-picker-item">
                        <label>SPIKE</label>
                        <input type="color" class="color-picker" id="spikeColor" value="#fdcb6e">
                    </div>
                    <div class="color-picker-item">
                        <label>EV3</label>
                        <input type="color" class="color-picker" id="ev3Color" value="#e17055">
                    </div>
                    <div class="color-picker-item">
                        <label>MINECRAFT</label>
                        <input type="color" class="color-picker" id="minecraftColor" value="#00b894">
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Ë¨õÂ∏´Â∫ïËâ≤Ë®≠ÁΩÆ</h3>
                <div class="color-picker-group" id="instructorColorGroup">
                    <!-- Ë¨õÂ∏´È°èËâ≤Ë®≠ÁΩÆÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
                </div>
            </div>

            <button class="save-settings" onclick="saveSettings()">
                <i class="fas fa-save"></i> ÂÑ≤Â≠òË®≠ÁΩÆ
            </button>
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let allEvents = [];
        let allInstructors = [];
        let currentView = 'today';
        let currentUser = null;
        let colorSettings = {
            esm: 'rgba(255, 182, 193, 0.8)',
            spm: 'rgba(116, 185, 255, 0.8)',
            boost: 'rgba(116, 185, 255, 0.8)',
            spike: 'rgba(255, 223, 102, 0.8)',
            ev3: 'rgba(180, 167, 214, 0.8)',
            minecraft: 'rgba(0, 184, 148, 0.8)'
        };
        let instructorColors = {};

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÔºåÈñãÂßãÂàùÂßãÂåñ...');
            
            // È°ØÁ§∫ËºâÂÖ•ÂãïÁï´
            showLoadingAnimation();
            
            // Ë®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩÂô®
            setupEventListeners();
            
            // ÂàùÂßãÂåñÁ≥ªÁµ±
            initializeSystem();
            
            // ÂÇôÁî®ÂàùÂßãÂåñÊ©üÂà∂Ôºà10ÁßíÂæåÂº∑Âà∂ÂÆåÊàêÔºâ
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay && loadingOverlay.style.display !== 'none') {
                    console.warn('Âº∑Âà∂ÂÆåÊàêÂàùÂßãÂåñÔºåÈÅøÂÖçËºâÂÖ•ÂãïÁï´Âç°‰Ωè');
                    hideLoadingAnimation();
                }
            }, 10000);
        });

        // È°ØÁ§∫ËºâÂÖ•ÂãïÁï´
        function showLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }
            
            // ÈáçÁΩÆÈÄ≤Â∫¶Ê¢ù
            updateLoadingProgress(0);
        }

        // Êõ¥Êñ∞ËºâÂÖ•ÈÄ≤Â∫¶
        function updateLoadingProgress(percentage) {
            const progressBar = document.getElementById('loadingProgressBar');
            const percentageText = document.getElementById('loadingPercentage');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (percentageText) {
                percentageText.textContent = Math.round(percentage) + '%';
            }
        }

        // Èö±ËóèËºâÂÖ•ÂãïÁï´
        function hideLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            if (mainContainer) {
                mainContainer.style.display = 'block';
                // Ëß∏Áôº‰∏ªÂÆπÂô®ÁöÑÈÄ≤ÂÖ•ÂãïÁï´
                mainContainer.classList.add('fade-in');
            }
        }

        // ÁÇ∫ÂÖÉÁ¥†Ê∑ªÂä†ÂãïÁï´ÊïàÊûú
        function addAnimationToElement(element, animationClass, delay = 0) {
            if (element) {
                setTimeout(() => {
                    element.classList.add(animationClass);
                }, delay);
            }
        }

        // ÁÇ∫‰∫ã‰ª∂Âç°ÁâáÊ∑ªÂä†ÈÄ≤ÂÖ•ÂãïÁï´
        function animateEventCards() {
            const eventCards = document.querySelectorAll('.event-card');
            eventCards.forEach((card, index) => {
                // ÈáçÁΩÆÂãïÁï´ÁãÄÊÖã
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.animation = 'none';
                
                // Âº∑Âà∂ÈáçÊéí
                card.offsetHeight;
                
                // ÈáçÊñ∞ÂïüÂãïÂãïÁï´
                card.style.animation = `slideUp 0.6s ease-out forwards`;
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }

        // Ë®àÁÆóÂÄíÊï∏Ë®àÊôÇ
        function calculateCountdown(startTime, endTime) {
            const now = new Date();
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            const timeDiff = start.getTime() - now.getTime();
            const endDiff = end.getTime() - now.getTime();
            
            // Â¶ÇÊûúË™≤Á®ãÂ∑≤ÁµêÊùü
            if (endDiff <= 0) {
                return {
                    text: 'Ë™≤Á®ãÂ∑≤ÁµêÊùü',
                    status: 'overdue',
                    icon: 'fas fa-check-circle'
                };
            }
            
            // Â¶ÇÊûúË™≤Á®ãÊ≠£Âú®ÈÄ≤Ë°å‰∏≠
            if (timeDiff <= 0 && endDiff > 0) {
                const remainingMinutes = Math.floor(endDiff / (1000 * 60));
                const remainingHours = Math.floor(remainingMinutes / 60);
                const remainingMins = remainingMinutes % 60;
                
                if (remainingHours > 0) {
                    return {
                        text: `ÈÄ≤Ë°å‰∏≠ÔºåÂâ©È§ò ${remainingHours}Â∞èÊôÇ${remainingMins}ÂàÜÈêò`,
                        status: 'ongoing',
                        icon: 'fas fa-play-circle'
                    };
                } else {
                    return {
                        text: `ÈÄ≤Ë°å‰∏≠ÔºåÂâ©È§ò ${remainingMins}ÂàÜÈêò`,
                        status: 'ongoing',
                        icon: 'fas fa-play-circle'
                    };
                }
            }
            
            // Â¶ÇÊûúË™≤Á®ãÂ∞öÊú™ÈñãÂßã
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return {
                    text: `ÈÇÑÊúâ ${days}Â§©${hours}Â∞èÊôÇ`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            } else if (hours > 0) {
                return {
                    text: `ÈÇÑÊúâ ${hours}Â∞èÊôÇ${minutes}ÂàÜÈêò`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            } else {
                return {
                    text: `ÈÇÑÊúâ ${minutes}ÂàÜÈêò`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            }
        }

        // Êõ¥Êñ∞ÊâÄÊúâÂÄíÊï∏Ë®àÊôÇ
        function updateAllCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown-timer');
            countdownElements.forEach(element => {
                const startTime = element.dataset.startTime;
                const endTime = element.dataset.endTime;
                
                if (startTime && endTime) {
                    const countdown = calculateCountdown(startTime, endTime);
                    element.className = `countdown-timer ${countdown.status}`;
                    element.innerHTML = `
                        <i class="${countdown.icon} countdown-icon"></i>
                        <span class="countdown-text">${countdown.text}</span>
                    `;
                }
            });
        }

        // ÂàùÂßãÂåñÁ≥ªÁµ±
        async function initializeSystem() {
            try {
                console.log('ÈñãÂßãÂàùÂßãÂåñÁ≥ªÁµ±...');
                addLoadingLog('üöÄ ÈñãÂßãÂàùÂßãÂåñÁ≥ªÁµ±...', 'info');
                updateLoadingProgress(10);
                
                // ËºâÂÖ•Ë®≠ÂÆö
                addLoadingLog('‚öôÔ∏è ËºâÂÖ•Á≥ªÁµ±Ë®≠ÂÆö...', 'info');
                loadSettings();
                updateLoadingProgress(20);
                
                // Êõ¥Êñ∞Êó•ÊúüÊôÇÈñì
                addLoadingLog('üïê ÂàùÂßãÂåñÊôÇÈñìÁ≥ªÁµ±...', 'info');
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                // Ë®≠ÁΩÆÂÄíÊï∏Ë®àÊôÇÊõ¥Êñ∞
                setInterval(updateAllCountdowns, 60000); // ÊØèÂàÜÈêòÊõ¥Êñ∞‰∏ÄÊ¨°
                updateLoadingProgress(30);
                
                // ÂÖàËºâÂÖ•Ë°å‰∫ãÊõÜË≥áÊñôÔºåÂÜçÂàùÂßãÂåñLIFF
                addLoadingLog('üìÖ Ê≠£Âú®ËºâÂÖ•Ë°å‰∫ãÊõÜË≥áÊñô...', 'info');
                await loadEvents().catch(error => {
                    console.error('ËºâÂÖ•Ë°å‰∫ãÊõÜË≥áÊñôÂ§±Êïó:', error);
                    addLoadingLog('‚ùå ËºâÂÖ•Ë°å‰∫ãÊõÜË≥áÊñôÂ§±Êïó: ' + error.message, 'error');
                });
                addLoadingLog('‚úÖ Ë°å‰∫ãÊõÜË≥áÊñôËºâÂÖ•ÂÆåÊàê', 'success');
                updateLoadingProgress(60);
                
                addLoadingLog('üîê Ê≠£Âú®ÂàùÂßãÂåñ LINE ÁôªÂÖ•...', 'info');
                await initLineUser().catch(error => {
                    console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', error);
                    addLoadingLog('‚ùå LINE ÁôªÂÖ•ÂàùÂßãÂåñÂ§±Êïó: ' + error.message, 'error');
                });
                addLoadingLog('‚úÖ LINE ÁôªÂÖ•ÂàùÂßãÂåñÂÆåÊàê', 'success');
                updateLoadingProgress(80);
                
                console.log('ÊâÄÊúâÂàùÂßãÂåñ‰ªªÂãôÂÆåÊàêÔºåÈñãÂßãË¨õÂ∏´ÊØîÂ∞ç...');
                addLoadingLog('üë®‚Äçüè´ ÈñãÂßãË¨õÂ∏´Ë∫´‰ªΩÊØîÂ∞ç...', 'info');
                updateLoadingProgress(90);
                
                // Âü∑Ë°åË¨õÂ∏´ÊØîÂ∞ç
                if (currentUser && currentUser.userId && currentUser.displayName) {
                    console.log('=== ÈñãÂßãËá™ÂãïÊØîÂ∞çË¨õÂ∏´ ===');
                    console.log('Áî®Êà∂Ë≥áÊñô:', currentUser);
                    addLoadingLog('üîç Ê≠£Âú®ÊØîÂ∞çË¨õÂ∏´Ë∫´‰ªΩ...', 'info');
                    
                    try {
                        await autoMatchTeacher(currentUser.userId, currentUser.displayName);
                        console.log('Ë¨õÂ∏´ÊØîÂ∞çÂÆåÊàê');
                        addLoadingLog('‚úÖ Ë¨õÂ∏´Ë∫´‰ªΩÊØîÂ∞çÂÆåÊàê', 'success');
                    } catch (error) {
                        console.error('Ëá™ÂãïÊØîÂ∞çË¨õÂ∏´Â§±Êïó:', error);
                        addLoadingLog('‚ö†Ô∏è Ë¨õÂ∏´Ë∫´‰ªΩÊØîÂ∞çÂ§±Êïó: ' + error.message, 'warning');
                    }
                } else {
                    console.log('Ê≤íÊúâÁî®Êà∂Ë≥áÊñôÔºåË∑≥ÈÅéËá™ÂãïÊØîÂ∞ç');
                    addLoadingLog('‚ö†Ô∏è Ê≤íÊúâÁî®Êà∂Ë≥áÊñôÔºåË∑≥ÈÅéË¨õÂ∏´ÊØîÂ∞ç', 'warning');
                }
                
                addLoadingLog('üéâ Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàêÔºÅ', 'success');
                updateLoadingProgress(100);
                
                // ÊØîÂ∞çÂÆåÊàêÂæåÈö±ËóèËºâÂÖ•ÂãïÁï´
                setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
                        
                        // Ëá™ÂãïÊªëÂãïÂà∞Ë°å‰∫ãÊõÜÂçÄÂüüÔºàÂÉÖË°åÂãïË£ùÁΩÆÔºâ
                        autoScrollToCalendar();
                    } catch (error) {
                        console.error('Èö±ËóèËºâÂÖ•ÂãïÁï´Â§±Êïó:', error);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó:', error);
                // Âç≥‰ΩøÂ§±Êïó‰πüË¶ÅÈö±ËóèËºâÂÖ•ÂãïÁï´
                setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºå‰ΩÜÂ∑≤Èö±ËóèËºâÂÖ•ÂãïÁï´');
                    } catch (hideError) {
                        console.error('Èö±ËóèËºâÂÖ•ÂãïÁï´Â§±Êïó:', hideError);
                    }
                }, 1000);
            }
        }

        // Êõ¥Êñ∞Êó•ÊúüÊôÇÈñìÈ°ØÁ§∫
        function updateDateTime() {
            const now = new Date();
            
            // Êõ¥Êñ∞Êó•Êúü
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', dateOptions);
            
            // Êõ¥Êñ∞ÊôÇÈñì
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW', timeOptions);
            
            // Êõ¥Êñ∞ÈÄ±Êï∏
            const weekNumber = getWeekNumber(now);
            document.getElementById('currentWeek').textContent = `${now.getFullYear()}Âπ¥Á¨¨${weekNumber}ÈÄ±`;
        }

        // Áç≤ÂèñÈÄ±Êï∏
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // LINE UserID Áõ∏ÈóúÂáΩÊï∏
        async function initLineUser() {
            console.log('ÈñãÂßãÂàùÂßãÂåñLINEÁî®Êà∂...');
            console.log('Áï∂ÂâçURL:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
            
            return new Promise((resolve) => {
                // Ë®≠ÁΩÆË∂ÖÊôÇ‰øùË≠∑Ôºà3ÁßíÔºåÊ∏õÂ∞ëÁ≠âÂæÖÊôÇÈñìÔºâ
                const timeout = setTimeout(() => {
                    console.warn('LIFF ÂàùÂßãÂåñË∂ÖÊôÇÔºåÈ°ØÁ§∫Á∂ÅÂÆöÊåâÈàï');
                    addLoadingLog('‚è∞ LINE ÁôªÂÖ•Ë∂ÖÊôÇÔºåË´ãÊâãÂãïÁ∂ÅÂÆö', 'warning');
                    showBindButton();
                    resolve();
                }, 3000);
                
                // Ê™¢Êü•ÊòØÂê¶Âú®LINEÁí∞Â¢É‰∏≠
                if (typeof liff !== 'undefined') {
                    console.log('LIFF SDK Â∑≤ËºâÂÖ•');
                    
                    // ÂàùÂßãÂåñLIFF - ÈÄôË£°ÈúÄË¶ÅÊÇ®ÁöÑLIFF ID
                    liff.init({
                        liffId: '1657746214-qp0y8NwZ', // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑLIFF ID
                        withLoginOnExternalBrowser: true
                    }).then(() => {
                        console.log('LIFF ÂàùÂßãÂåñÊàêÂäü');
                        console.log('ÊòØÂê¶Âú®LINEÂÆ¢Êà∂Á´Ø:', liff.isInClient());
                        console.log('ÊòØÂê¶Â∑≤ÁôªÂÖ•:', liff.isLoggedIn());
                        
                        if (liff.isLoggedIn()) {
                            console.log('Áî®Êà∂Â∑≤ÁôªÂÖ•ÔºåÁç≤ÂèñÁî®Êà∂Ë≥áÊñô...');
                            liff.getProfile().then(profile => {
                                clearTimeout(timeout);
                                console.log('Áç≤ÂèñÂà∞Áî®Êà∂Ë≥áÊñô:', profile);
                                currentUser = {
                                    userId: profile.userId,
                                    displayName: profile.displayName,
                                    pictureUrl: profile.pictureUrl
                                };
                                updateUserDisplay();
                                console.log('updateUserDisplay() Âü∑Ë°åÂÆåÊàê');
                                
                                
                                // Â∞áËá™ÂãïÊØîÂ∞çÁßªÂà∞Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàêÂæåÂü∑Ë°å
                                console.log('Ê∫ñÂÇôÂú®Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàêÂæåÂü∑Ë°åËá™ÂãïÊØîÂ∞ç');
                                
                                resolve();
                            }).catch(error => {
                                console.error('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÂ§±Êïó:', error);
                                clearTimeout(timeout);
                                showBindButton();
                                resolve();
                            });
                        } else {
                            console.log('Áî®Êà∂Êú™ÁôªÂÖ•ÔºåÈ°ØÁ§∫Á∂ÅÂÆöÊåâÈàï');
                            clearTimeout(timeout);
                            showBindButton();
                            resolve();
                        }
                    }).catch(error => {
                        console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', error);
                        clearTimeout(timeout);
                        showBindButton();
                        resolve();
                    });
                    
                } else {
                    clearTimeout(timeout);
                    console.log('LIFF SDK Êú™ËºâÂÖ•ÔºåÈ°ØÁ§∫Á∂ÅÂÆöÊåâÈàï');
                    showBindButton();
                    resolve();
                }
            });
        }

        function updateUserDisplay() {
            console.log('Êõ¥Êñ∞Áî®Êà∂È°ØÁ§∫ÔºåÁï∂ÂâçÁî®Êà∂:', currentUser);
            
            try {
                const userInfoGroup = document.getElementById('userInfoGroup');
                const userDisplayName = document.getElementById('userDisplayName');
                const userDisplayId = document.getElementById('userDisplayId');
                const bindUserBtn = document.getElementById('bindUserBtn');
                
                if (!userInfoGroup || !userDisplayName || !userDisplayId || !bindUserBtn) {
                    console.error('Êâæ‰∏çÂà∞Áî®Êà∂Ë≥áË®äÂÖÉÁ¥†');
                    return;
                }
                
                if (currentUser) {
                    console.log('È°ØÁ§∫Áî®Êà∂Ë≥áË®ä:', currentUser.displayName, currentUser.userId);
                    
                    try {
                        userDisplayName.textContent = currentUser.displayName;
                        console.log('Ë®≠ÁΩÆÁî®Êà∂ÂêçÁ®±ÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆÁî®Êà∂ÂêçÁ®±Â§±Êïó:', error);
                    }
                    
                    try {
                        userDisplayId.textContent = `ID: ${currentUser.userId}`;
                        console.log('Ë®≠ÁΩÆÁî®Êà∂IDÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆÁî®Êà∂IDÂ§±Êïó:', error);
                    }
                    
                    try {
                        userDisplayId.style.display = 'block';
                        console.log('Ë®≠ÁΩÆIDÈ°ØÁ§∫ÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆIDÈ°ØÁ§∫Â§±Êïó:', error);
                    }
                    
                    try {
                        bindUserBtn.textContent = 'ÈáçÊñ∞Á∂ÅÂÆö';
                        console.log('Ë®≠ÁΩÆÊåâÈàïÊñáÂ≠óÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆÊåâÈàïÊñáÂ≠óÂ§±Êïó:', error);
                    }
                    
                    try {
                        userInfoGroup.style.display = 'block';
                        console.log('Ë®≠ÁΩÆÁî®Êà∂Ë≥áË®äÁµÑÈ°ØÁ§∫ÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆÁî®Êà∂Ë≥áË®äÁµÑÈ°ØÁ§∫Â§±Êïó:', error);
                    }
                } else {
                    console.log('È°ØÁ§∫Êú™Á∂ÅÂÆöÁãÄÊÖã');
                    userDisplayName.textContent = 'Êú™Á∂ÅÂÆö';
                    userDisplayId.style.display = 'none';
                    bindUserBtn.textContent = 'Á∂ÅÂÆöÂ∏≥Ëôü';
                    userInfoGroup.style.display = 'block';
                }
                console.log('updateUserDisplay ÂáΩÊï∏Âü∑Ë°åÂÆåÊàê');
            } catch (error) {
                console.error('updateUserDisplay ÂáΩÊï∏Âü∑Ë°åÈåØË™§:', error);
            }
        }

        function showBindButton() {
            updateUserDisplay();
        }

        function bindUser() {
            console.log('Áî®Êà∂ÈªûÊìäÁ∂ÅÂÆöÊåâÈàï');
            
            if (typeof liff !== 'undefined') {
                try {
                    if (liff.isLoggedIn()) {
                        console.log('Áî®Êà∂Â∑≤ÁôªÂÖ•ÔºåÁç≤ÂèñÁî®Êà∂Ë≥áÊñô');
                        liff.getProfile().then(profile => {
                            console.log('Áç≤ÂèñÂà∞Áî®Êà∂Ë≥áÊñô:', profile);
                            currentUser = {
                                userId: profile.userId,
                                displayName: profile.displayName,
                                pictureUrl: profile.pictureUrl
                            };
                            updateUserDisplay();
                            
                            // Ëá™ÂãïÊØîÂ∞çË¨õÂ∏´
                            console.log('Ê∫ñÂÇôÂü∑Ë°åËá™ÂãïÊØîÂ∞çË¨õÂ∏´...');
                            autoMatchTeacher(profile.userId, profile.displayName);
                        }).catch(error => {
                            console.error('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÂ§±Êïó:', error);
                            alert('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÂ§±ÊïóÔºåË´ãÈáçË©¶');
                        });
                    } else {
                        console.log('Áî®Êà∂Êú™ÁôªÂÖ•ÔºåÂòóË©¶ÁôªÂÖ•');
                        // ÈÄôÊúÉËß∏ÁôºLINEÁöÑÊéàÊ¨äÊµÅÁ®ã
                        liff.login().catch(error => {
                            console.error('ÁôªÂÖ•Â§±Êïó:', error);
                            alert('ÁôªÂÖ•Â§±ÊïóÔºåË´ãÈáçË©¶');
                        });
                    }
                } catch (error) {
                    console.error('LIFF Êìç‰ΩúÁï∞Â∏∏:', error);
                    alert('Á∂ÅÂÆöÂ§±ÊïóÔºåË´ãÈáçË©¶');
                }
            } else {
                console.log('LIFF SDK Êú™ËºâÂÖ•');
                alert('Ë´ãÂú®LINEÊáâÁî®Á®ãÂºè‰∏≠ÈñãÂïüÊ≠§È†ÅÈù¢');
            }
        }

        // Ëá™ÂãïÊØîÂ∞çË¨õÂ∏´
        async function autoMatchTeacher(userId, displayName) {
            console.log('ÈñãÂßãËá™ÂãïÊØîÂ∞çË¨õÂ∏´...', { userId, displayName });
            console.log('ÂáΩÊï∏Ë¢´Ë™øÁî®ÔºåÂèÉÊï∏:', { userId, displayName });
            
            // Âú®È†ÅÈù¢‰∏äÈ°ØÁ§∫ÊØîÂ∞çÈÅéÁ®ã
            showMatchingProcess('ÈñãÂßãÊØîÂ∞çË¨õÂ∏´...', 'info');
            addLoadingLog('üîç ÈñãÂßãË¨õÂ∏´Ë∫´‰ªΩÊØîÂ∞ç...', 'info');
            
            return new Promise(async (resolve) => {
            
            try {
                console.log('Ê∫ñÂÇôË™øÁî®Ë¨õÂ∏´ API...');
                showMatchingProcess('Ê≠£Âú®Ë™øÁî®Ë¨õÂ∏´ API...', 'info');
                addLoadingLog('üåê Ê≠£Âú®ÈÄ£Êé•Ë¨õÂ∏´Ë≥áÊñôÂ∫´...', 'info');
                
                // Ë®≠ÁΩÆ API Ë™øÁî®Ë∂ÖÊôÇÔºà10ÁßíÔºâ
                const apiTimeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('API Ë™øÁî®Ë∂ÖÊôÇ')), 10000);
                });
                
                // Êö´ÊôÇ‰ΩøÁî®ÁèæÊúâÁöÑË¨õÂ∏´ APIÔºàÈÅøÂÖç 404 ÂïèÈ°åÔºâ
                const apiCall = fetch('/api/teachers', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    redirect: 'follow'  // Ëá™ÂãïË∑üÈö®ÈáçÂÆöÂêë
                });
                
                const response = await Promise.race([apiCall, apiTimeout]);
                
                console.log('APIÂõûÊáâÁãÄÊÖã:', response.status);
                console.log('APIÂõûÊáâOK:', response.ok);
                showMatchingProcess(`APIÂõûÊáâÁãÄÊÖã: ${response.status}`, response.ok ? 'success' : 'error');
                addLoadingLog(`üì° API ÂõûÊáâ: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`APIË´ãÊ±ÇÂ§±Êïó: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('APIÂõûÊáâ:', data);
                showMatchingProcess('APIÂõûÊáâÊàêÂäüÔºåÈñãÂßãÊØîÂ∞çË¨õÂ∏´...', 'success');
                addLoadingLog('‚úÖ Ë¨õÂ∏´Ë≥áÊñôËºâÂÖ•ÊàêÂäü', 'success');
                
                // ËôïÁêÜ /api/teachers ÁöÑÂõûÊáâÊ†ºÂºè
                if (data.success && data.teachers && Array.isArray(data.teachers)) {
                    showMatchingProcess(`ÊâæÂà∞ ${data.teachers.length} ÂÄãË¨õÂ∏´ÔºåÈñãÂßãÊØîÂ∞ç...`, 'info');
                    addLoadingLog(`üë• ÊâæÂà∞ ${data.teachers.length} ÂÄãË¨õÂ∏´ÔºåÈñãÂßãÊØîÂ∞ç...`, 'info');
                    
                    // È°ØÁ§∫ÊØîÂ∞çÈÅéÁ®ã
                    showMatchingProcess(`ÊØîÂ∞çÊ¢ù‰ª∂: UserID=${userId}, DisplayName=${displayName}`, 'info');
                    addLoadingLog(`üîç ÊØîÂ∞çÊ¢ù‰ª∂: ${displayName} (${userId})`, 'info');
                    
                    // Â∞ãÊâæÂåπÈÖçÁöÑË¨õÂ∏´
                    addLoadingLog('üîç ÈñãÂßãÈÄê‰∏ÄÊØîÂ∞çË¨õÂ∏´...', 'info');
                    const matchedTeacher = data.teachers.find((teacher, index) => {
                        addLoadingLog(`üìù ÊØîÂ∞çÁ¨¨ ${index + 1} ‰ΩçË¨õÂ∏´: ${teacher.name}`, 'info');
                        
                        // Á≤æÁ¢∫ÊØîÂ∞çuserIdÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                        if (teacher.userId && userId && teacher.userId.toLowerCase() === userId.toLowerCase()) {
                            showMatchingProcess(`‚úÖ Á≤æÁ¢∫ÂåπÈÖçUserID: ${teacher.userId}`, 'success');
                            addLoadingLog(`üéØ Á≤æÁ¢∫ÂåπÈÖç UserID: ${teacher.userId}`, 'success');
                            return true;
                        }
                        // Ê®°Á≥äÊØîÂ∞çnameËàádisplayNameÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                        if (teacher.name && displayName) {
                            const teacherName = teacher.name.toLowerCase().trim();
                            const userName = displayName.toLowerCase().trim();
                            
                            // ÂÆåÂÖ®ÂåπÈÖçÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                            if (teacherName === userName) {
                                showMatchingProcess(`‚úÖ ÂÆåÂÖ®ÂåπÈÖçÂêçÁ®±: ${teacher.name}`, 'success');
                                addLoadingLog(`üéØ ÂÆåÂÖ®ÂåπÈÖçÂêçÁ®±: ${teacher.name}`, 'success');
                                return true;
                            }
                            
                            // ÂåÖÂê´ÂåπÈÖçÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                            if (teacherName.includes(userName) || userName.includes(teacherName)) {
                                showMatchingProcess(`‚úÖ ÂåÖÂê´ÂåπÈÖç: ${teacher.name}`, 'success');
                                addLoadingLog(`üéØ ÂåÖÂê´ÂåπÈÖç: ${teacher.name}`, 'success');
                                return true;
                            }
                            
                            // ÈÉ®ÂàÜÂåπÈÖçÔºàËá≥Â∞ë3ÂÄãÂ≠óÁ¨¶Ôºå‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                            if (teacherName.length >= 3 && userName.length >= 3) {
                                const commonChars = [...teacherName].filter(char => userName.includes(char)).length;
                                const similarity = commonChars / Math.max(teacherName.length, userName.length);
                                if (similarity >= 0.6) { // 60%Áõ∏‰ººÂ∫¶
                                    showMatchingProcess(`‚úÖ Áõ∏‰ººÂ∫¶ÂåπÈÖç: ${teacher.name} (${Math.round(similarity * 100)}%)`, 'success');
                                    addLoadingLog(`üéØ Áõ∏‰ººÂ∫¶ÂåπÈÖç: ${teacher.name} (${Math.round(similarity * 100)}%)`, 'success');
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                    
                    if (matchedTeacher) {
                        console.log('ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´:', matchedTeacher);
                        showMatchingProcess(`üéâ ÊâæÂà∞ÂåπÈÖçË¨õÂ∏´: ${matchedTeacher.name}`, 'success');
                        
                        // Ëá™ÂãïÈÅ∏ÊìáË¨õÂ∏´
                        const instructorSelect = document.getElementById('instructorSelect');
                        if (instructorSelect) {
                            // Ê®°Á≥äÊØîÂ∞çË¨õÂ∏´ÈÅ∏È†Ö
                            const matchedOption = findBestMatchingOption(instructorSelect, matchedTeacher.name);
                            
                            if (matchedOption) {
                                instructorSelect.value = matchedOption.value;
                                console.log('Ëá™ÂãïÈÅ∏ÊìáË¨õÂ∏´:', matchedOption.value);
                                
                                // Á´ãÂç≥Êõ¥Êñ∞Áµ±Ë®àÂíåÊ∏≤Êüì‰∫ã‰ª∂ÔºàÂú®Ë∑≥ËΩâÂâçÔºâ
                                updateStats();
                                renderEvents();
                                
                                // Ë∑≥ËΩâÂà∞Á¨¨‰∫åÊ≠•È©ü
                                showStep(2);
                                
                                showMatchingProcess(`‚úÖ Ëá™ÂãïÈÅ∏ÊìáË¨õÂ∏´ÊàêÂäü: ${matchedOption.value}`, 'success');
                                addLoadingLog(`üéØ Ëá™ÂãïÈÅ∏ÊìáË¨õÂ∏´: ${matchedOption.value}`, 'success');
                                
                                // ÊØîÂ∞çÊàêÂäüÔºåÈ°ØÁ§∫ÂÄã‰∫∫Ë°å‰∫ãÊõÜ
                                console.log('ÊØîÂ∞çÊàêÂäüÔºåÂ∞áÈ°ØÁ§∫ÂÄã‰∫∫Ë°å‰∫ãÊõÜ');
                                return;
                            }
                        }
                        
                        console.log('Êú™ÊâæÂà∞Â∞çÊáâÁöÑË¨õÂ∏´ÈÅ∏È†Ö');
                        showMatchingProcess(`‚ö†Ô∏è ÊâæÂà∞ÂåπÈÖçË¨õÂ∏´‰ΩÜÊú™Âú®ÂàóË°®‰∏≠: ${matchedTeacher.name}`, 'warning');
                        addLoadingLog(`‚ö†Ô∏è ÊâæÂà∞ÂåπÈÖçË¨õÂ∏´‰ΩÜÊú™Âú®ÂàóË°®‰∏≠: ${matchedTeacher.name}`, 'warning');
                        
                        // ÊØîÂ∞çÂ§±ÊïóÔºåÈ°ØÁ§∫ÂÖ®ÈÉ®Ë¨õÂ∏´
                        console.log('ÊØîÂ∞çÂ§±ÊïóÔºåÂ∞áÈ°ØÁ§∫ÂÖ®ÈÉ®Ë¨õÂ∏´');
                        instructorSelect.value = ''; // ÈÅ∏ÊìáÂÖ®ÈÉ®Ë¨õÂ∏´
                        // Á´ãÂç≥Êõ¥Êñ∞Áµ±Ë®àÂíåÊ∏≤Êüì‰∫ã‰ª∂
                        updateStats();
                        renderEvents();
                    } else {
                        console.log('Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´');
                        showMatchingProcess('‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´ÔºåË´ãÊâãÂãïÈÅ∏Êìá', 'error');
                        addLoadingLog('‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´ÔºåË´ãÊâãÂãïÈÅ∏Êìá', 'error');
                        
                        // ÊØîÂ∞çÂ§±ÊïóÔºåÈ°ØÁ§∫ÂÖ®ÈÉ®Ë¨õÂ∏´
                        console.log('ÊØîÂ∞çÂ§±ÊïóÔºåÂ∞áÈ°ØÁ§∫ÂÖ®ÈÉ®Ë¨õÂ∏´');
                        instructorSelect.value = ''; // ÈÅ∏ÊìáÂÖ®ÈÉ®Ë¨õÂ∏´
                        // Á´ãÂç≥Êõ¥Êñ∞Áµ±Ë®àÂíåÊ∏≤Êüì‰∫ã‰ª∂
                        updateStats();
                        renderEvents();
                    }
                } else {
                    console.error('APIÂõûÊáâÊ†ºÂºèÈåØË™§:', data);
                    showMatchingProcess('‚ùå APIÂõûÊáâÊ†ºÂºèÈåØË™§', 'error');
                }
            } catch (error) {
                console.error('Ëá™ÂãïÊØîÂ∞çË¨õÂ∏´Â§±Êïó:', error);
                showMatchingProcess(`‚ùå Ëá™ÂãïÊØîÂ∞çÂ§±Êïó: ${error.message}`, 'error');
                
                if (error.message.includes('Ë∂ÖÊôÇ')) {
                    addLoadingLog('‚è∞ API Ë™øÁî®Ë∂ÖÊôÇÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Êé•', 'error');
                } else if (error.message.includes('404')) {
                    addLoadingLog('‚ùå Ë¨õÂ∏´ API ‰∏çÂ≠òÂú®ÔºåË´ãËÅØÁπ´ÁÆ°ÁêÜÂì°', 'error');
                } else {
                    addLoadingLog(`‚ùå ÊØîÂ∞çÂ§±Êïó: ${error.message}`, 'error');
                }
            } finally {
                // ÁÑ°Ë´ñÊØîÂ∞çÊàêÂäüËàáÂê¶ÔºåÈÉΩËß£Êûê Promise
                addLoadingLog('üèÅ Ë¨õÂ∏´ÊØîÂ∞çÊµÅÁ®ãÁµêÊùü', 'info');
                resolve();
            }
            });
        }

        // È°ØÁ§∫ÊØîÂ∞çÈÅéÁ®ã
        function showMatchingProcess(message, type = 'info') {
            console.log(`[ÊØîÂ∞çÈÅéÁ®ã] ${message}`);
        }

        // Ëá™ÂãïÊªëÂãïÂà∞Ë°å‰∫ãÊõÜÂçÄÂüüÔºàÂÉÖË°åÂãïË£ùÁΩÆÔºâ
        function autoScrollToCalendar() {
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë°åÂãïË£ùÁΩÆ
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
            
            if (isMobile) {
                // Âª∂ÈÅ≤‰∏ÄÈªûÊôÇÈñìÁ¢∫‰øùÈ†ÅÈù¢ÂÆåÂÖ®ËºâÂÖ•
                setTimeout(() => {
                    const viewButtons = document.querySelector('.view-buttons');
                    if (viewButtons) {
                        viewButtons.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'end' // ËÆìÊåâÈàïÂàáÈΩäÂè≥Èù¢È†ÇÁ´Ø
                        });
                        console.log('Â∑≤Ëá™ÂãïÊªëÂãïÂà∞Ë°å‰∫ãÊõÜÂçÄÂüü');
                    }
                }, 1000);
            }
        }

        // Ê®°Á≥äÊØîÂ∞çË¨õÂ∏´ÈÅ∏È†Ö
        function findBestMatchingOption(selectElement, targetName) {
            if (!selectElement || !targetName) return null;
            
            const options = Array.from(selectElement.options);
            const target = targetName.toLowerCase().trim();
            
            console.log(`ÈñãÂßãÊ®°Á≥äÊØîÂ∞çË¨õÂ∏´ÈÅ∏È†ÖÔºåÁõÆÊ®ôÂêçÁ®±: "${targetName}"`);
            
            // 1. Á≤æÁ¢∫ÂåπÈÖç
            for (let option of options) {
                if (option.value.toLowerCase().trim() === target) {
                    console.log(`‚úÖ Á≤æÁ¢∫ÂåπÈÖç: ${option.value}`);
                    return option;
                }
            }
            
            // 2. ÂåÖÂê´ÂåπÈÖç
            for (let option of options) {
                const optionValue = option.value.toLowerCase().trim();
                if (optionValue.includes(target) || target.includes(optionValue)) {
                    console.log(`‚úÖ ÂåÖÂê´ÂåπÈÖç: ${option.value}`);
                    return option;
                }
            }
            
            // 3. Áõ∏‰ººÂ∫¶ÂåπÈÖç
            let bestMatch = null;
            let bestSimilarity = 0;
            
            for (let option of options) {
                const optionValue = option.value.toLowerCase().trim();
                const similarity = calculateSimilarity(target, optionValue);
                
                console.log(`ÊØîÂ∞ç "${option.value}": Áõ∏‰ººÂ∫¶ ${Math.round(similarity * 100)}%`);
                
                if (similarity > bestSimilarity && similarity >= 0.5) { // 50% Áõ∏‰ººÂ∫¶ÈñæÂÄº
                    bestMatch = option;
                    bestSimilarity = similarity;
                }
            }
            
            if (bestMatch) {
                console.log(`‚úÖ Áõ∏‰ººÂ∫¶ÂåπÈÖç: ${bestMatch.value} (${Math.round(bestSimilarity * 100)}%)`);
                return bestMatch;
            }
            
            console.log('‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´ÈÅ∏È†Ö');
            return null;
        }

        // Ë®àÁÆóÂ≠ó‰∏≤Áõ∏‰ººÂ∫¶
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            if (str1.length === 0 || str2.length === 0) return 0;
            
            // ‰ΩøÁî® Levenshtein Ë∑ùÈõ¢Ë®àÁÆóÁõ∏‰ººÂ∫¶
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;
            
            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            const maxLen = Math.max(len1, len2);
            return (maxLen - matrix[len2][len1]) / maxLen;
        }


        // È°ØÁ§∫ÊåáÂÆöÊ≠•È©ü
        function showStep(stepNumber) {
            console.log('Ë∑≥ËΩâÂà∞Ê≠•È©ü:', stepNumber);
            
            // Êõ¥Êñ∞Ê≠•È©üÁãÄÊÖã
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed', 'pending');
                
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
            
            // Ê†πÊìöÊ≠•È©üÈ°ØÁ§∫/Èö±ËóèÁõ∏ÈóúÂÖßÂÆπ
            if (stepNumber === 2) {
                // Á¨¨‰∫åÊ≠•ÔºöÊü•ÁúãË°å‰∫ãÊõÜ - Á¢∫‰øùË°å‰∫ãÊõÜÂçÄÂüüÂèØË¶ã
                const calendarSection = document.querySelector('.calendar-section');
                if (calendarSection) {
                    calendarSection.style.display = 'block';
                }
                
                // Á´ãÂç≥ÊªæÂãïÂà∞Ë°å‰∫ãÊõÜÂçÄÂüüÔºàÁßªÈô§Âª∂ÈÅ≤Ôºâ
                if (calendarSection) {
                    calendarSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }


        // Ë®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        function setupEventListeners() {
            // Ë¨õÂ∏´ÁØ©ÈÅ∏‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const instructorSelect = document.getElementById('instructorSelect');
            if (instructorSelect) {
                instructorSelect.addEventListener('change', function() {
                    updateStats();
                    renderEvents();
                });
            }
            
            // ÊôÇÊÆµÁØ©ÈÅ∏‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const timeFilter = document.getElementById('timeFilter');
            if (timeFilter) {
                timeFilter.addEventListener('change', function() {
                    updateStats();
                    renderEvents();
                });
            }
            
            // Êó•ÊúüÁØ©ÈÅ∏‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    updateStats();
                    renderEvents();
                });
            }
            
            // ÊéíÂ∫èÊñπÂºè‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const sortOrder = document.getElementById('sortOrder');
            if (sortOrder) {
                sortOrder.addEventListener('change', function() {
                    renderEvents();
                });
            }
            
            // ÁÇ∫Ë¶ñÂúñÊåâÈàïÊ∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
            document.querySelectorAll('.view-buttons .btn-primary').forEach(button => {
                button.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    switchView(view);
                });
            });
            
            // Á∂ÅÂÆöÁî®Êà∂ÊåâÈàï‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const bindUserBtn = document.getElementById('bindUserBtn');
            if (bindUserBtn) {
                bindUserBtn.addEventListener('click', bindUser);
            }
        }

        // ÁîüÊàêÈö®Ê©üÈ¶¨Âç°ÈæçÈ°èËâ≤
        function generateRandomMacaronColor() {
            const macaronColors = [
                'rgba(255, 182, 193, 0.8)', 'rgba(116, 185, 255, 0.8)', 'rgba(255, 223, 102, 0.8)', 
                'rgba(180, 167, 214, 0.8)', 'rgba(0, 184, 148, 0.8)', 'rgba(255, 192, 203, 0.8)',
                'rgba(162, 155, 254, 0.8)', 'rgba(85, 239, 196, 0.8)', 'rgba(255, 118, 117, 0.8)', 
                'rgba(108, 92, 231, 0.8)', 'rgba(232, 67, 147, 0.8)', 'rgba(0, 206, 201, 0.8)',
                'rgba(255, 159, 67, 0.8)', 'rgba(255, 107, 107, 0.8)', 'rgba(46, 204, 113, 0.8)',
                'rgba(155, 89, 182, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(241, 196, 15, 0.8)'
            ];
            return macaronColors[Math.floor(Math.random() * macaronColors.length)];
        }

        // ËºâÂÖ•Ë®≠ÁΩÆ
        function loadSettings() {
            const saved = localStorage.getItem('calendarSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                colorSettings = { ...colorSettings, ...settings.colors };
                instructorColors = settings.instructorColors || {};
                applyColorSettings();
            }
            // Ê≥®ÊÑèÔºöË¨õÂ∏´È°èËâ≤Â∞áÂú® loadEvents ÂÆåÊàêÂæåÁîüÊàê
        }

        // ÁÇ∫Ë¨õÂ∏´ÁîüÊàêÈö®Ê©üÈ¶¨Âç°ÈæçÈ°èËâ≤
        function generateRandomInstructorColors() {
            allInstructors.forEach(instructor => {
                if (!instructorColors[instructor]) {
                    instructorColors[instructor] = generateRandomMacaronColor();
                }
            });
        }

        // ÂÑ≤Â≠òË®≠ÁΩÆ
        function saveSettings() {
            // Êõ¥Êñ∞È°èËâ≤Ë®≠ÁΩÆÔºàÂ∞á hex ËΩâÊèõÁÇ∫ rgbaÔºâ
            colorSettings.esm = hexToRgba(document.getElementById('esmColor').value, 0.8);
            colorSettings.spm = hexToRgba(document.getElementById('spmColor').value, 0.8);
            colorSettings.boost = hexToRgba(document.getElementById('boostColor').value, 0.8);
            colorSettings.spike = hexToRgba(document.getElementById('spikeColor').value, 0.8);
            colorSettings.ev3 = hexToRgba(document.getElementById('ev3Color').value, 0.8);
            colorSettings.minecraft = hexToRgba(document.getElementById('minecraftColor').value, 0.8);

            const settings = {
                colors: colorSettings,
                instructorColors: instructorColors
            };
            localStorage.setItem('calendarSettings', JSON.stringify(settings));
            applyColorSettings();
            closeSettings();
        }

        // ÊáâÁî®È°èËâ≤Ë®≠ÁΩÆ
        function applyColorSettings() {
            // Êõ¥Êñ∞CSSËÆäÊï∏
            document.documentElement.style.setProperty('--esm-color', colorSettings.esm);
            document.documentElement.style.setProperty('--spm-color', colorSettings.spm);
            document.documentElement.style.setProperty('--boost-color', colorSettings.boost);
            document.documentElement.style.setProperty('--spike-color', colorSettings.spike);
            document.documentElement.style.setProperty('--ev3-color', colorSettings.ev3);
            document.documentElement.style.setProperty('--minecraft-color', colorSettings.minecraft);
            
            // ÈáçÊñ∞Ê∏≤Êüì‰∫ã‰ª∂
            if (allEvents.length > 0) {
                renderEvents();
            }
        }

        // ÊâìÈñãË®≠ÁΩÆÁï´Èù¢
        function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            
            // Á¢∫‰øùË¨õÂ∏´È°èËâ≤Â∑≤Á∂ìÁîüÊàê
            if (allInstructors && allInstructors.length > 0) {
                generateRandomInstructorColors();
            }
            
            populateSettingsModal();
        }

        // Â°´ÂÖÖË®≠ÁΩÆÊ®°ÊÖãÊ°Ü
        function populateSettingsModal() {
            // Ë®≠ÁΩÆË™≤Á®ãÈ°ûÂûãÈ°èËâ≤ÔºàÂ∞á rgba ËΩâÊèõÁÇ∫ hexÔºâ
            document.getElementById('esmColor').value = rgbaToHex(colorSettings.esm);
            document.getElementById('spmColor').value = rgbaToHex(colorSettings.spm);
            document.getElementById('boostColor').value = rgbaToHex(colorSettings.boost);
            document.getElementById('spikeColor').value = rgbaToHex(colorSettings.spike);
            document.getElementById('ev3Color').value = rgbaToHex(colorSettings.ev3);
            document.getElementById('minecraftColor').value = rgbaToHex(colorSettings.minecraft);
            
            // Â°´ÂÖÖË¨õÂ∏´È°èËâ≤Ë®≠ÁΩÆ
            populateInstructorColorSettings();
        }

        // ÈóúÈñâË®≠ÁΩÆÁï´Èù¢
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }

        // Â°´ÂÖÖË¨õÂ∏´È°èËâ≤Ë®≠ÁΩÆ
        function populateInstructorColorSettings() {
            const container = document.getElementById('instructorColorGroup');
            container.innerHTML = '';
            
            // Á¢∫‰øù allInstructors Â∑≤Á∂ìËºâÂÖ•
            if (!allInstructors || allInstructors.length === 0) {
                console.log('Ë¨õÂ∏´ÂàóË°®Â∞öÊú™ËºâÂÖ•ÔºåÁÑ°Ê≥ïÂ°´ÂÖÖÈ°èËâ≤Ë®≠ÁΩÆ');
                return;
            }
            
            console.log('Â°´ÂÖÖË¨õÂ∏´È°èËâ≤Ë®≠ÁΩÆÔºåË¨õÂ∏´ÂàóË°®:', allInstructors);
            console.log('Áï∂ÂâçË¨õÂ∏´È°èËâ≤:', instructorColors);
            
            allInstructors.forEach(instructor => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-picker-item'; // ‰ΩøÁî®ËàáÊïôÊ°àÈ°ûÂûãÈ°èËâ≤Áõ∏ÂêåÁöÑ class
                const currentColor = instructorColors[instructor] || generateRandomMacaronColor();
                const hexColor = rgbaToHex(currentColor);
                console.log(`Ë¨õÂ∏´ ${instructor} ÁöÑÈ°èËâ≤: ${currentColor} -> ${hexColor}`);
                
                colorItem.innerHTML = `
                    <label>${instructor}</label>
                    <input type="color" class="color-picker" 
                           id="instructor_${instructor}" 
                           value="${hexColor}"
                           onchange="updateInstructorColor('${instructor}', this.value)">
                `;
                container.appendChild(colorItem);
            });
        }

        // Êõ¥Êñ∞Ë¨õÂ∏´È°èËâ≤
        function updateInstructorColor(instructor, color) {
            // Â∞á hex È°èËâ≤ËΩâÊèõÁÇ∫ rgba Ê†ºÂºè
            const rgbaColor = hexToRgba(color, 0.8);
            instructorColors[instructor] = rgbaColor;
        }

        // Â∞á hex È°èËâ≤ËΩâÊèõÁÇ∫ rgba Ê†ºÂºè
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Â∞á rgba È°èËâ≤ËΩâÊèõÁÇ∫ hex Ê†ºÂºèÔºàÁî®ÊñºÈ°èËâ≤ÈÅ∏ÊìáÂô®Ôºâ
        function rgbaToHex(rgba) {
            const values = rgba.match(/\d+/g);
            if (values && values.length >= 3) {
                const r = parseInt(values[0]);
                const g = parseInt(values[1]);
                const b = parseInt(values[2]);
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            return '#000000';
        }

// ËºâÂÖ•Áï∂Êó•‰∫ã‰ª∂ÔºàÁõ¥Êé•ËºâÂÖ•ÂÆåÊï¥Êï∏ÊìöÔºâ
async function loadTodayEvents() {
    try {
        console.log('üöÄ ÈñãÂßãËºâÂÖ•ÂÆåÊï¥‰∫ã‰ª∂Êï∏Êìö...');
        addLoadingLog('üåê Ê≠£Âú®ÈÄ£Êé• CalDAV ‰º∫ÊúçÂô®...', 'info');
        
        const response = await fetch('/api/events');
        addLoadingLog('üì° Ê≠£Âú®Áç≤ÂèñË°å‰∫ãÊõÜË≥áÊñô...', 'info');
        
        const data = await response.json();
        
        if (data.success) {
            addLoadingLog(`üìä ÊàêÂäüÁç≤Âèñ ${data.data.length} ÂÄã‰∫ã‰ª∂`, 'success');
            
            allEvents = data.data;
            allInstructors = [...new Set(allEvents.map(event => event.instructor).filter(Boolean))];
            
            addLoadingLog(`üë• ÁôºÁèæ ${allInstructors.length} ‰ΩçË¨õÂ∏´`, 'info');
            
            // ÁÇ∫Êñ∞Ë¨õÂ∏´ÁîüÊàêÈö®Ê©üÈ¶¨Âç°ÈæçÈ°èËâ≤ÔºàÂ¶ÇÊûúÊ≤íÊúâ‰øùÂ≠òÁöÑË®≠ÁΩÆÔºâ
            if (Object.keys(instructorColors).length === 0) {
                addLoadingLog('üé® Ê≠£Âú®ÁîüÊàêË¨õÂ∏´È°èËâ≤ÈÖçÁΩÆ...', 'info');
                generateRandomInstructorColors();
            }
            
            addLoadingLog('üîÑ Ê≠£Âú®Ê∏≤Êüì‰∫ã‰ª∂ÂàóË°®...', 'info');
            populateInstructorDropdown();
            renderEvents();
            updateStats();
            
            console.log(`‚úÖ ÂÆåÊï¥‰∫ã‰ª∂ËºâÂÖ•ÂÆåÊàê: ${allEvents.length} ÂÄã‰∫ã‰ª∂`);
            addLoadingLog(`‚úÖ ËºâÂÖ•ÂÆåÊàêÔºÅÂÖ± ${allEvents.length} ÂÄã‰∫ã‰ª∂`, 'success');
            hideLoadingMessage();
        } else {
            showError('ËºâÂÖ•‰∫ã‰ª∂Â§±Êïó: ' + data.message);
        }
    } catch (error) {
        console.error('ËºâÂÖ•‰∫ã‰ª∂ÈåØË™§:', error);
        showError('ÁÑ°Ê≥ïÈÄ£Êé•Âà∞ÊúçÂãôÂô®');
    }
}


        // ËºâÂÖ•‰∫ã‰ª∂Ë≥áÊñôÔºàÂêëÂæåÁõ∏ÂÆπÔºâ
        async function loadEvents() {
            return loadTodayEvents();
        }

        // ËºâÂÖ•Êó•Ë™åÁÆ°ÁêÜ
        let loadingLogs = [];
        
        function addLoadingLog(message, type = 'info') {
            const logItem = {
                message,
                type,
                timestamp: new Date().toLocaleTimeString()
            };
            loadingLogs.push(logItem);
            
            const logsContainer = document.getElementById('loadingLogs');
            if (logsContainer) {
                const logElement = document.createElement('div');
                logElement.className = `loading-log-item ${type}`;
                
                const icon = {
                    'success': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'info': '‚ÑπÔ∏è'
                }[type] || '‚ÑπÔ∏è';
                
                logElement.innerHTML = `
                    <span class="loading-log-icon">${icon}</span>
                    <span>[${logItem.timestamp}] ${message}</span>
                `;
                
                logsContainer.appendChild(logElement);
                
                // Ëá™ÂãïÊªæÂãïÂà∞ÊúÄÊñ∞Êó•Ë™å
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        // È°ØÁ§∫ËºâÂÖ•ÈÄ≤Â∫¶ÊèêÁ§∫
        function showLoadingMessage(message) {
            addLoadingLog(message, 'info');
            // ÁßªÈô§ÁèæÊúâÁöÑËºâÂÖ•ÊèêÁ§∫
            const existingMessage = document.getElementById('loading-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // ÂâµÂª∫ËºâÂÖ•ÊèêÁ§∫ÂÖÉÁ¥†
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 123, 255, 0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            loadingDiv.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                ${message}
            `;
            
            document.body.appendChild(loadingDiv);
        }

        // Èö±ËóèËºâÂÖ•ÈÄ≤Â∫¶ÊèêÁ§∫
        function hideLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (loadingMessage.parentNode) {
                        loadingMessage.remove();
                    }
                }, 300);
            }
        }

        // Â°´ÂÖÖË¨õÂ∏´‰∏ãÊãâÈÅ∏ÂñÆ
        function populateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            select.innerHTML = '<option value="">ÂÖ®ÈÉ®Ë¨õÂ∏´</option>';

            allInstructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor;
                option.textContent = instructor;
                select.appendChild(option);
            });
        }

        // Êõ¥Êñ∞Ë¨õÂ∏´‰∏ãÊãâÈÅ∏ÂñÆÔºà‰∏çÈáçÊñ∞Ê∏≤ÊüìÊï¥ÂÄãÁï´Èù¢Ôºâ
        function updateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            const currentValue = select.value;
            
            // Ê∏ÖÁ©∫ÁèæÊúâÈÅ∏È†ÖÔºàÈô§‰∫Ü"ÂÖ®ÈÉ®Ë¨õÂ∏´"Ôºâ
            select.innerHTML = '<option value="">ÂÖ®ÈÉ®Ë¨õÂ∏´</option>';

            // Ê∑ªÂä†ÊâÄÊúâË¨õÂ∏´ÈÅ∏È†Ö
            allInstructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor;
                option.textContent = instructor;
                select.appendChild(option);
            });
            
            // ÊÅ¢Âæ©‰πãÂâçÈÅ∏‰∏≠ÁöÑÂÄº
            if (currentValue && allInstructors.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // ÂàáÊèõÊ™¢Ë¶ñÊ®°Âºè
        function switchView(view) {
            currentView = view;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã - Âè™ÈáùÂ∞çË¶ñÂúñÊåâÈàï
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            viewButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÊâæÂà∞Â∞çÊáâÁöÑÊåâÈàï‰∏¶Ë®≠ÁÇ∫Ê¥ªË∫ç
            viewButtons.forEach(btn => {
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                }
            });
            
            // Êõ¥Êñ∞Áµ±Ë®àË≥áË®äÔºàÂåÖÊã¨Êó•ÊúüÁØÑÂúçÔºâ
            updateStats();
            renderEvents();
        }

        // Ê∏≤Êüì‰∫ã‰ª∂
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            let filteredEvents = allEvents.filter(event => {
                // Ë¨õÂ∏´ÁØ©ÈÅ∏
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // ÊôÇÊÆµÁØ©ÈÅ∏
                if (timeFilter) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getUTCHours();
                    let timeMatch = false;
                    
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    
                    if (!timeMatch) {
                    return false;
                    }
                }
                
                // ÊåáÂÆöÊó•ÊúüÁØ©ÈÅ∏
                if (dateFilter) {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    
                    // ‰ΩøÁî®UTCÊôÇÈñìÈÄ≤Ë°åÊó•ÊúüÊØîËºÉ
                    const eventYear = eventDate.getUTCFullYear();
                    const eventMonth = eventDate.getUTCMonth();
                    const eventDay = eventDate.getUTCDate();
                    const filterYear = filterDate.getUTCFullYear();
                    const filterMonth = filterDate.getUTCMonth();
                    const filterDay = filterDate.getUTCDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // Êó•ÊúüÁØ©ÈÅ∏
                const eventDate = new Date(event.start);
                const now = new Date();
                
                let shouldShow = false;
                switch (currentView) {
                    case 'today':
                        // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñìÈÄ≤Ë°åÊó•ÊúüÊØîËºÉÔºåÁ¢∫‰øùËàáÈ°ØÁ§∫‰∏ÄËá¥
                        const eventYear = eventDate.getFullYear();
                        const eventMonth = eventDate.getMonth();
                        const eventDay = eventDate.getDate();
                        const nowYear = now.getFullYear();
                        const nowMonth = now.getMonth();
                        const nowDay = now.getDate();
                        shouldShow = eventYear === nowYear && eventMonth === nowMonth && eventDay === nowDay;
                        console.log(`‰∫ã‰ª∂ÁØ©ÈÅ∏ - Ê®ôÈ°å: ${event.title}, ‰∫ã‰ª∂Êó•Êúü: ${eventYear}-${eventMonth+1}-${eventDay}, ‰ªäÂ§©: ${nowYear}-${nowMonth+1}-${nowDay}, È°ØÁ§∫: ${shouldShow}`);
                        break;
                    case 'week':
                        // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñìÈÄ≤Ë°åÊú¨ÈÄ±ÁØ©ÈÅ∏ÔºàÈÄ±‰∏ÄÂà∞ÈÄ±Êó•Ôºâ
                        const weekStart = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // ÈÄ±Êó•ÊôÇÂõûÂà∞‰∏äÈÄ±‰∏ÄÔºåÂÖ∂‰ªñÂ§©ÂõûÂà∞Êú¨ÈÄ±‰∏Ä
                        weekStart.setDate(now.getDate() + daysToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6); // ÈÄ±Êó•
                        weekEnd.setHours(23, 59, 59, 999);
                        shouldShow = eventDate >= weekStart && eventDate <= weekEnd;
                        break;
                    case 'month':
                        // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñìÈÄ≤Ë°åÊú¨ÊúàÁØ©ÈÅ∏
                        shouldShow = eventDate.getMonth() === now.getMonth() && eventDate.getFullYear() === now.getFullYear();
                        console.log(`üìÖ Êú¨ÊúàÁØ©ÈÅ∏ - Ê®ôÈ°å: ${event.title}, ‰∫ã‰ª∂Êó•Êúü: ${eventDate.getFullYear()}-${eventDate.getMonth()+1}-${eventDate.getDate()}, Áï∂Ââç: ${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}, È°ØÁ§∫: ${shouldShow}`);
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                        break;
                }
                
                return shouldShow;
            });
            
            // ÊéíÂ∫è‰∫ã‰ª∂ - ÂÑ™ÂåñÊéíÂ∫èÈÇèËºØ
            filteredEvents.sort((a, b) => {
                const now = new Date();
                const eventA = new Date(a.start);
                const eventB = new Date(b.start);
                const endA = new Date(a.end);
                const endB = new Date(b.end);
                
                // Âà§Êñ∑‰∫ã‰ª∂ÁãÄÊÖã
                const isEventAOngoing = eventA <= now && endA > now;
                const isEventBOngoing = eventB <= now && endB > now;
                const isEventAPast = endA < now;
                const isEventBPast = endB < now;
                const isEventAUpcoming = eventA > now;
                const isEventBUpcoming = eventB > now;
                
                // ÂÑ™ÂÖàÊéíÂ∫èÔºöÊ≠£Âú®ÈÄ≤Ë°å‰∏≠ > Âç≥Â∞áÈñãÂßã > Â∑≤ÁµêÊùü
                if (isEventAOngoing && !isEventBOngoing) return -1;
                if (!isEventAOngoing && isEventBOngoing) return 1;
                
                if (isEventAUpcoming && isEventBPast) return -1;
                if (isEventAPast && isEventBUpcoming) return 1;
                
                // Âú®Áõ∏ÂêåÁãÄÊÖã‰∏ãÔºåÊåâÊôÇÈñìÊéíÂ∫è
                switch (sortOrder) {
                    case 'time':
                        return eventA - eventB;
                    case 'instructor':
                        return a.instructor.localeCompare(b.instructor);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    default:
                        return eventA - eventB;
                }
            });
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="no-events">
                        <i class="fas fa-calendar-times"></i>
                        <h3>Ê≤íÊúâÊâæÂà∞‰∫ã‰ª∂</h3>
                        <p>Ë´ãÂòóË©¶Ë™øÊï¥ÁØ©ÈÅ∏Ê¢ù‰ª∂</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredEvents.map(event => createEventCard(event)).join('');
            
            // Ëß∏Áôº‰∫ã‰ª∂Âç°ÁâáÂãïÁï´
            setTimeout(() => {
                animateEventCards();
                // Êõ¥Êñ∞ÂÄíÊï∏Ë®àÊôÇ
                updateAllCountdowns();
            }, 100);
        }

        // ÂæûÊ®ôÈ°åËß£ÊûêÊôÇÈñì
        function parseTimeFromTitle(title) {
            // ÂåπÈÖçÊ†ºÂºèÂ¶Ç "18:30-20:30", "14:30-15:30", "16:30-17:30", "1630-1730" Á≠â
            const timeMatch = title.match(/(\d{1,2}):?(\d{2})-(\d{1,2}):?(\d{2})/);
            if (timeMatch) {
                const startHour = timeMatch[1];
                const startMin = timeMatch[2];
                const endHour = timeMatch[3];
                const endMin = timeMatch[4];
                
                // Ê†ºÂºèÂåñÊôÇÈñìÁÇ∫ HH:MM Ê†ºÂºè
                const startTime = `${startHour.padStart(2, '0')}:${startMin}`;
                const endTime = `${endHour.padStart(2, '0')}:${endMin}`;
                
                return {
                    startTime: startTime,
                    endTime: endTime,
                    timeString: `${startTime} - ${endTime}`
                };
            }
            return null;
        }

        // ÂæûÊ®ôÈ°åËß£ÊûêÊó•ÊúüÔºàÊ†πÊìöÊòüÊúüÂπæÔºâ
        function parseDateFromTitle(title, baseDate = new Date()) {
            // Áõ¥Êé•‰ΩøÁî® CalDAV ÁöÑÊó•ÊúüÔºå‰∏çÈáçÊñ∞Ë®àÁÆó
            // Âõ†ÁÇ∫ CalDAV Â∑≤Á∂ìÊèê‰æõ‰∫ÜÊ≠£Á¢∫ÁöÑÊó•Êúü
            return baseDate;
        }

        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂÅúË™≤/Ë´ãÂÅá
        function isCancelled(event) {
            const title = event.title.toLowerCase();
            const description = (event.description || '').toLowerCase();
            const cancelledKeywords = ['Ë´ãÂÅá', 'ÂÅúË™≤', 'ÂèñÊ∂à', 'Êö´ÂÅú', '‰ºëÊÅØ', 'ÊîæÂÅá'];
            
            return cancelledKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // ÂâµÂª∫‰∫ã‰ª∂Âç°Áâá
        function createEventCard(event) {
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            const isCancelledEvent = isCancelled(event);
            
            // ÂæûÊ®ôÈ°åËß£ÊûêÊôÇÈñì
            const titleTime = parseTimeFromTitle(event.title);
            
            // Áµ±‰∏Ä‰ΩøÁî® CalDAV ÁöÑÊó•ÊúüÔºåÁ¢∫‰øùÊó•ÊúüÊ≠£Á¢∫
            const displayDate = startDate.toLocaleDateString('zh-TW');
            let timeString;
            
            if (titleTime) {
                // ‰ΩøÁî®Ê®ôÈ°åËß£ÊûêÁöÑÊôÇÈñìÔºå‰ΩÜÊó•Êúü‰ΩøÁî® CalDAV
                timeString = titleTime.timeString;
                
                console.log(`Ê®ôÈ°åËß£Êûê - ${event.title}:`);
                console.log(`  ÂéüÂßã start: ${event.start}`);
                console.log(`  startDate Áâ©‰ª∂:`, startDate);
                console.log(`  CalDAVÊó•Êúü: ${displayDate}`);
                console.log(`  Ëß£ÊûêÊôÇÈñì: ${timeString}`);
                console.log(`  CalDAVÊôÇÈñì: ${startDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })} - ${endDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })}`);
            } else {
                // ÂõûÈÄÄÂà∞CalDAVÊôÇÈñì
                timeString = `${startDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })} - ${endDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })}`;
                console.log(`ÁÑ°Ê≥ïËß£ÊûêÊ®ôÈ°åÊôÇÈñìÔºå‰ΩøÁî®CalDAVÊôÇÈñì - ${event.title}: ${displayDate} ${timeString}`);
            }
            
            // Ê∏ÖÁêÜÊèèËø∞ÂÖßÂÆπ
            let cleanDescription = event.description || '';
            
            // ÁßªÈô§ÊäÄË°ìÊ®ôÁ±§ÂíåÈáçË§áË≥áË®ä
            cleanDescription = cleanDescription
                .replace(/\[NOTION_SYNC\]/g, '')
                .replace(/ÊôÇÈñì:.*?Ë¨õÂ∏´:/g, '')
                .replace(/Ë¨õÂ∏´:.*?TA:/g, '')
                .replace(/TA:.*?Á¨¨‰∏ÄÊúü:/g, '')
                .replace(/Á¨¨‰∏ÄÊúü:/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            // Â∞ãÊâæÊïôÊ°àÈÄ£Áµê - ÂæûÂéüÂßãÊèèËø∞‰∏≠ÊèêÂèñ
            // ÂÑ™ÂÖàÂåπÈÖçÊã¨ËôüÂÖßÁöÑÂÆåÊï¥ Notion ÈÄ£ÁµêÔºàÂåÖÂê´ ?pvs=21 Á≠âÂèÉÊï∏Ôºâ
            const notionUrlRegex = /\(https:\/\/www\.notion\.so\/([^)]+)\)/;
            let notionMatch = event.description.match(notionUrlRegex);
            
            // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Êã¨ËôüÂÖßÁöÑÈÄ£ÁµêÔºåÂâáÂåπÈÖç‰∏ÄËà¨ÁöÑ Notion ÈÄ£Áµê
            if (!notionMatch) {
                const generalNotionRegex = /https:\/\/www\.notion\.so\/([^)\s]+)/;
                notionMatch = event.description.match(generalNotionRegex);
            }
            
            let lessonButton = '';
            if (notionMatch) {
                const lessonUrl = `https://www.notion.so/${notionMatch[1]}`;
                
                // ÊèêÂèñÊïôÊ°àÂêçÁ®±ÂíåÈ°ûÂûã
                let lessonName = 'Êü•ÁúãÊïôÊ°à';
                let lessonType = 'ÊïôÊ°à';
                
                // ÂæûÂéüÂßãÊèèËø∞‰∏≠ÊèêÂèñÊïôÊ°àË≥áË®ä
                const originalDescription = event.description;
                
                // ÂåπÈÖçÂêÑÁ®ÆÊïôÊ°àÊ†ºÂºèÔºåÂÑ™ÂÖàÂåπÈÖçÊã¨ËôüÂâçÁöÑÊïôÊ°àÂêçÁ®±
                const lessonMatch = originalDescription.match(/(ESMÊïôÊ°à|SPMÊïôÊ°à|SPIKEÊïôÊ°à|BOOSTÊïôÊ°à|EV3ÊïôÊ°à|MINECRAFTÊïôÊ°à)[:\s]*([^(]+?)(?:\s*\(https:\/\/www\.notion\.so)/);
                if (lessonMatch && lessonMatch[2]) {
                    lessonName = lessonMatch[2].trim();
                    lessonType = lessonMatch[1].replace('ÊïôÊ°à', '');
                }
                
                lessonButton = `
                    <div class="lesson-section">
                        <div class="lesson-label">${lessonType}ÊïôÊ°à</div>
                        <a href="${lessonUrl}" target="_blank" class="lesson-button ${lessonType.toLowerCase()}">
                            <i class="fas fa-book"></i> ${lessonName}
                        </a>
                    </div>
                `;
            }
            
        // ËôïÁêÜ‰ΩçÁΩÆË≥áË®ä
        let location = event.location;
        if (!location || location === 'nan' || location === 'null' || location === '' || location.trim() === '') {
            location = 'FLBÂ∑•‰ΩúÂÆ§';
        }
        
        // Â¶ÇÊûúÊòØÁ´ôÂâçÊïôÂÆ§ÔºåË®≠ÂÆöÈ†êË®≠Âú∞ÂùÄ
        if (location === 'Á´ôÂâçÊïôÂÆ§') {
            location = 'Âè∞ÂåóÂ∏Ç‰∏≠Ê≠£ÂçÄÈñãÂ∞ÅË°ó1ÊÆµ2Ëôü9Ê®ì';
        }
            
            // Ë¨õÂ∏´Â∫ïËâ≤
            const instructorColor = instructorColors[event.instructor] || '#667eea';
            const instructorStyle = instructorColors[event.instructor] ? 'custom-color' : '';
            
            return `
                <div class="event-card ${isCancelledEvent ? 'cancelled-event' : ''}">
                    <div class="event-header">
                        <div>
                            <div class="event-title">
                                ${event.title}
                                ${isCancelledEvent ? '<span class="cancelled-badge"><i class="fas fa-ban"></i> ‚ö†Ô∏è ÂÅúË™≤ ‚ö†Ô∏è</span>' : ''}
                            </div>
                            <div class="event-instructor ${instructorStyle}" style="--instructor-color: ${instructorColor}">
                                <i class="fas fa-user"></i> ${event.instructor}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-details">
                        <div class="event-detail">
                            <i class="fas fa-calendar"></i>
                            <span>${displayDate}</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-clock"></i>
                            <span>${timeString}</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}" 
                               target="_blank" 
                               class="location-link"
                               title="ÈªûÊìäÊü•ÁúãÂú∞Âúñ">
                                <i class="fas fa-map-marked-alt location-map-icon"></i>
                                <span>${location}</span>
                                <i class="fas fa-external-link-alt location-external-icon"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="countdown-timer" 
                         data-start-time="${event.start}" 
                         data-end-time="${event.end}">
                        <i class="fas fa-clock countdown-icon"></i>
                        <span class="countdown-text">Ë®àÁÆó‰∏≠...</span>
                    </div>
                    
                    <div class="event-description">
                        <h4><i class="fas fa-info-circle"></i> Ë™≤Á®ãÊèèËø∞</h4>
                        <p>${cleanDescription || 'ÁÑ°ÊèèËø∞'}</p>
                    </div>
                    
                    ${lessonButton}
                </div>
            `;
        }

        // Êõ¥Êñ∞Áµ±Ë®àË≥áË®ä
        function updateStats() {
            // ‰ΩøÁî®Ëàá renderEvents Áõ∏ÂêåÁöÑÁØ©ÈÅ∏ÈÇèËºØ
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const filteredEvents = allEvents.filter(event => {
                // Ë¨õÂ∏´ÁØ©ÈÅ∏
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // ÊôÇÊÆµÁØ©ÈÅ∏
                if (timeFilter) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours(); // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñì
                    let timeMatch = false;
                    
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    
                    if (!timeMatch) {
                        return false;
                    }
                }
                
                // ÊåáÂÆöÊó•ÊúüÁØ©ÈÅ∏
                if (dateFilter) {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    
                    // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñìÈÄ≤Ë°åÊó•ÊúüÊØîËºÉ
                    const eventYear = eventDate.getFullYear();
                    const eventMonth = eventDate.getMonth();
                    const eventDay = eventDate.getDate();
                    const filterYear = filterDate.getFullYear();
                    const filterMonth = filterDate.getMonth();
                    const filterDay = filterDate.getDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // Ê™¢Ë¶ñÊ®°ÂºèÁØ©ÈÅ∏
                const eventDate = new Date(event.start);
                const now = new Date();
                
                let shouldShow = false;
                switch (currentView) {
                    case 'today':
                        // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñìÈÄ≤Ë°åÊó•ÊúüÊØîËºÉÔºåÁ¢∫‰øùËàáÈ°ØÁ§∫‰∏ÄËá¥
                        const eventYear = eventDate.getFullYear();
                        const eventMonth = eventDate.getMonth();
                        const eventDay = eventDate.getDate();
                        const nowYear = now.getFullYear();
                        const nowMonth = now.getMonth();
                        const nowDay = now.getDate();
                        shouldShow = eventYear === nowYear && eventMonth === nowMonth && eventDay === nowDay;
                        break;
                    case 'week':
                        // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñìÈÄ≤Ë°åÊú¨ÈÄ±ÁØ©ÈÅ∏ÔºàÈÄ±‰∏ÄÂà∞ÈÄ±Êó•Ôºâ
                        const weekStart = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        weekStart.setDate(now.getDate() + daysToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        weekEnd.setHours(23, 59, 59, 999);
                        shouldShow = eventDate >= weekStart && eventDate <= weekEnd;
                        break;
                    case 'month':
                        // ‰ΩøÁî®Êú¨Âú∞ÊôÇÈñìÈÄ≤Ë°åÊú¨ÊúàÁØ©ÈÅ∏
                        shouldShow = eventDate.getMonth() === now.getMonth() && eventDate.getFullYear() === now.getFullYear();
                        console.log(`üìÖ Êú¨ÊúàÁØ©ÈÅ∏ - Ê®ôÈ°å: ${event.title}, ‰∫ã‰ª∂Êó•Êúü: ${eventDate.getFullYear()}-${eventDate.getMonth()+1}-${eventDate.getDate()}, Áï∂Ââç: ${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}, È°ØÁ§∫: ${shouldShow}`);
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                        break;
                }
                
                return shouldShow;
            });
            
            // Ë®àÁÆóÁØ©ÈÅ∏ÂæåÁöÑË¨õÂ∏´Êï∏Èáè
            const uniqueInstructors = new Set(filteredEvents.map(event => event.instructor));
            const instructorCount = uniqueInstructors.size;
            
            // Ë™øË©¶Êó•Ë™åÔºöÈ°ØÁ§∫ÁØ©ÈÅ∏ÁµêÊûú
            console.log(`üìä ÁØ©ÈÅ∏ÁµêÊûú - Ê®°Âºè: ${currentView}, Á∏Ω‰∫ã‰ª∂: ${allEvents.length}, ÁØ©ÈÅ∏Âæå: ${filteredEvents.length}`);
            if (currentView === 'week' || currentView === 'month') {
                console.log(`üìÖ ${currentView === 'week' ? 'Êú¨ÈÄ±' : 'Êú¨Êúà'}‰∫ã‰ª∂Ë©≥ÊÉÖ:`, filteredEvents.map(e => ({
                    title: e.title,
                    instructor: e.instructor,
                    start: e.start,
                    date: new Date(e.start).toLocaleDateString('zh-TW')
                })));
            }
            
            // Ê†πÊìöÁï∂ÂâçÁØ©ÈÅ∏Ê®°ÂºèË®àÁÆóÊó•ÊúüÁØÑÂúç
            let dateRange = '-';
            const now = new Date();
            
            switch (currentView) {
                case 'today':
                    dateRange = now.toLocaleDateString('zh-TW');
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    // Ë®àÁÆóÊú¨ÈÄ±‰∏ÄÁöÑÊó•ÊúüÔºàgetDay() ËøîÂõû 0-6Ôºå0ÊòØÈÄ±Êó•Ôºå1ÊòØÈÄ±‰∏ÄÔºâ
                    const dayOfWeek = now.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // ÈÄ±Êó•ÊôÇÂõûÂà∞‰∏äÈÄ±‰∏ÄÔºåÂÖ∂‰ªñÂ§©ÂõûÂà∞Êú¨ÈÄ±‰∏Ä
                    weekStart.setDate(now.getDate() + daysToMonday);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6); // ÈÄ±Êó•
                    dateRange = `${weekStart.toLocaleDateString('zh-TW')} - ${weekEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    dateRange = `${monthStart.toLocaleDateString('zh-TW')} - ${monthEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case 'all':
                default:
            if (allEvents.length > 0) {
                const dates = allEvents.map(event => new Date(event.start));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                        dateRange = `${minDate.toLocaleDateString('zh-TW')} - ${maxDate.toLocaleDateString('zh-TW')}`;
                    }
                    break;
            }
            
            document.getElementById('dateRange').textContent = dateRange;
            document.getElementById('totalEvents').textContent = filteredEvents.length;
            document.getElementById('instructorCount').textContent = instructorCount;
        }

        // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
        function showError(message) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `
                <div class="no-events">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>ËºâÂÖ•Â§±Êïó</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâË®≠ÁΩÆÁï´Èù¢
        const settingsOverlay = document.getElementById('settingsOverlay');
        if (settingsOverlay) {
            settingsOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettings();
                }
            });
        }
    </script>
</body>
</html>// Railway Âº∑Âà∂ÈáçÊñ∞ÈÉ®ÁΩ≤ - Wed Sep 17 10:03:13 CST 2025
// Âº∑Âà∂ Railway ÈáçÊñ∞ÈÉ®ÁΩ≤ - Wed Sep 17 12:07:01 CST 2025
// ‰øÆÂæ©ÊôÇÈñìÈ°ØÁ§∫ÂïèÈ°å - Âº∑Âà∂ÈáçÊñ∞ÈÉ®ÁΩ≤ - Wed Jan 16 2025
// Á∑äÊÄ•‰øÆÂæ© - ÊôÇÈñìÈ°ØÁ§∫ÂïèÈ°å - 2025-01-16 15:30
// ‰øÆÂæ© CORS ÂïèÈ°å - Âº∑Âà∂ÈáçÊñ∞ÈÉ®ÁΩ≤ - 2025-01-16 15:45

