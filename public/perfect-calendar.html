<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë¨õÂ∏´Ë°å‰∫ãÊõÜÊ™¢Ë¶ñ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.98) 0%, 
                    rgba(248, 250, 252, 0.95) 25%,
                    rgba(255, 255, 255, 0.92) 50%,
                    rgba(248, 250, 252, 0.95) 75%,
                    rgba(255, 255, 255, 0.98) 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 20s ease infinite, subtleGlow 8s ease-in-out infinite;
            min-height: 100vh;
            color: rgba(51, 51, 51, 0.95);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.03) 50%, transparent 70%),
                linear-gradient(-45deg, transparent 30%, rgba(255, 215, 0, 0.02) 50%, transparent 70%);
            animation: shimmer 12s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes subtleGlow {
            0%, 100% { 
                background-position: 0% 0%, 0% 0%, 0% 0%, 0% 50%;
            }
            50% { 
                background-position: 0% 0%, 0% 0%, 0% 0%, 100% 50%;
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.2),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            z-index: 2;
        }

        /* È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü */
        .header {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.8) 0%, 
                rgba(20, 20, 20, 0.9) 50%,
                rgba(0, 0, 0, 0.8) 100%);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            padding: 30px;
            margin-bottom: 25px;
            border-radius: 25px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: headerFloat 6s ease-in-out infinite;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.1) 0%, 
                transparent 25%,
                transparent 75%,
                rgba(255, 215, 0, 0.1) 100%);
            animation: shimmer 3s ease-in-out infinite;
            z-index: 1;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.05) 0%, 
                transparent 70%);
            animation: rotate 20s linear infinite;
            z-index: 0;
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
        }

        .header h1 {
            color: rgba(255, 215, 0, 0.95);
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.3), 
                0 0 30px rgba(255, 215, 0, 0.4),
                0 0 60px rgba(255, 215, 0, 0.2);
            animation: titleGlow 4s ease-in-out infinite alternate;
            position: relative;
            z-index: 2;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 8px 0 0 0;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2;
        }

        .header-tim-note {
            display: none; /* Èö±ËóèÂ∫ï‰∏ãÁöÑÂ≠ó */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex: 1;
            text-align: center;
        }

        .header-logo {
            height: 50px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }



        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

            .user-info span {
                color: rgba(51, 51, 51, 0.9);
                font-weight: 500;
            }

            .user-details {
                align-items: center;
                text-align: center;
            }

            .user-name {
                font-size: 0.9rem;
                margin-bottom: 3px;
            }

            .user-id {
                font-size: 0.7rem;
                padding: 2px 4px;
            }

            .user-info-section {
                margin-top: 20px;
                padding: 15px;
            }

            .user-info-container h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }


        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .user-name {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .user-id {
            color: rgba(102, 102, 102, 0.8);
            font-size: 0.8rem;
            font-family: monospace;
            background: rgba(248, 249, 250, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }

        /* Áî®Êà∂Ë≥áË®äÂçÄÂüü */
        .user-info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .user-info-container h3 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 15px 0;
            text-align: center;
        }

        /* Êó•ÊúüÊôÇÈñìÈ°ØÁ§∫ÂçÄÂüü */
        .datetime-display {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .datetime-item {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255, 223, 102, 0.3);
            text-align: center;
        }

        .datetime-item i {
            font-size: 1.1rem;
        }

        /* ÈÄ≤Â∫¶ÊåáÁ§∫Âô® */
        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                transparent 50%,
                rgba(255, 255, 255, 0.1) 100%);
            animation: stepShimmer 3s ease-in-out infinite;
            z-index: 1;
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 2;
        }

        .step.completed .step-circle {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 2;
        }

        .step.pending .step-circle {
            background: linear-gradient(135deg, 
                rgba(85, 85, 85, 0.6) 0%, 
                rgba(60, 60, 60, 0.8) 100%);
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            z-index: 2;
        }

        .step-label {
            color: rgba(204, 204, 204, 0.9);
            font-size: 0.9rem;
            text-align: center;
        }

        .step.active .step-label {
            color: rgba(255, 223, 102, 0.9);
        }

        /* ‰∏ªÂÖßÂÆπÂçÄÂüü */
        .main-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .content-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .content-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .content-header i {
            color: rgba(255, 223, 102, 0.9);
            font-size: 1.3rem;
        }

        /* ÊéßÂà∂Èù¢Êùø */
        .controls {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.15) 0%, 
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            overflow: hidden;
            animation: controlsFloat 8s ease-in-out infinite;
        }

        .controls::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.08) 0%, 
                transparent 30%,
                transparent 70%,
                rgba(255, 215, 0, 0.08) 100%);
            animation: controlsShimmer 4s ease-in-out infinite;
            z-index: 1;
        }

        .controls::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.03) 0%, 
                transparent 70%);
            animation: controlsRotate 25s linear infinite;
            z-index: 0;
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 700;
            color: rgba(0, 0, 0, 0.8);
            font-size: 0.95rem;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 2;
        }

        select, input {
            padding: 12px 16px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: rgba(255, 255, 255, 0.9);
            color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 2;
            will-change: transform, box-shadow, border-color;
        }

        select:focus, input:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 
                0 0 0 3px rgba(255, 215, 0, 0.2),
                0 8px 25px rgba(0, 0, 0, 0.2),
                0 0 20px rgba(255, 215, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-2px) scale(1.02);
        }

        select:hover, input:hover {
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.15),
                0 0 10px rgba(255, 215, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        select:active, input:active {
            transform: translateY(0) scale(1.01);
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }


        /* Ë¶ñÂúñÊåâÈàïÁµÑ */
        .view-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            z-index: 2;
            transform: translateZ(0);
            will-change: transform, box-shadow, border-color;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 0;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 
                0 12px 30px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            color: rgba(255, 215, 0, 1);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.02);
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 
                0 0 0 3px rgba(255, 215, 0, 0.2),
                0 8px 25px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 215, 0, 0.3);
        }






        .btn-primary {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-primary:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            color: rgba(255, 215, 0, 1);
        }

        .btn-primary:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }

        .btn-primary.active {
            background: rgba(255, 193, 7, 1);
            border-color: rgba(255, 193, 7, 1);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5);
            transform: translateY(-2px);
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9) !important; /* Á¢∫‰øùÈÅ∏‰∏≠ÊôÇÂ≠óÈ´îÁÇ∫Ê∑±Ëâ≤ */
        }

        .btn-primary.active::after {
            content: '‚úì';
            position: absolute;
            top: -5px;
            right: -5px;
            background: rgba(255, 255, 255, 1);
            color: rgba(255, 193, 7, 1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid rgba(255, 193, 7, 1);
        }


        /* Âç≥Â∞áÂà∞‰æÜË™≤Á®ãÁöÑÈ´ò‰∫ÆÊ®£Âºè */
        .event-card.upcoming-event {
            position: relative;
            background: white; /* ‰øùÊåÅÁôΩËâ≤ËÉåÊôØ */
            border: 4px solid #FF8C42; /* Â¢ûÂä†ÈÇäÊ°ÜÂØ¨Â∫¶ */
            box-shadow: 0 4px 15px rgba(255, 140, 66, 0.2);
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .event-card.upcoming-event::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FF8C42, #FF6B35, #FF8C42, #FF6B35);
            border-radius: 10px;
            z-index: -1;
            opacity: 0.3; /* ÈùûÂ∏∏Ê∑°ÁöÑÈÇäÊ°ÜÊïàÊûú */
            transition: opacity 0.3s ease;
        }

        .event-card.upcoming-event:hover::before {
            opacity: 0.5; /* hoverÊôÇÁ®çÂæÆÂä†Ê∑± */
        }

        .event-card.upcoming-event .event-title {
            color: #333; /* Ê∑±Ëâ≤ÊñáÂ≠óÔºåÁ¢∫‰øùÂèØËÆÄÊÄß */
            font-weight: 700;
        }

        .event-card.upcoming-event .event-instructor {
            color: #333; /* Ê∑±Ëâ≤ÊñáÂ≠óÔºåÁ¢∫‰øùÂèØËÆÄÊÄß */
            font-weight: 600;
        }

        .event-card.upcoming-event .event-detail {
            color: #333; /* Ê∑±Ëâ≤ÊñáÂ≠óÔºåÁ¢∫‰øùÂèØËÆÄÊÄß */
        }

        .event-card.upcoming-event .event-detail i {
            color: #666; /* ÂúñÁ§∫È°èËâ≤ */
        }

        .event-card.upcoming-event .event-description {
            background: rgba(255, 140, 66, 0.08); /* ÈùûÂ∏∏Ê∑°ÁöÑÊ©òËâ≤ËÉåÊôØ */
            border-radius: 8px;
            padding: 12px;
        }

        .event-card.upcoming-event .event-description h4 {
            color: #333; /* Ê∑±Ëâ≤ÊñáÂ≠óÔºåÁ¢∫‰øùÂèØËÆÄÊÄß */
        }

        .event-card.upcoming-event .event-description p {
            color: #333; /* Ê∑±Ëâ≤ÊñáÂ≠óÔºåÁ¢∫‰øùÂèØËÆÄÊÄß */
        }

        /* Âç≥Â∞áÂà∞‰æÜË™≤Á®ãÊ®ôË®ò */
        .upcoming-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #FF8C42;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .upcoming-badge i {
            font-size: 0.9rem;
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.9);
            color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(108, 117, 125, 0.9);
        }

        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateY(-1px);
            color: rgba(255, 215, 0, 0.9);
        }

        .btn-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* Áµ±Ë®àÂçÄÂüü */
        .stats {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.15) 0%, 
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            overflow: hidden;
            animation: statsFloat 7s ease-in-out infinite;
        }

        .stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.08) 0%, 
                transparent 30%,
                transparent 70%,
                rgba(255, 215, 0, 0.08) 100%);
            animation: statsShimmer 5s ease-in-out infinite;
            z-index: 1;
        }

        .stats::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.03) 0%, 
                transparent 70%);
            animation: statsRotate 30s linear infinite;
            z-index: 0;
        }


        .events-container {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr;
        }

        .event-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 250, 252, 0.9) 50%,
                rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                0 0 0 1px rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.3);
            margin-bottom: 15px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            z-index: 3;
            overflow: hidden;
            will-change: transform, box-shadow, opacity;
        }

        .event-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9),
                0 0 0 1px rgba(255, 215, 0, 0.4);
            border-color: rgba(255, 215, 0, 0.5);
        }

        .event-card:active {
            transform: translateY(-2px) scale(1.01);
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                rgba(255, 215, 0, 0.8), 
                rgba(255, 193, 7, 0.6),
                rgba(255, 215, 0, 0.8));
            border-radius: 16px 16px 0 0;
        }

        .event-card.animated {
            opacity: 1;
            transform: translateY(0);
        }

        .event-card:nth-child(1) { animation-delay: 0.1s; }
        .event-card:nth-child(2) { animation-delay: 0.2s; }
        .event-card:nth-child(3) { animation-delay: 0.3s; }
        .event-card:nth-child(4) { animation-delay: 0.4s; }
        .event-card:nth-child(5) { animation-delay: 0.5s; }

        /* ÂÅúË™≤ÁãÄÊÖãÊ®£Âºè - Âä†Âº∑Áâà */
        .event-card.cancelled-event {
            background: rgba(248, 249, 250, 0.9);
            border: 3px solid #dc3545;
            opacity: 0.8;
            position: relative;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
        }

        .event-card.cancelled-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(220, 53, 69, 0.15) 8px,
                rgba(220, 53, 69, 0.15) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.cancelled-event::after {
            content: '‚ö†Ô∏è ÂÅúË™≤ ‚ö†Ô∏è';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            animation: bounce 1.5s infinite;
        }

        /* ‰ª£Ë™≤ÁãÄÊÖãÊ®£Âºè */
        .event-card.substitute-event {
            background: rgba(227, 242, 253, 0.9);
            border: 3px solid #2196F3;
            position: relative;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.4);
        }

        .event-card.substitute-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(33, 150, 243, 0.1) 8px,
                rgba(33, 150, 243, 0.1) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.substitute-event::after {
            content: 'üîÑ ‰ª£Ë™≤';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            animation: substituteBounce 2s infinite;
            border: 2px solid #0D47A1;
        }

        @keyframes substituteBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-10px) scale(1.1);
            }
            60% {
                transform: translateY(-5px) scale(1.05);
            }
        }

        /* È´îÈ©óÁãÄÊÖãÊ®£Âºè */
        .experience-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #8B4513;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            animation: experiencePulse 3s infinite;
            border: 2px solid #B8860B;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        @keyframes experiencePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            }
            30% {
                transform: scale(1.2);
                color: #FFD700;
                font-weight: bold;
                text-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
            }
            70% {
                transform: scale(1.1);
                color: #FFA500;
                font-weight: bold;
                text-shadow: 0 0 6px rgba(255, 165, 0, 0.3);
            }
        }

        .event-card.experience-event {
            background: rgba(255, 248, 220, 0.9);
            border: 3px solid #FFD700;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }

        .event-card.experience-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(255, 215, 0, 0.1) 8px,
                rgba(255, 215, 0, 0.1) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.experience-event::after {
            content: '‚≠ê È´îÈ©ó';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #FFD700;
            color: #8B4513;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            animation: experienceBounce 2s infinite;
            border: 2px solid #B8860B;
        }

        @keyframes experienceBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-10px) scale(1.1);
            }
            60% {
                transform: translateY(-5px) scale(1.05);
            }
        }

        .cancelled-badge {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            animation: pulse 1.5s infinite;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            border: 2px solid white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .substitute-badge {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            animation: substitutePulse 3s infinite;
            border: 2px solid #0D47A1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        @keyframes substitutePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(33, 150, 243, 0.7);
            }
        }

        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
            transform: translateY(-5px);
            }
        }

        .event-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .event-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: rgba(255, 223, 102, 0.9);
            border-radius: 2px 0 0 2px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .event-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: rgba(0, 0, 0, 0.9);
            margin-bottom: 12px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
            letter-spacing: 0.5px;
        }

        .event-instructor {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 
                0 4px 12px rgba(255, 215, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(0, 0, 0, 0.8);
            font-size: 0.95rem;
            font-weight: 500;
            padding: 8px 12px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }

        .event-detail:hover {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.3);
            transform: translateY(-1px);
        }

        .event-detail i {
            width: 22px;
            color: rgba(255, 215, 0, 0.8);
            text-align: center;
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .location-link {
            color: #0066cc !important;
            text-decoration: underline !important;
            text-decoration-color: #0066cc !important;
            text-decoration-thickness: 2px !important;
            text-underline-offset: 3px !important;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            position: relative;
            font-weight: 600;
            border: 2px solid rgba(0, 102, 204, 0.2);
            box-shadow: 0 2px 4px rgba(0, 102, 204, 0.1);
        }

        .location-link:hover {
            color: #ffffff !important;
            background: linear-gradient(135deg, #0066cc, #004499) !important;
            text-decoration: none !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
            border-color: #0066cc;
        }

        .location-link:active {
            color: #ffffff !important;
            background: linear-gradient(135deg, #004499, #003366) !important;
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 102, 204, 0.3);
        }

        .location-external-icon {
            font-size: 0.8rem;
            opacity: 1;
            color: #0066cc;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .location-link:hover .location-external-icon {
            opacity: 1;
            transform: scale(1.2);
            color: #ffffff;
        }

        .location-map-icon {
            font-size: 0.9rem;
            opacity: 1;
            color: #0066cc;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .location-link:hover .location-map-icon {
            opacity: 1;
            transform: scale(1.2);
            color: #ffffff;
        }

        .countdown-timer {
            background: rgba(255, 193, 7, 0.15);
            border: 2px solid rgba(255, 193, 7, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            margin-top: 12px;
            text-align: center;
            font-weight: 700;
            color: rgba(255, 193, 7, 1);
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 12px rgba(255, 193, 7, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .countdown-timer.upcoming {
            background: rgba(76, 175, 80, 0.15);
            border-color: rgba(76, 175, 80, 0.4);
            color: rgba(76, 175, 80, 1);
            box-shadow: 
                0 4px 12px rgba(76, 175, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-timer.ongoing {
            background: rgba(33, 150, 243, 0.15);
            border-color: rgba(33, 150, 243, 0.4);
            color: rgba(33, 150, 243, 1);
            box-shadow: 
                0 4px 12px rgba(33, 150, 243, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-timer.overdue {
            background: rgba(244, 67, 54, 0.15);
            border-color: rgba(244, 67, 54, 0.4);
            color: rgba(244, 67, 54, 1);
            box-shadow: 
                0 4px 12px rgba(244, 67, 54, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-text {
            font-size: 0.9rem;
            margin: 0;
        }

        .countdown-icon {
            margin-right: 6px;
            font-size: 0.8rem;
        }

        .event-description {
            background: rgba(248, 249, 250, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid rgba(255, 223, 102, 0.9);
        }

        .event-description h4 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: 600;
        }

        .event-description p {
            color: rgba(102, 102, 102, 0.9);
            line-height: 1.5;
            font-size: 0.9rem;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .lesson-section {
            margin-top: 15px;
        }

        .lesson-label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .lesson-button {
            display: inline-block;
            background: rgba(255, 223, 102, 0.9);
            color: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .lesson-button:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .no-events i {
            font-size: 4rem;
            color: rgba(255, 223, 102, 0.9);
            margin-bottom: 20px;
        }

        .no-events h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: rgba(51, 51, 51, 0.9);
        }

        .no-events p {
            font-size: 1.1rem;
            color: rgba(102, 102, 102, 0.9);
        }

        /* Ë®≠ÁΩÆÁï´Èù¢Ê®£Âºè */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .settings-modal {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(240, 240, 240, 0.9);
        }

        .settings-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .close-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            transform: scale(1.1);
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .color-picker-item label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            min-width: 80px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .instructor-color-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .instructor-color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .instructor-color-item label {
            font-size: 0.9rem;
            color: rgba(51, 51, 51, 0.9);
            min-width: 60px;
            font-weight: 600;
        }

        .instructor-color-picker {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .instructor-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .instructor-color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .save-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .save-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* ÈáçÊñ∞Êï¥ÁêÜÊµÆÂãïÊåâÈàï - ËòãÊûú iOS 16 Ê∂≤ÊÖãÁéªÁíÉÊïàÊûú */
        .refresh-button {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1000;
            user-select: none;
            overflow: hidden;
            will-change: transform, box-shadow;
        }

        .refresh-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .refresh-button:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .refresh-button:hover::before {
            opacity: 1;
        }

        .refresh-button:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 
                0 6px 24px rgba(0, 0, 0, 0.12),
                0 2px 6px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .refresh-button i {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .refresh-button.loading i {
            animation: spin 1s linear infinite;
        }

        .refresh-button.loading {
            background: rgba(0, 122, 255, 0.2);
            border-color: rgba(0, 122, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 122, 255, 0.2),
                0 2px 8px rgba(0, 122, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Êñ∞Â¢ûÁöÑÂãïÁï´ÊïàÊûú */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.4);
            }
        }
        
        @keyframes liquidFlow {
            0% { transform: translateX(-100%) rotate(0deg); }
            50% { transform: translateX(0%) rotate(180deg); }
            100% { transform: translateX(100%) rotate(360deg); }
        }
        
        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }
        
        @keyframes shimmer2 {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Ê∂≤ÊÖãÊØõÁéªÁíÉÊïàÊûú */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glassmorphism-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .liquid-button {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .liquid-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer2 2s infinite;
        }
        
        .liquid-button:hover::before {
            animation: shimmer2 0.8s infinite;
        }
        
        /* ÊµÆÂãïÈÄöÁü•Ê®£Âºè */
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 300px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            color: #fff;
            font-weight: 600;
            font-size: 0.9rem;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        
        .floating-notification.show {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .floating-notification.progress {
            background: rgba(40, 167, 69, 0.15);
            border-color: rgba(40, 167, 69, 0.3);
            color: #fff;
        }
        
        .floating-notification.completion {
            background: rgba(255, 193, 7, 0.15);
            border-color: rgba(255, 193, 7, 0.3);
            color: #fff;
            animation: celebration 0.6s ease;
        }
        
        @keyframes celebration {
            0% { transform: translateX(100%) scale(0.8); }
            50% { transform: translateX(0) scale(1.05); }
            100% { transform: translateX(0) scale(1); }
        }
        
        .progress-bar-floating {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill-floating {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification-icon {
            font-size: 1.2rem;
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.1rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .notification-close:hover {
            opacity: 1;
        }

        /* CSP ÂÖºÂÆπÁöÑ hover ÊïàÊûú */
        .close-attendance-modal:hover {
            background: rgba(220, 53, 69, 0.1) !important;
            color: #dc3545 !important;
        }
        
        .present-btn:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5) !important;
        }
        
        .absent-btn:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.5) !important;
        }
        
        .refresh-students-btn:hover {
            background: rgba(102, 126, 234, 1) !important;
        }
        
        /* ÈáçÊñ∞ËºâÂÖ•ÊåâÈàïÂãïÁï´ */
        @keyframes refreshSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-students-btn.loading {
            animation: refreshSpin 1s linear infinite;
            pointer-events: none;
        }


        /* Áµ±Ë®àÊ¨Ñ‰ΩçÂãïÁï´ */
        .stats-animation {
            animation: statsPulse 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes statsPulse {
            0% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
            25% { 
                transform: scale(1.08) rotate(1deg);
                filter: brightness(1.1);
            }
            50% { 
                transform: scale(0.95) rotate(-1deg);
                filter: brightness(0.9);
            }
            75% { 
                transform: scale(1.03) rotate(0.5deg);
                filter: brightness(1.05);
            }
            100% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
        }

        .stats-item-updated {
            animation: statsItemUpdate 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes statsItemUpdate {
            0% { 
                transform: scale(1);
                background: transparent;
            }
            25% { 
                transform: scale(1.1);
                background: rgba(255, 215, 0, 0.2);
            }
            50% { 
                transform: scale(0.95);
                background: rgba(255, 215, 0, 0.3);
            }
            75% { 
                transform: scale(1.05);
                background: rgba(255, 215, 0, 0.1);
            }
            100% { 
                transform: scale(1);
                background: transparent;
            }
        }
        
        .refresh-students-btn.loading i {
            animation: refreshSpin 1s linear infinite;
        }

        /* Âç°ÁâåÂãïÁï´ÊïàÊûú */
        @keyframes cardFlipIn {
            0% {
                transform: rotateY(-90deg) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: rotateY(-45deg) scale(0.9);
                opacity: 0.7;
            }
            100% {
                transform: rotateY(0deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes cardSlideIn {
            0% {
                transform: translateX(-100px) rotateY(-30deg);
                opacity: 0;
            }
            50% {
                transform: translateX(-20px) rotateY(-15deg);
                opacity: 0.7;
            }
            100% {
                transform: translateX(0) rotateY(0deg);
                opacity: 1;
            }
        }

        @keyframes cardBounceIn {
            0% {
                transform: translateY(-50px) scale(0.3);
                opacity: 0;
            }
            50% {
                transform: translateY(10px) scale(1.05);
                opacity: 0.8;
            }
            70% {
                transform: translateY(-5px) scale(0.98);
                opacity: 0.9;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes cardShimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        .student-card {
            animation: cardSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .student-card:nth-child(1) { animation-delay: 0.05s; }
        .student-card:nth-child(2) { animation-delay: 0.1s; }
        .student-card:nth-child(3) { animation-delay: 0.15s; }
        .student-card:nth-child(4) { animation-delay: 0.2s; }
        .student-card:nth-child(5) { animation-delay: 0.25s; }
        .student-card:nth-child(6) { animation-delay: 0.3s; }
        .student-card:nth-child(7) { animation-delay: 0.35s; }
        .student-card:nth-child(8) { animation-delay: 0.4s; }
        .student-card:nth-child(9) { animation-delay: 0.45s; }
        .student-card:nth-child(10) { animation-delay: 0.5s; }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: cardShimmer 2s ease-in-out;
        }

        .student-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 215, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .student-card.selected {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 
                0 12px 30px rgba(0, 0, 0, 0.2),
                0 0 0 2px rgba(255, 215, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border-color: #b8860b;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .student-card.double-click-animation {
            animation: cardDoubleClick 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes cardDoubleClick {
            0% { transform: scale(1); }
            25% { transform: scale(0.98); }
            50% { transform: scale(1.03); }
            75% { transform: scale(0.99); }
            100% { transform: scale(1); }
        }

        /* Ëá™ÂÆöÁæ©ÊªæÂãïÊ¢ùÊ®£Âºè */
        #studentsList::-webkit-scrollbar {
            width: 6px;
        }

        #studentsList::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #studentsList::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.6), rgba(255, 215, 0, 0.4));
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        #studentsList::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.8), rgba(255, 215, 0, 0.6));
        }

        /* Êá∏ÊµÆÂõ∫ÂÆöÈÅ∏ÂñÆÊ®£Âºè */
        .floating-stats-menu {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: 
                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 70%),
                linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.25) 0%, 
                    rgba(248, 249, 250, 0.2) 50%,
                    rgba(255, 255, 255, 0.25) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 12px 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(-20px) scale(0.9);
        }

        .floating-stats-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0) scale(1);
        }

        .floating-stats-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 0.85rem;
            color: rgba(51, 51, 51, 0.9);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            flex-wrap: nowrap;
        }

        .floating-stats-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .floating-stats-item .icon {
            color: #b8860b;
            font-size: 0.9rem;
            text-shadow: 0 0 8px rgba(184, 134, 11, 0.5);
        }

        .floating-stats-item .value {
            color: rgba(51, 51, 51, 0.8);
            font-weight: 700;
        }

        .floating-filter-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
        }

        .floating-filter-btn {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: #333333;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            white-space: nowrap;
        }

        .floating-filter-btn:hover {
            background: linear-gradient(135deg, rgba(184, 134, 11, 0.4), rgba(184, 134, 11, 0.3));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(184, 134, 11, 0.3);
        }

        .floating-filter-btn.active {
            background: linear-gradient(135deg, #b8860b, #daa520);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(184, 134, 11, 0.5);
            transform: translateY(-1px);
        }

        .floating-filter-btn:active {
            transform: translateY(0) scale(0.95);
            transition: all 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .floating-filter-btn.clicked {
            animation: buttonClickPulse 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes buttonClickPulse {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(0.95); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .floating-stats-menu {
                top: 10px;
                padding: 10px 16px;
                border-radius: 16px;
                max-width: 95%;
            }
            
            .floating-stats-content {
                gap: 8px;
                font-size: 0.8rem;
                flex-wrap: nowrap;
                justify-content: center;
            }
            
            .floating-filter-buttons {
                margin-left: 0;
                gap: 6px;
            }
            
            .floating-filter-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .floating-stats-menu {
                top: 8px;
                padding: 8px 12px;
                border-radius: 12px;
                max-width: 98%;
            }
            
            .floating-stats-content {
                gap: 6px;
                font-size: 0.7rem;
                flex-wrap: nowrap;
                justify-content: center;
            }
            
            .floating-filter-buttons {
                margin-left: 0;
                gap: 4px;
            }
            
            .floating-filter-btn {
                padding: 5px 8px;
                font-size: 0.65rem;
                min-width: 50px;
            }
        }

        /* Áº∫Âã§Á¥ÄÈåÑÊ®°ÊÖãÊ°ÜÊ®£Âºè */
        .attendance-record-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .attendance-record-content {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 249, 250, 0.9) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .attendance-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }

        .attendance-record-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .close-attendance-record-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-attendance-record-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            color: #ff0000;
            transform: scale(1.1);
        }

        .attendance-record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .attendance-record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border-left: 4px solid #b8860b;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .attendance-record-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .attendance-record-date {
            font-weight: bold;
            color: #333;
        }

        .attendance-record-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .attendance-record-status.present {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .attendance-record-status.absent {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .attendance-record-status.leave {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .attendance-record-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .attendance-record-error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }

        /* ÊâãÊ©üÂÑ™Âåñ - ÊµÆÂãïÈÄöÁü• */
        @media (max-width: 768px) {
            .floating-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                font-size: 0.85rem;
                padding: 12px 16px;
            }
            
            .notification-content {
                gap: 8px;
            }
            
            .notification-icon {
                font-size: 1.1rem;
            }
        }

        /* Êá∏ÊµÆÂ∞éËà™Âô®Ê®£Âºè */
        .floating-navigator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: flex;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 8px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            0% {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .nav-item {
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
            position: relative;
            overflow: hidden;
            min-width: 120px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-item:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-item.active {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.8) 0%, 
                rgba(255, 193, 7, 0.9) 100%);
            border: 1px solid rgba(255, 215, 0, 0.6);
            color: #333;
            box-shadow: 
                0 4px 15px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .nav-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-item .icon {
            font-size: 1.1rem;
        }

        .nav-item .text {
            font-size: 0.85rem;
        }

        /* Ê®°ÊÖãÊ°ÜÂ∑¶ÁßªÂãïÁï´ */
        .attendance-modal-content.slide-left {
            animation: slideLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideLeft {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        /* Ë¨õÂ∏´Â†±Ë°®Ê®£Âºè */
        .teacher-attendance-content {
            width: 100%;
            height: 100%;
        }

        .report-form textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        /* ÊâãÊ©üÂÑ™Âåñ - Êá∏ÊµÆÂ∞éËà™Âô® */
        @media (max-width: 768px) {
            .floating-navigator {
                top: 15px;
                padding: 6px;
                border-radius: 20px;
            }

            .nav-item {
                padding: 10px 18px;
                min-width: 100px;
                font-size: 0.8rem;
            }

            .nav-item .icon {
                font-size: 1rem;
            }

            .nav-item .text {
                font-size: 0.75rem;
            }

            .mode-buttons {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .mode-btn {
                padding: 12px;
            }

            .mode-btn i {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .floating-navigator {
                top: 10px;
                padding: 5px;
                border-radius: 18px;
            }

            .nav-item {
                padding: 8px 14px;
                min-width: 90px;
                font-size: 0.75rem;
            }

            .nav-item .icon {
                font-size: 0.9rem;
            }

            .nav-item .text {
                font-size: 0.7rem;
            }
        }

        /* ÊâãÊ©üÂÑ™Âåñ - Á∞ΩÂà∞Á≥ªÁµ± */
        @media (max-width: 768px) {
            .attendance-modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 10px !important;
                padding: 20px !important;
                max-height: 90vh !important;
            }
            
            .attendance-modal-content h2 {
                font-size: 1.2rem !important;
                margin-bottom: 15px !important;
            }
            
            .attendance-modal-content .course-info {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
                font-size: 0.85rem !important;
            }
            
            .attendance-student-item {
                flex-direction: row !important;
                align-items: center !important;
                padding: 12px 15px !important;
                gap: 12px !important;
                min-height: 60px !important;
                margin-bottom: 8px !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .attendance-student-item .student-info {
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                flex: 1 !important;
                min-width: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .attendance-student-item .student-actions {
                display: flex !important;
                gap: 4px !important;
                justify-content: space-between !important;
                flex-shrink: 0 !important;
                width: 100% !important;
                max-width: 140px !important;
            }
            
            .attendance-btn {
                padding: 6px 8px !important;
                font-size: 0.75rem !important;
                min-height: 32px !important;
                min-width: 50px !important;
                max-width: 65px !important;
                flex: 1 !important;
                margin: 2px !important;
            }
            
            .attendance-stats {
                flex-direction: column !important;
                gap: 10px !important;
                align-items: stretch !important;
            }
            
            .attendance-stats .stats-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
                font-size: 0.8rem !important;
            }
            
            .refresh-students-btn {
                width: 100% !important;
                padding: 12px !important;
                font-size: 0.9rem !important;
            }
        }

        @media (max-width: 480px) {
            .attendance-modal-content {
                width: 98% !important;
                padding: 15px !important;
            }
            
            .attendance-student-item {
                flex-direction: row !important;
                align-items: center !important;
                padding: 10px 12px !important;
                gap: 10px !important;
                min-height: 55px !important;
                margin-bottom: 6px !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .attendance-student-item .student-info {
                gap: 8px !important;
                flex: 1 !important;
                min-width: 0 !important;
            }
            
            .attendance-student-item .student-avatar {
                width: 32px !important;
                height: 32px !important;
                font-size: 0.9rem !important;
            }
            
            .attendance-student-item .student-name {
                font-size: 0.9rem !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            .attendance-student-item .student-actions {
                gap: 3px !important;
                flex-shrink: 0 !important;
                width: 100% !important;
                max-width: 120px !important;
            }
            
            .attendance-btn {
                padding: 4px 6px !important;
                font-size: 0.7rem !important;
                min-height: 28px !important;
                min-width: 45px !important;
                max-width: 60px !important;
                flex: 1 !important;
                margin: 1px !important;
            }
            
            .attendance-stats .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 6px !important;
            }
        }

        /* ÂæÆ‰∫§‰∫íÊïàÊûú */
        .smooth-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .smooth-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .bounce-in {
            animation: scaleIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .fade-in-up {
            animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .pulse-effect {
            animation: pulse 2s infinite;
        }

        .shake-effect {
            animation: shake 0.5s ease-in-out;
        }

        .glow-effect {
            animation: glow 2s ease-in-out infinite;
        }

        /* Á∞ΩÂà∞Á≥ªÁµ±Êá∏ÊµÆÈÅ∏ÂñÆ */
        .attendance-menu {
            position: fixed;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            user-select: none;
        }

        .attendance-menu-button {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 0.9) 0%, 
                rgba(69, 160, 73, 0.8) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 32px rgba(76, 175, 80, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            will-change: transform, box-shadow;
        }

        .attendance-menu-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .attendance-menu-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .attendance-menu-button:hover {
            transform: translateY(-3px) scale(1.1);
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 1) 0%, 
                rgba(69, 160, 73, 0.9) 100%);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 
                0 15px 45px rgba(76, 175, 80, 0.5),
                0 6px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .attendance-menu-button:hover::before {
            opacity: 1;
        }

        .attendance-menu-button:hover::after {
            width: 80px;
            height: 80px;
        }

        .attendance-menu-button:active {
            transform: translateY(-1px) scale(1.05);
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 0.95) 0%, 
                rgba(69, 160, 73, 0.85) 100%);
            box-shadow: 
                0 8px 25px rgba(76, 175, 80, 0.4),
                0 3px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .attendance-menu-button i {
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            z-index: 1;
        }

        .attendance-menu-tooltip {
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none;
            z-index: 1001;
        }

        .attendance-menu-tooltip::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid rgba(0, 0, 0, 0.8);
        }

        .attendance-menu:hover .attendance-menu-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(5px);
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            /* Êï¥ÂÄãÈ†ÅÈù¢ÂèØ‰ª•ÊªëÂãï */
            body {
                overflow-x: hidden;
                overflow-y: auto;
                margin: 0;
                padding: 0;
            }
            
            .container {
                padding: 0;
                max-width: 100%;
                margin: 0;
            }
            
            /* ÁØ©ÈÅ∏ÂçÄÂüüÂÆåÂÖ®Âõ∫ÂÆöÔºåÁµïÂ∞ç‰∏çÊúÉÁßªÂãï */
            .control-section {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 9999 !important;
                background: white !important;
                padding: 6px !important; /* Ê∏õÂ∞ëÂÖßÈÇäË∑ù */
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
                width: 100% !important;
                height: auto !important;
                /* Á¢∫‰øùÁØ©ÈÅ∏ÂçÄÂüüÊ∞∏ÈÅ†Âõ∫ÂÆöÂú®È†ÇÈÉ®ÔºåÁµïÂ∞ç‰∏çÊúÉÁßªÂãï */
                transform: translateZ(0) !important; /* Âº∑Âà∂Á°¨È´îÂä†ÈÄü */
                will-change: auto !important; /* ÂÑ™ÂåñÊ∏≤ÊüìÊÄßËÉΩ */
                backface-visibility: hidden !important; /* Èò≤Ê≠¢ÈñÉÁàç */
                /* Á¢∫‰øùÁØ©ÈÅ∏ÂçÄÂ°äË¶ÜËìãÂú®Ê®ôÈ°åÂçÄÂ°ä‰∏äÊñπ */
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* ‰∏ªÂÖßÂÆπÂçÄÂüüÔºåÁÇ∫Âõ∫ÂÆöÁØ©ÈÅ∏ÂçÄÂüüÁïôÂá∫Á©∫Èñì */
            .main-content {
                margin-top: 0 !important; /* ÁßªÈô§È†ÇÈÉ®ÈñìË∑ùÔºåËÆìÂÖßÂÆπÁ∑äË≤ºÁØ©ÈÅ∏ÂçÄÂ°ä */
                padding: 8px 8px 4px 8px; /* Ê∏õÂ∞ëÂ∫ïÈÉ®ÈñìË∑ù */
                /* ËÆìÊï¥ÂÄãÈ†ÅÈù¢ÂèØ‰ª•Ê≠£Â∏∏ÊªëÂãï */
            }
            
            /* ÁßªÈô§Ë¶ñÂúñÊåâÈàïÁöÑ sticky ÂÆö‰ΩçÔºåÂõ†ÁÇ∫ÁØ©ÈÅ∏ÂçÄÂüüÂ∑≤Á∂ìÂõ∫ÂÆö */
            .view-buttons {
                position: static !important;
                /* Ê∑ªÂä†ÊªëÂãïÊèêÁ§∫ */
                position: relative;
                margin: 4px 0 !important; /* Ê∏õÂ∞ë‰∏ä‰∏ãÈñìË∑ù */
            }
            
            /* ÁßªÈô§ÂéüÊú¨ÁöÑÊªëÂãïÊèêÁ§∫ÊåáÁ§∫Âô® */
            .view-buttons::after {
                display: none;
            }
            
            
            /* ÊåâÈàïËÑàË°ùÂãïÁï´ */
            @keyframes buttonPulse {
                0% { 
                    transform: scale(1.1); 
                    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
                }
                50% { 
                    transform: scale(1.15); 
                    box-shadow: 0 8px 16px rgba(0, 123, 255, 0.5);
                }
                100% { 
                    transform: scale(1.1); 
                    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
                }
            }
            
            /* Ë¶ñÂúñÊåâÈàïÈÅ∏‰∏≠ÊïàÊûú */
            .view-buttons .btn-primary.active {
                background: linear-gradient(135deg, #ffc107, #ff9800) !important;
                color: rgba(0, 0, 0, 0.9) !important;
                border: 2px solid #ff9800 !important;
                box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3) !important;
                transform: scale(1.05) !important;
                font-weight: 600 !important;
            }
            
            .view-buttons .btn-primary:not(.active) {
                background: rgba(255, 193, 7, 0.3) !important;
                color: rgba(0, 0, 0, 0.7) !important;
                border: 1px solid rgba(255, 193, 7, 0.5) !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            }
            
            .view-buttons .btn-primary:hover {
                background: rgba(255, 193, 7, 0.6) !important;
                transform: scale(1.02) !important;
                transition: all 0.2s ease !important;
            }


            .header {
                padding: 12px;
                margin-bottom: 0 !important; /* ÁßªÈô§Â∫ïÈÉ®ÈñìË∑ùÔºåÈÅøÂÖçËàáÁØ©ÈÅ∏ÂçÄÂ°äÈáçÁñä */
                position: relative !important; /* Á¢∫‰øùÊ®ôÈ°åÂçÄÂ°ä‰∏çÊúÉÂΩ±ÈüøÁØ©ÈÅ∏ÂçÄÂ°ä */
            }

            .header h1 {
                font-size: 1.4rem;
                line-height: 1.2;
            }

            .header-logo {
                height: 35px;
            }

            .header-left {
                gap: 8px;
                justify-content: center;
                text-align: center;
            }


            .control-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .control-group {
                width: 100%;
            }

            .control-group label {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }

            .control-group select,
            .control-group input {
                padding: 8px;
                font-size: 0.9rem;
                border-radius: 6px;
            }

            .view-buttons {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                width: 100%;
            }


            .btn-primary {
                padding: 8px 4px;
                font-size: 0.75rem;
                text-align: center;
                min-height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            
            .btn-primary.active {
                color: rgba(0, 0, 0, 0.9) !important; /* Á¢∫‰øùÈÅ∏‰∏≠ÊôÇÂ≠óÈ´îÁÇ∫Ê∑±Ëâ≤ */
            }

            .events-container {
                gap: 8px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-header {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                margin-bottom: 12px;
            }

            .event-title {
                font-size: 1rem;
                line-height: 1.3;
                word-wrap: break-word;
            }

            .event-instructor {
                padding: 4px 8px;
                font-size: 0.8rem;
                align-self: flex-start;
            }

            .event-details {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-bottom: 12px;
            }

            .event-detail {
                font-size: 0.8rem;
                padding: 4px 0;
            }

            .event-detail i {
                margin-right: 6px;
                width: 14px;
            }

            .event-description {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 6px;
            }

            .event-description h4 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }

            .event-description p {
                font-size: 0.8rem;
                line-height: 1.4;
                word-wrap: break-word;
            }

            .lesson-button {
                padding: 6px 12px;
                font-size: 0.8rem;
                border-radius: 6px;
            }


            .settings-modal {
                width: 95%;
                padding: 16px;
                margin: 10px auto;
            }

            .color-picker-group {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .instructor-color-group {
                grid-template-columns: 1fr;
            }

            .datetime-display {
                flex-direction: column;
                gap: 6px;
                justify-content: center;
                align-items: center;
            }

            .datetime-item {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .progress-steps {
                gap: 8px;
                margin: 12px 0;
                justify-content: center;
            }

            .progress-step {
                font-size: 0.7rem;
                padding: 6px 8px;
            }

            /* ÊâãÊ©üÁâàÈáçÊñ∞Êï¥ÁêÜÊåâÈàï - ËòãÊûú iOS 16 Ê∂≤ÊÖãÁéªÁíÉÊïàÊûú */
            .refresh-button {
                width: 50px;
                height: 50px;
                bottom: 25px;
                right: 15px;
                font-size: 20px;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 
                    0 6px 24px rgba(0, 0, 0, 0.12),
                    0 2px 6px rgba(0, 0, 0, 0.06),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }

            .refresh-button:hover {
                background: rgba(255, 255, 255, 0.25);
                border-color: rgba(255, 255, 255, 0.4);
                box-shadow: 
                    0 8px 28px rgba(0, 0, 0, 0.15),
                    0 3px 8px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5);
            }

            .refresh-button.loading {
                background: rgba(0, 122, 255, 0.25);
                border-color: rgba(0, 122, 255, 0.4);
                box-shadow: 
                    0 6px 24px rgba(0, 122, 255, 0.25),
                    0 2px 6px rgba(0, 122, 255, 0.12),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }

            .attendance-menu {
                bottom: 20px;
                left: 10px;
            }

            .attendance-menu-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .attendance-menu-tooltip {
                left: 55px;
                font-size: 11px;
                padding: 5px 8px;
            }
        }

        /* Ë∂ÖÂ∞èÂ±èÂπïÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 480px) {
            .container {
                padding: 6px;
            }

            .header {
                padding: 8px;
                margin-bottom: 8px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .header-logo {
                height: 30px;
            }

            .header-left {
                justify-content: center;
                text-align: center;
            }


            .control-group label {
                font-size: 0.8rem;
            }

            .control-group select,
            .control-group input {
                padding: 6px;
                font-size: 0.85rem;
            }

            .view-buttons {
                gap: 4px;
            }

            .btn-primary {
                padding: 6px 2px;
                font-size: 0.7rem;
                min-height: 32px;
            }

            
            .btn-primary.active {
                color: rgba(0, 0, 0, 0.9) !important; /* Á¢∫‰øùÈÅ∏‰∏≠ÊôÇÂ≠óÈ´îÁÇ∫Ê∑±Ëâ≤ */
            }


            .events-container {
                gap: 6px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 10px;
                margin-bottom: 6px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-title {
                font-size: 0.9rem;
            }

            .event-instructor {
                padding: 3px 6px;
                font-size: 0.75rem;
            }

            .event-detail {
                font-size: 0.75rem;
            }

            .event-description {
                padding: 8px;
            }

            .event-description h4 {
                font-size: 0.85rem;
            }

            .event-description p {
                font-size: 0.75rem;
            }

            .lesson-button {
                padding: 5px 10px;
                font-size: 0.75rem;
            }


            .datetime-item {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .progress-step {
                font-size: 0.65rem;
                padding: 4px 6px;
            }

            .user-info-section {
                margin-top: 15px;
                padding: 12px;
            }

            .user-info-container h3 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
        }

        /* ËºâÂÖ•ÂãïÁï´Ê®£Âºè - Ê∂≤ÊÖãÁéªÁíÉÊïàÊûú */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.95) 0%, 
                rgba(20, 20, 20, 0.95) 25%,
                rgba(255, 215, 0, 0.15) 50%,
                rgba(20, 20, 20, 0.95) 75%,
                rgba(0, 0, 0, 0.95) 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(1.1);
        }

        .loading-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 30px;
            padding: 40px 50px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.2),
                0 0 0 1px rgba(255, 215, 0, 0.1),
                0 0 30px rgba(255, 215, 0, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(1deg); }
            50% { transform: translateY(-5px) rotate(0deg); }
            75% { transform: translateY(-15px) rotate(-1deg); }
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 215, 0, 0.3),
                0 0 20px rgba(255, 215, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            animation: logoPulse 3s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 
                    0 15px 35px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 215, 0, 0.3),
                    0 0 20px rgba(255, 215, 0, 0.2);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 
                    0 20px 40px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 215, 0, 0.5),
                    0 0 40px rgba(255, 215, 0, 0.4),
                    0 0 60px rgba(255, 215, 0, 0.2);
            }
        }

        .loading-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent, 
                rgba(255, 215, 0, 0.2), 
                transparent);
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .loading-logo img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            position: relative;
            z-index: 1;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin-bottom: 20px;
            position: relative;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid transparent;
            border-top: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: rgba(255, 215, 0, 0.95);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .loading-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        .loading-progress {
            width: 250px;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 25px;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, 
                rgba(255, 215, 0, 0.9), 
                rgba(255, 193, 7, 0.8),
                rgba(255, 215, 0, 0.9));
            border-radius: 3px;
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .loading-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.8), 
                transparent);
            animation: progressShimmer 1.5s linear infinite;
        }

        @keyframes progressShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .loading-logs {
            max-height: 200px;
            overflow-y: auto;
            color: rgba(255, 255, 255, 0.85);
            font-size: 13px;
            text-align: center;
            width: 320px;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 215, 0, 0.1);
        }

        .loading-log-item {
            margin-bottom: 6px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            opacity: 0;
            animation: logFadeIn 0.5s ease-in forwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-log-item:last-child {
            border-bottom: none;
        }

        .loading-log-item.success {
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .loading-log-item.error {
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        .loading-log-item.warning {
            color: #ffd93d;
            text-shadow: 0 0 10px rgba(255, 217, 61, 0.3);
        }

        .loading-log-item.info {
            color: #45b7d1;
            text-shadow: 0 0 10px rgba(69, 183, 209, 0.3);
        }

        .loading-log-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
        }

        @keyframes logFadeIn {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        .loading-percentage {
            color: rgba(255, 215, 0, 0.9);
            font-size: 0.9rem;
            margin-top: 20px;
            margin-bottom: 20px;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .loading-signature {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 215, 0, 0.8);
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
            animation: signatureGlow 3s ease-in-out infinite;
        }

        @keyframes signatureGlow {
            0%, 100% { 
                opacity: 0.8;
                transform: scale(1);
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1.02);
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.6);
            }
        }

        /* ÈÅéÂ†¥ÂãïÁï´ÊïàÊûú */
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.8s ease-out;
        }

        .bounce-in {
            animation: bounceIn 1s ease-out;
        }

        .scale-in {
            animation: scaleIn 0.5s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .float {
            animation: float 3s ease-in-out infinite;
        }

        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        /* ÂãïÁï´ÈóúÈçµÂπÄ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            0% { 
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            50% { 
                opacity: 0.8;
                transform: translateY(-5px) scale(1.02);
            }
            100% { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(255, 223, 102, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 223, 102, 0.8);
            }
        }

        @keyframes headerFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes titleGlow {
            0% { 
                text-shadow: 
                    0 2px 10px rgba(0, 0, 0, 0.3), 
                    0 0 30px rgba(255, 215, 0, 0.4),
                    0 0 60px rgba(255, 215, 0, 0.2);
            }
            100% { 
                text-shadow: 
                    0 2px 15px rgba(0, 0, 0, 0.4), 
                    0 0 40px rgba(255, 215, 0, 0.6),
                    0 0 80px rgba(255, 215, 0, 0.3);
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes controlsFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        @keyframes controlsShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes controlsRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes statsFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }

        @keyframes statsShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes statsRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes stepShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Áµ±Ë®àÊï∏Â≠óÂãïÁï´ */
        .stats-text span {
            display: inline-block;
            transition: all 0.3s ease;
        }

        .stats-text span.animate {
            animation: counterBounce 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes counterBounce {
            0% { 
                transform: scale(1); 
                color: rgba(51, 51, 51, 0.8); 
                text-shadow: none;
            }
            20% { 
                transform: scale(1.3); 
                color: #2196F3; 
                font-weight: bold; 
                text-shadow: 0 0 12px rgba(33, 150, 243, 0.6);
            }
            40% { 
                transform: scale(1.15); 
                color: #1976D2; 
                font-weight: bold; 
                text-shadow: 0 0 8px rgba(25, 118, 210, 0.4);
            }
            60% { 
                transform: scale(1.25); 
                color: #1565C0; 
                font-weight: bold; 
                text-shadow: 0 0 10px rgba(21, 101, 192, 0.5);
            }
            80% { 
                transform: scale(1.05); 
                color: #1976D2; 
                font-weight: bold; 
                text-shadow: 0 0 6px rgba(25, 118, 210, 0.3);
            }
            100% { 
                transform: scale(1); 
                color: rgba(51, 51, 51, 0.8); 
                text-shadow: none;
            }
        }

        /* È¶¨Âç°ÈæçÈÖçËâ≤ËÆäÊï∏ */
        :root {
            --esm-color: #ff6b9d;
            --spm-color: #2c3e50;
            --boost-color: #74b9ff;
            --spike-color: #fdcb6e;
            --ev3-color: #e17055;
            --minecraft-color: #00b894;
        }

        /* ÊïôÊ°àÊåâÈàïÈ°èËâ≤ */
        .lesson-button.esm {
            background: linear-gradient(135deg, var(--esm-color) 0%, #ff8fab 100%);
        }

        .lesson-button.spm {
            background: linear-gradient(135deg, var(--spm-color) 0%, #34495e 100%);
        }

        .lesson-button.boost {
            background: linear-gradient(135deg, var(--boost-color) 0%, #a29bfe 100%);
        }

        .lesson-button.spike {
            background: linear-gradient(135deg, var(--spike-color) 0%, #fdcb6e 100%);
        }

        .lesson-button.ev3 {
            background: linear-gradient(135deg, var(--ev3-color) 0%, #fd79a8 100%);
        }

        .lesson-button.minecraft {
            background: linear-gradient(135deg, var(--minecraft-color) 0%, #55efc4 100%);
        }

        /* Èï∑ÊåâÁ∞ΩÂà∞ÊïàÊûú */
        .event-card {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            position: relative;
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .event-card:hover .long-press-hint {
            opacity: 1 !important;
        }
        
        .event-card.pressing .long-press-hint {
            opacity: 1 !important;
            color: #ff6b6b !important;
            font-weight: bold !important;
            animation: pulse 1s infinite !important;
        }
        
        .event-card.charging .long-press-hint {
            opacity: 1 !important;
            color: #ffd93d !important;
            font-weight: bold !important;
            animation: pulse 0.5s infinite !important;
        }

        .event-card.pressing {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease-out;
        }

        .event-card.charging {
            animation: chargingBounce 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite !important;
            box-shadow: 
                0 0 20px rgba(184, 134, 11, 0.4),
                0 0 40px rgba(184, 134, 11, 0.2),
                inset 0 0 20px rgba(184, 134, 11, 0.1) !important;
            border: 2px solid rgba(184, 134, 11, 0.6) !important;
            background: transparent !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            position: relative !important;
            z-index: 10 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .event-card.charging > * {
            position: relative !important;
            z-index: 15 !important;
        }

        /* ÈáãÊîæÂãïÁï´ - ÂÆåÂÖ®ÂÑ™ÂåñÁâàÊú¨ */
        .event-card.releasing {
            animation: releaseAnimation 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            position: relative !important;
            z-index: 10 !important;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 250, 252, 0.9) 50%,
                rgba(255, 255, 255, 0.95) 100%) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border-radius: 16px !important;
            padding: 20px !important;
            margin-bottom: 15px !important;
            border: 2px solid rgba(255, 215, 0, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }
        
        /* ÈáãÊîæÂãïÁï´ÂÆåÊàêÂæåÁöÑÈÅéÊ∏°ÁãÄÊÖã */
        .event-card.releasing.completing {
            animation: none !important;
            transform: scale(1) translateY(0px) !important;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                0 0 0 1px rgba(255, 215, 0, 0.2) !important;
            border: 2px solid rgba(255, 215, 0, 0.3) !important;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 250, 252, 0.9) 50%,
                rgba(255, 255, 255, 0.95) 100%) !important;
            transition: none !important;
        }

        @keyframes releaseAnimation {
            0% {
                transform: scale(1.05) translateY(-2px);
                box-shadow: 
                    0 15px 35px rgba(0, 0, 0, 0.25), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.9),
                    0 0 0 3px rgba(255, 215, 0, 0.6);
            }
            30% {
                transform: scale(0.95) translateY(1px);
                box-shadow: 
                    0 8px 20px rgba(0, 0, 0, 0.18), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.8),
                    0 0 0 2px rgba(255, 215, 0, 0.4);
            }
            70% {
                transform: scale(1.01) translateY(-0.5px);
                box-shadow: 
                    0 9px 22px rgba(0, 0, 0, 0.16), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.85),
                    0 0 0 1px rgba(255, 215, 0, 0.25);
            }
            100% {
                transform: scale(1) translateY(0px);
                box-shadow: 
                    0 8px 25px rgba(0, 0, 0, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8),
                    0 0 0 1px rgba(255, 215, 0, 0.2);
            }
        }

        /* ÊâãÊ©üÁ´ØÂãïÁï´ÂÑ™Âåñ */
        @media (max-width: 768px) {
            .event-card.charging {
                animation: chargingBounceMobile 1s cubic-bezier(0.4, 0, 0.2, 1) infinite !important;
                box-shadow: 
                    0 0 25px rgba(184, 134, 11, 0.5),
                    0 0 50px rgba(184, 134, 11, 0.3),
                    inset 0 0 25px rgba(184, 134, 11, 0.15) !important;
                border: 3px solid rgba(184, 134, 11, 0.8) !important;
                background: transparent !important;
                opacity: 1 !important;
                visibility: visible !important;
                display: block !important;
                position: relative !important;
                z-index: 10 !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }

            .event-card.charging > * {
                position: relative !important;
                z-index: 15 !important;
            }

            .event-card.charging::before {
                animation: chargingSweepMobile 1s ease-in-out infinite !important;
            }

            .event-card.charging::after {
                width: 70px !important;
                height: 70px !important;
                margin: -35px 0 0 -35px !important;
                border-width: 6px !important;
                animation: chargingSpinMobile 0.8s linear infinite !important;
            }
        }

        .event-card.charging::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(184, 134, 11, 0.1) 20%,
                rgba(255, 215, 0, 0.2) 40%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 215, 0, 0.2) 60%,
                rgba(184, 134, 11, 0.1) 80%,
                transparent 100%) !important;
            animation: chargingSweep 1.2s ease-in-out infinite !important;
            z-index: 1 !important;
            border-radius: inherit !important;
            box-shadow: inset 0 0 15px rgba(184, 134, 11, 0.1) !important;
            pointer-events: none !important;
        }

        .event-card.charging::after {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            width: 60px !important;
            height: 60px !important;
            margin: -30px 0 0 -30px !important;
            border: 5px solid rgba(184, 134, 11, 0.3) !important;
            border-top: 5px solid #b8860b !important;
            border-right: 5px solid #daa520 !important;
            border-bottom: 5px solid #ffd700 !important;
            border-radius: 50% !important;
            animation: chargingSpin 1s linear infinite !important;
            z-index: 2 !important;
            box-shadow: 
                0 0 30px rgba(184, 134, 11, 0.8),
                inset 0 0 10px rgba(255, 215, 0, 0.3) !important;
            pointer-events: none !important;
        }

        @keyframes chargingBounce {
            0% { 
                transform: scale(1.0) translateY(0px) rotate(0deg);
                box-shadow: 
                    0 0 10px rgba(184, 134, 11, 0.2),
                    0 0 20px rgba(184, 134, 11, 0.1),
                    inset 0 0 10px rgba(184, 134, 11, 0.05);
                filter: brightness(1) saturate(1);
            }
            5% { 
                transform: scale(1.005) translateY(-0.2px) rotate(0.1deg);
                box-shadow: 
                    0 0 12px rgba(184, 134, 11, 0.25),
                    0 0 24px rgba(184, 134, 11, 0.12),
                    inset 0 0 12px rgba(184, 134, 11, 0.06);
                filter: brightness(1.02) saturate(1.05);
            }
            10% { 
                transform: scale(1.01) translateY(-0.4px) rotate(0.2deg);
                box-shadow: 
                    0 0 14px rgba(184, 134, 11, 0.3),
                    0 0 28px rgba(184, 134, 11, 0.15),
                    inset 0 0 14px rgba(184, 134, 11, 0.07);
                filter: brightness(1.04) saturate(1.1);
            }
            15% { 
                transform: scale(1.015) translateY(-0.6px) rotate(0.3deg);
                box-shadow: 
                    0 0 16px rgba(184, 134, 11, 0.35),
                    0 0 32px rgba(184, 134, 11, 0.17),
                    inset 0 0 16px rgba(184, 134, 11, 0.08);
                filter: brightness(1.06) saturate(1.15);
            }
            20% { 
                transform: scale(1.02) translateY(-0.8px) rotate(0.4deg);
                box-shadow: 
                    0 0 18px rgba(184, 134, 11, 0.4),
                    0 0 36px rgba(184, 134, 11, 0.2),
                    inset 0 0 18px rgba(184, 134, 11, 0.09);
                filter: brightness(1.08) saturate(1.2);
            }
            25% { 
                transform: scale(1.025) translateY(-1px) rotate(0.5deg);
                box-shadow: 
                    0 0 20px rgba(184, 134, 11, 0.45),
                    0 0 40px rgba(184, 134, 11, 0.22),
                    inset 0 0 20px rgba(184, 134, 11, 0.1);
                filter: brightness(1.1) saturate(1.25);
            }
            30% { 
                transform: scale(1.03) translateY(-1.2px) rotate(0.6deg);
                box-shadow: 
                    0 0 22px rgba(184, 134, 11, 0.5),
                    0 0 44px rgba(184, 134, 11, 0.25),
                    inset 0 0 22px rgba(184, 134, 11, 0.11);
                filter: brightness(1.12) saturate(1.3);
            }
            35% { 
                transform: scale(1.035) translateY(-1.4px) rotate(0.7deg);
                box-shadow: 
                    0 0 24px rgba(184, 134, 11, 0.55),
                    0 0 48px rgba(184, 134, 11, 0.27),
                    inset 0 0 24px rgba(184, 134, 11, 0.12);
                filter: brightness(1.14) saturate(1.35);
            }
            40% { 
                transform: scale(1.04) translateY(-1.6px) rotate(0.8deg);
                box-shadow: 
                    0 0 26px rgba(184, 134, 11, 0.6),
                    0 0 52px rgba(184, 134, 11, 0.3),
                    inset 0 0 26px rgba(184, 134, 11, 0.13);
                filter: brightness(1.16) saturate(1.4);
            }
            45% { 
                transform: scale(1.045) translateY(-1.8px) rotate(0.9deg);
                box-shadow: 
                    0 0 28px rgba(184, 134, 11, 0.65),
                    0 0 56px rgba(184, 134, 11, 0.32),
                    inset 0 0 28px rgba(184, 134, 11, 0.14);
                filter: brightness(1.18) saturate(1.45);
            }
            50% { 
                transform: scale(1.05) translateY(-2px) rotate(1deg);
                box-shadow: 
                    0 0 30px rgba(184, 134, 11, 0.7),
                    0 0 60px rgba(184, 134, 11, 0.35),
                    inset 0 0 30px rgba(184, 134, 11, 0.15);
                filter: brightness(1.2) saturate(1.5);
            }
            55% { 
                transform: scale(1.045) translateY(-1.8px) rotate(0.9deg);
                box-shadow: 
                    0 0 28px rgba(184, 134, 11, 0.65),
                    0 0 56px rgba(184, 134, 11, 0.32),
                    inset 0 0 28px rgba(184, 134, 11, 0.14);
                filter: brightness(1.18) saturate(1.45);
            }
            60% { 
                transform: scale(1.04) translateY(-1.6px) rotate(0.8deg);
                box-shadow: 
                    0 0 26px rgba(184, 134, 11, 0.6),
                    0 0 52px rgba(184, 134, 11, 0.3),
                    inset 0 0 26px rgba(184, 134, 11, 0.13);
                filter: brightness(1.16) saturate(1.4);
            }
            65% { 
                transform: scale(1.035) translateY(-1.4px) rotate(0.7deg);
                box-shadow: 
                    0 0 24px rgba(184, 134, 11, 0.55),
                    0 0 48px rgba(184, 134, 11, 0.27),
                    inset 0 0 24px rgba(184, 134, 11, 0.12);
                filter: brightness(1.14) saturate(1.35);
            }
            70% { 
                transform: scale(1.03) translateY(-1.2px) rotate(0.6deg);
                box-shadow: 
                    0 0 22px rgba(184, 134, 11, 0.5),
                    0 0 44px rgba(184, 134, 11, 0.25),
                    inset 0 0 22px rgba(184, 134, 11, 0.11);
                filter: brightness(1.12) saturate(1.3);
            }
            75% { 
                transform: scale(1.025) translateY(-1px) rotate(0.5deg);
                box-shadow: 
                    0 0 20px rgba(184, 134, 11, 0.45),
                    0 0 40px rgba(184, 134, 11, 0.22),
                    inset 0 0 20px rgba(184, 134, 11, 0.1);
                filter: brightness(1.1) saturate(1.25);
            }
            80% { 
                transform: scale(1.02) translateY(-0.8px) rotate(0.4deg);
                box-shadow: 
                    0 0 18px rgba(184, 134, 11, 0.4),
                    0 0 36px rgba(184, 134, 11, 0.2),
                    inset 0 0 18px rgba(184, 134, 11, 0.09);
                filter: brightness(1.08) saturate(1.2);
            }
            85% { 
                transform: scale(1.015) translateY(-0.6px) rotate(0.3deg);
                box-shadow: 
                    0 0 16px rgba(184, 134, 11, 0.35),
                    0 0 32px rgba(184, 134, 11, 0.17),
                    inset 0 0 16px rgba(184, 134, 11, 0.08);
                filter: brightness(1.06) saturate(1.15);
            }
            90% { 
                transform: scale(1.01) translateY(-0.4px) rotate(0.2deg);
                box-shadow: 
                    0 0 14px rgba(184, 134, 11, 0.3),
                    0 0 28px rgba(184, 134, 11, 0.15),
                    inset 0 0 14px rgba(184, 134, 11, 0.07);
                filter: brightness(1.04) saturate(1.1);
            }
            95% { 
                transform: scale(1.005) translateY(-0.2px) rotate(0.1deg);
                box-shadow: 
                    0 0 12px rgba(184, 134, 11, 0.25),
                    0 0 24px rgba(184, 134, 11, 0.12),
                    inset 0 0 12px rgba(184, 134, 11, 0.06);
                filter: brightness(1.02) saturate(1.05);
            }
            100% { 
                transform: scale(1.0) translateY(0px) rotate(0deg);
                box-shadow: 
                    0 0 10px rgba(184, 134, 11, 0.2),
                    0 0 20px rgba(184, 134, 11, 0.1),
                    inset 0 0 10px rgba(184, 134, 11, 0.05);
                filter: brightness(1) saturate(1);
            }
        }

        @keyframes chargingSweep {
            0% { 
                transform: translateX(-120%) scaleY(1.1) rotate(1.5deg);
                opacity: 0.4;
                filter: blur(1px);
            }
            10% {
                transform: translateX(-100%) scaleY(1.2) rotate(1.2deg);
                opacity: 0.5;
                filter: blur(0.8px);
            }
            20% {
                transform: translateX(-80%) scaleY(1.3) rotate(0.9deg);
                opacity: 0.6;
                filter: blur(0.6px);
            }
            30% {
                transform: translateX(-60%) scaleY(1.4) rotate(0.6deg);
                opacity: 0.7;
                filter: blur(0.4px);
            }
            40% {
                transform: translateX(-40%) scaleY(1.5) rotate(0.3deg);
                opacity: 0.8;
                filter: blur(0.2px);
            }
            50% {
                transform: translateX(0%) scaleY(1.6) rotate(0deg);
                opacity: 1;
                filter: blur(0px);
            }
            60% {
                transform: translateX(40%) scaleY(1.5) rotate(-0.3deg);
                opacity: 0.8;
                filter: blur(0.2px);
            }
            70% {
                transform: translateX(60%) scaleY(1.4) rotate(-0.6deg);
                opacity: 0.7;
                filter: blur(0.4px);
            }
            80% {
                transform: translateX(80%) scaleY(1.3) rotate(-0.9deg);
                opacity: 0.6;
                filter: blur(0.6px);
            }
            90% {
                transform: translateX(100%) scaleY(1.2) rotate(-1.2deg);
                opacity: 0.5;
                filter: blur(0.8px);
            }
            100% { 
                transform: translateX(120%) scaleY(1.1) rotate(-1.5deg);
                opacity: 0.4;
                filter: blur(1px);
            }
        }

        @keyframes chargingSpin {
            0% { 
                transform: rotate(0deg) scale(1) translateY(0px);
                opacity: 0.6;
                filter: brightness(1) contrast(1);
            }
            12.5% {
                transform: rotate(45deg) scale(1.05) translateY(-1px);
                opacity: 0.7;
                filter: brightness(1.1) contrast(1.05);
            }
            25% {
                transform: rotate(90deg) scale(1.1) translateY(-2px);
                opacity: 0.8;
                filter: brightness(1.2) contrast(1.1);
            }
            37.5% {
                transform: rotate(135deg) scale(1.15) translateY(-3px);
                opacity: 0.9;
                filter: brightness(1.3) contrast(1.15);
            }
            50% {
                transform: rotate(180deg) scale(1.2) translateY(-4px);
                opacity: 1;
                filter: brightness(1.4) contrast(1.2);
            }
            62.5% {
                transform: rotate(225deg) scale(1.15) translateY(-3px);
                opacity: 0.9;
                filter: brightness(1.3) contrast(1.15);
            }
            75% {
                transform: rotate(270deg) scale(1.1) translateY(-2px);
                opacity: 0.8;
                filter: brightness(1.2) contrast(1.1);
            }
            87.5% {
                transform: rotate(315deg) scale(1.05) translateY(-1px);
                opacity: 0.7;
                filter: brightness(1.1) contrast(1.05);
            }
            100% { 
                transform: rotate(360deg) scale(1) translateY(0px);
                opacity: 0.6;
                filter: brightness(1) contrast(1);
            }
        }

        @keyframes successPulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            }
            25% { 
                transform: scale(1.1);
                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.6);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 12px 35px rgba(40, 167, 69, 0.8);
            }
            75% { 
                transform: scale(1.08);
                box-shadow: 0 10px 30px rgba(40, 167, 69, 0.7);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            }
        }

        /* ÊâãÊ©üÁ´ØÂ∞àÁî®ÂãïÁï´ */
        @keyframes chargingBounceMobile {
            0% { 
                transform: scale(1.02) translateY(0px) rotate(0deg);
                box-shadow: 
                    0 0 15px rgba(184, 134, 11, 0.3),
                    0 0 30px rgba(184, 134, 11, 0.15),
                    inset 0 0 15px rgba(184, 134, 11, 0.08);
                filter: brightness(1) saturate(1);
            }
            5% { 
                transform: scale(1.025) translateY(-0.3px) rotate(0.15deg);
                box-shadow: 
                    0 0 18px rgba(184, 134, 11, 0.35),
                    0 0 36px rgba(184, 134, 11, 0.17),
                    inset 0 0 18px rgba(184, 134, 11, 0.09);
                filter: brightness(1.05) saturate(1.1);
            }
            10% { 
                transform: scale(1.03) translateY(-0.6px) rotate(0.3deg);
                box-shadow: 
                    0 0 22px rgba(184, 134, 11, 0.4),
                    0 0 44px rgba(184, 134, 11, 0.2),
                    inset 0 0 22px rgba(184, 134, 11, 0.1);
                filter: brightness(1.1) saturate(1.2);
            }
            15% { 
                transform: scale(1.035) translateY(-0.9px) rotate(0.45deg);
                box-shadow: 
                    0 0 25px rgba(184, 134, 11, 0.45),
                    0 0 50px rgba(184, 134, 11, 0.22),
                    inset 0 0 25px rgba(184, 134, 11, 0.11);
                filter: brightness(1.15) saturate(1.3);
            }
            20% { 
                transform: scale(1.04) translateY(-1.2px) rotate(0.6deg);
                box-shadow: 
                    0 0 28px rgba(184, 134, 11, 0.5),
                    0 0 56px rgba(184, 134, 11, 0.25),
                    inset 0 0 28px rgba(184, 134, 11, 0.12);
                filter: brightness(1.2) saturate(1.4);
            }
            25% { 
                transform: scale(1.045) translateY(-1.5px) rotate(0.75deg);
                box-shadow: 
                    0 0 30px rgba(184, 134, 11, 0.55),
                    0 0 60px rgba(184, 134, 11, 0.27),
                    inset 0 0 30px rgba(184, 134, 11, 0.13);
                filter: brightness(1.25) saturate(1.5);
            }
            30% { 
                transform: scale(1.05) translateY(-1.8px) rotate(0.9deg);
                box-shadow: 
                    0 0 32px rgba(184, 134, 11, 0.6),
                    0 0 64px rgba(184, 134, 11, 0.3),
                    inset 0 0 32px rgba(184, 134, 11, 0.14);
                filter: brightness(1.3) saturate(1.6);
            }
            35% { 
                transform: scale(1.055) translateY(-2.1px) rotate(1.05deg);
                box-shadow: 
                    0 0 34px rgba(184, 134, 11, 0.65),
                    0 0 68px rgba(184, 134, 11, 0.32),
                    inset 0 0 34px rgba(184, 134, 11, 0.15);
                filter: brightness(1.35) saturate(1.7);
            }
            40% { 
                transform: scale(1.06) translateY(-2.4px) rotate(1.2deg);
                box-shadow: 
                    0 0 36px rgba(184, 134, 11, 0.7),
                    0 0 72px rgba(184, 134, 11, 0.35),
                    inset 0 0 36px rgba(184, 134, 11, 0.16);
                filter: brightness(1.4) saturate(1.8);
            }
            45% { 
                transform: scale(1.065) translateY(-2.7px) rotate(1.35deg);
                box-shadow: 
                    0 0 38px rgba(184, 134, 11, 0.75),
                    0 0 76px rgba(184, 134, 11, 0.37),
                    inset 0 0 38px rgba(184, 134, 11, 0.17);
                filter: brightness(1.45) saturate(1.9);
            }
            50% { 
                transform: scale(1.07) translateY(-3px) rotate(1.5deg);
                box-shadow: 
                    0 0 40px rgba(184, 134, 11, 0.8),
                    0 0 80px rgba(184, 134, 11, 0.4),
                    inset 0 0 40px rgba(184, 134, 11, 0.18);
                filter: brightness(1.5) saturate(2);
            }
            55% { 
                transform: scale(1.065) translateY(-2.7px) rotate(1.35deg);
                box-shadow: 
                    0 0 38px rgba(184, 134, 11, 0.75),
                    0 0 76px rgba(184, 134, 11, 0.37),
                    inset 0 0 38px rgba(184, 134, 11, 0.17);
                filter: brightness(1.45) saturate(1.9);
            }
            60% { 
                transform: scale(1.06) translateY(-2.4px) rotate(1.2deg);
                box-shadow: 
                    0 0 36px rgba(184, 134, 11, 0.7),
                    0 0 72px rgba(184, 134, 11, 0.35),
                    inset 0 0 36px rgba(184, 134, 11, 0.16);
                filter: brightness(1.4) saturate(1.8);
            }
            65% { 
                transform: scale(1.055) translateY(-2.1px) rotate(1.05deg);
                box-shadow: 
                    0 0 34px rgba(184, 134, 11, 0.65),
                    0 0 68px rgba(184, 134, 11, 0.32),
                    inset 0 0 34px rgba(184, 134, 11, 0.15);
                filter: brightness(1.35) saturate(1.7);
            }
            70% { 
                transform: scale(1.05) translateY(-1.8px) rotate(0.9deg);
                box-shadow: 
                    0 0 32px rgba(184, 134, 11, 0.6),
                    0 0 64px rgba(184, 134, 11, 0.3),
                    inset 0 0 32px rgba(184, 134, 11, 0.14);
                filter: brightness(1.3) saturate(1.6);
            }
            75% { 
                transform: scale(1.045) translateY(-1.5px) rotate(0.75deg);
                box-shadow: 
                    0 0 30px rgba(184, 134, 11, 0.55),
                    0 0 60px rgba(184, 134, 11, 0.27),
                    inset 0 0 30px rgba(184, 134, 11, 0.13);
                filter: brightness(1.25) saturate(1.5);
            }
            80% { 
                transform: scale(1.04) translateY(-1.2px) rotate(0.6deg);
                box-shadow: 
                    0 0 28px rgba(184, 134, 11, 0.5),
                    0 0 56px rgba(184, 134, 11, 0.25),
                    inset 0 0 28px rgba(184, 134, 11, 0.12);
                filter: brightness(1.2) saturate(1.4);
            }
            85% { 
                transform: scale(1.035) translateY(-0.9px) rotate(0.45deg);
                box-shadow: 
                    0 0 25px rgba(184, 134, 11, 0.45),
                    0 0 50px rgba(184, 134, 11, 0.22),
                    inset 0 0 25px rgba(184, 134, 11, 0.11);
                filter: brightness(1.15) saturate(1.3);
            }
            90% { 
                transform: scale(1.03) translateY(-0.6px) rotate(0.3deg);
                box-shadow: 
                    0 0 22px rgba(184, 134, 11, 0.4),
                    0 0 44px rgba(184, 134, 11, 0.2),
                    inset 0 0 22px rgba(184, 134, 11, 0.1);
                filter: brightness(1.1) saturate(1.2);
            }
            95% { 
                transform: scale(1.025) translateY(-0.3px) rotate(0.15deg);
                box-shadow: 
                    0 0 18px rgba(184, 134, 11, 0.35),
                    0 0 36px rgba(184, 134, 11, 0.17),
                    inset 0 0 18px rgba(184, 134, 11, 0.09);
                filter: brightness(1.05) saturate(1.1);
            }
            100% { 
                transform: scale(1.02) translateY(0px) rotate(0deg);
                box-shadow: 
                    0 0 15px rgba(184, 134, 11, 0.3),
                    0 0 30px rgba(184, 134, 11, 0.15),
                    inset 0 0 15px rgba(184, 134, 11, 0.08);
                filter: brightness(1) saturate(1);
            }
        }

        @keyframes chargingSweepMobile {
            0% { 
                transform: translateX(-150%) scaleY(1.3) rotate(2deg);
                opacity: 0.5;
                filter: blur(1.5px);
            }
            10% {
                transform: translateX(-120%) scaleY(1.4) rotate(1.6deg);
                opacity: 0.6;
                filter: blur(1.2px);
            }
            20% {
                transform: translateX(-90%) scaleY(1.5) rotate(1.2deg);
                opacity: 0.7;
                filter: blur(0.9px);
            }
            30% {
                transform: translateX(-60%) scaleY(1.6) rotate(0.8deg);
                opacity: 0.8;
                filter: blur(0.6px);
            }
            40% {
                transform: translateX(-30%) scaleY(1.7) rotate(0.4deg);
                opacity: 0.9;
                filter: blur(0.3px);
            }
            50% {
                transform: translateX(0%) scaleY(1.8) rotate(0deg);
                opacity: 1;
                filter: blur(0px);
            }
            60% {
                transform: translateX(30%) scaleY(1.7) rotate(-0.4deg);
                opacity: 0.9;
                filter: blur(0.3px);
            }
            70% {
                transform: translateX(60%) scaleY(1.6) rotate(-0.8deg);
                opacity: 0.8;
                filter: blur(0.6px);
            }
            80% {
                transform: translateX(90%) scaleY(1.5) rotate(-1.2deg);
                opacity: 0.7;
                filter: blur(0.9px);
            }
            90% {
                transform: translateX(120%) scaleY(1.4) rotate(-1.6deg);
                opacity: 0.6;
                filter: blur(1.2px);
            }
            100% { 
                transform: translateX(150%) scaleY(1.3) rotate(-2deg);
                opacity: 0.5;
                filter: blur(1.5px);
            }
        }

        @keyframes chargingSpinMobile {
            0% { 
                transform: rotate(0deg) scale(1) translateY(0px);
                opacity: 0.7;
                filter: brightness(1) contrast(1);
            }
            12.5% {
                transform: rotate(45deg) scale(1.1) translateY(-1.5px);
                opacity: 0.8;
                filter: brightness(1.1) contrast(1.05);
            }
            25% {
                transform: rotate(90deg) scale(1.2) translateY(-3px);
                opacity: 0.9;
                filter: brightness(1.2) contrast(1.1);
            }
            37.5% {
                transform: rotate(135deg) scale(1.3) translateY(-4.5px);
                opacity: 1;
                filter: brightness(1.3) contrast(1.15);
            }
            50% {
                transform: rotate(180deg) scale(1.4) translateY(-6px);
                opacity: 1;
                filter: brightness(1.4) contrast(1.2);
            }
            62.5% {
                transform: rotate(225deg) scale(1.3) translateY(-4.5px);
                opacity: 1;
                filter: brightness(1.3) contrast(1.15);
            }
            75% {
                transform: rotate(270deg) scale(1.2) translateY(-3px);
                opacity: 0.9;
                filter: brightness(1.2) contrast(1.1);
            }
            87.5% {
                transform: rotate(315deg) scale(1.1) translateY(-1.5px);
                opacity: 0.8;
                filter: brightness(1.1) contrast(1.05);
            }
            100% { 
                transform: rotate(360deg) scale(1) translateY(0px);
                opacity: 0.7;
                filter: brightness(1) contrast(1);
            }
        }

        /* Ë¨õÂ∏´Â∫ïËâ≤ */
        .event-instructor.custom-color {
            background: var(--instructor-color) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }
    </style>
</head>
<body>
    <!-- ËºâÂÖ•ÂãïÁï´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-logo">
                <img src="logo.jpg" alt="FLB Logo" />
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-text">üöÄ ËºâÂÖ•‰∏≠...</div>
            <div class="loading-subtitle">Ê≠£Âú®ÂàùÂßãÂåñÁ≥ªÁµ±ÔºåË´ãÁ®çÂÄô</div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
                <div class="loading-percentage" id="loadingPercentage">0%</div>
            <div class="loading-logs" id="loadingLogs">
                <div class="loading-log-item info">
                    <span class="loading-log-icon">‚ÑπÔ∏è</span>
                    <span>Á≥ªÁµ±ÂàùÂßãÂåñ‰∏≠...</span>
            </div>
        </div>
        </div>
        <div class="loading-signature">TimÊÑüÊÅ©Êà¥Âæ∑üôèüèª</div>
    </div>

    <!-- Êá∏ÊµÆÂõ∫ÂÆöÈÅ∏ÂñÆ -->
    <div class="floating-stats-menu" id="floatingStatsMenu">
        <div class="floating-stats-content">
            <div class="floating-filter-buttons">
                <button class="floating-filter-btn" data-filter="today">‰ªäÊó•</button>
                <button class="floating-filter-btn" data-filter="week">Êú¨ÈÄ±</button>
                <button class="floating-filter-btn" data-filter="month">Êú¨Êúà</button>
                <button class="floating-filter-btn" data-filter="all">ÂÖ®ÈÉ®</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <img src="logo.jpg" alt="FLB Logo" class="header-logo">
                    <div>
                        <h1>FLBË¨õÂ∏´Ë°å‰∫ãÊõÜÊ™¢Ë¶ñÁ≥ªÁµ±</h1>
                        <p class="header-subtitle">Âç≥ÊôÇÊü•ÁúãÊâÄÊúâË¨õÂ∏´ÁöÑË°åÁ®ãÂÆâÊéí</p>
                        <p class="header-tim-note">TimÊÑüÊÅ©Êà¥Âæ∑üôèüèª</p>
                    </div>
                </div>
        </div>

            <!-- Êó•ÊúüÊôÇÈñìÈ°ØÁ§∫ -->
            <div class="datetime-display">
                <div class="datetime-item">
                    <i class="fas fa-calendar"></i>
                    <span id="currentDate">2025Âπ¥01Êúà16Êó• ÊòüÊúüÂõõ</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime">13:58:43</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-calendar-week"></i>
                    <span id="currentWeek">2025Âπ¥Á¨¨3ÈÄ±</span>
                </div>
            </div>
            
            <!-- ÈÄ≤Â∫¶ÊåáÁ§∫Âô® -->
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-circle">1</div>
                    <div class="step-label">ÈÅ∏ÊìáË¨õÂ∏´</div>
                </div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">Êü•ÁúãË°å‰∫ãÊõÜ</div>
                </div>
                <div class="step pending">
                    <div class="step-circle">3</div>
                    <div class="step-label">ÁÆ°ÁêÜË°åÁ®ã</div>
                </div>
            </div>
        </div>

        <!-- ‰∏ªÂÖßÂÆπÂçÄÂüü -->
        <div class="main-content">
            <div class="content-header">
                <i class="fas fa-calendar-alt"></i>
                <h2>Ë¨õÂ∏´Ë°å‰∫ãÊõÜÊ™¢Ë¶ñ</h2>
            </div>

            <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="instructorSelect">ÈÅ∏ÊìáË¨õÂ∏´</label>
                    <select id="instructorSelect">
                        <option value="">ÂÖ®ÈÉ®Ë¨õÂ∏´</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="timeFilter">ÊôÇÊÆµÁØ©ÈÅ∏</label>
                        <select id="timeFilter">
                            <option value="">ÂÖ®ÈÉ®ÊôÇÊÆµ</option>
                            <option value="morning">Êó©‰∏ä (06:00-12:00)</option>
                            <option value="afternoon">‰∏ãÂçà (12:00-18:00)</option>
                            <option value="evening">Êôö‰∏ä (18:00-24:00)</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="dateFilter">ÊåáÂÆöÊó•Êúü</label>
                        <input type="date" id="dateFilter" />
                    </div>
                    <div class="control-group">
                        <div class="view-buttons">
                            <button class="btn btn-primary active" data-view="today">‰ªäÊó•</button>
                            <button class="btn btn-primary" data-view="week">Êú¨ÈÄ±</button>
                            <button class="btn btn-primary" data-view="month">Êú¨Êúà</button>
                            <button class="btn btn-primary" data-view="all">ÂÖ®ÈÉ®</button>
                </div>
            </div>
        </div>

                    <!-- Áµ±Ë®à‰ø°ÊÅØÊñáÂ≠óÈ°ØÁ§∫ -->
                    <div class="stats-text" id="statsText" style="text-align: center; margin-top: 8px; padding: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; font-size: 0.75rem; color: rgba(51, 51, 51, 0.8); max-width: 100%;">
                        <div class="stats-row" style="margin-bottom: 4px;">
                            <span id="totalEventsText">Á∏ΩË™≤Á®ã: 0</span> | 
                            <span id="instructorCountText">Ë¨õÂ∏´: 0</span>
                </div>
                        <div class="stats-row">
                            <span id="dateRangeText">Êó•Êúü: -</span>
                </div>
                </div>
                    

            </div>
        </div>


            <!-- Ë™≤Á®ãÂàóË°® -->
        <div class="events-container" id="eventsContainer">
            <div class="no-events">
                <i class="fas fa-calendar-times"></i>
                <h3>ËºâÂÖ•‰∏≠...</h3>
                <p>Ê≠£Âú®Áç≤ÂèñË°å‰∫ãÊõÜË≥áÊñô</p>
                </div>
            </div>

            <!-- Áî®Êà∂Ë≥áË®äÂçÄÂüü -->
            <div class="user-info-section" id="userInfoGroup" style="display: block;">
                <div class="user-info-container">
                    <h3>LINE Áî®Êà∂Ë≥áË®ä</h3>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="userDisplayName">Êú™Á∂ÅÂÆö</div>
                            <div class="user-id" id="userDisplayId" style="display: none;"></div>
                        </div>
                        <button class="btn btn-secondary" id="bindUserBtn">Á∂ÅÂÆöÂ∏≥Ëôü</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë®≠ÁΩÆÁï´Èù¢ -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <h2><i class="fas fa-palette"></i> È°èËâ≤Ë®≠ÁΩÆ</h2>
                <button class="close-settings" id="closeSettingsBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="settings-section">
                <h3>ÊïôÊ°àÈ°ûÂûãÈ°èËâ≤</h3>
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label>ESM</label>
                        <input type="color" class="color-picker" id="esmColor" value="#ff6b9d">
                    </div>
                    <div class="color-picker-item">
                        <label>SPM</label>
                        <input type="color" class="color-picker" id="spmColor" value="#2c3e50">
                    </div>
                    <div class="color-picker-item">
                        <label>BOOST</label>
                        <input type="color" class="color-picker" id="boostColor" value="#74b9ff">
                    </div>
                    <div class="color-picker-item">
                        <label>SPIKE</label>
                        <input type="color" class="color-picker" id="spikeColor" value="#fdcb6e">
                    </div>
                    <div class="color-picker-item">
                        <label>EV3</label>
                        <input type="color" class="color-picker" id="ev3Color" value="#e17055">
                    </div>
                    <div class="color-picker-item">
                        <label>MINECRAFT</label>
                        <input type="color" class="color-picker" id="minecraftColor" value="#00b894">
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Ë¨õÂ∏´Â∫ïËâ≤Ë®≠ÁΩÆ</h3>
                <div class="color-picker-group" id="instructorColorGroup">
                    <!-- Ë¨õÂ∏´È°èËâ≤Ë®≠ÁΩÆÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
                </div>
            </div>

            <button class="save-settings" id="saveSettingsBtn">
                <i class="fas fa-save"></i> ÂÑ≤Â≠òË®≠ÁΩÆ
            </button>
        </div>
    </div>

     <!-- ÈáçÊñ∞Êï¥ÁêÜÊµÆÂãïÊåâÈàï -->
     <div id="refreshButton" class="refresh-button" title="ÈáçÊñ∞Êï¥ÁêÜË°å‰∫ãÊõÜ">
         <i class="fas fa-sync-alt"></i>
     </div>

     <!-- Á∞ΩÂà∞Á≥ªÁµ±Êá∏ÊµÆÈÅ∏ÂñÆ -->
     <div id="attendanceMenu" class="attendance-menu" title="Á∞ΩÂà∞Á≥ªÁµ±">
         <div class="attendance-menu-button">
             <i class="fas fa-calendar-check"></i>
         </div>
         <div class="attendance-menu-tooltip">
             <span>Á∞ΩÂà∞Á≥ªÁµ±</span>
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let allEvents = [];
        let allInstructors = [];
        let currentView = '‰ªäÊó•'; // Áµ±‰∏Ä‰ΩøÁî®‰∏≠Êñá
        let currentUser = null;
        let colorSettings = {
            esm: 'rgba(255, 182, 193, 0.8)',
            spm: 'rgba(116, 185, 255, 0.8)',
            boost: 'rgba(116, 185, 255, 0.8)',
            spike: 'rgba(255, 223, 102, 0.8)',
            ev3: 'rgba(180, 167, 214, 0.8)',
            minecraft: 'rgba(0, 184, 148, 0.8)'
        };
        let instructorColors = {};

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÔºåÈñãÂßãÂàùÂßãÂåñ...');
            
            // È°ØÁ§∫ËºâÂÖ•ÂãïÁï´
            showLoadingAnimation();
            
            // Ë®≠ÁΩÆË™≤Á®ãÁõ£ËÅΩÂô®
            setupEventListeners();
            
            // ÂàùÂßãÂåñÁ≥ªÁµ±
            initializeSystem();
            
            // ÂàùÂßãÂåñÊá∏ÊµÆÈÅ∏ÂñÆÊªæÂãïÁõ£ËÅΩ
            initializeFloatingMenu();
        });

        // È°ØÁ§∫ËºâÂÖ•ÂãïÁï´
        function showLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }
            
            // ÈáçÁΩÆÈÄ≤Â∫¶Ê¢ù
            updateLoadingProgress(0);
        }

        // Êõ¥Êñ∞ËºâÂÖ•ÈÄ≤Â∫¶
        function updateLoadingProgress(percentage) {
            const progressBar = document.getElementById('loadingProgressBar');
            const percentageText = document.getElementById('loadingPercentage');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (percentageText) {
                percentageText.textContent = Math.round(percentage) + '%';
            }
        }

        // Èö±ËóèËºâÂÖ•ÂãïÁï´
        function hideLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            if (mainContainer) {
                mainContainer.style.display = 'block';
                // Ëß∏Áôº‰∏ªÂÆπÂô®ÁöÑÈÄ≤ÂÖ•ÂãïÁï´
                mainContainer.classList.add('fade-in');
            }
        }

        // ÁÇ∫ÂÖÉÁ¥†Ê∑ªÂä†ÂãïÁï´ÊïàÊûú
        function addAnimationToElement(element, animationClass, delay = 0) {
            if (element) {
                setTimeout(() => {
                    element.classList.add(animationClass);
                }, delay);
            }
        }

        // ÁÇ∫Ë™≤Á®ãÂç°ÁâáÊ∑ªÂä†ÈÄ≤ÂÖ•ÂãïÁï´
        function animateEventCards() {
            const eventCards = document.querySelectorAll('.event-card');
            eventCards.forEach((card, index) => {
                // ÈáçÁΩÆÂãïÁï´ÁãÄÊÖã
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.animation = 'none';
                
                // Âº∑Âà∂ÈáçÊéí
                card.offsetHeight;
                
                // ÈáçÊñ∞ÂïüÂãïÂãïÁï´
                card.style.animation = `slideUp 0.6s ease-out forwards`;
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }

        // Ë®àÁÆóÂÄíÊï∏Ë®àÊôÇ
        function calculateCountdown(startTime, endTime) {
            const now = new Date();
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            const timeDiff = start.getTime() - now.getTime();
            const endDiff = end.getTime() - now.getTime();
            
            // Â¶ÇÊûúË™≤Á®ãÂ∑≤ÁµêÊùü
            if (endDiff <= 0) {
                return {
                    text: 'Ë™≤Á®ãÂ∑≤ÁµêÊùü',
                    status: 'overdue',
                    icon: 'fas fa-check-circle'
                };
            }
            
            // Â¶ÇÊûúË™≤Á®ãÊ≠£Âú®ÈÄ≤Ë°å‰∏≠
            if (timeDiff <= 0 && endDiff > 0) {
                const remainingMinutes = Math.floor(endDiff / (1000 * 60));
                const remainingHours = Math.floor(remainingMinutes / 60);
                const remainingMins = remainingMinutes % 60;
                
                if (remainingHours > 0) {
                    return {
                        text: `ÈÄ≤Ë°å‰∏≠ÔºåÂâ©È§ò ${remainingHours}Â∞èÊôÇ${remainingMins}ÂàÜÈêò`,
                        status: 'ongoing',
                        icon: 'fas fa-play-circle'
                    };
                } else {
                    return {
                        text: `ÈÄ≤Ë°å‰∏≠ÔºåÂâ©È§ò ${remainingMins}ÂàÜÈêò`,
                        status: 'ongoing',
                        icon: 'fas fa-play-circle'
                    };
                }
            }
            
            // Â¶ÇÊûúË™≤Á®ãÂ∞öÊú™ÈñãÂßã
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return {
                    text: `ÈÇÑÊúâ ${days}Â§©${hours}Â∞èÊôÇ`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            } else if (hours > 0) {
                return {
                    text: `ÈÇÑÊúâ ${hours}Â∞èÊôÇ${minutes}ÂàÜÈêò`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            } else {
                return {
                    text: `ÈÇÑÊúâ ${minutes}ÂàÜÈêò`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            }
        }

        // Êõ¥Êñ∞ÊâÄÊúâÂÄíÊï∏Ë®àÊôÇ
        function updateAllCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown-timer');
            countdownElements.forEach(element => {
                const startTime = element.dataset.startTime;
                const endTime = element.dataset.endTime;
                
                if (startTime && endTime) {
                    const countdown = calculateCountdown(startTime, endTime);
                    element.className = `countdown-timer ${countdown.status}`;
                    element.innerHTML = `
                        <i class="${countdown.icon} countdown-icon"></i>
                        <span class="countdown-text">${countdown.text}</span>
                    `;
                }
            });
        }

        // ÂàùÂßãÂåñÁ≥ªÁµ±
        async function initializeSystem() {
            try {
                console.log('ÈñãÂßãÂàùÂßãÂåñÁ≥ªÁµ±...');
                addLoadingLog('üöÄ ÈñãÂßãÂàùÂßãÂåñÁ≥ªÁµ±...', 'info');
                updateLoadingProgress(10);
                
                // ÂàùÂßãÂåñÂÖ®Â±ÄËÆäÈáè
                window.currentView = '‰ªäÊó•';
                
                // ËºâÂÖ•Ë®≠ÂÆö
                addLoadingLog('‚öôÔ∏è ËºâÂÖ•Á≥ªÁµ±Ë®≠ÂÆö...', 'info');
                loadSettings();
                updateLoadingProgress(20);
                
                // Êõ¥Êñ∞Êó•ÊúüÊôÇÈñìÔºàÁßªÈô§ËÉåÊôØÁõ£ËÅΩÔºâ
                addLoadingLog('üïê ÂàùÂßãÂåñÊôÇÈñìÁ≥ªÁµ±...', 'info');
                updateDateTime();
                updateLoadingProgress(30);
                
                // ÂÖàËºâÂÖ•Ë°å‰∫ãÊõÜË≥áÊñôÔºåÂÜçÂàùÂßãÂåñLIFF
                addLoadingLog('üìÖ Ê≠£Âú®ËºâÂÖ•Ë°å‰∫ãÊõÜË≥áÊñô...', 'info');
                await loadEvents().catch(error => {
                    console.error('ËºâÂÖ•Ë°å‰∫ãÊõÜË≥áÊñôÂ§±Êïó:', error);
                    addLoadingLog('‚ùå ËºâÂÖ•Ë°å‰∫ãÊõÜË≥áÊñôÂ§±Êïó: ' + error.message, 'error');
                });
                addLoadingLog('‚úÖ Ë°å‰∫ãÊõÜË≥áÊñôËºâÂÖ•ÂÆåÊàê', 'success');
                updateLoadingProgress(60);
                
                addLoadingLog('üîê Ê≠£Âú®ÂàùÂßãÂåñ LINE ÁôªÂÖ•...', 'info');
                await initLineUser().catch(error => {
                    console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', error);
                    addLoadingLog('‚ùå LINE ÁôªÂÖ•ÂàùÂßãÂåñÂ§±Êïó: ' + error.message, 'error');
                });
                addLoadingLog('‚úÖ LINE ÁôªÂÖ•ÂàùÂßãÂåñÂÆåÊàê', 'success');
                updateLoadingProgress(80);
                
                console.log('ÊâÄÊúâÂàùÂßãÂåñ‰ªªÂãôÂÆåÊàêÔºåÈñãÂßãË¨õÂ∏´ÊØîÂ∞ç...');
                addLoadingLog('üë®‚Äçüè´ ÈñãÂßãË¨õÂ∏´Ë∫´‰ªΩÊØîÂ∞ç...', 'info');
                updateLoadingProgress(90);
                
                // Ê™¢Êü•ÊòØÂê¶Âú®Êú¨Âú∞Áí∞Â¢É
                const isLocal = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.hostname === '0.0.0.0' ||
                               window.location.protocol === 'file:';
                
                if (isLocal) {
                    console.log('üåê Êú¨Âú∞Áí∞Â¢ÉÊ®°ÂºèÔºåË∑≥ÈÅéË¨õÂ∏´Ëá™ÂãïÊØîÂ∞ç');
                    addLoadingLog('üåê Êú¨Âú∞Áí∞Â¢ÉÊ®°ÂºèÔºåË∑≥ÈÅéË¨õÂ∏´Ëá™ÂãïÊØîÂ∞ç', 'info');
                    console.log('Ë¨õÂ∏´ÊØîÂ∞çÂÆåÊàê');
                    addLoadingLog('‚úÖ Êú¨Âú∞Ê®°ÂºèÂàùÂßãÂåñÂÆåÊàê', 'success');
                } else if (currentUser && currentUser.userId && currentUser.displayName) {
                    console.log('=== ÈñãÂßãËá™ÂãïÊØîÂ∞çË¨õÂ∏´ ===');
                    console.log('Áî®Êà∂Ë≥áÊñô:', currentUser);
                    addLoadingLog('üîç Ê≠£Âú®ÊØîÂ∞çË¨õÂ∏´Ë∫´‰ªΩ...', 'info');
                    
                    try {
                        await autoMatchTeacher(currentUser.userId, currentUser.displayName);
                        console.log('Ë¨õÂ∏´ÊØîÂ∞çÂÆåÊàê');
                        addLoadingLog('‚úÖ Ë¨õÂ∏´Ë∫´‰ªΩÊØîÂ∞çÂÆåÊàê', 'success');
                    } catch (error) {
                        console.error('Ëá™ÂãïÊØîÂ∞çË¨õÂ∏´Â§±Êïó:', error);
                        addLoadingLog('‚ö†Ô∏è Ë¨õÂ∏´Ë∫´‰ªΩÊØîÂ∞çÂ§±Êïó: ' + error.message, 'warning');
                    }
                } else {
                    console.log('Ê≤íÊúâÁî®Êà∂Ë≥áÊñôÔºåË∑≥ÈÅéËá™ÂãïÊØîÂ∞ç');
                    addLoadingLog('‚ö†Ô∏è Ê≤íÊúâÁî®Êà∂Ë≥áÊñôÔºåË∑≥ÈÅéË¨õÂ∏´ÊØîÂ∞ç', 'warning');
                }
                
                addLoadingLog('üéâ Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàêÔºÅ', 'success');
                updateLoadingProgress(100);
                
                // ÊØîÂ∞çÂÆåÊàêÂæåÈö±ËóèËºâÂÖ•ÂãïÁï´
                setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
                        
                        // Á∂ÅÂÆöË¶ñÂúñÊåâÈàïÔºàÁßªÈô§ÈáçË§áÁ∂ÅÂÆöÔºâ
                        console.log('üîÑ Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàêÔºåÈñãÂßãÁ∂ÅÂÆöÊåâÈàï...');
                        bindViewButtons();
                        bindRefreshButton();
                        bindAttendanceMenu();
                        
                        // Ë®≠ÁΩÆ‰ªäÊó•ÊåâÈàïÁöÑÈ†êË®≠Êåâ‰∏ãÊïàÊûú
                        updateViewButtonStates();
                        console.log('üîÑ ‰ªäÊó•ÊåâÈàïÈ†êË®≠ÁãÄÊÖãÂ∑≤Ë®≠ÁΩÆ');
                        
                        // Êõ¥Êñ∞ÊôÇÊÆµÁØ©ÈÅ∏ÈÅ∏È†ÖÔºàÊô∫ÊÖßÁÆóÊ≥ïÔºâ
                        updateTimeFilterOptions();
                        console.log('üïê ÊôÇÊÆµÁØ©ÈÅ∏Êô∫ÊÖßÁÆóÊ≥ïÂ∑≤Êõ¥Êñ∞');
                        
                        // Ëá™ÂãïÊªëÂãïÂà∞Ë°å‰∫ãÊõÜÂçÄÂüüÔºàÂÉÖË°åÂãïË£ùÁΩÆÔºâ
                        autoScrollToCalendar();
                    } catch (error) {
                        console.error('Èö±ËóèËºâÂÖ•ÂãïÁï´Â§±Êïó:', error);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó:', error);
                // Âç≥‰ΩøÂ§±Êïó‰πüË¶ÅÈö±ËóèËºâÂÖ•ÂãïÁï´
                setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºå‰ΩÜÂ∑≤Èö±ËóèËºâÂÖ•ÂãïÁï´');
                    } catch (hideError) {
                        console.error('Èö±ËóèËºâÂÖ•ÂãïÁï´Â§±Êïó:', hideError);
                    }
                }, 1000);
            }
        }

        // Êõ¥Êñ∞Êó•ÊúüÊôÇÈñìÈ°ØÁ§∫
        function updateDateTime() {
            const now = new Date();
            
            // Êõ¥Êñ∞Êó•Êúü
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', dateOptions);
            
            // Êõ¥Êñ∞ÊôÇÈñì
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW', timeOptions);
            
            // Êõ¥Êñ∞ÈÄ±Êï∏
            const weekNumber = getWeekNumber(now);
            document.getElementById('currentWeek').textContent = `${now.getFullYear()}Âπ¥Á¨¨${weekNumber}ÈÄ±`;
        }

        // Áç≤ÂèñÈÄ±Êï∏
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // LINE UserID Áõ∏ÈóúÂáΩÊï∏
        async function initLineUser() {
            console.log('ÈñãÂßãÂàùÂßãÂåñLINEÁî®Êà∂...');
            console.log('Áï∂ÂâçURL:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
            
            return new Promise((resolve) => {
                // Ê™¢Êü•ÊòØÂê¶Âú®Êú¨Âú∞Áí∞Â¢É
                const isLocal = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.hostname === '0.0.0.0' ||
                               window.location.protocol === 'file:';
                
                if (isLocal) {
                    console.log('üåê Ê™¢Ê∏¨Âà∞Êú¨Âú∞Áí∞Â¢ÉÔºåË∑≥ÈÅé LINE Ë™çË≠â');
                    addLoadingLog('üåê Êú¨Âú∞Áí∞Â¢ÉÊ®°ÂºèÔºåË∑≥ÈÅé LINE Ë™çË≠â', 'info');
                    
                    // Ë®≠ÁΩÆÊ®°Êì¨Áî®Êà∂Ë≥áÊñô
                    currentUser = {
                        userId: 'local-test-user',
                        displayName: 'Êú¨Âú∞Ê∏¨Ë©¶Áî®Êà∂',
                        pictureUrl: ''
                    };
                    
                    updateUserDisplay();
                    console.log('Êú¨Âú∞Ê®°ÂºèÁî®Êà∂È°ØÁ§∫ÂÆåÊàê');
                    resolve();
                    return;
                }
                
                // Ë®≠ÁΩÆË∂ÖÊôÇ‰øùË≠∑Ôºà3ÁßíÔºåÊ∏õÂ∞ëÁ≠âÂæÖÊôÇÈñìÔºâ
                const timeout = setTimeout(() => {
                    console.warn('LIFF ÂàùÂßãÂåñË∂ÖÊôÇÔºåÈ°ØÁ§∫Á∂ÅÂÆöÊåâÈàï');
                    addLoadingLog('‚è∞ LINE ÁôªÂÖ•Ë∂ÖÊôÇÔºåË´ãÊâãÂãïÁ∂ÅÂÆö', 'warning');
                    showBindButton();
                    resolve();
                }, 3000);
                
                // Ê™¢Êü•ÊòØÂê¶Âú®LINEÁí∞Â¢É‰∏≠
                if (typeof liff !== 'undefined') {
                    console.log('LIFF SDK Â∑≤ËºâÂÖ•');
                    
                    // ÂàùÂßãÂåñLIFF - ÈÄôË£°ÈúÄË¶ÅÊÇ®ÁöÑLIFF ID
                    liff.init({
                        liffId: '1657746214-qp0y8NwZ', // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑLIFF ID
                        withLoginOnExternalBrowser: true
                    }).then(() => {
                        console.log('LIFF ÂàùÂßãÂåñÊàêÂäü');
                        console.log('ÊòØÂê¶Âú®LINEÂÆ¢Êà∂Á´Ø:', liff.isInClient());
                        console.log('ÊòØÂê¶Â∑≤ÁôªÂÖ•:', liff.isLoggedIn());
                        
                        if (liff.isLoggedIn()) {
                            console.log('Áî®Êà∂Â∑≤ÁôªÂÖ•ÔºåÁç≤ÂèñÁî®Êà∂Ë≥áÊñô...');
                            liff.getProfile().then(async (profile) => {
                                clearTimeout(timeout);
                                console.log('Áç≤ÂèñÂà∞Áî®Êà∂Ë≥áÊñô:', profile);
                                currentUser = {
                                    userId: profile.userId,
                                    displayName: profile.displayName,
                                    pictureUrl: profile.pictureUrl
                                };
                                updateUserDisplay();
                                console.log('updateUserDisplay() Âü∑Ë°åÂÆåÊàê');
                                
                                
                                // Â∞áËá™ÂãïÊØîÂ∞çÁßªÂà∞Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàêÂæåÂü∑Ë°å
                                console.log('Ê∫ñÂÇôÂú®Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàêÂæåÂü∑Ë°åËá™ÂãïÊØîÂ∞ç');
                                
                                resolve();
                            }).catch(error => {
                                console.error('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÂ§±Êïó:', error);
                                clearTimeout(timeout);
                                showBindButton();
                                resolve();
                            });
                        } else {
                            console.log('Áî®Êà∂Êú™ÁôªÂÖ•ÔºåÈ°ØÁ§∫Á∂ÅÂÆöÊåâÈàï');
                            clearTimeout(timeout);
                            showBindButton();
                            resolve();
                        }
                    }).catch(error => {
                        console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', error);
                        clearTimeout(timeout);
                        showBindButton();
                        resolve();
                    });
                    
                } else {
                    clearTimeout(timeout);
                    console.log('LIFF SDK Êú™ËºâÂÖ•ÔºåÈ°ØÁ§∫Á∂ÅÂÆöÊåâÈàï');
                    showBindButton();
                    resolve();
                }
            });
        }

        function updateUserDisplay() {
            console.log('Êõ¥Êñ∞Áî®Êà∂È°ØÁ§∫ÔºåÁï∂ÂâçÁî®Êà∂:', currentUser);
            
            try {
                const userInfoGroup = document.getElementById('userInfoGroup');
                const userDisplayName = document.getElementById('userDisplayName');
                const userDisplayId = document.getElementById('userDisplayId');
                const bindUserBtn = document.getElementById('bindUserBtn');
                
                if (!userInfoGroup || !userDisplayName || !userDisplayId || !bindUserBtn) {
                    console.error('Êâæ‰∏çÂà∞Áî®Êà∂Ë≥áË®äÂÖÉÁ¥†');
                    return;
                }
                
                if (currentUser) {
                    console.log('È°ØÁ§∫Áî®Êà∂Ë≥áË®ä:', currentUser.displayName, currentUser.userId);
                    
                    try {
                        userDisplayName.textContent = currentUser.displayName;
                        console.log('Ë®≠ÁΩÆÁî®Êà∂ÂêçÁ®±ÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆÁî®Êà∂ÂêçÁ®±Â§±Êïó:', error);
                    }
                    
                    try {
                        userDisplayId.textContent = `ID: ${currentUser.userId}`;
                        console.log('Ë®≠ÁΩÆÁî®Êà∂IDÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆÁî®Êà∂IDÂ§±Êïó:', error);
                    }
                    
                    try {
                        userDisplayId.style.display = 'block';
                        console.log('Ë®≠ÁΩÆIDÈ°ØÁ§∫ÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆIDÈ°ØÁ§∫Â§±Êïó:', error);
                    }
                    
                    try {
                        bindUserBtn.textContent = 'ÈáçÊñ∞Á∂ÅÂÆö';
                        console.log('Ë®≠ÁΩÆÊåâÈàïÊñáÂ≠óÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆÊåâÈàïÊñáÂ≠óÂ§±Êïó:', error);
                    }
                    
                    try {
                        userInfoGroup.style.display = 'block';
                        console.log('Ë®≠ÁΩÆÁî®Êà∂Ë≥áË®äÁµÑÈ°ØÁ§∫ÂÆåÊàê');
                    } catch (error) {
                        console.error('Ë®≠ÁΩÆÁî®Êà∂Ë≥áË®äÁµÑÈ°ØÁ§∫Â§±Êïó:', error);
                    }
                } else {
                    console.log('È°ØÁ§∫Êú™Á∂ÅÂÆöÁãÄÊÖã');
                    userDisplayName.textContent = 'Êú™Á∂ÅÂÆö';
                    userDisplayId.style.display = 'none';
                    bindUserBtn.textContent = 'Á∂ÅÂÆöÂ∏≥Ëôü';
                    userInfoGroup.style.display = 'block';
                }
                console.log('updateUserDisplay ÂáΩÊï∏Âü∑Ë°åÂÆåÊàê');
            } catch (error) {
                console.error('updateUserDisplay ÂáΩÊï∏Âü∑Ë°åÈåØË™§:', error);
            }
        }

        function showBindButton() {
            updateUserDisplay();
        }

        async function bindUser() {
            console.log('Áî®Êà∂ÈªûÊìäÁ∂ÅÂÆöÊåâÈàï');
            
            if (typeof liff !== 'undefined') {
                try {
                    if (liff.isLoggedIn()) {
                        console.log('Áî®Êà∂Â∑≤ÁôªÂÖ•ÔºåÁç≤ÂèñÁî®Êà∂Ë≥áÊñô');
                        liff.getProfile().then(async (profile) => {
                            console.log('Áç≤ÂèñÂà∞Áî®Êà∂Ë≥áÊñô:', profile);
                            currentUser = {
                                userId: profile.userId,
                                displayName: profile.displayName,
                                pictureUrl: profile.pictureUrl
                            };
                            updateUserDisplay();
                            
                            // Ëá™ÂãïÊØîÂ∞çË¨õÂ∏´
                            console.log('Ê∫ñÂÇôÂü∑Ë°åËá™ÂãïÊØîÂ∞çË¨õÂ∏´...');
                            await autoMatchTeacher(profile.userId, profile.displayName);
                        }).catch(error => {
                            console.error('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÂ§±Êïó:', error);
                            alert('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÂ§±ÊïóÔºåË´ãÈáçË©¶');
                        });
                    } else {
                        console.log('Áî®Êà∂Êú™ÁôªÂÖ•ÔºåÂòóË©¶ÁôªÂÖ•');
                        // ÈÄôÊúÉËß∏ÁôºLINEÁöÑÊéàÊ¨äÊµÅÁ®ã
                        liff.login().catch(error => {
                            console.error('ÁôªÂÖ•Â§±Êïó:', error);
                            alert('ÁôªÂÖ•Â§±ÊïóÔºåË´ãÈáçË©¶');
                        });
                    }
                } catch (error) {
                    console.error('LIFF Êìç‰ΩúÁï∞Â∏∏:', error);
                    alert('Á∂ÅÂÆöÂ§±ÊïóÔºåË´ãÈáçË©¶');
                }
            } else {
                console.log('LIFF SDK Êú™ËºâÂÖ•');
                alert('Ë´ãÂú®LINEÊáâÁî®Á®ãÂºè‰∏≠ÈñãÂïüÊ≠§È†ÅÈù¢');
            }
        }

        // Ëá™ÂãïÊØîÂ∞çË¨õÂ∏´
        async function autoMatchTeacher(userId, displayName) {
            console.log('ÈñãÂßãËá™ÂãïÊØîÂ∞çË¨õÂ∏´...', { userId, displayName });
            console.log('ÂáΩÊï∏Ë¢´Ë™øÁî®ÔºåÂèÉÊï∏:', { userId, displayName });
            
            // Âú®È†ÅÈù¢‰∏äÈ°ØÁ§∫ÊØîÂ∞çÈÅéÁ®ã
            showMatchingProcess('ÈñãÂßãÊØîÂ∞çË¨õÂ∏´...', 'info');
            addLoadingLog('üîç ÈñãÂßãË¨õÂ∏´Ë∫´‰ªΩÊØîÂ∞ç...', 'info');
            
            // Áç≤ÂèñË¨õÂ∏´ÈÅ∏ÊìáÂÖÉÁ¥†
            const instructorSelect = document.getElementById('instructorSelect');
            
            return new Promise(async (resolve) => {
            
            try {
                console.log('Ê∫ñÂÇôË™øÁî®Ë¨õÂ∏´ API...');
                showMatchingProcess('Ê≠£Âú®Ë™øÁî®Ë¨õÂ∏´ API...', 'info');
                addLoadingLog('üåê Ê≠£Âú®ÈÄ£Êé•Ë¨õÂ∏´Ë≥áÊñôÂ∫´...', 'info');
                
                // Ë®≠ÁΩÆ API Ë™øÁî®Ë∂ÖÊôÇÔºà10ÁßíÔºâ
                const apiTimeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('API Ë™øÁî®Ë∂ÖÊôÇ')), 10000);
                });
                
                // Êö´ÊôÇ‰ΩøÁî®ÁèæÊúâÁöÑË¨õÂ∏´ APIÔºàÈÅøÂÖç 404 ÂïèÈ°åÔºâ
                const apiCall = fetch('/api/teachers', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    redirect: 'follow'  // Ëá™ÂãïË∑üÈö®ÈáçÂÆöÂêë
                });
                
                const response = await Promise.race([apiCall, apiTimeout]);
                
                console.log('APIÂõûÊáâÁãÄÊÖã:', response.status);
                console.log('APIÂõûÊáâOK:', response.ok);
                showMatchingProcess(`APIÂõûÊáâÁãÄÊÖã: ${response.status}`, response.ok ? 'success' : 'error');
                addLoadingLog(`üì° API ÂõûÊáâ: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`APIË´ãÊ±ÇÂ§±Êïó: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('APIÂõûÊáâ:', data);
                showMatchingProcess('APIÂõûÊáâÊàêÂäüÔºåÈñãÂßãÊØîÂ∞çË¨õÂ∏´...', 'success');
                addLoadingLog('‚úÖ Ë¨õÂ∏´Ë≥áÊñôËºâÂÖ•ÊàêÂäü', 'success');
                
                // ËôïÁêÜ /api/teachers ÁöÑÂõûÊáâÊ†ºÂºè
                if (data.success && data.teachers && Array.isArray(data.teachers)) {
                    showMatchingProcess(`ÊâæÂà∞ ${data.teachers.length} ÂÄãË¨õÂ∏´ÔºåÈñãÂßãÊØîÂ∞ç...`, 'info');
                    addLoadingLog(`üë• ÊâæÂà∞ ${data.teachers.length} ÂÄãË¨õÂ∏´ÔºåÈñãÂßãÊØîÂ∞ç...`, 'info');
                    
                    // È°ØÁ§∫ÊØîÂ∞çÈÅéÁ®ã
                    showMatchingProcess(`ÊØîÂ∞çÊ¢ù‰ª∂: UserID=${userId}, DisplayName=${displayName}`, 'info');
                    addLoadingLog(`üîç ÊØîÂ∞çÊ¢ù‰ª∂: ${displayName} (${userId})`, 'info');
                    
                    // Â∞ãÊâæÂåπÈÖçÁöÑË¨õÂ∏´
                    addLoadingLog('üîç ÈñãÂßãÈÄê‰∏ÄÊØîÂ∞çË¨õÂ∏´...', 'info');
                    const matchedTeacher = data.teachers.find((teacher, index) => {
                        addLoadingLog(`üìù ÊØîÂ∞çÁ¨¨ ${index + 1} ‰ΩçË¨õÂ∏´: ${teacher.name}`, 'info');
                        
                        // Á≤æÁ¢∫ÊØîÂ∞çuserIdÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                        if (teacher.userId && userId && teacher.userId.toLowerCase() === userId.toLowerCase()) {
                            showMatchingProcess(`‚úÖ Á≤æÁ¢∫ÂåπÈÖçUserID: ${teacher.userId}`, 'success');
                            addLoadingLog(`üéØ Á≤æÁ¢∫ÂåπÈÖç UserID: ${teacher.userId}`, 'success');
                            return true;
                        }
                        // Ê®°Á≥äÊØîÂ∞çnameËàádisplayNameÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                        if (teacher.name && displayName) {
                            const teacherName = teacher.name.toLowerCase().trim();
                            const userName = displayName.toLowerCase().trim();
                            
                            // ÂÆåÂÖ®ÂåπÈÖçÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                            if (teacherName === userName) {
                                showMatchingProcess(`‚úÖ ÂÆåÂÖ®ÂåπÈÖçÂêçÁ®±: ${teacher.name}`, 'success');
                                addLoadingLog(`üéØ ÂÆåÂÖ®ÂåπÈÖçÂêçÁ®±: ${teacher.name}`, 'success');
                                return true;
                            }
                            
                            // ÂåÖÂê´ÂåπÈÖçÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                            if (teacherName.includes(userName) || userName.includes(teacherName)) {
                                showMatchingProcess(`‚úÖ ÂåÖÂê´ÂåπÈÖç: ${teacher.name}`, 'success');
                                addLoadingLog(`üéØ ÂåÖÂê´ÂåπÈÖç: ${teacher.name}`, 'success');
                                return true;
                            }
                            
                            // ÈÉ®ÂàÜÂåπÈÖçÔºàËá≥Â∞ë3ÂÄãÂ≠óÁ¨¶Ôºå‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                            if (teacherName.length >= 3 && userName.length >= 3) {
                                const commonChars = [...teacherName].filter(char => userName.includes(char)).length;
                                const similarity = commonChars / Math.max(teacherName.length, userName.length);
                                if (similarity >= 0.6) { // 60%Áõ∏‰ººÂ∫¶
                                    showMatchingProcess(`‚úÖ Áõ∏‰ººÂ∫¶ÂåπÈÖç: ${teacher.name} (${Math.round(similarity * 100)}%)`, 'success');
                                    addLoadingLog(`üéØ Áõ∏‰ººÂ∫¶ÂåπÈÖç: ${teacher.name} (${Math.round(similarity * 100)}%)`, 'success');
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                    
                    if (matchedTeacher) {
                        console.log('ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´:', matchedTeacher);
                        showMatchingProcess(`üéâ ÊâæÂà∞ÂåπÈÖçË¨õÂ∏´: ${matchedTeacher.name}`, 'success');
                        
                        // Ëá™ÂãïÈÅ∏ÊìáË¨õÂ∏´
                        if (instructorSelect) {
                            // Ê®°Á≥äÊØîÂ∞çË¨õÂ∏´ÈÅ∏È†Ö
                            const matchedOption = findBestMatchingOption(instructorSelect, matchedTeacher.name);
                            
                            if (matchedOption) {
                                instructorSelect.value = matchedOption.value;
                                console.log('Ëá™ÂãïÈÅ∏ÊìáË¨õÂ∏´:', matchedOption.value);
                                
                                // Á´ãÂç≥Êõ¥Êñ∞Áµ±Ë®àÂíåÊ∏≤ÊüìË™≤Á®ãÔºàÂú®Ë∑≥ËΩâÂâçÔºâ
                                updateStats();
                                renderEvents();
                                
                                // Ë∑≥ËΩâÂà∞Á¨¨‰∫åÊ≠•È©ü
                                showStep(2);
                                
                                showMatchingProcess(`‚úÖ Ëá™ÂãïÈÅ∏ÊìáË¨õÂ∏´ÊàêÂäü: ${matchedOption.value}`, 'success');
                                addLoadingLog(`üéØ Ëá™ÂãïÈÅ∏ÊìáË¨õÂ∏´: ${matchedOption.value}`, 'success');
                                
                                // ÊØîÂ∞çÊàêÂäüÔºåÈ°ØÁ§∫ÂÄã‰∫∫Ë°å‰∫ãÊõÜ
                                console.log('ÊØîÂ∞çÊàêÂäüÔºåÂ∞áÈ°ØÁ§∫ÂÄã‰∫∫Ë°å‰∫ãÊõÜ');
                                resolve();
                                return;
                            }
                        }
                        
                        console.log('Êú™ÊâæÂà∞Â∞çÊáâÁöÑË¨õÂ∏´ÈÅ∏È†Ö');
                        showMatchingProcess(`‚ö†Ô∏è ÊâæÂà∞ÂåπÈÖçË¨õÂ∏´‰ΩÜÊú™Âú®ÂàóË°®‰∏≠: ${matchedTeacher.name}`, 'warning');
                        addLoadingLog(`‚ö†Ô∏è ÊâæÂà∞ÂåπÈÖçË¨õÂ∏´‰ΩÜÊú™Âú®ÂàóË°®‰∏≠: ${matchedTeacher.name}`, 'warning');
                        
                        // ÊØîÂ∞çÂ§±ÊïóÔºåÈ°ØÁ§∫ÂÖ®ÈÉ®Ë¨õÂ∏´
                        console.log('ÊØîÂ∞çÂ§±ÊïóÔºåÂ∞áÈ°ØÁ§∫ÂÖ®ÈÉ®Ë¨õÂ∏´');
                        if (instructorSelect) {
                        instructorSelect.value = ''; // ÈÅ∏ÊìáÂÖ®ÈÉ®Ë¨õÂ∏´
                            // Á´ãÂç≥Êõ¥Êñ∞Áµ±Ë®àÂíåÊ∏≤ÊüìË™≤Á®ã
                            updateStats();
                            renderEvents();
                        }
                    } else {
                        console.log('Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´');
                        showMatchingProcess('‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´ÔºåË´ãÊâãÂãïÈÅ∏Êìá', 'error');
                        addLoadingLog('‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´ÔºåË´ãÊâãÂãïÈÅ∏Êìá', 'error');
                        
                        // ÊØîÂ∞çÂ§±ÊïóÔºåÈ°ØÁ§∫ÂÖ®ÈÉ®Ë¨õÂ∏´
                        console.log('ÊØîÂ∞çÂ§±ÊïóÔºåÂ∞áÈ°ØÁ§∫ÂÖ®ÈÉ®Ë¨õÂ∏´');
                        if (instructorSelect) {
                        instructorSelect.value = ''; // ÈÅ∏ÊìáÂÖ®ÈÉ®Ë¨õÂ∏´
                            // Á´ãÂç≥Êõ¥Êñ∞Áµ±Ë®àÂíåÊ∏≤ÊüìË™≤Á®ã
                            updateStats();
                            renderEvents();
                        }
                    }
                } else {
                    console.error('APIÂõûÊáâÊ†ºÂºèÈåØË™§:', data);
                    showMatchingProcess('‚ùå APIÂõûÊáâÊ†ºÂºèÈåØË™§', 'error');
                }
            } catch (error) {
                console.error('Ëá™ÂãïÊØîÂ∞çË¨õÂ∏´Â§±Êïó:', error);
                showMatchingProcess(`‚ùå Ëá™ÂãïÊØîÂ∞çÂ§±Êïó: ${error.message}`, 'error');
                
                if (error.message.includes('Ë∂ÖÊôÇ')) {
                    addLoadingLog('‚è∞ API Ë™øÁî®Ë∂ÖÊôÇÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Êé•', 'error');
                } else if (error.message.includes('404')) {
                    addLoadingLog('‚ùå Ë¨õÂ∏´ API ‰∏çÂ≠òÂú®ÔºåË´ãËÅØÁπ´ÁÆ°ÁêÜÂì°', 'error');
                } else {
                    addLoadingLog(`‚ùå ÊØîÂ∞çÂ§±Êïó: ${error.message}`, 'error');
                }
            } finally {
                // ÁÑ°Ë´ñÊØîÂ∞çÊàêÂäüËàáÂê¶ÔºåÈÉΩËß£Êûê Promise
                addLoadingLog('üèÅ Ë¨õÂ∏´ÊØîÂ∞çÊµÅÁ®ãÁµêÊùü', 'info');
                resolve();
            }
            });
        }

        // È°ØÁ§∫ÊØîÂ∞çÈÅéÁ®ã
        function showMatchingProcess(message, type = 'info') {
            console.log(`[ÊØîÂ∞çÈÅéÁ®ã] ${message}`);
        }

        // Ëá™ÂãïÊªëÂãïÂà∞Ë°å‰∫ãÊõÜÂçÄÂüüÔºàÊâÄÊúâË£ùÁΩÆÔºâ
        function autoScrollToCalendar() {
                // Âª∂ÈÅ≤‰∏ÄÈªûÊôÇÈñìÁ¢∫‰øùÈ†ÅÈù¢ÂÆåÂÖ®ËºâÂÖ•
                setTimeout(() => {
                // ÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆì‰ªäÊó•Êú¨ÈÄ±ÊØèÊúàÊåâÈàïÂàáÈΩäÈ†ÇÈÉ®
                    const viewButtons = document.querySelector('.view-buttons');
                
                    if (viewButtons) {
                    // Ë®àÁÆóË¶ñÂúñÊåâÈàïÁöÑ‰ΩçÁΩÆÔºåËÆìÊåâÈàïÈΩäÂπ≥È†ÇÈÉ®
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // ÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆìÊåâÈàïÈΩäÂπ≥È†ÇÈÉ®
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`Â∑≤Ëá™ÂãïÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆì‰ªäÊó•Êú¨ÈÄ±ÊØèÊúàÊåâÈàïÂàáÈΩäÈ†ÇÈÉ®`);
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Ë¶ñÂúñÊåâÈàïÔºåÂâáÊªëÂãïÂà∞‰∏ªÂÖßÂÆπÂçÄÂüü
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`Â∑≤Ëá™ÂãïÊªëÂãïÂà∞‰∏ªÂÖßÂÆπÂçÄÂüüÔºåÁØ©ÈÅ∏ÂçÄÂ°äÈ´òÂ∫¶: ${controlHeight}px`);
                    }
                    }
                }, 1000);
            }

        // Ëá™ÂãïÊªæÂãïÂà∞Ë¶ñÂúñÊåâÈàïÔºàÈÄöÁî®ÂáΩÊï∏Ôºâ
        function autoScrollToViewButtons() {
            console.log('üîÑ ÈñãÂßãËá™ÂãïÊªæÂãïÂà∞Ë¶ñÂúñÊåâÈàï');
            
            // ‰ΩøÁî®ËàáÁ¨¨‰∏ÄÊ¨°ËºâÂÖ•ÊôÇÁõ∏ÂêåÁöÑÊªëÂãïÈÇèËºØ
            setTimeout(() => {
                // ÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆì‰ªäÊó•Êú¨ÈÄ±ÊØèÊúàÊåâÈàïÂàáÈΩäÈ†ÇÈÉ®
                const viewButtons = document.querySelector('.view-buttons');
                
                if (viewButtons) {
                    // Ë®àÁÆóË¶ñÂúñÊåâÈàïÁöÑ‰ΩçÁΩÆÔºåËÆìÊåâÈàïÈΩäÂπ≥È†ÇÈÉ®
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // ÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆìÊåâÈàïÈΩäÂπ≥È†ÇÈÉ®
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`Â∑≤Ëá™ÂãïÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆì‰ªäÊó•Êú¨ÈÄ±ÊØèÊúàÊåâÈàïÂàáÈΩäÈ†ÇÈÉ®`);
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Ë¶ñÂúñÊåâÈàïÔºåÂâáÊªëÂãïÂà∞‰∏ªÂÖßÂÆπÂçÄÂüü
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`Â∑≤Ëá™ÂãïÊªëÂãïÂà∞‰∏ªÂÖßÂÆπÂçÄÂüüÔºåÁØ©ÈÅ∏ÂçÄÂ°äÈ´òÂ∫¶: ${controlHeight}px`);
                    }
                }
            }, 100);
        }

        // Ê®°Á≥äÊØîÂ∞çË¨õÂ∏´ÈÅ∏È†Ö
        function findBestMatchingOption(selectElement, targetName) {
            if (!selectElement || !targetName) return null;
            
            const options = Array.from(selectElement.options);
            const target = targetName.toLowerCase().trim();
            
            console.log(`ÈñãÂßãÊ®°Á≥äÊØîÂ∞çË¨õÂ∏´ÈÅ∏È†ÖÔºåÁõÆÊ®ôÂêçÁ®±: "${targetName}"`);
            
            // 1. Á≤æÁ¢∫ÂåπÈÖç
            for (let option of options) {
                if (option.value.toLowerCase().trim() === target) {
                    console.log(`‚úÖ Á≤æÁ¢∫ÂåπÈÖç: ${option.value}`);
                    return option;
                }
            }
            
            // 2. ÂåÖÂê´ÂåπÈÖç
            for (let option of options) {
                const optionValue = option.value.toLowerCase().trim();
                if (optionValue.includes(target) || target.includes(optionValue)) {
                    console.log(`‚úÖ ÂåÖÂê´ÂåπÈÖç: ${option.value}`);
                    return option;
                }
            }
            
            // 3. Áõ∏‰ººÂ∫¶ÂåπÈÖç
            let bestMatch = null;
            let bestSimilarity = 0;
            
            for (let option of options) {
                const optionValue = option.value.toLowerCase().trim();
                const similarity = calculateSimilarity(target, optionValue);
                
                console.log(`ÊØîÂ∞ç "${option.value}": Áõ∏‰ººÂ∫¶ ${Math.round(similarity * 100)}%`);
                
                if (similarity > bestSimilarity && similarity >= 0.5) { // 50% Áõ∏‰ººÂ∫¶ÈñæÂÄº
                    bestMatch = option;
                    bestSimilarity = similarity;
                }
            }
            
            if (bestMatch) {
                console.log(`‚úÖ Áõ∏‰ººÂ∫¶ÂåπÈÖç: ${bestMatch.value} (${Math.round(bestSimilarity * 100)}%)`);
                return bestMatch;
            }
            
            console.log('‚ùå Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´ÈÅ∏È†Ö');
            return null;
        }

        // Ë®àÁÆóÂ≠ó‰∏≤Áõ∏‰ººÂ∫¶
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            if (str1.length === 0 || str2.length === 0) return 0;
            
            // ‰ΩøÁî® Levenshtein Ë∑ùÈõ¢Ë®àÁÆóÁõ∏‰ººÂ∫¶
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;
            
            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            const maxLen = Math.max(len1, len2);
            return (maxLen - matrix[len2][len1]) / maxLen;
        }


        // Á∂ÅÂÆöÈáçÊñ∞Êï¥ÁêÜÊåâÈàïË™≤Á®ã
        function bindRefreshButton() {
            const refreshButton = document.getElementById('refreshButton');
            if (refreshButton) {
                // ÁßªÈô§ËàäÁöÑË™≤Á®ãÁõ£ËÅΩÂô®
                refreshButton.removeEventListener('click', handleRefreshClick);
                // Ê∑ªÂä†Êñ∞ÁöÑË™≤Á®ãÁõ£ËÅΩÂô®
                refreshButton.addEventListener('click', handleRefreshClick);
                console.log('‚úÖ ÈáçÊñ∞Êï¥ÁêÜÊåâÈàïË™≤Á®ãÂ∑≤Á∂ÅÂÆö');
            } else {
                console.warn('‚ö†Ô∏è ÈáçÊñ∞Êï¥ÁêÜÊåâÈàïÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }
        }

        // Á∂ÅÂÆöÁ∞ΩÂà∞Á≥ªÁµ±ÈÅ∏ÂñÆË™≤Á®ã
        function bindAttendanceMenu() {
            const attendanceMenu = document.getElementById('attendanceMenu');
            if (attendanceMenu) {
                // ÁßªÈô§ËàäÁöÑË™≤Á®ãÁõ£ËÅΩÂô®
                attendanceMenu.removeEventListener('click', handleAttendanceMenuClick);
                // Ê∑ªÂä†Êñ∞ÁöÑË™≤Á®ãÁõ£ËÅΩÂô®
                attendanceMenu.addEventListener('click', handleAttendanceMenuClick);
                console.log('‚úÖ Á∞ΩÂà∞Á≥ªÁµ±ÈÅ∏ÂñÆË™≤Á®ãÂ∑≤Á∂ÅÂÆö');
            } else {
                console.warn('‚ö†Ô∏è Á∞ΩÂà∞Á≥ªÁµ±ÈÅ∏ÂñÆÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }
        }

        // ËôïÁêÜÁ∞ΩÂà∞Á≥ªÁµ±ÈÅ∏ÂñÆÈªûÊìä
        function handleAttendanceMenuClick(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('üìã Á∞ΩÂà∞Á≥ªÁµ±ÈÅ∏ÂñÆË¢´ÈªûÊìä');
            
            // Ë∑≥ËΩâÂà∞Á∞ΩÂà∞Á≥ªÁµ±
            const attendanceUrl = 'https://liff.line.me/1657746214-wPgd2qQn';
            
            try {
                // Ê™¢Êü• LIFF ÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    // Âú® LINE ÂÖß‰ΩøÁî® LIFF ÈñãÂïü
                    liff.openWindow({
                        url: attendanceUrl,
                        external: false
                    });
                    console.log('‚úÖ ‰ΩøÁî® LIFF Âú® LINE ÂÖßÈñãÂïüÁ∞ΩÂà∞Á≥ªÁµ±');
                } else {
                    // Â¶ÇÊûú‰∏çÂú® LINE ÂÖßÊàñ LIFF Êú™ÂàùÂßãÂåñÔºå‰ΩøÁî®‰∏ÄËà¨ÊñπÂºèÈñãÂïü
                    window.open(attendanceUrl, '_blank', 'noopener,noreferrer');
                    console.log('‚úÖ ‰ΩøÁî®‰∏ÄËà¨ÊñπÂºèÈñãÂïüÁ∞ΩÂà∞Á≥ªÁµ±');
                }
            } catch (error) {
                console.error('‚ùå ÈñãÂïüÁ∞ΩÂà∞Á≥ªÁµ±Â§±Êïó:', error);
                // ÈôçÁ¥öËôïÁêÜÔºö‰ΩøÁî®‰∏ÄËà¨ÊñπÂºèÈñãÂïü
                window.open(attendanceUrl, '_blank', 'noopener,noreferrer');
            }
            
            // Ê∑ªÂä†ÈªûÊìäÂãïÁï´ÊïàÊûú
            const button = event.currentTarget.querySelector('.attendance-menu-button');
            if (button) {
                button.style.transform = 'translateY(-1px) scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 150);
            }
        }

        // ÈáçÊñ∞Êï¥ÁêÜÊåâÈàïÈªûÊìäËôïÁêÜÂáΩÊï∏
        function handleRefreshClick(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('üîÑ ÈáçÊñ∞Êï¥ÁêÜÊåâÈàïË¢´ÈªûÊìä');
            forceRefresh();
        }


        // Ë®àÁÆóÊØè‰ΩçË¨õÂ∏´ÁöÑ‰∏ã‰∏ÄÂÄãÂç≥Â∞áÂà∞‰æÜÁöÑË™≤Á®ã
        function getUpcomingEventsByInstructor() {
            const now = new Date();
            const upcomingEvents = {};
            
            // Áç≤ÂèñÊâÄÊúâÊúâÊïàÁöÑÊú™‰æÜË™≤Á®ã
            const futureEvents = allEvents.filter(event => {
                if (!event || !event.start || !event.instructor) return false;
                const eventDate = new Date(event.start);
                return eventDate > now; // Âè™ËÄÉÊÖÆÊú™‰æÜÁöÑË™≤Á®ã
            });
            
            // ÊåâË¨õÂ∏´ÂàÜÁµÑ‰∏¶ÊâæÂà∞ÊØèÂÄãË¨õÂ∏´ÁöÑ‰∏ã‰∏ÄÂÄãË™≤Á®ã
            futureEvents.forEach(event => {
                const instructor = event.instructor;
                if (!upcomingEvents[instructor]) {
                    upcomingEvents[instructor] = event;
                } else {
                    // ÊØîËºÉÊôÇÈñìÔºå‰øùÁïôÊõ¥Êó©ÁöÑË™≤Á®ã
                    const currentUpcoming = new Date(upcomingEvents[instructor].start);
                    const newEvent = new Date(event.start);
                    if (newEvent < currentUpcoming) {
                        upcomingEvents[instructor] = event;
                    }
                }
            });
            
            console.log('üìÖ ÊØè‰ΩçË¨õÂ∏´ÁöÑ‰∏ã‰∏ÄÂÄãË™≤Á®ã:', upcomingEvents);
            return upcomingEvents;
        }

        // Ê™¢Êü•Ë™≤Á®ãÊòØÂê¶ÁÇ∫Âç≥Â∞áÂà∞‰æÜÁöÑË™≤Á®ã
        function isUpcomingEvent(event) {
            if (!event || !event.start || !event.instructor) return false;
            
            const upcomingEvents = getUpcomingEventsByInstructor();
            const instructor = event.instructor;
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë©≤Ë¨õÂ∏´ÁöÑ‰∏ã‰∏ÄÂÄãË™≤Á®ã
            if (upcomingEvents[instructor] && upcomingEvents[instructor].id === event.id) {
                return true;
            }
            
            return false;
        }

        // Ë®àÁÆóË∑ùÈõ¢Ë™≤Á®ãÈñãÂßãÁöÑÊôÇÈñì
        function getTimeUntilEvent(event) {
            if (!event || !event.start) return null;
            
            const now = new Date();
            const eventDate = new Date(event.start);
            const timeDiff = eventDate - now;
            
            if (timeDiff <= 0) return null; // Ë™≤Á®ãÂ∑≤ÈñãÂßãÊàñÁµêÊùü
            
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days}Â§©${hours}Â∞èÊôÇ`;
            } else if (hours > 0) {
                return `${hours}Â∞èÊôÇ${minutes}ÂàÜÈêò`;
            } else {
                return `${minutes}ÂàÜÈêò`;
            }
        }

        // Âº∑Âà∂ÈáçÊñ∞Êï¥ÁêÜË°å‰∫ãÊõÜ
        async function forceRefresh() {
            const refreshButton = document.getElementById('refreshButton');
            const icon = refreshButton.querySelector('i');
            
            // Ê∑ªÂä†ËºâÂÖ•ÂãïÁï´
            refreshButton.classList.add('loading');
            icon.style.animation = 'spin 1s linear infinite';
            
            try {
                console.log('üîÑ ÈñãÂßãÂº∑Âà∂ÈáçÊñ∞Êï¥ÁêÜË°å‰∫ãÊõÜ...');
                
                // È°ØÁ§∫ËºâÂÖ•ÂãïÁï´
                showLoadingAnimation();
                
                // ÈáçÊñ∞ËºâÂÖ•Ë™≤Á®ãÊï∏Êìö
                await loadTodayEvents();
                
                // ÈáçÊñ∞Á∂ÅÂÆöÊâÄÊúâË™≤Á®ãÁõ£ËÅΩÂô®
                bindViewButtons();
                updateViewButtonStates();
                
                // Êõ¥Êñ∞Áµ±Ë®àÂíåÊ∏≤Êüì
                updateStats();
                renderEvents();
                
                // Ëá™ÂãïÊªæÂãïÂà∞Ë°å‰∫ãÊõÜÂçÄÂüü
                autoScrollToCalendar();
                
                console.log('‚úÖ Ë°å‰∫ãÊõÜÈáçÊñ∞Êï¥ÁêÜÂÆåÊàê');
                
                // È°ØÁ§∫ÊàêÂäüÊèêÁ§∫
                addLoadingLog('‚úÖ Ë°å‰∫ãÊõÜÂ∑≤ÈáçÊñ∞Êï¥ÁêÜ', 'success');
                
            } catch (error) {
                console.error('‚ùå ÈáçÊñ∞Êï¥ÁêÜÂ§±Êïó:', error);
                addLoadingLog('‚ùå ÈáçÊñ∞Êï¥ÁêÜÂ§±Êïó: ' + error.message, 'error');
            } finally {
                // ÁßªÈô§ËºâÂÖ•ÂãïÁï´
                refreshButton.classList.remove('loading');
                icon.style.animation = '';
                
                // Èö±ËóèËºâÂÖ•ÂãïÁï´
                setTimeout(() => {
                    hideLoadingAnimation();
                }, 500);
            }
        }

        // È°ØÁ§∫ÊåáÂÆöÊ≠•È©ü
        function showStep(stepNumber) {
            console.log('Ë∑≥ËΩâÂà∞Ê≠•È©ü:', stepNumber);
            
            // Êõ¥Êñ∞Ê≠•È©üÁãÄÊÖã
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed', 'pending');
                
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
            
            // Ê†πÊìöÊ≠•È©üÈ°ØÁ§∫/Èö±ËóèÁõ∏ÈóúÂÖßÂÆπ
            if (stepNumber === 2) {
                // Á¨¨‰∫åÊ≠•ÔºöÊü•ÁúãË°å‰∫ãÊõÜ - Á¢∫‰øùË°å‰∫ãÊõÜÂçÄÂüüÂèØË¶ã
                const calendarSection = document.querySelector('.calendar-section');
                if (calendarSection) {
                    calendarSection.style.display = 'block';
                }
                
                // Ëá™ÂãïÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆì‰ªäÊó•Êú¨ÈÄ±ÊØèÊúàÊåâÈàïÂàáÈΩäÈ†ÇÈÉ®
                const viewButtons = document.querySelector('.view-buttons');
                if (viewButtons) {
                    // Ë®àÁÆóË¶ñÂúñÊåâÈàïÁöÑ‰ΩçÁΩÆÔºåËÆìÊåâÈàïÈΩäÂπ≥È†ÇÈÉ®
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // ÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆìÊåâÈàïÈΩäÂπ≥È†ÇÈÉ®
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`Â∑≤Ëá™ÂãïÊªëÂãïÂà∞Ë¶ñÂúñÊåâÈàïÂçÄÂüüÔºåËÆì‰ªäÊó•Êú¨ÈÄ±ÊØèÊúàÊåâÈàïÂàáÈΩäÈ†ÇÈÉ®`);
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Ë¶ñÂúñÊåâÈàïÔºåÂâáÊªëÂãïÂà∞‰∏ªÂÖßÂÆπÂçÄÂüü
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`Â∑≤Ëá™ÂãïÊªëÂãïÂà∞‰∏ªÂÖßÂÆπÂçÄÂüüÔºåÁØ©ÈÅ∏ÂçÄÂ°äÈ´òÂ∫¶: ${controlHeight}px`);
                    }
                }
            }
        }


        // È´ò‰∫ÆË¶ñÂúñÊåâÈàï
        function highlightViewButton(viewName) {
            // ÁßªÈô§ÊâÄÊúâÊåâÈàïÁöÑ active ÁãÄÊÖã
            const allButtons = document.querySelectorAll('.view-buttons .btn');
            allButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '';
                btn.style.transition = 'all 0.3s ease';
            });
            
            // Ê∑ªÂä†ÁõÆÊ®ôÊåâÈàïÁöÑ active ÁãÄÊÖã
            const targetButton = document.querySelector(`[data-view="${viewName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
                
                // Ê∑ªÂä†È´ò‰∫ÆÂãïÁï´ - Êõ¥ÊòéÈ°ØÁöÑÊïàÊûú
                targetButton.style.transform = 'scale(1.1)';
                targetButton.style.boxShadow = '0 6px 12px rgba(0, 123, 255, 0.4)';
                targetButton.style.transition = 'all 0.3s ease';
                targetButton.style.zIndex = '10';
                
                // Ê∑ªÂä†ËÑàË°ùÂãïÁï´
                targetButton.style.animation = 'buttonPulse 0.6s ease-out';
                
                setTimeout(() => {
                    targetButton.style.transform = 'scale(1.05)';
                    targetButton.style.boxShadow = '0 4px 8px rgba(0, 123, 255, 0.3)';
                    targetButton.style.animation = '';
                }, 300);
            }
        }

        // ÊªëÂãïÂäüËÉΩÂ∑≤ÁßªÈô§ - ÈÅøÂÖçËàáÊåâÈàïÈªûÊìäË°ùÁ™Å

        // Ë®≠ÁΩÆË™≤Á®ãÁõ£ËÅΩÂô®
        function setupEventListeners() {
            // ÊªëÂãïÂäüËÉΩÂ∑≤ÁßªÈô§
            
            // Ë¨õÂ∏´ÁØ©ÈÅ∏Ë™≤Á®ãÁõ£ËÅΩÂô®
            const instructorSelect = document.getElementById('instructorSelect');
            if (instructorSelect) {
                instructorSelect.addEventListener('change', function() {
                    const selectedInstructor = this.value;
                    console.log('üì± Ë¨õÂ∏´ÈÅ∏ÊìáËÆäÊõ¥:', selectedInstructor);
                    
                    if (selectedInstructor) {
                        // Êô∫ÊÖßÂà§Êñ∑ÔºöÊ™¢Êü•Ë¨õÂ∏´Âú®‰∏çÂêåË¶ñÂúñ‰∏ãÁöÑË™≤Á®ãÊï∏Èáè
                        const instructorEvents = allEvents.filter(event => 
                            event && event.instructor === selectedInstructor
                        );
                        
                        if (instructorEvents.length === 0) {
                            console.log('‚ö†Ô∏è Ë©≤Ë¨õÂ∏´Ê≤íÊúâ‰ªª‰ΩïË™≤Á®ã');
                            currentView = 'ÂÖ®ÈÉ®';
                            window.currentView = 'ÂÖ®ÈÉ®';
                        } else {
                            // Ê™¢Êü•‰ªäÊó•ÊòØÂê¶ÊúâË™≤Á®ã
                            const now = new Date();
                            const todayEvents = instructorEvents.filter(event => {
                                const eventDate = new Date(event.start);
                                return eventDate.getFullYear() === now.getFullYear() &&
                                       eventDate.getMonth() === now.getMonth() &&
                                       eventDate.getDate() === now.getDate();
                            });
                            
                            if (todayEvents.length > 0) {
                                console.log('‚úÖ Ë¨õÂ∏´‰ªäÊó•ÊúâË™≤Á®ãÔºå‰øùÊåÅ‰ªäÊó•Ë¶ñÂúñ');
                                currentView = '‰ªäÊó•';
                                window.currentView = '‰ªäÊó•';
                            } else {
                                // Ê™¢Êü•Êú¨ÈÄ±ÊòØÂê¶ÊúâË™≤Á®ã
                                const weekStart = new Date(now);
                                const dayOfWeek = now.getDay();
                                const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                                weekStart.setDate(now.getDate() + daysToMonday);
                                weekStart.setHours(0, 0, 0, 0);
                                const weekEnd = new Date(weekStart);
                                weekEnd.setDate(weekStart.getDate() + 6);
                                weekEnd.setHours(23, 59, 59, 999);
                                
                                const weekEvents = instructorEvents.filter(event => {
                                    const eventDate = new Date(event.start);
                                    return eventDate >= weekStart && eventDate <= weekEnd;
                                });
                                
                                if (weekEvents.length > 0) {
                                    console.log('‚úÖ Ë¨õÂ∏´Êú¨ÈÄ±ÊúâË™≤Á®ãÔºåÂàáÊèõÂà∞Êú¨ÈÄ±Ë¶ñÂúñ');
                                    currentView = 'Êú¨ÈÄ±';
                                    window.currentView = 'Êú¨ÈÄ±';
                                } else {
                                    // Ê™¢Êü•Êú¨ÊúàÊòØÂê¶ÊúâË™≤Á®ã
                                    const monthEvents = instructorEvents.filter(event => {
                                        const eventDate = new Date(event.start);
                                        return eventDate.getFullYear() === now.getFullYear() &&
                                               eventDate.getMonth() === now.getMonth();
                                    });
                                    
                                    if (monthEvents.length > 0) {
                                        console.log('‚úÖ Ë¨õÂ∏´Êú¨ÊúàÊúâË™≤Á®ãÔºåÂàáÊèõÂà∞Êú¨ÊúàË¶ñÂúñ');
                                        currentView = 'Êú¨Êúà';
                                        window.currentView = 'Êú¨Êúà';
                                    } else {
                                        console.log('‚úÖ Ë¨õÂ∏´Âè™ÊúâÂÖ∂‰ªñÊúà‰ªΩÁöÑË™≤Á®ãÔºåÂàáÊèõÂà∞ÂÖ®ÈÉ®Ë¶ñÂúñ');
                                        currentView = 'ÂÖ®ÈÉ®';
                                        window.currentView = 'ÂÖ®ÈÉ®';
                                    }
                                }
                            }
                        }
                    } else {
                        // ÈÅ∏ÊìáÂÖ®ÈÉ®Ë¨õÂ∏´ÊôÇÈáçÁΩÆÁÇ∫‰ªäÊó•Ë¶ñÂúñ
                        currentView = '‰ªäÊó•';
                        window.currentView = '‰ªäÊó•';
                    }
                    
                    updateViewButtonStates();
                    updateTimeFilterOptions(); // Êõ¥Êñ∞ÊôÇÊÆµÁØ©ÈÅ∏ÈÅ∏È†Ö
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // Ëá™ÂãïÊªæÂãïÂà∞Ë¶ñÂúñÊåâÈàï
                    console.log('üì± Ë¨õÂ∏´ÈÅ∏ÊìáÂæåÊô∫ÊÖßÂàáÊèõË¶ñÂúñ:', currentView);
                });
            }
            
            // ÊôÇÊÆµÁØ©ÈÅ∏Ë™≤Á®ãÁõ£ËÅΩÂô®
            const timeFilter = document.getElementById('timeFilter');
            if (timeFilter) {
                timeFilter.addEventListener('change', function() {
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // Ëá™ÂãïÊªæÂãïÂà∞Ë¶ñÂúñÊåâÈàï
                });
            }
            
            // Êó•ÊúüÁØ©ÈÅ∏Ë™≤Á®ãÁõ£ËÅΩÂô®
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // Ëá™ÂãïÊªæÂãïÂà∞Ë¶ñÂúñÊåâÈàï
                });
            }
            
            
            
            
            
            // Ë®≠ÁΩÆÂàùÂßãÈÅ∏‰∏≠ÁãÄÊÖãÔºàÁßªÈô§Âª∂ÈÅ≤Ôºâ
            updateViewButtonStates();
            
            // Âø´ÈÄüÁØ©ÈÅ∏ÂäüËÉΩÂ∑≤ÁßªÈô§
            
            // Á∂ÅÂÆöÁî®Êà∂ÊåâÈàïË™≤Á®ãÁõ£ËÅΩÂô®
            const bindUserBtn = document.getElementById('bindUserBtn');
            if (bindUserBtn) {
                bindUserBtn.addEventListener('click', bindUser);
            }
        }



        // ÁîüÊàêÈö®Ê©üÈ¶¨Âç°ÈæçÈ°èËâ≤
        function generateRandomMacaronColor() {
            const macaronColors = [
                'rgba(255, 182, 193, 0.8)', 'rgba(116, 185, 255, 0.8)', 'rgba(255, 223, 102, 0.8)', 
                'rgba(180, 167, 214, 0.8)', 'rgba(0, 184, 148, 0.8)', 'rgba(255, 192, 203, 0.8)',
                'rgba(162, 155, 254, 0.8)', 'rgba(85, 239, 196, 0.8)', 'rgba(255, 118, 117, 0.8)', 
                'rgba(108, 92, 231, 0.8)', 'rgba(232, 67, 147, 0.8)', 'rgba(0, 206, 201, 0.8)',
                'rgba(255, 159, 67, 0.8)', 'rgba(255, 107, 107, 0.8)', 'rgba(46, 204, 113, 0.8)',
                'rgba(155, 89, 182, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(241, 196, 15, 0.8)'
            ];
            return macaronColors[Math.floor(Math.random() * macaronColors.length)];
        }

        // ËºâÂÖ•Ë®≠ÁΩÆ
        function loadSettings() {
            const saved = localStorage.getItem('calendarSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                colorSettings = { ...colorSettings, ...settings.colors };
                instructorColors = settings.instructorColors || {};
                applyColorSettings();
            }
            // Ê≥®ÊÑèÔºöË¨õÂ∏´È°èËâ≤Â∞áÂú® loadEvents ÂÆåÊàêÂæåÁîüÊàê
        }

        // ÁÇ∫Ë¨õÂ∏´ÁîüÊàêÈö®Ê©üÈ¶¨Âç°ÈæçÈ°èËâ≤
        function generateRandomInstructorColors() {
            allInstructors.forEach(instructor => {
                if (!instructorColors[instructor]) {
                    instructorColors[instructor] = generateRandomMacaronColor();
                }
            });
        }

        // ÂÑ≤Â≠òË®≠ÁΩÆ
        function saveSettings() {
            // Êõ¥Êñ∞È°èËâ≤Ë®≠ÁΩÆÔºàÂ∞á hex ËΩâÊèõÁÇ∫ rgbaÔºâ
            colorSettings.esm = hexToRgba(document.getElementById('esmColor').value, 0.8);
            colorSettings.spm = hexToRgba(document.getElementById('spmColor').value, 0.8);
            colorSettings.boost = hexToRgba(document.getElementById('boostColor').value, 0.8);
            colorSettings.spike = hexToRgba(document.getElementById('spikeColor').value, 0.8);
            colorSettings.ev3 = hexToRgba(document.getElementById('ev3Color').value, 0.8);
            colorSettings.minecraft = hexToRgba(document.getElementById('minecraftColor').value, 0.8);

            const settings = {
                colors: colorSettings,
                instructorColors: instructorColors
            };
            localStorage.setItem('calendarSettings', JSON.stringify(settings));
            applyColorSettings();
            closeSettings();
        }

        // ÊáâÁî®È°èËâ≤Ë®≠ÁΩÆ
        function applyColorSettings() {
            // Êõ¥Êñ∞CSSËÆäÊï∏
            document.documentElement.style.setProperty('--esm-color', colorSettings.esm);
            document.documentElement.style.setProperty('--spm-color', colorSettings.spm);
            document.documentElement.style.setProperty('--boost-color', colorSettings.boost);
            document.documentElement.style.setProperty('--spike-color', colorSettings.spike);
            document.documentElement.style.setProperty('--ev3-color', colorSettings.ev3);
            document.documentElement.style.setProperty('--minecraft-color', colorSettings.minecraft);
            
            // ÈáçÊñ∞Ê∏≤ÊüìË™≤Á®ã
            if (allEvents.length > 0) {
                renderEvents();
            }
        }

        // ÊâìÈñãË®≠ÁΩÆÁï´Èù¢
        function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            
            // Á¢∫‰øùË¨õÂ∏´È°èËâ≤Â∑≤Á∂ìÁîüÊàê
            if (allInstructors && allInstructors.length > 0) {
                generateRandomInstructorColors();
            }
            
            populateSettingsModal();
        }

        // Â°´ÂÖÖË®≠ÁΩÆÊ®°ÊÖãÊ°Ü
        function populateSettingsModal() {
            // Ë®≠ÁΩÆË™≤Á®ãÈ°ûÂûãÈ°èËâ≤ÔºàÂ∞á rgba ËΩâÊèõÁÇ∫ hexÔºâ
            document.getElementById('esmColor').value = rgbaToHex(colorSettings.esm);
            document.getElementById('spmColor').value = rgbaToHex(colorSettings.spm);
            document.getElementById('boostColor').value = rgbaToHex(colorSettings.boost);
            document.getElementById('spikeColor').value = rgbaToHex(colorSettings.spike);
            document.getElementById('ev3Color').value = rgbaToHex(colorSettings.ev3);
            document.getElementById('minecraftColor').value = rgbaToHex(colorSettings.minecraft);
            
            // Â°´ÂÖÖË¨õÂ∏´È°èËâ≤Ë®≠ÁΩÆ
            populateInstructorColorSettings();
        }

        // ÈóúÈñâË®≠ÁΩÆÁï´Èù¢
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }

        // Â°´ÂÖÖË¨õÂ∏´È°èËâ≤Ë®≠ÁΩÆ
        function populateInstructorColorSettings() {
            const container = document.getElementById('instructorColorGroup');
            container.innerHTML = '';
            
            // Á¢∫‰øù allInstructors Â∑≤Á∂ìËºâÂÖ•
            if (!allInstructors || allInstructors.length === 0) {
                console.log('Ë¨õÂ∏´ÂàóË°®Â∞öÊú™ËºâÂÖ•ÔºåÁÑ°Ê≥ïÂ°´ÂÖÖÈ°èËâ≤Ë®≠ÁΩÆ');
                return;
            }
            
            console.log('Â°´ÂÖÖË¨õÂ∏´È°èËâ≤Ë®≠ÁΩÆÔºåË¨õÂ∏´ÂàóË°®:', allInstructors);
            console.log('Áï∂ÂâçË¨õÂ∏´È°èËâ≤:', instructorColors);
            
            allInstructors.forEach(instructor => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-picker-item'; // ‰ΩøÁî®ËàáÊïôÊ°àÈ°ûÂûãÈ°èËâ≤Áõ∏ÂêåÁöÑ class
                const currentColor = instructorColors[instructor] || generateRandomMacaronColor();
                const hexColor = rgbaToHex(currentColor);
                console.log(`Ë¨õÂ∏´ ${instructor} ÁöÑÈ°èËâ≤: ${currentColor} -> ${hexColor}`);
                
                colorItem.innerHTML = `
                    <label>${instructor}</label>
                    <input type="color" class="color-picker" 
                           id="instructor_${instructor}" 
                           value="${hexColor}"
                           onchange="updateInstructorColor('${instructor}', this.value)">
                `;
                container.appendChild(colorItem);
            });
        }

        // Êõ¥Êñ∞Ë¨õÂ∏´È°èËâ≤
        function updateInstructorColor(instructor, color) {
            // Â∞á hex È°èËâ≤ËΩâÊèõÁÇ∫ rgba Ê†ºÂºè
            const rgbaColor = hexToRgba(color, 0.8);
            instructorColors[instructor] = rgbaColor;
        }

        // Â∞á hex È°èËâ≤ËΩâÊèõÁÇ∫ rgba Ê†ºÂºè
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Â∞á rgba È°èËâ≤ËΩâÊèõÁÇ∫ hex Ê†ºÂºèÔºàÁî®ÊñºÈ°èËâ≤ÈÅ∏ÊìáÂô®Ôºâ
        function rgbaToHex(rgba) {
            const values = rgba.match(/\d+/g);
            if (values && values.length >= 3) {
                const r = parseInt(values[0]);
                const g = parseInt(values[1]);
                const b = parseInt(values[2]);
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            return '#000000';
        }

// ËºâÂÖ•Áï∂Êó•Ë™≤Á®ãÔºàÁõ¥Êé•ËºâÂÖ•ÂÆåÊï¥Êï∏ÊìöÔºâ
async function loadTodayEvents() {
            try {
        console.log('üöÄ ÈñãÂßãËºâÂÖ•ÂÆåÊï¥Ë™≤Á®ãÊï∏Êìö...');
        addLoadingLog('üåê Ê≠£Âú®ÈÄ£Êé• CalDAV ‰º∫ÊúçÂô®...', 'info');
        
                const response = await fetch('/api/events');
        addLoadingLog('üì° Ê≠£Âú®Áç≤ÂèñË°å‰∫ãÊõÜË≥áÊñô...', 'info');
        
                const data = await response.json();
                
                if (data.success) {
            addLoadingLog(`üìä ÊàêÂäüÁç≤Âèñ ${data.data.length} ÂÄãË™≤Á®ã`, 'success');
            
                    // ÈÅéÊøæÊéâ null ÂÄºÂíåÁÑ°ÊïàË™≤Á®ã
                    allEvents = data.data.filter(event => {
                        if (!event) {
                            console.warn('‚ö†Ô∏è loadTodayEvents: ÁôºÁèæ null Ë™≤Á®ãÔºåÂ∑≤ÈÅéÊøæ');
                            return false;
                        }
                        if (!event.start || !event.end || !event.title || !event.instructor) {
                            console.warn('‚ö†Ô∏è loadTodayEvents: Ë™≤Á®ãÁº∫Â∞ëÂøÖË¶ÅÂ±¨ÊÄßÔºåÂ∑≤ÈÅéÊøæ', event);
                            return false;
                        }
                        return true;
                    });
                    
                    console.log('üîç loadTodayEvents: allEvents ÈÅéÊøæÂÆåÊàêÔºåÊï∏Èáè:', allEvents.length);
                    console.log('üîç loadTodayEvents: allEvents Ââç5ÂÄãË™≤Á®ã:', allEvents.slice(0, 5));
                    
                    // Ë™øË©¶ allEvents ÁöÑÁãÄÊÖã
                    console.log('üîç loadTodayEvents: ÈñãÂßãÂ°´ÂÖÖ allInstructors');
                    console.log('üîç loadTodayEvents: allEvents Èï∑Â∫¶:', allEvents.length);
                    console.log('üîç loadTodayEvents: allEvents Ââç3ÂÄãË™≤Á®ãÁöÑË¨õÂ∏´:', allEvents.slice(0, 3).map(event => event.instructor));
                    
                    allInstructors = [...new Set(allEvents.map(event => event.instructor).filter(Boolean))];
            
            console.log('üîç loadTodayEvents: allInstructors Â°´ÂÖÖÂÆåÊàê:', allInstructors);
            addLoadingLog(`üë• ÁôºÁèæ ${allInstructors.length} ‰ΩçË¨õÂ∏´`, 'info');
                    
                    // ÁÇ∫Êñ∞Ë¨õÂ∏´ÁîüÊàêÈö®Ê©üÈ¶¨Âç°ÈæçÈ°èËâ≤ÔºàÂ¶ÇÊûúÊ≤íÊúâ‰øùÂ≠òÁöÑË®≠ÁΩÆÔºâ
                    if (Object.keys(instructorColors).length === 0) {
                addLoadingLog('üé® Ê≠£Âú®ÁîüÊàêË¨õÂ∏´È°èËâ≤ÈÖçÁΩÆ...', 'info');
                        generateRandomInstructorColors();
                    }
                    
                    addLoadingLog('üîÑ Ê≠£Âú®Ê∏≤ÊüìË™≤Á®ãÂàóË°®...', 'info');
                    await populateInstructorDropdown();
                    renderEvents();
                    updateStats();
                    
            
            console.log(`‚úÖ ÂÆåÊï¥Ë™≤Á®ãËºâÂÖ•ÂÆåÊàê: ${allEvents.length} ÂÄãË™≤Á®ã`);
            addLoadingLog(`‚úÖ ËºâÂÖ•ÂÆåÊàêÔºÅÂÖ± ${allEvents.length} ÂÄãË™≤Á®ã`, 'success');
            hideLoadingMessage();
                } else {
                    showError('ËºâÂÖ•Ë™≤Á®ãÂ§±Êïó: ' + data.message);
                }
            } catch (error) {
                console.error('ËºâÂÖ•Ë™≤Á®ãÈåØË™§:', error);
                showError('ÁÑ°Ê≥ïÈÄ£Êé•Âà∞ÊúçÂãôÂô®');
    }
}


        // ËºâÂÖ•Ë™≤Á®ãË≥áÊñôÔºàÂêëÂæåÁõ∏ÂÆπÔºâ
        async function loadEvents() {
            return loadTodayEvents();
        }

        // ËºâÂÖ•Êó•Ë™åÁÆ°ÁêÜ
        let loadingLogs = [];
        
        function addLoadingLog(message, type = 'info') {
            const logItem = {
                message,
                type,
                timestamp: new Date().toLocaleTimeString()
            };
            loadingLogs.push(logItem);
            
            const logsContainer = document.getElementById('loadingLogs');
            if (logsContainer) {
                const logElement = document.createElement('div');
                logElement.className = `loading-log-item ${type}`;
                
                const icon = {
                    'success': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'info': '‚ÑπÔ∏è'
                }[type] || '‚ÑπÔ∏è';
                
                logElement.innerHTML = `
                    <span class="loading-log-icon">${icon}</span>
                    <span>[${logItem.timestamp}] ${message}</span>
                `;
                
                logsContainer.appendChild(logElement);
                
                // Ëá™ÂãïÊªæÂãïÂà∞ÊúÄÊñ∞Êó•Ë™å
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        // È°ØÁ§∫ËºâÂÖ•ÈÄ≤Â∫¶ÊèêÁ§∫
        function showLoadingMessage(message) {
            addLoadingLog(message, 'info');
            // ÁßªÈô§ÁèæÊúâÁöÑËºâÂÖ•ÊèêÁ§∫
            const existingMessage = document.getElementById('loading-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // ÂâµÂª∫ËºâÂÖ•ÊèêÁ§∫ÂÖÉÁ¥†
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 123, 255, 0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            loadingDiv.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                ${message}
            `;
            
            document.body.appendChild(loadingDiv);
        }

        // Èö±ËóèËºâÂÖ•ÈÄ≤Â∫¶ÊèêÁ§∫
        function hideLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (loadingMessage.parentNode) {
                        loadingMessage.remove();
                    }
                }, 300);
            }
        }

        // Â°´ÂÖÖË¨õÂ∏´‰∏ãÊãâÈÅ∏ÂñÆ
        async function populateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            const currentValue = select.value; // ‰øùÂ≠òÁï∂ÂâçÈÅ∏Êìá
            
            console.log('üîÑ Â°´ÂÖÖË¨õÂ∏´‰∏ãÊãâÈÅ∏ÂñÆÔºåÁï∂ÂâçÈÅ∏Êìá:', currentValue);
            console.log('üîÑ ÂèØÁî®Ë¨õÂ∏´ÂàóË°®:', allInstructors);
            
            try {
            select.innerHTML = '<option value="">ÂÖ®ÈÉ®Ë¨õÂ∏´</option>';
            
                let instructors = [];
                
                // ÊñπÊ≥ï1: ‰ΩøÁî® allInstructors
                if (allInstructors && allInstructors.length > 0) {
                    console.log('‚úÖ ‰ΩøÁî® allInstructorsÔºåÊï∏Èáè:', allInstructors.length);
                    instructors = [...allInstructors];
                } else {
                    // ÊñπÊ≥ï2: Áõ¥Êé•Âæû API Áç≤Âèñ‰∏¶ÊèêÂèñË¨õÂ∏´ÂàóË°®
                    console.log('‚ö†Ô∏è allInstructors ÁÇ∫Á©∫ÔºåÁõ¥Êé•Âæû API Áç≤ÂèñË¨õÂ∏´ÂàóË°®');
                    try {
                        const response = await fetch('/api/events');
                        const data = await response.json();
                        
                        if (data.success && data.data) {
                            instructors = [...new Set(data.data
                                .filter(event => event && event.instructor)
                                .map(event => event.instructor)
                            )].sort();
                            
                            console.log('üì° Âæû API Áç≤ÂèñÁöÑË¨õÂ∏´ÂàóË°®:', instructors);
                        } else {
                            // ÊñπÊ≥ï3: ‰ΩøÁî®Á°¨Á∑®Á¢ºÁöÑÊ∏¨Ë©¶Ë¨õÂ∏´
                            console.log('‚ö†Ô∏è API Áç≤ÂèñÂ§±ÊïóÔºå‰ΩøÁî®Ê∏¨Ë©¶Ë¨õÂ∏´');
                            instructors = ['AGNES', 'BELLA', 'TIM', 'ALICE'];
                        }
                    } catch (apiError) {
                        console.error('‚ùå API Ë™øÁî®Â§±Êïó:', apiError);
                        // ÊñπÊ≥ï3: ‰ΩøÁî®Á°¨Á∑®Á¢ºÁöÑÊ∏¨Ë©¶Ë¨õÂ∏´
                        instructors = ['AGNES', 'BELLA', 'TIM', 'ALICE'];
                    }
                }
                
                // ÊéíÂ∫èË¨õÂ∏´ÂàóË°®ÔºöÂ∑≤ÈÅ∏ÊìáÁöÑË¨õÂ∏´ÊéíÂú®ÂâçÈù¢
                if (currentValue && instructors.includes(currentValue)) {
                    // Â∞áÁï∂ÂâçÈÅ∏ÊìáÁöÑË¨õÂ∏´ÁßªÂà∞ÊúÄÂâçÈù¢
                    instructors = [currentValue, ...instructors.filter(inst => inst !== currentValue)];
                    console.log('üîÑ Â∑≤ÈÅ∏ÊìáË¨õÂ∏´ÂÑ™ÂÖàÊéíÂ∫è:', instructors);
                }
                
                // ÂâµÂª∫ÈÅ∏È†Ö
                instructors.forEach(instructor => {
                    const option = document.createElement('option');
                    option.value = instructor;
                    option.textContent = instructor;
                    select.appendChild(option);
                });
                
                // ÊÅ¢Âæ©‰πãÂâçÁöÑÈÅ∏Êìá
                if (currentValue) {
                    select.value = currentValue;
                    console.log('üîÑ ÊÅ¢Âæ©Ë¨õÂ∏´ÈÅ∏Êìá:', currentValue);
                }
                
                console.log('‚úÖ populateInstructorDropdown Âü∑Ë°åÂÆåÊàêÔºåË¨õÂ∏´ÈÅ∏È†ÖÊï∏Èáè:', select.options.length);
            } catch (error) {
                console.error('‚ùå populateInstructorDropdown Âü∑Ë°åÂ§±Êïó:', error);
                // Âç≥‰ΩøÂ§±Êïó‰πüË¶ÅÁ¢∫‰øùÊúâÂü∫Êú¨ÈÅ∏È†Ö
                select.innerHTML = '<option value="">ÂÖ®ÈÉ®Ë¨õÂ∏´</option><option value="ERROR">ÁôºÁîüÈåØË™§</option><option value="AGNES">[Ê∏¨Ë©¶] AGNES</option><option value="BELLA">[Ê∏¨Ë©¶] BELLA</option>';
            }
        }

        // Êõ¥Êñ∞Ë¨õÂ∏´‰∏ãÊãâÈÅ∏ÂñÆÔºà‰∏çÈáçÊñ∞Ê∏≤ÊüìÊï¥ÂÄãÁï´Èù¢Ôºâ
        function updateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            const currentValue = select.value;
            
            // Ê∏ÖÁ©∫ÁèæÊúâÈÅ∏È†ÖÔºàÈô§‰∫Ü"ÂÖ®ÈÉ®Ë¨õÂ∏´"Ôºâ
            select.innerHTML = '<option value="">ÂÖ®ÈÉ®Ë¨õÂ∏´</option>';

            // Ê∑ªÂä†ÊâÄÊúâË¨õÂ∏´ÈÅ∏È†Ö
            allInstructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor;
                option.textContent = instructor;
                select.appendChild(option);
            });
            
            // ÊÅ¢Âæ©‰πãÂâçÈÅ∏‰∏≠ÁöÑÂÄº
            if (currentValue && allInstructors.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Êõ¥Êñ∞ÊôÇÊÆµÁØ©ÈÅ∏ÈÅ∏È†ÖÔºàÊô∫ÊÖßÁÆóÊ≥ïÔºâ
        function updateTimeFilterOptions() {
            const timeFilter = document.getElementById('timeFilter');
            const instructorFilter = document.getElementById('instructorSelect').value;
            
            if (!timeFilter) return;
            
            // ‰øùÂ≠òÁï∂ÂâçÈÅ∏Êìá
            const currentValue = timeFilter.value;
            
            // Ê∏ÖÁ©∫ÁèæÊúâÈÅ∏È†Ö
            timeFilter.innerHTML = '<option value="">ÂÖ®ÈÉ®ÊôÇÊÆµ</option>';
            
            // Áç≤ÂèñË¶ÅÁµ±Ë®àÁöÑË™≤Á®ãÔºàÊ†πÊìöË¨õÂ∏´ÁØ©ÈÅ∏Ôºâ
            let eventsToAnalyze = allEvents;
            if (instructorFilter) {
                eventsToAnalyze = allEvents.filter(event => 
                    event && event.instructor === instructorFilter
                );
            }
            
            // Áµ±Ë®àÊôÇÊÆµÂàÜÂ∏É
            const timeSlots = {
                morning: 0,
                afternoon: 0,
                evening: 0
            };
            
            eventsToAnalyze.forEach(event => {
                if (event.start) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    
                    if (hour >= 6 && hour < 12) {
                        timeSlots.morning++;
                    } else if (hour >= 12 && hour < 18) {
                        timeSlots.afternoon++;
                    } else if (hour >= 18 && hour < 24) {
                        timeSlots.evening++;
                    }
                }
            });
            
            // Âè™Ê∑ªÂä†ÊúâË™≤Á®ãÁöÑÊôÇÊÆµÈÅ∏È†Ö
            if (timeSlots.morning > 0) {
                const option = document.createElement('option');
                option.value = 'morning';
                option.textContent = `‰∏äÂçà (${timeSlots.morning})`;
                timeFilter.appendChild(option);
            }
            
            if (timeSlots.afternoon > 0) {
                const option = document.createElement('option');
                option.value = 'afternoon';
                option.textContent = `‰∏ãÂçà (${timeSlots.afternoon})`;
                timeFilter.appendChild(option);
            }
            
            if (timeSlots.evening > 0) {
                const option = document.createElement('option');
                option.value = 'evening';
                option.textContent = `Êôö‰∏ä (${timeSlots.evening})`;
                timeFilter.appendChild(option);
            }
            
            console.log('üïê Êô∫ÊÖßÊôÇÊÆµÁØ©ÈÅ∏Êõ¥Êñ∞:', timeSlots, 'Ë¨õÂ∏´:', instructorFilter || 'ÂÖ®ÈÉ®');
            
            // ÊÅ¢Âæ©‰πãÂâçÁöÑÈÅ∏ÊìáÔºàÂ¶ÇÊûúË©≤ÈÅ∏È†Ö‰ªçÁÑ∂Â≠òÂú®Ôºâ
            if (currentValue && timeFilter.querySelector(`option[value="${currentValue}"]`)) {
                timeFilter.value = currentValue;
            } else {
                timeFilter.value = '';
            }
        }

        // Ë¶ñÂúñÊåâÈàïÈªûÊìäËôïÁêÜÂáΩÊï∏
        function handleViewButtonClick(e) {
            console.log('üéØ handleViewButtonClick Ë¢´Ë™øÁî®', {
                eventType: e.type,
                target: this,
                dataView: this.getAttribute('data-view'),
                currentView: currentView,
                timestamp: new Date().toISOString()
            });
            
            // Èò≤Ê≠¢ÊªëÂãïË™≤Á®ãÂπ≤ÊìæÈªûÊìä
            e.preventDefault();
            e.stopPropagation();
            
            const view = this.getAttribute('data-view');
            console.log(`üì± ÊåâÈàïÈªûÊìäÔºöÂàáÊèõÂà∞ ${view}`, {
                eventType: e.type,
                target: this,
                currentView: currentView,
                buttonText: this.textContent,
                buttonClass: this.className
            });
            
            // Ëß∏ÁôºÊåâÈàïÈ´ò‰∫ÆÂãïÁï´
            highlightViewButton(view);
            
            // ÂàáÊèõË¶ñÂúñ
            switchView(view);
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖãÂíåÈáçÊñ∞Ê∏≤ÊüìÔºàÁßªÈô§Âª∂ÈÅ≤Ôºâ
            updateViewButtonStates();
            updateStats();
            renderEvents();
            autoScrollToViewButtons(); // Ëá™ÂãïÊªæÂãïÂà∞Ë¶ñÂúñÊåâÈàï
            console.log(`üì± Ë¶ñÂúñÂ∑≤ÂàáÊèõÂà∞ ${view}ÔºåË™≤Á®ãÂ∑≤ÈáçÊñ∞Ê∏≤Êüì`);
        }

        // ÁÇ∫Ë¶ñÂúñÊåâÈàïÊ∑ªÂä†Ë™≤Á®ãÁõ£ËÅΩÂô®
        function bindViewButtons() {
            console.log('üîó ÈñãÂßãÁ∂ÅÂÆöË¶ñÂúñÊåâÈàï...');
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            console.log(`üîó ÊâæÂà∞ ${viewButtons.length} ÂÄãË¶ñÂúñÊåâÈàï`);
            
            // Ê™¢Êü•Áî®Êà∂‰ª£ÁêÜ
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
            console.log('üì± Ë®≠ÂÇôÊ™¢Ê∏¨:', { userAgent, isIOS, isSafari });
            
            if (viewButtons.length === 0) {
                console.error('‚ùå Êâæ‰∏çÂà∞Ë¶ñÂúñÊåâÈàïÔºåË´ãÊ™¢Êü• HTML ÁµêÊßã');
                // Ê™¢Êü• DOM ÁµêÊßã
                const viewButtonsContainer = document.querySelector('.view-buttons');
                if (viewButtonsContainer) {
                    console.log('‚ùå view-buttons ÂÆπÂô®Â≠òÂú®Ôºå‰ΩÜÊ≤íÊúâÊåâÈàï');
                    console.log('‚ùå ÂÆπÂô®ÂÖßÂÆπ:', viewButtonsContainer.innerHTML);
                } else {
                    console.log('‚ùå view-buttons ÂÆπÂô®‰∏çÂ≠òÂú®');
                }
                return;
            }
            
            viewButtons.forEach((button, index) => {
                console.log(`üîó Á∂ÅÂÆöÊåâÈàï ${index + 1}: ${button.getAttribute('data-view')}`);
                
                // Ê∏ÖÈô§ÊâÄÊúâËàäÁöÑË™≤Á®ãÁõ£ËÅΩÂô®ÂíåÂ±¨ÊÄß
                button.removeEventListener('click', handleViewButtonClick);
                button.removeEventListener('touchstart', handleViewButtonClick);
                button.removeEventListener('touchend', handleViewButtonClick);
                button.removeEventListener('mousedown', handleViewButtonClick);
                button.removeEventListener('touchend', handleViewButtonClick);
                button.onclick = null;
                
                // iOS Safari ÁâπÊÆäÊ®£ÂºèË®≠ÁΩÆ
                button.style.pointerEvents = 'auto';
                button.style.cursor = 'pointer';
                button.style.userSelect = 'none';
                button.style.webkitUserSelect = 'none';
                button.style.webkitTouchCallout = 'none';
                button.style.webkitTapHighlightColor = 'transparent';
                button.style.position = 'relative';
                button.style.zIndex = '10';
                button.style.display = 'block';
                button.style.width = '100%';
                button.style.height = 'auto';
                button.style.minHeight = '44px'; // iOS ÊúÄÂ∞èËß∏ÊéßÂçÄÂüü
                
                // iOS Safari Ëß∏ÊéßÂÑ™Âåñ
                if (isIOS) {
                    button.style.touchAction = 'manipulation';
                    button.style.webkitTouchCallout = 'none';
                    button.style.webkitUserSelect = 'none';
                    button.style.webkitTapHighlightColor = 'rgba(0, 0, 0, 0.1)';
                    button.style.border = 'none';
                    button.style.outline = 'none';
                    button.style.appearance = 'none';
                    button.style.webkitAppearance = 'none';
                } else {
                    button.style.touchAction = 'manipulation';
                }
                
                // Á∞°ÂåñÁöÑÊåâÈàïË™≤Á®ãËôïÁêÜ - Á¢∫‰øùÊåâÈàïÂèØ‰ª•Ê≠£Â∏∏ÈªûÊìä
                const buttonClickHandler = function(e) {
                    console.log(`üì± ÊåâÈàïÈªûÊìäËß∏Áôº: ${button.getAttribute('data-view')}`);
                    e.preventDefault();
                    e.stopPropagation();
                    handleViewButtonClick.call(this, e);
                };
                
                // Ê∏ÖÈô§ÊâÄÊúâËàäÁöÑË™≤Á®ãÁõ£ËÅΩÂô®
                button.removeEventListener('click', buttonClickHandler);
                button.removeEventListener('touchstart', buttonClickHandler);
                button.removeEventListener('touchend', buttonClickHandler);
                button.removeEventListener('mousedown', buttonClickHandler);
                
                // Ê∑ªÂä†Êñ∞ÁöÑË™≤Á®ãÁõ£ËÅΩÂô®
                button.addEventListener('click', buttonClickHandler, { passive: false });
                button.addEventListener('touchstart', buttonClickHandler, { passive: false });
                button.addEventListener('touchend', buttonClickHandler, { passive: false });
                
                // Âº∑Âà∂ onclick ‰ΩúÁÇ∫ÂÇôÁî®ÊñπÊ°à
                button.onclick = buttonClickHandler;
                
                console.log(`‚úÖ ÊåâÈàï ${index + 1} Á∂ÅÂÆöÂÆåÊàê: ${button.getAttribute('data-view')}`);
            });
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖãÔºàÁßªÈô§Âª∂ÈÅ≤Ôºâ
            updateViewButtonStates();
            console.log('üì± ÊåâÈàïÁãÄÊÖãÂ∑≤Êõ¥Êñ∞');
        }

        // Êõ¥Êñ∞Ë¶ñÂúñÊåâÈàïÁãÄÊÖã
        function updateViewButtonStates() {
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            
            // ‰∏≠Ëã±ÊñáÂ∞çÊáâÈóú‰øÇ
            const viewMap = {
                '‰ªäÊó•': 'today',
                'Êú¨ÈÄ±': 'week', 
                'Êú¨Êúà': 'month',
                'ÂÖ®ÈÉ®': 'all'
            };
            
            const englishCurrentView = viewMap[currentView] || currentView;
            
            viewButtons.forEach(button => {
                const view = button.getAttribute('data-view');
                if (view === englishCurrentView) {
                    button.classList.add('active');
                    console.log(`‚úÖ ÊåâÈàï ${view} (${currentView}) Ë®≠ÁÇ∫ÈÅ∏‰∏≠ÁãÄÊÖã`);
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // iOS Safari ÊåâÈàïÊ∏¨Ë©¶ÂáΩÊï∏
        function testIOSButtons() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            
            if (isIOS) {
                console.log('üçé ÈñãÂßã iOS Safari ÊåâÈàïÊ∏¨Ë©¶...');
                const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
                
                viewButtons.forEach((button, index) => {
                    console.log(`üçé Ê∏¨Ë©¶ÊåâÈàï ${index + 1}: ${button.getAttribute('data-view')}`);
                    console.log(`üçé ÊåâÈàïÊ®£Âºè:`, {
                        pointerEvents: button.style.pointerEvents,
                        touchAction: button.style.touchAction,
                        webkitUserSelect: button.style.webkitUserSelect,
                        minHeight: button.style.minHeight,
                        display: button.style.display,
                        width: button.style.width
                    });
                    
                    // Âº∑Âà∂Ëß∏ÁôºÊ∏¨Ë©¶
                    button.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                    setTimeout(() => {
                        button.style.backgroundColor = '';
                    }, 1000);
                });
            }
        }

        // ÂàáÊèõÊ™¢Ë¶ñÊ®°Âºè
        // Ë®≠ÁΩÆÁÇ∫ÂÖ®Â±ÄÂáΩÊï∏
        window.switchView = function switchView(view) {
            // Â∞áËã±ÊñáË¶ñÂúñËΩâÊèõÁÇ∫‰∏≠Êñá
            const viewMap = {
                'today': '‰ªäÊó•',
                'week': 'Êú¨ÈÄ±',
                'month': 'Êú¨Êúà',
                'all': 'ÂÖ®ÈÉ®'
            };
            
            const chineseView = viewMap[view] || view;
            currentView = chineseView;
            
            console.log('üîÑ switchView - ÂàáÊèõÂà∞Ë¶ñÂúñ:', chineseView, 'ÂéüÂßãË¶ñÂúñ:', view);
            
            // Êõ¥Êñ∞ÊåâÈàïÈÅ∏‰∏≠ÁãÄÊÖã
            updateViewButtonStates();
            window.currentView = chineseView; // Ë®≠ÁΩÆÂÖ®Â±ÄËÆäÈáè
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã - Âè™ÈáùÂ∞çË¶ñÂúñÊåâÈàï
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            viewButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÊâæÂà∞Â∞çÊáâÁöÑÊåâÈàï‰∏¶Ë®≠ÁÇ∫Ê¥ªË∫ç
            viewButtons.forEach(btn => {
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                }
            });
            
            
            
            // Êõ¥Êñ∞Áµ±Ë®àË≥áË®äÔºàÂåÖÊã¨Êó•ÊúüÁØÑÂúçÔºâ
            updateStats();
            renderEvents();
        };


        // ÈÄöÁî®ÁØ©ÈÅ∏ÂáΩÊï∏ÔºåÊ†πÊìöÁï∂ÂâçÁØ©ÈÅ∏Ê¢ù‰ª∂ÁØ©ÈÅ∏Ë™≤Á®ãÔºà‰∏çÂåÖÂê´Ë¶ñÂúñÁØ©ÈÅ∏Ôºâ
        function getFilteredEvents() {
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            console.log('üîç getFilteredEvents - ÁØ©ÈÅ∏Ê¢ù‰ª∂:', {
                instructorFilter,
                timeFilter,
                dateFilter,
                totalEvents: allEvents.length
            });
            
            const filtered = allEvents.filter(event => {
                const eventDate = new Date(event.start);
                
                // Ë¨õÂ∏´ÁØ©ÈÅ∏
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // ÊôÇÊÆµÁØ©ÈÅ∏
                if (timeFilter) {
                    const hour = eventDate.getHours();
                    let timeMatch = false;
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    if (!timeMatch) return false;
                }
                
                // ÊåáÂÆöÊó•ÊúüÁØ©ÈÅ∏
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const eventYear = eventDate.getFullYear();
                    const eventMonth = eventDate.getMonth();
                    const eventDay = eventDate.getDate();
                    const filterYear = filterDate.getFullYear();
                    const filterMonth = filterDate.getMonth();
                    const filterDay = filterDate.getDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // Âø´ÈÄüÁØ©ÈÅ∏Êó•ÊúüÁØÑÂúç
                if (window.currentQuickFilterRange) {
                    const range = window.currentQuickFilterRange;
                    const eventTime = eventDate.getTime();
                    if (eventTime < range.start.getTime() || eventTime > range.end.getTime()) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log('üîç getFilteredEvents - ÁØ©ÈÅ∏ÁµêÊûú:', filtered.length);
            return filtered;
        }

        // Êú™‰ΩøÁî®ÁöÑ getViewFilteredEvents ÂáΩÊï∏Â∑≤ÁßªÈô§


        // ÁßªÈô§Âø´ÈÄüÁØ©ÈÅ∏ÂäüËÉΩ - ÊâÄÊúâÂø´ÈÄüÁØ©ÈÅ∏Áõ∏Èóú‰ª£Á¢ºÂ∑≤ÁßªÈô§
        
        // Ê∏≤ÊüìË™≤Á®ãÂàóË°®
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            console.log('üé® renderEvents - ÈñãÂßãÁØ©ÈÅ∏ÔºåÁ∏ΩË™≤Á®ãÊï∏:', allEvents.length, 'Áï∂ÂâçË¶ñÂúñ:', currentView);
            
            // ‰ΩøÁî®Á∞°ÂñÆÁõ¥Êé•ÁöÑÁØ©ÈÅ∏ÈÇèËºØÔºåÂÖàÈÅéÊøæÊéâ null ÂÄº
            let filteredEvents = allEvents.filter(event => {
                // ÂÖàÊ™¢Êü•Ë™≤Á®ãÊòØÂê¶ÁÇ∫ null Êàñ undefined
                if (!event) {
                    console.warn('‚ö†Ô∏è renderEvents: ÁôºÁèæ null Ë™≤Á®ãÔºåÂ∑≤ÈÅéÊøæ');
                    return false;
                }
                
                // Ê™¢Êü•ÂøÖË¶ÅÂ±¨ÊÄßÊòØÂê¶Â≠òÂú®
                if (!event.start || !event.end || !event.title || !event.instructor) {
                    console.warn('‚ö†Ô∏è renderEvents: Ë™≤Á®ãÁº∫Â∞ëÂøÖË¶ÅÂ±¨ÊÄßÔºåÂ∑≤ÈÅéÊøæ', event);
                    return false;
                }
                
                return true;
            }).filter(event => {
                // Ë¨õÂ∏´ÁØ©ÈÅ∏
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // ÊôÇÊÆµÁØ©ÈÅ∏
                if (timeFilter) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    let timeMatch = false;
                    
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    
                    if (!timeMatch) {
                    return false;
                    }
                }
                
                // ÊåáÂÆöÊó•ÊúüÁØ©ÈÅ∏
                if (dateFilter) {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    const eventYear = eventDate.getFullYear();
                    const eventMonth = eventDate.getMonth();
                    const eventDay = eventDate.getDate();
                    const filterYear = filterDate.getFullYear();
                    const filterMonth = filterDate.getMonth();
                    const filterDay = filterDate.getDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // Ë¶ñÂúñÁØ©ÈÅ∏
                const eventDate = new Date(event.start);
                const now = new Date();
                
                let shouldShow = false;
                switch (currentView) {
                    case '‰ªäÊó•':
                        const eventYear = eventDate.getFullYear();
                        const eventMonth = eventDate.getMonth();
                        const eventDay = eventDate.getDate();
                        const nowYear = now.getFullYear();
                        const nowMonth = now.getMonth();
                        const nowDay = now.getDate();
                        shouldShow = eventYear === nowYear && eventMonth === nowMonth && eventDay === nowDay;
                        break;
                    case 'Êú¨ÈÄ±':
                        const weekStart = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        weekStart.setDate(now.getDate() + daysToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        weekEnd.setHours(23, 59, 59, 999);
                        shouldShow = eventDate >= weekStart && eventDate <= weekEnd;
                        break;
                    case 'Êú¨Êúà':
                        shouldShow = eventDate.getFullYear() === now.getFullYear() && 
                                   eventDate.getMonth() === now.getMonth();
                        break;
                    case 'ÂÖ®ÈÉ®':
                    default:
                        shouldShow = true;
                }
                
                return shouldShow;
            });
            
            console.log('üé® renderEvents - ÁØ©ÈÅ∏ÂæåË™≤Á®ãÊï∏Èáè:', filteredEvents.length, 'Áï∂ÂâçË¶ñÂúñ:', currentView);
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            if (container) {
                container.innerHTML = '';
            }
            
            // ÊéíÂ∫èË™≤Á®ã
            filteredEvents.sort((a, b) => {
                const now = new Date();
                const eventA = new Date(a.start);
                const eventB = new Date(b.start);
                const endA = new Date(a.end);
                const endB = new Date(b.end);
                
                // Âà§Êñ∑Ë™≤Á®ãÁãÄÊÖã
                const isEventAOngoing = eventA <= now && endA > now;
                const isEventBOngoing = eventB <= now && endB > now;
                const isEventAPast = endA < now;
                const isEventBPast = endB < now;
                const isEventAUpcoming = eventA > now;
                const isEventBUpcoming = eventB > now;
                
                // ÂÑ™ÂÖàÊéíÂ∫èÔºöÊ≠£Âú®ÈÄ≤Ë°å‰∏≠ > Âç≥Â∞áÈñãÂßã > Â∑≤ÁµêÊùü
                if (isEventAOngoing && !isEventBOngoing) return -1;
                if (!isEventAOngoing && isEventBOngoing) return 1;
                
                if (isEventAUpcoming && isEventBPast) return -1;
                if (isEventAPast && isEventBUpcoming) return 1;
                
                // Âú®Áõ∏ÂêåÁãÄÊÖã‰∏ãÔºåÊåâÊôÇÈñìÊéíÂ∫è
                return eventA - eventB;
            });
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="no-events">
                        <i class="fas fa-calendar-times"></i>
                        <h3>Ê≤íÊúâÊâæÂà∞Ë™≤Á®ã</h3>
                        <p>Ë´ãÂòóË©¶Ë™øÊï¥ÁØ©ÈÅ∏Ê¢ù‰ª∂</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredEvents.map(event => createEventCard(event)).join('');
            
            // Ëß∏ÁôºË™≤Á®ãÂç°ÁâáÂãïÁï´ÔºàÁßªÈô§Âª∂ÈÅ≤Ôºâ
                animateEventCards();
                // Êõ¥Êñ∞ÂÄíÊï∏Ë®àÊôÇ
                updateAllCountdowns();
        }

        // ÂæûÊ®ôÈ°åËß£ÊûêÊôÇÈñì
        function parseTimeFromTitle(title) {
            // ÂåπÈÖçÊ†ºÂºèÂ¶Ç "18:30-20:30", "14:30-15:30", "16:30-17:30", "1630-1730" Á≠â
            const timeMatch = title.match(/(\d{1,2}):?(\d{2})-(\d{1,2}):?(\d{2})/);
            if (timeMatch) {
                const startHour = timeMatch[1];
                const startMin = timeMatch[2];
                const endHour = timeMatch[3];
                const endMin = timeMatch[4];
                
                // Ê†ºÂºèÂåñÊôÇÈñìÁÇ∫ HH:MM Ê†ºÂºè
                const startTime = `${startHour.padStart(2, '0')}:${startMin}`;
                const endTime = `${endHour.padStart(2, '0')}:${endMin}`;
                
                return {
                    startTime: startTime,
                    endTime: endTime,
                    timeString: `${startTime} - ${endTime}`
                };
            }
            return null;
        }

        // ÂæûÊ®ôÈ°åËß£ÊûêÊó•ÊúüÔºàÊ†πÊìöÊòüÊúüÂπæÔºâ
        function parseDateFromTitle(title, baseDate = new Date()) {
            // Áõ¥Êé•‰ΩøÁî® CalDAV ÁöÑÊó•ÊúüÔºå‰∏çÈáçÊñ∞Ë®àÁÆó
            // Âõ†ÁÇ∫ CalDAV Â∑≤Á∂ìÊèê‰æõ‰∫ÜÊ≠£Á¢∫ÁöÑÊó•Êúü
            return baseDate;
        }

        // Ë®àÁÆóÈÄ±Ê¨°ÔºàISO 8601 Ê®ôÊ∫ñÔºâ
        function getWeekNumber(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        // Áç≤ÂèñÊòüÊúüÂπæÔºà‰∏≠ÊñáÔºâ
        function getWeekday(date) {
            const weekdays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
            return weekdays[date.getDay()];
        }
        
        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂÅúË™≤/Ë´ãÂÅá
        function isCancelled(event) {
            const title = event.title.toLowerCase();
            const description = (event.description || '').toLowerCase();
            const cancelledKeywords = ['Ë´ãÂÅá', 'ÂÅúË™≤', 'ÂèñÊ∂à', 'Êö´ÂÅú', '‰ºëÊÅØ', 'ÊîæÂÅá'];
            
            return cancelledKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫‰ª£Ë™≤/Â∏∂Áè≠Ë™≤Á®ã
        function isSubstitute(event) {
            const title = event.title || '';
            const description = event.description || '';
            
            const substituteKeywords = ['‰ª£Ë™≤', 'Â∏∂Áè≠', '‰ª£ÁêÜ', 'ÊîØÊè¥'];
            
            return substituteKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // Áç≤Âèñ‰ª£Ë™≤/Â∏∂Áè≠‰ø°ÊÅØ
        function getSubstituteInfo(event) {
            const title = event.title || '';
            const description = event.description || '';
            
            // ÂæûÊ®ôÈ°å‰∏≠ÊèêÂèñ‰ª£Ë™≤‰ø°ÊÅØ
            const titleMatch = title.match(/\[(‰ª£Ë™≤|Â∏∂Áè≠|‰ª£ÁêÜ|ÊîØÊè¥)\]([^\[\]]+)/);
            if (titleMatch) {
                return {
                    type: titleMatch[1],
                    originalInstructor: titleMatch[2].trim()
                };
            }
            
            // ÂæûÊèèËø∞‰∏≠ÊèêÂèñ‰ª£Ë™≤‰ø°ÊÅØ
            const descMatch = description.match(/\[(‰ª£Ë™≤|Â∏∂Áè≠|‰ª£ÁêÜ|ÊîØÊè¥)\]([^\[\]]+)/);
            if (descMatch) {
                return {
                    type: descMatch[1],
                    originalInstructor: descMatch[2].trim()
                };
            }
            
            return null;
        }

        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫È´îÈ©óË™≤Á®ã
        function isExperience(event) {
            if (!event || !event.title) return false;
            
            const title = event.title || '';
            const description = event.description || '';
            
            // Êõ¥Á≤æÁ¢∫ÁöÑÈ´îÈ©óÈóúÈçµÂ≠óÊ™¢Ê∏¨ÔºåÈÅøÂÖçË™§Âà§
            const experienceKeywords = ['È´îÈ©ó'];
            
            return experienceKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // Áç≤ÂèñÈ´îÈ©ó‰ø°ÊÅØ
        function getExperienceInfo(event) {
            if (!isExperience(event)) return null;
            
            const title = event.title || '';
            const description = event.description || '';
            
            // ÂæûÊ®ôÈ°å‰∏≠ÊèêÂèñÈ´îÈ©ó‰ø°ÊÅØ
            const titleMatch = title.match(/\[(È´îÈ©ó|È´î)\]([^\[\]]+)/);
            if (titleMatch) {
                return {
                    type: titleMatch[1]
                };
            }
            
            // ÂæûÊèèËø∞‰∏≠ÊèêÂèñÈ´îÈ©ó‰ø°ÊÅØ
            const descMatch = description.match(/\[(È´îÈ©ó|È´î)\]([^\[\]]+)/);
            if (descMatch) {
                return {
                    type: descMatch[1]
                };
            }
            
            // Â¶ÇÊûúÊ≤íÊúâÊñπÊã¨ËôüÊ†ºÂºèÔºåÊ™¢Êü•ÊòØÂê¶ÂåÖÂê´ÈóúÈçµÂ≠ó
            if (title.includes('È´îÈ©ó')) {
                return { type: 'È´îÈ©ó' };
            } else if (title.includes('È´î')) {
                return { type: 'È´î' };
            }
            
            return null;
        }

        // ÂâµÂª∫Ë™≤Á®ãÂç°Áâá
        function createEventCard(event) {
            // Ê™¢Êü•Ë™≤Á®ãÊòØÂê¶ÁÇ∫ null Êàñ undefined
            if (!event) {
                console.error('‚ùå createEventCard: Ë™≤Á®ãÁÇ∫ null Êàñ undefined');
                return '';
            }
            
            // Ê™¢Êü•ÂøÖË¶ÅÂ±¨ÊÄßÊòØÂê¶Â≠òÂú®
            if (!event.start || !event.end || !event.title || !event.instructor) {
                console.error('‚ùå createEventCard: Ë™≤Á®ãÁº∫Â∞ëÂøÖË¶ÅÂ±¨ÊÄß', event);
                return '';
            }
            
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            const isCancelledEvent = isCancelled(event);
            
            // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫‰ª£Ë™≤/Â∏∂Áè≠Ë™≤Á®ã
            const isSubstituteEvent = isSubstitute(event);
            const substituteInfo = isSubstituteEvent ? getSubstituteInfo(event) : null;
            
            // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫È´îÈ©óË™≤Á®ã
            const isExperienceEvent = isExperience(event);
            const experienceInfo = isExperienceEvent ? getExperienceInfo(event) : null;
            
            // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫Âç≥Â∞áÂà∞‰æÜÁöÑË™≤Á®ã
            const isUpcomingEventFlag = isUpcomingEvent(event);
            const timeUntilEvent = isUpcomingEventFlag ? getTimeUntilEvent(event) : null;
            
            // ÂæûÊ®ôÈ°åËß£ÊûêÊôÇÈñì
            const titleTime = parseTimeFromTitle(event.title);
            
            // Áµ±‰∏Ä‰ΩøÁî® CalDAV ÁöÑÊó•ÊúüÔºåÁ¢∫‰øùÊó•ÊúüÊ≠£Á¢∫
            const displayDate = startDate.toLocaleDateString('zh-TW');
            let timeString;
            
            if (titleTime) {
                // ‰ΩøÁî®Ê®ôÈ°åËß£ÊûêÁöÑÊôÇÈñìÔºå‰ΩÜÊó•Êúü‰ΩøÁî® CalDAV
                timeString = titleTime.timeString;
            } else {
                // ‰ΩøÁî® CalDAV ÁöÑÊôÇÈñì
                timeString = `${startDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })} - ${endDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })}`;
            }
            
            // Ê∏ÖÁêÜÊèèËø∞ÂÖßÂÆπ
            let cleanDescription = event.description || '';
            
            // ÁßªÈô§ÊäÄË°ìÊ®ôÁ±§ÂíåÈáçË§áË≥áË®ä
            cleanDescription = cleanDescription
                .replace(/\[NOTION_SYNC\]/g, '')
                .replace(/ÊôÇÈñì:.*?Ë¨õÂ∏´:/g, '')
                .replace(/Ë¨õÂ∏´:.*?TA:/g, '')
                .replace(/TA:.*?Á¨¨‰∏ÄÊúü:/g, '')
                .replace(/Á¨¨‰∏ÄÊúü:/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            // Â∞ãÊâæÊïôÊ°àÈÄ£Áµê - ÂæûÂéüÂßãÊèèËø∞‰∏≠ÊèêÂèñ
            const notionUrlRegex = /\(https:\/\/www\.notion\.so\/([^)]+)\)/;
            let notionMatch = event.description.match(notionUrlRegex);
            
            // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Êã¨ËôüÂÖßÁöÑÈÄ£ÁµêÔºåÂâáÂåπÈÖç‰∏ÄËà¨ÁöÑ Notion ÈÄ£Áµê
            if (!notionMatch) {
                const generalNotionRegex = /https:\/\/www\.notion\.so\/([^)\s]+)/;
                notionMatch = event.description.match(generalNotionRegex);
            }
            
            let lessonButton = '';
            if (notionMatch) {
                const lessonUrl = `https://www.notion.so/${notionMatch[1]}`;
                
                // ÊèêÂèñÊïôÊ°àÂêçÁ®±ÂíåÈ°ûÂûã
                let lessonName = 'Êü•ÁúãÊïôÊ°à';
                let lessonType = 'ÊïôÊ°à';
                
                // ÂæûÂéüÂßãÊèèËø∞‰∏≠ÊèêÂèñÊïôÊ°àË≥áË®ä
                const originalDescription = event.description;
                
                // ÂåπÈÖçÂêÑÁ®ÆÊïôÊ°àÊ†ºÂºèÔºåÂÑ™ÂÖàÂåπÈÖçÊã¨ËôüÂâçÁöÑÊïôÊ°àÂêçÁ®±
                const lessonMatch = originalDescription.match(/(ESMÊïôÊ°à|SPMÊïôÊ°à|SPIKEÊïôÊ°à|BOOSTÊïôÊ°à|EV3ÊïôÊ°à|MINECRAFTÊïôÊ°à)[:\s]*([^(]+?)(?:\s*\(https:\/\/www\.notion\.so)/);
                if (lessonMatch && lessonMatch[2]) {
                    lessonName = lessonMatch[2].trim();
                    lessonType = lessonMatch[1].replace('ÊïôÊ°à', '');
                }
                
                lessonButton = `
                    <div class="lesson-section">
                        <div class="lesson-label">${lessonType}ÊïôÊ°à</div>
                        <a href="${lessonUrl}" target="_blank" class="lesson-button ${lessonType.toLowerCase()}">
                            <i class="fas fa-book"></i> ${lessonName}
                        </a>
                    </div>
                `;
            }
            
        // ËôïÁêÜ‰ΩçÁΩÆË≥áË®ä
        let location = event.location;
        if (!location || location === 'nan' || location === 'null' || location === '' || location.trim() === '') {
                location = 'Ê®ÇÁ®ãÂùä FunLearnBar';
            }
        
            // Áµ±‰∏ÄÂú∞ÂùÄÁÇ∫Ê®ÇÁ®ãÂùä FunLearnBar
            if (location === 'Á´ôÂâçÊïôÂÆ§' || location === 'Âè∞ÂåóÂ∏Ç‰∏≠Ê≠£ÂçÄÈñãÂ∞ÅË°ó1ÊÆµ2Ëôü9Ê®ì' || location === 'Âè∞ÂåóÂ∏Ç‰∏≠Ê≠£ÂçÄÈñãÂ∞ÅË°ó‰∏ÄÊÆµ2Ëôü9Ê®ì') {
                location = 'Ê®ÇÁ®ãÂùä FunLearnBar';
        }
            
            // Ë¨õÂ∏´Â∫ïËâ≤
            const instructorColor = instructorColors[event.instructor] || '#667eea';
            const instructorStyle = instructorColors[event.instructor] ? 'custom-color' : '';
            
            return `
                <div class="event-card ${isCancelledEvent ? 'cancelled-event' : ''} ${isSubstituteEvent ? 'substitute-event' : ''} ${isExperienceEvent ? 'experience-event' : ''} ${isUpcomingEventFlag ? 'upcoming-event' : ''}"
                     data-event-title="${event.title.replace(/'/g, "\\'")}"
                     data-event-instructor="${event.instructor.replace(/'/g, "\\'")}"
                     data-event-start="${event.start}"
                     data-event-end="${event.end}">
                    <div class="event-header">
                        <div>
                            <div class="event-title">
                                ${event.title}
                                ${isCancelledEvent ? '<span class="cancelled-badge"><i class="fas fa-ban"></i> ‚ö†Ô∏è ÂÅúË™≤ ‚ö†Ô∏è</span>' : ''}
                                ${isSubstituteEvent && substituteInfo ? `<span class="substitute-badge"><i class="fas fa-exchange-alt"></i> ${substituteInfo.type} ${substituteInfo.originalInstructor}</span>` : ''}
                                ${isExperienceEvent && experienceInfo ? `<span class="experience-badge"><i class="fas fa-star"></i> ${experienceInfo.type}</span>` : ''}
                                ${isUpcomingEventFlag ? `<span class="upcoming-badge"><i class="fas fa-clock"></i> Âç≥Â∞á‰∏äË™≤</span>` : ''}
                            </div>
                            <div class="event-instructor ${instructorStyle}" style="--instructor-color: ${instructorColor}">
                                <i class="fas fa-user"></i> ${event.instructor}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-details">
                        <div class="event-detail">
                            <i class="fas fa-calendar"></i>
                            <span>${displayDate} (${getWeekday(startDate)}, Á¨¨${getWeekNumber(startDate)}ÈÄ±)</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-clock"></i>
                            <span>${timeString}</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}" 
                               target="_blank" 
                               class="location-link"
                               title="ÈªûÊìäÊü•ÁúãÂú∞Âúñ">
                                <i class="fas fa-map-marked-alt location-map-icon"></i>
                                <span>${location}</span>
                                <i class="fas fa-external-link-alt location-external-icon"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="countdown-timer" 
                         data-start-time="${event.start}" 
                         data-end-time="${event.end}">
                        <i class="fas fa-clock countdown-icon"></i>
                        <span class="countdown-text">Ë®àÁÆó‰∏≠...</span>
                    </div>
                    
                    <div class="event-description">
                        <h4><i class="fas fa-info-circle"></i> Ë™≤Á®ãÊèèËø∞</h4>
                        <p>${cleanDescription || 'ÁÑ°ÊèèËø∞'}</p>
                    </div>
                    
                    ${lessonButton}
                    
                    <!-- Èï∑ÊåâÊèêÁ§∫ -->
                    <div class="long-press-hint" style="
                        text-align: center; 
                        margin-top: 10px; 
                        font-size: 0.75rem; 
                        color: rgba(51, 51, 51, 0.6);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    ">
                        <i class="fas fa-hand-pointer"></i> Èï∑Êåâ1.5ÁßíÈÄ≤Ë°åÁ∞ΩÂà∞<br>
                        <small style="font-size: 0.6rem; color: rgba(51, 51, 51, 0.4);">
                            0.5ÁßíÈõÜÊ∞£ ‚Üí 1ÁßíÈ†êËºâ ‚Üí 1.5ÁßíÈñãÂïü
                        </small>
                        <small style="font-size: 0.65rem; color: rgba(51, 51, 51, 0.5);">
                            <i class="fas fa-hand-paper"></i> ÁßªÂãïÊâãÊåáÂèØÂèñÊ∂à
                        </small>
                    </div>
                </div>
            `;
        }

        // Êõ¥Êñ∞Áµ±Ë®à‰ø°ÊÅØ
        function updateStats() {
            // Áç≤ÂèñÁï∂ÂâçÁØ©ÈÅ∏Ê¢ù‰ª∂
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            // ÂÖàÈÅéÊøæÊéâ null ÂÄº
            let filteredEvents = allEvents.filter(event => {
                if (!event) return false;
                if (!event.start || !event.end || !event.title || !event.instructor) return false;
                return true;
            });
            
            // ÊáâÁî®Ë¨õÂ∏´ÁØ©ÈÅ∏
            if (instructorFilter) {
                filteredEvents = filteredEvents.filter(event => event.instructor === instructorFilter);
            }
            
            // ÊáâÁî®ÊôÇÊÆµÁØ©ÈÅ∏
                if (timeFilter) {
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    switch (timeFilter) {
                        case 'morning':
                            return hour >= 6 && hour < 12;
                        case 'afternoon':
                            return hour >= 12 && hour < 18;
                        case 'evening':
                            return hour >= 18 && hour < 24;
                        default:
                            return true;
                    }
                });
                }
                
            // ÊáâÁî®ÊåáÂÆöÊó•ÊúüÁØ©ÈÅ∏
                if (dateFilter) {
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    return eventDate.getFullYear() === filterDate.getFullYear() &&
                           eventDate.getMonth() === filterDate.getMonth() &&
                           eventDate.getDate() === filterDate.getDate();
                });
            }
            
            // ÊáâÁî®Ë¶ñÂúñÁØ©ÈÅ∏Ôºà‰ªäÊó•/Êú¨ÈÄ±/Êú¨Êúà/ÂÖ®ÈÉ®Ôºâ
                const now = new Date();
            filteredEvents = filteredEvents.filter(event => {
                const eventDate = new Date(event.start);
                
                switch (currentView) {
                    case '‰ªäÊó•':
                        return eventDate.getFullYear() === now.getFullYear() &&
                               eventDate.getMonth() === now.getMonth() &&
                               eventDate.getDate() === now.getDate();
                    case 'Êú¨ÈÄ±':
                        const weekStart = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        weekStart.setDate(now.getDate() + daysToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        weekEnd.setHours(23, 59, 59, 999);
                        return eventDate >= weekStart && eventDate <= weekEnd;
                    case 'Êú¨Êúà':
                        return eventDate.getFullYear() === now.getFullYear() &&
                               eventDate.getMonth() === now.getMonth();
                    case 'ÂÖ®ÈÉ®':
                    default:
                        return true;
                }
            });
            
            // Ë®àÁÆóÁØ©ÈÅ∏ÂæåÁöÑË¨õÂ∏´Êï∏Èáè
            const uniqueInstructors = new Set(filteredEvents.map(event => event.instructor));
            const instructorCount = uniqueInstructors.size;
            
            // Ë™øË©¶Êó•Ë™åÔºöÈ°ØÁ§∫ÁØ©ÈÅ∏ÁµêÊûú
            console.log(`üìä Áµ±Ë®àÊõ¥Êñ∞ - Ê®°Âºè: ${currentView}, Á∏ΩË™≤Á®ã: ${allEvents.length}, ÁØ©ÈÅ∏Âæå: ${filteredEvents.length}`);
            
            // Ê†πÊìöÁï∂ÂâçÁØ©ÈÅ∏Ê®°ÂºèË®àÁÆóÊó•ÊúüÁØÑÂúç
            let dateRange = '-';
            
            switch (currentView) {
                case '‰ªäÊó•':
                    dateRange = now.toLocaleDateString('zh-TW');
                    break;
                case 'Êú¨ÈÄ±':
                    const weekStart = new Date(now);
                    const dayOfWeek = now.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    weekStart.setDate(now.getDate() + daysToMonday);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    dateRange = `${weekStart.toLocaleDateString('zh-TW')} - ${weekEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case 'Êú¨Êúà':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    dateRange = `${monthStart.toLocaleDateString('zh-TW')} - ${monthEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case 'ÂÖ®ÈÉ®':
                default:
                    if (filteredEvents.length > 0) {
                        const dates = filteredEvents.map(event => new Date(event.start));
                        const minDate = new Date(Math.min(...dates));
                        const maxDate = new Date(Math.max(...dates));
                        dateRange = `${minDate.toLocaleDateString('zh-TW')} - ${maxDate.toLocaleDateString('zh-TW')}`;
                    } else if (allEvents.length > 0) {
                const dates = allEvents.map(event => new Date(event.start));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                        dateRange = `${minDate.toLocaleDateString('zh-TW')} - ${maxDate.toLocaleDateString('zh-TW')}`;
                    }
                    break;
            }
            
            // Êõ¥Êñ∞ÊñáÂ≠óÂΩ¢ÂºèÁöÑÁµ±Ë®à‰ø°ÊÅØ
            const totalEventsText = document.getElementById('totalEventsText');
            const instructorCountText = document.getElementById('instructorCountText');
            const dateRangeText = document.getElementById('dateRangeText');
            
            // ÂãïÁï´Êõ¥Êñ∞Áµ±Ë®àÊï∏Â≠ó
            if (totalEventsText) {
                animateCounter(totalEventsText, `Á∏ΩË™≤Á®ã: ${filteredEvents.length}`);
            }
            if (instructorCountText) {
                animateCounter(instructorCountText, `Ë¨õÂ∏´: ${instructorCount}`);
            }
            if (dateRangeText) {
                animateCounter(dateRangeText, `Êó•Êúü: ${dateRange}`);
            }
            
            // Ëß∏ÁôºÁµ±Ë®àÊõ¥Êñ∞Ë™≤Á®ãÔºåÈÄöÁü•Êá∏ÊµÆÈÅ∏ÂñÆÊõ¥Êñ∞
            document.dispatchEvent(new CustomEvent('statsUpdated'));
        }

        // ÂãïÁï´Êõ¥Êñ∞Ë®àÊï∏Âô®
        function animateCounter(element, newText) {
            if (element.textContent !== newText) {
                // Ê∑ªÂä†ÂãïÁï´È°û
                element.classList.add('animate');
                
                // Êõ¥Êñ∞ÊñáÂ≠ó
                element.textContent = newText;
                
                // ÁßªÈô§ÂãïÁï´È°û
                setTimeout(() => {
                    element.classList.remove('animate');
                }, 600);
            }
        }

        // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
        function showError(message) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `
                <div class="no-events">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>ËºâÂÖ•Â§±Êïó</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâË®≠ÁΩÆÁï´Èù¢
        const settingsOverlay = document.getElementById('settingsOverlay');
        if (settingsOverlay) {
            settingsOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettings();
                }
            });
        }

        // Ë®≠ÁΩÆÊåâÈàïË™≤Á®ãÁõ£ËÅΩÂô®
        document.addEventListener('DOMContentLoaded', function() {
            // ÈóúÈñâË®≠ÁΩÆÊåâÈàï
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', closeSettings);
            }

            // ÂÑ≤Â≠òË®≠ÁΩÆÊåâÈàï
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', saveSettings);
            }
        });

        // Èï∑ÊåâÁ∞ΩÂà∞Ë™≤Á®ãÁõ£ËÅΩÂô®
        let longPressTimer = null;
        let isCharging = false;
        let chargingStartTime = 0;
        let isAnimating = false; // Èò≤Ê≠¢ÂãïÁï´Ë°ùÁ™Å
        
        // Ëß∏ÊéßÊªëÂãïÊ™¢Ê∏¨
        let touchStartPos = { x: 0, y: 0 };
        let touchCurrentPos = { x: 0, y: 0 };
        let isScrolling = false;
        let scrollThreshold = 5; // ÊªëÂãïÈñæÂÄºÔºàÂÉèÁ¥†Ôºâ- ÈÄ≤‰∏ÄÊ≠•Èôç‰Ωé‰ª•ÊèêÈ´òÁ≤æÂ∫¶
        let touchStartTime = 0;
        let touchDuration = 0;
        let isTouchActive = false;
        let touchCancelThreshold = 25; // Ëß∏ÊéßÂèñÊ∂àÈñæÂÄºÔºàÂÉèÁ¥†Ôºâ- ÊèêÈ´òÈõ£Â∫¶
        let isTouchCancelled = false;
        
        // Ê®°ÊÖãÊ°ÜÁãÄÊÖãËøΩËπ§
        let currentAttendanceModal = null;
        let isModalLoading = false;
        let isStudentListLoading = false;
        let studentListLoadPromise = null;

        // È°ØÁ§∫Â≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπ
        function showStudentAttendance() {
            console.log('üë• È°ØÁ§∫Â≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπ');
            
            // Áç≤ÂèñÊ®°ÊÖãÊ°ÜÂÖßÂÆπ
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // ÁßªÈô§Â∑¶ÁßªÂãïÁï´È°ûÂà•ÔºåÂõûÂà∞ÂéüÂßãÂ≠∏ÁîüÁ∞ΩÂà∞Áï´Èù¢
            modalContent.classList.remove('slide-left');
            
            // Ê™¢Êü•Â≠∏ÁîüÂêçÂñÆÊòØÂê¶Ê≠£Âú®ËºâÂÖ•‰∏≠
            if (isStudentListLoading) {
                console.log('‚è≥ Â≠∏ÁîüÂêçÂñÆÊ≠£Âú®ËºâÂÖ•‰∏≠ÔºåÈ°ØÁ§∫ËºâÂÖ•Áï´Èù¢');
                showStudentLoadingState();
            } else if (studentListLoadPromise) {
                console.log('‚è≥ Á≠âÂæÖÂ≠∏ÁîüÂêçÂñÆËºâÂÖ•ÂÆåÊàê');
                showStudentLoadingState();
                // Á≠âÂæÖËºâÂÖ•ÂÆåÊàê
                studentListLoadPromise.then(() => {
                    console.log('‚úÖ Â≠∏ÁîüÂêçÂñÆËºâÂÖ•ÂÆåÊàêÔºåÊÅ¢Âæ©Ê≠£Â∏∏Áï´Èù¢');
                    hideStudentLoadingState();
                    // ÈáçÊñ∞ËºâÂÖ•Â≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπ
                    restoreStudentAttendanceContent();
                });
            } else {
                console.log('‚úÖ Â≠∏ÁîüÂêçÂñÆÂ∑≤ËºâÂÖ•ÂÆåÊàêÔºåÈ°ØÁ§∫Ê≠£Â∏∏Áï´Èù¢');
                hideStudentLoadingState();
                // ÈáçÊñ∞ËºâÂÖ•Â≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπ
                restoreStudentAttendanceContent();
            }
        }

        // ÊÅ¢Âæ©Â≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπ
        function restoreStudentAttendanceContent() {
            console.log('üîÑ ÊÅ¢Âæ©Â≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπ');
            
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // ÈáçÊñ∞ÂâµÂª∫ÂéüÂßãÁöÑÂ≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπÁµêÊßã
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <h2 style="margin: 0; color: #333333; font-size: 1.5rem; text-shadow: none;">
                            <i class="fas fa-calendar-check" style="color: #b8860b; margin-right: 10px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                            Ë™≤Á®ãÁ∞ΩÂà∞Á≥ªÁµ±
                        </h2>
                    </div>
                    <button id="closeAttendanceModal" class="close-attendance-modal" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 215, 0, 0.4);
                        font-size: 1.5rem;
                        color: #333333;
                        cursor: pointer;
                        padding: 5px;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s ease;
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                    ">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="course-info" style="
                    margin-bottom: 20px; 
                    padding: 20px; 
                    background: 
                        radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.05) 0%, transparent 70%),
                        linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
                    border-radius: 15px; 
                    border: 1px solid rgba(255, 215, 0, 0.3);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    box-shadow: 
                        0 8px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
                ">
                    <div class="course-info-panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                        <div data-field="teacher" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">Ë¨õÂ∏´:</strong> <span id="currentTeacher">ËºâÂÖ•‰∏≠...</span></div>
                        <div data-field="course" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">Ë™≤Á®ã:</strong> <span id="currentCourse">ËºâÂÖ•‰∏≠...</span></div>
                        <div data-field="time" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">ÊôÇÈñì:</strong> <span id="currentTime">ËºâÂÖ•‰∏≠...</span></div>
                        <div data-field="date" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">Êó•Êúü:</strong> <span id="currentDate">ËºâÂÖ•‰∏≠...</span></div>
                    </div>
                </div>
                
                <div id="attendanceContent">
                    <div style="text-align: center; padding: 60px 40px; color: #333333; background: linear-gradient(135deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05)); border-radius: 15px; transition: all 0.5s ease;">
                        <!-- Âç°ÁâåËºâÂÖ•ÂãïÁï´ -->
                        <div style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            gap: 10px;
                            margin-bottom: 30px;
                            perspective: 1000px;
                        ">
                            <div style="
                                width: 20px;
                                height: 30px;
                                background: linear-gradient(135deg, #b8860b, #daa520);
                                border-radius: 4px;
                                animation: cardBounceIn 0.6s ease-out infinite;
                                animation-delay: 0s;
                                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                            "></div>
                            <div style="
                                width: 20px;
                                height: 30px;
                                background: linear-gradient(135deg, #b8860b, #daa520);
                                border-radius: 4px;
                                animation: cardBounceIn 0.6s ease-out infinite;
                                animation-delay: 0.1s;
                                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                            "></div>
                            <div style="
                                width: 20px;
                                height: 30px;
                                background: linear-gradient(135deg, #b8860b, #daa520);
                                border-radius: 4px;
                                animation: cardBounceIn 0.6s ease-out infinite;
                                animation-delay: 0.2s;
                                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                            "></div>
                        </div>
                        <h3 style="margin: 0; color: rgba(255, 255, 255, 0.95); text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);">
                            <i class="fas fa-spinner" style="color: #ffd700; margin-right: 8px; animation: spin 1s linear infinite;"></i>
                            ËºâÂÖ•Â≠∏ÁîüÂêçÂñÆ‰∏≠...
                        </h3>
                        <p style="margin: 10px 0; color: rgba(255, 255, 255, 0.7);">
                            Ê≠£Âú®ÂæûË≥áÊñôÂ∫´ËºâÂÖ•Â≠∏ÁîüË≥áÊñôÔºåË´ãÁ®çÂÄô
                        </p>
                    </div>
                </div>
            `;
            
            // ÈáçÊñ∞Ë®≠ÁΩÆÈóúÈñâÊåâÈàï‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const closeBtn = document.getElementById('closeAttendanceModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    closeAttendanceModal();
                });
            }
            
            // ÈáçÊñ∞ËºâÂÖ•Â≠∏ÁîüË≥áÊñô
            if (window.currentAttendanceData) {
                const { teacher, course, time, start, end, minutesUntilStart } = window.currentAttendanceData;
                loadCourseStudents(teacher, course, time, start, end, minutesUntilStart);
            }
        }

        // È°ØÁ§∫Â≠∏ÁîüËºâÂÖ•ÁãÄÊÖã
        function showStudentLoadingState() {
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // ÂâµÂª∫ËºâÂÖ•ÈÅÆÁΩ©
            let loadingOverlay = modalContent.querySelector('.student-loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'student-loading-overlay';
                loadingOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255, 255, 255, 0.95);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    backdrop-filter: blur(5px);
                `;
                loadingOverlay.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 40px;
                        color: #666;
                        font-size: 1.1rem;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 15px;
                    ">
                        <i class="fas fa-spinner" style="
                            color: #FFD700;
                            font-size: 2rem;
                            animation: spin 1s linear infinite;
                        "></i>
                        <div class="loading-text" style="font-weight: 500;">ËºâÂÖ•Â≠∏ÁîüÂêçÂñÆ‰∏≠...</div>
                        <div style="font-size: 0.9rem; color: #999;">Ë´ãÁ®çÂÄôÔºåËºâÂÖ•ÂÆåÊàêÂæåÊúÉËá™ÂãïÈ°ØÁ§∫</div>
                    </div>
                `;
                modalContent.appendChild(loadingOverlay);
            }
            loadingOverlay.style.display = 'flex';
        }

        // Èö±ËóèÂ≠∏ÁîüËºâÂÖ•ÁãÄÊÖã
        function hideStudentLoadingState() {
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            const loadingOverlay = modalContent.querySelector('.student-loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }


        // È°ØÁ§∫Ë¨õÂ∏´Á∞ΩÂà∞ÂÖßÂÆπ
        function showTeacherAttendance() {
            console.log('üë®‚Äçüè´ È°ØÁ§∫Ë¨õÂ∏´Á∞ΩÂà∞ÂÖßÂÆπ');
            
            // Áç≤ÂèñÊ®°ÊÖãÊ°ÜÂÖßÂÆπ
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // Ê∑ªÂä†Â∑¶ÁßªÂãïÁï´È°ûÂà•
            modalContent.classList.add('slide-left');
            
            // ÂâµÂª∫Ë¨õÂ∏´Â†±Ë°®ÂÖßÂÆπ
            const teacherAttendanceContent = document.createElement('div');
            teacherAttendanceContent.className = 'teacher-attendance-content';
            teacherAttendanceContent.innerHTML = `
                <div class="teacher-attendance-header">
                    <h2 style="
                        margin: 0 0 20px 0;
                        color: #333;
                        text-align: center;
                        font-size: 1.5rem;
                        font-weight: 700;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                    ">
                        <i class="fas fa-clipboard-list" style="color: #ffd700;"></i>
                        Ë¨õÂ∏´Â†±Ë°®
                    </h2>
                </div>
                
                <!-- ‰ªäÊó•Â†±Ë°® -->
                <div class="today-report-section">
                    <h3 style="
                        color: #555;
                        margin: 20px 0 15px 0;
                        font-size: 1.2rem;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-calendar-day"></i>
                        ‰ªäÊó•Â†±Ë°®
                    </h3>
                    
                    <div class="report-form">
                        <div class="form-group">
                            <label for="course-content" style="
                                display: block;
                                margin-bottom: 8px;
                                font-weight: 600;
                                color: #333;
                            ">Ë™≤Á®ãÂÖßÂÆπÔºö</label>
                            <textarea 
                                id="course-content" 
                                placeholder="Ë´ãÊèèËø∞‰ªäÂ§©ÁöÑË™≤Á®ãÂÖßÂÆπ..."
                                rows="4"
                                maxlength="500"
                                style="
                                    width: 100%;
                                    padding: 12px;
                                    border: 2px solid #e9ecef;
                                    border-radius: 8px;
                                    font-size: 1rem;
                                    font-family: inherit;
                                    resize: vertical;
                                    transition: border-color 0.3s ease;
                                "
                            ></textarea>
                            <div class="char-count" style="
                                text-align: right;
                                margin-top: 5px;
                                font-size: 0.85rem;
                                color: #666;
                            ">
                                <span id="char-count">0</span>/500
                            </div>
                        </div>
                        
                        <!-- Ë∫´‰ªΩÈÅ∏Êìá -->
                        <div class="assistant-toggle" style="
                            margin: 20px 0;
                            padding: 20px;
                            background: #f8f9fa;
                            border-radius: 12px;
                            border: 1px solid #e9ecef;
                        ">
                            <div class="mode-header">
                                <h4 style="
                                    margin: 0 0 8px 0;
                                    color: #333;
                                    font-size: 1.1rem;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-users"></i>
                                    Ë∫´‰ªΩÈÅ∏Êìá
                                </h4>
                                <p class="mode-description" style="
                                    margin: 0 0 15px 0;
                                    color: #666;
                                    font-size: 0.9rem;
                                ">Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑË∫´‰ªΩ‰ª•Ê≠£Á¢∫Ë®≠ÂÆö‰∫∫Êï∏</p>
                            </div>
                            <div class="mode-buttons" style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 15px;
                                margin-bottom: 15px;
                            ">
                                <button class="mode-btn teacher-mode active" id="teacher-mode-btn" style="
                                    background: linear-gradient(135deg, #ffd700, #ffed4e);
                                    color: #333;
                                    border: 2px solid #ffd700;
                                    padding: 15px;
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    text-align: center;
                                ">
                                    <i class="fas fa-chalkboard-teacher" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i>
                                    <div class="mode-title" style="font-weight: 600; margin-bottom: 4px;">Ë¨õÂ∏´Ê®°Âºè</div>
                                    <div class="mode-desc" style="font-size: 0.8rem; opacity: 0.8;">‰∫∫Êï∏Ê†πÊìöÂ≠∏ÁîüÊï∏ÈáèË®àÁÆó</div>
                                </button>
                                <button class="mode-btn assistant-mode" id="assistant-mode-btn" style="
                                    background: #f8f9fa;
                                    color: #666;
                                    border: 2px solid #e9ecef;
                                    padding: 15px;
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    text-align: center;
                                ">
                                    <i class="fas fa-user-graduate" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i>
                                    <div class="mode-title" style="font-weight: 600; margin-bottom: 4px;">Âä©ÊïôÊ®°Âºè</div>
                                    <div class="mode-desc" style="font-size: 0.8rem; opacity: 0.8;">‰∫∫Êï∏Ëá™ÂãïË®≠ÁÇ∫ 0</div>
                                </button>
                            </div>
                            <div class="current-mode-display" style="
                                text-align: center;
                                padding: 10px;
                                background: rgba(255, 215, 0, 0.1);
                                border-radius: 8px;
                                font-size: 0.9rem;
                            ">
                                <span class="mode-label" style="color: #666;">ÁõÆÂâçÊ®°ÂºèÔºö</span>
                                <span class="mode-value" id="current-mode-display" style="font-weight: 600; color: #333;">Ë¨õÂ∏´Ê®°Âºè</span>
                            </div>
                        </div>
                        
                        <!-- Êèê‰∫§ÊåâÈàï -->
                        <div class="report-actions" style="
                            margin-top: 30px;
                            text-align: center;
                        ">
                            <button class="btn-primary" id="submitTeacherReport" style="
                                background: linear-gradient(135deg, #28a745, #20c997);
                                color: white;
                                border: none;
                                padding: 15px 40px;
                                border-radius: 25px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                            ">
                                <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>
                                Êèê‰∫§Ë¨õÂ∏´Â†±Ë°®
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ê∏ÖÁ©∫ÂéüÊúâÂÖßÂÆπ‰∏¶Ê∑ªÂä†Ë¨õÂ∏´Â†±Ë°®ÂÖßÂÆπ
            modalContent.innerHTML = '';
            modalContent.appendChild(teacherAttendanceContent);
            
            // ÂàùÂßãÂåñË¨õÂ∏´Â†±Ë°®ÂäüËÉΩ
            initializeTeacherReport();
            
            // Â¶ÇÊûúÂ≠∏ÁîüÂêçÂñÆÊ≠£Âú®ËºâÂÖ•‰∏≠ÔºåÂú®ËÉåÊôØÊåÅÁ∫åËºâÂÖ•
            if (isStudentListLoading && !studentListLoadPromise) {
                console.log('üîÑ Â≠∏ÁîüÂêçÂñÆÊ≠£Âú®ËºâÂÖ•‰∏≠ÔºåÂú®ËÉåÊôØÊåÅÁ∫åËºâÂÖ•...');
                startBackgroundStudentLoading();
            }
        }

        // ÈñãÂßãËÉåÊôØËºâÂÖ•Â≠∏ÁîüÂêçÂñÆ
        function startBackgroundStudentLoading() {
            console.log('üîÑ ÈñãÂßãËÉåÊôØËºâÂÖ•Â≠∏ÁîüÂêçÂñÆ...');
            
            studentListLoadPromise = new Promise((resolve) => {
                // Ê®°Êì¨ËºâÂÖ•ÈÅéÁ®ã
                setTimeout(() => {
                    console.log('‚úÖ ËÉåÊôØËºâÂÖ•Â≠∏ÁîüÂêçÂñÆÂÆåÊàê');
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    // È°ØÁ§∫ËºâÂÖ•ÂÆåÊàêÈÄöÁü•
                    showToast('Â≠∏ÁîüÂêçÂñÆËºâÂÖ•ÂÆåÊàêÔºÅ', 'success');
                    
                    resolve();
                }, 3000); // 3ÁßíËºâÂÖ•ÊôÇÈñì
            });
        }

        // ÂàùÂßãÂåñË¨õÂ∏´Â†±Ë°®ÂäüËÉΩ
        function initializeTeacherReport() {
            console.log('üìù ÂàùÂßãÂåñË¨õÂ∏´Â†±Ë°®ÂäüËÉΩ');
            
            // Ë®≠ÁΩÆÂ≠óÊï∏Áµ±Ë®à
            const courseContent = document.getElementById('course-content');
            const charCount = document.getElementById('char-count');
            
            if (courseContent && charCount) {
                courseContent.addEventListener('input', function() {
                    const count = this.value.length;
                    charCount.textContent = count;
                    
                    // Â≠óÊï∏Êé•ËøëÈôêÂà∂ÊôÇËÆäËâ≤
                    if (count > 450) {
                        charCount.style.color = '#dc3545';
                    } else if (count > 400) {
                        charCount.style.color = '#ffc107';
                    } else {
                        charCount.style.color = '#666';
                    }
                });
            }
            
            // Ë®≠ÁΩÆË∫´‰ªΩÈÅ∏ÊìáÊåâÈàï
            const teacherModeBtn = document.getElementById('teacher-mode-btn');
            const assistantModeBtn = document.getElementById('assistant-mode-btn');
            const currentModeDisplay = document.getElementById('current-mode-display');
            
            if (teacherModeBtn && assistantModeBtn && currentModeDisplay) {
                teacherModeBtn.addEventListener('click', () => {
                    setTeacherMode();
                });
                
                assistantModeBtn.addEventListener('click', () => {
                    setAssistantMode();
                });
            }
            
            // Ë®≠ÁΩÆÊèê‰∫§ÊåâÈàï
            const submitBtn = document.getElementById('submitTeacherReport');
            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    submitTeacherReport();
                });
            }
        }

        // Ë®≠ÁΩÆË¨õÂ∏´Ê®°Âºè
        function setTeacherMode() {
            console.log('üë®‚Äçüè´ Ë®≠ÁΩÆË¨õÂ∏´Ê®°Âºè');
            
            const teacherModeBtn = document.getElementById('teacher-mode-btn');
            const assistantModeBtn = document.getElementById('assistant-mode-btn');
            const currentModeDisplay = document.getElementById('current-mode-display');
            
            if (teacherModeBtn && assistantModeBtn && currentModeDisplay) {
                // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
                teacherModeBtn.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                teacherModeBtn.style.color = '#333';
                teacherModeBtn.style.border = '2px solid #ffd700';
                
                assistantModeBtn.style.background = '#f8f9fa';
                assistantModeBtn.style.color = '#666';
                assistantModeBtn.style.border = '2px solid #e9ecef';
                
                // Êõ¥Êñ∞È°ØÁ§∫
                currentModeDisplay.textContent = 'Ë¨õÂ∏´Ê®°Âºè';
            }
        }

        // Ë®≠ÁΩÆÂä©ÊïôÊ®°Âºè
        function setAssistantMode() {
            console.log('üë®‚Äçüéì Ë®≠ÁΩÆÂä©ÊïôÊ®°Âºè');
            
            const teacherModeBtn = document.getElementById('teacher-mode-btn');
            const assistantModeBtn = document.getElementById('assistant-mode-btn');
            const currentModeDisplay = document.getElementById('current-mode-display');
            
            if (teacherModeBtn && assistantModeBtn && currentModeDisplay) {
                // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
                assistantModeBtn.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
                assistantModeBtn.style.color = 'white';
                assistantModeBtn.style.border = '2px solid #6c757d';
                
                teacherModeBtn.style.background = '#f8f9fa';
                teacherModeBtn.style.color = '#666';
                teacherModeBtn.style.border = '2px solid #e9ecef';
                
                // Êõ¥Êñ∞È°ØÁ§∫
                currentModeDisplay.textContent = 'Âä©ÊïôÊ®°Âºè';
            }
        }

        // Êèê‰∫§Ë¨õÂ∏´Â†±Ë°®
        async function submitTeacherReport() {
            try {
                console.log('üì§ Êèê‰∫§Ë¨õÂ∏´Â†±Ë°®');
                
                const courseContent = document.getElementById('course-content');
                const currentModeDisplay = document.getElementById('current-mode-display');
                const submitBtn = document.getElementById('submitTeacherReport');
                
                if (!courseContent || !courseContent.value.trim()) {
                    showToast('Ë´ãÂ°´ÂØ´Ë™≤Á®ãÂÖßÂÆπ', 'error');
                    return;
                }
                
                // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Êèê‰∫§‰∏≠...';
                    submitBtn.disabled = true;
                }
                
                // Ê®°Êì¨APIË™øÁî®
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                const mode = currentModeDisplay ? currentModeDisplay.textContent : 'Ë¨õÂ∏´Ê®°Âºè';
                showToast(`Ë¨õÂ∏´Â†±Ë°®Êèê‰∫§ÊàêÂäüÔºÅ(${mode})`, 'success');
                
                // ÈáçÁΩÆË°®ÂñÆ
                if (courseContent) {
                    courseContent.value = '';
                }
                
                const charCount = document.getElementById('char-count');
                if (charCount) {
                    charCount.textContent = '0';
                    charCount.style.color = '#666';
                }
                
                // ÈáçÁΩÆÊåâÈàï
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Êèê‰∫§Ë¨õÂ∏´Â†±Ë°®';
                    submitBtn.disabled = false;
                }
                
                console.log('‚úÖ Ë¨õÂ∏´Â†±Ë°®Êèê‰∫§ÂÆåÊàê');
                
            } catch (error) {
                console.error('‚ùå Ë¨õÂ∏´Â†±Ë°®Êèê‰∫§Â§±Êïó:', error);
                showToast('Ë¨õÂ∏´Â†±Ë°®Êèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                
                // ÈáçÁΩÆÊåâÈàï
                const submitBtn = document.getElementById('submitTeacherReport');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Êèê‰∫§Ë¨õÂ∏´Â†±Ë°®';
                    submitBtn.disabled = false;
                }
            }
        }

        // ÈóúÈñâÁ∞ΩÂà∞Ê®°ÊÖãÊ°Ü
        function closeAttendanceModal() {
            if (currentAttendanceModal) {
                console.log('‚ùå ÈóúÈñâÁ∞ΩÂà∞Ê®°ÊÖãÊ°Ü');
                currentAttendanceModal.remove();
                currentAttendanceModal = null;
                isModalLoading = false;
                
                // ÁßªÈô§Êá∏ÊµÆÂ∞éËà™Âô®
                const floatingNavigator = document.querySelector('.floating-navigator');
                if (floatingNavigator) {
                    floatingNavigator.remove();
                    console.log('‚úÖ Êá∏ÊµÆÂ∞éËà™Âô®Â∑≤ÁßªÈô§');
                }
                
                // ÈáçÁΩÆËß∏ÊéßÁãÄÊÖã
                isCharging = false;
                isTouchActive = false;
                isTouchCancelled = false;
                isScrolling = false;
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // ÈáçÁΩÆÈÄöÁü•ÁãÄÊÖã
                attendanceNotificationSent = false;
                studentAttendanceStatus = {};
                if (attendanceCheckTimer) {
                    clearTimeout(attendanceCheckTimer);
                    attendanceCheckTimer = null;
                }
                
                // Ê∏ÖÈô§ÊâÄÊúâÂèØËÉΩÁöÑËºâÂÖ•ÁãÄÊÖã
                const loadingElements = document.querySelectorAll('.attendance-loading, .loading-spinner');
                loadingElements.forEach(el => el.remove());
                
                // Ê∏ÖÈô§ÊâÄÊúâ‰∫ã‰ª∂Âç°ÁâáÁöÑÂãïÁï´ÁãÄÊÖã
                const eventCards = document.querySelectorAll('.event-card');
                eventCards.forEach(card => {
                    card.classList.remove('pressing', 'charging', 'releasing', 'completing');
                    card.style.animation = '';
                    card.style.transition = '';
                });
                
                console.log('‚úÖ Ê®°ÊÖãÊ°ÜÁãÄÊÖãÂ∑≤ÂÆåÂÖ®ÈáçÁΩÆ');
            }
        }

        // ÈúáÂãïÂõûÈ•ãÂáΩÊï∏
        function triggerHapticFeedback(type) {
            // Ê™¢Êü•ÊòØÂê¶ÊîØÊè¥ÈúáÂãïAPI
            if (!navigator.vibrate) {
                console.log('üì± Ë®≠ÂÇô‰∏çÊîØÊè¥ÈúáÂãïÂäüËÉΩ');
                return;
            }

            // Ê™¢Êü•ÊòØÂê¶Âú®ÊâãÊ©üÁ´Ø
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (!isMobile) {
                console.log('üíª ÈùûÊâãÊ©üË®≠ÂÇôÔºåË∑≥ÈÅéÈúáÂãï');
                return;
            }

            try {
                switch (type) {
                    case 'start':
                        // ÈñãÂßãÈõÜÊ∞£ÔºöËºïÂæÆÈúáÂãï
                        navigator.vibrate(30);
                        console.log('üì≥ ÈúáÂãïÂõûÈ•ãÔºöÈñãÂßãÈõÜÊ∞£');
                        break;
                    case 'loading':
                        // ËºâÂÖ•‰∏≠ÔºöÊº∏Âº∑ÈúáÂãï
                        navigator.vibrate([40, 60, 40]);
                        console.log('üì≥ ÈúáÂãïÂõûÈ•ãÔºöËºâÂÖ•‰∏≠');
                        break;
                    case 'complete':
                        // ÂÆåÊàêÔºöÂº∑ÁÉàÈúáÂãï
                        navigator.vibrate([80, 50, 80]);
                        console.log('üì≥ ÈúáÂãïÂõûÈ•ãÔºöÂÆåÊàê');
                        break;
                    case 'release':
                        // ÈáãÊîæÔºöËºïÂæÆÈúáÂãï
                        navigator.vibrate(20);
                        console.log('üì≥ ÈúáÂãïÂõûÈ•ãÔºöÈáãÊîæ');
                        break;
                    default:
                        // È†êË®≠ÔºöÁü≠ÈúáÂãï
                        navigator.vibrate(50);
                        console.log('üì≥ ÈúáÂãïÂõûÈ•ãÔºöÈ†êË®≠');
                }
            } catch (error) {
                console.warn('üì≥ ÈúáÂãïÂäüËÉΩÂü∑Ë°åÂ§±Êïó:', error);
            }
        }

        document.addEventListener('mousedown', function(e) {
            // Á¢∫‰øù e.target Êúâ closest ÊñπÊ≥ï
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && !eventCard.classList.contains('charging')) {
                const title = eventCard.dataset.eventTitle;
                const instructor = eventCard.dataset.eventInstructor;
                const start = eventCard.dataset.eventStart;
                const end = eventCard.dataset.eventEnd;
                
                if (title && instructor && start && end) {
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂÅúË™≤Ë™≤Á®ã
                    if (eventCard.classList.contains('cancelled-event')) {
                        console.log('‚ö†Ô∏è ÂÅúË™≤Ë™≤Á®ãÁÑ°Ê≥ïÁ∞ΩÂà∞');
                        alert('‚ö†Ô∏è Ê≠§Ë™≤Á®ãÂ∑≤ÂÅúË™≤ÔºåÁÑ°Ê≥ïÈÄ≤Ë°åÁ∞ΩÂà∞');
                        return;
                    }
                    
                    // ÈñãÂßãÈï∑ÊåâË®àÊôÇ
                    chargingStartTime = Date.now();
                    isCharging = true;
                    
                    // Á´ãÂç≥Ê∑ªÂä†ÊåâÂ£ìÊïàÊûú
                    eventCard.classList.add('pressing');
                    
                    // ÈúáÂãïÂõûÈ•ãÔºöÈñãÂßãÊåâÂ£ì
                    triggerHapticFeedback('start');
                    
                    // 0.3ÁßíÂæåÈñãÂßãÈõÜÊ∞£ÂÖÖËÉΩÊïàÊûú
                    longPressTimer = setTimeout(() => {
                        if (isCharging) {
                            console.log('üîã Ëß∏ÁôºÂÖÖÈõªÂãïÁï´ÔºåÁßªÈô§ pressing È°ûÂà•ÔºåÊ∑ªÂä† charging È°ûÂà•');
                            eventCard.classList.remove('pressing');
                            eventCard.classList.add('charging');
                            console.log('üîã ÈñãÂßãÈõÜÊ∞£ÂÖÖËÉΩ...');
                            console.log('üîã Áï∂ÂâçË™≤Á®ãÂç°ÁâáÈ°ûÂà•:', eventCard.className);
                            
                            // ÈúáÂãïÂõûÈ•ãÔºöÈñãÂßãÈõÜÊ∞£
                            triggerHapticFeedback('start');
                            
                            // 0.5ÁßíÂæåÈñãÂßãÈõÜÊ∞£ÂÖÖËÉΩÊïàÊûú
                            longPressTimer = setTimeout(() => {
                                if (isCharging) {
                                    console.log('üîã ÊªëÈº†Ë®≠ÂÇôËß∏ÁôºÂÖÖÈõªÂãïÁï´ÔºåÁßªÈô§ pressing È°ûÂà•ÔºåÊ∑ªÂä† charging È°ûÂà•');
                                    eventCard.classList.remove('pressing');
                                    eventCard.classList.add('charging');
                                    console.log('üîã ÈñãÂßãÈõÜÊ∞£ÂÖÖËÉΩ...');
                                    console.log('üîã Áï∂ÂâçË™≤Á®ãÂç°ÁâáÈ°ûÂà•:', eventCard.className);
                                    
                                    // ÈúáÂãïÂõûÈ•ãÔºöÈñãÂßãÈõÜÊ∞£
                                    triggerHapticFeedback('start');
                                    
                                    // 1ÁßíÂæåÈñãÂßãÂæåÁ´ØÈ†êËºâÂÖ•Ôºà0.5ÁßíÂæåÔºâ
                                    setTimeout(() => {
                                        if (isCharging) {
                                            console.log('üìö ÈñãÂßãÂæåÁ´ØÈ†êËºâÂÖ•Â≠∏ÁîüË≥áÊñô...');
                                            // ÈúáÂãïÂõûÈ•ãÔºöËºâÂÖ•‰∏≠
                                            triggerHapticFeedback('loading');
                                        }
                                    }, 500);
                                    
                                    // 1.5ÁßíÂæåË∑≥Âá∫ËºâÂÖ•ÂãïÁï´Ôºà1ÁßíÂæåÔºâ
                                    setTimeout(() => {
                                        if (isCharging) {
                                            console.log('üöÄ Ë∑≥Âá∫ËºâÂÖ•Áï´Èù¢');
                                            eventCard.classList.remove('charging');
                                            // ÈúáÂãïÂõûÈ•ãÔºöÂÆåÊàê
                                            triggerHapticFeedback('complete');
                                            handleDirectAttendance(title, instructor, start, end);
                                        }
                                    }, 1000);
                                }
                            }, 500);
                        }
                    }, 300);
                }
            }
        });

        document.addEventListener('mouseup', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && (longPressTimer || isCharging)) {
                // Èò≤Ê≠¢ÈáçË§áËß∏Áôº
                if (isAnimating) return;
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                if (isCharging) {
                    isAnimating = true;
                    
                    // ÈúáÂãïÂõûÈ•ãÔºöÈáãÊîæ
                    triggerHapticFeedback('release');
                    
                    // ÂÑ™ÂåñÁöÑÈáãÊîæÂãïÁï´ÈÇèËºØ
                    eventCard.classList.remove('charging', 'pressing');
                    eventCard.classList.add('releasing');
                    
                    // ÂãïÁï´ÂÆåÊàêÂæåÊ∑ªÂä†ÈÅéÊ∏°ÁãÄÊÖãÔºåÁÑ∂ÂæåÂπ≥ÊªëÁßªÈô§
                    setTimeout(() => {
                        eventCard.classList.add('completing');
                        setTimeout(() => {
                            eventCard.classList.remove('releasing', 'completing');
                            // Ê∏ÖÈô§ÊâÄÊúâÂãïÁï´Áõ∏ÈóúÁöÑÊ®£Âºè
                            eventCard.style.animation = '';
                            eventCard.style.transition = '';
                            isAnimating = false;
                            console.log('‚úÖ ÊªëÈº†ÈáãÊîæÂãïÁï´ÂÆåÊàê');
                        }, 200);
                    }, 400);
                    
                    console.log('‚ùå Èï∑Êåâ‰∏≠Êñ∑ÔºåÊí≠ÊîæÈáãÊîæÂãïÁï´');
                } else {
                    eventCard.classList.remove('pressing');
                    console.log('‚ùå Èï∑Êåâ‰∏≠Êñ∑');
                }
                
                isCharging = false;
            }
        });

        document.addEventListener('mouseleave', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && (longPressTimer || isCharging)) {
                // Èò≤Ê≠¢ÈáçË§áËß∏Áôº
                if (isAnimating) return;
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                if (isCharging) {
                    isAnimating = true;
                    
                    // ÈúáÂãïÂõûÈ•ãÔºöÈáãÊîæ
                    triggerHapticFeedback('release');
                    
                    // ÂÑ™ÂåñÁöÑÈáãÊîæÂãïÁï´ÈÇèËºØ
                    eventCard.classList.remove('charging', 'pressing');
                    eventCard.classList.add('releasing');
                    
                    // ÂãïÁï´ÂÆåÊàêÂæåÊ∑ªÂä†ÈÅéÊ∏°ÁãÄÊÖãÔºåÁÑ∂ÂæåÂπ≥ÊªëÁßªÈô§
                    setTimeout(() => {
                        eventCard.classList.add('completing');
                        setTimeout(() => {
                            eventCard.classList.remove('releasing', 'completing');
                            // Ê∏ÖÈô§ÊâÄÊúâÂãïÁï´Áõ∏ÈóúÁöÑÊ®£Âºè
                            eventCard.style.animation = '';
                            eventCard.style.transition = '';
                            isAnimating = false;
                            console.log('‚úÖ ÊªëÈº†Èõ¢ÈñãÈáãÊîæÂãïÁï´ÂÆåÊàê');
                        }, 200);
                    }, 400);
                    
                    console.log('‚ùå ÊªëÈº†Èõ¢ÈñãÔºåÊí≠ÊîæÈáãÊîæÂãïÁï´');
                } else {
                    eventCard.classList.remove('pressing');
                    console.log('‚ùå ÊªëÈº†Èõ¢ÈñãÔºåÈï∑Êåâ‰∏≠Êñ∑');
                }
                
                isCharging = false;
            }
        });

        // Ëß∏ÊéßË®≠ÂÇôÊîØÊè¥
        document.addEventListener('touchstart', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && !eventCard.classList.contains('charging')) {
                const title = eventCard.dataset.eventTitle;
                const instructor = eventCard.dataset.eventInstructor;
                const start = eventCard.dataset.eventStart;
                const end = eventCard.dataset.eventEnd;
                
                if (title && instructor && start && end) {
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂÅúË™≤Ë™≤Á®ã
                    if (eventCard.classList.contains('cancelled-event')) {
                        console.log('‚ö†Ô∏è ÂÅúË™≤Ë™≤Á®ãÁÑ°Ê≥ïÁ∞ΩÂà∞ÔºàËß∏ÊéßÔºâ');
                        alert('‚ö†Ô∏è Ê≠§Ë™≤Á®ãÂ∑≤ÂÅúË™≤ÔºåÁÑ°Ê≥ïÈÄ≤Ë°åÁ∞ΩÂà∞');
                        return;
                    }
                    
                    // Ë®òÈåÑËß∏ÊéßÈñãÂßã‰ΩçÁΩÆÂíåÊôÇÈñì
                    const touch = e.touches[0];
                    touchStartPos.x = touch.clientX;
                    touchStartPos.y = touch.clientY;
                    touchCurrentPos.x = touch.clientX;
                    touchCurrentPos.y = touch.clientY;
                    touchStartTime = Date.now();
                    isScrolling = false;
                    isTouchActive = true;
                    isTouchCancelled = false;
                    
                    chargingStartTime = Date.now();
                    isCharging = true;
                    
                    // Á´ãÂç≥Ê∑ªÂä†ÊåâÂ£ìÊïàÊûú
                    eventCard.classList.add('pressing');
                    
                    // ÈúáÂãïÂõûÈ•ãÔºöÈñãÂßãÊåâÂ£ì
                    triggerHapticFeedback('start');
                    
                    // 0.5ÁßíÂæåÈñãÂßãÈõÜÊ∞£ÂÖÖËÉΩÊïàÊûú
                    longPressTimer = setTimeout(() => {
                        if (isCharging && !isScrolling) {
                            console.log('üîã Ëß∏ÊéßË®≠ÂÇôËß∏ÁôºÂÖÖÈõªÂãïÁï´ÔºåÁßªÈô§ pressing È°ûÂà•ÔºåÊ∑ªÂä† charging È°ûÂà•');
                            eventCard.classList.remove('pressing');
                            eventCard.classList.add('charging');
                            console.log('üîã ÈñãÂßãÈõÜÊ∞£ÂÖÖËÉΩ...');
                            console.log('üîã Áï∂ÂâçË™≤Á®ãÂç°ÁâáÈ°ûÂà•:', eventCard.className);
                            
                            // ÈúáÂãïÂõûÈ•ãÔºöÈñãÂßãÈõÜÊ∞£
                            triggerHapticFeedback('start');
                            
                            // 1ÁßíÂæåÈñãÂßãÂæåÁ´ØÈ†êËºâÂÖ•Ôºà0.5ÁßíÂæåÔºâ
                            setTimeout(() => {
                                if (isCharging && !isScrolling) {
                                    console.log('üìö ÈñãÂßãÂæåÁ´ØÈ†êËºâÂÖ•Â≠∏ÁîüË≥áÊñô...');
                                    // ÈúáÂãïÂõûÈ•ãÔºöËºâÂÖ•‰∏≠
                                    triggerHapticFeedback('loading');
                                }
                            }, 500);
                            
                            // 1.5ÁßíÂæåË∑≥Âá∫ËºâÂÖ•ÂãïÁï´Ôºà1ÁßíÂæåÔºâ
                            setTimeout(() => {
                                if (isCharging && !isScrolling) {
                                    console.log('üöÄ Ë∑≥Âá∫ËºâÂÖ•Áï´Èù¢');
                                    eventCard.classList.remove('charging');
                                    // ÈúáÂãïÂõûÈ•ãÔºöÂÆåÊàê
                                    triggerHapticFeedback('complete');
                                    handleDirectAttendance(title, instructor, start, end);
                                }
                            }, 1000);
                        }
                    }, 500);
                }
            }
        });

        // Ëß∏ÊéßÁßªÂãï‰∫ã‰ª∂ - Ê™¢Ê∏¨ÊªëÂãï
        document.addEventListener('touchmove', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && isCharging) {
                const touch = e.touches[0];
                touchCurrentPos.x = touch.clientX;
                touchCurrentPos.y = touch.clientY;
                
                // Ë®àÁÆóÁßªÂãïË∑ùÈõ¢ÂíåÊñπÂêë
                const deltaX = touchCurrentPos.x - touchStartPos.x;
                const deltaY = touchCurrentPos.y - touchStartPos.y;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                // Ë®àÁÆóÁßªÂãïÈÄüÂ∫¶
                const currentTime = Date.now();
                const timeDelta = currentTime - touchStartTime;
                const velocity = distance / (timeDelta || 1);
                
                // Â¶ÇÊûúÁßªÂãïË∑ùÈõ¢Ë∂ÖÈÅéÂèñÊ∂àÈñæÂÄºÔºåÊ®ôË®òÁÇ∫Ëß∏ÊéßÂèñÊ∂à
                if (distance > touchCancelThreshold) {
                    isTouchCancelled = true;
                    console.log('üì± Ê™¢Ê∏¨Âà∞Ëß∏ÊéßÂèñÊ∂àÔºåË∑ùÈõ¢:', distance);
                    
                    // ÈúáÂãïÂõûÈ•ãÔºöËß∏ÊéßÂèñÊ∂à
                    triggerHapticFeedback('release');
                    
                    // Á´ãÂç≥ÂÅúÊ≠¢ÂÖÖÈõª
                    if (eventCard.classList.contains('charging')) {
                        eventCard.classList.remove('charging', 'pressing');
                        eventCard.classList.add('releasing');
                        
                        setTimeout(() => {
                            eventCard.classList.add('completing');
                            setTimeout(() => {
                                eventCard.classList.remove('releasing', 'completing');
                                eventCard.style.animation = '';
                                eventCard.style.transition = '';
                                isAnimating = false;
                            }, 200);
                        }, 400);
                    } else {
                        eventCard.classList.remove('pressing');
                    }
                    
                    // Ê∏ÖÈô§Èï∑ÊåâË®àÊôÇÂô®
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    
                    isCharging = false;
                    isTouchActive = false;
                    return;
                }
                
                // Â¶ÇÊûúÁßªÂãïË∑ùÈõ¢Ë∂ÖÈÅéÊªëÂãïÈñæÂÄºÊàñÈÄüÂ∫¶ÈÅéÂø´ÔºåÊ®ôË®òÁÇ∫ÊªëÂãï
                if (distance > scrollThreshold || velocity > 0.3) {
                    isScrolling = true;
                    console.log('üì± Ê™¢Ê∏¨Âà∞ÊªëÂãïÔºåÂèñÊ∂àÈï∑ÊåâÂäüËÉΩ', { distance, velocity });
                    
                    // ÈúáÂãïÂõûÈ•ãÔºöÊªëÂãïÂèñÊ∂à
                    triggerHapticFeedback('release');
                    
                    // Â¶ÇÊûúÊ≠£Âú®ÂÖÖÈõªÔºåÁ´ãÂç≥ÂÅúÊ≠¢
                    if (eventCard.classList.contains('charging')) {
                        eventCard.classList.remove('charging', 'pressing');
                        eventCard.classList.add('releasing');
                        
                        setTimeout(() => {
                            eventCard.classList.add('completing');
                            setTimeout(() => {
                                eventCard.classList.remove('releasing', 'completing');
                                // Ê∏ÖÈô§ÊâÄÊúâÂãïÁï´Áõ∏ÈóúÁöÑÊ®£Âºè
                                eventCard.style.animation = '';
                                eventCard.style.transition = '';
                                isAnimating = false;
                            }, 200);
                        }, 400);
                    }
                    
                    // Ê∏ÖÈô§Èï∑ÊåâË®àÊôÇÂô®
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    
                    isCharging = false;
                    isTouchActive = false;
                }
            }
        });

        document.addEventListener('touchend', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && (longPressTimer || isCharging)) {
                // Èò≤Ê≠¢ÈáçË§áËß∏Áôº
                if (isAnimating) return;
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ëß∏ÊéßÂèñÊ∂à
                if (isTouchCancelled) {
                    console.log('üì± Ëß∏ÊéßÁµêÊùüÔºöËß∏ÊéßÂ∑≤ÂèñÊ∂àÔºå‰∏çËß∏ÁôºÈï∑ÊåâÂäüËÉΩ');
                    eventCard.classList.remove('pressing', 'charging');
                    isCharging = false;
                    isScrolling = false;
                    isTouchActive = false;
                    return;
                }
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊªëÂãïÊìç‰Ωú
                if (isScrolling) {
                    console.log('üì± Ëß∏ÊéßÁµêÊùüÔºöÊªëÂãïÊìç‰ΩúÔºå‰∏çËß∏ÁôºÈï∑ÊåâÂäüËÉΩ');
                    eventCard.classList.remove('pressing', 'charging');
                    isCharging = false;
                    isScrolling = false;
                    isTouchActive = false;
                    return;
                }
                
                // Ë®àÁÆóËß∏ÊéßÊåÅÁ∫åÊôÇÈñì
                touchDuration = Date.now() - touchStartTime;
                console.log('üì± Ëß∏ÊéßÁµêÊùüÔºåÊåÅÁ∫åÊôÇÈñì:', touchDuration + 'ms');
                
                // Ê™¢Êü•ÊúÄÂ∞èÈï∑ÊåâÊôÇÈñìÔºà1.5ÁßíÔºâ
                if (touchDuration < 1500) {
                    console.log('üì± Ëß∏ÊéßÊôÇÈñìÂ§™Áü≠Ôºà< 1.5ÁßíÔºâÔºå‰∏çËß∏ÁôºÈï∑ÊåâÂäüËÉΩ');
                    eventCard.classList.remove('pressing', 'charging');
                    isCharging = false;
                    isScrolling = false;
                    isTouchActive = false;
                    return;
                }
                
                if (isCharging) {
                    isAnimating = true;
                    
                    // ÈúáÂãïÂõûÈ•ãÔºöÈáãÊîæ
                    triggerHapticFeedback('release');
                    
                    // ÂÑ™ÂåñÁöÑÈáãÊîæÂãïÁï´ÈÇèËºØ
                    eventCard.classList.remove('charging', 'pressing');
                    eventCard.classList.add('releasing');
                    
                    // ÂãïÁï´ÂÆåÊàêÂæåÊ∑ªÂä†ÈÅéÊ∏°ÁãÄÊÖãÔºåÁÑ∂ÂæåÂπ≥ÊªëÁßªÈô§
                    setTimeout(() => {
                        eventCard.classList.add('completing');
                        setTimeout(() => {
                            eventCard.classList.remove('releasing', 'completing');
                            // Ê∏ÖÈô§ÊâÄÊúâÂãïÁï´Áõ∏ÈóúÁöÑÊ®£Âºè
                            eventCard.style.animation = '';
                            eventCard.style.transition = '';
                            isAnimating = false;
                            console.log('‚úÖ Ëß∏ÊéßÈáãÊîæÂãïÁï´ÂÆåÊàê');
                        }, 200);
                    }, 400);
                    
                    console.log('‚ùå Ëß∏ÊéßÈï∑Êåâ‰∏≠Êñ∑ÔºåÊí≠ÊîæÈáãÊîæÂãïÁï´');
                } else {
                    eventCard.classList.remove('pressing');
                    console.log('‚ùå Ëß∏ÊéßÈï∑Êåâ‰∏≠Êñ∑');
                }
                
                isCharging = false;
                isScrolling = false;
                isTouchActive = false; // ÈáçÁΩÆËß∏ÊéßÁãÄÊÖã
            }
        });

        // Ëß∏ÊéßÂèñÊ∂à‰∫ã‰ª∂ - ËôïÁêÜÊÑèÂ§ñ‰∏≠Êñ∑
        document.addEventListener('touchcancel', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && (longPressTimer || isCharging) && isTouchActive) {
                console.log('üì± Ëß∏ÊéßÂèñÊ∂à‰∫ã‰ª∂');
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                // ÈúáÂãïÂõûÈ•ãÔºöÂèñÊ∂à
                triggerHapticFeedback('release');
                
                if (isCharging) {
                    eventCard.classList.remove('charging', 'pressing');
                    eventCard.classList.add('releasing');
                    
                    setTimeout(() => {
                        eventCard.classList.add('completing');
                        setTimeout(() => {
                            eventCard.classList.remove('releasing', 'completing');
                            // Ê∏ÖÈô§ÊâÄÊúâÂãïÁï´Áõ∏ÈóúÁöÑÊ®£Âºè
                            eventCard.style.animation = '';
                            eventCard.style.transition = '';
                            isAnimating = false;
                        }, 200);
                    }, 400);
                } else {
                    eventCard.classList.remove('pressing');
                }
                
                isCharging = false;
                isScrolling = false;
                isTouchActive = false;
                isTouchCancelled = false;
            }
        });

        // ==================== Á∞ΩÂà∞Á≥ªÁµ±ÂäüËÉΩ ====================
        
        // ÁâπÊÆäË™≤Á®ãÈ°ûÂûãÂÆöÁæ©
        const SPECIAL_EVENT_TYPES = {
            "ÂÅúË™≤": ["ÂÅúË™≤", "ÂèñÊ∂à", "Êö´ÂÅú", "‰ºëÊÅØ", "ÊîæÂÅá", "Ë´ãÂÅá"],
            "È´îÈ©ó": ["È´îÈ©ó", "È´îÈ©óË™≤", "È´îÈ©óÁè≠", "È´îË™≤", "È´î"],
            "‰ª£Ë™≤": ["‰ª£Ë™≤", "‰ª£ÁêÜ", "ÊîØÊè¥", "‰ª£"],
            "Ë£úË™≤": ["Ë£úË™≤", "Ë™øË™≤", "Âª∂Âæå", "ÊèêÂâç"]
        };

        // Ê®°Á≥äÂåπÈÖçË¨õÂ∏´ÂêçÁ®±
        function findMatchingInstructor(targetInstructor, availableInstructors) {
            if (!targetInstructor || !availableInstructors || availableInstructors.length === 0) {
                return null;
            }

            const target = targetInstructor.trim().toLowerCase();
            
            // 1. ÂÆåÂÖ®ÂåπÈÖçÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
            let exactMatch = availableInstructors.find(instructor => 
                instructor.toLowerCase() === target
            );
            if (exactMatch) {
                console.log(`‚úÖ ÂÆåÂÖ®ÂåπÈÖçÊâæÂà∞Ë¨õÂ∏´: ${exactMatch}`);
                return exactMatch;
            }

            // 2. ÂåÖÂê´ÂåπÈÖç
            let containsMatch = availableInstructors.find(instructor => 
                instructor.toLowerCase().includes(target) || target.includes(instructor.toLowerCase())
            );
            if (containsMatch) {
                console.log(`‚úÖ ÂåÖÂê´ÂåπÈÖçÊâæÂà∞Ë¨õÂ∏´: ${containsMatch}`);
                return containsMatch;
            }

            // 3. Ê®°Á≥äÂåπÈÖçÔºà‰ΩøÁî® Levenshtein Ë∑ùÈõ¢Ôºâ
            let bestMatch = null;
            let bestScore = Infinity;
            const threshold = 3; // ÊúÄÂ§ßÁ∑®ËºØË∑ùÈõ¢

            for (const instructor of availableInstructors) {
                const distance = levenshteinDistance(target, instructor.toLowerCase());
                if (distance <= threshold && distance < bestScore) {
                    bestScore = distance;
                    bestMatch = instructor;
                }
            }

            if (bestMatch) {
                console.log(`‚úÖ Ê®°Á≥äÂåπÈÖçÊâæÂà∞Ë¨õÂ∏´: ${bestMatch} (Ë∑ùÈõ¢: ${bestScore})`);
                return bestMatch;
            }

            console.log(`‚ùå Êâæ‰∏çÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´: ${targetInstructor}`);
            return null;
        }

        // Levenshtein Ë∑ùÈõ¢ÁÆóÊ≥ï
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;

            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[len2][len1];
        }

        // ÁßªÈô§ÁâπÊÆäË™≤Á®ãÈ°ûÂûã
        function removeSpecialEventTypes(timeInfo) {
            if (!timeInfo) return timeInfo;
            
            let cleanedTimeInfo = timeInfo;
            
            // ÁßªÈô§ÁâπÊÆäË™≤Á®ãÈ°ûÂûã
            for (const [category, keywords] of Object.entries(SPECIAL_EVENT_TYPES)) {
                for (const keyword of keywords) {
                    const regex = new RegExp(`\\s*${keyword}\\s*`, 'gi');
                    cleanedTimeInfo = cleanedTimeInfo.replace(regex, ' ');
                }
            }
            
            // ÁßªÈô§ÈÄ±Êï∏Ë≥áË®ä
            cleanedTimeInfo = cleanedTimeInfo.replace(/\s*Á¨¨\d+ÈÄ±\s*/gi, ' ');
            
            // Ê∏ÖÁêÜÂ§öÈ§òÁ©∫Ê†º
            cleanedTimeInfo = cleanedTimeInfo.replace(/\s+/g, ' ').trim();
            
            return cleanedTimeInfo;
        }

        // Ëß£ÊûêË™≤Á®ãÊ®ôÈ°å
        function parseCourseTitle(fullTitle) {
            if (!fullTitle) {
                return { courseName: '', timeInfo: '' };
            }

            console.log(`üîç Ëß£ÊûêË™≤Á®ãÊ®ôÈ°å: "${fullTitle}"`);

            // ÂÆöÁæ©Â§öÁ®ÆË™≤Á®ãÊ®ôÈ°åÊ†ºÂºèÁöÑÊ≠£ÂâáË°®ÈÅîÂºè
            const patterns = [
                // Ê†ºÂºè1: "SPIKE PRO Êó• 10:00-12:00 Á¨¨3ÈÄ±" - ËôïÁêÜÂåÖÂê´Á©∫Ê†ºÁöÑË™≤Á®ãÂêçÁ®±
                /^([A-Z]+(?:\s+[A-Z]+)*)\s+([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})(?:\s+(.+?))?(?:\s+Á¨¨\d+ÈÄ±.*)?$/,
                // Ê†ºÂºè2: "ESM ÂÖ≠ 9:30-10:30 Âà∞Â∫ú Á¨¨4ÈÄ±Ë´ãÂÅá"
                /^([A-Z]+)\s+([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})\s+(.+?)(?:\s+Á¨¨\d+ÈÄ±.*)?$/,
                // Ê†ºÂºè3: "BOOST ÂÖ≠ 1530-1700 Âà∞Â∫ú"
                /^([A-Z]+)\s+([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•])\s+(\d{4})-(\d{4})\s+(.+?)(?:\s+Á¨¨\d+ÈÄ±.*)?$/,
                // Ê†ºÂºè4: "SPIKE ÂÖ≠ 9:30-10:30"
                /^([A-Z]+)\s+([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})(?:\s+(.+?))?(?:\s+Á¨¨\d+ÈÄ±.*)?$/,
                // Ê†ºÂºè5: "ESM ÂÖ≠ 1530-1700"
                /^([A-Z]+)\s+([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•])\s+(\d{4})-(\d{4})(?:\s+(.+?))?(?:\s+Á¨¨\d+ÈÄ±.*)?$/,
                // Ê†ºÂºè6: "ESM ÂÖ≠ 0930-1100 Âà∞Â∫ú"
                /^([A-Z]+)\s+([‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠Êó•])\s+(\d{4})-(\d{4})\s+(.+?)(?:\s+Á¨¨\d+ÈÄ±.*)?$/
            ];

            for (const pattern of patterns) {
                const match = fullTitle.match(pattern);
                if (match) {
                    let courseName = match[1];
                    const weekday = match[2];
                    const startTime = match[3];
                    const endTime = match[4];
                    const location = match[5] || '';

                    // ËôïÁêÜË™≤Á®ãÂêçÁ®±ÔºöÂ¶ÇÊûúÊòØ "SPIKE PRO" ÈÄôÊ®£ÁöÑÊ†ºÂºèÔºåÂè™ÂèñÁ¨¨‰∏ÄÈÉ®ÂàÜ
                    if (courseName.includes(' ')) {
                        const courseParts = courseName.split(' ');
                        // Âè™ÂèñÁ¨¨‰∏ÄÂÄãÂñÆË©û‰ΩúÁÇ∫‰∏ªË¶ÅË™≤Á®ãÂêçÁ®±
                        courseName = courseParts[0];
                        console.log(`üîÑ Ë™≤Á®ãÂêçÁ®±Á∞°Âåñ: "${match[1]}" ‚Üí "${courseName}"`);
                    }

                    // Ê†ºÂºèÂåñÊôÇÈñì
                    const formattedStartTime = formatTime(startTime);
                    const formattedEndTime = formatTime(endTime);

                    // ÊßãÂª∫ÊôÇÈñìË≥áË®äÂ≠ó‰∏≤
                    let timeInfo = `${weekday} ${formattedStartTime}-${formattedEndTime}`;
                    if (location) {
                        timeInfo += ` ${location}`;
                    }

                    // ÁßªÈô§ÁâπÊÆäË™≤Á®ãÈ°ûÂûã
                    timeInfo = removeSpecialEventTypes(timeInfo);

                    console.log(`‚úÖ Ëß£ÊûêÊàêÂäü: Ë™≤Á®ã="${courseName}", ÊôÇÈñìË≥áË®ä="${timeInfo}"`);
                    return { courseName, timeInfo };
                }
            }

            // Â¶ÇÊûúÊ≤íÊúâÂåπÈÖçÂà∞‰ªª‰ΩïÊ†ºÂºèÔºåËøîÂõûÂéüÂßãÊ®ôÈ°å
            console.log(`‚ö†Ô∏è ÁÑ°Ê≥ïËß£ÊûêË™≤Á®ãÊ®ôÈ°åÊ†ºÂºè: "${fullTitle}"`);
            return { courseName: fullTitle, timeInfo: '' };
        }

        // Ê†ºÂºèÂåñÊôÇÈñì
        function formatTime(timeStr) {
            if (!timeStr) return '';
            
            // Â¶ÇÊûúÂ∑≤Á∂ìÊòØ HHHH Ê†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
            if (timeStr.length === 4 && !timeStr.includes(':')) {
                return timeStr;
            }
            
            // Â¶ÇÊûúÊòØ HH:MM Ê†ºÂºèÔºåËΩâÊèõÁÇ∫ HHHH
            if (timeStr.includes(':')) {
                const [hours, minutes] = timeStr.split(':');
                return `${hours.padStart(2, '0')}${minutes.padStart(2, '0')}`;
            }
            
            return timeStr;
        }

        // Áç≤ÂèñÂèØÁî®Ë¨õÂ∏´ÂàóË°®
        async function getAvailableInstructors() {
            try {
                const response = await fetch('/api/teachers');
                const data = await response.json();
                
                if (data.success && data.teachers) {
                    return data.teachers.map(teacher => teacher.name);
                } else {
                    console.warn('‚ö†Ô∏è ÁÑ°Ê≥ïÁç≤ÂèñË¨õÂ∏´ÂàóË°®Ôºå‰ΩøÁî®È†êË®≠ÂàóË°®');
                    return ['Tim', 'Ted', 'Agnes', 'Hansen', 'James', 'Ivan', 'Xian', 'Eason', 'Bella', 'Gillian', 'Daniel', 'Philp', 'Tony', 'Jacky', 'Weinie', 'test', 'Dirty', 'Melody', 'ÊÇ£Ê∞¥'];
                }
            } catch (error) {
                console.error('‚ùå Áç≤ÂèñË¨õÂ∏´ÂàóË°®Â§±Êïó:', error);
                return ['Tim', 'Ted', 'Agnes', 'Hansen', 'James', 'Ivan', 'Xian', 'Eason', 'Bella', 'Gillian', 'Daniel', 'Philp', 'Tony', 'Jacky', 'Weinie', 'test', 'Dirty', 'Melody', 'ÊÇ£Ê∞¥'];
            }
        }

        // ËôïÁêÜÁõ¥Êé•Á∞ΩÂà∞
        async function handleDirectAttendance(title, instructor, start, end) {
            try {
                console.log('üéØ ËôïÁêÜÁõ¥Êé•Á∞ΩÂà∞:', { title, instructor, start, end });
                
                // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊúâÊ®°ÊÖãÊ°ÜÂú®È°ØÁ§∫
                if (currentAttendanceModal) {
                    console.log('‚ö†Ô∏è Â∑≤ÊúâÊ®°ÊÖãÊ°ÜÂú®È°ØÁ§∫ÔºåÂèñÊ∂àÊñ∞ÁöÑÁ∞ΩÂà∞Ë´ãÊ±Ç');
                    return;
                }
                
                // Ê™¢Êü•Ë™≤Á®ãÊôÇÈñìÈôêÂà∂
                const courseStartTime = new Date(start);
                const currentTime = new Date();
                const timeDiff = courseStartTime.getTime() - currentTime.getTime();
                const minutesUntilStart = Math.floor(timeDiff / (1000 * 60));
                
                console.log(`‚è∞ Ë™≤Á®ãÈñãÂßãÊôÇÈñì: ${courseStartTime.toLocaleString()}`);
                console.log(`‚è∞ Áï∂ÂâçÊôÇÈñì: ${currentTime.toLocaleString()}`);
                console.log(`‚è∞ Ë∑ùÈõ¢Ë™≤Á®ãÈñãÂßã: ${minutesUntilStart} ÂàÜÈêò`);
                
                // Ëß£ÊûêË™≤Á®ãÊ®ôÈ°åÔºåÂàÜÈõ¢Ë™≤Á®ãÂêçÁ®±ÂíåÊôÇÈñìË≥áË®ä
                const { courseName, timeInfo } = parseCourseTitle(title);
                console.log(`üìù Ëß£ÊûêÁµêÊûú: Ë™≤Á®ã="${courseName}", ÊôÇÈñìË≥áË®ä="${timeInfo}"`);
                
                // Áç≤ÂèñÂèØÁî®Ë¨õÂ∏´ÂàóË°®‰∏¶ÈÄ≤Ë°åÊ®°Á≥äÊØîÂ∞ç
                const availableInstructors = await getAvailableInstructors();
                const matchedInstructor = findMatchingInstructor(instructor, availableInstructors);
                
                if (!matchedInstructor) {
                    const errorMsg = `Ë¨õÂ∏´ "${instructor}" ‰∏çÂ≠òÂú®„ÄÇÂèØÁî®ÁöÑË¨õÂ∏´Ôºö${availableInstructors.join(', ')}`;
                    console.error('‚ùå', errorMsg);
                    alert(errorMsg);
                    return;
                }

                // Â¶ÇÊûúÊâæÂà∞ÂåπÈÖçÁöÑË¨õÂ∏´Ôºå‰ΩøÁî®ÂåπÈÖçÁöÑÂêçÁ®±
                if (matchedInstructor !== instructor) {
                    console.log(`üîÑ Ë¨õÂ∏´ÂêçÁ®±Â∑≤‰øÆÊ≠£: "${instructor}" ‚Üí "${matchedInstructor}"`);
                    instructor = matchedInstructor;
                }
                
                // ‰ΩøÁî®Ëß£ÊûêÂæåÁöÑË™≤Á®ãÂêçÁ®±ÂíåÊôÇÈñìË≥áË®ä
                const finalCourseName = courseName;
                const finalTimeString = timeInfo || `${new Date(start).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} - ${new Date(end).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}`;
                
                // ÈñãÂïüÂéüÁîüÁ∞ΩÂà∞Á≥ªÁµ±ÔºàÂÇ≥ÂÖ•ÊôÇÈñìÈôêÂà∂Ë≥áË®äÔºâ
                await openNativeAttendanceSystem(matchedInstructor, finalCourseName, finalTimeString, start, end, minutesUntilStart);
                
            } catch (error) {
                console.error('‚ùå Áõ¥Êé•Á∞ΩÂà∞Â§±Êïó:', error);
                alert('Áõ¥Êé•Á∞ΩÂà∞Â§±Êïó: ' + error.message);
            }
        }

        // ÈñãÂïüÂéüÁîüÁ∞ΩÂà∞Á≥ªÁµ±
        async function openNativeAttendanceSystem(teacher, course, time, start, end, minutesUntilStart = null) {
            try {
                console.log('üéØ ÈñãÂïüÂéüÁîüÁ∞ΩÂà∞Á≥ªÁµ±:', { teacher, course, time, start, end });
                
                // ‰øùÂ≠òÁï∂ÂâçÁ∞ΩÂà∞Êï∏ÊìöÔºå‰ª•‰æøÂú®ÊÅ¢Âæ©Â≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπÊôÇ‰ΩøÁî®
                window.currentAttendanceData = { teacher, course, time, start, end, minutesUntilStart };
                
                // ÂâµÂª∫Á∞ΩÂà∞Á≥ªÁµ±Ê®°ÊÖãÊ°Ü
                const modal = document.createElement('div');
                modal.id = 'attendanceModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease-out;
                `;
                
                modal.innerHTML = `
                    <div class="attendance-modal-content" style="
                        background: 
                            radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.15) 0%, transparent 50%),
                            radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.12) 0%, transparent 50%),
                            linear-gradient(135deg, 
                                rgba(255, 255, 255, 0.95) 0%, 
                                rgba(248, 248, 248, 0.92) 25%,
                                rgba(252, 252, 252, 0.9) 50%,
                                rgba(248, 248, 248, 0.92) 75%,
                                rgba(255, 255, 255, 0.95) 100%);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border-radius: 25px;
                        padding: 30px;
                        max-width: 90%;
                        max-height: 90%;
                        width: 800px;
                        overflow-y: auto;
                        box-shadow: 
                            0 20px 60px rgba(0, 0, 0, 0.4),
                            0 0 0 1px rgba(255, 215, 0, 0.2),
                            inset 0 1px 0 rgba(255, 255, 255, 0.1);
                        animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                        border: 1px solid rgba(255, 215, 0, 0.3);
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <h2 style="margin: 0; color: #333333; font-size: 1.5rem; text-shadow: none;">
                                    <i class="fas fa-calendar-check" style="color: #b8860b; margin-right: 10px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                                    Ë™≤Á®ãÁ∞ΩÂà∞Á≥ªÁµ±
                                </h2>
                                ${minutesUntilStart !== null ? `
                                    <div style="margin-top: 8px; font-size: 0.9rem; color: ${minutesUntilStart <= 10 ? '#28a745' : '#ffc107'}; font-weight: 600;">
                                        <i class="fas fa-clock" style="margin-right: 5px;"></i>
                                        ${minutesUntilStart > 0 ? 
                                            `Ë∑ùÈõ¢Ë™≤Á®ãÈñãÂßãÈÇÑÊúâ ${minutesUntilStart} ÂàÜÈêò` : 
                                            minutesUntilStart === 0 ? 
                                                'Ë™≤Á®ãÂç≥Â∞áÈñãÂßã' : 
                                                'Ë™≤Á®ãÂ∑≤ÈñãÂßã'
                                        }
                                    </div>
                                ` : ''}
                            </div>
                            <button id="closeAttendanceModal" class="close-attendance-modal" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 215, 0, 0.4);
                                font-size: 1.5rem;
                                color: #333333;
                                cursor: pointer;
                                padding: 5px;
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.3s ease;
                                backdrop-filter: blur(10px);
                                -webkit-backdrop-filter: blur(10px);
                            ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        
                        <div class="course-info" style="
                            margin-bottom: 20px; 
                            padding: 20px; 
                            background: 
                                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.05) 0%, transparent 70%),
                                linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
                            border-radius: 15px; 
                            border: 1px solid rgba(255, 215, 0, 0.3);
                            backdrop-filter: blur(10px);
                            -webkit-backdrop-filter: blur(10px);
                            box-shadow: 
                                0 8px 32px rgba(0, 0, 0, 0.2),
                                inset 0 1px 0 rgba(255, 255, 255, 0.1);
                        ">
                            <div class="course-info-panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                <div data-field="teacher" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">Ë¨õÂ∏´:</strong> ${teacher}</div>
                                <div data-field="course" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">Ë™≤Á®ã:</strong> ${course}</div>
                                <div data-field="time" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">ÊôÇÈñì:</strong> ${time}</div>
                                <div data-field="date" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">Êó•Êúü:</strong> ${new Date(start).toLocaleDateString('zh-TW')}</div>
                            </div>
                        </div>
                        
                        <div id="attendanceContent">
                            <div style="text-align: center; padding: 60px 40px; color: #333333; background: linear-gradient(135deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05)); border-radius: 15px; transition: all 0.5s ease;">
                                <!-- Âç°ÁâåËºâÂÖ•ÂãïÁï´ -->
                                <div style="
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    gap: 10px;
                                    margin-bottom: 30px;
                                    perspective: 1000px;
                                ">
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0.1s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0.2s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0.3s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0.4s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                </div>
                                
                                <h3 style="margin: 0; color: #333333; animation: fadeIn 0.6s ease-out; text-shadow: none;">
                                    <i class="fas fa-id-card" style="margin-right: 8px; color: #b8860b; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                                    Ê≠£Âú®ÁôºÁâå‰∏≠...
                                </h3>
                                
                                <p style="margin: 10px 0; color: #666666; font-size: 0.9rem;">
                                    Ê∫ñÂÇôÂ≠∏ÁîüÂç°ÁâåÔºåË´ãÁ®çÂÄô
                                </p>
                                
                                <div style="
                                    width: 200px;
                                    height: 4px;
                                    background: linear-gradient(90deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
                                    margin: 20px auto 0;
                                    border-radius: 2px;
                                    position: relative;
                                    overflow: hidden;
                                    box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
                                ">
                                    <div style="
                                        position: absolute;
                                        top: 0;
                                        left: -100%;
                                        width: 100%;
                                        height: 100%;
                                        background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.8), transparent);
                                        animation: shimmer 2s infinite;
                                    "></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ÂâµÂª∫Êá∏ÊµÆÂ∞éËà™Âô®
                const floatingNavigator = document.createElement('div');
                floatingNavigator.className = 'floating-navigator';
                floatingNavigator.innerHTML = `
                    <div class="nav-item active" data-tab="student-attendance">
                        <i class="fas fa-user-graduate icon"></i>
                        <span class="text">Â≠∏ÁîüÁ∞ΩÂà∞</span>
                    </div>
                    <div class="nav-item" data-tab="teacher-attendance">
                        <i class="fas fa-chalkboard-teacher icon"></i>
                        <span class="text">Ë¨õÂ∏´Á∞ΩÂà∞</span>
                    </div>
                `;

                document.body.appendChild(modal);
                document.body.appendChild(floatingNavigator);
                currentAttendanceModal = modal;
                isModalLoading = true;

                // Ê∑ªÂä†Â∞éËà™Âô®ÈªûÊìä‰∫ã‰ª∂
                const navItems = floatingNavigator.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        // ÁßªÈô§ÊâÄÊúâÊ¥ªÂãïÁãÄÊÖã
                        navItems.forEach(nav => nav.classList.remove('active'));
                        // Ê∑ªÂä†Áï∂ÂâçÊ¥ªÂãïÁãÄÊÖã
                        this.classList.add('active');
                        
                        const tab = this.dataset.tab;
                        console.log('üîÑ ÂàáÊèõÂà∞Ê®ôÁ±§:', tab);
                        
                        if (tab === 'teacher-attendance') {
                            // È°ØÁ§∫Ë¨õÂ∏´Á∞ΩÂà∞ÂÖßÂÆπ
                            showTeacherAttendance();
                        } else {
                            // È°ØÁ§∫Â≠∏ÁîüÁ∞ΩÂà∞ÂÖßÂÆπ
                            showStudentAttendance();
                        }
                    });
                });
                
                // Ë®≠ÁΩÆÈóúÈñâÊåâÈàïË™≤Á®ã
                const closeBtn = document.getElementById('closeAttendanceModal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        console.log('‚ùå Áî®Êà∂ÈªûÊìäÈóúÈñâÊåâÈàïÔºåÂèñÊ∂àËºâÂÖ•');
                        closeAttendanceModal();
                    });
                }
                
                // ÈªûÊìäËÉåÊôØÈóúÈñâ
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        console.log('‚ùå Áî®Êà∂ÈªûÊìäËÉåÊôØÔºåÂèñÊ∂àËºâÂÖ•');
                        closeAttendanceModal();
                    }
                });
                
                // ËºâÂÖ•Â≠∏ÁîüÂêçÂñÆ
                await loadCourseStudents(teacher, course, time, start, end, minutesUntilStart);
                
                // ËºâÂÖ•ÂÆåÊàêÔºåÊõ¥Êñ∞ÁãÄÊÖã
                isModalLoading = false;
                
            } catch (error) {
                console.error('‚ùå ÈñãÂïüÁ∞ΩÂà∞Á≥ªÁµ±Â§±Êïó:', error);
                alert('ÈñãÂïüÁ∞ΩÂà∞Á≥ªÁµ±Â§±Êïó: ' + error.message);
            }
        }

        // ËºâÂÖ•Ë™≤Á®ãÂ≠∏Áîü
        async function loadCourseStudents(teacher, course, time, start, end, minutesUntilStart = null) {
            try {
                console.log('üìö ËºâÂÖ•Ë™≤Á®ãÂ≠∏Áîü:', { teacher, course, time, start, end });
                
                // Ë®≠ÁΩÆÂ≠∏ÁîüÂêçÂñÆËºâÂÖ•ÁãÄÊÖã
                isStudentListLoading = true;
                studentListLoadPromise = null;
                
                // Ê™¢Êü•Ê®°ÊÖãÊ°ÜÊòØÂê¶‰ªçÁÑ∂Â≠òÂú®
                if (!currentAttendanceModal || !isModalLoading) {
                    console.log('‚ùå Ê®°ÊÖãÊ°ÜÂ∑≤Ë¢´ÈóúÈñâÔºåÂèñÊ∂àËºâÂÖ•');
                    isStudentListLoading = false;
                    return;
                }
                
                // Ë®≠ÁΩÆËºâÂÖ•Ë∂ÖÊôÇ‰øùË≠∑
                const loadingTimeout = setTimeout(() => {
                    if (isModalLoading) {
                        console.log('‚è∞ ËºâÂÖ•Ë∂ÖÊôÇÔºåËá™ÂãïÈóúÈñâÊ®°ÊÖãÊ°Ü');
                        closeAttendanceModal();
                    }
                }, 15000); // 15ÁßíË∂ÖÊôÇ
                
                const response = await fetch('/api/proxy/google-sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'getRosterAttendance',
                        course: course,
                        period: time
                    })
                });
                
                const data = await response.json();
                console.log('üìä Â≠∏ÁîüË≥áÊñôÂõûÊáâ:', data);
                
                // ÂÜçÊ¨°Ê™¢Êü•Ê®°ÊÖãÊ°ÜÊòØÂê¶‰ªçÁÑ∂Â≠òÂú®
                if (!currentAttendanceModal || !isModalLoading) {
                    console.log('‚ùå Ê®°ÊÖãÊ°ÜÂ∑≤Ë¢´ÈóúÈñâÔºåÂèñÊ∂àËôïÁêÜÂ≠∏ÁîüË≥áÊñô');
                    return;
                }
                
                if (data.success && data.students) {
                    console.log('üîç Â≠∏ÁîüÊï∏ÊìöÁµêÊßãÊ™¢Êü•:', data.students.map(s => ({
                        name: s.name,
                        id: s.id,
                        studentId: s.studentId,
                        student_id: s.student_id,
                        key: s.key,
                        allKeys: Object.keys(s)
                    })));
                    
                    // ËºâÂÖ•ÂÆåÊàêÔºåÊõ¥Êñ∞ÁãÄÊÖã
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    displayStudents(data.students, teacher, course, time, start, end, minutesUntilStart);
                } else {
                    // ËºâÂÖ•Â§±ÊïóÔºåÊõ¥Êñ∞ÁãÄÊÖã
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    // È°ØÁ§∫ÈåØË™§Ë®äÊÅØÔºå‰∏ç‰ΩøÁî®Ê®°Êì¨Ë≥áÊñô
                    console.error('‚ùå ÁÑ°Ê≥ïËºâÂÖ•Â≠∏ÁîüË≥áÊñô:', data);
                    const attendanceContent = document.getElementById('attendanceContent');
                    if (attendanceContent) {
                        attendanceContent.innerHTML = `
                            <div style="text-align: center; padding: 60px 40px; color: rgba(255, 255, 255, 0.8);">
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    border: 4px solid rgba(220, 53, 69, 0.3);
                                    border-top: 4px solid #dc3545;
                                    border-radius: 50%;
                                    animation: spin 1s linear infinite;
                                    margin: 0 auto 20px;
                                    box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
                                "></div>
                                <h3 style="margin: 0; color: rgba(255, 255, 255, 0.95); text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);">
                                    <i class="fas fa-exclamation-triangle" style="color: #dc3545; margin-right: 8px;"></i>
                                    ÁÑ°Ê≥ïËºâÂÖ•Â≠∏ÁîüË≥áÊñô
                                </h3>
                                <p style="margin: 10px 0; color: rgba(255, 255, 255, 0.7);">
                                    Ë´ãÊ™¢Êü•Ë™≤Á®ãÂêçÁ®±ÂíåÊôÇÈñìÊòØÂê¶Ê≠£Á¢∫ÔºåÊàñÁ®çÂæåÂÜçË©¶
                                </p>
                                <button onclick="location.reload()" style="
                                    background: linear-gradient(135deg, rgba(255, 215, 0, 0.8), rgba(255, 215, 0, 0.6));
                                    color: rgba(0, 0, 0, 0.8);
                                    border: 1px solid rgba(255, 215, 0, 0.5);
                                    padding: 10px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    margin-top: 15px;
                                    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
                                ">
                                    <i class="fas fa-redo" style="margin-right: 5px;"></i> ÈáçÊñ∞ËºâÂÖ•
                                </button>
                            </div>
                        `;
                    }
                }
                
                // Ê∏ÖÈô§ËºâÂÖ•Ë∂ÖÊôÇË®àÊôÇÂô®
                clearTimeout(loadingTimeout);
                
            } catch (error) {
                console.error('‚ùå ËºâÂÖ•Â≠∏ÁîüÂ§±Êïó:', error);
                
                // ËºâÂÖ•Â§±ÊïóÔºåÊõ¥Êñ∞ÁãÄÊÖã
                isStudentListLoading = false;
                studentListLoadPromise = null;
                
                // Ê∏ÖÈô§ËºâÂÖ•Ë∂ÖÊôÇË®àÊôÇÂô®
                clearTimeout(loadingTimeout);
                // È°ØÁ§∫ÈåØË™§Ë®äÊÅØÔºå‰∏ç‰ΩøÁî®Ê®°Êì¨Ë≥áÊñô
                const attendanceContent = document.getElementById('attendanceContent');
                if (attendanceContent) {
                    attendanceContent.innerHTML = `
                        <div style="text-align: center; padding: 60px 40px; color: rgba(255, 255, 255, 0.8);">
                            <div style="
                                width: 60px;
                                height: 60px;
                                border: 4px solid rgba(220, 53, 69, 0.3);
                                border-top: 4px solid #dc3545;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin: 0 auto 20px;
                                box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
                            "></div>
                            <h3 style="margin: 0; color: rgba(255, 255, 255, 0.95); text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);">
                                <i class="fas fa-exclamation-triangle" style="color: #dc3545; margin-right: 8px;"></i>
                                ËºâÂÖ•Â≠∏ÁîüË≥áÊñôÊôÇÁôºÁîüÈåØË™§
                            </h3>
                            <p style="margin: 10px 0; color: rgba(255, 255, 255, 0.7);">
                                ÈåØË™§Ë®äÊÅØ: ${error.message}
                            </p>
                            <button onclick="location.reload()" style="
                                background: linear-gradient(135deg, rgba(255, 215, 0, 0.8), rgba(255, 215, 0, 0.6));
                                color: rgba(0, 0, 0, 0.8);
                                border: 1px solid rgba(255, 215, 0, 0.5);
                                padding: 10px 20px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-weight: 600;
                                margin-top: 15px;
                                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
                            ">
                                <i class="fas fa-redo" style="margin-right: 5px;"></i> ÈáçÊñ∞ËºâÂÖ•
                            </button>
                        </div>
                    `;
                }
            }
        }

        // È°ØÁ§∫Â≠∏ÁîüÂàóË°®
        function displayStudents(students, teacher, course, time, start, end, minutesUntilStart = null) {
            const attendanceContent = document.getElementById('attendanceContent');
            if (!attendanceContent) return;
            
            // Ê∑ªÂä†ËºâÂÖ•ÂÆåÊàêÁöÑÈÅéÊ∏°ÊïàÊûú
            attendanceContent.style.background = 'transparent';
            attendanceContent.style.transition = 'all 0.5s ease';
            
            // ÈáçÊñ∞Ë®≠ÁΩÆÈóúÈñâÊåâÈàï‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂõ†ÁÇ∫ÂÖßÂÆπË¢´ÈáçÊñ∞ÁîüÊàêÔºâ
            const closeBtn = document.getElementById('closeAttendanceModal');
            if (closeBtn) {
                // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
                closeBtn.replaceWith(closeBtn.cloneNode(true));
                // ÈáçÊñ∞Áç≤ÂèñÊåâÈàï‰∏¶Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
                const newCloseBtn = document.getElementById('closeAttendanceModal');
                if (newCloseBtn) {
                    newCloseBtn.addEventListener('click', function() {
                        console.log('‚ùå Áî®Êà∂ÈªûÊìäÈóúÈñâÊåâÈàïÔºàÂ≠∏ÁîüËºâÂÖ•ÂæåÔºâ');
                        closeAttendanceModal();
                    });
                }
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            // Ê∑ªÂä†ÊôÇÈñìÈôêÂà∂ÊèêÁ§∫
            let timeRestrictionMessage = '';
            if (minutesUntilStart !== null && minutesUntilStart > 10) {
                timeRestrictionMessage = `
                    <div style="
                        background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 193, 7, 0.1));
                        border: 1px solid rgba(255, 193, 7, 0.4);
                        border-radius: 15px;
                        padding: 15px;
                        margin-bottom: 20px;
                        text-align: center;
                        color: #856404;
                        font-weight: 600;
                    ">
                        <i class="fas fa-info-circle" style="margin-right: 8px; color: #ffc107;"></i>
                        Ë™≤Á®ãÈñãÂßãÂâç10ÂàÜÈêòÊâçËÉΩÈÄ≤Ë°åÁ∞ΩÂà∞ÔºåÁõÆÂâçÂè™ËÉΩÊü•ÁúãÂ≠∏ÁîüÂêçÂñÆ
                    </div>
                `;
            }
            
            const studentsHtml = students.map((student, index) => {
                // Á¢∫‰øùÂ≠∏ÁîüÊúâIDÔºåÂÑ™ÂÖà‰ΩøÁî®ÂßìÂêçÔºåÂ¶ÇÊûúÊ≤íÊúâÂâá‰ΩøÁî®Á¥¢Âºï
                const studentId = student.name || student.id || student.studentId || student.student_id || student.key || `student_${index}`;
                console.log(`üîç Â≠∏Áîü ${index + 1} ID ËôïÁêÜ:`, {
                    originalId: student.id,
                    studentId: student.studentId,
                    student_id: student.student_id,
                    key: student.key,
                    name: student.name,
                    finalId: studentId,
                    allKeys: Object.keys(student)
                });
                
                // Ê™¢Êü•‰ªäÂ§©ÁöÑÁ∞ΩÂà∞ÁãÄÊÖã
                const todayAttendance = student.attendance.find(record => record.date === today);
                let currentStatus = null;
                let statusText = '';
                
                if (todayAttendance) {
                    if (todayAttendance.present === true) {
                        currentStatus = 'present';
                        statusText = '‚úÖ Â∑≤Âá∫Â∏≠';
                    } else if (todayAttendance.present === false) {
                        currentStatus = 'absent';
                        statusText = '‚ùå Â∑≤Áº∫Â∏≠';
                    } else if (todayAttendance.present === 'leave') {
                        currentStatus = 'leave';
                        statusText = '‚ö†Ô∏è Â∑≤Ë´ãÂÅá';
                    }
                } else {
                    currentStatus = 'pending';
                    statusText = '‚è∞ ÂæÖÁ∞ΩÂà∞';
                }
                
                // Ê†πÊìöÁãÄÊÖãË®≠ÂÆöÊ®£Âºè
                let statusStyles = {
                    border: '#e9ecef',
                    background: 'white',
                    icon: 'fas fa-clock',
                    iconColor: '#6c757d',
                    statusColor: '#6c757d'
                };
                
                if (currentStatus === 'present') {
                    statusStyles = {
                        border: '#28a745',
                        background: 'linear-gradient(135deg, rgba(40, 167, 69, 0.25), rgba(32, 201, 151, 0.2))',
                        icon: 'fas fa-check-circle',
                        iconColor: '#28a745',
                        statusColor: '#28a745',
                        emoji: '‚úÖ'
                    };
                } else if (currentStatus === 'absent') {
                    statusStyles = {
                        border: '#dc3545',
                        background: 'linear-gradient(135deg, rgba(220, 53, 69, 0.25), rgba(231, 76, 60, 0.2))',
                        icon: 'fas fa-times-circle',
                        iconColor: '#dc3545',
                        statusColor: '#dc3545',
                        emoji: '‚ùå'
                    };
                } else if (currentStatus === 'leave') {
                    statusStyles = {
                        border: '#ffc107',
                        background: 'linear-gradient(135deg, rgba(255, 193, 7, 0.25), rgba(243, 156, 18, 0.2))',
                        icon: 'fas fa-exclamation-triangle',
                        iconColor: '#ffc107',
                        statusColor: '#ffc107',
                        emoji: '‚ö†Ô∏è'
                    };
                } else if (currentStatus === 'pending') {
                    statusStyles = {
                        border: '#6c757d',
                        background: 'linear-gradient(135deg, rgba(108, 117, 125, 0.2), rgba(73, 80, 87, 0.15))',
                        icon: 'fas fa-clock',
                        iconColor: '#6c757d',
                        statusColor: '#6c757d',
                        emoji: '‚è∞'
                    };
                }
                
                return `
                    <div class="student-card student-item attendance-student-item ${currentStatus ? currentStatus : ''}" data-student-id="${studentId}" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 16px;
                        border: 1px solid ${statusStyles.border};
                        border-radius: 12px;
                        background: ${statusStyles.background};
                        backdrop-filter: blur(25px);
                        -webkit-backdrop-filter: blur(25px);
                        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        position: relative;
                        overflow: hidden;
                        box-shadow: 
                            0 4px 20px rgba(0, 0, 0, 0.08),
                            inset 0 1px 0 rgba(255, 255, 255, 0.9);
                        transform-style: preserve-3d;
                        perspective: 1000px;
                        min-height: 60px;
                        margin-bottom: 8px;
                        animation: cardSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                    ">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <div style="
                                width: 28px;
                                height: 28px;
                                border-radius: 50%;
                                background: linear-gradient(135deg, #b8860b, #daa520);
                                color: rgba(0, 0, 0, 0.8);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                font-size: 0.8rem;
                                box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
                                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            ">
                                ${student.name.charAt(0)}
                            </div>
                            <div style="flex: 1;">
                                <div class="student-name" style="font-weight: 600; color: rgba(0, 0, 0, 0.9); font-size: 0.85rem; margin-bottom: 4px;">${student.name}</div>
                                <!-- ÁãÄÊÖãÊ®ôÁ±§ - ÂêçÂ≠ó‰∏ãÊñπ -->
                                <div class="status-tag" style="
                                    background: ${statusStyles.statusColor};
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 8px;
                                    font-size: 0.65rem;
                                    font-weight: 600;
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 3px;
                                    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
                                ">
                                    <span style="font-size: 0.7rem;">${statusStyles.emoji}</span>
                                    <span>${statusText}</span>
                                </div>
                                ${student.id ? `<div style="color: rgba(0, 0, 0, 0.6); font-size: 0.7rem; margin-top: 2px;">${student.id}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="attendance-btn present-btn liquid-button" data-student-id="${studentId}" 
                                data-minutes-until-start="${minutesUntilStart}"
                                data-disabled="${minutesUntilStart !== null && minutesUntilStart > 10}"
                                data-is-disabled="${minutesUntilStart !== null && minutesUntilStart > 10}"
                                style="
                                background: ${currentStatus === 'present' 
                                    ? 'linear-gradient(135deg, rgba(40, 167, 69, 1), rgba(32, 201, 151, 0.9))' 
                                    : minutesUntilStart !== null && minutesUntilStart > 10
                                        ? 'linear-gradient(135deg, rgba(108, 117, 125, 0.3), rgba(108, 117, 125, 0.2))'
                                        : 'linear-gradient(135deg, rgba(40, 167, 69, 0.6), rgba(32, 201, 151, 0.5))'};
                                color: ${minutesUntilStart !== null && minutesUntilStart > 10 ? 'rgba(0, 0, 0, 0.4)' : 'white'};
                                border: 1px solid ${currentStatus === 'present' ? 'rgba(40, 167, 69, 0.8)' : minutesUntilStart !== null && minutesUntilStart > 10 ? 'rgba(108, 117, 125, 0.3)' : 'rgba(255, 255, 255, 0.4)'};
                                padding: 8px 16px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 0.85rem;
                                font-weight: 600;
                                transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                opacity: 1;
                                position: relative;
                                overflow: hidden;
                                backdrop-filter: blur(15px);
                                -webkit-backdrop-filter: blur(15px);
                                box-shadow: ${currentStatus === 'present' 
                                    ? '0 6px 20px rgba(40, 167, 69, 0.5)' 
                                    : '0 3px 12px rgba(40, 167, 69, 0.3)'};
                                transform: ${currentStatus === 'present' ? 'scale(1.05)' : 'scale(1)'};
                            ">
                                <span style="margin-right: 6px; font-size: 0.9rem;">‚úÖ</span> Âá∫Â∏≠
                            </button>
                            <button class="attendance-btn absent-btn liquid-button" data-student-id="${studentId}" 
                                data-minutes-until-start="${minutesUntilStart}"
                                data-disabled="${minutesUntilStart !== null && minutesUntilStart > 10}"
                                data-is-disabled="${minutesUntilStart !== null && minutesUntilStart > 10}"
                                style="
                                background: ${currentStatus === 'absent' 
                                    ? 'linear-gradient(135deg, rgba(220, 53, 69, 1), rgba(231, 76, 60, 0.9))' 
                                    : minutesUntilStart !== null && minutesUntilStart > 10
                                        ? 'linear-gradient(135deg, rgba(108, 117, 125, 0.3), rgba(108, 117, 125, 0.2))'
                                        : 'linear-gradient(135deg, rgba(220, 53, 69, 0.6), rgba(231, 76, 60, 0.5))'};
                                color: ${minutesUntilStart !== null && minutesUntilStart > 10 ? 'rgba(0, 0, 0, 0.4)' : 'white'};
                                border: 1px solid ${currentStatus === 'absent' ? 'rgba(220, 53, 69, 0.8)' : minutesUntilStart !== null && minutesUntilStart > 10 ? 'rgba(108, 117, 125, 0.3)' : 'rgba(255, 255, 255, 0.4)'};
                                padding: 8px 16px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 0.85rem;
                                font-weight: 600;
                                transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                opacity: 1;
                                position: relative;
                                overflow: hidden;
                                backdrop-filter: blur(15px);
                                -webkit-backdrop-filter: blur(15px);
                                box-shadow: ${currentStatus === 'absent' 
                                    ? '0 6px 20px rgba(220, 53, 69, 0.5)' 
                                    : '0 3px 12px rgba(220, 53, 69, 0.3)'};
                                transform: ${currentStatus === 'absent' ? 'scale(1.05)' : 'scale(1)'};
                            ">
                                <span style="margin-right: 6px; font-size: 0.9rem;">‚ùå</span> Áº∫Â∏≠
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // ÈáçÁΩÆÈÄöÁü•ÁãÄÊÖã
            resetAttendanceNotification();
            
            attendanceContent.innerHTML = `
                <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                    <h3 style="margin: 0 0 12px 0; color: #333333; font-size: 1.1rem; text-shadow: none;">
                        <i class="fas fa-users" style="color: #b8860b; margin-right: 8px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                        Â≠∏ÁîüÂêçÂñÆ (${students.length} ‰∫∫)
                    </h3>
                    ${timeRestrictionMessage}
                    <div id="studentsList" style="
                        display: flex; 
                        flex-direction: column; 
                        gap: 8px; 
                        flex: 1; 
                        overflow-y: auto; 
                        padding-right: 8px;
                        max-height: 400px;
                    ">
                        ${studentsHtml}
                    </div>
                </div>
                
                <div style="
                    position: sticky;
                    bottom: 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 16px 20px;
                    background: 
                        radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.08) 0%, transparent 70%),
                        linear-gradient(135deg, 
                            rgba(255, 255, 255, 0.15) 0%, 
                            rgba(248, 249, 250, 0.1) 50%,
                            rgba(255, 255, 255, 0.15) 100%);
                    border-radius: 15px;
                    margin-top: 16px;
                    border: 1px solid rgba(255, 215, 0, 0.4);
                    backdrop-filter: blur(25px);
                    -webkit-backdrop-filter: blur(25px);
                    box-shadow: 
                        0 8px 32px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
                ">
                    <div id="attendanceStats" style="font-size: 0.85rem; color: #333333; text-shadow: none;">
                        Áµ±Ë®àËºâÂÖ•‰∏≠...
                    </div>
                </div>
            `;
            
        // Ë®≠ÁΩÆË™≤Á®ãÁõ£ËÅΩÂô®ÔºàÂª∂ÈÅ≤Âü∑Ë°åÁ¢∫‰øùDOMÂ∑≤Ê∏≤ÊüìÔºâ
        setTimeout(() => {
            // ÂÖàË®≠ÁΩÆÂ≠∏ÁîüÂç°ÁâáÈõôÊìäË™≤Á®ãÁõ£ËÅΩÂô®ÔºàÂõ†ÁÇ∫ÂÆÉÊúÉÈáçÊñ∞ÂâµÂª∫ÂÖÉÁ¥†Ôºâ
            setupStudentCardDoubleClickListeners();
            
            // ÂÜçË®≠ÁΩÆÊåâÈàï‰∫ã‰ª∂Áõ£ËÅΩÂô®
            setupAttendanceEventListeners(teacher, course, time, start, end);
            
            updateAttendanceStats();
        }, 100);
        }

        // Ë®≠ÁΩÆÁ∞ΩÂà∞Ë™≤Á®ãÁõ£ËÅΩÂô®
        function setupAttendanceEventListeners(teacher, course, time, start, end) {
            console.log('üîß Ë®≠ÁΩÆÁ∞ΩÂà∞‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºåÊâæÂà∞ÊåâÈàïÊï∏Èáè:', {
                presentBtns: document.querySelectorAll('.present-btn').length,
                absentBtns: document.querySelectorAll('.absent-btn').length,
                studentCards: document.querySelectorAll('.student-card').length
            });
            
            // Ê™¢Êü•ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.present-btn, .absent-btn').forEach((btn, index) => {
                console.log(`üîç ÊåâÈàï ${index + 1} ÁãÄÊÖã:`, {
                    studentId: btn.dataset.studentId,
                    disabled: btn.disabled,
                    dataDisabled: btn.dataset.disabled,
                    dataIsDisabled: btn.dataset.isDisabled,
                    pointerEvents: btn.style.pointerEvents,
                    className: btn.className,
                    minutesUntilStart: btn.dataset.minutesUntilStart,
                    hasDisabledAttribute: btn.hasAttribute('disabled'),
                    innerHTML: btn.innerHTML.substring(0, 50) + '...'
                });
            });
            
            // ÂÖàÁßªÈô§ÊâÄÊúâÁèæÊúâÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
            document.querySelectorAll('.present-btn').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            document.querySelectorAll('.absent-btn').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            // ÈáçÊñ∞Êü•Ë©¢ÊåâÈàïÔºàÂõ†ÁÇ∫ replaceWith ÂâµÂª∫‰∫ÜÊñ∞ÂÖÉÁ¥†Ôºâ
            const presentBtns = document.querySelectorAll('.present-btn');
            const absentBtns = document.querySelectorAll('.absent-btn');
            
            console.log('üîÑ ÈáçÊñ∞Êü•Ë©¢ÊåâÈàï:', {
                presentBtns: presentBtns.length,
                absentBtns: absentBtns.length
            });
            
            // ÂãïÊÖãË®≠ÁΩÆÊåâÈàïÁöÑ disabled Â±¨ÊÄß
            [...presentBtns, ...absentBtns].forEach(btn => {
                const minutesUntilStart = parseInt(btn.dataset.minutesUntilStart);
                const shouldDisable = minutesUntilStart !== null && minutesUntilStart > 10;
                
                console.log(`üîß Ë®≠ÁΩÆÊåâÈàï disabled Â±¨ÊÄß:`, {
                    studentId: btn.dataset.studentId,
                    minutesUntilStart: minutesUntilStart,
                    shouldDisable: shouldDisable,
                    currentDisabled: btn.disabled
                });
                
                if (shouldDisable) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
            });
            
            // Âá∫Â∏≠ÊåâÈàï
            presentBtns.forEach((btn, index) => {
                console.log(`üîß Á∂ÅÂÆöÂá∫Â∏≠ÊåâÈàï ${index + 1}:`, { 
                    studentId: btn.dataset.studentId, 
                    button: btn,
                    disabled: btn.disabled,
                    pointerEvents: btn.style.pointerEvents
                });
                
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('üéØ Âá∫Â∏≠ÊåâÈàïË¢´ÈªûÊìä‰∫ÜÔºÅ');
                    
                    const studentId = this.dataset.studentId;
                    console.log('üéØ Âá∫Â∏≠ÊåâÈàïÈªûÊìä:', { studentId, button: this, disabled: this.disabled });
                    
                    // Ê™¢Êü•ÊåâÈàïÊòØÂê¶Ë¢´Á¶ÅÁî®
                    if (this.disabled) {
                        console.log('‚ö†Ô∏è ÊåâÈàïË¢´Á¶ÅÁî®ÔºåÁÑ°Ê≥ïÈªûÊìä');
                        return;
                    }
                    
                    const studentItem = document.querySelector(`.student-card[data-student-id="${studentId}"]`);
                    console.log('üîç ÊâæÂà∞Â≠∏ÁîüÂç°Áâá:', { studentItem, studentId });
                    
                    const studentName = studentItem ? 
                        studentItem.querySelector('.student-name')?.textContent || studentId : 
                        studentId;
                    
                    // Ê∑ªÂä†ÊåâÈàïËºâÂÖ•ÂãïÁï´
                    this.style.animation = 'buttonPress 0.3s ease-out';
                    this.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> ËôïÁêÜ‰∏≠...';
                    this.style.pointerEvents = 'none';
                    
                    try {
                        console.log('üöÄ ÈñãÂßãË™øÁî® saveSingleAttendanceRecord API');
                        // Á´ãÂç≥ÁôºÈÄÅÂá∫Â∏≠Ë®òÈåÑ
                        await saveSingleAttendanceRecord(teacher, course, time, start, end, studentId, studentName, 'present');
                        console.log('‚úÖ saveSingleAttendanceRecord API Ë™øÁî®ÂÆåÊàê');
                        
                        // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                        setTimeout(() => {
                            this.innerHTML = '<span style="margin-right: 8px; font-size: 1rem;">‚úÖ</span> Âá∫Â∏≠';
                            this.style.pointerEvents = 'auto';
                            this.style.animation = '';
                        }, 1000);
                    } catch (error) {
                        console.error('‚ùå Âá∫Â∏≠ÊåâÈàïËôïÁêÜÂ§±Êïó:', error);
                        // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                        this.innerHTML = '<span style="margin-right: 8px; font-size: 1rem;">‚úÖ</span> Âá∫Â∏≠';
                        this.style.pointerEvents = 'auto';
                        this.style.animation = '';
                    }
                });
            });
            
            // Áº∫Â∏≠ÊåâÈàï
            absentBtns.forEach((btn, index) => {
                console.log(`üîß Á∂ÅÂÆöÁº∫Â∏≠ÊåâÈàï ${index + 1}:`, { 
                    studentId: btn.dataset.studentId, 
                    button: btn,
                    disabled: btn.disabled,
                    pointerEvents: btn.style.pointerEvents
                });
                
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('üéØ Áº∫Â∏≠ÊåâÈàïË¢´ÈªûÊìä‰∫ÜÔºÅ');
                    
                    const studentId = this.dataset.studentId;
                    console.log('üéØ Áº∫Â∏≠ÊåâÈàïÈªûÊìä:', { studentId, button: this, disabled: this.disabled });
                    
                    // Ê™¢Êü•ÊåâÈàïÊòØÂê¶Ë¢´Á¶ÅÁî®
                    if (this.disabled) {
                        console.log('‚ö†Ô∏è ÊåâÈàïË¢´Á¶ÅÁî®ÔºåÁÑ°Ê≥ïÈªûÊìä');
                        return;
                    }
                    
                    const studentItem = document.querySelector(`.student-card[data-student-id="${studentId}"]`);
                    console.log('üîç ÊâæÂà∞Â≠∏ÁîüÂç°Áâá:', { studentItem, studentId });
                    
                    const studentName = studentItem ? 
                        studentItem.querySelector('.student-name')?.textContent || studentId : 
                        studentId;
                    
                    // Ê∑ªÂä†ÊåâÈàïËºâÂÖ•ÂãïÁï´
                    this.style.animation = 'buttonPress 0.3s ease-out';
                    this.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> ËôïÁêÜ‰∏≠...';
                    this.style.pointerEvents = 'none';
                    
                    try {
                        console.log('üöÄ ÈñãÂßãË™øÁî® saveSingleAttendanceRecord API (Áº∫Â∏≠)');
                        // Á´ãÂç≥ÁôºÈÄÅÁº∫Â∏≠Ë®òÈåÑ
                        await saveSingleAttendanceRecord(teacher, course, time, start, end, studentId, studentName, 'absent');
                        console.log('‚úÖ saveSingleAttendanceRecord API Ë™øÁî®ÂÆåÊàê (Áº∫Â∏≠)');
                        
                        // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                        setTimeout(() => {
                            this.innerHTML = '<span style="margin-right: 8px; font-size: 1rem;">‚ùå</span> Áº∫Â∏≠';
                            this.style.pointerEvents = 'auto';
                            this.style.animation = '';
                        }, 1000);
                    } catch (error) {
                        console.error('‚ùå Áº∫Â∏≠ÊåâÈàïËôïÁêÜÂ§±Êïó:', error);
                        // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                        this.innerHTML = '<span style="margin-right: 8px; font-size: 1rem;">‚ùå</span> Áº∫Â∏≠';
                        this.style.pointerEvents = 'auto';
                        this.style.animation = '';
                    }
                });
            });
        }

        // ÈÄöÁü•Áõ∏ÈóúËÆäÊï∏
        let attendanceNotificationSent = false;
        let studentAttendanceStatus = {};
        let attendanceCheckTimer = null;

        // ÂÑ≤Â≠òÂñÆÁ≠ÜÁ∞ΩÂà∞Ë®òÈåÑ
        async function saveSingleAttendanceRecord(teacher, course, time, start, end, studentId, studentName, status) {
            try {
                console.log('üíæ Á´ãÂç≥ÂÑ≤Â≠òÂñÆÁ≠ÜÁ∞ΩÂà∞Ë®òÈåÑ:', { teacher, course, time, start, end, studentId, studentName, status });
                
                // Áç≤Âèñ‰ªäÂ§©ÁöÑÊó•Êúü
                const today = new Date().toISOString().split('T')[0];
                
                // ÊßãÂª∫ÂñÆÁ≠ÜÁ∞ΩÂà∞Ë®òÈåÑ
                const attendanceRecord = {
                    studentName: studentName,
                    studentId: studentId,
                    date: today,
                    present: status === 'present' ? true : false,
                    teacher: teacher,
                    course: course,
                    period: time  // ‰ΩøÁî® period ËÄå‰∏çÊòØ time
                };
                
                console.log('üì§ Ê∫ñÂÇôÂÑ≤Â≠òÁöÑÂñÆÁ≠ÜË®òÈåÑ:', attendanceRecord);
                
                // ‰ΩøÁî®ÂæåÁ´Ø‰ª£ÁêÜ API
                const proxyUrl = '/api/proxy/google-sheets';
                const payload = {
                    action: 'updateAttendance',
                    records: [attendanceRecord] // ÂåÖË£ùÊàêÈô£Âàó
                };
                
                console.log('üì§ ÁôºÈÄÅ‰ª£ÁêÜË´ãÊ±Ç:', { proxyUrl, payload });
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`‰ª£ÁêÜ API Ë´ãÊ±ÇÂ§±Êïó: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì• ‰ª£ÁêÜ API ÂõûÊáâ:', data);
                
                // Ê™¢Êü•ÊòØÂê¶ÊúâÊàêÂäüÁöÑË®òÈåÑ
                if (data.results && data.results.length > 0) {
                    const successResults = data.results.filter(r => r.success === true);
                    const failedResults = data.results.filter(r => r.success === false);
                    
                    if (successResults.length > 0) {
                        // ÊúâÊàêÂäüÁöÑË®òÈåÑÔºåÊõ¥Êñ∞UI
                        updateStudentStatus(studentId, status);
                        updateAttendanceStats();
                        
                        // Êõ¥Êñ∞Â≠∏ÁîüÁ∞ΩÂà∞ÁãÄÊÖã‰∏¶Ëß∏ÁôºÈÄöÁü•Ê™¢Êü•
                        studentAttendanceStatus[studentId] = status;
                        updateAttendanceProgress(); // Êõ¥Êñ∞ÈÄ≤Â∫¶È°ØÁ§∫
                        startAttendanceCheckTimer();
                        return;
                    } else if (failedResults.length > 0) {
                        // ÊâÄÊúâË®òÈåÑÈÉΩÂ§±ÊïóÔºåÈ°ØÁ§∫ÈåØË™§
                        console.error('‚ùå API ËøîÂõûÂ§±Êïó:', data);
                        const errorMessage = failedResults[0].error || 'Êú™Áü•ÈåØË™§';
                        alert(`ÂÑ≤Â≠òÂ§±Êïó: ${errorMessage}\n\nË´ãÈáçË©¶„ÄÇ`);
                        return;
                    }
                }
                
                // Â¶ÇÊûúÊ≤íÊúâ results Êàñ success ÁÇ∫ false
                if (!data.success) {
                    console.error('‚ùå API ËøîÂõûÂ§±Êïó:', data);
                    const errorMessage = data.error || data.message || 'Êú™Áü•ÈåØË™§';
                    alert(`ÂÑ≤Â≠òÂ§±Êïó: ${errorMessage}\n\nË´ãÈáçË©¶„ÄÇ`);
                    return;
                }
                
                // Êõ¥Êñ∞Â≠∏ÁîüÁãÄÊÖãÈ°ØÁ§∫
                updateStudentStatus(studentId, status);
                updateAttendanceStats();
                
                // Êõ¥Êñ∞Â≠∏ÁîüÁ∞ΩÂà∞ÁãÄÊÖã‰∏¶Ëß∏ÁôºÈÄöÁü•Ê™¢Êü•
                studentAttendanceStatus[studentId] = status;
                updateAttendanceProgress(); // Êõ¥Êñ∞ÈÄ≤Â∫¶È°ØÁ§∫
                startAttendanceCheckTimer();
                
            } catch (error) {
                console.error('‚ùå ÂÑ≤Â≠òÂñÆÁ≠ÜÁ∞ΩÂà∞Ë®òÈåÑÂ§±Êïó:', error);
                alert(`ÂÑ≤Â≠òÂ§±Êïó: ${error.message}\n\nË´ãÈáçË©¶„ÄÇ`);
            }
        }

        // Ê™¢Ê∏¨ÊòØÂê¶ÊâÄÊúâÂ≠∏ÁîüÈÉΩÂ∑≤Á∞ΩÂà∞
        function checkAllStudentsMarked() {
            const studentCards = document.querySelectorAll('.student-card');
            const totalStudents = studentCards.length;
            
            // Ë®àÁÆóÊúâÈÄ≤Â∫¶ÁöÑÂ≠∏ÁîüÊï∏ÈáèÔºàÈô§‰∫Ü"Êú™Á∞ΩÂà∞"‰ª•Â§ñÁöÑÊâÄÊúâÁãÄÊÖãÈÉΩÁÆóÈÄ≤Â∫¶Ôºâ
            let markedStudents = 0;
            studentCards.forEach(card => {
                const studentName = card.querySelector('.student-name')?.textContent?.trim();
                if (studentName) {
                    // Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Êúâ‰ªª‰ΩïÁãÄÊÖãÔºàÁï∂Ê¨°Á∞ΩÂà∞ÊàñÊ≠∑Âè≤ÁãÄÊÖãÔºâ
                    const currentStatus = studentAttendanceStatus[studentName];
                    const hasStatus = card.querySelector('.status-tag');
                    const statusText = hasStatus ? hasStatus.textContent.trim() : '';
                    
                    // Â¶ÇÊûúÊúâÁï∂Ê¨°Á∞ΩÂà∞ÁãÄÊÖãÔºåÊàñËÄÖÊúâÊ≠∑Âè≤ÁãÄÊÖãÊ®ôÁ±§ÔºàÂåÖÂê´Âá∫Â∏≠„ÄÅÁº∫Â∏≠„ÄÅË´ãÂÅáÁ≠âÔºâÔºåÂ∞±ÁÆóÊúâÈÄ≤Â∫¶
                    // ÊéíÈô§"ÂæÖÁ∞ΩÂà∞"„ÄÅ"Êú™Á∞ΩÂà∞"Á≠âÁÑ°ÈÄ≤Â∫¶ÁãÄÊÖã
                    if (currentStatus || 
                        (statusText && 
                         !statusText.includes('ÂæÖÁ∞ΩÂà∞') && !statusText.includes('Êú™Á∞ΩÂà∞') && !statusText.includes('ÂæÖÈÅ∏Êìá') &&
                         (statusText.includes('Âá∫Â∏≠') || statusText.includes('Present') || statusText.includes('‚úÖ') || statusText.includes('Â∑≤Âá∫Â∏≠') ||
                          statusText.includes('Áº∫Â∏≠') || statusText.includes('Absent') || statusText.includes('‚ùå') || statusText.includes('Â∑≤Áº∫Â∏≠') ||
                          statusText.includes('Ë´ãÂÅá') || statusText.includes('Leave') || statusText.includes('‚ö†Ô∏è') || statusText.includes('Â∑≤Ë´ãÂÅá')))) {
                        markedStudents++;
                        console.log(`‚úÖ Â≠∏Áîü ${studentName} ÊúâÈÄ≤Â∫¶: Áï∂Ê¨°=${currentStatus}, Ê≠∑Âè≤=${statusText}`);
                    } else {
                        console.log(`‚è≥ Â≠∏Áîü ${studentName} ÁÑ°ÈÄ≤Â∫¶: Áï∂Ê¨°=${currentStatus}, Ê≠∑Âè≤=${statusText}`);
                    }
                }
            });
            
            console.log(`üîç Á∞ΩÂà∞ÂÆåÊàêÊ™¢Ê∏¨: ${markedStudents}/${totalStudents} Â≠∏ÁîüÊúâÈÄ≤Â∫¶`);
            console.log('üìã Áï∂Ê¨°Ê®ôË®òÂ≠∏Áîü:', Object.keys(studentAttendanceStatus));
            console.log('üìã Â≠∏ÁîüÂç°ÁâáÊï∏Èáè:', studentCards.length);
            
            const isComplete = markedStudents === totalStudents;
            console.log(`‚úÖ Á∞ΩÂà∞ÂÆåÊàêÁãÄÊÖã: ${isComplete ? 'ÂÆåÊàê' : 'Êú™ÂÆåÊàê'}`);
            
            return isComplete;
        }

        // ÂïüÂãïÁ∞ΩÂà∞Ê™¢Êü•ÂÆöÊôÇÂô®
        function startAttendanceCheckTimer() {
            // Ê∏ÖÈô§ËàäÁöÑÂÆöÊôÇÂô®
            if (attendanceCheckTimer) {
                clearTimeout(attendanceCheckTimer);
            }
            
            // Á≠âÂæÖ3ÁßíÂæåÊ™¢Êü•‰∏¶ÁôºÈÄÅÈÄöÁü•ÔºàÁµ¶Áî®Êà∂ÊôÇÈñìÈáçÊñ∞‰øÆÊ≠£ÁãÄÊÖãÔºâ
            console.log('‚è∞ Á≠âÂæÖ3ÁßíÂæåÁôºÈÄÅÈÄöÁü•...');
            attendanceCheckTimer = setTimeout(() => {
                sendBatchAttendanceNotification();
            }, 3000);
        }

        // ÊâπÈáèÁôºÈÄÅÂ≠∏ÁîüÁ∞ΩÂà∞ÈÄöÁü•
        async function sendBatchAttendanceNotification() {
            // Â¶ÇÊûúÂ∑≤Á∂ìÁôºÈÄÅÈÅéÈÄöÁü•Ôºå‰∏çÂÜçÈáçË§áÁôºÈÄÅ
            if (attendanceNotificationSent) return;
            
            // Ê™¢Êü•ÊòØÂê¶Êúâ‰ªª‰ΩïÂ≠∏ÁîüË¢´Ê®ôË®ò
            const hasMarkedStudents = Object.keys(studentAttendanceStatus).length > 0;
            if (!hasMarkedStudents) return;
            
            console.log('üì§ Ê∫ñÂÇôÁôºÈÄÅÂ≠∏ÁîüÁ∞ΩÂà∞ÈÄöÁü•...');
            
            // Áç≤ÂèñÁï∂ÂâçË™≤Á®ã‰ø°ÊÅØ
            const currentEvent = getCurrentEventInfo();
            if (!currentEvent) {
                console.log('‚ùå ÁÑ°Ê≥ïÁç≤ÂèñÁï∂ÂâçË™≤Á®ã‰ø°ÊÅØ');
                return;
            }
            
            const { teacher, course, time } = currentEvent;
            
            // ÂàÜÈ°ûÂ≠∏ÁîüÁãÄÊÖã
            const presentStudents = [];
            const absentStudents = [];
            const unmarkedStudents = [];
            
            // Áç≤ÂèñÊâÄÊúâÂ≠∏ÁîüÂç°Áâá
            const studentCards = document.querySelectorAll('.student-card');
            studentCards.forEach(card => {
                const studentName = card.querySelector('.student-name')?.textContent?.trim();
                if (studentName) {
                    // ÂÑ™ÂÖà‰ΩøÁî®Áï∂Ê¨°Á∞ΩÂà∞ÁãÄÊÖãÔºåÂ¶ÇÊûúÊ≤íÊúâÂâáÊ™¢Êü•Ê≠∑Âè≤ÁãÄÊÖãÊ®ôÁ±§
                    let status = studentAttendanceStatus[studentName];
                    
                    if (!status) {
                        // Ê™¢Êü•Ê≠∑Âè≤ÁãÄÊÖãÊ®ôÁ±§
                        const statusTag = card.querySelector('.status-tag');
                        if (statusTag) {
                            const statusText = statusTag.textContent.trim();
                            console.log(`üîç Ê™¢Êü•Â≠∏Áîü ${studentName} ÁöÑÊ≠∑Âè≤ÁãÄÊÖã: "${statusText}"`);
                            
                            // ÊéíÈô§"ÂæÖÁ∞ΩÂà∞"„ÄÅ"Êú™Á∞ΩÂà∞"Á≠âÁÑ°ÈÄ≤Â∫¶ÁãÄÊÖã
                            if (!statusText.includes('ÂæÖÁ∞ΩÂà∞') && !statusText.includes('Êú™Á∞ΩÂà∞') && !statusText.includes('ÂæÖÈÅ∏Êìá')) {
                                if (statusText.includes('Âá∫Â∏≠') || statusText.includes('Present') || statusText.includes('‚úÖ') || statusText.includes('Â∑≤Âá∫Â∏≠')) {
                                    status = 'present';
                                    console.log(`‚úÖ Â≠∏Áîü ${studentName} Ê≠∑Âè≤ÁãÄÊÖãÁÇ∫Âá∫Â∏≠`);
                                } else if (statusText.includes('Áº∫Â∏≠') || statusText.includes('Absent') || statusText.includes('‚ùå') || statusText.includes('Â∑≤Áº∫Â∏≠')) {
                                    status = 'absent';
                                    console.log(`‚ùå Â≠∏Áîü ${studentName} Ê≠∑Âè≤ÁãÄÊÖãÁÇ∫Áº∫Â∏≠`);
                                } else if (statusText.includes('Ë´ãÂÅá') || statusText.includes('Leave') || statusText.includes('‚ö†Ô∏è') || statusText.includes('Â∑≤Ë´ãÂÅá')) {
                                    status = 'leave';
                                    console.log(`‚ö†Ô∏è Â≠∏Áîü ${studentName} Ê≠∑Âè≤ÁãÄÊÖãÁÇ∫Ë´ãÂÅá`);
                                }
                            } else {
                                console.log(`‚è≥ Â≠∏Áîü ${studentName} Ê≠∑Âè≤ÁãÄÊÖãÁÇ∫ÂæÖÁ∞ΩÂà∞Ôºå‰∏çÁÆóÈÄ≤Â∫¶`);
                            }
                        }
                    } else {
                        console.log(`üìù Â≠∏Áîü ${studentName} Áï∂Ê¨°Á∞ΩÂà∞ÁãÄÊÖã: ${status}`);
                    }
                    
                    // Ê†πÊìöÁãÄÊÖãÂàÜÈ°û
                    if (status === 'present') {
                        presentStudents.push(studentName);
                        console.log(`‚úÖ Â≠∏Áîü ${studentName} Ê≠∏È°ûÁÇ∫Âá∫Â∏≠`);
                    } else if (status === 'absent') {
                        absentStudents.push(studentName);
                        console.log(`‚ùå Â≠∏Áîü ${studentName} Ê≠∏È°ûÁÇ∫Áº∫Â∏≠`);
                    } else if (status === 'leave') {
                        // Ë´ãÂÅá‰πüÁÆóÈÄ≤Â∫¶ÔºåÂèØ‰ª•ÂñÆÁç®ÂàÜÈ°ûÊàñÊ≠∏È°ûÂà∞Áº∫Â∏≠
                        absentStudents.push(studentName + '(Ë´ãÂÅá)');
                        console.log(`‚ö†Ô∏è Â≠∏Áîü ${studentName} Ê≠∏È°ûÁÇ∫Ë´ãÂÅá`);
                    } else {
                        unmarkedStudents.push(studentName);
                        console.log(`‚è≥ Â≠∏Áîü ${studentName} Ê≠∏È°ûÁÇ∫Êú™ÈÅ∏Êìá`);
                    }
                }
            });
            
            console.log(`üìä Â≠∏ÁîüÁãÄÊÖãÂàÜÈ°ûÁµêÊûú:`, {
                present: presentStudents,
                absent: absentStudents,
                unmarked: unmarkedStudents,
                total: presentStudents.length + absentStudents.length + unmarkedStudents.length
            });
            
            // Ê™¢Êü•ÊòØÂê¶ÊâÄÊúâÂ≠∏ÁîüÈÉΩÂ∑≤Á∞ΩÂà∞
            const allStudentsMarked = checkAllStudentsMarked();
            const totalStudents = presentStudents.length + absentStudents.length + unmarkedStudents.length;
            
            // ÊßãÂª∫ÈÄöÁü•Ë®äÊÅØ
            let message = `üìö Â≠∏ÁîüÁ∞ΩÂà∞ÈÄöÁü•\n\n`;
            message += `üë®‚Äçüè´ Ë¨õÂ∏´Ôºö${teacher || 'Êú™Áü•Ë¨õÂ∏´'}\n`;
            message += `üìñ Ë™≤Á®ãÔºö${course || 'Êú™Áü•Ë™≤Á®ã'}\n`;
            message += `üìÖ Êó•ÊúüÔºö${new Date().toLocaleDateString('zh-TW')}\n\n`;
            
            // Á∞ΩÂà∞ÂÆåÊàêÁãÄÊÖã
            if (allStudentsMarked) {
                message += `üéâ Á∞ΩÂà∞ÂÆåÊàêÔºÅÊâÄÊúâÂ≠∏ÁîüÂ∑≤Ê®ôË®ò\n\n`;
            } else {
                // Ë®àÁÆóÁ∏ΩÈÄ≤Â∫¶ÔºàÂåÖÊã¨Ê≠∑Âè≤ÁãÄÊÖãÔºâ
                let totalProgress = 0;
                studentCards.forEach(card => {
                    const studentName = card.querySelector('.student-name')?.textContent?.trim();
                    if (studentName) {
                        const currentStatus = studentAttendanceStatus[studentName];
                        const hasStatus = card.querySelector('.status-tag');
                        const statusText = hasStatus ? hasStatus.textContent.trim() : '';
                        
                        if (currentStatus || (statusText && statusText !== 'Êú™Á∞ΩÂà∞' && statusText !== 'ÂæÖÁ∞ΩÂà∞')) {
                            totalProgress++;
                        }
                    }
                });
                
                message += `‚è≥ Á∞ΩÂà∞ÈÄ≤Ë°å‰∏≠ (${totalProgress}/${totalStudents} ÊúâÈÄ≤Â∫¶)\n\n`;
            }
            
            if (presentStudents.length > 0) {
                message += `‚úÖ Âá∫Â∏≠ (${presentStudents.length}‰∫∫)Ôºö\n${presentStudents.join('„ÄÅ')}\n\n`;
            }
            
            if (absentStudents.length > 0) {
                message += `‚ùå Áº∫Â∏≠ (${absentStudents.length}‰∫∫)Ôºö\n${absentStudents.join('„ÄÅ')}\n\n`;
            }
            
            if (unmarkedStudents.length > 0) {
                message += `‚è≥ Êú™ÈÅ∏Êìá (${unmarkedStudents.length}‰∫∫)Ôºö\n${unmarkedStudents.join('„ÄÅ')}\n\n`;
            }
            
            message += `‚è∞ Á∞ΩÂà∞ÊôÇÈñìÔºö${new Date().toLocaleString('zh-TW')}`;
            
            try {
                // ÁôºÈÄÅÈÄöÁü•
                const response = await fetch('/api/student-attendance-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        teacherName: teacher,
                        courseName: course,
                        presentStudents: presentStudents,
                        absentStudents: absentStudents,
                        unmarkedStudents: unmarkedStudents
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    attendanceNotificationSent = true;
                    console.log('‚úÖ Â≠∏ÁîüÁ∞ΩÂà∞ÈÄöÁü•Â∑≤ÁôºÈÄÅÔºÅ');
                    showToast('‚úÖ Â≠∏ÁîüÁ∞ΩÂà∞ÈÄöÁü•Â∑≤ÁôºÈÄÅÔºÅ');
                } else {
                    console.error('‚ùå ÈÄöÁü•ÁôºÈÄÅÂ§±Êïó:', data.error);
                    showToast('‚ùå ÈÄöÁü•ÁôºÈÄÅÂ§±Êïó');
                }
            } catch (error) {
                console.error('ÁôºÈÄÅÈÄöÁü•ÈåØË™§:', error);
                showToast('‚ùå ÈÄöÁü•ÁôºÈÄÅÂ§±Êïó');
            }
        }

        // Áç≤ÂèñÁï∂ÂâçË™≤Á®ã‰ø°ÊÅØ
        function getCurrentEventInfo() {
            console.log('üîç ÂòóË©¶Áç≤ÂèñÁï∂ÂâçË™≤Á®ã‰ø°ÊÅØ...');
            
            // ÂæûÊ®°ÊÖãÊ°ÜÂÖßÂÆπ‰∏≠Áç≤ÂèñË™≤Á®ã‰ø°ÊÅØ
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) {
                console.log('‚ùå Êâæ‰∏çÂà∞Á∞ΩÂà∞Ê®°ÊÖãÊ°Ü');
                return null;
            }
            
            // ÂòóË©¶ÂæûË™≤Á®ã‰ø°ÊÅØÈù¢ÊùøÁç≤Âèñ
            const courseInfoPanel = modalContent.querySelector('.course-info-panel');
            if (courseInfoPanel) {
                const teacherElement = courseInfoPanel.querySelector('[data-field="teacher"]');
                const courseElement = courseInfoPanel.querySelector('[data-field="course"]');
                const timeElement = courseInfoPanel.querySelector('[data-field="time"]');
                
                if (teacherElement && courseElement && timeElement) {
                    const teacher = teacherElement.textContent.replace('Ë¨õÂ∏´:', '').trim();
                    const course = courseElement.textContent.replace('Ë™≤Á®ã:', '').trim();
                    const time = timeElement.textContent.replace('ÊôÇÈñì:', '').trim();
                    
                    console.log('‚úÖ ÂæûË™≤Á®ã‰ø°ÊÅØÈù¢ÊùøÁç≤Âèñ:', { teacher, course, time });
                    return { teacher, course, time };
                }
            }
            
            // ÂÇôÁî®ÊñπÊ°àÔºöÂæûÊ®°ÊÖãÊ°ÜÊ®ôÈ°åËß£Êûê
            const modalTitle = modalContent.querySelector('h2');
            if (modalTitle) {
                const titleText = modalTitle.textContent;
                console.log('üîç ÂæûÊ®ôÈ°åËß£Êûê:', titleText);
                
                // Ëß£ÊûêÊ®ôÈ°åÁç≤ÂèñË¨õÂ∏´ÂíåË™≤Á®ã‰ø°ÊÅØ
                const teacherMatch = titleText.match(/Ë¨õÂ∏´[Ôºö:]\s*([^Ë™≤Á®ã]+)/);
                const courseMatch = titleText.match(/Ë™≤Á®ã[Ôºö:]\s*([^ÊôÇÈñì]+)/);
                const timeMatch = titleText.match(/ÊôÇÈñì[Ôºö:]\s*([^Êó•Êúü]+)/);
                
                const result = {
                    teacher: teacherMatch ? teacherMatch[1].trim() : 'Êú™Áü•Ë¨õÂ∏´',
                    course: courseMatch ? courseMatch[1].trim() : 'Êú™Áü•Ë™≤Á®ã',
                    time: timeMatch ? timeMatch[1].trim() : 'Êú™Áü•ÊôÇÈñì'
                };
                
                console.log('‚úÖ ÂæûÊ®ôÈ°åËß£ÊûêÁµêÊûú:', result);
                return result;
            }
            
            console.log('‚ùå ÁÑ°Ê≥ïÁç≤ÂèñË™≤Á®ã‰ø°ÊÅØ');
            return null;
        }

        // Êõ¥Êñ∞Á∞ΩÂà∞ÈÄ≤Â∫¶È°ØÁ§∫
        function updateAttendanceProgress() {
            const studentCards = document.querySelectorAll('.student-card');
            const totalStudents = studentCards.length;
            
            // Ë®àÁÆóÊúâÈÄ≤Â∫¶ÁöÑÂ≠∏ÁîüÊï∏ÈáèÔºàÂåÖÊã¨Ê≠∑Âè≤ÁãÄÊÖãÔºâ
            let markedStudents = 0;
            studentCards.forEach(card => {
                const studentName = card.querySelector('.student-name')?.textContent?.trim();
                if (studentName) {
                    // Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Êúâ‰ªª‰ΩïÁãÄÊÖãÔºàÁï∂Ê¨°Á∞ΩÂà∞ÊàñÊ≠∑Âè≤ÁãÄÊÖãÔºâ
                    const currentStatus = studentAttendanceStatus[studentName];
                    const hasStatus = card.querySelector('.status-tag');
                    const statusText = hasStatus ? hasStatus.textContent.trim() : '';
                    
                    // Â¶ÇÊûúÊúâÁï∂Ê¨°Á∞ΩÂà∞ÁãÄÊÖãÔºåÊàñËÄÖÊúâÊ≠∑Âè≤ÁãÄÊÖãÊ®ôÁ±§ÔºàÂåÖÂê´Âá∫Â∏≠„ÄÅÁº∫Â∏≠„ÄÅË´ãÂÅáÁ≠âÔºâÔºåÂ∞±ÁÆóÊúâÈÄ≤Â∫¶
                    // ÊéíÈô§"ÂæÖÁ∞ΩÂà∞"„ÄÅ"Êú™Á∞ΩÂà∞"Á≠âÁÑ°ÈÄ≤Â∫¶ÁãÄÊÖã
                    if (currentStatus || 
                        (statusText && 
                         !statusText.includes('ÂæÖÁ∞ΩÂà∞') && !statusText.includes('Êú™Á∞ΩÂà∞') && !statusText.includes('ÂæÖÈÅ∏Êìá') &&
                         (statusText.includes('Âá∫Â∏≠') || statusText.includes('Present') || statusText.includes('‚úÖ') || statusText.includes('Â∑≤Âá∫Â∏≠') ||
                          statusText.includes('Áº∫Â∏≠') || statusText.includes('Absent') || statusText.includes('‚ùå') || statusText.includes('Â∑≤Áº∫Â∏≠') ||
                          statusText.includes('Ë´ãÂÅá') || statusText.includes('Leave') || statusText.includes('‚ö†Ô∏è') || statusText.includes('Â∑≤Ë´ãÂÅá')))) {
                        markedStudents++;
                    }
                }
            });
            
            const progress = totalStudents > 0 ? (markedStudents / totalStudents) * 100 : 0;
            
            console.log(`üìä Êõ¥Êñ∞ÈÄ≤Â∫¶È°ØÁ§∫: ${markedStudents}/${totalStudents} (${progress}%)`);
            console.log(`üìä Áï∂Ê¨°Ê®ôË®ò: ${Object.keys(studentAttendanceStatus).length}, Á∏ΩÈÄ≤Â∫¶: ${markedStudents}`);
            
            // ÁßªÈô§ËàäÁöÑÊµÆÂãïÈÄöÁü•
            const existingNotification = document.querySelector('.floating-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // ÂâµÂª∫Êñ∞ÁöÑÊµÆÂãïÈÄöÁü•
            const notification = document.createElement('div');
            notification.className = 'floating-notification progress';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">üìä</div>
                    <div class="notification-text">
                        <div>Á∞ΩÂà∞ÈÄ≤Â∫¶</div>
                        <div class="progress-bar-floating">
                            <div class="progress-fill-floating" style="width: ${progress}%"></div>
                        </div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${markedStudents}/${totalStudents} Â≠∏ÁîüÂ∑≤Ê®ôË®ò</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Ëß∏ÁôºÈ°ØÁ§∫ÂãïÁï´
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Â¶ÇÊûúÊâÄÊúâÂ≠∏ÁîüÈÉΩÂ∑≤Á∞ΩÂà∞ÔºåÈ°ØÁ§∫ÂÆåÊàêÈÄöÁü•
            if (markedStudents === totalStudents && totalStudents > 0) {
                setTimeout(() => {
                    showCompletionNotification();
                }, 500);
            }
            
            console.log('‚úÖ ÊµÆÂãïÈÄ≤Â∫¶ÈÄöÁü•Â∑≤È°ØÁ§∫');
        }
        
        // È°ØÁ§∫ÂÆåÊàêÈÄöÁü•
        function showCompletionNotification() {
            // ÁßªÈô§ÈÄ≤Â∫¶ÈÄöÁü•
            const progressNotification = document.querySelector('.floating-notification.progress');
            if (progressNotification) {
                progressNotification.remove();
            }
            
            // ÂâµÂª∫ÂÆåÊàêÈÄöÁü•
            const notification = document.createElement('div');
            notification.className = 'floating-notification completion';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">üéâ</div>
                    <div class="notification-text">
                        <div>Á∞ΩÂà∞ÂÆåÊàêÔºÅ</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">ÊâÄÊúâÂ≠∏ÁîüÂ∑≤Ê®ôË®ò</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Ëß∏ÁôºÈ°ØÁ§∫ÂãïÁï´
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // 5ÁßíÂæåËá™ÂãïÈö±Ëóè
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 400);
                }
            }, 5000);
            
            console.log('‚úÖ ÊµÆÂãïÂÆåÊàêÈÄöÁü•Â∑≤È°ØÁ§∫');
        }

        // ÈáçÁΩÆÁ∞ΩÂà∞ÈÄöÁü•ÁãÄÊÖãÔºàÁï∂ÈñãÂßãÊñ∞ÁöÑÁ∞ΩÂà∞ÊôÇÔºâ
        function resetAttendanceNotification() {
            attendanceNotificationSent = false;
            studentAttendanceStatus = {};
            
            // Ê∏ÖÈô§ÂÆöÊôÇÂô®
            if (attendanceCheckTimer) {
                clearTimeout(attendanceCheckTimer);
                attendanceCheckTimer = null;
            }
        }

        // È°ØÁ§∫ Toast ÈÄöÁü•
        function showToast(message, type = 'success') {
            // ÂâµÂª∫ toast ÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 500;
                max-width: 300px;
                word-wrap: break-word;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // È°ØÁ§∫ÂãïÁï´
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // 3ÁßíÂæåËá™ÂãïÈö±Ëóè
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Êõ¥Êñ∞Â≠∏ÁîüÁãÄÊÖã
        function updateStudentStatus(studentId, status) {
            // Á≤æÁ¢∫Êü•ÊâæÂ≠∏ÁîüÂç°ÁâáÔºåÈÅøÂÖçÊâæÂà∞ÊåâÈàï
            let studentItem = document.querySelector(`.student-card[data-student-id="${studentId}"]`);
            
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÂòóË©¶ÈÄöÈÅéÂ≠∏ÁîüÂßìÂêçÊü•Êâæ
            if (!studentItem) {
                console.log(`üîç ÈÄöÈÅéIDÊâæ‰∏çÂà∞Â≠∏ÁîüÂç°ÁâáÔºåÂòóË©¶ÈÄöÈÅéÂßìÂêçÊü•Êâæ: ${studentId}`);
                // Êü•ÊâæÊâÄÊúâÂ≠∏ÁîüÂç°ÁâáÔºåÈÄöÈÅéÂßìÂêçÂåπÈÖç
                const allStudentCards = document.querySelectorAll('.student-card');
                for (let card of allStudentCards) {
                    const studentName = card.querySelector('.student-name')?.textContent?.trim();
                    if (studentName === studentId) {
                        studentItem = card;
                        console.log(`‚úÖ ÈÄöÈÅéÂßìÂêçÊâæÂà∞Â≠∏ÁîüÂç°Áâá: ${studentName}`);
                        break;
                    }
                }
            }
            
            if (!studentItem) {
                console.error(`‚ùå Êâæ‰∏çÂà∞Â≠∏ÁîüÂç°Áâá: ${studentId}`);
                console.log('üîç ÂèØÁî®ÁöÑÂ≠∏ÁîüÂç°Áâá:', Array.from(document.querySelectorAll('.student-card')).map(card => ({
                    id: card.dataset.studentId,
                    name: card.querySelector('.student-name')?.textContent?.trim()
                })));
                return;
            }

            // Ê∑ªÂä†ÁãÄÊÖãËÆäÊõ¥ÂãïÁï´
            studentItem.style.animation = 'statusChange 0.6s ease-out';
            studentItem.classList.remove('present', 'absent', 'leave', 'pending');

            // ÈáçÁΩÆÊâÄÊúâÊåâÈàïÊ®£Âºè
            const presentBtn = studentItem.querySelector('.present-btn');
            const absentBtn = studentItem.querySelector('.absent-btn');
            
            if (presentBtn) {
                presentBtn.style.transform = 'scale(1)';
                presentBtn.style.boxShadow = '0 4px 15px rgba(40, 167, 69, 0.3)';
            }
            if (absentBtn) {
                absentBtn.style.transform = 'scale(1)';
                absentBtn.style.boxShadow = '0 4px 15px rgba(220, 53, 69, 0.3)';
            }

            if (status) {
                studentItem.classList.add(status);
                
                // Ê†πÊìöÁãÄÊÖãË®≠ÂÆöÊ®£Âºè
                let statusStyles = {
                    border: '#e9ecef',
                    background: 'white',
                    icon: 'fas fa-clock',
                    iconColor: '#6c757d',
                    statusColor: '#6c757d',
                    statusText: 'ÂæÖÁ∞ΩÂà∞'
                };
                
                if (status === 'present') {
                    statusStyles = {
                        border: '#28a745',
                        background: 'linear-gradient(135deg, rgba(40, 167, 69, 0.25), rgba(32, 201, 151, 0.2))',
                        icon: 'fas fa-check-circle',
                        iconColor: '#28a745',
                        statusColor: '#28a745',
                        statusText: '‚úÖ Â∑≤Âá∫Â∏≠',
                        emoji: '‚úÖ'
                    };
                } else if (status === 'absent') {
                    statusStyles = {
                        border: '#dc3545',
                        background: 'linear-gradient(135deg, rgba(220, 53, 69, 0.25), rgba(231, 76, 60, 0.2))',
                        icon: 'fas fa-times-circle',
                        iconColor: '#dc3545',
                        statusColor: '#dc3545',
                        statusText: '‚ùå Â∑≤Áº∫Â∏≠',
                        emoji: '‚ùå'
                    };
                } else if (status === 'leave') {
                    statusStyles = {
                        border: '#ffc107',
                        background: 'linear-gradient(135deg, rgba(255, 193, 7, 0.25), rgba(243, 156, 18, 0.2))',
                        icon: 'fas fa-exclamation-triangle',
                        iconColor: '#ffc107',
                        statusColor: '#ffc107',
                        statusText: '‚ö†Ô∏è Â∑≤Ë´ãÂÅá',
                        emoji: '‚ö†Ô∏è'
                    };
                }
                
                // Êõ¥Êñ∞Â≠∏ÁîüÈ†ÖÁõÆÁöÑÊ®£Âºè
                studentItem.style.border = `2px solid ${statusStyles.border}`;
                studentItem.style.background = statusStyles.background;
                
                // Êõ¥Êñ∞ÁãÄÊÖãÈ°ØÁ§∫
                const statusDisplay = studentItem.querySelector('.student-name').nextElementSibling;
                if (statusDisplay) {
                    statusDisplay.innerHTML = `
                        <span style="font-size: 1.1rem;">${statusStyles.emoji}</span>
                        <span>${statusStyles.statusText}</span>
                    `;
                    statusDisplay.style.background = statusStyles.statusColor;
                    statusDisplay.style.color = 'white';
                }
                
                // È´ò‰∫ÆÈÅ∏‰∏≠ÁöÑÊåâÈàï‰∏¶Ê∑ªÂä†ÊàêÂäüÂãïÁï´
                const selectedBtn = studentItem.querySelector(`.${status}-btn`);
                if (selectedBtn) {
                    selectedBtn.style.transform = 'scale(1.05)';
                    selectedBtn.style.boxShadow = status === 'present' ? 
                        '0 8px 25px rgba(40, 167, 69, 0.5)' : 
                        '0 8px 25px rgba(220, 53, 69, 0.5)';
                    selectedBtn.style.animation = 'successPulse 0.8s ease-out';
                }
            }
            
            // Ê∏ÖÈô§ÂãïÁï´
            setTimeout(() => {
                studentItem.style.animation = '';
                if (studentItem.querySelector('.present-btn')) {
                    studentItem.querySelector('.present-btn').style.animation = '';
                }
                if (studentItem.querySelector('.absent-btn')) {
                    studentItem.querySelector('.absent-btn').style.animation = '';
                }
            }, 600);
            
            // Êõ¥Êñ∞Áµ±Ë®à
            updateAttendanceStats();
        }

        // Êõ¥Êñ∞Á∞ΩÂà∞Áµ±Ë®à
        function updateAttendanceStats() {
            const studentsList = document.getElementById('studentsList');
            if (!studentsList) return;
            
            const students = studentsList.querySelectorAll('.student-item');
            let presentCount = 0;
            let absentCount = 0;
            let leaveCount = 0;
            let pendingCount = 0;
            
            students.forEach(student => {
                if (student.classList.contains('present')) presentCount++;
                else if (student.classList.contains('absent')) absentCount++;
                else if (student.classList.contains('leave')) leaveCount++;
                else pendingCount++;
            });
            
            const totalCount = students.length;
            const attendanceStats = document.getElementById('attendanceStats');
            if (attendanceStats) {
                // Ê∑ªÂä†Áµ±Ë®àÂãïÁï´
                attendanceStats.classList.add('stats-animation');
                setTimeout(() => {
                    attendanceStats.classList.remove('stats-animation');
                }, 600);
                
                attendanceStats.innerHTML = `
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: center;">
                        <span class="stats-item" style="color: #28a745; text-shadow: none; padding: 4px 8px; border-radius: 8px; background: rgba(40, 167, 69, 0.1);"><i class="fas fa-check-circle"></i> Âá∫Â∏≠: ${presentCount}</span>
                        <span class="stats-item" style="color: #dc3545; text-shadow: none; padding: 4px 8px; border-radius: 8px; background: rgba(220, 53, 69, 0.1);"><i class="fas fa-times-circle"></i> Áº∫Â∏≠: ${absentCount}</span>
                        <span class="stats-item" style="color: #ffc107; text-shadow: none; padding: 4px 8px; border-radius: 8px; background: rgba(255, 193, 7, 0.1);"><i class="fas fa-exclamation-triangle"></i> Ë´ãÂÅá: ${leaveCount}</span>
                        <span class="stats-item" style="color: #6c757d; text-shadow: none; padding: 4px 8px; border-radius: 8px; background: rgba(108, 117, 125, 0.1);"><i class="fas fa-clock"></i> ÂæÖÁ∞Ω: ${pendingCount}</span>
                    </div>
                `;
            }
        }

        // Ë®≠ÁΩÆÂ≠∏ÁîüÂç°ÁâáÈõôÊìäË™≤Á®ãÁõ£ËÅΩÂô®
        function setupStudentCardDoubleClickListeners() {
            // Áõ¥Êé•Á∂ÅÂÆöÂ≠∏ÁîüÂç°Áâá‰∫ã‰ª∂Áõ£ËÅΩÂô®Ôºå‰∏çÈáçÊñ∞ÂâµÂª∫ÂÖÉÁ¥†
            
            const studentCards = document.querySelectorAll('.student-card');
            studentCards.forEach(card => {
                let clickCount = 0;
                let clickTimer = null;
                
                card.addEventListener('click', function(e) {
                    // Èò≤Ê≠¢Ë™≤Á®ãÂÜíÊ≥°Âà∞ÊåâÈàï
                    if (e.target.classList.contains('present-btn') || 
                        e.target.classList.contains('absent-btn') ||
                        e.target.closest('.present-btn') || 
                        e.target.closest('.absent-btn')) {
                        console.log('üö´ Â≠∏ÁîüÂç°ÁâáÈªûÊìäË¢´ÈòªÊ≠¢ÔºåÂõ†ÁÇ∫ÈªûÊìä‰∫ÜÊåâÈàï');
                        return;
                    }
                    
                    clickCount++;
                    
                    if (clickCount === 1) {
                        // Á¨¨‰∏ÄÊ¨°ÈªûÊìäÔºåË®≠ÁΩÆÂÆöÊôÇÂô®
                        clickTimer = setTimeout(() => {
                            clickCount = 0;
                        }, 300); // 300ms ÂÖßÊ≤íÊúâÁ¨¨‰∫åÊ¨°ÈªûÊìäÂâáÈáçÁΩÆ
                    } else if (clickCount === 2) {
                        // Á¨¨‰∫åÊ¨°ÈªûÊìäÔºåËß∏ÁôºÈõôÊìäË™≤Á®ã
                        clearTimeout(clickTimer);
                        clickCount = 0;
                        
                        // Ê∑ªÂä†ÈõôÊìäÂãïÁï´
                        card.classList.add('double-click-animation');
                        setTimeout(() => {
                            card.classList.remove('double-click-animation');
                        }, 600);
                        
                        // Êü•Ë©¢Áº∫Âã§Á¥ÄÈåÑ
                        const studentName = card.querySelector('.student-name')?.textContent;
                        if (studentName) {
                            queryStudentAttendanceRecord(studentName);
                        }
                    }
                });
            });
        }

        // Êü•Ë©¢Â≠∏ÁîüÁº∫Âã§Á¥ÄÈåÑ
        async function queryStudentAttendanceRecord(studentName) {
            try {
                // ÂâµÂª∫Ê®°ÊÖãÊ°Ü
                const modal = document.createElement('div');
                modal.className = 'attendance-record-modal';
                modal.innerHTML = `
                    <div class="attendance-record-content">
                        <div class="attendance-record-header">
                            <h3 class="attendance-record-title">
                                <i class="fas fa-user-graduate"></i> ${studentName} ÁöÑÁº∫Âã§Á¥ÄÈåÑ
                            </h3>
                            <button class="close-attendance-record-btn" id="closeAttendanceRecordBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="attendance-record-loading">
                            <div style="
                                width: 40px;
                                height: 40px;
                                border: 4px solid rgba(255, 215, 0, 0.2);
                                border-top: 4px solid #b8860b;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin: 0 auto 20px;
                            "></div>
                            <p>Ê≠£Âú®Êü•Ë©¢Áº∫Âã§Á¥ÄÈåÑ...</p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Ë®≠ÁΩÆÈóúÈñâÊåâÈàïË™≤Á®ã
                const closeBtn = modal.querySelector('#closeAttendanceRecordBtn');
                closeBtn.addEventListener('click', () => {
                    modal.remove();
                });
                
                // ÈªûÊìäËÉåÊôØÈóúÈñâ
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                // Êü•Ë©¢Áº∫Âã§Á¥ÄÈåÑ
                console.log('üîç Êü•Ë©¢Â≠∏ÁîüÁº∫Âã§Á¥ÄÈåÑ:', studentName);
                
                const response = await fetch('/api/proxy/google-sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'query',
                        name: studentName
                    })
                });
                
                console.log('üì° Êü•Ë©¢ÂõûÊáâÁãÄÊÖã:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì• Êü•Ë©¢ÂõûÊáâÊï∏Êìö:', data);
                
                if (data.success && data.attendance) {
                    // È°ØÁ§∫Áº∫Âã§Á¥ÄÈåÑ
                    displayAttendanceRecords(modal, studentName, data.attendance);
                } else {
                    // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
                    displayAttendanceRecordError(modal, data.error || 'Êü•Ë©¢Â§±Êïó');
                }
                
            } catch (error) {
                console.error('Êü•Ë©¢Áº∫Âã§Á¥ÄÈåÑÈåØË™§:', error);
                // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
                if (modal) {
                    displayAttendanceRecordError(modal, 'Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
                }
            }
        }

        // È°ØÁ§∫Áº∫Âã§Á¥ÄÈåÑ
        function displayAttendanceRecords(modal, studentName, records) {
            const content = modal.querySelector('.attendance-record-content');
            const loading = modal.querySelector('.attendance-record-loading');
            
            if (loading) {
                loading.remove();
            }
            
            const recordsList = document.createElement('div');
            recordsList.className = 'attendance-record-list';
            
            if (records.length === 0) {
                recordsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 20px;"></i>
                        <h4>Ê≤íÊúâÁº∫Âã§Á¥ÄÈåÑ</h4>
                        <p>${studentName} ÁöÑÂá∫Âã§ÁãÄÊ≥ÅËâØÂ•ΩÔºÅ</p>
                    </div>
                `;
            } else {
                recordsList.innerHTML = records.map(record => {
                    const statusClass = record.present ? 'present' : 'absent';
                    const statusText = record.present ? 'Âá∫Â∏≠' : 'Áº∫Â∏≠';
                    const statusIcon = record.present ? 'fa-check-circle' : 'fa-times-circle';
                    
                    return `
                        <div class="attendance-record-item">
                            <div class="attendance-record-date">
                                <i class="fas fa-calendar-alt"></i>
                                ${new Date(record.date).toLocaleDateString('zh-TW')}
                            </div>
                            <div class="attendance-record-status ${statusClass}">
                                <i class="fas ${statusIcon}"></i>
                                ${statusText}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            content.appendChild(recordsList);
        }

        // È°ØÁ§∫Áº∫Âã§Á¥ÄÈåÑÈåØË™§
        function displayAttendanceRecordError(modal, errorMessage) {
            const content = modal.querySelector('.attendance-record-content');
            const loading = modal.querySelector('.attendance-record-loading');
            
            if (loading) {
                loading.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'attendance-record-error';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h4>Êü•Ë©¢Â§±Êïó</h4>
                <p>${errorMessage}</p>
            `;
            
            content.appendChild(errorDiv);
        }

        // ÂàùÂßãÂåñÊá∏ÊµÆÈÅ∏ÂñÆÊªæÂãïÁõ£ËÅΩ
        function initializeFloatingMenu() {
            const floatingMenu = document.getElementById('floatingStatsMenu');
            const statsText = document.getElementById('statsText');
            
            if (!floatingMenu || !statsText) return;
            
            let isFloatingVisible = false;
            let ticking = false;
            
            // ÊªæÂãïÁõ£ËÅΩÂáΩÊï∏
            function handleScroll() {
                if (!ticking) {
                    requestAnimationFrame(() => {
                        const statsRect = statsText.getBoundingClientRect();
                        const shouldShow = statsRect.bottom < 0; // Áï∂Áµ±Ë®àÂçÄÂüüÊªæÂãïÂá∫Ë¶ñÁ™óÊôÇÈ°ØÁ§∫Êá∏ÊµÆÈÅ∏ÂñÆ
                        
                        if (shouldShow && !isFloatingVisible) {
                            showFloatingMenu();
                            isFloatingVisible = true;
                        } else if (!shouldShow && isFloatingVisible) {
                            hideFloatingMenu();
                            isFloatingVisible = false;
                        }
                        
                        ticking = false;
                    });
                    ticking = true;
                }
            }
            
            // Ê∑ªÂä†ÊªæÂãïÁõ£ËÅΩÂô®
            window.addEventListener('scroll', handleScroll, { passive: true });
            
            // È°ØÁ§∫Êá∏ÊµÆÈÅ∏ÂñÆ
            function showFloatingMenu() {
                floatingMenu.classList.add('show');
                updateFloatingMenuContent();
            }
            
            // Èö±ËóèÊá∏ÊµÆÈÅ∏ÂñÆ
            function hideFloatingMenu() {
                floatingMenu.classList.remove('show');
            }
            
            // Êõ¥Êñ∞Êá∏ÊµÆÈÅ∏ÂñÆÂÖßÂÆπ
            function updateFloatingMenuContent() {
                const totalEventsText = document.getElementById('totalEventsText');
                const instructorCountText = document.getElementById('instructorCountText');
                const dateRangeText = document.getElementById('dateRangeText');
                
                const floatingTotalEvents = document.getElementById('floatingTotalEvents');
                const floatingInstructorCount = document.getElementById('floatingInstructorCount');
                const floatingDateRange = document.getElementById('floatingDateRange');
                
                if (totalEventsText && floatingTotalEvents) {
                    floatingTotalEvents.textContent = totalEventsText.textContent;
                }
                if (instructorCountText && floatingInstructorCount) {
                    floatingInstructorCount.textContent = instructorCountText.textContent;
                }
                if (dateRangeText && floatingDateRange) {
                    floatingDateRange.textContent = dateRangeText.textContent;
                }
            }
            
            // Áõ£ËÅΩÁµ±Ë®àÊõ¥Êñ∞Ë™≤Á®ã
            document.addEventListener('statsUpdated', updateFloatingMenuContent);
            
            // ÂàùÂßãÂåñÁØ©ÈÅ∏ÊåâÈàï
            initializeFloatingFilterButtons();
        }
        
        // ÂàùÂßãÂåñÊá∏ÊµÆÈÅ∏ÂñÆÁØ©ÈÅ∏ÊåâÈàï
        function initializeFloatingFilterButtons() {
            const filterButtons = document.querySelectorAll('.floating-filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    
                    // Ê∑ªÂä†ÈªûÊìäÂãïÁï´
                    this.classList.add('clicked');
                    setTimeout(() => {
                        this.classList.remove('clicked');
                    }, 600);
                    
                    // ÁßªÈô§ÊâÄÊúâÊåâÈàïÁöÑ active È°ûÂà•
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Ê∑ªÂä†Áï∂ÂâçÊåâÈàïÁöÑ active È°ûÂà•
                    this.classList.add('active');
                    
                    // Âü∑Ë°åÁØ©ÈÅ∏
                    applyDateFilter(filter);
                });
            });
        }
        
        // ÊáâÁî®Êó•ÊúüÁØ©ÈÅ∏
        function applyDateFilter(filter) {
            console.log('üîÑ Êá∏ÊµÆÈÅ∏ÂñÆÁØ©ÈÅ∏:', filter);
            
            // ÊâæÂà∞Â∞çÊáâÁöÑÁØ©ÈÅ∏ÊåâÈàï‰∏¶Êõ¥Êñ∞ÁãÄÊÖã
            const filterButtons = document.querySelectorAll('.filter-btn, .floating-filter-btn');
            const targetButton = Array.from(filterButtons).find(btn => 
                btn.getAttribute('data-filter') === filter || 
                btn.textContent.trim() === filter
            );
            
            // Êõ¥Êñ∞ÊâÄÊúâÊåâÈàïÁöÑ active ÁãÄÊÖã
            filterButtons.forEach(btn => btn.classList.remove('active'));
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Áõ¥Êé•ÂàáÊèõË¶ñÂúñ
            if (window.switchView) {
                console.log('üîÑ ÂàáÊèõË¶ñÂúñÂà∞:', filter);
                window.switchView(filter);
            }
            
            // Âü∑Ë°åÁØ©ÈÅ∏ÈÇèËºØ
            const today = new Date();
            let startDate, endDate;
            
            switch(filter) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay()); // Êú¨ÈÄ±ÈñãÂßãÔºàÈÄ±Êó•Ôºâ
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6); // Êú¨ÈÄ±ÁµêÊùüÔºàÈÄ±ÂÖ≠Ôºâ
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1); // Êú¨ÊúàÁ¨¨‰∏ÄÂ§©
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); // Êú¨ÊúàÊúÄÂæå‰∏ÄÂ§©
                    break;
                case 'all':
                    // ÂÖ®ÈÉ®ÔºöÊ∏ÖÈô§Êó•ÊúüÁØ©ÈÅ∏
                    startDate = null;
                    endDate = null;
                    break;
                default:
                    return;
            }
            
            // Êõ¥Êñ∞Êó•ÊúüÁØÑÂúçÁØ©ÈÅ∏
            if (window.updateDateRange) {
                window.updateDateRange(startDate, endDate);
            }
            
            // Ëß∏ÁôºË™≤Á®ãÈáçÊñ∞ËºâÂÖ•
            if (window.loadEvents) {
                window.loadEvents();
            }
            
            // ÊªæÂãïÂà∞Á¨¨‰∏ÄÁ≠ÜË°å‰∫ãÊõÜ
            setTimeout(() => {
                const firstEvent = document.querySelector('.event-card');
                if (firstEvent) {
                    firstEvent.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }
            }, 500);
        }

    </script>
</body>
  </html>
