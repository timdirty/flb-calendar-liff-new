<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¬›å¸«è¡Œäº‹æ›†æª¢è¦–</title>
    <!-- é è¼‰å…¥é—œéµè³‡æº -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style">
    <!-- LIFF SDK æ”¹ç‚ºé å–è€Œéé è¼‰å…¥ï¼Œé¿å…æœªä½¿ç”¨è­¦å‘Š -->
    <link rel="prefetch" href="https://static.line-scdn.net/liff/edge/2/sdk.js" as="script">
    
    <!-- é—œéµCSSå„ªå…ˆè¼‰å…¥ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- éé—œéµè³‡æºå»¶é²è¼‰å…¥ -->
    <script>
        // æ€§èƒ½å„ªåŒ–å·¥å…·
        const PerformanceOptimizer = {
            // æ€§èƒ½ç›£æ§æ•¸æ“š
            metrics: {
                api: {
                    requests: 0,
                    successes: 0,
                    failures: 0,
                    averageResponseTime: 0,
                    totalResponseTime: 0
                },
                attendance: {
                    loadAttempts: 0,
                    successfulLoads: 0,
                    failedLoads: 0,
                    averageLoadTime: 0,
                    totalLoadTime: 0
                },
                memory: {
                    start: performance.memory ? performance.memory.usedJSHeapSize : 0,
                    peak: 0,
                    current: 0
                }
            },
            
            // è¨˜éŒ„APIè«‹æ±‚
            recordApiRequest(success, responseTime) {
                this.metrics.api.requests++;
                this.metrics.api.totalResponseTime += responseTime;
                this.metrics.api.averageResponseTime = this.metrics.api.totalResponseTime / this.metrics.api.requests;
                
                if (success) {
                    this.metrics.api.successes++;
                } else {
                    this.metrics.api.failures++;
                }
            },
            
            // è¨˜éŒ„å­¸ç”Ÿè³‡æ–™è¼‰å…¥
            recordAttendanceLoad(success, loadTime) {
                this.metrics.attendance.loadAttempts++;
                this.metrics.attendance.totalLoadTime += loadTime;
                this.metrics.attendance.averageLoadTime = this.metrics.attendance.totalLoadTime / this.metrics.attendance.loadAttempts;
                
                if (success) {
                    this.metrics.attendance.successfulLoads++;
                } else {
                    this.metrics.attendance.failedLoads++;
                }
            },
            
            // æ›´æ–°è¨˜æ†¶é«”ä½¿ç”¨æƒ…æ³
            updateMemoryUsage() {
                if (performance.memory) {
                    this.metrics.memory.current = performance.memory.usedJSHeapSize;
                    this.metrics.memory.peak = Math.max(this.metrics.memory.peak, this.metrics.memory.current);
                }
            },
            
            // ç²å–æ€§èƒ½å ±å‘Š
            getPerformanceReport() {
                this.updateMemoryUsage();
                return {
                    api: {
                        ...this.metrics.api,
                        successRate: this.metrics.api.requests > 0 ? 
                            (this.metrics.api.successes / this.metrics.api.requests * 100).toFixed(2) + '%' : '0%'
                    },
                    attendance: {
                        ...this.metrics.attendance,
                        successRate: this.metrics.attendance.loadAttempts > 0 ? 
                            (this.metrics.attendance.successfulLoads / this.metrics.attendance.loadAttempts * 100).toFixed(2) + '%' : '0%'
                    },
                    memory: {
                        ...this.metrics.memory,
                        usageIncrease: this.metrics.memory.current - this.metrics.memory.start,
                        peakIncrease: this.metrics.memory.peak - this.metrics.memory.start
                    }
                };
            },
            
            // å»¶é²è¼‰å…¥LIFF SDK
            loadLIFFSDK() {
                return new Promise((resolve, reject) => {
                    if (typeof liff !== 'undefined') {
                        console.log('âœ… LIFF SDKå·²å­˜åœ¨');
                        resolve();
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.charset = 'utf-8';
                    script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
                    script.async = true;
                    script.defer = true;
                    script.onload = () => {
                        console.log('âœ… LIFF SDKè¼‰å…¥æˆåŠŸ');
                        resolve();
                    };
                    script.onerror = () => {
                        console.error('âŒ LIFF SDKè¼‰å…¥å¤±æ•—');
                        reject(new Error('LIFF SDKè¼‰å…¥å¤±æ•—'));
                    };
                    document.head.appendChild(script);
                });
            },
            
            // é è¼‰å…¥é—œéµè³‡æº - å„ªåŒ–ç‰ˆæœ¬
            preloadCriticalResources() {
                const criticalResources = [
                    { href: '/api/events', as: 'fetch', type: 'application/json', priority: 'high' },
                    { href: '/api/teachers', as: 'fetch', type: 'application/json', priority: 'high' },
                    { href: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css', as: 'style', priority: 'low' }
                ];
                
                criticalResources.forEach(resource => {
                    const link = document.createElement('link');
                    link.rel = resource.priority === 'high' ? 'preload' : 'prefetch';
                    link.href = resource.href;
                    link.as = resource.as;
                    if (resource.type) link.type = resource.type;
                    if (resource.priority === 'high') {
                        link.crossOrigin = 'anonymous';
                    }
                    document.head.appendChild(link);
                });
                
                // é è¼‰å…¥é—œéµåœ–ç‰‡
                this.preloadCriticalImages();
            },
            
            // é è¼‰å…¥é—œéµåœ–ç‰‡
            preloadCriticalImages() {
                const criticalImages = [
                    'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjRkZGRkZGIi8+Cjwvc3ZnPgo='
                ];
                
                criticalImages.forEach(src => {
                    const img = new Image();
                    img.src = src;
                });
            },
            
            // æ‡¶è¼‰å…¥éé—œéµåŠŸèƒ½
            lazyLoadNonCriticalFeatures() {
                // ä½¿ç”¨ Intersection Observer æ‡¶è¼‰å…¥
                if ('IntersectionObserver' in window) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const element = entry.target;
                                if (element.dataset.lazyLoad) {
                                    this.loadLazyContent(element);
                                    observer.unobserve(element);
                                }
                            }
                        });
                    });
                    
                    // è§€å¯Ÿæ‰€æœ‰éœ€è¦æ‡¶è¼‰å…¥çš„å…ƒç´ 
                    document.querySelectorAll('[data-lazy-load]').forEach(el => {
                        observer.observe(el);
                    });
                }
            },
            
            // è¼‰å…¥æ‡¶è¼‰å…¥å…§å®¹
            loadLazyContent(element) {
                const loadType = element.dataset.lazyLoad;
                switch (loadType) {
                    case 'attendance-modal':
                        this.loadAttendanceModal();
                        break;
                    case 'teacher-options':
                        this.loadTeacherOptions();
                        break;
                    case 'time-filters':
                        this.loadTimeFilters();
                        break;
                    case 'event-cards':
                        this.loadEventCards();
                        break;
                    case 'floating-menu':
                        this.loadFloatingMenu();
                        break;
                    case 'notifications':
                        this.loadNotifications();
                        break;
                    case 'charts':
                        this.loadCharts();
                        break;
                }
            },
            
            // è¼‰å…¥ç°½åˆ°æ¨¡æ…‹æ¡†
            loadAttendanceModal() {
                console.log('æ‡¶è¼‰å…¥ç°½åˆ°æ¨¡æ…‹æ¡†...');
                // é€™è£¡å¯ä»¥è¼‰å…¥ç°½åˆ°ç›¸é—œçš„é¡å¤–åŠŸèƒ½
            },
            
            // è¼‰å…¥è¬›å¸«é¸é …
            loadTeacherOptions() {
                console.log('æ‡¶è¼‰å…¥è¬›å¸«é¸é …...');
                // é€™è£¡å¯ä»¥è¼‰å…¥è¬›å¸«ç›¸é—œçš„é¡å¤–åŠŸèƒ½
            },
            
            // è¼‰å…¥æ™‚é–“ç¯©é¸
            loadTimeFilters() {
                console.log('æ‡¶è¼‰å…¥æ™‚é–“ç¯©é¸...');
                // é€™è£¡å¯ä»¥è¼‰å…¥æ™‚é–“ç¯©é¸çš„é¡å¤–åŠŸèƒ½
            },
            
            // è¼‰å…¥äº‹ä»¶å¡ç‰‡
            loadEventCards() {
                console.log('æ‡¶è¼‰å…¥äº‹ä»¶å¡ç‰‡...');
                // è¼‰å…¥äº‹ä»¶å¡ç‰‡çš„é¡å¤–åŠŸèƒ½
                this.optimizeEventCards();
            },
            
            // è¼‰å…¥æ‡¸æµ®é¸å–®
            loadFloatingMenu() {
                console.log('æ‡¶è¼‰å…¥æ‡¸æµ®é¸å–®...');
                // è¼‰å…¥æ‡¸æµ®é¸å–®çš„é¡å¤–åŠŸèƒ½
                this.optimizeFloatingMenu();
            },
            
            // è¼‰å…¥é€šçŸ¥ç³»çµ±
            loadNotifications() {
                console.log('æ‡¶è¼‰å…¥é€šçŸ¥ç³»çµ±...');
                // è¼‰å…¥é€šçŸ¥ç³»çµ±çš„é¡å¤–åŠŸèƒ½
                this.optimizeNotifications();
            },
            
            // è¼‰å…¥åœ–è¡¨
            loadCharts() {
                console.log('æ‡¶è¼‰å…¥åœ–è¡¨...');
                // è¼‰å…¥åœ–è¡¨çš„é¡å¤–åŠŸèƒ½
                this.optimizeCharts();
            },
            
            // å„ªåŒ–äº‹ä»¶å¡ç‰‡
            optimizeEventCards() {
                const eventCards = document.querySelectorAll('.event-card');
                eventCards.forEach(card => {
                    // æ·»åŠ è¦–è¦ºå„ªåŒ–
                    card.style.willChange = 'transform, opacity';
                    card.style.contain = 'layout style paint';
                });
            },
            
            // å„ªåŒ–æ‡¸æµ®é¸å–®
            optimizeFloatingMenu() {
                const floatingMenu = document.getElementById('floatingStatsMenu');
                if (floatingMenu) {
                    floatingMenu.style.willChange = 'transform, opacity';
                    floatingMenu.style.contain = 'layout style paint';
                }
            },
            
            // å„ªåŒ–é€šçŸ¥ç³»çµ±
            optimizeNotifications() {
                const notifications = document.querySelectorAll('.toast, .countdown-toast');
                notifications.forEach(notification => {
                    notification.style.willChange = 'transform, opacity';
                    notification.style.contain = 'layout style paint';
                });
            },
            
            // å„ªåŒ–åœ–è¡¨
            optimizeCharts() {
                const charts = document.querySelectorAll('[class*="chart"], [class*="graph"]');
                charts.forEach(chart => {
                    chart.style.willChange = 'transform, opacity';
                    chart.style.contain = 'layout style paint';
                });
            },
            
            // å„ªåŒ–DOMæ“ä½œ
            batchDOMUpdates(updates) {
                requestAnimationFrame(() => {
                    updates.forEach(update => update());
                });
            },
            
            // é˜²æŠ–å‡½æ•¸ - å„ªåŒ–ç‰ˆæœ¬
            debounce(func, wait, immediate = false) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        timeout = null;
                        if (!immediate) func(...args);
                    };
                    const callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func(...args);
                };
            },
            
            // ç¯€æµå‡½æ•¸ - å„ªåŒ–ç‰ˆæœ¬
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },
            
            // æ–°å¢ï¼šæ‰¹é‡è™•ç†å‡½æ•¸
            batchProcess(items, processor, batchSize = 10) {
                const results = [];
                for (let i = 0; i < items.length; i += batchSize) {
                    const batch = items.slice(i, i + batchSize);
                    results.push(...batch.map(processor));
                }
                return results;
            },
            
            // æ–°å¢ï¼šæ€§èƒ½ç›£æ§
            performanceMonitor: {
                metrics: new Map(),
                start(name) {
                    this.metrics.set(name, performance.now());
                },
                end(name) {
                    const startTime = this.metrics.get(name);
                    if (startTime) {
                        const duration = performance.now() - startTime;
                        console.log(`â±ï¸ ${name}: ${duration.toFixed(2)}ms`);
                        this.metrics.delete(name);
                        return duration;
                    }
                }
            }
        };
        
        // è¨˜æ†¶é«”ç®¡ç†å™¨
        const MemoryManager = {
            cache: new Map(),
            maxCacheSize: 100,
            cleanup() {
                if (this.cache.size > this.maxCacheSize) {
                    const keys = Array.from(this.cache.keys());
                    const toDelete = keys.slice(0, keys.length - this.maxCacheSize);
                    toDelete.forEach(key => this.cache.delete(key));
                }
            },
            get(key) {
                return this.cache.get(key);
            },
            set(key, value) {
                this.cache.set(key, value);
                this.cleanup();
            },
            clear() {
                this.cache.clear();
            },
            // æ¸…ç†éæœŸçš„å¿«å–
            cleanupExpired() {
                const now = Date.now();
                for (const [key, value] of this.cache.entries()) {
                    if (value.expiry && now > value.expiry) {
                        this.cache.delete(key);
                    }
                }
            }
        };
        
        // æ¨¡çµ„ç®¡ç†å™¨
        const ModuleManager = {
            modules: new Map(),
            loaded: new Set(),
            
            // è¨»å†Šæ¨¡çµ„
            register(name, module) {
                this.modules.set(name, module);
            },
            
            // è¼‰å…¥æ¨¡çµ„
            async load(name) {
                if (this.loaded.has(name)) {
                    return this.modules.get(name);
                }
                
                const module = this.modules.get(name);
                if (!module) {
                    throw new Error(`æ¨¡çµ„ ${name} æœªæ‰¾åˆ°`);
                }
                
                if (module.init) {
                    await module.init();
                }
                
                this.loaded.add(name);
                return module;
            },
            
            // è¼‰å…¥å¤šå€‹æ¨¡çµ„
            async loadMultiple(names) {
                const promises = names.map(name => this.load(name));
                return Promise.all(promises);
            },
            
            // æ¸…ç†æ¨¡çµ„
            cleanup(name) {
                const module = this.modules.get(name);
                if (module && module.cleanup) {
                    module.cleanup();
                }
                this.loaded.delete(name);
            }
        };
        
            // æš´éœ²åˆ°å…¨å±€
            window.PerformanceOptimizer = PerformanceOptimizer;
            window.MemoryManager = MemoryManager;
            window.ModuleManager = ModuleManager;
            
            // æ·»åŠ æ¸¬è©¦Google Sheets APIåŠŸèƒ½
            window.testGoogleSheetsAPI = function() {
                console.log('ğŸ§ª æ¸¬è©¦Google Sheets API...');
                
                const testPayload = {
                    action: "update",
                    name: "æ¸¬è©¦å­¸ç”Ÿ",
                    date: "2025-09-22",
                    present: true,
                    teacher: "æ¸¬è©¦è¬›å¸«",
                    course: "æ¸¬è©¦èª²ç¨‹",
                    period: "æ¸¬è©¦æ™‚æ®µ"
                };
                
                const proxyUrl = '/api/proxy/google-sheets';
                
                fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'updateAttendance',
                        googleSheetsUrl: "https://script.google.com/macros/s/AKfycbxfj5fwNIc8ncbqkOm763yo6o06wYPHm2nbfd_1yLkHlakoS9FtYfYJhvGCaiAYh_vjIQ/dev",
                        payload: testPayload
                    })
                })
                .then(response => {
                    console.log('ğŸ“¥ APIå›æ‡‰ç‹€æ…‹:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ“¥ APIå›æ‡‰å…§å®¹:', data);
                    showToast('ğŸ§ª Google Sheets APIæ¸¬è©¦å®Œæˆï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°', 'info', 3000);
                })
                .catch(error => {
                    console.error('âŒ APIæ¸¬è©¦å¤±æ•—:', error);
                    showToast('âŒ Google Sheets APIæ¸¬è©¦å¤±æ•—', 'error', 3000);
                });
            };
            
            // æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™é¡¯ç¤º
            window.testAttendanceDisplay = function() {
                console.log('ğŸ§ª æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™é¡¯ç¤º');
                
                if (!window.loadedStudentsData || !window.loadedStudentsData.students) {
                    console.log('âŒ æ²’æœ‰è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™');
                    showToast('âŒ æ²’æœ‰è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™ï¼Œè«‹å…ˆè¼‰å…¥èª²ç¨‹å­¸ç”Ÿ', 'error', 3000);
                    return;
                }
                
                // ç‚ºæ¯å€‹å­¸ç”Ÿæ·»åŠ æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™
                window.loadedStudentsData.students.forEach(student => {
                    const studentId = student.id || student.student_id || student.name;
                    
                    // æ·»åŠ éš¨æ©Ÿå‡ºç¼ºå‹¤è³‡æ–™
                    const present = Math.floor(Math.random() * 5) + 1; // 1-5æ¬¡
                    const absent = Math.floor(Math.random() * 3); // 0-2æ¬¡
                    const late = Math.floor(Math.random() * 2); // 0-1æ¬¡
                    const unmarked = Math.floor(Math.random() * 2); // 0-1æ¬¡
                    
                    student.present = present;
                    student.absent = absent;
                    student.late = late;
                    student.unmarked = unmarked;
                    
                    // æ›´æ–°attendanceRecords
                    if (window.loadedStudentsData.attendanceRecords[studentId]) {
                        window.loadedStudentsData.attendanceRecords[studentId].present = present;
                        window.loadedStudentsData.attendanceRecords[studentId].absent = absent;
                        window.loadedStudentsData.attendanceRecords[studentId].late = late;
                        window.loadedStudentsData.attendanceRecords[studentId].unmarked = unmarked;
                    }
                    
                    console.log(`ğŸ“Š ${student.name}: å‡ºå¸­${present}æ¬¡, ç¼ºå¸­${absent}æ¬¡, é²åˆ°${late}æ¬¡, æœªæ¨™è¨˜${unmarked}æ¬¡`);
                });
                
                console.log('âœ… æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™å·²æ·»åŠ ');
                showToast('âœ… æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™å·²æ·»åŠ ï¼Œè«‹æŸ¥çœ‹å­¸ç”Ÿå¡ç‰‡', 'success', 3000);
                
                // é‡æ–°æ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨
                if (window.loadedStudentsData && window.loadedStudentsData.students) {
                    displayStudents(window.loadedStudentsData.students, 
                        window.loadedStudentsData.teacher, 
                        window.loadedStudentsData.course, 
                        window.loadedStudentsData.time, 
                        window.loadedStudentsData.start, 
                        window.loadedStudentsData.end, 
                        window.loadedStudentsData.minutesUntilStart);
                }
            };
            
            // æ¸¬è©¦æ‰‹æ©Ÿç«¯ä½ˆå±€
            window.testMobileLayout = function() {
                console.log('ğŸ“± æ¸¬è©¦æ‰‹æ©Ÿç«¯ä½ˆå±€');
                
                // æª¢æŸ¥ç•¶å‰è¦–çª—å¯¬åº¦
                const width = window.innerWidth;
                console.log(`ğŸ“ ç•¶å‰è¦–çª—å¯¬åº¦: ${width}px`);
                
                // æª¢æŸ¥å‡ºç¼ºå‹¤çµ±è¨ˆå…ƒç´ çš„é¡¯ç¤ºç‹€æ…‹
                const desktopStats = document.querySelectorAll('.attendance-stats-desktop');
                const mobileStats = document.querySelectorAll('.attendance-stats-mobile');
                
                console.log(`ğŸ–¥ï¸ æ¡Œé¢ç«¯çµ±è¨ˆå…ƒç´ æ•¸é‡: ${desktopStats.length}`);
                console.log(`ğŸ“± æ‰‹æ©Ÿç«¯çµ±è¨ˆå…ƒç´ æ•¸é‡: ${mobileStats.length}`);
                
                // æª¢æŸ¥æ¯å€‹å…ƒç´ çš„é¡¯ç¤ºç‹€æ…‹
                desktopStats.forEach((element, index) => {
                    const computedStyle = window.getComputedStyle(element);
                    console.log(`ğŸ–¥ï¸ æ¡Œé¢ç«¯å…ƒç´  ${index + 1} é¡¯ç¤ºç‹€æ…‹: ${computedStyle.display}`);
                });
                
                mobileStats.forEach((element, index) => {
                    const computedStyle = window.getComputedStyle(element);
                    console.log(`ğŸ“± æ‰‹æ©Ÿç«¯å…ƒç´  ${index + 1} é¡¯ç¤ºç‹€æ…‹: ${computedStyle.display}`);
                });
                
                // æ ¹æ“šè¦–çª—å¯¬åº¦çµ¦å‡ºå»ºè­°
                if (width <= 768) {
                    console.log('âœ… ç•¶å‰ç‚ºæ‰‹æ©Ÿç«¯ä½ˆå±€ï¼Œæ‡‰è©²é¡¯ç¤ºæ‰‹æ©Ÿç«¯çµ±è¨ˆå…ƒç´ ');
                    showToast('ğŸ“± ç•¶å‰ç‚ºæ‰‹æ©Ÿç«¯ä½ˆå±€ï¼Œè«‹æª¢æŸ¥å‡ºç¼ºå‹¤çµ±è¨ˆæ˜¯å¦æ­£ç¢ºé¡¯ç¤º', 'info', 3000);
                } else {
                    console.log('âœ… ç•¶å‰ç‚ºæ¡Œé¢ç«¯ä½ˆå±€ï¼Œæ‡‰è©²é¡¯ç¤ºæ¡Œé¢ç«¯çµ±è¨ˆå…ƒç´ ');
                    showToast('ğŸ–¥ï¸ ç•¶å‰ç‚ºæ¡Œé¢ç«¯ä½ˆå±€ï¼Œè«‹æª¢æŸ¥å‡ºç¼ºå‹¤çµ±è¨ˆæ˜¯å¦æ­£ç¢ºé¡¯ç¤º', 'info', 3000);
                }
            };
            
            // æ·»åŠ æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™åŠŸèƒ½
            window.addTestAttendanceData = function() {
                if (!window.loadedStudentsData || !window.loadedStudentsData.students) {
                    console.log('âš ï¸ æ²’æœ‰è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™');
                    return;
                }
                
                console.log('ğŸ§ª æ·»åŠ æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™...');
                
                // ç‚ºæ¯å€‹å­¸ç”Ÿæ·»åŠ æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™
                window.loadedStudentsData.students.forEach((student, index) => {
                    const studentId = student.id || student.student_id || student.name;
                    
                    // æ·»åŠ éš¨æ©Ÿå‡ºç¼ºå‹¤è³‡æ–™
                    const present = Math.floor(Math.random() * 5) + 1; // 1-5æ¬¡
                    const absent = Math.floor(Math.random() * 3); // 0-2æ¬¡
                    const late = Math.floor(Math.random() * 2); // 0-1æ¬¡
                    const unmarked = Math.floor(Math.random() * 2); // 0-1æ¬¡
                    
                    student.present = present;
                    student.absent = absent;
                    student.late = late;
                    student.unmarked = unmarked;
                    
                    // æ›´æ–°å‡ºç¼ºå‹¤è¨˜éŒ„
                    if (window.loadedStudentsData.attendanceRecords[studentId]) {
                        window.loadedStudentsData.attendanceRecords[studentId].present = present;
                        window.loadedStudentsData.attendanceRecords[studentId].absent = absent;
                        window.loadedStudentsData.attendanceRecords[studentId].late = late;
                        window.loadedStudentsData.attendanceRecords[studentId].unmarked = unmarked;
                    }
                    
                    console.log(`ğŸ“Š ${student.name}: å‡ºå¸­${present}æ¬¡, ç¼ºå¸­${absent}æ¬¡, é²åˆ°${late}æ¬¡, æœªæ¨™è¨˜${unmarked}æ¬¡`);
                });
                
                console.log('âœ… æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™å·²æ·»åŠ ');
                showToast('ğŸ§ª æ¸¬è©¦å‡ºç¼ºå‹¤è³‡æ–™å·²æ·»åŠ ', 'success', 2000);
            };
            
            // æ·»åŠ æ€§èƒ½å ±å‘Šé¡¯ç¤ºåŠŸèƒ½
            window.showPerformanceReport = function() {
                const report = PerformanceOptimizer.getPerformanceReport();
                console.log('ğŸ“Š ç³»çµ±æ€§èƒ½å ±å‘Š:', report);
                
                // å‰µå»ºæ€§èƒ½å ±å‘Šæ¨¡æ…‹æ¡†
                const modal = document.createElement('div');
                modal.className = 'performance-modal';
                modal.innerHTML = `
                    <div class="performance-content">
                        <div class="performance-header">
                            <h3>ğŸ“Š ç³»çµ±æ€§èƒ½å ±å‘Š</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="performance-body">
                            <div class="metric-section">
                                <h4>ğŸŒ API è«‹æ±‚çµ±è¨ˆ</h4>
                                <div class="metric-grid">
                                    <div class="metric-item">
                                        <span class="metric-label">ç¸½è«‹æ±‚æ•¸:</span>
                                        <span class="metric-value">${report.api.requests}</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">æˆåŠŸç‡:</span>
                                        <span class="metric-value">${report.api.successRate}</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">å¹³å‡éŸ¿æ‡‰æ™‚é–“:</span>
                                        <span class="metric-value">${report.api.averageResponseTime.toFixed(2)}ms</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="metric-section">
                                <h4>ğŸ“š å­¸ç”Ÿè³‡æ–™è¼‰å…¥çµ±è¨ˆ</h4>
                                <div class="metric-grid">
                                    <div class="metric-item">
                                        <span class="metric-label">è¼‰å…¥å˜—è©¦:</span>
                                        <span class="metric-value">${report.attendance.loadAttempts}</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">æˆåŠŸç‡:</span>
                                        <span class="metric-value">${report.attendance.successRate}</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">å¹³å‡è¼‰å…¥æ™‚é–“:</span>
                                        <span class="metric-value">${report.attendance.averageLoadTime.toFixed(2)}ms</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="metric-section">
                                <h4>ğŸ’¾ è¨˜æ†¶é«”ä½¿ç”¨æƒ…æ³</h4>
                                <div class="metric-grid">
                                    <div class="metric-item">
                                        <span class="metric-label">ç•¶å‰ä½¿ç”¨:</span>
                                        <span class="metric-value">${(report.memory.current / 1024 / 1024).toFixed(2)}MB</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">å³°å€¼ä½¿ç”¨:</span>
                                        <span class="metric-value">${(report.memory.peak / 1024 / 1024).toFixed(2)}MB</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">ä½¿ç”¨å¢é•·:</span>
                                        <span class="metric-value">${(report.memory.usageIncrease / 1024 / 1024).toFixed(2)}MB</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ æ¨£å¼
                const style = document.createElement('style');
                style.textContent = `
                    .performance-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    }
                    .performance-content {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        max-width: 600px;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    }
                    .performance-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #f0f0f0;
                        padding-bottom: 10px;
                    }
                    .close-btn {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                    }
                    .metric-section {
                        margin-bottom: 20px;
                        padding: 15px;
                        background: #f8f9fa;
                        border-radius: 8px;
                    }
                    .metric-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 10px;
                        margin-top: 10px;
                    }
                    .metric-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 12px;
                        background: white;
                        border-radius: 6px;
                        border: 1px solid #e0e0e0;
                    }
                    .metric-label {
                        font-weight: 500;
                        color: #666;
                    }
                    .metric-value {
                        font-weight: bold;
                        color: #333;
                    }
                `;
                document.head.appendChild(style);
                document.body.appendChild(modal);
                
                // é—œé–‰æŒ‰éˆ•äº‹ä»¶
                modal.querySelector('.close-btn').onclick = () => {
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                };
                
                // é»æ“ŠèƒŒæ™¯é—œé–‰
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        document.head.removeChild(style);
                    }
                };
            };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* å‹•ç•«æ•ˆèƒ½å„ªåŒ– - å…¨ç›¤å„ªåŒ–ç‰ˆæœ¬ */
        :root {
            --animation-duration: 0.3s;
            --transition-duration: 0.2s;
            --animation-timing: cubic-bezier(0.4, 0, 0.2, 1);
            --reduced-motion: 0.1s;
            --primary-color: #4f46e5;
            --secondary-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        @media (prefers-reduced-motion: reduce) {
            :root {
                --animation-duration: var(--reduced-motion);
                --transition-duration: var(--reduced-motion);
            }
            *, *::before, *::after {
                animation-duration: var(--reduced-motion) !important;
                animation-iteration-count: 1 !important;
                transition-duration: var(--reduced-motion) !important;
            }
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆå„ªåŒ– */
        @media (max-width: 768px) {
            :root {
                --animation-duration: 0.2s;
                --transition-duration: 0.15s;
            }
        }
        
        @media (max-width: 480px) {
            :root {
                --animation-duration: 0.15s;
                --transition-duration: 0.1s;
            }
        }
        
        /* æ€§èƒ½å„ªåŒ– */
        .performance-optimized {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        /* ç»ç’ƒè³ªæ„Ÿå„ªåŒ– */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
        }
        
        /* å‡ºç¼ºå‹¤ç´€éŒ„æ¨¡æ…‹æ¡†æ¨£å¼ */
        .attendance-record-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }
        
        .attendance-record-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideInUp 0.3s ease-out;
        }
        
        .attendance-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
            color: white;
            border-radius: 20px 20px 0 0;
        }
        
        .attendance-record-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-attendance-record-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-attendance-record-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .attendance-record-body {
            padding: 25px;
        }
        
        .student-info {
            background: rgba(79, 70, 229, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .info-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        .attendance-status {
            margin-bottom: 25px;
        }
        
        .attendance-status h4 {
            margin: 0 0 15px 0;
            color: #374151;
            font-size: 1.1rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }
        
        .status-item:hover {
            transform: translateY(-2px);
        }
        
        .status-item.present {
            border-left: 4px solid #10b981;
        }
        
        .status-item.absent {
            border-left: 4px solid #ef4444;
        }
        
        .status-item.late {
            border-left: 4px solid #f59e0b;
        }
        
        .status-item.unmarked {
            border-left: 4px solid #6b7280;
        }
        
        .status-item i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }
        
        .status-item.present i {
            color: #10b981;
        }
        
        .status-item.absent i {
            color: #ef4444;
        }
        
        .status-item.late i {
            color: #f59e0b;
        }
        
        .status-item.unmarked i {
            color: #6b7280;
        }
        
        .status-item span {
            display: block;
            font-weight: 600;
            color: #374151;
        }
        
        .status-count {
            font-size: 1.2rem;
            margin-top: 5px;
        }
        
        .attendance-details h4 {
            margin: 0 0 15px 0;
            color: #374151;
            font-size: 1.1rem;
        }
        
        .details-list {
            background: rgba(6, 182, 212, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #374151;
        }
        
        .detail-value {
            color: #6b7280;
            font-weight: 500;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* å•Ÿç”¨ç¡¬é«”åŠ é€Ÿå’Œæ•ˆèƒ½å„ªåŒ– */
        .event-card,.btn,.floating-filter-btn,.glass-card,.attendance-modal-content,.teacher-attendance-content,.floating-navigator,.toast,.countdown-toast,.liquid-button,.student-loading-overlay,#optimized-loading-overlay,[class*="liquid"],[class*="glass"]{transform:translateZ(0);backface-visibility:hidden;perspective:1000px;will-change:transform,opacity,box-shadow;contain:layout style paint}
        .liquid-loader,.liquid-ring,.liquid-ball{transform:translateZ(0);will-change:transform;contain:layout style paint}
        @media (prefers-reduced-motion:reduce){
            .liquid-loader *,.liquid-ring,.liquid-ball{animation-duration:0.1s!important;animation-iteration-count:1!important}
        }
        @media (max-width:768px){
            .liquid-loader{transform:scale(0.8)}
            .liquid-ring{border-width:2px}
            .liquid-ball{width:12px;height:12px}
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 215, 0, 0.03) 0%, transparent 50%),
                linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.98) 0%, 
                    rgba(248, 250, 252, 0.95) 25%,
                    rgba(255, 255, 255, 0.92) 50%,
                    rgba(248, 250, 252, 0.95) 75%,
                    rgba(255, 255, 255, 0.98) 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 60s ease infinite;
            min-height: 100vh;
            color: rgba(51, 51, 51, 0.95);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.03) 50%, transparent 70%),
                linear-gradient(-45deg, transparent 30%, rgba(255, 215, 0, 0.02) 50%, transparent 70%);
            animation: shimmer 40s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes subtleGlow {
            0%, 100% { 
                background-position: 0% 0%, 0% 0%, 0% 0%, 0% 50%;
            }
            50% { 
                background-position: 0% 0%, 0% 0%, 0% 0%, 100% 50%;
            }
        }
        
        /* å„ªåŒ–å‹•ç•«æŒçºŒæ™‚é–“ */
        .event-card {
            transition: all var(--transition-duration) var(--animation-timing);
        }
        
        .btn {
            transition: all var(--transition-duration) var(--animation-timing);
        }
        
        .floating-filter-btn {
            transition: all var(--transition-duration) var(--animation-timing);
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        /* æ–°å¢å‹•ç•«æ•ˆæœ */
        @keyframes buttonPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        @keyframes buttonClick {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes slideInRight {
            from { 
                opacity: 0; 
                transform: translateX(50px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        @keyframes bounceIn {
            0% { 
                opacity: 0; 
                transform: scale(0.3) translateY(-50px); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1.05) translateY(0); 
            }
            70% { 
                transform: scale(0.9); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes successPulse {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); 
            }
            70% { 
                transform: scale(1.1); 
                box-shadow: 0 0 0 15px rgba(76, 175, 80, 0); 
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); 
            }
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.2),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            z-index: 2;
        }

        /* é ‚éƒ¨æ¨™é¡Œå€åŸŸ */
        .header {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.8) 0%, 
                rgba(20, 20, 20, 0.9) 50%,
                rgba(0, 0, 0, 0.8) 100%);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            padding: 30px;
            margin-bottom: 25px;
            border-radius: 25px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: headerFloat 20s ease-in-out infinite;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.1) 0%, 
                transparent 25%,
                transparent 75%,
                rgba(255, 215, 0, 0.1) 100%);
            animation: shimmer 6s ease-in-out infinite;
            z-index: 1;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.05) 0%, 
                transparent 70%);
            animation: rotate 40s linear infinite;
            z-index: 0;
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
        }

        .header h1 {
            color: rgba(255, 215, 0, 0.95);
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.3), 
                0 0 30px rgba(255, 215, 0, 0.4),
                0 0 60px rgba(255, 215, 0, 0.2);
            animation: titleGlow 8s ease-in-out infinite alternate;
            position: relative;
            z-index: 2;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 8px 0 0 0;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2;
        }

        .header-tim-note {
            display: none; /* éš±è—åº•ä¸‹çš„å­— */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex: 1;
            text-align: center;
        }

        .header-logo {
            height: 50px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }



        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

            .user-info span {
                color: rgba(51, 51, 51, 0.9);
                font-weight: 500;
            }

            .user-details {
                align-items: center;
                text-align: center;
            }

            .user-name {
                font-size: 0.9rem;
                margin-bottom: 3px;
            }

            .user-id {
                font-size: 0.7rem;
                padding: 2px 4px;
            }

            .user-info-section {
                margin-top: 20px;
                padding: 15px;
            }

            .user-info-container h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }


        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .user-name {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .user-id {
            color: rgba(102, 102, 102, 0.8);
            font-size: 0.8rem;
            font-family: monospace;
            background: rgba(248, 249, 250, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }

        /* ç”¨æˆ¶è³‡è¨Šå€åŸŸ */
        .user-info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .user-info-container h3 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 15px 0;
            text-align: center;
        }

        /* æ—¥æœŸæ™‚é–“é¡¯ç¤ºå€åŸŸ */
        .datetime-display {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .datetime-item {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255, 223, 102, 0.3);
            text-align: center;
        }

        .datetime-item i {
            font-size: 1.1rem;
        }

        /* é€²åº¦æŒ‡ç¤ºå™¨ */
        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                transparent 50%,
                rgba(255, 255, 255, 0.1) 100%);
            animation: stepShimmer 3s ease-in-out infinite;
            z-index: 1;
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 2;
        }

        .step.completed .step-circle {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 2;
        }

        .step.pending .step-circle {
            background: linear-gradient(135deg, 
                rgba(85, 85, 85, 0.6) 0%, 
                rgba(60, 60, 60, 0.8) 100%);
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            z-index: 2;
        }

        .step-label {
            color: rgba(204, 204, 204, 0.9);
            font-size: 0.9rem;
            text-align: center;
        }

        .step.active .step-label {
            color: rgba(255, 223, 102, 0.9);
        }

        /* ä¸»å…§å®¹å€åŸŸ */
        .main-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .content-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .content-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .content-header i {
            color: rgba(255, 223, 102, 0.9);
            font-size: 1.3rem;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.15) 0%, 
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            overflow: hidden;
            animation: controlsFloat 16s ease-in-out infinite;
        }

        .controls::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.08) 0%, 
                transparent 30%,
                transparent 70%,
                rgba(255, 215, 0, 0.08) 100%);
            animation: controlsShimmer 8s ease-in-out infinite;
            z-index: 1;
        }

        .controls::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.03) 0%, 
                transparent 70%);
            animation: controlsRotate 50s linear infinite;
            z-index: 0;
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 700;
            color: rgba(0, 0, 0, 0.8);
            font-size: 0.95rem;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 2;
        }

        select, input {
            padding: 12px 16px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: rgba(255, 255, 255, 0.9);
            color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 2;
            will-change: transform, box-shadow, border-color;
        }

        select:focus, input:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 
                0 0 0 3px rgba(255, 215, 0, 0.2),
                0 8px 25px rgba(0, 0, 0, 0.2),
                0 0 20px rgba(255, 215, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-2px) scale(1.02);
        }

        select:hover, input:hover {
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.15),
                0 0 10px rgba(255, 215, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        select:active, input:active {
            transform: translateY(0) scale(1.01);
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }


        /* è¦–åœ–æŒ‰éˆ•çµ„ */
        .view-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            z-index: 2;
            transform: translateZ(0);
            will-change: transform, box-shadow, border-color;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 0;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 
                0 12px 30px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            color: rgba(255, 215, 0, 1);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.02);
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.8);
            box-shadow: 
                0 0 0 3px rgba(255, 215, 0, 0.2),
                0 8px 25px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 215, 0, 0.3);
        }






        .btn-primary {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-primary:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            color: rgba(255, 215, 0, 1);
        }

        .btn-primary:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }

        .btn-primary.active {
            background: rgba(255, 193, 7, 1);
            border-color: rgba(255, 193, 7, 1);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5);
            transform: translateY(-2px);
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9) !important; /* ç¢ºä¿é¸ä¸­æ™‚å­—é«”ç‚ºæ·±è‰² */
        }

        .btn-primary.active::after {
            content: 'âœ“';
            position: absolute;
            top: -5px;
            right: -5px;
            background: rgba(255, 255, 255, 1);
            color: rgba(255, 193, 7, 1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid rgba(255, 193, 7, 1);
        }


        /* å³å°‡åˆ°ä¾†èª²ç¨‹çš„é«˜äº®æ¨£å¼ */
        .event-card.upcoming-event {
            position: relative;
            background: white; /* ä¿æŒç™½è‰²èƒŒæ™¯ */
            border: 4px solid #FF8C42; /* å¢åŠ é‚Šæ¡†å¯¬åº¦ */
            box-shadow: 0 4px 15px rgba(255, 140, 66, 0.2);
            transform: scale(1.01);
            transition: all 0.3s ease;
        }

        .event-card.upcoming-event::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FF8C42, #FF6B35, #FF8C42, #FF6B35);
            border-radius: 10px;
            z-index: -1;
            opacity: 0.3; /* éå¸¸æ·¡çš„é‚Šæ¡†æ•ˆæœ */
            transition: opacity 0.3s ease;
        }

        .event-card.upcoming-event:hover::before {
            opacity: 0.5; /* hoveræ™‚ç¨å¾®åŠ æ·± */
        }

        .event-card.upcoming-event .event-title {
            color: #333; /* æ·±è‰²æ–‡å­—ï¼Œç¢ºä¿å¯è®€æ€§ */
            font-weight: 700;
        }

        .event-card.upcoming-event .event-instructor {
            color: #333; /* æ·±è‰²æ–‡å­—ï¼Œç¢ºä¿å¯è®€æ€§ */
            font-weight: 600;
        }

        .event-card.upcoming-event .event-detail {
            color: #333; /* æ·±è‰²æ–‡å­—ï¼Œç¢ºä¿å¯è®€æ€§ */
        }

        .event-card.upcoming-event .event-detail i {
            color: #666; /* åœ–ç¤ºé¡è‰² */
        }

        .event-card.upcoming-event .event-description {
            background: rgba(255, 140, 66, 0.08); /* éå¸¸æ·¡çš„æ©˜è‰²èƒŒæ™¯ */
            border-radius: 8px;
            padding: 12px;
        }

        .event-card.upcoming-event .event-description h4 {
            color: #333; /* æ·±è‰²æ–‡å­—ï¼Œç¢ºä¿å¯è®€æ€§ */
        }

        .event-card.upcoming-event .event-description p {
            color: #333; /* æ·±è‰²æ–‡å­—ï¼Œç¢ºä¿å¯è®€æ€§ */
        }

        /* å³å°‡åˆ°ä¾†èª²ç¨‹æ¨™è¨˜ */
        .upcoming-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #FF8C42;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .upcoming-badge i {
            font-size: 0.9rem;
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.9);
            color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(108, 117, 125, 0.9);
        }

        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateY(-1px);
            color: rgba(255, 215, 0, 0.9);
        }

        .btn-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* çµ±è¨ˆå€åŸŸ */
        .stats {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.15) 0%, 
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            overflow: hidden;
            animation: statsFloat 14s ease-in-out infinite;
        }

        .stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.08) 0%, 
                transparent 30%,
                transparent 70%,
                rgba(255, 215, 0, 0.08) 100%);
            animation: statsShimmer 10s ease-in-out infinite;
            z-index: 1;
        }

        .stats::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.03) 0%, 
                transparent 70%);
            animation: statsRotate 60s linear infinite;
            z-index: 0;
        }


        .events-container {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr;
        }

        .event-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 250, 252, 0.9) 50%,
                rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                0 0 0 1px rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.3);
            margin-bottom: 15px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            z-index: 3;
            overflow: hidden;
            will-change: transform, box-shadow, opacity;
        }

        .event-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9),
                0 0 0 1px rgba(255, 215, 0, 0.4);
            border-color: rgba(255, 215, 0, 0.5);
        }

        .event-card:active {
            transform: translateY(-2px) scale(1.01);
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                rgba(255, 215, 0, 0.8), 
                rgba(255, 193, 7, 0.6),
                rgba(255, 215, 0, 0.8));
            border-radius: 16px 16px 0 0;
        }

        .event-card.animated {
            opacity: 1;
            transform: translateY(0);
        }

        .event-card:nth-child(1) { animation-delay: 0.1s; }
        .event-card:nth-child(2) { animation-delay: 0.2s; }
        .event-card:nth-child(3) { animation-delay: 0.3s; }
        .event-card:nth-child(4) { animation-delay: 0.4s; }
        .event-card:nth-child(5) { animation-delay: 0.5s; }

        /* åœèª²ç‹€æ…‹æ¨£å¼ - åŠ å¼·ç‰ˆ */
        .event-card.cancelled-event {
            background: rgba(248, 249, 250, 0.9);
            border: 3px solid #dc3545;
            opacity: 0.8;
            position: relative;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
        }

        .event-card.cancelled-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(220, 53, 69, 0.15) 8px,
                rgba(220, 53, 69, 0.15) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.cancelled-event::after {
            content: 'âš ï¸ åœèª² âš ï¸';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            animation: bounce 1.5s infinite;
        }

        /* ä»£èª²ç‹€æ…‹æ¨£å¼ */
        .event-card.substitute-event {
            background: rgba(227, 242, 253, 0.9);
            border: 3px solid #2196F3;
            position: relative;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.4);
        }

        .event-card.substitute-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(33, 150, 243, 0.1) 8px,
                rgba(33, 150, 243, 0.1) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.substitute-event::after {
            content: 'ğŸ”„ ä»£èª²';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            animation: substituteBounce 2s infinite;
            border: 2px solid #0D47A1;
        }

        @keyframes substituteBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-10px) scale(1.1);
            }
            60% {
                transform: translateY(-5px) scale(1.05);
            }
        }

        /* é«”é©—ç‹€æ…‹æ¨£å¼ */
        .experience-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #8B4513;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            animation: experiencePulse 3s infinite;
            border: 2px solid #B8860B;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        @keyframes experiencePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            }
            30% {
                transform: scale(1.2);
                color: #FFD700;
                font-weight: bold;
                text-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
            }
            70% {
                transform: scale(1.1);
                color: #FFA500;
                font-weight: bold;
                text-shadow: 0 0 6px rgba(255, 165, 0, 0.3);
            }
        }

        .event-card.experience-event {
            background: rgba(255, 248, 220, 0.9);
            border: 3px solid #FFD700;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }

        .event-card.experience-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(255, 215, 0, 0.1) 8px,
                rgba(255, 215, 0, 0.1) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.experience-event::after {
            content: 'â­ é«”é©—';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #FFD700;
            color: #8B4513;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            animation: experienceBounce 2s infinite;
            border: 2px solid #B8860B;
        }

        @keyframes experienceBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-10px) scale(1.1);
            }
            60% {
                transform: translateY(-5px) scale(1.05);
            }
        }

        .cancelled-badge {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            animation: pulse 1.5s infinite;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            border: 2px solid white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .substitute-badge {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            animation: substitutePulse 3s infinite;
            border: 2px solid #0D47A1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        @keyframes substitutePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(33, 150, 243, 0.7);
            }
        }

        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
            transform: translateY(-5px);
            }
        }

        .event-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .event-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: rgba(255, 223, 102, 0.9);
            border-radius: 2px 0 0 2px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .event-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: rgba(0, 0, 0, 0.9);
            margin-bottom: 12px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
            letter-spacing: 0.5px;
        }

        .event-instructor {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 
                0 4px 12px rgba(255, 215, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(0, 0, 0, 0.8);
            font-size: 0.95rem;
            font-weight: 500;
            padding: 8px 12px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }

        .event-detail:hover {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.3);
            transform: translateY(-1px);
        }

        .event-detail i {
            width: 22px;
            color: rgba(255, 215, 0, 0.8);
            text-align: center;
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .location-link {
            color: #0066cc !important;
            text-decoration: underline !important;
            text-decoration-color: #0066cc !important;
            text-decoration-thickness: 2px !important;
            text-underline-offset: 3px !important;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            position: relative;
            font-weight: 600;
            border: 2px solid rgba(0, 102, 204, 0.2);
            box-shadow: 0 2px 4px rgba(0, 102, 204, 0.1);
        }

        .location-link:hover {
            color: #ffffff !important;
            background: linear-gradient(135deg, #0066cc, #004499) !important;
            text-decoration: none !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
            border-color: #0066cc;
        }

        .location-link:active {
            color: #ffffff !important;
            background: linear-gradient(135deg, #004499, #003366) !important;
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 102, 204, 0.3);
        }

        .location-external-icon {
            font-size: 0.8rem;
            opacity: 1;
            color: #0066cc;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .location-link:hover .location-external-icon {
            opacity: 1;
            transform: scale(1.2);
            color: #ffffff;
        }

        .location-map-icon {
            font-size: 0.9rem;
            opacity: 1;
            color: #0066cc;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .location-link:hover .location-map-icon {
            opacity: 1;
            transform: scale(1.2);
            color: #ffffff;
        }

        .countdown-timer {
            background: rgba(255, 193, 7, 0.15);
            border: 2px solid rgba(255, 193, 7, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            margin-top: 12px;
            text-align: center;
            font-weight: 700;
            color: rgba(255, 193, 7, 1);
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 12px rgba(255, 193, 7, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .countdown-timer.upcoming {
            background: rgba(76, 175, 80, 0.15);
            border-color: rgba(76, 175, 80, 0.4);
            color: rgba(76, 175, 80, 1);
            box-shadow: 
                0 4px 12px rgba(76, 175, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-timer.ongoing {
            background: rgba(33, 150, 243, 0.15);
            border-color: rgba(33, 150, 243, 0.4);
            color: rgba(33, 150, 243, 1);
            box-shadow: 
                0 4px 12px rgba(33, 150, 243, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-timer.overdue {
            background: rgba(244, 67, 54, 0.15);
            border-color: rgba(244, 67, 54, 0.4);
            color: rgba(244, 67, 54, 1);
            box-shadow: 
                0 4px 12px rgba(244, 67, 54, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-text {
            font-size: 0.9rem;
            margin: 0;
        }

        .countdown-icon {
            margin-right: 6px;
            font-size: 0.8rem;
        }

        .event-description {
            background: rgba(248, 249, 250, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid rgba(255, 223, 102, 0.9);
        }

        .event-description h4 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: 600;
        }

        .event-description p {
            color: rgba(102, 102, 102, 0.9);
            line-height: 1.5;
            font-size: 0.9rem;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .lesson-section {
            margin-top: 15px;
        }

        .lesson-label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .lesson-button {
            display: inline-block;
            background: rgba(255, 223, 102, 0.9);
            color: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .lesson-button:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .no-events i {
            font-size: 4rem;
            color: rgba(255, 223, 102, 0.9);
            margin-bottom: 20px;
        }

        .no-events h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: rgba(51, 51, 51, 0.9);
        }

        .no-events p {
            font-size: 1.1rem;
            color: rgba(102, 102, 102, 0.9);
        }

        /* è¨­ç½®ç•«é¢æ¨£å¼ */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .settings-modal {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(240, 240, 240, 0.9);
        }

        .settings-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .close-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            transform: scale(1.1);
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .color-picker-item label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            min-width: 80px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .instructor-color-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .instructor-color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .instructor-color-item label {
            font-size: 0.9rem;
            color: rgba(51, 51, 51, 0.9);
            min-width: 60px;
            font-weight: 600;
        }

        .instructor-color-picker {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .instructor-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .instructor-color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .save-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .save-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* é‡æ–°æ•´ç†æµ®å‹•æŒ‰éˆ• - è˜‹æœ iOS 16 æ¶²æ…‹ç»ç’ƒæ•ˆæœ */
        .refresh-button {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1000;
            user-select: none;
            overflow: hidden;
            will-change: transform, box-shadow;
        }

        .refresh-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .refresh-button:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .refresh-button:hover::before {
            opacity: 1;
        }

        .refresh-button:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 
                0 6px 24px rgba(0, 0, 0, 0.12),
                0 2px 6px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .refresh-button i {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .refresh-button.loading i {
            animation: spin 1s linear infinite;
        }

        .refresh-button.loading {
            background: rgba(0, 122, 255, 0.2);
            border-color: rgba(0, 122, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 122, 255, 0.2),
                0 2px 8px rgba(0, 122, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* æ–°å¢çš„å‹•ç•«æ•ˆæœ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.4);
            }
        }
        
        @keyframes liquidFlow {
            0% { transform: translateX(-100%) rotate(0deg); }
            50% { transform: translateX(0%) rotate(180deg); }
            100% { transform: translateX(100%) rotate(360deg); }
        }
        
        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }
        
        @keyframes shimmer2 {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* æ¶²æ…‹æ¯›ç»ç’ƒæ•ˆæœ */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glassmorphism-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .liquid-button {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .liquid-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer2 2s infinite;
        }
        
        .liquid-button:hover::before {
            animation: shimmer2 0.8s infinite;
        }
        
        /* æµ®å‹•é€šçŸ¥æ¨£å¼ */
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 300px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            color: #fff;
            font-weight: 600;
            font-size: 0.9rem;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        
        .floating-notification.show {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .floating-notification.progress {
            background: rgba(40, 167, 69, 0.15);
            border-color: rgba(40, 167, 69, 0.3);
            color: #fff;
        }
        
        .floating-notification.completion {
            background: rgba(255, 193, 7, 0.15);
            border-color: rgba(255, 193, 7, 0.3);
            color: #fff;
            animation: celebration 0.6s ease;
        }
        
        @keyframes celebration {
            0% { transform: translateX(100%) scale(0.8); }
            50% { transform: translateX(0) scale(1.05); }
            100% { transform: translateX(0) scale(1); }
        }
        
        .progress-bar-floating {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill-floating {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification-icon {
            font-size: 1.2rem;
        }
        
        .notification-text {
            flex: 1;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.1rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .notification-close:hover {
            opacity: 1;
        }

        /* CSP å…¼å®¹çš„ hover æ•ˆæœ */
        .close-attendance-modal:hover {
            background: rgba(220, 53, 69, 0.1) !important;
            color: #dc3545 !important;
        }
        
        .present-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4) !important;
            transition: all 0.3s ease !important;
        }
        
        .absent-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4) !important;
            transition: all 0.3s ease !important;
        }
        
        .present-btn:active {
            transform: translateY(0px) !important;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important;
            transition: all 0.1s ease !important;
        }
        
        .absent-btn:active {
            transform: translateY(0px) !important;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3) !important;
            transition: all 0.1s ease !important;
        }
        
        .refresh-students-btn:hover {
            background: rgba(102, 126, 234, 1) !important;
        }
        
        /* é‡æ–°è¼‰å…¥æŒ‰éˆ•å‹•ç•« */
        @keyframes refreshSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-students-btn.loading {
            animation: refreshSpin 1s linear infinite;
            pointer-events: none;
        }


        /* çµ±è¨ˆæ¬„ä½å‹•ç•« */
        .stats-animation {
            animation: statsPulse 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes statsPulse {
            0% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
            25% { 
                transform: scale(1.08) rotate(1deg);
                filter: brightness(1.1);
            }
            50% { 
                transform: scale(0.95) rotate(-1deg);
                filter: brightness(0.9);
            }
            75% { 
                transform: scale(1.03) rotate(0.5deg);
                filter: brightness(1.05);
            }
            100% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
        }

        .stats-item-updated {
            animation: statsItemUpdate 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes statsItemUpdate {
            0% { 
                transform: scale(1);
                background: transparent;
            }
            25% { 
                transform: scale(1.1);
                background: rgba(255, 215, 0, 0.2);
            }
            50% { 
                transform: scale(0.95);
                background: rgba(255, 215, 0, 0.3);
            }
            75% { 
                transform: scale(1.05);
                background: rgba(255, 215, 0, 0.1);
            }
            100% { 
                transform: scale(1);
                background: transparent;
            }
        }
        
        .refresh-students-btn.loading i {
            animation: refreshSpin 1s linear infinite;
        }

        /* å¡ç‰Œå‹•ç•«æ•ˆæœ */
        @keyframes cardFlipIn {
            0% {
                transform: rotateY(-90deg) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: rotateY(-45deg) scale(0.9);
                opacity: 0.7;
            }
            100% {
                transform: rotateY(0deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes cardSlideIn {
            0% {
                transform: translateX(-100px) rotateY(-30deg);
                opacity: 0;
            }
            50% {
                transform: translateX(-20px) rotateY(-15deg);
                opacity: 0.7;
            }
            100% {
                transform: translateX(0) rotateY(0deg);
                opacity: 1;
            }
        }

        @keyframes cardBounceIn {
            0% {
                transform: translateY(-50px) scale(0.3);
                opacity: 0;
            }
            50% {
                transform: translateY(10px) scale(1.05);
                opacity: 0.8;
            }
            70% {
                transform: translateY(-5px) scale(0.98);
                opacity: 0.9;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes cardShimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        .student-card {
            animation: cardSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .student-card:nth-child(1) { animation-delay: 0.05s; }
        .student-card:nth-child(2) { animation-delay: 0.1s; }
        .student-card:nth-child(3) { animation-delay: 0.15s; }
        .student-card:nth-child(4) { animation-delay: 0.2s; }
        .student-card:nth-child(5) { animation-delay: 0.25s; }
        .student-card:nth-child(6) { animation-delay: 0.3s; }
        .student-card:nth-child(7) { animation-delay: 0.35s; }
        .student-card:nth-child(8) { animation-delay: 0.4s; }
        .student-card:nth-child(9) { animation-delay: 0.45s; }
        .student-card:nth-child(10) { animation-delay: 0.5s; }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: cardShimmer 2s ease-in-out;
        }

        .student-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 215, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .student-card.selected {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 
                0 12px 30px rgba(0, 0, 0, 0.2),
                0 0 0 2px rgba(255, 215, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border-color: #b8860b;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .student-card.double-click-animation {
            animation: cardDoubleClick 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes cardDoubleClick {
            0% { transform: scale(1); }
            25% { transform: scale(0.98); }
            50% { transform: scale(1.03); }
            75% { transform: scale(0.99); }
            100% { transform: scale(1); }
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        #studentsList::-webkit-scrollbar {
            width: 6px;
        }

        #studentsList::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #studentsList::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.6), rgba(255, 215, 0, 0.4));
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        #studentsList::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.8), rgba(255, 215, 0, 0.6));
        }

        /* æ‡¸æµ®å›ºå®šé¸å–®æ¨£å¼ */
        .floating-stats-menu {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: 
                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 70%),
                linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.25) 0%, 
                    rgba(248, 249, 250, 0.2) 50%,
                    rgba(255, 255, 255, 0.25) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 12px 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(-20px) scale(0.9);
        }

        .floating-stats-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0) scale(1);
        }

        .floating-stats-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 0.85rem;
            color: rgba(51, 51, 51, 0.9);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            flex-wrap: nowrap;
        }

        .floating-stats-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .floating-stats-item .icon {
            color: #b8860b;
            font-size: 0.9rem;
            text-shadow: 0 0 8px rgba(184, 134, 11, 0.5);
        }

        .floating-stats-item .value {
            color: rgba(51, 51, 51, 0.8);
            font-weight: 700;
        }

        .floating-filter-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
        }

        .floating-filter-btn {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: #333333;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            white-space: nowrap;
        }

        .floating-filter-btn:hover {
            background: linear-gradient(135deg, rgba(184, 134, 11, 0.4), rgba(184, 134, 11, 0.3));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(184, 134, 11, 0.3);
        }

        .floating-filter-btn.active {
            background: linear-gradient(135deg, #b8860b, #daa520);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(184, 134, 11, 0.5);
            transform: translateY(-1px);
        }

        .floating-filter-btn:active {
            transform: translateY(0) scale(0.95);
            transition: all 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .floating-filter-btn.clicked {
            animation: buttonClickPulse 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes buttonClickPulse {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(0.95); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .floating-stats-menu {
                top: 10px;
                padding: 10px 16px;
                border-radius: 16px;
                max-width: 95%;
            }
            
            .floating-stats-content {
                gap: 8px;
                font-size: 0.8rem;
                flex-wrap: nowrap;
                justify-content: center;
            }
            
            .floating-filter-buttons {
                margin-left: 0;
                gap: 6px;
            }
            
            .floating-filter-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .floating-stats-menu {
                top: 8px;
                padding: 8px 12px;
                border-radius: 12px;
                max-width: 98%;
            }
            
            .floating-stats-content {
                gap: 6px;
                font-size: 0.7rem;
                flex-wrap: nowrap;
                justify-content: center;
            }
            
            .floating-filter-buttons {
                margin-left: 0;
                gap: 4px;
            }
            
            .floating-filter-btn {
                padding: 5px 8px;
                font-size: 0.65rem;
                min-width: 50px;
            }
        }

        /* ç¼ºå‹¤ç´€éŒ„æ¨¡æ…‹æ¡†æ¨£å¼ */
        .attendance-record-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .attendance-record-content {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 249, 250, 0.9) 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .attendance-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }

        .attendance-record-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .close-attendance-record-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-attendance-record-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            color: #ff0000;
            transform: scale(1.1);
        }

        .attendance-record-list {
            max-height: 350px;
                            min-height: 200px;
            overflow-y: auto;
        }

        .attendance-record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border-left: 4px solid #b8860b;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .attendance-record-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .attendance-record-date {
            font-weight: bold;
            color: #333;
        }

        .attendance-record-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .attendance-record-status.present {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .attendance-record-status.absent {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .attendance-record-status.leave {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .attendance-record-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .attendance-record-error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }

        /* æ‰‹æ©Ÿå„ªåŒ– - æµ®å‹•é€šçŸ¥ */
        @media (max-width: 768px) {
            .floating-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                font-size: 0.85rem;
                padding: 12px 16px;
            }
            
            .notification-content {
                gap: 8px;
            }
            
            .notification-icon {
                font-size: 1.1rem;
            }
        }

        /* æ‡¸æµ®å°èˆªå™¨æ¨£å¼ */
        .floating-navigator {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: flex;
            flex-wrap: nowrap;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 12px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            justify-content: space-around;
            min-width: 300px;
        }

        @keyframes slideDown {
            0% {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            0% {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .nav-item {
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
            position: relative;
            overflow: hidden;
            min-width: 120px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .nav-item:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-item.active {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.8) 0%, 
                rgba(255, 193, 7, 0.9) 100%);
            border: 1px solid rgba(255, 215, 0, 0.6);
            color: #333;
            box-shadow: 
                0 4px 15px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .nav-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-item .icon {
            font-size: 1.1rem;
        }

        .nav-item .text {
            font-size: 0.85rem;
        }

        /* æ¨¡æ…‹æ¡†å·¦ç§»å‹•ç•« */
        .attendance-modal-content.slide-left {
            animation: slideLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideLeft {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        /* è¬›å¸«å ±è¡¨æ¨£å¼ */
        .teacher-attendance-content {
            width: 100%;
            min-height: 100%;
        }
        
        /* æ¶²æ…‹ç»ç’ƒå¡ç‰‡æ¨£å¼ */
        .glass-card {
            position: relative;
        }
        
        /* å…‰æ•ˆå‹•ç•« */
        @keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(30deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(30deg);
            }
        }
        
        /* æŒ‰éˆ•æ‡¸åœæ•ˆæœ */
        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                0 4px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        
        .mode-btn:hover .shimmer-effect {
            left: 100%;
        }
        
        /* æ–‡å­—è¼¸å…¥æ¡†ç„¦é»æ•ˆæœ */
        #course-content:focus {
            transform: scale(1.02);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* é˜²æ­¢è¼¸å…¥æ¡†èšç„¦æ™‚é é¢ç¸®æ”¾ */
        input, textarea, select {
            font-size: 16px !important;
            -webkit-text-size-adjust: 100%;
            -webkit-appearance: none;
            appearance: none;
            border-radius: 0;
        }
        
        /* ç‰¹åˆ¥é‡å°èª²ç¨‹å…§å®¹è¼¸å…¥æ¡† */
        #course-content {
            font-size: 16px !important;
            -webkit-text-size-adjust: 100%;
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* é˜²æ­¢iOS Safariç¸®æ”¾ */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }
        
        /* å€’æ•¸è¨ˆæ™‚æç¤ºæ¨£å¼ */
        .countdown-toast {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 10000 !important;
        }
        
        /* äººæ•¸é¸æ“‡æŒ‰éˆ•æ¨£å¼ */
        .count-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .count-btn.active {
            border-width: 4px;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .count-btn.active {
            border-color: #ff6b35;
            background: linear-gradient(135deg, #fff5f2, #ffe8e0);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
        }
        
        .count-btn.active i {
            color: #ff6b35;
            transform: scale(1.1);
        }

        .report-form textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        /* æ‰‹æ©Ÿå„ªåŒ– - æ‡¸æµ®å°èˆªå™¨ */
        @media (max-width: 768px) {
            .floating-navigator {
                bottom: 10px;
                left: 0;
                right: 0;
                transform: none;
                width: calc(100% - 40px);
                margin: 0 20px;
                padding: 12px;
                border-radius: 20px;
                justify-content: space-around;
            }

            .nav-item {
                padding: 12px 20px;
                min-width: 120px;
                font-size: 0.85rem;
                flex: 1;
                text-align: center;
            }

            .nav-item .icon {
                font-size: 1rem;
            }

            .nav-item .text {
                font-size: 0.75rem;
            }

            .mode-buttons {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .mode-btn {
                padding: 12px;
            }

            .mode-btn i {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .floating-navigator {
                bottom: 5px;
                left: 0;
                right: 0;
                transform: none;
                width: calc(100% - 30px);
                margin: 0 15px;
                padding: 10px;
                border-radius: 18px;
                justify-content: space-around;
            }

            .nav-item {
                padding: 10px 16px;
                min-width: 100px;
                font-size: 0.8rem;
                flex: 1;
                text-align: center;
            }

            .nav-item .icon {
                font-size: 0.9rem;
            }

            .nav-item .text {
                font-size: 0.7rem;
            }
        }

        /* æ‰‹æ©Ÿå„ªåŒ– - ç°½åˆ°ç³»çµ± */
        @media (max-width: 768px) {
            .attendance-modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 10px !important;
                padding: 20px !important;
                max-height: 90vh !important;
            }
            
            .attendance-modal-content h2 {
                font-size: 1.2rem !important;
                margin-bottom: 15px !important;
            }
            
            .attendance-modal-content .course-info {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
                font-size: 0.85rem !important;
            }
            
            .attendance-student-item {
                flex-direction: row !important;
                align-items: center !important;
                padding: 12px 15px !important;
                gap: 12px !important;
                min-height: 60px !important;
                margin-bottom: 8px !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .attendance-student-item .student-info {
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                flex: 1 !important;
                min-width: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .attendance-student-item .student-actions {
                display: flex !important;
                gap: 4px !important;
                justify-content: space-between !important;
                flex-shrink: 0 !important;
                width: 100% !important;
                max-width: 140px !important;
            }
            
            .attendance-btn {
                padding: 6px 8px !important;
                font-size: 0.75rem !important;
                min-height: 32px !important;
                min-width: 50px !important;
                max-width: 65px !important;
                flex: 1 !important;
                margin: 2px !important;
            }
            
            .attendance-stats {
                flex-direction: column !important;
                gap: 10px !important;
                align-items: stretch !important;
            }
            
            .attendance-stats .stats-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
                font-size: 0.8rem !important;
            }
            
            .refresh-students-btn {
                width: 100% !important;
                padding: 12px !important;
                font-size: 0.9rem !important;
            }
            
            /* æ‰‹æ©Ÿç«¯å‡ºç¼ºå‹¤æ¬¡æ•¸ä½ˆå±€å„ªåŒ– */
            .student-card .attendance-stats-mobile {
                display: flex !important;
                flex-direction: column !important;
                gap: 4px !important;
                margin-bottom: 8px !important;
                width: 100% !important;
            }
            
            .student-card .attendance-stats-row {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                gap: 8px !important;
                flex-wrap: wrap !important;
            }
            
            .student-card .attendance-stat-item {
                display: flex !important;
                align-items: center !important;
                gap: 4px !important;
                font-size: 0.6rem !important;
                font-weight: 600 !important;
                padding: 2px 6px !important;
                border-radius: 8px !important;
                background: rgba(255, 255, 255, 0.8) !important;
                backdrop-filter: blur(10px) !important;
                -webkit-backdrop-filter: blur(10px) !important;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
                min-width: 0 !important;
                flex: 1 !important;
                max-width: calc(50% - 4px) !important;
            }
            
            .student-card .attendance-stat-item i {
                font-size: 0.7rem !important;
                flex-shrink: 0 !important;
            }
            
            .student-card .attendance-stat-item.present {
                color: #28a745 !important;
                border: 1px solid rgba(40, 167, 69, 0.3) !important;
            }
            
            .student-card .attendance-stat-item.absent {
                color: #dc3545 !important;
                border: 1px solid rgba(220, 53, 69, 0.3) !important;
            }
            
            .student-card .attendance-stat-item.late {
                color: #ffc107 !important;
                border: 1px solid rgba(255, 193, 7, 0.3) !important;
            }
            
            .student-card .attendance-stat-item.unmarked {
                color: #6c757d !important;
                border: 1px solid rgba(108, 117, 125, 0.3) !important;
            }
            
            /* æ‰‹æ©Ÿç«¯é¡¯ç¤ºåˆ‡æ› */
            .attendance-stats-desktop {
                display: none !important;
            }
            
            .attendance-stats-mobile {
                display: block !important;
            }
        }
        
        /* æ¡Œé¢ç«¯é¡¯ç¤ºåˆ‡æ› */
        @media (min-width: 769px) {
            .attendance-stats-desktop {
                display: flex !important;
            }
            
            .attendance-stats-mobile {
                display: none !important;
            }
        }

        @media (max-width: 480px) {
            .attendance-modal-content {
                width: 98% !important;
                padding: 15px !important;
            }
            
            .attendance-student-item {
                flex-direction: row !important;
                align-items: center !important;
                padding: 10px 12px !important;
                gap: 10px !important;
                min-height: 55px !important;
                margin-bottom: 6px !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .attendance-student-item .student-info {
                gap: 8px !important;
                flex: 1 !important;
                min-width: 0 !important;
            }
            
            .attendance-student-item .student-avatar {
                width: 32px !important;
                height: 32px !important;
                font-size: 0.9rem !important;
            }
            
            .attendance-student-item .student-name {
                font-size: 0.9rem !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            .attendance-student-item .student-actions {
                gap: 3px !important;
                flex-shrink: 0 !important;
                width: 100% !important;
                max-width: 120px !important;
            }
            
            .attendance-btn {
                padding: 4px 6px !important;
                font-size: 0.7rem !important;
                min-height: 28px !important;
                min-width: 45px !important;
                max-width: 60px !important;
                flex: 1 !important;
                margin: 1px !important;
            }
            
            .attendance-stats .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 6px !important;
            }
            
            /* 480pxä»¥ä¸‹æ‰‹æ©Ÿå‡ºç¼ºå‹¤æ¬¡æ•¸é€²ä¸€æ­¥å„ªåŒ– */
            .student-card .attendance-stats-mobile {
                margin-bottom: 6px !important;
            }
            
            .student-card .attendance-stats-row {
                gap: 4px !important;
                margin-bottom: 2px !important;
            }
            
            .student-card .attendance-stat-item {
                font-size: 0.55rem !important;
                padding: 1px 4px !important;
                border-radius: 6px !important;
                max-width: calc(50% - 2px) !important;
            }
            
            .student-card .attendance-stat-item i {
                font-size: 0.6rem !important;
            }
            
            .student-card .attendance-stat-item span {
                font-size: 0.55rem !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
        }

        /* å¾®äº¤äº’æ•ˆæœ */
        .smooth-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .smooth-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .bounce-in {
            animation: scaleIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .fade-in-up {
            animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .pulse-effect {
            animation: pulse 2s infinite;
        }

        .shake-effect {
            animation: shake 0.5s ease-in-out;
        }

        .glow-effect {
            animation: glow 2s ease-in-out infinite;
        }

        /* ç°½åˆ°ç³»çµ±æ‡¸æµ®é¸å–® */
        .attendance-menu {
            position: fixed;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            user-select: none;
        }

        .attendance-menu-button {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 0.9) 0%, 
                rgba(69, 160, 73, 0.8) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 32px rgba(76, 175, 80, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            will-change: transform, box-shadow;
        }

        .attendance-menu-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .attendance-menu-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .attendance-menu-button:hover {
            transform: translateY(-3px) scale(1.1);
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 1) 0%, 
                rgba(69, 160, 73, 0.9) 100%);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 
                0 15px 45px rgba(76, 175, 80, 0.5),
                0 6px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .attendance-menu-button:hover::before {
            opacity: 1;
        }

        .attendance-menu-button:hover::after {
            width: 80px;
            height: 80px;
        }

        .attendance-menu-button:active {
            transform: translateY(-1px) scale(1.05);
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 0.95) 0%, 
                rgba(69, 160, 73, 0.85) 100%);
            box-shadow: 
                0 8px 25px rgba(76, 175, 80, 0.4),
                0 3px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .attendance-menu-button i {
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            z-index: 1;
        }

        .attendance-menu-tooltip {
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none;
            z-index: 1001;
        }

        .attendance-menu-tooltip::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid rgba(0, 0, 0, 0.8);
        }

        .attendance-menu:hover .attendance-menu-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(5px);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            /* æ•´å€‹é é¢å¯ä»¥æ»‘å‹• */
            body {
                overflow-x: hidden;
                overflow-y: auto;
                margin: 0;
                padding: 0;
            }
            
            .container {
                padding: 0;
                max-width: 100%;
                margin: 0;
            }
            
            /* ç¯©é¸å€åŸŸå®Œå…¨å›ºå®šï¼Œçµ•å°ä¸æœƒç§»å‹• */
            .control-section {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 9999 !important;
                background: white !important;
                padding: 6px !important; /* æ¸›å°‘å…§é‚Šè· */
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
                width: 100% !important;
                height: auto !important;
                /* ç¢ºä¿ç¯©é¸å€åŸŸæ°¸é å›ºå®šåœ¨é ‚éƒ¨ï¼Œçµ•å°ä¸æœƒç§»å‹• */
                transform: translateZ(0) !important; /* å¼·åˆ¶ç¡¬é«”åŠ é€Ÿ */
                will-change: auto !important; /* å„ªåŒ–æ¸²æŸ“æ€§èƒ½ */
                backface-visibility: hidden !important; /* é˜²æ­¢é–ƒçˆ */
                /* ç¢ºä¿ç¯©é¸å€å¡Šè¦†è“‹åœ¨æ¨™é¡Œå€å¡Šä¸Šæ–¹ */
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* ä¸»å…§å®¹å€åŸŸï¼Œç‚ºå›ºå®šç¯©é¸å€åŸŸç•™å‡ºç©ºé–“ */
            .main-content {
                margin-top: 0 !important; /* ç§»é™¤é ‚éƒ¨é–“è·ï¼Œè®“å…§å®¹ç·Šè²¼ç¯©é¸å€å¡Š */
                padding: 8px 8px 4px 8px; /* æ¸›å°‘åº•éƒ¨é–“è· */
                /* è®“æ•´å€‹é é¢å¯ä»¥æ­£å¸¸æ»‘å‹• */
            }
            
            /* ç§»é™¤è¦–åœ–æŒ‰éˆ•çš„ sticky å®šä½ï¼Œå› ç‚ºç¯©é¸å€åŸŸå·²ç¶“å›ºå®š */
            .view-buttons {
                position: static !important;
                /* æ·»åŠ æ»‘å‹•æç¤º */
                position: relative;
                margin: 4px 0 !important; /* æ¸›å°‘ä¸Šä¸‹é–“è· */
            }
            
            /* ç§»é™¤åŸæœ¬çš„æ»‘å‹•æç¤ºæŒ‡ç¤ºå™¨ */
            .view-buttons::after {
                display: none;
            }
            
            
            /* æŒ‰éˆ•è„ˆè¡å‹•ç•« */
            @keyframes buttonPulse {
                0% { 
                    transform: scale(1.1); 
                    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
                }
                50% { 
                    transform: scale(1.15); 
                    box-shadow: 0 8px 16px rgba(0, 123, 255, 0.5);
                }
                100% { 
                    transform: scale(1.1); 
                    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
                }
            }
            
            /* è¦–åœ–æŒ‰éˆ•é¸ä¸­æ•ˆæœ */
            .view-buttons .btn-primary.active {
                background: linear-gradient(135deg, #ffc107, #ff9800) !important;
                color: rgba(0, 0, 0, 0.9) !important;
                border: 2px solid #ff9800 !important;
                box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3) !important;
                transform: scale(1.05) !important;
                font-weight: 600 !important;
            }
            
            .view-buttons .btn-primary:not(.active) {
                background: rgba(255, 193, 7, 0.3) !important;
                color: rgba(0, 0, 0, 0.7) !important;
                border: 1px solid rgba(255, 193, 7, 0.5) !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            }
            
            .view-buttons .btn-primary:hover {
                background: rgba(255, 193, 7, 0.6) !important;
                transform: scale(1.02) !important;
                transition: all 0.2s ease !important;
            }


            .header {
                padding: 12px;
                margin-bottom: 0 !important; /* ç§»é™¤åº•éƒ¨é–“è·ï¼Œé¿å…èˆ‡ç¯©é¸å€å¡Šé‡ç–Š */
                position: relative !important; /* ç¢ºä¿æ¨™é¡Œå€å¡Šä¸æœƒå½±éŸ¿ç¯©é¸å€å¡Š */
            }

            .header h1 {
                font-size: 1.4rem;
                line-height: 1.2;
            }

            .header-logo {
                height: 35px;
            }

            .header-left {
                gap: 8px;
                justify-content: center;
                text-align: center;
            }


            .control-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .control-group {
                width: 100%;
            }

            .control-group label {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }

            .control-group select,
            .control-group input {
                padding: 8px;
                font-size: 0.9rem;
                border-radius: 6px;
            }

            .view-buttons {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                width: 100%;
            }


            .btn-primary {
                padding: 8px 4px;
                font-size: 0.75rem;
                text-align: center;
                min-height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            
            .btn-primary.active {
                color: rgba(0, 0, 0, 0.9) !important; /* ç¢ºä¿é¸ä¸­æ™‚å­—é«”ç‚ºæ·±è‰² */
            }

            .events-container {
                gap: 8px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-header {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                margin-bottom: 12px;
            }

            .event-title {
                font-size: 1rem;
                line-height: 1.3;
                word-wrap: break-word;
            }

            .event-instructor {
                padding: 4px 8px;
                font-size: 0.8rem;
                align-self: flex-start;
            }

            .event-details {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-bottom: 12px;
            }

            .event-detail {
                font-size: 0.8rem;
                padding: 4px 0;
            }

            .event-detail i {
                margin-right: 6px;
                width: 14px;
            }

            .event-description {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 6px;
            }

            .event-description h4 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }

            .event-description p {
                font-size: 0.8rem;
                line-height: 1.4;
                word-wrap: break-word;
            }

            .lesson-button {
                padding: 6px 12px;
                font-size: 0.8rem;
                border-radius: 6px;
            }


            .settings-modal {
                width: 95%;
                padding: 16px;
                margin: 10px auto;
            }

            .color-picker-group {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .instructor-color-group {
                grid-template-columns: 1fr;
            }

            .datetime-display {
                flex-direction: column;
                gap: 6px;
                justify-content: center;
                align-items: center;
            }

            .datetime-item {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .progress-steps {
                gap: 8px;
                margin: 12px 0;
                justify-content: center;
            }

            .progress-step {
                font-size: 0.7rem;
                padding: 6px 8px;
            }

            /* æ‰‹æ©Ÿç‰ˆé‡æ–°æ•´ç†æŒ‰éˆ• - è˜‹æœ iOS 16 æ¶²æ…‹ç»ç’ƒæ•ˆæœ */
            .refresh-button {
                width: 50px;
                height: 50px;
                bottom: 25px;
                right: 15px;
                font-size: 20px;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 
                    0 6px 24px rgba(0, 0, 0, 0.12),
                    0 2px 6px rgba(0, 0, 0, 0.06),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }

            .refresh-button:hover {
                background: rgba(255, 255, 255, 0.25);
                border-color: rgba(255, 255, 255, 0.4);
                box-shadow: 
                    0 8px 28px rgba(0, 0, 0, 0.15),
                    0 3px 8px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5);
            }

            .refresh-button.loading {
                background: rgba(0, 122, 255, 0.25);
                border-color: rgba(0, 122, 255, 0.4);
                box-shadow: 
                    0 6px 24px rgba(0, 122, 255, 0.25),
                    0 2px 6px rgba(0, 122, 255, 0.12),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }

            .attendance-menu {
                bottom: 20px;
                left: 10px;
            }

            .attendance-menu-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .attendance-menu-tooltip {
                left: 55px;
                font-size: 11px;
                padding: 5px 8px;
            }
        }

        /* è¶…å°å±å¹•éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 480px) {
            .container {
                padding: 6px;
            }

            .header {
                padding: 8px;
                margin-bottom: 8px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .header-logo {
                height: 30px;
            }

            .header-left {
                justify-content: center;
                text-align: center;
            }


            .control-group label {
                font-size: 0.8rem;
            }

            .control-group select,
            .control-group input {
                padding: 6px;
                font-size: 0.85rem;
            }

            .view-buttons {
                gap: 4px;
            }

            .btn-primary {
                padding: 6px 2px;
                font-size: 0.7rem;
                min-height: 32px;
            }

            
            .btn-primary.active {
                color: rgba(0, 0, 0, 0.9) !important; /* ç¢ºä¿é¸ä¸­æ™‚å­—é«”ç‚ºæ·±è‰² */
            }


            .events-container {
                gap: 6px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 10px;
                margin-bottom: 6px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-title {
                font-size: 0.9rem;
            }

            .event-instructor {
                padding: 3px 6px;
                font-size: 0.75rem;
            }

            .event-detail {
                font-size: 0.75rem;
            }

            .event-description {
                padding: 8px;
            }

            .event-description h4 {
                font-size: 0.85rem;
            }

            .event-description p {
                font-size: 0.75rem;
            }

            .lesson-button {
                padding: 5px 10px;
                font-size: 0.75rem;
            }


            .datetime-item {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .progress-step {
                font-size: 0.65rem;
                padding: 4px 6px;
            }

            .user-info-section {
                margin-top: 15px;
                padding: 12px;
            }

            .user-info-container h3 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
        }

        /* è¼‰å…¥å‹•ç•«æ¨£å¼ - æ¶²æ…‹ç»ç’ƒæ•ˆæœ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.95) 0%, 
                rgba(20, 20, 20, 0.95) 25%,
                rgba(255, 215, 0, 0.15) 50%,
                rgba(20, 20, 20, 0.95) 75%,
                rgba(0, 0, 0, 0.95) 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(1.1);
        }

        .loading-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 30px;
            padding: 40px 50px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.2),
                0 0 0 1px rgba(255, 215, 0, 0.1),
                0 0 30px rgba(255, 215, 0, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(1deg); }
            50% { transform: translateY(-5px) rotate(0deg); }
            75% { transform: translateY(-15px) rotate(-1deg); }
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 215, 0, 0.3),
                0 0 20px rgba(255, 215, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            animation: logoPulse 3s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 
                    0 15px 35px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 215, 0, 0.3),
                    0 0 20px rgba(255, 215, 0, 0.2);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 
                    0 20px 40px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 215, 0, 0.5),
                    0 0 40px rgba(255, 215, 0, 0.4),
                    0 0 60px rgba(255, 215, 0, 0.2);
            }
        }

        .loading-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent, 
                rgba(255, 215, 0, 0.2), 
                transparent);
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .loading-logo img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            position: relative;
            z-index: 1;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin-bottom: 20px;
            position: relative;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid transparent;
            border-top: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: rgba(255, 215, 0, 0.95);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .loading-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        .loading-progress {
            width: 250px;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 25px;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, 
                rgba(255, 215, 0, 0.9), 
                rgba(255, 193, 7, 0.8),
                rgba(255, 215, 0, 0.9));
            border-radius: 3px;
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .loading-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.8), 
                transparent);
            animation: progressShimmer 1.5s linear infinite;
        }

        @keyframes progressShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .loading-logs {
            max-height: 200px;
            overflow-y: auto;
            color: rgba(255, 255, 255, 0.85);
            font-size: 13px;
            text-align: center;
            width: 320px;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 215, 0, 0.1);
        }

        .loading-log-item {
            margin-bottom: 6px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            opacity: 0;
            animation: logFadeIn 0.5s ease-in forwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-log-item:last-child {
            border-bottom: none;
        }

        .loading-log-item.success {
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .loading-log-item.error {
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        .loading-log-item.warning {
            color: #ffd93d;
            text-shadow: 0 0 10px rgba(255, 217, 61, 0.3);
        }

        .loading-log-item.info {
            color: #45b7d1;
            text-shadow: 0 0 10px rgba(69, 183, 209, 0.3);
        }

        .loading-log-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
        }

        @keyframes logFadeIn {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        .loading-percentage {
            color: rgba(255, 215, 0, 0.9);
            font-size: 0.9rem;
            margin-top: 20px;
            margin-bottom: 20px;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .loading-signature {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 215, 0, 0.8);
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
            animation: signatureGlow 3s ease-in-out infinite;
        }

        @keyframes signatureGlow {
            0%, 100% { 
                opacity: 0.8;
                transform: scale(1);
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1.02);
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.6);
            }
        }

        /* éå ´å‹•ç•«æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.8s ease-out;
        }

        .bounce-in {
            animation: bounceIn 1s ease-out;
        }

        .scale-in {
            animation: scaleIn 0.5s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .float {
            animation: float 3s ease-in-out infinite;
        }

        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        /* å‹•ç•«é—œéµå¹€ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            0% { 
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            50% { 
                opacity: 0.8;
                transform: translateY(-5px) scale(1.02);
            }
            100% { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(255, 223, 102, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 223, 102, 0.8);
            }
        }

        @keyframes headerFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes titleGlow {
            0% { 
                text-shadow: 
                    0 2px 10px rgba(0, 0, 0, 0.3), 
                    0 0 30px rgba(255, 215, 0, 0.4),
                    0 0 60px rgba(255, 215, 0, 0.2);
            }
            100% { 
                text-shadow: 
                    0 2px 15px rgba(0, 0, 0, 0.4), 
                    0 0 40px rgba(255, 215, 0, 0.6),
                    0 0 80px rgba(255, 215, 0, 0.3);
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes controlsFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        @keyframes controlsShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes controlsRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes statsFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }

        @keyframes statsShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes statsRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes stepShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* çµ±è¨ˆæ•¸å­—å‹•ç•« */
        .stats-text span {
            display: inline-block;
            transition: all 0.3s ease;
        }

        .stats-text span.animate {
            animation: counterBounce 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes counterBounce {
            0% { 
                transform: scale(1); 
                color: rgba(51, 51, 51, 0.8); 
                text-shadow: none;
            }
            20% { 
                transform: scale(1.3); 
                color: #2196F3; 
                font-weight: bold; 
                text-shadow: 0 0 12px rgba(33, 150, 243, 0.6);
            }
            40% { 
                transform: scale(1.15); 
                color: #1976D2; 
                font-weight: bold; 
                text-shadow: 0 0 8px rgba(25, 118, 210, 0.4);
            }
            60% { 
                transform: scale(1.25); 
                color: #1565C0; 
                font-weight: bold; 
                text-shadow: 0 0 10px rgba(21, 101, 192, 0.5);
            }
            80% { 
                transform: scale(1.05); 
                color: #1976D2; 
                font-weight: bold; 
                text-shadow: 0 0 6px rgba(25, 118, 210, 0.3);
            }
            100% { 
                transform: scale(1); 
                color: rgba(51, 51, 51, 0.8); 
                text-shadow: none;
            }
        }

        /* é¦¬å¡é¾é…è‰²è®Šæ•¸ */
        :root {
            --esm-color: #ff6b9d;
            --spm-color: #2c3e50;
            --boost-color: #74b9ff;
            --spike-color: #fdcb6e;
            --ev3-color: #e17055;
            --minecraft-color: #00b894;
            
            /* å‹•ç•«æ€§èƒ½å„ªåŒ–è®Šæ•¸ */
            --animation-duration: 0.3s;
            --transition-duration: 0.2s;
            --animation-timing: cubic-bezier(0.4, 0, 0.2, 1);
            --reduced-motion: false;
        }
        
        /* å°Šé‡ç”¨æˆ¶çš„å‹•ç•«åå¥½è¨­ç½® */
        @media (prefers-reduced-motion: reduce) {
            :root {
                --animation-duration: 0.1s;
                --transition-duration: 0.1s;
                --reduced-motion: true;
            }
            
            * {
                animation-duration: 0.1s !important;
                transition-duration: 0.1s !important;
            }
        }

        /* æ•™æ¡ˆæŒ‰éˆ•é¡è‰² */
        .lesson-button.esm {
            background: linear-gradient(135deg, var(--esm-color) 0%, #ff8fab 100%);
        }

        .lesson-button.spm {
            background: linear-gradient(135deg, var(--spm-color) 0%, #34495e 100%);
        }

        .lesson-button.boost {
            background: linear-gradient(135deg, var(--boost-color) 0%, #a29bfe 100%);
        }

        .lesson-button.spike {
            background: linear-gradient(135deg, var(--spike-color) 0%, #fdcb6e 100%);
        }

        .lesson-button.ev3 {
            background: linear-gradient(135deg, var(--ev3-color) 0%, #fd79a8 100%);
        }

        .lesson-button.minecraft {
            background: linear-gradient(135deg, var(--minecraft-color) 0%, #55efc4 100%);
        }

        /* é•·æŒ‰ç°½åˆ°æ•ˆæœ */
        .event-card {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            position: relative;
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .event-card:hover .long-press-hint {
            opacity: 1 !important;
        }
        
        .event-card.pressing .long-press-hint {
            opacity: 1 !important;
            color: #ff6b6b !important;
            font-weight: bold !important;
            animation: pulse 1s infinite !important;
        }
        
        .event-card.charging .long-press-hint {
            opacity: 1 !important;
            color: #ffd93d !important;
            font-weight: bold !important;
            animation: pulse 0.5s infinite !important;
        }

        .event-card.pressing {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease-out;
        }

        .event-card.charging {
            animation: chargingBounce 2s ease-in-out infinite !important;
            box-shadow: 
                0 0 20px rgba(184, 134, 11, 0.4),
                0 0 40px rgba(184, 134, 11, 0.2),
                inset 0 0 20px rgba(184, 134, 11, 0.1) !important;
            border: 2px solid rgba(184, 134, 11, 0.6) !important;
            background: transparent !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            position: relative !important;
            z-index: 10 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .event-card.charging > * {
            position: relative !important;
            z-index: 15 !important;
        }

        /* é‡‹æ”¾å‹•ç•« - å®Œå…¨å„ªåŒ–ç‰ˆæœ¬ */
        .event-card.releasing {
            animation: releaseAnimation 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            position: relative !important;
            z-index: 10 !important;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 250, 252, 0.9) 50%,
                rgba(255, 255, 255, 0.95) 100%) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border-radius: 16px !important;
            padding: 20px !important;
            margin-bottom: 15px !important;
            border: 2px solid rgba(255, 215, 0, 0.3) !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            will-change: transform, opacity !important;
        }
        
        /* é‡‹æ”¾å‹•ç•«å®Œæˆå¾Œçš„éæ¸¡ç‹€æ…‹ */
        .event-card.releasing.completing {
            animation: none !important;
            transform: scale(1) translateY(0px) !important;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                0 0 0 1px rgba(255, 215, 0, 0.2) !important;
            border: 2px solid rgba(255, 215, 0, 0.3) !important;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 250, 252, 0.9) 50%,
                rgba(255, 255, 255, 0.95) 100%) !important;
            transition: none !important;
        }

        @keyframes releaseAnimation {
            0% {
                transform: scale(1.05) translateY(-2px);
                box-shadow: 
                    0 15px 35px rgba(0, 0, 0, 0.25), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.9),
                    0 0 0 3px rgba(255, 215, 0, 0.6);
            }
            30% {
                transform: scale(0.95) translateY(1px);
                box-shadow: 
                    0 8px 20px rgba(0, 0, 0, 0.18), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.8),
                    0 0 0 2px rgba(255, 215, 0, 0.4);
            }
            70% {
                transform: scale(1.01) translateY(-0.5px);
                box-shadow: 
                    0 9px 22px rgba(0, 0, 0, 0.16), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.85),
                    0 0 0 1px rgba(255, 215, 0, 0.25);
            }
            100% {
                transform: scale(1) translateY(0px);
                box-shadow: 
                    0 8px 25px rgba(0, 0, 0, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8),
                    0 0 0 1px rgba(255, 215, 0, 0.2);
            }
        }

        /* æ‰‹æ©Ÿç«¯å‹•ç•«å„ªåŒ– - æ¸›å°‘èƒ½è€— */
        @media (max-width: 768px) {
            /* æ¸›å°‘å‹•ç•«é »ç‡ï¼Œé™ä½CPUä½¿ç”¨ */
            .event-card.charging {
                animation: chargingBounceMobile 2s cubic-bezier(0.4, 0, 0.2, 1) infinite !important;
                box-shadow: 
                    0 0 25px rgba(184, 134, 11, 0.5),
                    0 0 50px rgba(184, 134, 11, 0.3),
                    inset 0 0 25px rgba(184, 134, 11, 0.15) !important;
                border: 3px solid rgba(184, 134, 11, 0.8) !important;
                background: transparent !important;
                opacity: 1 !important;
                visibility: visible !important;
                display: block !important;
                position: relative !important;
                z-index: 10 !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }

            .event-card.charging > * {
                position: relative !important;
                z-index: 15 !important;
            }

            .event-card.charging::before {
                animation: chargingSweepMobile 1s ease-in-out infinite !important;
            }

            .event-card.charging::after {
                width: 70px !important;
                height: 70px !important;
                margin: -35px 0 0 -35px !important;
                border-width: 6px !important;
                animation: chargingSpinMobile 1.5s linear infinite !important;
            }
            
            /* ç¦ç”¨ä¸å¿…è¦çš„å‹•ç•«ä»¥ç¯€çœé›»é‡ */
            .header::before,
            .controls::before,
            .stats::before {
                animation: none !important;
            }
            
            /* ç°¡åŒ–èƒŒæ™¯å‹•ç•« */
            body {
                animation: gradientShift 60s ease infinite !important;
            }
            
            .header {
                animation: headerFloat 20s ease-in-out infinite !important;
            }
            
            /* æ¸›å°‘è„ˆè¡å‹•ç•«é »ç‡ */
            .pulse {
                animation: pulse 3s infinite !important;
            }
            
            .glow {
                animation: glow 4s ease-in-out infinite alternate !important;
            }
        }
        
        /* ä½åŠŸè€—æ¨¡å¼ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* æ–°å¢éŸ¿æ‡‰å¼è¨­è¨ˆå„ªåŒ– */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .header {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .events-container {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 5px;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .events-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .event-card {
                padding: 15px;
                border-radius: 12px;
            }
            
            .event-card h3 {
                font-size: 1.1rem;
            }
            
            .event-card .event-time {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 8px;
                margin: 3px;
                border-radius: 12px;
            }
            
            .header {
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .events-container {
                gap: 10px;
            }
            
            .event-card {
                padding: 12px;
                border-radius: 10px;
            }
            
            .event-card h3 {
                font-size: 1rem;
            }
            
            .event-card .event-time {
                font-size: 0.8rem;
            }
        }

        /* å¹³æ¿ç«¯å„ªåŒ– */
        @media (min-width: 769px) and (max-width: 1024px) {
            .events-container {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 18px;
            }
            
            .event-card {
                padding: 18px;
            }
        }

        /* å¤§å±å¹•å„ªåŒ– */
        @media (min-width: 1200px) {
            .container {
                max-width: 1400px;
                padding: 25px;
            }
            
            .events-container {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 20px;
            }
            
            .event-card {
                padding: 20px;
            }
        }

        /* è¦–è¦ºåé¥‹å„ªåŒ– */
        .btn-animated {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-animated:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-animated:active {
            transform: translateY(0);
            animation: buttonClick 0.2s ease;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            animation: successPulse 0.6s ease;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #f57c00, #ef6c00);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .success-icon {
            color: #4CAF50;
            animation: successPulse 0.6s ease;
        }

        .error-icon {
            color: #f44336;
            animation: errorShake 0.5s ease;
        }

        .fade-in {
            animation: fadeInUp 0.5s ease-out;
        }

        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }

        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-error {
            background-color: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }

        .status-warning {
            background-color: #ff9800;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }

        .status-loading {
            background-color: #2196F3;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .event-card.charging::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(184, 134, 11, 0.1) 20%,
                rgba(255, 215, 0, 0.2) 40%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 215, 0, 0.2) 60%,
                rgba(184, 134, 11, 0.1) 80%,
                transparent 100%) !important;
            animation: chargingSweep 1.2s ease-in-out infinite !important;
            z-index: 1 !important;
            border-radius: inherit !important;
            box-shadow: inset 0 0 15px rgba(184, 134, 11, 0.1) !important;
            pointer-events: none !important;
        }

        .event-card.charging::after {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            width: 60px !important;
            height: 60px !important;
            margin: -30px 0 0 -30px !important;
            border: 5px solid rgba(184, 134, 11, 0.3) !important;
            border-top: 5px solid #b8860b !important;
            border-right: 5px solid #daa520 !important;
            border-bottom: 5px solid #ffd700 !important;
            border-radius: 50% !important;
            animation: chargingSpin 1s linear infinite !important;
            z-index: 2 !important;
            box-shadow: 
                0 0 30px rgba(184, 134, 11, 0.8),
                inset 0 0 10px rgba(255, 215, 0, 0.3) !important;
            pointer-events: none !important;
        }

        @keyframes chargingBounce {
            0% { 
                transform: scale(1.0);
                box-shadow: 0 0 10px rgba(184, 134, 11, 0.3);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(184, 134, 11, 0.6);
            }
            100% { 
                transform: scale(1.0);
                box-shadow: 0 0 10px rgba(184, 134, 11, 0.3);
            }
        }

        @keyframes chargingSweep {
            0% { 
                transform: translateX(-100%);
                opacity: 0.3;
            }
            50% {
                transform: translateX(0%);
                opacity: 0.8;
            }
            100% {
                transform: translateX(100%);
                opacity: 0.3;
            }
        }

        @keyframes chargingSpin {
            0% { 
                transform: rotate(0deg);
                opacity: 0.6;
            }
            50% {
                transform: rotate(180deg);
                opacity: 1;
            }
            100% { 
                transform: rotate(360deg);
                opacity: 0.6;
            }
        }

        @keyframes successPulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            }
            25% { 
                transform: scale(1.1);
                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.6);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 12px 35px rgba(40, 167, 69, 0.8);
            }
            75% { 
                transform: scale(1.08);
                box-shadow: 0 10px 30px rgba(40, 167, 69, 0.7);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            }
        }

        /* æ‰‹æ©Ÿç«¯å°ˆç”¨å‹•ç•« */
        @keyframes chargingBounceMobile {
            0% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(184, 134, 11, 0.3);
            }
            50% { 
                transform: scale(1.07);
                box-shadow: 0 0 25px rgba(184, 134, 11, 0.6);
            }
            100% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(184, 134, 11, 0.3);
            }
        }

        @keyframes chargingSweepMobile {
            0% { 
                transform: translateX(-100%);
                opacity: 0.3;
            }
            50% {
                transform: translateX(0%);
                opacity: 0.8;
            }
            100% { 
                transform: translateX(100%);
                opacity: 0.3;
            }
        }

        @keyframes chargingSpinMobile {
            0% { 
                transform: rotate(0deg);
                opacity: 0.7;
            }
            50% {
                transform: rotate(180deg);
                opacity: 1;
            }
            100% { 
                transform: rotate(360deg);
                opacity: 0.7;
            }
        }

        /* è¬›å¸«åº•è‰² */
        .event-instructor.custom-color {
            background: var(--instructor-color) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥å‹•ç•« -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-logo">
                <img src="logo.jpg" alt="FLB Logo" />
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-text">ğŸš€ è¼‰å…¥ä¸­...</div>
            <div class="loading-subtitle">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±ï¼Œè«‹ç¨å€™</div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
                <div class="loading-percentage" id="loadingPercentage">0%</div>
            <div class="loading-logs" id="loadingLogs">
                <div class="loading-log-item info">
                    <span class="loading-log-icon">â„¹ï¸</span>
                    <span>ç³»çµ±åˆå§‹åŒ–ä¸­...</span>
            </div>
        </div>
        </div>
        <div class="loading-signature">Timæ„Ÿæ©æˆ´å¾·ğŸ™ğŸ»</div>
    </div>

    <!-- æ‡¸æµ®å›ºå®šé¸å–® -->
    <div class="floating-stats-menu" id="floatingStatsMenu" data-lazy-load="floating-menu">
        <div class="floating-stats-content">
            <div class="floating-filter-buttons">
                <button class="floating-filter-btn" data-filter="today">ä»Šæ—¥</button>
                <button class="floating-filter-btn" data-filter="week">æœ¬é€±</button>
                <button class="floating-filter-btn" data-filter="month">æœ¬æœˆ</button>
                <button class="floating-filter-btn" data-filter="all">å…¨éƒ¨</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- é ‚éƒ¨æ¨™é¡Œå€åŸŸ -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <img src="logo.jpg" alt="FLB Logo" class="header-logo">
                    <div>
                        <h1>FLBè¬›å¸«è¡Œäº‹æ›†æª¢è¦–ç³»çµ±</h1>
                        <p class="header-subtitle">å³æ™‚æŸ¥çœ‹æ‰€æœ‰è¬›å¸«çš„è¡Œç¨‹å®‰æ’</p>
                        <p class="header-tim-note">Timæ„Ÿæ©æˆ´å¾·ğŸ™ğŸ»</p>
                    </div>
                </div>
        </div>

            <!-- æ—¥æœŸæ™‚é–“é¡¯ç¤º -->
            <div class="datetime-display">
                <div class="datetime-item">
                    <i class="fas fa-calendar"></i>
                    <span id="currentDate">2025å¹´01æœˆ16æ—¥ æ˜ŸæœŸå››</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime">13:58:43</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-calendar-week"></i>
                    <span id="currentWeek">2025å¹´ç¬¬3é€±</span>
                </div>
            </div>
            
            <!-- é€²åº¦æŒ‡ç¤ºå™¨ -->
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-circle">1</div>
                    <div class="step-label">é¸æ“‡è¬›å¸«</div>
                </div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">æŸ¥çœ‹è¡Œäº‹æ›†</div>
                </div>
                <div class="step pending">
                    <div class="step-circle">3</div>
                    <div class="step-label">ç®¡ç†è¡Œç¨‹</div>
                </div>
            </div>
        </div>

        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <div class="main-content">
            <div class="content-header">
                <i class="fas fa-calendar-alt"></i>
                <h2>è¬›å¸«è¡Œäº‹æ›†æª¢è¦–</h2>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="instructorSelect">é¸æ“‡è¬›å¸«</label>
                    <select id="instructorSelect">
                        <option value="">å…¨éƒ¨è¬›å¸«</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="timeFilter">æ™‚æ®µç¯©é¸</label>
                        <select id="timeFilter">
                            <option value="">å…¨éƒ¨æ™‚æ®µ</option>
                            <option value="morning">æ—©ä¸Š (06:00-12:00)</option>
                            <option value="afternoon">ä¸‹åˆ (12:00-18:00)</option>
                            <option value="evening">æ™šä¸Š (18:00-24:00)</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="dateFilter">æŒ‡å®šæ—¥æœŸ</label>
                        <input type="date" id="dateFilter" />
                    </div>
                    <div class="control-group">
                        <div class="view-buttons">
                            <button class="btn btn-primary active" data-view="today">ä»Šæ—¥</button>
                            <button class="btn btn-primary" data-view="week">æœ¬é€±</button>
                            <button class="btn btn-primary" data-view="month">æœ¬æœˆ</button>
                            <button class="btn btn-primary" data-view="all">å…¨éƒ¨</button>
                </div>
            </div>
        </div>

                    <!-- çµ±è¨ˆä¿¡æ¯æ–‡å­—é¡¯ç¤º -->
                    <div class="stats-text" id="statsText" style="text-align: center; margin-top: 8px; padding: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; font-size: 0.75rem; color: rgba(51, 51, 51, 0.8); max-width: 100%;">
                        <div class="stats-row" style="margin-bottom: 4px;">
                            <span id="totalEventsText">ç¸½èª²ç¨‹: 0</span> | 
                            <span id="instructorCountText">è¬›å¸«: 0</span>
                </div>
                        <div class="stats-row">
                            <span id="dateRangeText">æ—¥æœŸ: -</span>
                </div>
                </div>
                    

            </div>
        </div>


            <!-- èª²ç¨‹åˆ—è¡¨ -->
        <div class="events-container" id="eventsContainer">
            <div class="no-events">
                <i class="fas fa-calendar-times"></i>
                <h3>è¼‰å…¥ä¸­...</h3>
                <p>æ­£åœ¨ç²å–è¡Œäº‹æ›†è³‡æ–™</p>
                </div>
            </div>

            <!-- ç”¨æˆ¶è³‡è¨Šå€åŸŸ -->
            <div class="user-info-section" id="userInfoGroup" style="display: block;">
                <div class="user-info-container">
                    <h3>LINE ç”¨æˆ¶è³‡è¨Š</h3>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="userDisplayName">æœªç¶å®š</div>
                            <div class="user-id" id="userDisplayId" style="display: none;"></div>
                        </div>
                        <button class="btn btn-secondary" id="bindUserBtn">ç¶å®šå¸³è™Ÿ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­ç½®ç•«é¢ -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <h2><i class="fas fa-palette"></i> é¡è‰²è¨­ç½®</h2>
                <button class="close-settings" id="closeSettingsBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="settings-section">
                <h3>æ•™æ¡ˆé¡å‹é¡è‰²</h3>
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label>ESM</label>
                        <input type="color" class="color-picker" id="esmColor" value="#ff6b9d">
                    </div>
                    <div class="color-picker-item">
                        <label>SPM</label>
                        <input type="color" class="color-picker" id="spmColor" value="#2c3e50">
                    </div>
                    <div class="color-picker-item">
                        <label>BOOST</label>
                        <input type="color" class="color-picker" id="boostColor" value="#74b9ff">
                    </div>
                    <div class="color-picker-item">
                        <label>SPIKE</label>
                        <input type="color" class="color-picker" id="spikeColor" value="#fdcb6e">
                    </div>
                    <div class="color-picker-item">
                        <label>EV3</label>
                        <input type="color" class="color-picker" id="ev3Color" value="#e17055">
                    </div>
                    <div class="color-picker-item">
                        <label>MINECRAFT</label>
                        <input type="color" class="color-picker" id="minecraftColor" value="#00b894">
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>è¬›å¸«åº•è‰²è¨­ç½®</h3>
                <div class="color-picker-group" id="instructorColorGroup">
                    <!-- è¬›å¸«é¡è‰²è¨­ç½®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <button class="save-settings" id="saveSettingsBtn">
                <i class="fas fa-save"></i> å„²å­˜è¨­ç½®
            </button>
        </div>
    </div>

     <!-- é‡æ–°æ•´ç†æµ®å‹•æŒ‰éˆ• -->
     <div id="refreshButton" class="refresh-button" title="é‡æ–°æ•´ç†è¡Œäº‹æ›†">
         <i class="fas fa-sync-alt"></i>
     </div>

     <!-- ç°½åˆ°ç³»çµ±æ‡¸æµ®é¸å–® -->
     <div id="attendanceMenu" class="attendance-menu" title="ç°½åˆ°ç³»çµ±">
         <div class="attendance-menu-button">
             <i class="fas fa-calendar-check"></i>
         </div>
         <div class="attendance-menu-tooltip">
             <span>ç°½åˆ°ç³»çµ±</span>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let allEvents = [];
        let allInstructors = [];
        let currentView = 'ä»Šæ—¥'; // çµ±ä¸€ä½¿ç”¨ä¸­æ–‡
        let currentUser = null;
        let colorSettings = {
            esm: 'rgba(255, 182, 193, 0.8)',
            spm: 'rgba(116, 185, 255, 0.8)',
            boost: 'rgba(116, 185, 255, 0.8)',
            spike: 'rgba(255, 223, 102, 0.8)',
            ev3: 'rgba(180, 167, 214, 0.8)',
            minecraft: 'rgba(0, 184, 148, 0.8)'
        };
        let instructorColors = {};

        // å„ªåŒ–çš„åˆ†éšæ®µåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆ†éšæ®µåˆå§‹åŒ–...');
            
            // ç¬¬ä¸€éšæ®µï¼šç«‹å³åŸ·è¡Œçš„é—œéµä»»å‹™
            showLoadingAnimation();
            setupEventListeners();
            
            // ç¬¬äºŒéšæ®µï¼šå»¶é²åŸ·è¡Œçš„éé—œéµä»»å‹™
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => {
                    initializeFloatingMenu();
                    PerformanceOptimizer.preloadCriticalResources();
                    PerformanceOptimizer.lazyLoadNonCriticalFeatures();
                    
                    // CALDAVé è¼‰å…¥
                    if (window.apiOptimizer) {
                        apiOptimizer.preloadCaldavData().catch(error => {
                            console.log('âš ï¸ CALDAVé è¼‰å…¥å¤±æ•—:', error.message);
                        });
                    }
                });
            } else {
                // é™ç´šè™•ç†
                setTimeout(() => {
                    initializeFloatingMenu();
                    PerformanceOptimizer.preloadCriticalResources();
                    PerformanceOptimizer.lazyLoadNonCriticalFeatures();
                    
                    // CALDAVé è¼‰å…¥
                    if (window.apiOptimizer) {
                        apiOptimizer.preloadCaldavData().catch(error => {
                            console.log('âš ï¸ CALDAVé è¼‰å…¥å¤±æ•—:', error.message);
                        });
                    }
                }, 100);
            }
            
            // ç¬¬ä¸‰éšæ®µï¼šç•°æ­¥åˆå§‹åŒ–ç³»çµ±
            initializeSystemOptimized();
        });
        
        // æ™ºèƒ½ç¯©é¸ï¼šè‡ªå‹•é¸æ“‡æœ‰è¡Œäº‹æ›†çš„æ¨¡å¼
        function smartViewSelection() {
            console.log('ğŸ§  é–‹å§‹æ™ºèƒ½ç¯©é¸è¦–åœ–æ¨¡å¼...');
            
            if (!allEvents || allEvents.length === 0) {
                console.log('âš ï¸ æ²’æœ‰äº‹ä»¶è³‡æ–™ï¼Œä¿æŒä»Šæ—¥è¦–åœ–');
                return 'ä»Šæ—¥';
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦æœ‰èª²ç¨‹
            const todayEvents = allEvents.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                return eventDay.getTime() === today.getTime();
            });
            
            if (todayEvents.length > 0) {
                console.log(`âœ… ä»Šæ—¥æœ‰ ${todayEvents.length} å€‹èª²ç¨‹ï¼Œé¸æ“‡ä»Šæ—¥è¦–åœ–`);
                return 'ä»Šæ—¥';
            }
            
            // æª¢æŸ¥æœ¬é€±æ˜¯å¦æœ‰èª²ç¨‹
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const weekEvents = allEvents.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                return eventDate >= weekStart && eventDate <= weekEnd;
            });
            
            if (weekEvents.length > 0) {
                console.log(`âœ… æœ¬é€±æœ‰ ${weekEvents.length} å€‹èª²ç¨‹ï¼Œé¸æ“‡æœ¬é€±è¦–åœ–`);
                return 'æœ¬é€±';
            }
            
            // æª¢æŸ¥æœ¬æœˆæ˜¯å¦æœ‰èª²ç¨‹
            const monthEvents = allEvents.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                return eventDate.getFullYear() === now.getFullYear() &&
                       eventDate.getMonth() === now.getMonth();
            });
            
            if (monthEvents.length > 0) {
                console.log(`âœ… æœ¬æœˆæœ‰ ${monthEvents.length} å€‹èª²ç¨‹ï¼Œé¸æ“‡æœ¬æœˆè¦–åœ–`);
                return 'æœ¬æœˆ';
            }
            
            // å¦‚æœéƒ½æ²’æœ‰ï¼Œé¸æ“‡å…¨éƒ¨è¦–åœ–
            console.log(`âœ… åªæœ‰å…¶ä»–æ™‚é–“çš„ ${allEvents.length} å€‹èª²ç¨‹ï¼Œé¸æ“‡å…¨éƒ¨è¦–åœ–`);
            return 'å…¨éƒ¨';
        }

        // è¬›å¸«æ™ºèƒ½ç¯©é¸ï¼šé‡å°ç‰¹å®šè¬›å¸«çš„èª²ç¨‹é€²è¡Œæ™ºèƒ½è¦–åœ–é¸æ“‡
        function smartInstructorViewSelection(instructorEvents) {
            console.log('ğŸ§  é–‹å§‹è¬›å¸«æ™ºèƒ½ç¯©é¸è¦–åœ–æ¨¡å¼...');
            
            if (!instructorEvents || instructorEvents.length === 0) {
                console.log('âš ï¸ è©²è¬›å¸«æ²’æœ‰èª²ç¨‹ï¼Œä½¿ç”¨å…¨å±€æ™ºèƒ½ç¯©é¸');
                return advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«').view;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // æª¢æŸ¥è¬›å¸«ä»Šæ—¥æ˜¯å¦æœ‰èª²ç¨‹
            const todayEvents = instructorEvents.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                return eventDay.getTime() === today.getTime();
            });
            
            if (todayEvents.length > 0) {
                console.log(`âœ… è¬›å¸«ä»Šæ—¥æœ‰ ${todayEvents.length} å€‹èª²ç¨‹ï¼Œé¸æ“‡ä»Šæ—¥è¦–åœ–`);
                return 'ä»Šæ—¥';
            }
            
            // æª¢æŸ¥è¬›å¸«æœ¬é€±æ˜¯å¦æœ‰èª²ç¨‹
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const weekEvents = instructorEvents.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                return eventDate >= weekStart && eventDate <= weekEnd;
            });
            
            if (weekEvents.length > 0) {
                console.log(`âœ… è¬›å¸«æœ¬é€±æœ‰ ${weekEvents.length} å€‹èª²ç¨‹ï¼Œé¸æ“‡æœ¬é€±è¦–åœ–`);
                return 'æœ¬é€±';
            }
            
            // æª¢æŸ¥è¬›å¸«æœ¬æœˆæ˜¯å¦æœ‰èª²ç¨‹
            const monthEvents = instructorEvents.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                return eventDate.getFullYear() === now.getFullYear() &&
                       eventDate.getMonth() === now.getMonth();
            });
            
            if (monthEvents.length > 0) {
                console.log(`âœ… è¬›å¸«æœ¬æœˆæœ‰ ${monthEvents.length} å€‹èª²ç¨‹ï¼Œé¸æ“‡æœ¬æœˆè¦–åœ–`);
                return 'æœ¬æœˆ';
            }
            
            // å¦‚æœéƒ½æ²’æœ‰ï¼Œé¸æ“‡å…¨éƒ¨è¦–åœ–
            console.log(`âœ… è¬›å¸«åªæœ‰å…¶ä»–æ™‚é–“çš„ ${instructorEvents.length} å€‹èª²ç¨‹ï¼Œé¸æ“‡å…¨éƒ¨è¦–åœ–`);
            return 'å…¨éƒ¨';
        }

        // é¡¯ç¤ºæ™ºèƒ½ç¯©é¸é€šçŸ¥
        function showSmartFilterNotification(instructor, view, courseCount) {
            const viewNames = {
                'ä»Šæ—¥': 'ä»Šæ—¥',
                'æœ¬é€±': 'æœ¬é€±', 
                'æœ¬æœˆ': 'æœ¬æœˆ',
                'å…¨éƒ¨': 'å…¨éƒ¨'
            };
            
            const viewName = viewNames[view] || view;
            const message = `ğŸ§  æ™ºèƒ½ç¯©é¸ï¼š${instructor} åœ¨ ${viewName} æœ‰ ${courseCount} å€‹èª²ç¨‹`;
            
            // é¡¯ç¤ºçŸ­æš«çš„é€šçŸ¥
            showToast(message, 'info', 3000);
            
            // åœ¨æ§åˆ¶å°é¡¯ç¤ºè©³ç´°ä¿¡æ¯
            console.log(`ğŸ“Š æ™ºèƒ½ç¯©é¸çµ±è¨ˆ:`, {
                instructor: instructor,
                view: viewName,
                courseCount: courseCount,
                timestamp: new Date().toLocaleString()
            });
        }

        // é¡¯ç¤ºé€²éšæ™ºèƒ½ç¯©é¸é€šçŸ¥
        function showAdvancedSmartFilterNotification(result) {
            const { view, reason, stats, instructor } = result;
            
            const viewNames = {
                'ä»Šæ—¥': 'ä»Šæ—¥',
                'æœ¬é€±': 'æœ¬é€±', 
                'æœ¬æœˆ': 'æœ¬æœˆ',
                'å…¨éƒ¨': 'å…¨éƒ¨'
            };
            
            const viewName = viewNames[view] || view;
            
            // å‰µå»ºè©³ç´°çš„çµ±è¨ˆä¿¡æ¯
            const statsText = `ä»Šæ—¥:${stats.today} æœ¬é€±:${stats.week} æœ¬æœˆ:${stats.month} ç¸½è¨ˆ:${stats.total}`;
            const message = `ğŸ§  æ™ºèƒ½ç¯©é¸ï¼š${instructor} â†’ ${viewName} (${reason})`;
            
            // é¡¯ç¤ºè©³ç´°çš„é€šçŸ¥
            showToast(message, 'info', 4000);
            
            // åœ¨æ§åˆ¶å°é¡¯ç¤ºè©³ç´°ä¿¡æ¯
            console.log(`ğŸ“Š é€²éšæ™ºèƒ½ç¯©é¸çµ±è¨ˆ:`, {
                instructor: instructor,
                selectedView: viewName,
                reason: reason,
                stats: statsText,
                timestamp: new Date().toLocaleString()
            });
            
            // é¡¯ç¤ºèª²ç¨‹åˆ†å¸ƒåœ–è¡¨ï¼ˆåœ¨æ§åˆ¶å°ï¼‰
            console.log(`ğŸ“ˆ èª²ç¨‹åˆ†å¸ƒåœ–è¡¨:`, {
                'ä»Šæ—¥': 'â–ˆ'.repeat(Math.min(stats.today, 10)) + ` (${stats.today})`,
                'æœ¬é€±': 'â–ˆ'.repeat(Math.min(stats.week, 10)) + ` (${stats.week})`,
                'æœ¬æœˆ': 'â–ˆ'.repeat(Math.min(stats.month, 10)) + ` (${stats.month})`,
                'ç¸½è¨ˆ': 'â–ˆ'.repeat(Math.min(stats.total, 10)) + ` (${stats.total})`
            });
        }

        // æ‰‹å‹•è§¸ç™¼æ™ºèƒ½ç¯©é¸
        function triggerSmartFilter() {
            console.log('ğŸ”„ æ‰‹å‹•è§¸ç™¼æ™ºèƒ½ç¯©é¸...');
            
            const instructorSelect = document.getElementById('instructorSelect');
            const selectedInstructor = instructorSelect ? instructorSelect.value : null;
            
            if (selectedInstructor) {
                // é‡å°ç‰¹å®šè¬›å¸«é€²è¡Œæ™ºèƒ½ç¯©é¸
                const instructorEvents = allEvents.filter(event => 
                    event && event.instructor === selectedInstructor
                );
                
                const smartResult = advancedSmartViewSelection(instructorEvents, selectedInstructor);
                currentView = smartResult.view;
                window.currentView = smartResult.view;
                
                console.log(`ğŸ§  æ‰‹å‹•æ™ºèƒ½ç¯©é¸çµæœ: ${smartResult.view} (${smartResult.reason})`);
                showAdvancedSmartFilterNotification(smartResult);
                
            } else {
                // å…¨å±€æ™ºèƒ½ç¯©é¸
                const smartResult = advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«');
                currentView = smartResult.view;
                window.currentView = smartResult.view;
                
                console.log(`ğŸ§  æ‰‹å‹•å…¨å±€æ™ºèƒ½ç¯©é¸çµæœ: ${smartResult.view} (${smartResult.reason})`);
                showAdvancedSmartFilterNotification(smartResult);
            }
            
            // æ›´æ–°UI
            updateViewButtonStates();
            updateTimeFilterOptions();
            updateStats();
            renderEvents();
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            showToast('ğŸ§  æ™ºèƒ½ç¯©é¸å·²é‡æ–°åŸ·è¡Œ', 'success', 2000);
        }

        // æ™ºèƒ½ç¯©é¸èª¿è©¦å‡½æ•¸
        function debugSmartFilter() {
            console.log('ğŸ” æ™ºèƒ½ç¯©é¸èª¿è©¦ä¿¡æ¯:');
            console.log('ğŸ“Š å…¨éƒ¨äº‹ä»¶æ•¸é‡:', allEvents.length);
            console.log('ğŸ‘¨â€ğŸ« ç•¶å‰é¸æ“‡è¬›å¸«:', document.getElementById('instructorSelect')?.value || 'æœªé¸æ“‡');
            console.log('ğŸ“… ç•¶å‰è¦–åœ–:', currentView);
            
            // æª¢æŸ¥äº‹ä»¶è³‡æ–™æ ¼å¼
            if (allEvents.length > 0) {
                const sampleEvent = allEvents[0];
                console.log('ğŸ“‹ äº‹ä»¶è³‡æ–™ç¯„ä¾‹:', {
                    title: sampleEvent.title,
                    start: sampleEvent.start,
                    instructor: sampleEvent.instructor,
                    hasStart: !!sampleEvent.start
                });
            }
            
            // æ¸¬è©¦æ™ºèƒ½ç¯©é¸
            const testResult = advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«');
            console.log('ğŸ§  æ¸¬è©¦æ™ºèƒ½ç¯©é¸çµæœ:', testResult);
            
            return testResult;
        }
        
        // å¼·åˆ¶é‡æ–°åŸ·è¡Œæ™ºèƒ½ç¯©é¸
        function forceSmartFilter() {
            console.log('ğŸ”„ å¼·åˆ¶é‡æ–°åŸ·è¡Œæ™ºèƒ½ç¯©é¸...');
            
            const instructorSelect = document.getElementById('instructorSelect');
            if (instructorSelect) {
                // è§¸ç™¼è¬›å¸«é¸æ“‡è®Šæ›´äº‹ä»¶
                const changeEvent = new Event('change', { bubbles: true });
                instructorSelect.dispatchEvent(changeEvent);
            } else {
                // å¦‚æœæ²’æœ‰è¬›å¸«é¸æ“‡å™¨ï¼Œç›´æ¥åŸ·è¡Œå…¨å±€æ™ºèƒ½ç¯©é¸
                const smartResult = advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«');
                currentView = smartResult.view;
                window.currentView = smartResult.view;
                
                updateViewButtonStates();
                updateTimeFilterOptions();
                updateStats();
                renderEvents();
                
                console.log('ğŸ§  å¼·åˆ¶æ™ºèƒ½ç¯©é¸çµæœ:', smartResult);
                showAdvancedSmartFilterNotification(smartResult);
            }
        }
        
        // é‡å°ç‰¹å®šè¬›å¸«çš„æ™ºæ…§ç¯©é¸
        function smartFilterForInstructor(instructorName) {
            console.log(`ğŸ§  åŸ·è¡Œè¬›å¸« "${instructorName}" çš„æ™ºæ…§ç¯©é¸...`);
            
            if (!instructorName) {
                console.log('âš ï¸ æ²’æœ‰æŒ‡å®šè¬›å¸«åç¨±');
                return;
            }
            
            // éæ¿¾å‡ºè©²è¬›å¸«çš„äº‹ä»¶
            const instructorEvents = allEvents.filter(event => 
                event && event.instructor === instructorName
            );
            
            console.log(`ğŸ” è¬›å¸« "${instructorName}" çš„èª²ç¨‹æ•¸é‡:`, instructorEvents.length);
            
            if (instructorEvents.length === 0) {
                console.log('âš ï¸ è©²è¬›å¸«æ²’æœ‰èª²ç¨‹ï¼Œä½¿ç”¨å…¨å±€æ™ºæ…§ç¯©é¸');
                const smartResult = advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«');
                currentView = smartResult.view;
                window.currentView = smartResult.view;
                
                updateViewButtonStates();
                updateTimeFilterOptions();
                updateStats();
                renderEvents();
                
                showAdvancedSmartFilterNotification(smartResult);
                return;
            }
            
            // åŸ·è¡Œé‡å°è©²è¬›å¸«çš„æ™ºæ…§ç¯©é¸
            const smartResult = advancedSmartViewSelection(instructorEvents, instructorName);
            currentView = smartResult.view;
            window.currentView = smartResult.view;
            
            console.log(`ğŸ§  è¬›å¸« "${instructorName}" æ™ºæ…§ç¯©é¸çµæœ: ${smartResult.view} (${smartResult.reason})`);
            
            // æ›´æ–°UI
            updateViewButtonStates();
            updateTimeFilterOptions();
            updateStats();
            renderEvents();
            autoScrollToViewButtons();
            
            // é¡¯ç¤ºè©³ç´°çš„æ™ºèƒ½ç¯©é¸æç¤º
            showAdvancedSmartFilterNotification(smartResult);
        }
        
        // æª¢æŸ¥æ™ºæ…§ç¯©é¸åŸ·è¡Œç‹€æ³
        function checkSmartFilterStatus() {
            console.log('ğŸ” æª¢æŸ¥æ™ºæ…§ç¯©é¸åŸ·è¡Œç‹€æ³:');
            console.log('ğŸ“Š å…¨éƒ¨äº‹ä»¶æ•¸é‡:', allEvents.length);
            console.log('ğŸ‘¨â€ğŸ« ç•¶å‰é¸æ“‡è¬›å¸«:', document.getElementById('instructorSelect')?.value || 'æœªé¸æ“‡');
            console.log('ğŸ“… ç•¶å‰è¦–åœ–:', currentView);
            console.log('ğŸ¯ è¦–åœ–æŒ‰éˆ•ç‹€æ…‹:', {
                today: document.querySelector('[data-view="today"]')?.classList.contains('active'),
                week: document.querySelector('[data-view="week"]')?.classList.contains('active'),
                month: document.querySelector('[data-view="month"]')?.classList.contains('active'),
                all: document.querySelector('[data-view="all"]')?.classList.contains('active')
            });
            
            // æª¢æŸ¥è¬›å¸«äº‹ä»¶
            const instructorSelect = document.getElementById('instructorSelect');
            if (instructorSelect && instructorSelect.value) {
                const instructorEvents = allEvents.filter(event => 
                    event && event.instructor === instructorSelect.value
                );
                console.log(`ğŸ” è¬›å¸« "${instructorSelect.value}" çš„èª²ç¨‹æ•¸é‡:`, instructorEvents.length);
                
                if (instructorEvents.length > 0) {
                    console.log('ğŸ“‹ è¬›å¸«èª²ç¨‹ç¯„ä¾‹:', instructorEvents[0]);
                }
            }
        }
        
        // å¼·åˆ¶é‡æ–°æª¢æŸ¥è¬›å¸«é¸æ“‡ä¸¦åŸ·è¡Œæ™ºæ…§ç¯©é¸
        function forceInstructorSmartFilter() {
            console.log('ğŸ”„ å¼·åˆ¶é‡æ–°æª¢æŸ¥è¬›å¸«é¸æ“‡ä¸¦åŸ·è¡Œæ™ºæ…§ç¯©é¸...');
            const instructorSelect = document.getElementById('instructorSelect');
            
            if (!instructorSelect) {
                console.log('âŒ æ‰¾ä¸åˆ°è¬›å¸«é¸æ“‡å™¨');
                return;
            }
            
            console.log('ğŸ” è¬›å¸«é¸æ“‡å™¨ç‹€æ…‹:', {
                value: instructorSelect.value,
                selectedIndex: instructorSelect.selectedIndex,
                options: instructorSelect.options ? Array.from(instructorSelect.options).map(opt => ({ value: opt.value, text: opt.text })) : 'options ä¸å¯ç”¨'
            });
            
            if (instructorSelect.value && instructorSelect.value !== '') {
                console.log('ğŸ¯ åŸ·è¡Œè¬›å¸«æ™ºæ…§ç¯©é¸:', instructorSelect.value);
                const instructorEvents = allEvents.filter(event => 
                    event && event.instructor === instructorSelect.value
                );
                
                console.log(`ğŸ” è¬›å¸« "${instructorSelect.value}" çš„èª²ç¨‹æ•¸é‡:`, instructorEvents.length);
                
                const smartResult = advancedSmartViewSelection(instructorEvents, instructorSelect.value);
                currentView = smartResult.view;
                window.currentView = smartResult.view;
                
                console.log(`ğŸ§  å¼·åˆ¶è¬›å¸«æ™ºæ…§ç¯©é¸çµæœ: ${smartResult.view} (${smartResult.reason})`);
                
                updateViewButtonStates();
                updateTimeFilterOptions();
                updateStats();
                renderEvents();
                autoScrollToViewButtons();
                
                showAdvancedSmartFilterNotification(smartResult);
            } else {
                console.log('âš ï¸ æ²’æœ‰é¸ä¸­è¬›å¸«ï¼ŒåŸ·è¡Œå…¨å±€æ™ºæ…§ç¯©é¸');
                const smartResult = advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«');
                currentView = smartResult.view;
                window.currentView = smartResult.view;
                
                updateViewButtonStates();
                updateTimeFilterOptions();
                updateStats();
                renderEvents();
                autoScrollToViewButtons();
                
                showAdvancedSmartFilterNotification(smartResult);
            }
        }
        
        // å°‡æ™ºèƒ½ç¯©é¸å‡½æ•¸æš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿èª¿è©¦
        window.triggerSmartFilter = triggerSmartFilter;
        window.advancedSmartViewSelection = advancedSmartViewSelection;
        window.debugSmartFilter = debugSmartFilter;
        window.forceSmartFilter = forceSmartFilter;
        window.smartFilterForInstructor = smartFilterForInstructor;
        window.checkSmartFilterStatus = checkSmartFilterStatus;
        window.forceInstructorSmartFilter = forceInstructorSmartFilter;

        // é€²éšæ™ºèƒ½ç¯©é¸ï¼šæ ¹æ“šèª²ç¨‹åˆ†å¸ƒé¸æ“‡æœ€ä½³è¦–åœ–
        function advancedSmartViewSelection(events, instructor = null) {
            console.log('ğŸš€ é–‹å§‹é€²éšæ™ºèƒ½ç¯©é¸...');
            
            if (!events || events.length === 0) {
                console.log('âš ï¸ æ²’æœ‰äº‹ä»¶è³‡æ–™');
                return { view: 'ä»Šæ—¥', reason: 'ç„¡èª²ç¨‹è³‡æ–™' };
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // è¨ˆç®—å„æ™‚é–“ç¯„åœçš„èª²ç¨‹æ•¸é‡
            const stats = {
                today: 0,
                week: 0,
                month: 0,
                total: events.length
            };
            
            // ä»Šæ—¥èª²ç¨‹
            const todayEvents = events.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                return eventDay.getTime() === today.getTime();
            });
            stats.today = todayEvents.length;
            
            // æœ¬é€±èª²ç¨‹ - ä¿®æ­£é€±ä¸€ç‚ºç¬¬ä¸€å¤©
            const weekStart = new Date(today);
            const dayOfWeek = today.getDay();
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // é€±æ—¥ç‚º-6ï¼Œå…¶ä»–ç‚º1-dayOfWeek
            weekStart.setDate(today.getDate() + daysToMonday);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const weekEvents = events.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                return eventDate >= weekStart && eventDate <= weekEnd;
            });
            stats.week = weekEvents.length;
            
            // æœ¬æœˆèª²ç¨‹
            const monthEvents = events.filter(event => {
                if (!event || !event.start) return false;
                const eventDate = new Date(event.start);
                return eventDate.getFullYear() === now.getFullYear() &&
                       eventDate.getMonth() === now.getMonth();
            });
            stats.month = monthEvents.length;
            
            console.log('ğŸ“Š èª²ç¨‹åˆ†å¸ƒçµ±è¨ˆ:', stats);
            console.log('ğŸ“… æ™‚é–“ç¯„åœ:', {
                today: today.toLocaleDateString('zh-TW'),
                weekStart: weekStart.toLocaleDateString('zh-TW'),
                weekEnd: weekEnd.toLocaleDateString('zh-TW'),
                month: `${now.getFullYear()}-${now.getMonth() + 1}`
            });
            
            // æ™ºèƒ½é¸æ“‡é‚è¼¯ - å„ªåŒ–ç‰ˆæœ¬
            let selectedView = 'ä»Šæ—¥';
            let reason = '';
            
            // å„ªå…ˆç´šï¼šä»Šæ—¥ > æœ¬é€± > æœ¬æœˆ > å…¨éƒ¨
            if (stats.today > 0) {
                selectedView = 'ä»Šæ—¥';
                reason = `ä»Šæ—¥æœ‰ ${stats.today} å€‹èª²ç¨‹`;
            } else if (stats.week > 0) {
                selectedView = 'æœ¬é€±';
                reason = `æœ¬é€±æœ‰ ${stats.week} å€‹èª²ç¨‹`;
            } else if (stats.month > 0) {
                selectedView = 'æœ¬æœˆ';
                reason = `æœ¬æœˆæœ‰ ${stats.month} å€‹èª²ç¨‹`;
            } else if (stats.total > 0) {
                selectedView = 'å…¨éƒ¨';
                reason = `ç¸½å…±æœ‰ ${stats.total} å€‹èª²ç¨‹`;
            } else {
                selectedView = 'ä»Šæ—¥';
                reason = 'ç„¡èª²ç¨‹è³‡æ–™';
            }
            
            // ç‰¹æ®Šæƒ…æ³è™•ç†
            if (stats.today === 0 && stats.week === 0 && stats.month === 0) {
                reason = 'æ‰€æœ‰èª²ç¨‹éƒ½åœ¨å…¶ä»–æ™‚é–“';
            }
            
            console.log(`ğŸ¯ é€²éšæ™ºèƒ½ç¯©é¸çµæœ: ${selectedView} (${reason})`);
            
            return {
                view: selectedView,
                reason: reason,
                stats: stats,
                instructor: instructor
            };
        }

        // å„ªåŒ–çš„ç³»çµ±åˆå§‹åŒ–ï¼ˆåˆ†éšæ®µè¼‰å…¥ï¼‰
        async function initializeSystemOptimized() {
            try {
                console.log('é–‹å§‹å„ªåŒ–åˆ†éšæ®µåˆå§‹åŒ–ç³»çµ±...');
                addLoadingLog('ğŸš€ é–‹å§‹å„ªåŒ–åˆ†éšæ®µåˆå§‹åŒ–ç³»çµ±...', 'info');
                updateLoadingProgress(10);
                
                // ç¬¬ä¸€éšæ®µï¼šåŸºç¤åˆå§‹åŒ–ï¼ˆåŒæ­¥ï¼‰
                const phase1Start = performance.now();
                window.currentView = 'ä»Šæ—¥';
                loadSettings();
                updateDateTime();
                updateLoadingProgress(20);
                
                const phase1Time = performance.now() - phase1Start;
                console.log(`ç¬¬ä¸€éšæ®µå®Œæˆ: ${phase1Time.toFixed(2)}ms`);
                
                // ç¬¬äºŒéšæ®µï¼šä¸¦è¡Œè¼‰å…¥é—œéµè³‡æºï¼ˆç•°æ­¥ï¼‰
                const phase2Start = performance.now();
                addLoadingLog('ğŸ”„ ä¸¦è¡Œè¼‰å…¥é—œéµè³‡æº...', 'info');
                updateLoadingProgress(25);
                
                const [calendarResult, lineResult] = await Promise.allSettled([
                    loadEventsOptimized().catch(error => {
                        console.error('è¼‰å…¥è¡Œäº‹æ›†è³‡æ–™å¤±æ•—:', error);
                        addLoadingLog('âŒ è¼‰å…¥è¡Œäº‹æ›†è³‡æ–™å¤±æ•—: ' + error.message, 'error');
                        return null;
                    }),
                    initLineUserOptimized().catch(error => {
                        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                        addLoadingLog('âŒ LINE ç™»å…¥åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
                        return null;
                    })
                ]);
                
                const phase2Time = performance.now() - phase2Start;
                console.log(`ç¬¬äºŒéšæ®µå®Œæˆ: ${phase2Time.toFixed(2)}ms`);
                
                // è™•ç†çµæœ
                if (calendarResult.status === 'fulfilled' && calendarResult.value !== null) {
                    addLoadingLog('âœ… è¡Œäº‹æ›†è³‡æ–™è¼‰å…¥å®Œæˆ', 'success');
                    updateLoadingProgress(60);
                } else {
                    addLoadingLog('âš ï¸ è¡Œäº‹æ›†è³‡æ–™è¼‰å…¥æœ‰å•é¡Œ', 'warning');
                }
                
                if (lineResult.status === 'fulfilled' && lineResult.value !== null) {
                    addLoadingLog('âœ… LINE ç™»å…¥åˆå§‹åŒ–å®Œæˆ', 'success');
                    updateLoadingProgress(80);
                } else {
                    addLoadingLog('âš ï¸ LINE ç™»å…¥åˆå§‹åŒ–æœ‰å•é¡Œ', 'warning');
                }
                
                // ç¬¬ä¸‰éšæ®µï¼šè¬›å¸«æ¯”å°ï¼ˆå»¶é²åŸ·è¡Œï¼‰
                const phase3Start = performance.now();
                console.log('æ‰€æœ‰åˆå§‹åŒ–ä»»å‹™å®Œæˆï¼Œé–‹å§‹è¬›å¸«æ¯”å°...');
                addLoadingLog('ğŸ‘¨â€ğŸ« é–‹å§‹è¬›å¸«èº«ä»½æ¯”å°...', 'info');
                updateLoadingProgress(90);
                
                // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç’°å¢ƒ
                const isLocal = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.hostname === '0.0.0.0' ||
                               window.location.protocol === 'file:';
                
                if (isLocal) {
                    console.log('ğŸŒ æœ¬åœ°ç’°å¢ƒæ¨¡å¼ï¼Œè·³éè¬›å¸«è‡ªå‹•æ¯”å°');
                    addLoadingLog('ğŸŒ æœ¬åœ°ç’°å¢ƒæ¨¡å¼ï¼Œè·³éè¬›å¸«è‡ªå‹•æ¯”å°', 'info');
                    console.log('è¬›å¸«æ¯”å°å®Œæˆ');
                    addLoadingLog('âœ… æœ¬åœ°æ¨¡å¼åˆå§‹åŒ–å®Œæˆ', 'success');
                } else if (currentUser && currentUser.userId && currentUser.displayName) {
                    console.log('=== é–‹å§‹è‡ªå‹•æ¯”å°è¬›å¸« ===');
                    console.log('ç”¨æˆ¶è³‡æ–™:', currentUser);
                    addLoadingLog('ğŸ” æ­£åœ¨æ¯”å°è¬›å¸«èº«ä»½...', 'info');
                    
                    try {
                        await autoMatchTeacher(currentUser.userId, currentUser.displayName);
                        console.log('è¬›å¸«æ¯”å°å®Œæˆ');
                        addLoadingLog('âœ… è¬›å¸«èº«ä»½æ¯”å°å®Œæˆ', 'success');
                        
                        // è¬›å¸«æ¯”å°å®Œæˆå¾Œï¼Œé‡æ–°åŸ·è¡Œæ™ºæ…§ç¯©é¸
                        console.log('ğŸ”„ è¬›å¸«æ¯”å°å®Œæˆå¾Œé‡æ–°åŸ·è¡Œæ™ºæ…§ç¯©é¸...');
                        // ä½¿ç”¨å¼·åˆ¶å‡½æ•¸ç¢ºä¿æ­£ç¢ºåŸ·è¡Œè¬›å¸«æ™ºæ…§ç¯©é¸
                        setTimeout(() => {
                            forceInstructorSmartFilter();
                        }, 100);
                    } catch (error) {
                        console.error('è‡ªå‹•æ¯”å°è¬›å¸«å¤±æ•—:', error);
                        addLoadingLog('âš ï¸ è¬›å¸«èº«ä»½æ¯”å°å¤±æ•—: ' + error.message, 'warning');
                    }
                } else {
                    console.log('æ²’æœ‰ç”¨æˆ¶è³‡æ–™ï¼Œè·³éè‡ªå‹•æ¯”å°');
                    addLoadingLog('âš ï¸ æ²’æœ‰ç”¨æˆ¶è³‡æ–™ï¼Œè·³éè¬›å¸«æ¯”å°', 'warning');
                }
                
                const phase3Time = performance.now() - phase3Start;
                console.log(`ç¬¬ä¸‰éšæ®µå®Œæˆ: ${phase3Time.toFixed(2)}ms`);
                
                addLoadingLog('ğŸ‰ ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼', 'success');
                updateLoadingProgress(100);
                
                // ç¬¬å››éšæ®µï¼šUIæ›´æ–°ï¼ˆå»¶é²åŸ·è¡Œï¼‰
                const phase4Start = performance.now();
                animationManager.setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                        
                        // ç¶å®šè¦–åœ–æŒ‰éˆ•
                        bindViewButtons();
                        bindRefreshButton();
                        bindAttendanceMenu();
                        
                        // è¨­ç½®é è¨­è¦–åœ–ï¼Œæ™ºæ…§ç¯©é¸å°‡åœ¨è¬›å¸«æ¯”å°å®Œæˆå¾ŒåŸ·è¡Œ
                        console.log('ğŸ”„ è¨­ç½®é è¨­è¦–åœ–ï¼Œç­‰å¾…è¬›å¸«æ¯”å°å®Œæˆå¾ŒåŸ·è¡Œæ™ºæ…§ç¯©é¸...');
                        currentView = 'ä»Šæ—¥';
                        window.currentView = 'ä»Šæ—¥';
                        
                        // è¨­ç½®é è¨­ç‹€æ…‹
                        updateViewButtonStates();
                        updateTimeFilterOptions();
                        autoScrollToCalendar();
                        
                        const totalTime = performance.now() - phase1Start;
                        console.log(`ğŸ¯ ç¸½åˆå§‹åŒ–æ™‚é–“: ${totalTime.toFixed(2)}ms`);
                        console.log(`ğŸ“Š å„éšæ®µæ™‚é–“: åŸºç¤${phase1Time.toFixed(2)}ms, è³‡æº${phase2Time.toFixed(2)}ms, æ¯”å°${phase3Time.toFixed(2)}ms, UI${(performance.now() - phase4Start).toFixed(2)}ms`);
                        
                    } catch (error) {
                        console.error('éš±è—è¼‰å…¥å‹•ç•«å¤±æ•—:', error);
                    }
                }, 300); // æ¸›å°‘å»¶é²æ™‚é–“
                
            } catch (error) {
                console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                animationManager.setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œä½†å·²éš±è—è¼‰å…¥å‹•ç•«');
                    } catch (hideError) {
                        console.error('éš±è—è¼‰å…¥å‹•ç•«å¤±æ•—:', hideError);
                    }
                }, 500);
            }
        }

        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        function showLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }
            
            // é‡ç½®é€²åº¦æ¢
            updateLoadingProgress(0);
        }

        // æ›´æ–°è¼‰å…¥é€²åº¦
        function updateLoadingProgress(percentage) {
            const progressBar = document.getElementById('loadingProgressBar');
            const percentageText = document.getElementById('loadingPercentage');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (percentageText) {
                percentageText.textContent = Math.round(percentage) + '%';
            }
        }

        // éš±è—è¼‰å…¥å‹•ç•«
        function hideLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            if (mainContainer) {
                mainContainer.style.display = 'block';
                // è§¸ç™¼ä¸»å®¹å™¨çš„é€²å…¥å‹•ç•«
                mainContainer.classList.add('fade-in');
            }
        }

        // ç‚ºå…ƒç´ æ·»åŠ å‹•ç•«æ•ˆæœ
        function addAnimationToElement(element, animationClass, delay = 0) {
            if (element) {
                animationManager.setTimeout(() => {
                    element.classList.add(animationClass);
                }, delay);
            }
        }

        // ç‚ºèª²ç¨‹å¡ç‰‡æ·»åŠ é€²å…¥å‹•ç•«
        function animateEventCards() {
            const eventCards = document.querySelectorAll('.event-card');
            eventCards.forEach((card, index) => {
                // é‡ç½®å‹•ç•«ç‹€æ…‹
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.animation = 'none';
                
                // å¼·åˆ¶é‡æ’
                card.offsetHeight;
                
                // é‡æ–°å•Ÿå‹•å‹•ç•«
                card.style.animation = `slideUp 0.6s ease-out forwards`;
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }

        // è¨ˆç®—å€’æ•¸è¨ˆæ™‚
        function calculateCountdown(startTime, endTime) {
            const now = new Date();
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            const timeDiff = start.getTime() - now.getTime();
            const endDiff = end.getTime() - now.getTime();
            
            // å¦‚æœèª²ç¨‹å·²çµæŸ
            if (endDiff <= 0) {
                return {
                    text: 'èª²ç¨‹å·²çµæŸ',
                    status: 'overdue',
                    icon: 'fas fa-check-circle'
                };
            }
            
            // å¦‚æœèª²ç¨‹æ­£åœ¨é€²è¡Œä¸­
            if (timeDiff <= 0 && endDiff > 0) {
                const remainingMinutes = Math.floor(endDiff / (1000 * 60));
                const remainingHours = Math.floor(remainingMinutes / 60);
                const remainingMins = remainingMinutes % 60;
                
                if (remainingHours > 0) {
                    return {
                        text: `é€²è¡Œä¸­ï¼Œå‰©é¤˜ ${remainingHours}å°æ™‚${remainingMins}åˆ†é˜`,
                        status: 'ongoing',
                        icon: 'fas fa-play-circle'
                    };
                } else {
                    return {
                        text: `é€²è¡Œä¸­ï¼Œå‰©é¤˜ ${remainingMins}åˆ†é˜`,
                        status: 'ongoing',
                        icon: 'fas fa-play-circle'
                    };
                }
            }
            
            // å¦‚æœèª²ç¨‹å°šæœªé–‹å§‹
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return {
                    text: `é‚„æœ‰ ${days}å¤©${hours}å°æ™‚`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            } else if (hours > 0) {
                return {
                    text: `é‚„æœ‰ ${hours}å°æ™‚${minutes}åˆ†é˜`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            } else {
                return {
                    text: `é‚„æœ‰ ${minutes}åˆ†é˜`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            }
        }

        // æ›´æ–°æ‰€æœ‰å€’æ•¸è¨ˆæ™‚
        function updateAllCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown-timer');
            countdownElements.forEach(element => {
                const startTime = element.dataset.startTime;
                const endTime = element.dataset.endTime;
                
                if (startTime && endTime) {
                    const countdown = calculateCountdown(startTime, endTime);
                    element.className = `countdown-timer ${countdown.status}`;
                    element.innerHTML = `
                        <i class="${countdown.icon} countdown-icon"></i>
                        <span class="countdown-text">${countdown.text}</span>
                    `;
                }
            });
        }

        // å„ªåŒ–çš„ç³»çµ±åˆå§‹åŒ–ï¼ˆä¸¦è¡Œè¼‰å…¥ï¼‰
        async function initializeSystem() {
            try {
                console.log('é–‹å§‹å„ªåŒ–åˆå§‹åŒ–ç³»çµ±...');
                addLoadingLog('ğŸš€ é–‹å§‹å„ªåŒ–åˆå§‹åŒ–ç³»çµ±...', 'info');
                updateLoadingProgress(10);
                
                // åˆå§‹åŒ–å…¨å±€è®Šé‡
                window.currentView = 'ä»Šæ—¥';
                
                // è¼‰å…¥è¨­å®š
                addLoadingLog('âš™ï¸ è¼‰å…¥ç³»çµ±è¨­å®š...', 'info');
                loadSettings();
                updateLoadingProgress(15);
                
                // æ›´æ–°æ—¥æœŸæ™‚é–“
                addLoadingLog('ğŸ• åˆå§‹åŒ–æ™‚é–“ç³»çµ±...', 'info');
                updateDateTime();
                updateLoadingProgress(20);
                
                // ä¸¦è¡Œè¼‰å…¥è¡Œäº‹æ›†å’ŒLINEç”¨æˆ¶è³‡æ–™
                addLoadingLog('ğŸ”„ ä¸¦è¡Œè¼‰å…¥è¡Œäº‹æ›†å’ŒLINEè³‡æ–™...', 'info');
                updateLoadingProgress(25);
                
                const [calendarResult, lineResult] = await Promise.allSettled([
                    loadEvents().catch(error => {
                        console.error('è¼‰å…¥è¡Œäº‹æ›†è³‡æ–™å¤±æ•—:', error);
                        addLoadingLog('âŒ è¼‰å…¥è¡Œäº‹æ›†è³‡æ–™å¤±æ•—: ' + error.message, 'error');
                        return null;
                    }),
                    initLineUser().catch(error => {
                        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                        addLoadingLog('âŒ LINE ç™»å…¥åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
                        return null;
                    })
                ]);
                
                // è™•ç†çµæœ
                if (calendarResult.status === 'fulfilled' && calendarResult.value !== null) {
                    addLoadingLog('âœ… è¡Œäº‹æ›†è³‡æ–™è¼‰å…¥å®Œæˆ', 'success');
                    updateLoadingProgress(60);
                } else {
                    addLoadingLog('âš ï¸ è¡Œäº‹æ›†è³‡æ–™è¼‰å…¥æœ‰å•é¡Œ', 'warning');
                }
                
                if (lineResult.status === 'fulfilled' && lineResult.value !== null) {
                    addLoadingLog('âœ… LINE ç™»å…¥åˆå§‹åŒ–å®Œæˆ', 'success');
                    updateLoadingProgress(80);
                } else {
                    addLoadingLog('âš ï¸ LINE ç™»å…¥åˆå§‹åŒ–æœ‰å•é¡Œ', 'warning');
                }
                
                console.log('æ‰€æœ‰åˆå§‹åŒ–ä»»å‹™å®Œæˆï¼Œé–‹å§‹è¬›å¸«æ¯”å°...');
                addLoadingLog('ğŸ‘¨â€ğŸ« é–‹å§‹è¬›å¸«èº«ä»½æ¯”å°...', 'info');
                updateLoadingProgress(90);
                
                // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç’°å¢ƒ
                const isLocal = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.hostname === '0.0.0.0' ||
                               window.location.protocol === 'file:';
                
                if (isLocal) {
                    console.log('ğŸŒ æœ¬åœ°ç’°å¢ƒæ¨¡å¼ï¼Œè·³éè¬›å¸«è‡ªå‹•æ¯”å°');
                    addLoadingLog('ğŸŒ æœ¬åœ°ç’°å¢ƒæ¨¡å¼ï¼Œè·³éè¬›å¸«è‡ªå‹•æ¯”å°', 'info');
                    console.log('è¬›å¸«æ¯”å°å®Œæˆ');
                    addLoadingLog('âœ… æœ¬åœ°æ¨¡å¼åˆå§‹åŒ–å®Œæˆ', 'success');
                } else if (currentUser && currentUser.userId && currentUser.displayName) {
                    console.log('=== é–‹å§‹è‡ªå‹•æ¯”å°è¬›å¸« ===');
                    console.log('ç”¨æˆ¶è³‡æ–™:', currentUser);
                    addLoadingLog('ğŸ” æ­£åœ¨æ¯”å°è¬›å¸«èº«ä»½...', 'info');
                    
                    try {
                        await autoMatchTeacher(currentUser.userId, currentUser.displayName);
                        console.log('è¬›å¸«æ¯”å°å®Œæˆ');
                        addLoadingLog('âœ… è¬›å¸«èº«ä»½æ¯”å°å®Œæˆ', 'success');
                        
                        // è¬›å¸«æ¯”å°å®Œæˆå¾Œï¼Œé‡æ–°åŸ·è¡Œæ™ºæ…§ç¯©é¸
                        console.log('ğŸ”„ è¬›å¸«æ¯”å°å®Œæˆå¾Œé‡æ–°åŸ·è¡Œæ™ºæ…§ç¯©é¸...');
                        // ä½¿ç”¨å¼·åˆ¶å‡½æ•¸ç¢ºä¿æ­£ç¢ºåŸ·è¡Œè¬›å¸«æ™ºæ…§ç¯©é¸
                        setTimeout(() => {
                            forceInstructorSmartFilter();
                        }, 100);
                    } catch (error) {
                        console.error('è‡ªå‹•æ¯”å°è¬›å¸«å¤±æ•—:', error);
                        addLoadingLog('âš ï¸ è¬›å¸«èº«ä»½æ¯”å°å¤±æ•—: ' + error.message, 'warning');
                    }
                } else {
                    console.log('æ²’æœ‰ç”¨æˆ¶è³‡æ–™ï¼Œè·³éè‡ªå‹•æ¯”å°');
                    addLoadingLog('âš ï¸ æ²’æœ‰ç”¨æˆ¶è³‡æ–™ï¼Œè·³éè¬›å¸«æ¯”å°', 'warning');
                }
                
                addLoadingLog('ğŸ‰ ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼', 'success');
                updateLoadingProgress(100);
                
                // æ¯”å°å®Œæˆå¾Œéš±è—è¼‰å…¥å‹•ç•«
                animationManager.setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                        
                        // ç¶å®šè¦–åœ–æŒ‰éˆ•ï¼ˆç§»é™¤é‡è¤‡ç¶å®šï¼‰
                        console.log('ğŸ”„ ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œé–‹å§‹ç¶å®šæŒ‰éˆ•...');
                        bindViewButtons();
                        bindRefreshButton();
                        bindAttendanceMenu();
                        
                        // è¨­ç½®ä»Šæ—¥æŒ‰éˆ•çš„é è¨­æŒ‰ä¸‹æ•ˆæœ
                        updateViewButtonStates();
                        console.log('ğŸ”„ ä»Šæ—¥æŒ‰éˆ•é è¨­ç‹€æ…‹å·²è¨­ç½®');
                        
                        // æ›´æ–°æ™‚æ®µç¯©é¸é¸é …ï¼ˆæ™ºæ…§ç®—æ³•ï¼‰
                        updateTimeFilterOptions();
                        console.log('ğŸ• æ™‚æ®µç¯©é¸æ™ºæ…§ç®—æ³•å·²æ›´æ–°');
                        
                        // è‡ªå‹•æ»‘å‹•åˆ°è¡Œäº‹æ›†å€åŸŸï¼ˆåƒ…è¡Œå‹•è£ç½®ï¼‰
                        autoScrollToCalendar();
                    } catch (error) {
                        console.error('éš±è—è¼‰å…¥å‹•ç•«å¤±æ•—:', error);
                    }
                }, 500);
                
            } catch (error) {
                console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                // å³ä½¿å¤±æ•—ä¹Ÿè¦éš±è—è¼‰å…¥å‹•ç•«
                animationManager.setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œä½†å·²éš±è—è¼‰å…¥å‹•ç•«');
                    } catch (hideError) {
                        console.error('éš±è—è¼‰å…¥å‹•ç•«å¤±æ•—:', hideError);
                    }
                }, 1000);
            }
        }

        // æ›´æ–°æ—¥æœŸæ™‚é–“é¡¯ç¤º
        function updateDateTime() {
            const now = new Date();
            
            // æ›´æ–°æ—¥æœŸ
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', dateOptions);
            
            // æ›´æ–°æ™‚é–“
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW', timeOptions);
            
            // æ›´æ–°é€±æ•¸
            const weekNumber = getWeekNumber(now);
            document.getElementById('currentWeek').textContent = `${now.getFullYear()}å¹´ç¬¬${weekNumber}é€±`;
        }

        // ç²å–é€±æ•¸
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // LINE UserID ç›¸é—œå‡½æ•¸
        async function initLineUser() {
            console.log('é–‹å§‹åˆå§‹åŒ–LINEç”¨æˆ¶...');
            console.log('ç•¶å‰URL:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
            
            return new Promise((resolve) => {
                // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç’°å¢ƒ
                const isLocal = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.hostname === '0.0.0.0' ||
                               window.location.protocol === 'file:';
                
                if (isLocal) {
                    console.log('ğŸŒ æª¢æ¸¬åˆ°æœ¬åœ°ç’°å¢ƒï¼Œè·³é LINE èªè­‰');
                    addLoadingLog('ğŸŒ æœ¬åœ°ç’°å¢ƒæ¨¡å¼ï¼Œè·³é LINE èªè­‰', 'info');
                    
                    // è¨­ç½®æ¨¡æ“¬ç”¨æˆ¶è³‡æ–™
                    currentUser = {
                        userId: 'local-test-user',
                        displayName: 'æœ¬åœ°æ¸¬è©¦ç”¨æˆ¶',
                        pictureUrl: ''
                    };
                    
                    updateUserDisplay();
                    console.log('æœ¬åœ°æ¨¡å¼ç”¨æˆ¶é¡¯ç¤ºå®Œæˆ');
                    resolve();
                    return;
                }
                
                // è¨­ç½®è¶…æ™‚ä¿è­·ï¼ˆ3ç§’ï¼Œæ¸›å°‘ç­‰å¾…æ™‚é–“ï¼‰
                const timeout = setTimeout(() => {
                    console.warn('LIFF åˆå§‹åŒ–è¶…æ™‚ï¼Œé¡¯ç¤ºç¶å®šæŒ‰éˆ•');
                    addLoadingLog('â° LINE ç™»å…¥è¶…æ™‚ï¼Œè«‹æ‰‹å‹•ç¶å®š', 'warning');
                    showBindButton();
                    resolve();
                }, 3000);
                
                // æª¢æŸ¥æ˜¯å¦åœ¨LINEç’°å¢ƒä¸­
                if (typeof liff !== 'undefined') {
                    console.log('LIFF SDK å·²è¼‰å…¥');
                    
                    // åˆå§‹åŒ–LIFF - é€™è£¡éœ€è¦æ‚¨çš„LIFF ID
                    liff.init({
                        liffId: '1657746214-qp0y8NwZ', // è«‹æ›¿æ›ç‚ºæ‚¨çš„LIFF ID
                        withLoginOnExternalBrowser: true
                    }).then(() => {
                        console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                        console.log('æ˜¯å¦åœ¨LINEå®¢æˆ¶ç«¯:', liff.isInClient());
                        console.log('æ˜¯å¦å·²ç™»å…¥:', liff.isLoggedIn());
                        
                        if (liff.isLoggedIn()) {
                            console.log('ç”¨æˆ¶å·²ç™»å…¥ï¼Œç²å–ç”¨æˆ¶è³‡æ–™...');
                            liff.getProfile().then(async (profile) => {
                                clearTimeout(timeout);
                                console.log('ç²å–åˆ°ç”¨æˆ¶è³‡æ–™:', profile);
                                currentUser = {
                                    userId: profile.userId,
                                    displayName: profile.displayName,
                                    pictureUrl: profile.pictureUrl
                                };
                                updateUserDisplay();
                                console.log('updateUserDisplay() åŸ·è¡Œå®Œæˆ');
                                
                                
                                // å°‡è‡ªå‹•æ¯”å°ç§»åˆ°ç³»çµ±åˆå§‹åŒ–å®Œæˆå¾ŒåŸ·è¡Œ
                                console.log('æº–å‚™åœ¨ç³»çµ±åˆå§‹åŒ–å®Œæˆå¾ŒåŸ·è¡Œè‡ªå‹•æ¯”å°');
                                
                                resolve();
                            }).catch(error => {
                                console.error('ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
                                clearTimeout(timeout);
                                showBindButton();
                                resolve();
                            });
                        } else {
                            console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œé¡¯ç¤ºç¶å®šæŒ‰éˆ•');
                            clearTimeout(timeout);
                            showBindButton();
                            resolve();
                        }
                    }).catch(error => {
                        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                        clearTimeout(timeout);
                        showBindButton();
                        resolve();
                    });
                    
                } else {
                    clearTimeout(timeout);
                    console.log('LIFF SDK æœªè¼‰å…¥ï¼Œé¡¯ç¤ºç¶å®šæŒ‰éˆ•');
                    showBindButton();
                    resolve();
                }
            });
        }

        function updateUserDisplay() {
            console.log('æ›´æ–°ç”¨æˆ¶é¡¯ç¤ºï¼Œç•¶å‰ç”¨æˆ¶:', currentUser);
            
            try {
                const userInfoGroup = document.getElementById('userInfoGroup');
                const userDisplayName = document.getElementById('userDisplayName');
                const userDisplayId = document.getElementById('userDisplayId');
                const bindUserBtn = document.getElementById('bindUserBtn');
                
                if (!userInfoGroup || !userDisplayName || !userDisplayId || !bindUserBtn) {
                    console.error('æ‰¾ä¸åˆ°ç”¨æˆ¶è³‡è¨Šå…ƒç´ ');
                    return;
                }
                
                if (currentUser) {
                    console.log('é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š:', currentUser.displayName, currentUser.userId);
                    
                    try {
                        userDisplayName.textContent = currentUser.displayName;
                        console.log('è¨­ç½®ç”¨æˆ¶åç¨±å®Œæˆ');
                    } catch (error) {
                        console.error('è¨­ç½®ç”¨æˆ¶åç¨±å¤±æ•—:', error);
                    }
                    
                    try {
                        userDisplayId.textContent = `ID: ${currentUser.userId}`;
                        console.log('è¨­ç½®ç”¨æˆ¶IDå®Œæˆ');
                    } catch (error) {
                        console.error('è¨­ç½®ç”¨æˆ¶IDå¤±æ•—:', error);
                    }
                    
                    try {
                        userDisplayId.style.display = 'block';
                        console.log('è¨­ç½®IDé¡¯ç¤ºå®Œæˆ');
                    } catch (error) {
                        console.error('è¨­ç½®IDé¡¯ç¤ºå¤±æ•—:', error);
                    }
                    
                    try {
                        bindUserBtn.textContent = 'é‡æ–°ç¶å®š';
                        console.log('è¨­ç½®æŒ‰éˆ•æ–‡å­—å®Œæˆ');
                    } catch (error) {
                        console.error('è¨­ç½®æŒ‰éˆ•æ–‡å­—å¤±æ•—:', error);
                    }
                    
                    try {
                        userInfoGroup.style.display = 'block';
                        console.log('è¨­ç½®ç”¨æˆ¶è³‡è¨Šçµ„é¡¯ç¤ºå®Œæˆ');
                    } catch (error) {
                        console.error('è¨­ç½®ç”¨æˆ¶è³‡è¨Šçµ„é¡¯ç¤ºå¤±æ•—:', error);
                    }
                } else {
                    console.log('é¡¯ç¤ºæœªç¶å®šç‹€æ…‹');
                    userDisplayName.textContent = 'æœªç¶å®š';
                    userDisplayId.style.display = 'none';
                    bindUserBtn.textContent = 'ç¶å®šå¸³è™Ÿ';
                    userInfoGroup.style.display = 'block';
                }
                console.log('updateUserDisplay å‡½æ•¸åŸ·è¡Œå®Œæˆ');
            } catch (error) {
                console.error('updateUserDisplay å‡½æ•¸åŸ·è¡ŒéŒ¯èª¤:', error);
            }
        }

        function showBindButton() {
            updateUserDisplay();
        }

        async function bindUser() {
            console.log('ç”¨æˆ¶é»æ“Šç¶å®šæŒ‰éˆ•');
            
            if (typeof liff !== 'undefined') {
                try {
                    if (liff.isLoggedIn()) {
                        console.log('ç”¨æˆ¶å·²ç™»å…¥ï¼Œç²å–ç”¨æˆ¶è³‡æ–™');
                        liff.getProfile().then(async (profile) => {
                            console.log('ç²å–åˆ°ç”¨æˆ¶è³‡æ–™:', profile);
                            currentUser = {
                                userId: profile.userId,
                                displayName: profile.displayName,
                                pictureUrl: profile.pictureUrl
                            };
                            updateUserDisplay();
                            
                            // è‡ªå‹•æ¯”å°è¬›å¸«
                            console.log('æº–å‚™åŸ·è¡Œè‡ªå‹•æ¯”å°è¬›å¸«...');
                            await autoMatchTeacher(profile.userId, profile.displayName);
                        }).catch(error => {
                            console.error('ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
                            alert('ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—ï¼Œè«‹é‡è©¦');
                        });
                    } else {
                        console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œå˜—è©¦ç™»å…¥');
                        // é€™æœƒè§¸ç™¼LINEçš„æˆæ¬Šæµç¨‹
                        liff.login().catch(error => {
                            console.error('ç™»å…¥å¤±æ•—:', error);
                            alert('ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦');
                        });
                    }
                } catch (error) {
                    console.error('LIFF æ“ä½œç•°å¸¸:', error);
                    alert('ç¶å®šå¤±æ•—ï¼Œè«‹é‡è©¦');
                }
            } else {
                console.log('LIFF SDK æœªè¼‰å…¥');
                alert('è«‹åœ¨LINEæ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿæ­¤é é¢');
            }
        }

        // å„ªåŒ–çš„è‡ªå‹•æ¯”å°è¬›å¸«ï¼ˆå«å¿«å–æ©Ÿåˆ¶ï¼‰
        async function autoMatchTeacher(userId, displayName) {
            console.log('é–‹å§‹å„ªåŒ–è‡ªå‹•æ¯”å°è¬›å¸«...', { userId, displayName });
            
            // æª¢æŸ¥å¿«å–
            const cacheKey = `teacher_match_${userId}_${displayName}`;
            const cachedResult = localStorage.getItem(cacheKey);
            const cacheTime = localStorage.getItem(`${cacheKey}_time`);
            const cacheExpiry = 10 * 60 * 1000; // 10åˆ†é˜å¿«å–
            
            if (cachedResult && cacheTime && (Date.now() - parseInt(cacheTime)) < cacheExpiry) {
                console.log('ğŸ“¦ ä½¿ç”¨å¿«å–çš„è¬›å¸«æ¯”å°çµæœ');
                addLoadingLog('ğŸ“¦ ä½¿ç”¨å¿«å–çš„è¬›å¸«æ¯”å°çµæœ', 'info');
                
                const result = JSON.parse(cachedResult);
                if (result.matchedTeacher) {
                    selectMatchedTeacher(result.matchedTeacher);
                }
                return;
            }
            
            // åœ¨é é¢ä¸Šé¡¯ç¤ºæ¯”å°éç¨‹
            showMatchingProcess('é–‹å§‹æ¯”å°è¬›å¸«...', 'info');
            addLoadingLog('ğŸ” é–‹å§‹è¬›å¸«èº«ä»½æ¯”å°...', 'info');
            
            // ç²å–è¬›å¸«é¸æ“‡å…ƒç´ 
            const instructorSelect = document.getElementById('instructorSelect');
            
            return new Promise(async (resolve) => {
            
            try {
                console.log('æº–å‚™èª¿ç”¨å„ªåŒ–çš„è¬›å¸« API...');
                showMatchingProcess('æ­£åœ¨èª¿ç”¨è¬›å¸« API...', 'info');
                addLoadingLog('ğŸŒ æ­£åœ¨é€£æ¥è¬›å¸«è³‡æ–™åº«...', 'info');
                
                // ä½¿ç”¨å„ªåŒ–çš„APIè«‹æ±‚
                const result = await apiOptimizer.fetchWithRetry('/api/teachers', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    redirect: 'follow'  // è‡ªå‹•è·Ÿéš¨é‡å®šå‘
                });
                
                console.log('APIå›æ‡‰çµæœ:', result);
                showMatchingProcess(`APIå›æ‡‰æˆåŠŸ`, 'success');
                addLoadingLog(`ğŸ“¡ API å›æ‡‰æˆåŠŸ`, 'success');
                
                if (!result || !result.data) {
                    throw new Error(`APIè«‹æ±‚å¤±æ•—: ç„¡æ•ˆçš„å›æ‡‰æ ¼å¼`);
                }
                
                const data = result.data;
                console.log('APIå›æ‡‰:', data);
                showMatchingProcess('APIå›æ‡‰æˆåŠŸï¼Œé–‹å§‹æ¯”å°è¬›å¸«...', 'success');
                addLoadingLog('âœ… è¬›å¸«è³‡æ–™è¼‰å…¥æˆåŠŸ', 'success');
                
                // è™•ç† /api/teachers çš„å›æ‡‰æ ¼å¼
                if (data.success && data.teachers && Array.isArray(data.teachers)) {
                    showMatchingProcess(`æ‰¾åˆ° ${data.teachers.length} å€‹è¬›å¸«ï¼Œé–‹å§‹æ¯”å°...`, 'info');
                    addLoadingLog(`ğŸ‘¥ æ‰¾åˆ° ${data.teachers.length} å€‹è¬›å¸«ï¼Œé–‹å§‹æ¯”å°...`, 'info');
                    
                    // é¡¯ç¤ºæ¯”å°éç¨‹
                    showMatchingProcess(`æ¯”å°æ¢ä»¶: UserID=${userId}, DisplayName=${displayName}`, 'info');
                    addLoadingLog(`ğŸ” æ¯”å°æ¢ä»¶: ${displayName} (${userId})`, 'info');
                    
                    // å°‹æ‰¾åŒ¹é…çš„è¬›å¸«
                    addLoadingLog('ğŸ” é–‹å§‹é€ä¸€æ¯”å°è¬›å¸«...', 'info');
                    const matchedTeacher = data.teachers.find((teacher, index) => {
                        addLoadingLog(`ğŸ“ æ¯”å°ç¬¬ ${index + 1} ä½è¬›å¸«: ${teacher.name}`, 'info');
                        
                        // ç²¾ç¢ºæ¯”å°userIdï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                        if (teacher.userId && userId && teacher.userId.toLowerCase() === userId.toLowerCase()) {
                            showMatchingProcess(`âœ… ç²¾ç¢ºåŒ¹é…UserID: ${teacher.userId}`, 'success');
                            addLoadingLog(`ğŸ¯ ç²¾ç¢ºåŒ¹é… UserID: ${teacher.userId}`, 'success');
                            return true;
                        }
                        // æ¨¡ç³Šæ¯”å°nameèˆ‡displayNameï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                        if (teacher.name && displayName) {
                            const teacherName = teacher.name.toLowerCase().trim();
                            const userName = displayName.toLowerCase().trim();
                            
                            // å®Œå…¨åŒ¹é…ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                            if (teacherName === userName) {
                                showMatchingProcess(`âœ… å®Œå…¨åŒ¹é…åç¨±: ${teacher.name}`, 'success');
                                addLoadingLog(`ğŸ¯ å®Œå…¨åŒ¹é…åç¨±: ${teacher.name}`, 'success');
                                return true;
                            }
                            
                            // åŒ…å«åŒ¹é…ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                            if (teacherName.includes(userName) || userName.includes(teacherName)) {
                                showMatchingProcess(`âœ… åŒ…å«åŒ¹é…: ${teacher.name}`, 'success');
                                addLoadingLog(`ğŸ¯ åŒ…å«åŒ¹é…: ${teacher.name}`, 'success');
                                return true;
                            }
                            
                            // éƒ¨åˆ†åŒ¹é…ï¼ˆè‡³å°‘3å€‹å­—ç¬¦ï¼Œä¸å€åˆ†å¤§å°å¯«ï¼‰
                            if (teacherName.length >= 3 && userName.length >= 3) {
                                const commonChars = [...teacherName].filter(char => userName.includes(char)).length;
                                const similarity = commonChars / Math.max(teacherName.length, userName.length);
                                if (similarity >= 0.6) { // 60%ç›¸ä¼¼åº¦
                                    showMatchingProcess(`âœ… ç›¸ä¼¼åº¦åŒ¹é…: ${teacher.name} (${Math.round(similarity * 100)}%)`, 'success');
                                    addLoadingLog(`ğŸ¯ ç›¸ä¼¼åº¦åŒ¹é…: ${teacher.name} (${Math.round(similarity * 100)}%)`, 'success');
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                    
                    if (matchedTeacher) {
                        console.log('æ‰¾åˆ°åŒ¹é…çš„è¬›å¸«:', matchedTeacher);
                        showMatchingProcess(`ğŸ‰ æ‰¾åˆ°åŒ¹é…è¬›å¸«: ${matchedTeacher.name}`, 'success');
                        
                        // å¿«å–æ¯”å°çµæœ
                        const result = {
                            matchedTeacher: matchedTeacher,
                            timestamp: Date.now()
                        };
                        localStorage.setItem(cacheKey, JSON.stringify(result));
                        localStorage.setItem(`${cacheKey}_time`, Date.now().toString());
                        
                        // é¸æ“‡åŒ¹é…çš„è¬›å¸«
                        selectMatchedTeacher(matchedTeacher);
                        
                        // æ¯”å°æˆåŠŸï¼Œé¡¯ç¤ºå€‹äººè¡Œäº‹æ›†
                        console.log('æ¯”å°æˆåŠŸï¼Œå°‡é¡¯ç¤ºå€‹äººè¡Œäº‹æ›†');
                        resolve();
                        return;
                    } else {
                        console.log('æœªæ‰¾åˆ°å°æ‡‰çš„è¬›å¸«é¸é …');
                        showMatchingProcess(`âš ï¸ æ‰¾åˆ°åŒ¹é…è¬›å¸«ä½†æœªåœ¨åˆ—è¡¨ä¸­: ${matchedTeacher.name}`, 'warning');
                        addLoadingLog(`âš ï¸ æ‰¾åˆ°åŒ¹é…è¬›å¸«ä½†æœªåœ¨åˆ—è¡¨ä¸­: ${matchedTeacher.name}`, 'warning');
                        
                        // æ¯”å°å¤±æ•—ï¼Œé¡¯ç¤ºå…¨éƒ¨è¬›å¸«
                        console.log('æ¯”å°å¤±æ•—ï¼Œå°‡é¡¯ç¤ºå…¨éƒ¨è¬›å¸«');
                        if (instructorSelect) {
                            instructorSelect.value = ''; // é¸æ“‡å…¨éƒ¨è¬›å¸«
                            
                            // ç›´æ¥åŸ·è¡Œå…¨å±€æ™ºæ…§ç¯©é¸ï¼Œä¸è§¸ç™¼äº‹ä»¶
                            console.log('ğŸ”„ è¬›å¸«æ¯”å°å¤±æ•—ï¼ŒåŸ·è¡Œå…¨å±€æ™ºæ…§ç¯©é¸');
                            const smartResult = advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«');
                            currentView = smartResult.view;
                            window.currentView = smartResult.view;
                            
                            updateViewButtonStates();
                            updateTimeFilterOptions();
                            updateStats();
                            renderEvents();
                            autoScrollToViewButtons();
                            
                            showAdvancedSmartFilterNotification(smartResult);
                        }
                    }
                } else {
                    console.error('APIå›æ‡‰æ ¼å¼éŒ¯èª¤:', data);
                    showMatchingProcess('âŒ APIå›æ‡‰æ ¼å¼éŒ¯èª¤', 'error');
                }
            } catch (error) {
                console.error('è‡ªå‹•æ¯”å°è¬›å¸«å¤±æ•—:', error);
                showMatchingProcess(`âŒ è‡ªå‹•æ¯”å°å¤±æ•—: ${error.message}`, 'error');
                
                if (error.message.includes('è¶…æ™‚')) {
                    addLoadingLog('â° API èª¿ç”¨è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥', 'error');
                } else if (error.message.includes('404')) {
                    addLoadingLog('âŒ è¬›å¸« API ä¸å­˜åœ¨ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡', 'error');
                } else {
                    addLoadingLog(`âŒ æ¯”å°å¤±æ•—: ${error.message}`, 'error');
                }
            } finally {
                // ç„¡è«–æ¯”å°æˆåŠŸèˆ‡å¦ï¼Œéƒ½è§£æ Promise
                addLoadingLog('ğŸ è¬›å¸«æ¯”å°æµç¨‹çµæŸ', 'info');
                
                // ç¢ºä¿åœ¨æ¯”å°å¤±æ•—æ™‚ä¹ŸåŸ·è¡Œæ™ºæ…§ç¯©é¸
                const instructorSelect = document.getElementById('instructorSelect');
                if (instructorSelect && instructorSelect.value === '') {
                    console.log('ğŸ”„ è¬›å¸«æ¯”å°å¤±æ•—ï¼ŒåŸ·è¡Œå…¨å±€æ™ºæ…§ç¯©é¸');
                    // ç›´æ¥åŸ·è¡Œå…¨å±€æ™ºæ…§ç¯©é¸ï¼Œä¸è§¸ç™¼äº‹ä»¶
                    const smartResult = advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«');
                    currentView = smartResult.view;
                    window.currentView = smartResult.view;
                    
                    updateViewButtonStates();
                    updateTimeFilterOptions();
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons();
                    
                    showAdvancedSmartFilterNotification(smartResult);
                }
                
                resolve();
            }
            });
        }

        // é¡¯ç¤ºæ¯”å°éç¨‹
        function showMatchingProcess(message, type = 'info') {
            console.log(`[æ¯”å°éç¨‹] ${message}`);
        }

        // è‡ªå‹•æ»‘å‹•åˆ°è¡Œäº‹æ›†å€åŸŸï¼ˆæ‰€æœ‰è£ç½®ï¼‰
        function autoScrollToCalendar() {
                // å»¶é²ä¸€é»æ™‚é–“ç¢ºä¿é é¢å®Œå…¨è¼‰å…¥
                setTimeout(() => {
                // æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“ä»Šæ—¥æœ¬é€±æ¯æœˆæŒ‰éˆ•åˆ‡é½Šé ‚éƒ¨
                    const viewButtons = document.querySelector('.view-buttons');
                
                    if (viewButtons) {
                    // è¨ˆç®—è¦–åœ–æŒ‰éˆ•çš„ä½ç½®ï¼Œè®“æŒ‰éˆ•é½Šå¹³é ‚éƒ¨
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“æŒ‰éˆ•é½Šå¹³é ‚éƒ¨
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`å·²è‡ªå‹•æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“ä»Šæ—¥æœ¬é€±æ¯æœˆæŒ‰éˆ•åˆ‡é½Šé ‚éƒ¨`);
                } else {
                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°è¦–åœ–æŒ‰éˆ•ï¼Œå‰‡æ»‘å‹•åˆ°ä¸»å…§å®¹å€åŸŸ
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`å·²è‡ªå‹•æ»‘å‹•åˆ°ä¸»å…§å®¹å€åŸŸï¼Œç¯©é¸å€å¡Šé«˜åº¦: ${controlHeight}px`);
                    }
                    }
                }, 1000);
            }

        // è‡ªå‹•æ»¾å‹•åˆ°è¦–åœ–æŒ‰éˆ•ï¼ˆé€šç”¨å‡½æ•¸ï¼‰
        function autoScrollToViewButtons() {
            console.log('ğŸ”„ é–‹å§‹è‡ªå‹•æ»¾å‹•åˆ°è¦–åœ–æŒ‰éˆ•');
            
            // ä½¿ç”¨èˆ‡ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ç›¸åŒçš„æ»‘å‹•é‚è¼¯
            setTimeout(() => {
                // æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“ä»Šæ—¥æœ¬é€±æ¯æœˆæŒ‰éˆ•åˆ‡é½Šé ‚éƒ¨
                const viewButtons = document.querySelector('.view-buttons');
                
                if (viewButtons) {
                    // è¨ˆç®—è¦–åœ–æŒ‰éˆ•çš„ä½ç½®ï¼Œè®“æŒ‰éˆ•é½Šå¹³é ‚éƒ¨
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“æŒ‰éˆ•é½Šå¹³é ‚éƒ¨
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`å·²è‡ªå‹•æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“ä»Šæ—¥æœ¬é€±æ¯æœˆæŒ‰éˆ•åˆ‡é½Šé ‚éƒ¨`);
                } else {
                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°è¦–åœ–æŒ‰éˆ•ï¼Œå‰‡æ»‘å‹•åˆ°ä¸»å…§å®¹å€åŸŸ
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`å·²è‡ªå‹•æ»‘å‹•åˆ°ä¸»å…§å®¹å€åŸŸï¼Œç¯©é¸å€å¡Šé«˜åº¦: ${controlHeight}px`);
                    }
                }
            }, 100);
        }

        // æ¨¡ç³Šæ¯”å°è¬›å¸«é¸é …
        function findBestMatchingOption(selectElement, targetName) {
            if (!selectElement || !targetName) return null;
            
            const options = Array.from(selectElement.options);
            const target = targetName.toLowerCase().trim();
            
            console.log(`é–‹å§‹æ¨¡ç³Šæ¯”å°è¬›å¸«é¸é …ï¼Œç›®æ¨™åç¨±: "${targetName}"`);
            
            // 1. ç²¾ç¢ºåŒ¹é…
            for (let option of options) {
                if (option.value.toLowerCase().trim() === target) {
                    console.log(`âœ… ç²¾ç¢ºåŒ¹é…: ${option.value}`);
                    return option;
                }
            }
            
            // 2. åŒ…å«åŒ¹é…
            for (let option of options) {
                const optionValue = option.value.toLowerCase().trim();
                if (optionValue.includes(target) || target.includes(optionValue)) {
                    console.log(`âœ… åŒ…å«åŒ¹é…: ${option.value}`);
                    return option;
                }
            }
            
            // 3. ç›¸ä¼¼åº¦åŒ¹é…
            let bestMatch = null;
            let bestSimilarity = 0;
            
            for (let option of options) {
                const optionValue = option.value.toLowerCase().trim();
                const similarity = calculateSimilarity(target, optionValue);
                
                console.log(`æ¯”å° "${option.value}": ç›¸ä¼¼åº¦ ${Math.round(similarity * 100)}%`);
                
                if (similarity > bestSimilarity && similarity >= 0.5) { // 50% ç›¸ä¼¼åº¦é–¾å€¼
                    bestMatch = option;
                    bestSimilarity = similarity;
                }
            }
            
            if (bestMatch) {
                console.log(`âœ… ç›¸ä¼¼åº¦åŒ¹é…: ${bestMatch.value} (${Math.round(bestSimilarity * 100)}%)`);
                return bestMatch;
            }
            
            console.log('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„è¬›å¸«é¸é …');
            return null;
        }

        // è¨ˆç®—å­—ä¸²ç›¸ä¼¼åº¦
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            if (str1.length === 0 || str2.length === 0) return 0;
            
            // ä½¿ç”¨ Levenshtein è·é›¢è¨ˆç®—ç›¸ä¼¼åº¦
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;
            
            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            const maxLen = Math.max(len1, len2);
            return (maxLen - matrix[len2][len1]) / maxLen;
        }


        // ç¶å®šé‡æ–°æ•´ç†æŒ‰éˆ•èª²ç¨‹
        function bindRefreshButton() {
            const refreshButton = document.getElementById('refreshButton');
            if (refreshButton) {
                // ç§»é™¤èˆŠçš„èª²ç¨‹ç›£è½å™¨
                refreshButton.removeEventListener('click', handleRefreshClick);
                // æ·»åŠ æ–°çš„èª²ç¨‹ç›£è½å™¨
                refreshButton.addEventListener('click', handleRefreshClick);
                console.log('âœ… é‡æ–°æ•´ç†æŒ‰éˆ•èª²ç¨‹å·²ç¶å®š');
            } else {
                console.warn('âš ï¸ é‡æ–°æ•´ç†æŒ‰éˆ•å…ƒç´ æœªæ‰¾åˆ°');
            }
        }

        // ç¶å®šç°½åˆ°ç³»çµ±é¸å–®èª²ç¨‹
        function bindAttendanceMenu() {
            const attendanceMenu = document.getElementById('attendanceMenu');
            if (attendanceMenu) {
                // ç§»é™¤èˆŠçš„èª²ç¨‹ç›£è½å™¨
                attendanceMenu.removeEventListener('click', handleAttendanceMenuClick);
                // æ·»åŠ æ–°çš„èª²ç¨‹ç›£è½å™¨
                attendanceMenu.addEventListener('click', handleAttendanceMenuClick);
                console.log('âœ… ç°½åˆ°ç³»çµ±é¸å–®èª²ç¨‹å·²ç¶å®š');
            } else {
                console.warn('âš ï¸ ç°½åˆ°ç³»çµ±é¸å–®å…ƒç´ æœªæ‰¾åˆ°');
            }
        }

        // è™•ç†ç°½åˆ°ç³»çµ±é¸å–®é»æ“Š
        function handleAttendanceMenuClick(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('ğŸ“‹ ç°½åˆ°ç³»çµ±é¸å–®è¢«é»æ“Š');
            
            // è·³è½‰åˆ°ç°½åˆ°ç³»çµ±
            const attendanceUrl = 'https://liff.line.me/1657746214-wPgd2qQn';
            
            try {
                // æª¢æŸ¥ LIFF æ˜¯å¦å·²åˆå§‹åŒ–
                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    // åœ¨ LINE å…§ä½¿ç”¨ LIFF é–‹å•Ÿ
                    liff.openWindow({
                        url: attendanceUrl,
                        external: false
                    });
                    console.log('âœ… ä½¿ç”¨ LIFF åœ¨ LINE å…§é–‹å•Ÿç°½åˆ°ç³»çµ±');
                } else {
                    // å¦‚æœä¸åœ¨ LINE å…§æˆ– LIFF æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ä¸€èˆ¬æ–¹å¼é–‹å•Ÿ
                    window.open(attendanceUrl, '_blank', 'noopener,noreferrer');
                    console.log('âœ… ä½¿ç”¨ä¸€èˆ¬æ–¹å¼é–‹å•Ÿç°½åˆ°ç³»çµ±');
                }
            } catch (error) {
                console.error('âŒ é–‹å•Ÿç°½åˆ°ç³»çµ±å¤±æ•—:', error);
                // é™ç´šè™•ç†ï¼šä½¿ç”¨ä¸€èˆ¬æ–¹å¼é–‹å•Ÿ
                window.open(attendanceUrl, '_blank', 'noopener,noreferrer');
            }
            
            // æ·»åŠ é»æ“Šå‹•ç•«æ•ˆæœ
            const button = event.currentTarget.querySelector('.attendance-menu-button');
            if (button) {
                button.style.transform = 'translateY(-1px) scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 150);
            }
        }

        // é‡æ–°æ•´ç†æŒ‰éˆ•é»æ“Šè™•ç†å‡½æ•¸
        function handleRefreshClick(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('ğŸ”„ é‡æ–°æ•´ç†æŒ‰éˆ•è¢«é»æ“Š');
            forceRefresh();
        }


        // è¨ˆç®—æ¯ä½è¬›å¸«çš„ä¸‹ä¸€å€‹å³å°‡åˆ°ä¾†çš„èª²ç¨‹
        function getUpcomingEventsByInstructor() {
            const now = new Date();
            const upcomingEvents = {};
            
            // ç²å–æ‰€æœ‰æœ‰æ•ˆçš„æœªä¾†èª²ç¨‹
            const futureEvents = allEvents.filter(event => {
                if (!event || !event.start || !event.instructor) return false;
                const eventDate = new Date(event.start);
                return eventDate > now; // åªè€ƒæ…®æœªä¾†çš„èª²ç¨‹
            });
            
            // æŒ‰è¬›å¸«åˆ†çµ„ä¸¦æ‰¾åˆ°æ¯å€‹è¬›å¸«çš„ä¸‹ä¸€å€‹èª²ç¨‹
            futureEvents.forEach(event => {
                const instructor = event.instructor;
                if (!upcomingEvents[instructor]) {
                    upcomingEvents[instructor] = event;
                } else {
                    // æ¯”è¼ƒæ™‚é–“ï¼Œä¿ç•™æ›´æ—©çš„èª²ç¨‹
                    const currentUpcoming = new Date(upcomingEvents[instructor].start);
                    const newEvent = new Date(event.start);
                    if (newEvent < currentUpcoming) {
                        upcomingEvents[instructor] = event;
                    }
                }
            });
            
            console.log('ğŸ“… æ¯ä½è¬›å¸«çš„ä¸‹ä¸€å€‹èª²ç¨‹:', upcomingEvents);
            return upcomingEvents;
        }

        // æª¢æŸ¥èª²ç¨‹æ˜¯å¦ç‚ºå³å°‡åˆ°ä¾†çš„èª²ç¨‹
        function isUpcomingEvent(event) {
            if (!event || !event.start || !event.instructor) return false;
            
            const upcomingEvents = getUpcomingEventsByInstructor();
            const instructor = event.instructor;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè©²è¬›å¸«çš„ä¸‹ä¸€å€‹èª²ç¨‹
            if (upcomingEvents[instructor] && upcomingEvents[instructor].id === event.id) {
                return true;
            }
            
            return false;
        }

        // è¨ˆç®—è·é›¢èª²ç¨‹é–‹å§‹çš„æ™‚é–“
        function getTimeUntilEvent(event) {
            if (!event || !event.start) return null;
            
            const now = new Date();
            const eventDate = new Date(event.start);
            const timeDiff = eventDate - now;
            
            if (timeDiff <= 0) return null; // èª²ç¨‹å·²é–‹å§‹æˆ–çµæŸ
            
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days}å¤©${hours}å°æ™‚`;
            } else if (hours > 0) {
                return `${hours}å°æ™‚${minutes}åˆ†é˜`;
            } else {
                return `${minutes}åˆ†é˜`;
            }
        }

        // å¼·åˆ¶é‡æ–°æ•´ç†è¡Œäº‹æ›†
        async function forceRefresh() {
            const refreshButton = document.getElementById('refreshButton');
            const icon = refreshButton.querySelector('i');
            
            // æ·»åŠ è¼‰å…¥å‹•ç•«
            refreshButton.classList.add('loading');
            icon.style.animation = 'spin 1s linear infinite';
            
            try {
                console.log('ğŸ”„ é–‹å§‹å¼·åˆ¶é‡æ–°æ•´ç†è¡Œäº‹æ›†...');
                
                // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
                showLoadingAnimation();
                
                // é‡æ–°è¼‰å…¥èª²ç¨‹æ•¸æ“š
                await loadTodayEvents();
                
                // é‡æ–°ç¶å®šæ‰€æœ‰èª²ç¨‹ç›£è½å™¨
                bindViewButtons();
                updateViewButtonStates();
                
                // æ›´æ–°çµ±è¨ˆå’Œæ¸²æŸ“
                updateStats();
                renderEvents();
                
                // è‡ªå‹•æ»¾å‹•åˆ°è¡Œäº‹æ›†å€åŸŸ
                autoScrollToCalendar();
                
                console.log('âœ… è¡Œäº‹æ›†é‡æ–°æ•´ç†å®Œæˆ');
                
                // é¡¯ç¤ºæˆåŠŸæç¤º
                addLoadingLog('âœ… è¡Œäº‹æ›†å·²é‡æ–°æ•´ç†', 'success');
                
            } catch (error) {
                console.error('âŒ é‡æ–°æ•´ç†å¤±æ•—:', error);
                addLoadingLog('âŒ é‡æ–°æ•´ç†å¤±æ•—: ' + error.message, 'error');
            } finally {
                // ç§»é™¤è¼‰å…¥å‹•ç•«
                refreshButton.classList.remove('loading');
                icon.style.animation = '';
                
                // éš±è—è¼‰å…¥å‹•ç•«
                setTimeout(() => {
                    hideLoadingAnimation();
                }, 500);
            }
        }

        // é¡¯ç¤ºæŒ‡å®šæ­¥é©Ÿ
        function showStep(stepNumber) {
            console.log('è·³è½‰åˆ°æ­¥é©Ÿ:', stepNumber);
            
            // æ›´æ–°æ­¥é©Ÿç‹€æ…‹
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed', 'pending');
                
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
            
            // æ ¹æ“šæ­¥é©Ÿé¡¯ç¤º/éš±è—ç›¸é—œå…§å®¹
            if (stepNumber === 2) {
                // ç¬¬äºŒæ­¥ï¼šæŸ¥çœ‹è¡Œäº‹æ›† - ç¢ºä¿è¡Œäº‹æ›†å€åŸŸå¯è¦‹
                const calendarSection = document.querySelector('.calendar-section');
                if (calendarSection) {
                    calendarSection.style.display = 'block';
                }
                
                // è‡ªå‹•æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“ä»Šæ—¥æœ¬é€±æ¯æœˆæŒ‰éˆ•åˆ‡é½Šé ‚éƒ¨
                const viewButtons = document.querySelector('.view-buttons');
                if (viewButtons) {
                    // è¨ˆç®—è¦–åœ–æŒ‰éˆ•çš„ä½ç½®ï¼Œè®“æŒ‰éˆ•é½Šå¹³é ‚éƒ¨
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“æŒ‰éˆ•é½Šå¹³é ‚éƒ¨
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`å·²è‡ªå‹•æ»‘å‹•åˆ°è¦–åœ–æŒ‰éˆ•å€åŸŸï¼Œè®“ä»Šæ—¥æœ¬é€±æ¯æœˆæŒ‰éˆ•åˆ‡é½Šé ‚éƒ¨`);
                } else {
                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°è¦–åœ–æŒ‰éˆ•ï¼Œå‰‡æ»‘å‹•åˆ°ä¸»å…§å®¹å€åŸŸ
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`å·²è‡ªå‹•æ»‘å‹•åˆ°ä¸»å…§å®¹å€åŸŸï¼Œç¯©é¸å€å¡Šé«˜åº¦: ${controlHeight}px`);
                    }
                }
            }
        }


        // é«˜äº®è¦–åœ–æŒ‰éˆ•
        function highlightViewButton(viewName) {
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
            const allButtons = document.querySelectorAll('.view-buttons .btn');
            allButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '';
                btn.style.transition = 'all 0.3s ease';
            });
            
            // æ·»åŠ ç›®æ¨™æŒ‰éˆ•çš„ active ç‹€æ…‹
            const targetButton = document.querySelector(`[data-view="${viewName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
                
                // æ·»åŠ é«˜äº®å‹•ç•« - æ›´æ˜é¡¯çš„æ•ˆæœ
                targetButton.style.transform = 'scale(1.1)';
                targetButton.style.boxShadow = '0 6px 12px rgba(0, 123, 255, 0.4)';
                targetButton.style.transition = 'all 0.3s ease';
                targetButton.style.zIndex = '10';
                
                // æ·»åŠ è„ˆè¡å‹•ç•«
                targetButton.style.animation = 'buttonPulse 0.6s ease-out';
                
                setTimeout(() => {
                    targetButton.style.transform = 'scale(1.05)';
                    targetButton.style.boxShadow = '0 4px 8px rgba(0, 123, 255, 0.3)';
                    targetButton.style.animation = '';
                }, 300);
            }
        }

        // æ»‘å‹•åŠŸèƒ½å·²ç§»é™¤ - é¿å…èˆ‡æŒ‰éˆ•é»æ“Šè¡çª

        // è¨­ç½®èª²ç¨‹ç›£è½å™¨
        function setupEventListeners() {
            // æ»‘å‹•åŠŸèƒ½å·²ç§»é™¤
            
            // è¬›å¸«ç¯©é¸èª²ç¨‹ç›£è½å™¨ï¼ˆå„ªåŒ–ç‰ˆæœ¬ï¼‰
            const instructorSelect = document.getElementById('instructorSelect');
            if (instructorSelect) {
                // æ·»åŠ æ¨™è¨˜ä»¥é˜²æ­¢é‡è¤‡äº‹ä»¶è§¸ç™¼
                let isHandlingInstructorChange = false;
                
                instructorSelect.addEventListener('change', PerformanceOptimizer.debounce(function(event) {
                    if (isHandlingInstructorChange) {
                        console.log('â­ï¸ è·³éé‡è¤‡çš„è¬›å¸«é¸æ“‡è®Šæ›´äº‹ä»¶');
                        return;
                    }
                    
                    isHandlingInstructorChange = true;
                    
                    const target = event.target || this;
                    const selectedInstructor = target.value;
                    console.log('ğŸ“± è¬›å¸«é¸æ“‡è®Šæ›´:', selectedInstructor);
                    console.log('ğŸ” è¬›å¸«é¸æ“‡å™¨è©³ç´°ç‹€æ…‹:', {
                        value: selectedInstructor,
                        selectedIndex: target.selectedIndex,
                        options: target.options ? Array.from(target.options).map(opt => ({ value: opt.value, text: opt.text })) : 'options ä¸å¯ç”¨'
                    });
                    
                    if (selectedInstructor && selectedInstructor !== '') {
                        // ä½¿ç”¨é€²éšè¬›å¸«æ™ºèƒ½ç¯©é¸åŠŸèƒ½
                        const instructorEvents = allEvents.filter(event => 
                            event && event.instructor === selectedInstructor
                        );
                        
                        console.log(`ğŸ” è¬›å¸« "${selectedInstructor}" çš„èª²ç¨‹æ•¸é‡:`, instructorEvents.length);
                        
                        // ä½¿ç”¨é€²éšæ™ºèƒ½ç¯©é¸
                        const smartResult = advancedSmartViewSelection(instructorEvents, selectedInstructor);
                        currentView = smartResult.view;
                        window.currentView = smartResult.view;
                        
                        console.log(`ğŸ§  è¬›å¸«é€²éšæ™ºèƒ½ç¯©é¸çµæœ: ${smartResult.view} (${smartResult.reason})`);
                        
                        // é¡¯ç¤ºè©³ç´°çš„æ™ºèƒ½ç¯©é¸æç¤º
                        showAdvancedSmartFilterNotification(smartResult);
                        
                    } else {
                        // é¸æ“‡å…¨éƒ¨è¬›å¸«æ™‚ä½¿ç”¨é€²éšå…¨å±€æ™ºèƒ½ç¯©é¸
                        console.log('ğŸ”„ é¸æ“‡å…¨éƒ¨è¬›å¸«ï¼Œä½¿ç”¨é€²éšå…¨å±€æ™ºèƒ½ç¯©é¸');
                        const smartResult = advancedSmartViewSelection(allEvents, 'å…¨éƒ¨è¬›å¸«');
                        currentView = smartResult.view;
                        window.currentView = smartResult.view;
                        
                        console.log(`ğŸ§  å…¨å±€é€²éšæ™ºèƒ½ç¯©é¸çµæœ: ${smartResult.view} (${smartResult.reason})`);
                        
                        // é¡¯ç¤ºè©³ç´°çš„æ™ºèƒ½ç¯©é¸æç¤º
                        showAdvancedSmartFilterNotification(smartResult);
                    }
                    
                    // æ›´æ–°UIç‹€æ…‹
                    updateViewButtonStates();
                    updateTimeFilterOptions(); // æ›´æ–°æ™‚æ®µç¯©é¸é¸é …
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // è‡ªå‹•æ»¾å‹•åˆ°è¦–åœ–æŒ‰éˆ•
                    
                    console.log('ğŸ“± è¬›å¸«é¸æ“‡å¾Œæ™ºæ…§åˆ‡æ›è¦–åœ–:', currentView);
                    console.log('ğŸ¯ æ™ºèƒ½ç¯©é¸å®Œæˆï¼Œç•¶å‰è¦–åœ–:', currentView);
                    
                    // é‡ç½®æ¨™è¨˜
                    setTimeout(() => {
                        isHandlingInstructorChange = false;
                    }, 100);
                }, 200)); // é˜²æŠ–å»¶é²
            }
            
            // æ™‚æ®µç¯©é¸èª²ç¨‹ç›£è½å™¨ï¼ˆå„ªåŒ–ç‰ˆæœ¬ï¼‰
            const timeFilter = document.getElementById('timeFilter');
            if (timeFilter) {
                timeFilter.addEventListener('change', PerformanceOptimizer.debounce(function() {
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // è‡ªå‹•æ»¾å‹•åˆ°è¦–åœ–æŒ‰éˆ•
                }, 200)); // é˜²æŠ–å»¶é²
            }
            
            // æ—¥æœŸç¯©é¸èª²ç¨‹ç›£è½å™¨
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // è‡ªå‹•æ»¾å‹•åˆ°è¦–åœ–æŒ‰éˆ•
                });
            }
            
            
            
            
            
            // è¨­ç½®åˆå§‹é¸ä¸­ç‹€æ…‹ï¼ˆç§»é™¤å»¶é²ï¼‰
            updateViewButtonStates();
            
            // å¿«é€Ÿç¯©é¸åŠŸèƒ½å·²ç§»é™¤
            
            // ç¶å®šç”¨æˆ¶æŒ‰éˆ•èª²ç¨‹ç›£è½å™¨
            const bindUserBtn = document.getElementById('bindUserBtn');
            if (bindUserBtn) {
                bindUserBtn.addEventListener('click', bindUser);
            }
        }



        // ç”Ÿæˆéš¨æ©Ÿé¦¬å¡é¾é¡è‰²
        function generateRandomMacaronColor() {
            const macaronColors = [
                'rgba(255, 182, 193, 0.8)', 'rgba(116, 185, 255, 0.8)', 'rgba(255, 223, 102, 0.8)', 
                'rgba(180, 167, 214, 0.8)', 'rgba(0, 184, 148, 0.8)', 'rgba(255, 192, 203, 0.8)',
                'rgba(162, 155, 254, 0.8)', 'rgba(85, 239, 196, 0.8)', 'rgba(255, 118, 117, 0.8)', 
                'rgba(108, 92, 231, 0.8)', 'rgba(232, 67, 147, 0.8)', 'rgba(0, 206, 201, 0.8)',
                'rgba(255, 159, 67, 0.8)', 'rgba(255, 107, 107, 0.8)', 'rgba(46, 204, 113, 0.8)',
                'rgba(155, 89, 182, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(241, 196, 15, 0.8)'
            ];
            return macaronColors[Math.floor(Math.random() * macaronColors.length)];
        }

        // è¼‰å…¥è¨­ç½®
        function loadSettings() {
            const saved = localStorage.getItem('calendarSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                colorSettings = { ...colorSettings, ...settings.colors };
                instructorColors = settings.instructorColors || {};
                applyColorSettings();
            }
            // æ³¨æ„ï¼šè¬›å¸«é¡è‰²å°‡åœ¨ loadEvents å®Œæˆå¾Œç”Ÿæˆ
        }

        // ç‚ºè¬›å¸«ç”Ÿæˆéš¨æ©Ÿé¦¬å¡é¾é¡è‰²
        function generateRandomInstructorColors() {
            allInstructors.forEach(instructor => {
                if (!instructorColors[instructor]) {
                    instructorColors[instructor] = generateRandomMacaronColor();
                }
            });
        }

        // å„²å­˜è¨­ç½®
        function saveSettings() {
            // æ›´æ–°é¡è‰²è¨­ç½®ï¼ˆå°‡ hex è½‰æ›ç‚º rgbaï¼‰
            colorSettings.esm = hexToRgba(document.getElementById('esmColor').value, 0.8);
            colorSettings.spm = hexToRgba(document.getElementById('spmColor').value, 0.8);
            colorSettings.boost = hexToRgba(document.getElementById('boostColor').value, 0.8);
            colorSettings.spike = hexToRgba(document.getElementById('spikeColor').value, 0.8);
            colorSettings.ev3 = hexToRgba(document.getElementById('ev3Color').value, 0.8);
            colorSettings.minecraft = hexToRgba(document.getElementById('minecraftColor').value, 0.8);

            const settings = {
                colors: colorSettings,
                instructorColors: instructorColors
            };
            localStorage.setItem('calendarSettings', JSON.stringify(settings));
            applyColorSettings();
            closeSettings();
        }

        // æ‡‰ç”¨é¡è‰²è¨­ç½®
        function applyColorSettings() {
            // æ›´æ–°CSSè®Šæ•¸
            document.documentElement.style.setProperty('--esm-color', colorSettings.esm);
            document.documentElement.style.setProperty('--spm-color', colorSettings.spm);
            document.documentElement.style.setProperty('--boost-color', colorSettings.boost);
            document.documentElement.style.setProperty('--spike-color', colorSettings.spike);
            document.documentElement.style.setProperty('--ev3-color', colorSettings.ev3);
            document.documentElement.style.setProperty('--minecraft-color', colorSettings.minecraft);
            
            // é‡æ–°æ¸²æŸ“èª²ç¨‹
            if (allEvents.length > 0) {
                renderEvents();
            }
        }

        // æ‰“é–‹è¨­ç½®ç•«é¢
        function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            
            // ç¢ºä¿è¬›å¸«é¡è‰²å·²ç¶“ç”Ÿæˆ
            if (allInstructors && allInstructors.length > 0) {
                generateRandomInstructorColors();
            }
            
            populateSettingsModal();
        }

        // å¡«å……è¨­ç½®æ¨¡æ…‹æ¡†
        function populateSettingsModal() {
            // è¨­ç½®èª²ç¨‹é¡å‹é¡è‰²ï¼ˆå°‡ rgba è½‰æ›ç‚º hexï¼‰
            document.getElementById('esmColor').value = rgbaToHex(colorSettings.esm);
            document.getElementById('spmColor').value = rgbaToHex(colorSettings.spm);
            document.getElementById('boostColor').value = rgbaToHex(colorSettings.boost);
            document.getElementById('spikeColor').value = rgbaToHex(colorSettings.spike);
            document.getElementById('ev3Color').value = rgbaToHex(colorSettings.ev3);
            document.getElementById('minecraftColor').value = rgbaToHex(colorSettings.minecraft);
            
            // å¡«å……è¬›å¸«é¡è‰²è¨­ç½®
            populateInstructorColorSettings();
        }

        // é—œé–‰è¨­ç½®ç•«é¢
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }

        // å¡«å……è¬›å¸«é¡è‰²è¨­ç½®
        function populateInstructorColorSettings() {
            const container = document.getElementById('instructorColorGroup');
            container.innerHTML = '';
            
            // ç¢ºä¿ allInstructors å·²ç¶“è¼‰å…¥
            if (!allInstructors || allInstructors.length === 0) {
                console.log('è¬›å¸«åˆ—è¡¨å°šæœªè¼‰å…¥ï¼Œç„¡æ³•å¡«å……é¡è‰²è¨­ç½®');
                return;
            }
            
            console.log('å¡«å……è¬›å¸«é¡è‰²è¨­ç½®ï¼Œè¬›å¸«åˆ—è¡¨:', allInstructors);
            console.log('ç•¶å‰è¬›å¸«é¡è‰²:', instructorColors);
            
            allInstructors.forEach(instructor => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-picker-item'; // ä½¿ç”¨èˆ‡æ•™æ¡ˆé¡å‹é¡è‰²ç›¸åŒçš„ class
                const currentColor = instructorColors[instructor] || generateRandomMacaronColor();
                const hexColor = rgbaToHex(currentColor);
                console.log(`è¬›å¸« ${instructor} çš„é¡è‰²: ${currentColor} -> ${hexColor}`);
                
                colorItem.innerHTML = `
                    <label>${instructor}</label>
                    <input type="color" class="color-picker" 
                           id="instructor_${instructor}" 
                           value="${hexColor}"
                           onchange="updateInstructorColor('${instructor}', this.value)">
                `;
                container.appendChild(colorItem);
            });
        }

        // æ›´æ–°è¬›å¸«é¡è‰²
        function updateInstructorColor(instructor, color) {
            // å°‡ hex é¡è‰²è½‰æ›ç‚º rgba æ ¼å¼
            const rgbaColor = hexToRgba(color, 0.8);
            instructorColors[instructor] = rgbaColor;
        }

        // å°‡ hex é¡è‰²è½‰æ›ç‚º rgba æ ¼å¼
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // å°‡ rgba é¡è‰²è½‰æ›ç‚º hex æ ¼å¼ï¼ˆç”¨æ–¼é¡è‰²é¸æ“‡å™¨ï¼‰
        function rgbaToHex(rgba) {
            const values = rgba.match(/\d+/g);
            if (values && values.length >= 3) {
                const r = parseInt(values[0]);
                const g = parseInt(values[1]);
                const b = parseInt(values[2]);
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            return '#000000';
        }

// å„ªåŒ–çš„è¼‰å…¥ç•¶æ—¥èª²ç¨‹ï¼ˆå«å¿«å–æ©Ÿåˆ¶ï¼‰
async function loadTodayEvents() {
    try {
        console.log('ğŸš€ é–‹å§‹å„ªåŒ–è¼‰å…¥å®Œæ•´èª²ç¨‹æ•¸æ“š...');
        
        // æª¢æŸ¥å¿«å–
        const cacheKey = 'calendar_events_cache';
        const cacheTime = 'calendar_events_cache_time';
        const cacheExpiry = 5 * 60 * 1000; // 5åˆ†é˜å¿«å–
        
        const cachedData = localStorage.getItem(cacheKey);
        const cacheTimestamp = localStorage.getItem(cacheTime);
        const now = Date.now();
        
        if (cachedData && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
            console.log('ğŸ“¦ ä½¿ç”¨å¿«å–çš„èª²ç¨‹æ•¸æ“š');
            addLoadingLog('ğŸ“¦ ä½¿ç”¨å¿«å–çš„èª²ç¨‹æ•¸æ“š', 'info');
            
            const data = JSON.parse(cachedData);
            if (data.success) {
                processEventsData(data);
                return;
            }
        }
        
        addLoadingLog('ğŸŒ æ­£åœ¨é€£æ¥ CalDAV ä¼ºæœå™¨...', 'info');
        
        // ä½¿ç”¨å„ªåŒ–çš„APIè«‹æ±‚
        const response = await apiOptimizer.fetchWithRetry('/api/events', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });
        
        addLoadingLog('ğŸ“¡ æ­£åœ¨ç²å–è¡Œäº‹æ›†è³‡æ–™...', 'info');
        
        const data = response.data || response;
        
        if (data.success) {
            // å¿«å–æ•¸æ“š
            localStorage.setItem(cacheKey, JSON.stringify(data));
            localStorage.setItem(cacheTime, now.toString());
            
            processEventsData(data);
        } else {
            showError('è¼‰å…¥èª²ç¨‹å¤±æ•—: ' + data.message);
        }
            } catch (error) {
                console.error('è¼‰å…¥èª²ç¨‹éŒ¯èª¤:', error);
                showError('ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨');
    }
}


        // è™•ç†äº‹ä»¶æ•¸æ“šï¼ˆå„ªåŒ–ç‰ˆæœ¬ï¼‰
        function processEventsData(data) {
            addLoadingLog(`ğŸ“Š æˆåŠŸç²å– ${data.data.length} å€‹èª²ç¨‹`, 'success');
            
            // éæ¿¾æ‰ null å€¼å’Œç„¡æ•ˆèª²ç¨‹
            allEvents = data.data.filter(event => {
                if (!event) {
                    console.warn('âš ï¸ processEventsData: ç™¼ç¾ null èª²ç¨‹ï¼Œå·²éæ¿¾');
                    return false;
                }
                if (!event.start || !event.end || !event.title || !event.instructor) {
                    console.warn('âš ï¸ processEventsData: èª²ç¨‹ç¼ºå°‘å¿…è¦å±¬æ€§ï¼Œå·²éæ¿¾', event);
                    return false;
                }
                return true;
            });
            
            console.log('ğŸ” processEventsData: allEvents éæ¿¾å®Œæˆï¼Œæ•¸é‡:', allEvents.length);
            
            // å¡«å……è¬›å¸«åˆ—è¡¨
            allInstructors = [...new Set(allEvents.map(event => event.instructor).filter(Boolean))];
            console.log('ğŸ” processEventsData: allInstructors å¡«å……å®Œæˆ:', allInstructors);
            addLoadingLog(`ğŸ‘¥ ç™¼ç¾ ${allInstructors.length} ä½è¬›å¸«`, 'info');
            
            // ç‚ºæ–°è¬›å¸«ç”Ÿæˆéš¨æ©Ÿé¦¬å¡é¾é¡è‰²ï¼ˆå¦‚æœæ²’æœ‰ä¿å­˜çš„è¨­ç½®ï¼‰
            if (Object.keys(instructorColors).length === 0) {
                addLoadingLog('ğŸ¨ æ­£åœ¨ç”Ÿæˆè¬›å¸«é¡è‰²é…ç½®...', 'info');
                generateRandomInstructorColors();
            }
            
            addLoadingLog('ğŸ”„ æ­£åœ¨æ¸²æŸ“èª²ç¨‹åˆ—è¡¨...', 'info');
            populateInstructorDropdown();
            renderEvents();
            updateStats();
            
            console.log(`âœ… èª²ç¨‹æ•¸æ“šè™•ç†å®Œæˆ: ${allEvents.length} å€‹èª²ç¨‹`);
            addLoadingLog(`âœ… è¼‰å…¥å®Œæˆï¼å…± ${allEvents.length} å€‹èª²ç¨‹`, 'success');
            hideLoadingMessage();
        }

        // é¸æ“‡åŒ¹é…çš„è¬›å¸«ï¼ˆå„ªåŒ–ç‰ˆæœ¬ï¼‰
        function selectMatchedTeacher(matchedTeacher) {
            const instructorSelect = document.getElementById('instructorSelect');
            
            if (instructorSelect) {
                // æ¨¡ç³Šæ¯”å°è¬›å¸«é¸é …
                const matchedOption = findBestMatchingOption(instructorSelect, matchedTeacher.name);
                
                if (matchedOption) {
                    instructorSelect.value = matchedOption.value;
                    console.log('è‡ªå‹•é¸æ“‡è¬›å¸«:', matchedOption.value);
                    
                    // ä¸åœ¨æ­¤è™•è§¸ç™¼äº‹ä»¶ï¼Œè®“è¬›å¸«æ¯”å°å®Œæˆå¾Œçš„é‚è¼¯çµ±ä¸€è™•ç†
                    console.log('ğŸ¯ è¬›å¸«é¸æ“‡å·²è¨­ç½®ï¼Œç­‰å¾…çµ±ä¸€è§¸ç™¼æ™ºæ…§ç¯©é¸');
                    
                    // è·³è½‰åˆ°ç¬¬äºŒæ­¥é©Ÿ
                    showStep(2);
                    
                    showMatchingProcess(`âœ… è‡ªå‹•é¸æ“‡è¬›å¸«æˆåŠŸ: ${matchedOption.value}`, 'success');
                    addLoadingLog(`ğŸ¯ è‡ªå‹•é¸æ“‡è¬›å¸«: ${matchedOption.value}`, 'success');
                } else {
                    console.log('æœªæ‰¾åˆ°åŒ¹é…çš„è¬›å¸«é¸é …');
                    showMatchingProcess('âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„è¬›å¸«é¸é …', 'warning');
                    addLoadingLog('âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„è¬›å¸«é¸é …', 'warning');
                }
            }
        }

        // å„ªåŒ–çš„äº‹ä»¶è¼‰å…¥ï¼ˆCALDAVé€Ÿåº¦å„ªåŒ–ç‰ˆï¼‰
        async function loadEventsOptimized() {
            try {
                console.log('ğŸš€ é–‹å§‹CALDAVé€Ÿåº¦å„ªåŒ–è¼‰å…¥äº‹ä»¶è³‡æ–™...');
                
                // æª¢æŸ¥CALDAVå°ˆç”¨å¿«å–
                const caldavCacheKey = 'caldav_events_cache';
                const caldavCacheTime = 'caldav_events_cache_time';
                const caldavCacheExpiry = 8 * 60 * 1000; // 8åˆ†é˜CALDAVå¿«å–
                
                const cachedData = localStorage.getItem(caldavCacheKey);
                const cacheTimestamp = localStorage.getItem(caldavCacheTime);
                const now = Date.now();
                
                if (cachedData && cacheTimestamp && (now - parseInt(cacheTimestamp)) < caldavCacheExpiry) {
                    console.log('ğŸ“¦ ä½¿ç”¨CALDAVå¿«å–çš„äº‹ä»¶æ•¸æ“š');
                    addLoadingLog('ğŸ“¦ ä½¿ç”¨CALDAVå¿«å–çš„äº‹ä»¶æ•¸æ“š', 'info');
                    
                    const data = JSON.parse(cachedData);
                    if (data.success) {
                        processEventsData(data);
                        return { success: true, fromCache: true };
                    }
                }
                
                addLoadingLog('ğŸŒ æ­£åœ¨é€£æ¥ CalDAV ä¼ºæœå™¨ï¼ˆå„ªåŒ–ç‰ˆï¼‰...', 'info');
                
                // ä½¿ç”¨å„ªåŒ–çš„APIè«‹æ±‚ï¼ˆCALDAVå°ˆç”¨å„ªåŒ–ï¼‰
                const response = await apiOptimizer.fetchWithRetry('/api/events', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Accept-Encoding': 'gzip, deflate, br',
                        'Connection': 'keep-alive'
                    }
                });
                
                addLoadingLog('ğŸ“¡ æ­£åœ¨ç²å–è¡Œäº‹æ›†è³‡æ–™ï¼ˆå„ªåŒ–ç‰ˆï¼‰...', 'info');
                
                const data = response.data || response;
                
                if (data.success) {
                    // è¨­ç½®CALDAVå°ˆç”¨å¿«å–
                    localStorage.setItem(caldavCacheKey, JSON.stringify(data));
                    localStorage.setItem(caldavCacheTime, now.toString());
                    
                    // åŒæ™‚æ›´æ–°ä¸€èˆ¬å¿«å–
                    const generalCacheKey = 'calendar_events_cache';
                    const generalCacheTime = 'calendar_events_cache_time';
                    localStorage.setItem(generalCacheKey, JSON.stringify(data));
                    localStorage.setItem(generalCacheTime, now.toString());
                    
                    processEventsData(data);
                    return { success: true, fromCache: false };
                } else {
                    throw new Error(data.message || 'è¼‰å…¥äº‹ä»¶å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥äº‹ä»¶éŒ¯èª¤:', error);
                addLoadingLog('âŒ è¼‰å…¥äº‹ä»¶å¤±æ•—: ' + error.message, 'error');
                throw error;
            }
        }

        // å„ªåŒ–çš„LINEç”¨æˆ¶åˆå§‹åŒ–
        async function initLineUserOptimized() {
            console.log('é–‹å§‹å„ªåŒ–åˆå§‹åŒ–LINEç”¨æˆ¶...');
            
            // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç’°å¢ƒ
            const isLocal = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' || 
                           window.location.hostname === '0.0.0.0' ||
                           window.location.protocol === 'file:';
            
            if (isLocal) {
                console.log('ğŸŒ æª¢æ¸¬åˆ°æœ¬åœ°ç’°å¢ƒï¼Œè·³é LINE èªè­‰');
                addLoadingLog('ğŸŒ æœ¬åœ°ç’°å¢ƒæ¨¡å¼ï¼Œè·³é LINE èªè­‰', 'info');
                
                // è¨­ç½®æ¨¡æ“¬ç”¨æˆ¶è³‡æ–™
                currentUser = {
                    userId: 'local-test-user',
                    displayName: 'æœ¬åœ°æ¸¬è©¦ç”¨æˆ¶',
                    pictureUrl: ''
                };
                
                updateUserDisplay();
                console.log('æœ¬åœ°æ¨¡å¼ç”¨æˆ¶é¡¯ç¤ºå®Œæˆ');
                return { success: true, local: true };
            }
            
            // å»¶é²è¼‰å…¥LIFF SDK
            try {
                await PerformanceOptimizer.loadLIFFSDK();
                console.log('LIFF SDK è¼‰å…¥å®Œæˆ');
            } catch (error) {
                console.error('LIFF SDK è¼‰å…¥å¤±æ•—:', error);
                addLoadingLog('âŒ LIFF SDK è¼‰å…¥å¤±æ•—', 'error');
                return { success: false, error: error.message };
            }
            
            return new Promise((resolve) => {
                // è¨­ç½®è¶…æ™‚ä¿è­·ï¼ˆ5ç§’ï¼‰
                const timeout = setTimeout(() => {
                    console.warn('LIFF åˆå§‹åŒ–è¶…æ™‚');
                    addLoadingLog('â° LINE ç™»å…¥è¶…æ™‚ï¼Œè«‹æ‰‹å‹•ç¶å®š', 'warning');
                    showBindButton();
                    resolve({ success: false, timeout: true });
                }, 5000);
                
                // åˆå§‹åŒ–LIFF
                liff.init({
                    liffId: '1657746214-qp0y8NwZ',
                    withLoginOnExternalBrowser: true
                }).then(() => {
                    console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                    
                    if (liff.isLoggedIn()) {
                        liff.getProfile().then(async (profile) => {
                            clearTimeout(timeout);
                            console.log('ç²å–åˆ°ç”¨æˆ¶è³‡æ–™:', profile);
                            
                            currentUser = {
                                userId: profile.userId,
                                displayName: profile.displayName,
                                pictureUrl: profile.pictureUrl
                            };
                            
                            updateUserDisplay();
                            console.log('ç”¨æˆ¶é¡¯ç¤ºæ›´æ–°å®Œæˆ');
                            resolve({ success: true, user: currentUser });
                        }).catch(error => {
                            clearTimeout(timeout);
                            console.error('ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
                            addLoadingLog('âŒ ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—', 'error');
                            resolve({ success: false, error: error.message });
                        });
                    } else {
                        clearTimeout(timeout);
                        console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œé¡¯ç¤ºç¶å®šæŒ‰éˆ•');
                        showBindButton();
                        resolve({ success: false, notLoggedIn: true });
                    }
                }).catch(error => {
                    clearTimeout(timeout);
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                    addLoadingLog('âŒ LIFF åˆå§‹åŒ–å¤±æ•—', 'error');
                    resolve({ success: false, error: error.message });
                });
            });
        }

        // è¼‰å…¥èª²ç¨‹è³‡æ–™ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
        async function loadEvents() {
            return loadTodayEvents();
        }

        // è¼‰å…¥æ—¥èªŒç®¡ç†
        let loadingLogs = [];
        
        function addLoadingLog(message, type = 'info') {
            const logItem = {
                message,
                type,
                timestamp: new Date().toLocaleTimeString()
            };
            loadingLogs.push(logItem);
            
            const logsContainer = document.getElementById('loadingLogs');
            if (logsContainer) {
                const logElement = document.createElement('div');
                logElement.className = `loading-log-item ${type}`;
                
                const icon = {
                    'success': 'âœ…',
                    'warning': 'âš ï¸',
                    'error': 'âŒ',
                    'info': 'â„¹ï¸'
                }[type] || 'â„¹ï¸';
                
                logElement.innerHTML = `
                    <span class="loading-log-icon">${icon}</span>
                    <span>[${logItem.timestamp}] ${message}</span>
                `;
                
                logsContainer.appendChild(logElement);
                
                // è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°æ—¥èªŒ
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        // é¡¯ç¤ºè¼‰å…¥é€²åº¦æç¤º
        function showLoadingMessage(message) {
            addLoadingLog(message, 'info');
            // ç§»é™¤ç¾æœ‰çš„è¼‰å…¥æç¤º
            const existingMessage = document.getElementById('loading-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // å‰µå»ºè¼‰å…¥æç¤ºå…ƒç´ 
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 123, 255, 0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            loadingDiv.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                ${message}
            `;
            
            document.body.appendChild(loadingDiv);
        }

        // éš±è—è¼‰å…¥é€²åº¦æç¤º
        function hideLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (loadingMessage.parentNode) {
                        loadingMessage.remove();
                    }
                }, 300);
            }
        }

        // å¡«å……è¬›å¸«ä¸‹æ‹‰é¸å–®
        async function populateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            const currentValue = select.value; // ä¿å­˜ç•¶å‰é¸æ“‡
            
            console.log('ğŸ”„ å¡«å……è¬›å¸«ä¸‹æ‹‰é¸å–®ï¼Œç•¶å‰é¸æ“‡:', currentValue);
            console.log('ğŸ”„ å¯ç”¨è¬›å¸«åˆ—è¡¨:', allInstructors);
            
            try {
            select.innerHTML = '<option value="">å…¨éƒ¨è¬›å¸«</option>';
            
                let instructors = [];
                
                // æ–¹æ³•1: ä½¿ç”¨ allInstructors
                if (allInstructors && allInstructors.length > 0) {
                    console.log('âœ… ä½¿ç”¨ allInstructorsï¼Œæ•¸é‡:', allInstructors.length);
                    instructors = [...allInstructors];
                } else {
                    // æ–¹æ³•2: ç›´æ¥å¾ API ç²å–ä¸¦æå–è¬›å¸«åˆ—è¡¨
                    console.log('âš ï¸ allInstructors ç‚ºç©ºï¼Œç›´æ¥å¾ API ç²å–è¬›å¸«åˆ—è¡¨');
                    try {
                        const response = await fetch('/api/events');
                        const data = await response.json();
                        
                        if (data.success && data.data) {
                            instructors = [...new Set(data.data
                                .filter(event => event && event.instructor)
                                .map(event => event.instructor)
                            )].sort();
                            
                            console.log('ğŸ“¡ å¾ API ç²å–çš„è¬›å¸«åˆ—è¡¨:', instructors);
                        } else {
                            // æ–¹æ³•3: ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„æ¸¬è©¦è¬›å¸«
                            console.log('âš ï¸ API ç²å–å¤±æ•—ï¼Œä½¿ç”¨æ¸¬è©¦è¬›å¸«');
                            instructors = ['AGNES', 'BELLA', 'TIM', 'ALICE'];
                        }
                    } catch (apiError) {
                        console.error('âŒ API èª¿ç”¨å¤±æ•—:', apiError);
                        // æ–¹æ³•3: ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„æ¸¬è©¦è¬›å¸«
                        instructors = ['AGNES', 'BELLA', 'TIM', 'ALICE'];
                    }
                }
                
                // æ’åºè¬›å¸«åˆ—è¡¨ï¼šå·²é¸æ“‡çš„è¬›å¸«æ’åœ¨å‰é¢
                if (currentValue && instructors.includes(currentValue)) {
                    // å°‡ç•¶å‰é¸æ“‡çš„è¬›å¸«ç§»åˆ°æœ€å‰é¢
                    instructors = [currentValue, ...instructors.filter(inst => inst !== currentValue)];
                    console.log('ğŸ”„ å·²é¸æ“‡è¬›å¸«å„ªå…ˆæ’åº:', instructors);
                }
                
                // å‰µå»ºé¸é …
                instructors.forEach(instructor => {
                    const option = document.createElement('option');
                    option.value = instructor;
                    option.textContent = instructor;
                    select.appendChild(option);
                });
                
                // æ¢å¾©ä¹‹å‰çš„é¸æ“‡
                if (currentValue) {
                    select.value = currentValue;
                    console.log('ğŸ”„ æ¢å¾©è¬›å¸«é¸æ“‡:', currentValue);
                }
                
                console.log('âœ… populateInstructorDropdown åŸ·è¡Œå®Œæˆï¼Œè¬›å¸«é¸é …æ•¸é‡:', select.options.length);
            } catch (error) {
                console.error('âŒ populateInstructorDropdown åŸ·è¡Œå¤±æ•—:', error);
                // å³ä½¿å¤±æ•—ä¹Ÿè¦ç¢ºä¿æœ‰åŸºæœ¬é¸é …
                select.innerHTML = '<option value="">å…¨éƒ¨è¬›å¸«</option><option value="ERROR">ç™¼ç”ŸéŒ¯èª¤</option><option value="AGNES">[æ¸¬è©¦] AGNES</option><option value="BELLA">[æ¸¬è©¦] BELLA</option>';
            }
        }

        // æ›´æ–°è¬›å¸«ä¸‹æ‹‰é¸å–®ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´å€‹ç•«é¢ï¼‰
        function updateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            const currentValue = select.value;
            
            // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆé™¤äº†"å…¨éƒ¨è¬›å¸«"ï¼‰
            select.innerHTML = '<option value="">å…¨éƒ¨è¬›å¸«</option>';

            // æ·»åŠ æ‰€æœ‰è¬›å¸«é¸é …
            allInstructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor;
                option.textContent = instructor;
                select.appendChild(option);
            });
            
            // æ¢å¾©ä¹‹å‰é¸ä¸­çš„å€¼
            if (currentValue && allInstructors.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // æ›´æ–°æ™‚æ®µç¯©é¸é¸é …ï¼ˆæ™ºæ…§ç®—æ³•ï¼‰
        function updateTimeFilterOptions() {
            const timeFilter = document.getElementById('timeFilter');
            const instructorFilter = document.getElementById('instructorSelect').value;
            
            if (!timeFilter) return;
            
            // ä¿å­˜ç•¶å‰é¸æ“‡
            const currentValue = timeFilter.value;
            
            // æ¸…ç©ºç¾æœ‰é¸é …
            timeFilter.innerHTML = '<option value="">å…¨éƒ¨æ™‚æ®µ</option>';
            
            // ç²å–è¦çµ±è¨ˆçš„èª²ç¨‹ï¼ˆæ ¹æ“šè¬›å¸«ç¯©é¸ï¼‰
            let eventsToAnalyze = allEvents;
            if (instructorFilter) {
                eventsToAnalyze = allEvents.filter(event => 
                    event && event.instructor === instructorFilter
                );
            }
            
            // çµ±è¨ˆæ™‚æ®µåˆ†å¸ƒ
            const timeSlots = {
                morning: 0,
                afternoon: 0,
                evening: 0
            };
            
            eventsToAnalyze.forEach(event => {
                if (event.start) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    
                    if (hour >= 6 && hour < 12) {
                        timeSlots.morning++;
                    } else if (hour >= 12 && hour < 18) {
                        timeSlots.afternoon++;
                    } else if (hour >= 18 && hour < 24) {
                        timeSlots.evening++;
                    }
                }
            });
            
            // åªæ·»åŠ æœ‰èª²ç¨‹çš„æ™‚æ®µé¸é …
            if (timeSlots.morning > 0) {
                const option = document.createElement('option');
                option.value = 'morning';
                option.textContent = `ä¸Šåˆ (${timeSlots.morning})`;
                timeFilter.appendChild(option);
            }
            
            if (timeSlots.afternoon > 0) {
                const option = document.createElement('option');
                option.value = 'afternoon';
                option.textContent = `ä¸‹åˆ (${timeSlots.afternoon})`;
                timeFilter.appendChild(option);
            }
            
            if (timeSlots.evening > 0) {
                const option = document.createElement('option');
                option.value = 'evening';
                option.textContent = `æ™šä¸Š (${timeSlots.evening})`;
                timeFilter.appendChild(option);
            }
            
            console.log('ğŸ• æ™ºæ…§æ™‚æ®µç¯©é¸æ›´æ–°:', timeSlots, 'è¬›å¸«:', instructorFilter || 'å…¨éƒ¨');
            
            // æ¢å¾©ä¹‹å‰çš„é¸æ“‡ï¼ˆå¦‚æœè©²é¸é …ä»ç„¶å­˜åœ¨ï¼‰
            if (currentValue && timeFilter.querySelector(`option[value="${currentValue}"]`)) {
                timeFilter.value = currentValue;
            } else {
                timeFilter.value = '';
            }
        }

        // è¦–åœ–æŒ‰éˆ•é»æ“Šè™•ç†å‡½æ•¸
        function handleViewButtonClick(e) {
            console.log('ğŸ¯ handleViewButtonClick è¢«èª¿ç”¨', {
                eventType: e.type,
                target: this,
                dataView: this.getAttribute('data-view'),
                currentView: currentView,
                timestamp: new Date().toISOString()
            });
            
            // é˜²æ­¢æ»‘å‹•èª²ç¨‹å¹²æ“¾é»æ“Š
            e.preventDefault();
            e.stopPropagation();
            
            const view = this.getAttribute('data-view');
            console.log(`ğŸ“± æŒ‰éˆ•é»æ“Šï¼šåˆ‡æ›åˆ° ${view}`, {
                eventType: e.type,
                target: this,
                currentView: currentView,
                buttonText: this.textContent,
                buttonClass: this.className
            });
            
            // è§¸ç™¼æŒ‰éˆ•é«˜äº®å‹•ç•«
            highlightViewButton(view);
            
            // åˆ‡æ›è¦–åœ–
            switchView(view);
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹å’Œé‡æ–°æ¸²æŸ“ï¼ˆç§»é™¤å»¶é²ï¼‰
            updateViewButtonStates();
            updateStats();
            renderEvents();
            autoScrollToViewButtons(); // è‡ªå‹•æ»¾å‹•åˆ°è¦–åœ–æŒ‰éˆ•
            console.log(`ğŸ“± è¦–åœ–å·²åˆ‡æ›åˆ° ${view}ï¼Œèª²ç¨‹å·²é‡æ–°æ¸²æŸ“`);
        }

        // ç‚ºè¦–åœ–æŒ‰éˆ•æ·»åŠ èª²ç¨‹ç›£è½å™¨
        function bindViewButtons() {
            console.log('ğŸ”— é–‹å§‹ç¶å®šè¦–åœ–æŒ‰éˆ•...');
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            console.log(`ğŸ”— æ‰¾åˆ° ${viewButtons.length} å€‹è¦–åœ–æŒ‰éˆ•`);
            
            // æª¢æŸ¥ç”¨æˆ¶ä»£ç†
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
            console.log('ğŸ“± è¨­å‚™æª¢æ¸¬:', { userAgent, isIOS, isSafari });
            
            if (viewButtons.length === 0) {
                console.error('âŒ æ‰¾ä¸åˆ°è¦–åœ–æŒ‰éˆ•ï¼Œè«‹æª¢æŸ¥ HTML çµæ§‹');
                // æª¢æŸ¥ DOM çµæ§‹
                const viewButtonsContainer = document.querySelector('.view-buttons');
                if (viewButtonsContainer) {
                    console.log('âŒ view-buttons å®¹å™¨å­˜åœ¨ï¼Œä½†æ²’æœ‰æŒ‰éˆ•');
                    console.log('âŒ å®¹å™¨å…§å®¹:', viewButtonsContainer.innerHTML);
                } else {
                    console.log('âŒ view-buttons å®¹å™¨ä¸å­˜åœ¨');
                }
                return;
            }
            
            viewButtons.forEach((button, index) => {
                console.log(`ğŸ”— ç¶å®šæŒ‰éˆ• ${index + 1}: ${button.getAttribute('data-view')}`);
                
                // æ¸…é™¤æ‰€æœ‰èˆŠçš„èª²ç¨‹ç›£è½å™¨å’Œå±¬æ€§
                button.removeEventListener('click', handleViewButtonClick);
                button.removeEventListener('touchstart', handleViewButtonClick);
                button.removeEventListener('touchend', handleViewButtonClick);
                button.removeEventListener('mousedown', handleViewButtonClick);
                button.removeEventListener('touchend', handleViewButtonClick);
                // ç§»é™¤å…§è¯äº‹ä»¶è™•ç†å™¨ä»¥é¿å…CSPéŒ¯èª¤
                // button.onclick = null;
                
                // iOS Safari ç‰¹æ®Šæ¨£å¼è¨­ç½®
                button.style.pointerEvents = 'auto';
                button.style.cursor = 'pointer';
                button.style.userSelect = 'none';
                button.style.webkitUserSelect = 'none';
                button.style.webkitTouchCallout = 'none';
                button.style.webkitTapHighlightColor = 'transparent';
                button.style.position = 'relative';
                button.style.zIndex = '10';
                button.style.display = 'block';
                button.style.width = '100%';
                button.style.height = 'auto';
                button.style.minHeight = '44px'; // iOS æœ€å°è§¸æ§å€åŸŸ
                
                // iOS Safari è§¸æ§å„ªåŒ–
                if (isIOS) {
                    button.style.touchAction = 'manipulation';
                    button.style.webkitTouchCallout = 'none';
                    button.style.webkitUserSelect = 'none';
                    button.style.webkitTapHighlightColor = 'rgba(0, 0, 0, 0.1)';
                    button.style.border = 'none';
                    button.style.outline = 'none';
                    button.style.appearance = 'none';
                    button.style.webkitAppearance = 'none';
                } else {
                    button.style.touchAction = 'manipulation';
                }
                
                // ç°¡åŒ–çš„æŒ‰éˆ•èª²ç¨‹è™•ç† - ç¢ºä¿æŒ‰éˆ•å¯ä»¥æ­£å¸¸é»æ“Š
                const buttonClickHandler = function(e) {
                    console.log(`ğŸ“± æŒ‰éˆ•é»æ“Šè§¸ç™¼: ${button.getAttribute('data-view')}`);
                    e.preventDefault();
                    e.stopPropagation();
                    handleViewButtonClick.call(this, e);
                };
                
                // æ¸…é™¤æ‰€æœ‰èˆŠçš„èª²ç¨‹ç›£è½å™¨
                button.removeEventListener('click', buttonClickHandler);
                button.removeEventListener('touchstart', buttonClickHandler);
                button.removeEventListener('touchend', buttonClickHandler);
                button.removeEventListener('mousedown', buttonClickHandler);
                
                // æ·»åŠ æ–°çš„èª²ç¨‹ç›£è½å™¨
                button.addEventListener('click', buttonClickHandler, { passive: false });
                button.addEventListener('touchstart', buttonClickHandler, { passive: false });
                button.addEventListener('touchend', buttonClickHandler, { passive: false });
                
                // ç§»é™¤å…§è¯äº‹ä»¶è™•ç†å™¨ä»¥é¿å…CSPéŒ¯èª¤
                // button.onclick = buttonClickHandler;
                
                console.log(`âœ… æŒ‰éˆ• ${index + 1} ç¶å®šå®Œæˆ: ${button.getAttribute('data-view')}`);
            });
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼ˆç§»é™¤å»¶é²ï¼‰
            updateViewButtonStates();
            console.log('ğŸ“± æŒ‰éˆ•ç‹€æ…‹å·²æ›´æ–°');
        }

        // æ›´æ–°è¦–åœ–æŒ‰éˆ•ç‹€æ…‹
        function updateViewButtonStates() {
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            
            // ä¸­è‹±æ–‡å°æ‡‰é—œä¿‚
            const viewMap = {
                'ä»Šæ—¥': 'today',
                'æœ¬é€±': 'week', 
                'æœ¬æœˆ': 'month',
                'å…¨éƒ¨': 'all'
            };
            
            const englishCurrentView = viewMap[currentView] || currentView;
            
            viewButtons.forEach(button => {
                const view = button.getAttribute('data-view');
                if (view === englishCurrentView) {
                    button.classList.add('active');
                    console.log(`âœ… æŒ‰éˆ• ${view} (${currentView}) è¨­ç‚ºé¸ä¸­ç‹€æ…‹`);
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // iOS Safari æŒ‰éˆ•æ¸¬è©¦å‡½æ•¸
        function testIOSButtons() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            
            if (isIOS) {
                console.log('ğŸ é–‹å§‹ iOS Safari æŒ‰éˆ•æ¸¬è©¦...');
                const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
                
                viewButtons.forEach((button, index) => {
                    console.log(`ğŸ æ¸¬è©¦æŒ‰éˆ• ${index + 1}: ${button.getAttribute('data-view')}`);
                    console.log(`ğŸ æŒ‰éˆ•æ¨£å¼:`, {
                        pointerEvents: button.style.pointerEvents,
                        touchAction: button.style.touchAction,
                        webkitUserSelect: button.style.webkitUserSelect,
                        minHeight: button.style.minHeight,
                        display: button.style.display,
                        width: button.style.width
                    });
                    
                    // å¼·åˆ¶è§¸ç™¼æ¸¬è©¦
                    button.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                    setTimeout(() => {
                        button.style.backgroundColor = '';
                    }, 1000);
                });
            }
        }

        // åˆ‡æ›æª¢è¦–æ¨¡å¼
        // è¨­ç½®ç‚ºå…¨å±€å‡½æ•¸
        window.switchView = function switchView(view) {
            // å°‡è‹±æ–‡è¦–åœ–è½‰æ›ç‚ºä¸­æ–‡
            const viewMap = {
                'today': 'ä»Šæ—¥',
                'week': 'æœ¬é€±',
                'month': 'æœ¬æœˆ',
                'all': 'å…¨éƒ¨'
            };
            
            const chineseView = viewMap[view] || view;
            currentView = chineseView;
            
            console.log('ğŸ”„ switchView - åˆ‡æ›åˆ°è¦–åœ–:', chineseView, 'åŸå§‹è¦–åœ–:', view);
            
            // æ›´æ–°æŒ‰éˆ•é¸ä¸­ç‹€æ…‹
            updateViewButtonStates();
            window.currentView = chineseView; // è¨­ç½®å…¨å±€è®Šé‡
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ - åªé‡å°è¦–åœ–æŒ‰éˆ•
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            viewButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦è¨­ç‚ºæ´»èº
            viewButtons.forEach(btn => {
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                }
            });
            
            
            
            // æ›´æ–°çµ±è¨ˆè³‡è¨Šï¼ˆåŒ…æ‹¬æ—¥æœŸç¯„åœï¼‰
            updateStats();
            renderEvents();
        };


        // é€šç”¨ç¯©é¸å‡½æ•¸ï¼Œæ ¹æ“šç•¶å‰ç¯©é¸æ¢ä»¶ç¯©é¸èª²ç¨‹ï¼ˆä¸åŒ…å«è¦–åœ–ç¯©é¸ï¼‰
        function getFilteredEvents() {
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            console.log('ğŸ” getFilteredEvents - ç¯©é¸æ¢ä»¶:', {
                instructorFilter,
                timeFilter,
                dateFilter,
                totalEvents: allEvents.length
            });
            
            const filtered = allEvents.filter(event => {
                const eventDate = new Date(event.start);
                
                // è¬›å¸«ç¯©é¸
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // æ™‚æ®µç¯©é¸
                if (timeFilter) {
                    const hour = eventDate.getHours();
                    let timeMatch = false;
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    if (!timeMatch) return false;
                }
                
                // æŒ‡å®šæ—¥æœŸç¯©é¸
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const eventYear = eventDate.getFullYear();
                    const eventMonth = eventDate.getMonth();
                    const eventDay = eventDate.getDate();
                    const filterYear = filterDate.getFullYear();
                    const filterMonth = filterDate.getMonth();
                    const filterDay = filterDate.getDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // å¿«é€Ÿç¯©é¸æ—¥æœŸç¯„åœ
                if (window.currentQuickFilterRange) {
                    const range = window.currentQuickFilterRange;
                    const eventTime = eventDate.getTime();
                    if (eventTime < range.start.getTime() || eventTime > range.end.getTime()) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log('ğŸ” getFilteredEvents - ç¯©é¸çµæœ:', filtered.length);
            return filtered;
        }

        // æœªä½¿ç”¨çš„ getViewFilteredEvents å‡½æ•¸å·²ç§»é™¤


        // ç§»é™¤å¿«é€Ÿç¯©é¸åŠŸèƒ½ - æ‰€æœ‰å¿«é€Ÿç¯©é¸ç›¸é—œä»£ç¢¼å·²ç§»é™¤
        
        // æ¸²æŸ“èª²ç¨‹åˆ—è¡¨
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            console.log('ğŸ¨ renderEvents - é–‹å§‹ç¯©é¸ï¼Œç¸½èª²ç¨‹æ•¸:', allEvents.length, 'ç•¶å‰è¦–åœ–:', currentView);
            
            // ä½¿ç”¨ç°¡å–®ç›´æ¥çš„ç¯©é¸é‚è¼¯ï¼Œå…ˆéæ¿¾æ‰ null å€¼
            let filteredEvents = allEvents.filter(event => {
                // å…ˆæª¢æŸ¥èª²ç¨‹æ˜¯å¦ç‚º null æˆ– undefined
                if (!event) {
                    console.warn('âš ï¸ renderEvents: ç™¼ç¾ null èª²ç¨‹ï¼Œå·²éæ¿¾');
                    return false;
                }
                
                // æª¢æŸ¥å¿…è¦å±¬æ€§æ˜¯å¦å­˜åœ¨
                if (!event.start || !event.end || !event.title || !event.instructor) {
                    console.warn('âš ï¸ renderEvents: èª²ç¨‹ç¼ºå°‘å¿…è¦å±¬æ€§ï¼Œå·²éæ¿¾', event);
                    return false;
                }
                
                return true;
            }).filter(event => {
                // è¬›å¸«ç¯©é¸
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // æ™‚æ®µç¯©é¸
                if (timeFilter) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    let timeMatch = false;
                    
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    
                    if (!timeMatch) {
                    return false;
                    }
                }
                
                // æŒ‡å®šæ—¥æœŸç¯©é¸
                if (dateFilter) {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    const eventYear = eventDate.getFullYear();
                    const eventMonth = eventDate.getMonth();
                    const eventDay = eventDate.getDate();
                    const filterYear = filterDate.getFullYear();
                    const filterMonth = filterDate.getMonth();
                    const filterDay = filterDate.getDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // è¦–åœ–ç¯©é¸
                const eventDate = new Date(event.start);
                const now = new Date();
                
                let shouldShow = false;
                switch (currentView) {
                    case 'ä»Šæ—¥':
                        const eventYear = eventDate.getFullYear();
                        const eventMonth = eventDate.getMonth();
                        const eventDay = eventDate.getDate();
                        const nowYear = now.getFullYear();
                        const nowMonth = now.getMonth();
                        const nowDay = now.getDate();
                        shouldShow = eventYear === nowYear && eventMonth === nowMonth && eventDay === nowDay;
                        break;
                    case 'æœ¬é€±':
                        const weekStart = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        weekStart.setDate(now.getDate() + daysToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        weekEnd.setHours(23, 59, 59, 999);
                        shouldShow = eventDate >= weekStart && eventDate <= weekEnd;
                        break;
                    case 'æœ¬æœˆ':
                        shouldShow = eventDate.getFullYear() === now.getFullYear() && 
                                   eventDate.getMonth() === now.getMonth();
                        break;
                    case 'å…¨éƒ¨':
                    default:
                        shouldShow = true;
                }
                
                return shouldShow;
            });
            
            console.log('ğŸ¨ renderEvents - ç¯©é¸å¾Œèª²ç¨‹æ•¸é‡:', filteredEvents.length, 'ç•¶å‰è¦–åœ–:', currentView);
            
            // æ¸…ç©ºå®¹å™¨
            if (container) {
                container.innerHTML = '';
            }
            
            // æ’åºèª²ç¨‹
            filteredEvents.sort((a, b) => {
                const now = new Date();
                const eventA = new Date(a.start);
                const eventB = new Date(b.start);
                const endA = new Date(a.end);
                const endB = new Date(b.end);
                
                // åˆ¤æ–·èª²ç¨‹ç‹€æ…‹
                const isEventAOngoing = eventA <= now && endA > now;
                const isEventBOngoing = eventB <= now && endB > now;
                const isEventAPast = endA < now;
                const isEventBPast = endB < now;
                const isEventAUpcoming = eventA > now;
                const isEventBUpcoming = eventB > now;
                
                // å„ªå…ˆæ’åºï¼šæ­£åœ¨é€²è¡Œä¸­ > å³å°‡é–‹å§‹ > å·²çµæŸ
                if (isEventAOngoing && !isEventBOngoing) return -1;
                if (!isEventAOngoing && isEventBOngoing) return 1;
                
                if (isEventAUpcoming && isEventBPast) return -1;
                if (isEventAPast && isEventBUpcoming) return 1;
                
                // åœ¨ç›¸åŒç‹€æ…‹ä¸‹ï¼ŒæŒ‰æ™‚é–“æ’åº
                return eventA - eventB;
            });
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="no-events">
                        <i class="fas fa-calendar-times"></i>
                        <h3>æ²’æœ‰æ‰¾åˆ°èª²ç¨‹</h3>
                        <p>è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredEvents.map(event => createEventCard(event)).join('');
            
            // æ·»åŠ é è¼‰å…¥åŠŸèƒ½åˆ°èª²ç¨‹å¡ç‰‡
            addPreloadToEventCards();
            
            // è§¸ç™¼èª²ç¨‹å¡ç‰‡å‹•ç•«ï¼ˆç§»é™¤å»¶é²ï¼‰
                animateEventCards();
                // æ›´æ–°å€’æ•¸è¨ˆæ™‚
                updateAllCountdowns();
        }

        // å¾æ¨™é¡Œè§£ææ™‚é–“
        function parseTimeFromTitle(title) {
            // åŒ¹é…æ ¼å¼å¦‚ "18:30-20:30", "14:30-15:30", "16:30-17:30", "1630-1730" ç­‰
            const timeMatch = title.match(/(\d{1,2}):?(\d{2})-(\d{1,2}):?(\d{2})/);
            if (timeMatch) {
                const startHour = timeMatch[1];
                const startMin = timeMatch[2];
                const endHour = timeMatch[3];
                const endMin = timeMatch[4];
                
                // æ ¼å¼åŒ–æ™‚é–“ç‚º HH:MM æ ¼å¼
                const startTime = `${startHour.padStart(2, '0')}:${startMin}`;
                const endTime = `${endHour.padStart(2, '0')}:${endMin}`;
                
                return {
                    startTime: startTime,
                    endTime: endTime,
                    timeString: `${startTime} - ${endTime}`
                };
            }
            return null;
        }

        // å¾æ¨™é¡Œè§£ææ—¥æœŸï¼ˆæ ¹æ“šæ˜ŸæœŸå¹¾ï¼‰
        function parseDateFromTitle(title, baseDate = new Date()) {
            // ç›´æ¥ä½¿ç”¨ CalDAV çš„æ—¥æœŸï¼Œä¸é‡æ–°è¨ˆç®—
            // å› ç‚º CalDAV å·²ç¶“æä¾›äº†æ­£ç¢ºçš„æ—¥æœŸ
            return baseDate;
        }

        // è¨ˆç®—é€±æ¬¡ï¼ˆISO 8601 æ¨™æº–ï¼‰
        function getWeekNumber(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        // ç²å–æ˜ŸæœŸå¹¾ï¼ˆä¸­æ–‡ï¼‰
        function getWeekday(date) {
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            return weekdays[date.getDay()];
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºåœèª²/è«‹å‡
        function isCancelled(event) {
            const title = event.title.toLowerCase();
            const description = (event.description || '').toLowerCase();
            const cancelledKeywords = ['è«‹å‡', 'åœèª²', 'å–æ¶ˆ', 'æš«åœ', 'ä¼‘æ¯', 'æ”¾å‡'];
            
            return cancelledKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºä»£èª²/å¸¶ç­èª²ç¨‹
        function isSubstitute(event) {
            const title = event.title || '';
            const description = event.description || '';
            
            const substituteKeywords = ['ä»£èª²', 'å¸¶ç­', 'ä»£ç†', 'æ”¯æ´'];
            
            return substituteKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // ç²å–ä»£èª²/å¸¶ç­ä¿¡æ¯
        function getSubstituteInfo(event) {
            const title = event.title || '';
            const description = event.description || '';
            
            // å¾æ¨™é¡Œä¸­æå–ä»£èª²ä¿¡æ¯
            const titleMatch = title.match(/\[(ä»£èª²|å¸¶ç­|ä»£ç†|æ”¯æ´)\]([^\[\]]+)/);
            if (titleMatch) {
                return {
                    type: titleMatch[1],
                    originalInstructor: titleMatch[2].trim()
                };
            }
            
            // å¾æè¿°ä¸­æå–ä»£èª²ä¿¡æ¯
            const descMatch = description.match(/\[(ä»£èª²|å¸¶ç­|ä»£ç†|æ”¯æ´)\]([^\[\]]+)/);
            if (descMatch) {
                return {
                    type: descMatch[1],
                    originalInstructor: descMatch[2].trim()
                };
            }
            
            return null;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºé«”é©—èª²ç¨‹
        function isExperience(event) {
            if (!event || !event.title) return false;
            
            const title = event.title || '';
            const description = event.description || '';
            
            // æ›´ç²¾ç¢ºçš„é«”é©—é—œéµå­—æª¢æ¸¬ï¼Œé¿å…èª¤åˆ¤
            const experienceKeywords = ['é«”é©—'];
            
            return experienceKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // ç²å–é«”é©—ä¿¡æ¯
        function getExperienceInfo(event) {
            if (!isExperience(event)) return null;
            
            const title = event.title || '';
            const description = event.description || '';
            
            // å¾æ¨™é¡Œä¸­æå–é«”é©—ä¿¡æ¯
            const titleMatch = title.match(/\[(é«”é©—|é«”)\]([^\[\]]+)/);
            if (titleMatch) {
                return {
                    type: titleMatch[1]
                };
            }
            
            // å¾æè¿°ä¸­æå–é«”é©—ä¿¡æ¯
            const descMatch = description.match(/\[(é«”é©—|é«”)\]([^\[\]]+)/);
            if (descMatch) {
                return {
                    type: descMatch[1]
                };
            }
            
            // å¦‚æœæ²’æœ‰æ–¹æ‹¬è™Ÿæ ¼å¼ï¼Œæª¢æŸ¥æ˜¯å¦åŒ…å«é—œéµå­—
            if (title.includes('é«”é©—')) {
                return { type: 'é«”é©—' };
            } else if (title.includes('é«”')) {
                return { type: 'é«”' };
            }
            
            return null;
        }

        // å‰µå»ºèª²ç¨‹å¡ç‰‡
        function createEventCard(event) {
            // æª¢æŸ¥èª²ç¨‹æ˜¯å¦ç‚º null æˆ– undefined
            if (!event) {
                console.error('âŒ createEventCard: èª²ç¨‹ç‚º null æˆ– undefined');
                return '';
            }
            
            // æª¢æŸ¥å¿…è¦å±¬æ€§æ˜¯å¦å­˜åœ¨
            if (!event.start || !event.end || !event.title || !event.instructor) {
                console.error('âŒ createEventCard: èª²ç¨‹ç¼ºå°‘å¿…è¦å±¬æ€§', event);
                return '';
            }
            
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            const isCancelledEvent = isCancelled(event);
            
            // æª¢æ¸¬æ˜¯å¦ç‚ºä»£èª²/å¸¶ç­èª²ç¨‹
            const isSubstituteEvent = isSubstitute(event);
            const substituteInfo = isSubstituteEvent ? getSubstituteInfo(event) : null;
            
            // æª¢æ¸¬æ˜¯å¦ç‚ºé«”é©—èª²ç¨‹
            const isExperienceEvent = isExperience(event);
            const experienceInfo = isExperienceEvent ? getExperienceInfo(event) : null;
            
            // æª¢æ¸¬æ˜¯å¦ç‚ºå³å°‡åˆ°ä¾†çš„èª²ç¨‹
            const isUpcomingEventFlag = isUpcomingEvent(event);
            const timeUntilEvent = isUpcomingEventFlag ? getTimeUntilEvent(event) : null;
            
            // å¾æ¨™é¡Œè§£ææ™‚é–“
            const titleTime = parseTimeFromTitle(event.title);
            
            // çµ±ä¸€ä½¿ç”¨ CalDAV çš„æ—¥æœŸï¼Œç¢ºä¿æ—¥æœŸæ­£ç¢º
            const displayDate = startDate.toLocaleDateString('zh-TW');
            let timeString;
            
            if (titleTime) {
                // ä½¿ç”¨æ¨™é¡Œè§£æçš„æ™‚é–“ï¼Œä½†æ—¥æœŸä½¿ç”¨ CalDAV
                timeString = titleTime.timeString;
            } else {
                // ä½¿ç”¨ CalDAV çš„æ™‚é–“
                timeString = `${startDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })} - ${endDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })}`;
            }
            
            // æ¸…ç†æè¿°å…§å®¹
            let cleanDescription = event.description || '';
            
            // ç§»é™¤æŠ€è¡“æ¨™ç±¤å’Œé‡è¤‡è³‡è¨Š
            cleanDescription = cleanDescription
                .replace(/\[NOTION_SYNC\]/g, '')
                .replace(/æ™‚é–“:.*?è¬›å¸«:/g, '')
                .replace(/è¬›å¸«:.*?TA:/g, '')
                .replace(/TA:.*?ç¬¬ä¸€æœŸ:/g, '')
                .replace(/ç¬¬ä¸€æœŸ:/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            // å°‹æ‰¾æ•™æ¡ˆé€£çµ - å¾åŸå§‹æè¿°ä¸­æå–
            const notionUrlRegex = /\(https:\/\/www\.notion\.so\/([^)]+)\)/;
            let notionMatch = event.description.match(notionUrlRegex);
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ‹¬è™Ÿå…§çš„é€£çµï¼Œå‰‡åŒ¹é…ä¸€èˆ¬çš„ Notion é€£çµ
            if (!notionMatch) {
                const generalNotionRegex = /https:\/\/www\.notion\.so\/([^)\s]+)/;
                notionMatch = event.description.match(generalNotionRegex);
            }
            
            let lessonButton = '';
            if (notionMatch) {
                const lessonUrl = `https://www.notion.so/${notionMatch[1]}`;
                
                // æå–æ•™æ¡ˆåç¨±å’Œé¡å‹
                let lessonName = 'æŸ¥çœ‹æ•™æ¡ˆ';
                let lessonType = 'æ•™æ¡ˆ';
                
                // å¾åŸå§‹æè¿°ä¸­æå–æ•™æ¡ˆè³‡è¨Š
                const originalDescription = event.description;
                
                // åŒ¹é…å„ç¨®æ•™æ¡ˆæ ¼å¼ï¼Œå„ªå…ˆåŒ¹é…æ‹¬è™Ÿå‰çš„æ•™æ¡ˆåç¨±
                const lessonMatch = originalDescription.match(/(ESMæ•™æ¡ˆ|SPMæ•™æ¡ˆ|SPIKEæ•™æ¡ˆ|BOOSTæ•™æ¡ˆ|EV3æ•™æ¡ˆ|MINECRAFTæ•™æ¡ˆ)[:\s]*([^(]+?)(?:\s*\(https:\/\/www\.notion\.so)/);
                if (lessonMatch && lessonMatch[2]) {
                    lessonName = lessonMatch[2].trim();
                    lessonType = lessonMatch[1].replace('æ•™æ¡ˆ', '');
                }
                
                lessonButton = `
                    <div class="lesson-section">
                        <div class="lesson-label">${lessonType}æ•™æ¡ˆ</div>
                        <a href="${lessonUrl}" target="_blank" class="lesson-button ${lessonType.toLowerCase()}">
                            <i class="fas fa-book"></i> ${lessonName}
                        </a>
                    </div>
                `;
            }
            
        // è™•ç†ä½ç½®è³‡è¨Š
        let location = event.location;
        if (!location || location === 'nan' || location === 'null' || location === '' || location.trim() === '') {
                location = 'æ¨‚ç¨‹åŠ FunLearnBar';
            }
        
            // çµ±ä¸€åœ°å€ç‚ºæ¨‚ç¨‹åŠ FunLearnBar
            if (location === 'ç«™å‰æ•™å®¤' || location === 'å°åŒ—å¸‚ä¸­æ­£å€é–‹å°è¡—1æ®µ2è™Ÿ9æ¨“' || location === 'å°åŒ—å¸‚ä¸­æ­£å€é–‹å°è¡—ä¸€æ®µ2è™Ÿ9æ¨“') {
                location = 'æ¨‚ç¨‹åŠ FunLearnBar';
        }
            
            // è¬›å¸«åº•è‰²
            const instructorColor = instructorColors[event.instructor] || '#667eea';
            const instructorStyle = instructorColors[event.instructor] ? 'custom-color' : '';
            
            return `
                <div class="event-card ${isCancelledEvent ? 'cancelled-event' : ''} ${isSubstituteEvent ? 'substitute-event' : ''} ${isExperienceEvent ? 'experience-event' : ''} ${isUpcomingEventFlag ? 'upcoming-event' : ''}"
                     data-event-title="${event.title.replace(/'/g, "\\'")}"
                     data-event-instructor="${event.instructor.replace(/'/g, "\\'")}"
                     data-event-start="${event.start}"
                     data-event-end="${event.end}">
                    <div class="event-header">
                        <div>
                            <div class="event-title">
                                ${event.title}
                                ${isCancelledEvent ? '<span class="cancelled-badge"><i class="fas fa-ban"></i> âš ï¸ åœèª² âš ï¸</span>' : ''}
                                ${isSubstituteEvent && substituteInfo ? `<span class="substitute-badge"><i class="fas fa-exchange-alt"></i> ${substituteInfo.type} ${substituteInfo.originalInstructor}</span>` : ''}
                                ${isExperienceEvent && experienceInfo ? `<span class="experience-badge"><i class="fas fa-star"></i> ${experienceInfo.type}</span>` : ''}
                                ${isUpcomingEventFlag ? `<span class="upcoming-badge"><i class="fas fa-clock"></i> å³å°‡ä¸Šèª²</span>` : ''}
                            </div>
                            <div class="event-instructor ${instructorStyle}" style="--instructor-color: ${instructorColor}">
                                <i class="fas fa-user"></i> ${event.instructor}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-details">
                        <div class="event-detail">
                            <i class="fas fa-calendar"></i>
                            <span>${displayDate} (${getWeekday(startDate)}, ç¬¬${getWeekNumber(startDate)}é€±)</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-clock"></i>
                            <span>${timeString}</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}" 
                               target="_blank" 
                               class="location-link"
                               title="é»æ“ŠæŸ¥çœ‹åœ°åœ–">
                                <i class="fas fa-map-marked-alt location-map-icon"></i>
                                <span>${location}</span>
                                <i class="fas fa-external-link-alt location-external-icon"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="countdown-timer" 
                         data-start-time="${event.start}" 
                         data-end-time="${event.end}">
                        <i class="fas fa-clock countdown-icon"></i>
                        <span class="countdown-text">è¨ˆç®—ä¸­...</span>
                    </div>
                    
                    <div class="event-description">
                        <h4><i class="fas fa-info-circle"></i> èª²ç¨‹æè¿°</h4>
                        <p>${cleanDescription || 'ç„¡æè¿°'}</p>
                    </div>
                    
                    ${lessonButton}
                    
                    <!-- é•·æŒ‰æç¤º -->
                    <div class="long-press-hint" style="
                        text-align: center; 
                        margin-top: 10px; 
                        font-size: 0.75rem; 
                        color: rgba(51, 51, 51, 0.6);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    ">
                        <i class="fas fa-hand-pointer"></i> é•·æŒ‰1.5ç§’é€²è¡Œç°½åˆ°<br>
                        <small style="font-size: 0.6rem; color: rgba(51, 51, 51, 0.4);">
                            0.5ç§’é›†æ°£ â†’ 1ç§’é è¼‰ â†’ 1.5ç§’é–‹å•Ÿ
                        </small>
                        <small style="font-size: 0.65rem; color: rgba(51, 51, 51, 0.5);">
                            <i class="fas fa-hand-paper"></i> ç§»å‹•æ‰‹æŒ‡å¯å–æ¶ˆ
                        </small>
                    </div>
                </div>
            `;
        }

        // æ›´æ–°çµ±è¨ˆä¿¡æ¯
        function updateStats() {
            // ç²å–ç•¶å‰ç¯©é¸æ¢ä»¶
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            // å…ˆéæ¿¾æ‰ null å€¼
            let filteredEvents = allEvents.filter(event => {
                if (!event) return false;
                if (!event.start || !event.end || !event.title || !event.instructor) return false;
                return true;
            });
            
            // æ‡‰ç”¨è¬›å¸«ç¯©é¸
            if (instructorFilter) {
                filteredEvents = filteredEvents.filter(event => event.instructor === instructorFilter);
            }
            
            // æ‡‰ç”¨æ™‚æ®µç¯©é¸
                if (timeFilter) {
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    switch (timeFilter) {
                        case 'morning':
                            return hour >= 6 && hour < 12;
                        case 'afternoon':
                            return hour >= 12 && hour < 18;
                        case 'evening':
                            return hour >= 18 && hour < 24;
                        default:
                            return true;
                    }
                });
                }
                
            // æ‡‰ç”¨æŒ‡å®šæ—¥æœŸç¯©é¸
                if (dateFilter) {
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    return eventDate.getFullYear() === filterDate.getFullYear() &&
                           eventDate.getMonth() === filterDate.getMonth() &&
                           eventDate.getDate() === filterDate.getDate();
                });
            }
            
            // æ‡‰ç”¨è¦–åœ–ç¯©é¸ï¼ˆä»Šæ—¥/æœ¬é€±/æœ¬æœˆ/å…¨éƒ¨ï¼‰
                const now = new Date();
            filteredEvents = filteredEvents.filter(event => {
                const eventDate = new Date(event.start);
                
                switch (currentView) {
                    case 'ä»Šæ—¥':
                        return eventDate.getFullYear() === now.getFullYear() &&
                               eventDate.getMonth() === now.getMonth() &&
                               eventDate.getDate() === now.getDate();
                    case 'æœ¬é€±':
                        const weekStart = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        weekStart.setDate(now.getDate() + daysToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        weekEnd.setHours(23, 59, 59, 999);
                        return eventDate >= weekStart && eventDate <= weekEnd;
                    case 'æœ¬æœˆ':
                        return eventDate.getFullYear() === now.getFullYear() &&
                               eventDate.getMonth() === now.getMonth();
                    case 'å…¨éƒ¨':
                    default:
                        return true;
                }
            });
            
            // è¨ˆç®—ç¯©é¸å¾Œçš„è¬›å¸«æ•¸é‡
            const uniqueInstructors = new Set(filteredEvents.map(event => event.instructor));
            const instructorCount = uniqueInstructors.size;
            
            // èª¿è©¦æ—¥èªŒï¼šé¡¯ç¤ºç¯©é¸çµæœ
            console.log(`ğŸ“Š çµ±è¨ˆæ›´æ–° - æ¨¡å¼: ${currentView}, ç¸½èª²ç¨‹: ${allEvents.length}, ç¯©é¸å¾Œ: ${filteredEvents.length}`);
            
            // æ ¹æ“šç•¶å‰ç¯©é¸æ¨¡å¼è¨ˆç®—æ—¥æœŸç¯„åœ
            let dateRange = '-';
            
            switch (currentView) {
                case 'ä»Šæ—¥':
                    dateRange = now.toLocaleDateString('zh-TW');
                    break;
                case 'æœ¬é€±':
                    const weekStart = new Date(now);
                    const dayOfWeek = now.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    weekStart.setDate(now.getDate() + daysToMonday);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    dateRange = `${weekStart.toLocaleDateString('zh-TW')} - ${weekEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case 'æœ¬æœˆ':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    dateRange = `${monthStart.toLocaleDateString('zh-TW')} - ${monthEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case 'å…¨éƒ¨':
                default:
                    if (filteredEvents.length > 0) {
                        const dates = filteredEvents.map(event => new Date(event.start));
                        const minDate = new Date(Math.min(...dates));
                        const maxDate = new Date(Math.max(...dates));
                        dateRange = `${minDate.toLocaleDateString('zh-TW')} - ${maxDate.toLocaleDateString('zh-TW')}`;
                    } else if (allEvents.length > 0) {
                const dates = allEvents.map(event => new Date(event.start));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                        dateRange = `${minDate.toLocaleDateString('zh-TW')} - ${maxDate.toLocaleDateString('zh-TW')}`;
                    }
                    break;
            }
            
            // æ›´æ–°æ–‡å­—å½¢å¼çš„çµ±è¨ˆä¿¡æ¯
            const totalEventsText = document.getElementById('totalEventsText');
            const instructorCountText = document.getElementById('instructorCountText');
            const dateRangeText = document.getElementById('dateRangeText');
            
            // å‹•ç•«æ›´æ–°çµ±è¨ˆæ•¸å­—
            if (totalEventsText) {
                animateCounter(totalEventsText, `ç¸½èª²ç¨‹: ${filteredEvents.length}`);
            }
            if (instructorCountText) {
                animateCounter(instructorCountText, `è¬›å¸«: ${instructorCount}`);
            }
            if (dateRangeText) {
                animateCounter(dateRangeText, `æ—¥æœŸ: ${dateRange}`);
            }
            
            // è§¸ç™¼çµ±è¨ˆæ›´æ–°èª²ç¨‹ï¼Œé€šçŸ¥æ‡¸æµ®é¸å–®æ›´æ–°
            document.dispatchEvent(new CustomEvent('statsUpdated'));
        }

        // å‹•ç•«æ›´æ–°è¨ˆæ•¸å™¨
        function animateCounter(element, newText) {
            if (element.textContent !== newText) {
                // æ·»åŠ å‹•ç•«é¡
                element.classList.add('animate');
                
                // æ›´æ–°æ–‡å­—
                element.textContent = newText;
                
                // ç§»é™¤å‹•ç•«é¡
                setTimeout(() => {
                    element.classList.remove('animate');
                }, 600);
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `
                <div class="no-events">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>è¼‰å…¥å¤±æ•—</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // é»æ“Šå¤–éƒ¨é—œé–‰è¨­ç½®ç•«é¢
        const settingsOverlay = document.getElementById('settingsOverlay');
        if (settingsOverlay) {
            settingsOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettings();
                }
            });
        }

        // è¨­ç½®æŒ‰éˆ•èª²ç¨‹ç›£è½å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // é—œé–‰è¨­ç½®æŒ‰éˆ•
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', closeSettings);
            }

            // å„²å­˜è¨­ç½®æŒ‰éˆ•
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', saveSettings);
            }
        });

        // é•·æŒ‰ç°½åˆ°èª²ç¨‹ç›£è½å™¨
        let longPressTimer = null;
        let isCharging = false;
        let chargingStartTime = 0;
        let isAnimating = false; // é˜²æ­¢å‹•ç•«è¡çª
        
        // è§¸æ§æ»‘å‹•æª¢æ¸¬
        let touchStartPos = { x: 0, y: 0 };
        let touchCurrentPos = { x: 0, y: 0 };
        let isScrolling = false;
        let scrollThreshold = 5; // æ»‘å‹•é–¾å€¼ï¼ˆåƒç´ ï¼‰- é€²ä¸€æ­¥é™ä½ä»¥æé«˜ç²¾åº¦
        let touchStartTime = 0;
        let touchDuration = 0;
        let isTouchActive = false;
        let touchCancelThreshold = 25; // è§¸æ§å–æ¶ˆé–¾å€¼ï¼ˆåƒç´ ï¼‰- æé«˜é›£åº¦
        let isTouchCancelled = false;
        
        // æ¨¡æ…‹æ¡†ç‹€æ…‹è¿½è¹¤
        let currentAttendanceModal = null;
        let isModalLoading = false;
        let isStudentListLoading = false;
        let studentListLoadPromise = null;

        // é¡¯ç¤ºå­¸ç”Ÿç°½åˆ°å…§å®¹
        function showStudentAttendance() {
            console.log('ğŸ‘¥ é¡¯ç¤ºå­¸ç”Ÿç°½åˆ°å…§å®¹');
            
            // ç²å–æ¨¡æ…‹æ¡†å…§å®¹
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // ç§»é™¤å·¦ç§»å‹•ç•«é¡åˆ¥ï¼Œå›åˆ°åŸå§‹å­¸ç”Ÿç°½åˆ°ç•«é¢
            modalContent.classList.remove('slide-left');
            
            // æª¢æŸ¥å­¸ç”Ÿåå–®æ˜¯å¦æ­£åœ¨è¼‰å…¥ä¸­
            if (isStudentListLoading) {
                console.log('â³ å­¸ç”Ÿåå–®æ­£åœ¨è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºè¼‰å…¥ç•«é¢');
                showStudentLoadingState();
            } else if (studentListLoadPromise) {
                console.log('â³ ç­‰å¾…å­¸ç”Ÿåå–®è¼‰å…¥å®Œæˆ');
                showStudentLoadingState();
                // ç­‰å¾…è¼‰å…¥å®Œæˆ
                studentListLoadPromise.then(() => {
                    console.log('âœ… å­¸ç”Ÿåå–®è¼‰å…¥å®Œæˆï¼Œæ¢å¾©æ­£å¸¸ç•«é¢');
                    hideStudentLoadingState();
                    // ç›´æ¥æ¢å¾©å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œä¸é‡æ–°è¼‰å…¥
                    restoreStudentAttendanceContent();
                });
            } else {
                console.log('âœ… å­¸ç”Ÿåå–®å·²è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤ºæ­£å¸¸ç•«é¢');
                hideStudentLoadingState();
                // ç›´æ¥æ¢å¾©å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œä¸é‡æ–°è¼‰å…¥
                restoreStudentAttendanceContent();
                
                // ç«‹å³æ›´æ–°èª²ç¨‹è³‡è¨Š
                console.log('ğŸ”„ åœ¨showStudentAttendanceä¸­ç«‹å³èª¿ç”¨updateCourseInfoDisplay');
                updateCourseInfoDisplay();
            }
            
            // ç¢ºä¿èª²ç¨‹è³‡è¨Šæ­£ç¢ºé¡¯ç¤º - å¼·åˆ¶æ›´æ–°
            setTimeout(() => {
                console.log('ğŸ”„ åœ¨showStudentAttendanceä¸­èª¿ç”¨updateCourseInfoDisplay');
                // å¼·åˆ¶æ›´æ–°èª²ç¨‹è³‡è¨Šï¼Œä¸ç®¡æ˜¯å¦æœ‰æ•¸æ“š
                updateCourseInfoDisplay();
                
                // å†æ¬¡ç¢ºä¿èª²ç¨‹è³‡è¨Šæ­£ç¢ºé¡¯ç¤º
                setTimeout(() => {
                    console.log('ğŸ”„ äºŒæ¬¡ç¢ºèªèª²ç¨‹è³‡è¨Šé¡¯ç¤º');
                    updateCourseInfoDisplay();
                }, 200);
                
                // ç¬¬ä¸‰æ¬¡ç¢ºèªï¼Œç¢ºä¿å…ƒç´ å·²å®Œå…¨è¼‰å…¥
                setTimeout(() => {
                    console.log('ğŸ”„ ä¸‰æ¬¡ç¢ºèªèª²ç¨‹è³‡è¨Šé¡¯ç¤º');
                    updateCourseInfoDisplay();
                }, 500);
            }, 300);
        }

        // æ›´æ–°èª²ç¨‹è³‡è¨Šé¡¯ç¤º

        // èª²ç¨‹è³‡è¨Šå…¨åŸŸè®Šæ•¸
        let storedCourseInfo = {
            teacher: null,
            course: null,
            time: null,
            date: null
        };
        
        // æª¢æŸ¥æ˜¯å¦å·²å„²å­˜èª²ç¨‹è³‡è¨Š
        function isCourseInfoStored() {
            return storedCourseInfo.teacher && storedCourseInfo.course && 
                   storedCourseInfo.time && storedCourseInfo.date;
        }
        
        // å„²å­˜èª²ç¨‹è³‡è¨Š
        function storeCourseInfo(teacher, course, time, date) {
            storedCourseInfo.teacher = teacher;
            storedCourseInfo.course = course;
            storedCourseInfo.time = time;
            storedCourseInfo.date = date;
            console.log('ğŸ’¾ èª²ç¨‹è³‡è¨Šå·²å„²å­˜:', storedCourseInfo);
        }
        
        // ä½¿ç”¨å„²å­˜çš„èª²ç¨‹è³‡è¨Šæ›´æ–°é¡¯ç¤º
        function updateDisplayWithStoredInfo() {
            console.log('ğŸ”„ ä½¿ç”¨å„²å­˜çš„èª²ç¨‹è³‡è¨Šæ›´æ–°é¡¯ç¤º');
            console.log('ğŸ” storedCourseInfo:', storedCourseInfo);
            
            // åªæ›´æ–°ç•¶å‰æ´»å‹•æ¨¡æ…‹æ¡†ä¸­çš„å…ƒç´ 
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) {
                console.log('âŒ æ‰¾ä¸åˆ°æ¨¡æ…‹æ¡†å…§å®¹ï¼Œç„¡æ³•æ›´æ–°èª²ç¨‹è³‡è¨Š');
                return;
            }
            
            // å˜—è©¦æ‰¾åˆ°èª²ç¨‹è³‡è¨Šå…ƒç´ ï¼ˆæ”¯æ´å…©ç¨®HTMLçµæ§‹ï¼‰
            let timeElement = modalContent.querySelector('#currentTime');
            let dateElement = modalContent.querySelector('#currentDate');
            let teacherElement = modalContent.querySelector('#currentTeacher');
            let courseElement = modalContent.querySelector('#currentCourse');
            
            // å¦‚æœæ‰¾ä¸åˆ°IDå…ƒç´ ï¼Œå˜—è©¦æ‰¾åˆ°data-fieldå…ƒç´ 
            if (!timeElement) {
                const timeField = modalContent.querySelector('[data-field="time"]');
                if (timeField) {
                    timeElement = timeField.querySelector('span') || timeField;
                }
            }
            if (!dateElement) {
                const dateField = modalContent.querySelector('[data-field="date"]');
                if (dateField) {
                    dateElement = dateField.querySelector('span') || dateField;
                }
            }
            if (!teacherElement) {
                const teacherField = modalContent.querySelector('[data-field="teacher"]');
                if (teacherField) {
                    teacherElement = teacherField.querySelector('span') || teacherField;
                }
            }
            if (!courseElement) {
                const courseField = modalContent.querySelector('[data-field="course"]');
                if (courseField) {
                    courseElement = courseField.querySelector('span') || courseField;
                }
            }
            
            console.log('ğŸ” å…ƒç´ æª¢æŸ¥:', {
                timeElement: !!timeElement,
                dateElement: !!dateElement,
                teacherElement: !!teacherElement,
                courseElement: !!courseElement
            });
            
            if (timeElement && storedCourseInfo.time) {
                console.log('ğŸ” æ›´æ–°æ™‚é–“å…ƒç´ :', storedCourseInfo.time);
                // æª¢æŸ¥æ˜¯å¦æ˜¯åŸå§‹çš„data-fieldçµæ§‹
                if (timeElement.hasAttribute('data-field')) {
                    // åŸå§‹çµæ§‹ï¼šæ›´æ–°æ•´å€‹å…ƒç´ çš„innerHTML
                    timeElement.innerHTML = `<strong style="color: #b8860b; font-weight: 600;">æ™‚é–“:</strong> ${storedCourseInfo.time}`;
                } else {
                    // æ–°çµæ§‹ï¼šåªæ›´æ–°textContent
                    timeElement.textContent = storedCourseInfo.time;
                }
                console.log('âœ… æ™‚é–“å…ƒç´ å·²æ›´æ–°');
            } else {
                console.log('âŒ æ™‚é–“å…ƒç´ æ›´æ–°å¤±æ•—:', {
                    timeElement: !!timeElement,
                    timeValue: storedCourseInfo.time
                });
            }
            
            if (dateElement && storedCourseInfo.date) {
                console.log('ğŸ” æ›´æ–°æ—¥æœŸå…ƒç´ :', storedCourseInfo.date);
                // æª¢æŸ¥æ˜¯å¦æ˜¯åŸå§‹çš„data-fieldçµæ§‹
                if (dateElement.hasAttribute('data-field')) {
                    // åŸå§‹çµæ§‹ï¼šæ›´æ–°æ•´å€‹å…ƒç´ çš„innerHTML
                    dateElement.innerHTML = `<strong style="color: #b8860b; font-weight: 600;">æ—¥æœŸ:</strong> ${storedCourseInfo.date}`;
                } else {
                    // æ–°çµæ§‹ï¼šåªæ›´æ–°textContent
                    dateElement.textContent = storedCourseInfo.date;
                }
                console.log('âœ… æ—¥æœŸå…ƒç´ å·²æ›´æ–°');
            } else {
                console.log('âŒ æ—¥æœŸå…ƒç´ æ›´æ–°å¤±æ•—:', {
                    dateElement: !!dateElement,
                    dateValue: storedCourseInfo.date
                });
            }
            
            if (teacherElement && storedCourseInfo.teacher) {
                console.log('ğŸ” æ›´æ–°è¬›å¸«å…ƒç´ :', storedCourseInfo.teacher);
                // æª¢æŸ¥æ˜¯å¦æ˜¯åŸå§‹çš„data-fieldçµæ§‹
                if (teacherElement.hasAttribute('data-field')) {
                    // åŸå§‹çµæ§‹ï¼šæ›´æ–°æ•´å€‹å…ƒç´ çš„innerHTML
                    teacherElement.innerHTML = `<strong style="color: #b8860b; font-weight: 600;">è¬›å¸«:</strong> ${storedCourseInfo.teacher}`;
                } else {
                    // æ–°çµæ§‹ï¼šåªæ›´æ–°textContent
                    teacherElement.textContent = storedCourseInfo.teacher;
                }
                console.log('âœ… è¬›å¸«å…ƒç´ å·²æ›´æ–°');
            } else {
                console.log('âŒ è¬›å¸«å…ƒç´ æ›´æ–°å¤±æ•—:', {
                    teacherElement: !!teacherElement,
                    teacherValue: storedCourseInfo.teacher
                });
            }
            
            if (courseElement && storedCourseInfo.course) {
                console.log('ğŸ” æ›´æ–°èª²ç¨‹å…ƒç´ :', storedCourseInfo.course);
                // æª¢æŸ¥æ˜¯å¦æ˜¯åŸå§‹çš„data-fieldçµæ§‹
                if (courseElement.hasAttribute('data-field')) {
                    // åŸå§‹çµæ§‹ï¼šæ›´æ–°æ•´å€‹å…ƒç´ çš„innerHTML
                    courseElement.innerHTML = `<strong style="color: #b8860b; font-weight: 600;">èª²ç¨‹:</strong> ${storedCourseInfo.course}`;
                } else {
                    // æ–°çµæ§‹ï¼šåªæ›´æ–°textContent
                    courseElement.textContent = storedCourseInfo.course;
                }
                console.log('âœ… èª²ç¨‹å…ƒç´ å·²æ›´æ–°');
            } else {
                console.log('âŒ èª²ç¨‹å…ƒç´ æ›´æ–°å¤±æ•—:', {
                    courseElement: !!courseElement,
                    courseValue: storedCourseInfo.course
                });
            }
            
            console.log('ğŸ”„ ä½¿ç”¨å„²å­˜çš„èª²ç¨‹è³‡è¨Šæ›´æ–°é¡¯ç¤ºå®Œæˆ');
        }
        
        function updateCourseInfoDisplay() {
            console.log('ğŸ”„ æ›´æ–°èª²ç¨‹è³‡è¨Šé¡¯ç¤º');
            console.log('ğŸ” window.loadedStudentsData:', window.loadedStudentsData);
            console.log('ğŸ” window.currentAttendanceData:', window.currentAttendanceData);
            console.log('ğŸ” å·²å„²å­˜çš„èª²ç¨‹è³‡è¨Š:', storedCourseInfo);
            
            // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            const teacherElement = document.getElementById('currentTeacher');
            const courseElement = document.getElementById('currentCourse');
            
            console.log('ğŸ” å…ƒç´ æª¢æŸ¥:', {
                timeElement: !!timeElement,
                dateElement: !!dateElement,
                teacherElement: !!teacherElement,
                courseElement: !!courseElement
            });
            
            // å¦‚æœå·²ç¶“æœ‰å„²å­˜çš„èª²ç¨‹è³‡è¨Šï¼Œç›´æ¥ä½¿ç”¨
            if (isCourseInfoStored()) {
                console.log('âœ… ä½¿ç”¨å·²å„²å­˜çš„èª²ç¨‹è³‡è¨Š');
                updateDisplayWithStoredInfo();
                return;
            }
            
            // å¦‚æœæ²’æœ‰å„²å­˜çš„èª²ç¨‹è³‡è¨Šï¼Œä½†å…ƒç´ é¡¯ç¤º"è¼‰å…¥ä¸­"ï¼Œå˜—è©¦å¾å…¶ä»–ä¾†æºç²å–
            if (timeElement && timeElement.textContent === 'è¼‰å…¥ä¸­...' && 
                dateElement && dateElement.textContent === 'è¼‰å…¥ä¸­...') {
                console.log('ğŸ” æª¢æ¸¬åˆ°è¼‰å…¥ä¸­ç‹€æ…‹ï¼Œå˜—è©¦å¾å…¶ä»–ä¾†æºç²å–èª²ç¨‹è³‡è¨Š');
                
                // å˜—è©¦å¾ window.loadedStudentsData ç²å–
                if (window.loadedStudentsData && window.loadedStudentsData.teacher) {
                    console.log('âœ… å¾ window.loadedStudentsData ç²å–èª²ç¨‹è³‡è¨Š');
                    const teacher = window.loadedStudentsData.teacher;
                    const course = window.loadedStudentsData.course;
                    const time = window.loadedStudentsData.time;
                    let date = window.loadedStudentsData.date;
                    
                    // å¦‚æœæ²’æœ‰ dateï¼Œå¾ start è¨ˆç®—
                    if (!date && window.loadedStudentsData.start) {
                        const startDate = new Date(window.loadedStudentsData.start);
                        date = startDate.toLocaleDateString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                    
                    // å„²å­˜èª²ç¨‹è³‡è¨Š
                    if (teacher && course && time && date) {
                        storeCourseInfo(teacher, course, time, date);
                        updateDisplayWithStoredInfo();
                        return;
                    }
                }
                
                // å˜—è©¦å¾ window.currentAttendanceData ç²å–
                if (window.currentAttendanceData && window.currentAttendanceData.teacher) {
                    console.log('âœ… å¾ window.currentAttendanceData ç²å–èª²ç¨‹è³‡è¨Š');
                    const teacher = window.currentAttendanceData.teacher;
                    const course = window.currentAttendanceData.course;
                    const time = window.currentAttendanceData.time;
                    let date = window.currentAttendanceData.date;
                    
                    // å¦‚æœæ²’æœ‰ dateï¼Œå¾ start è¨ˆç®—
                    if (!date && window.currentAttendanceData.start) {
                        const startDate = new Date(window.currentAttendanceData.start);
                        date = startDate.toLocaleDateString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                    
                    // å„²å­˜èª²ç¨‹è³‡è¨Š
                    if (teacher && course && time && date) {
                        storeCourseInfo(teacher, course, time, date);
                        updateDisplayWithStoredInfo();
                        return;
                    }
                }
            }
            
            // å¦‚æœæ²’æœ‰å¯ç”¨çš„æ•¸æ“šï¼Œè¨­ç½®ç‚ºé è¨­å€¼
            if (!window.loadedStudentsData && !window.currentAttendanceData) {
                console.log('âš ï¸ æ²’æœ‰å¯ç”¨çš„èª²ç¨‹æ•¸æ“šï¼Œè¨­ç½®ç‚ºé è¨­å€¼');
                
                if (timeElement) {
                    timeElement.textContent = '--:--';
                }
                if (dateElement) {
                    dateElement.textContent = '--/--/--';
                }
                if (teacherElement) {
                    teacherElement.textContent = 'æœªçŸ¥';
                }
                if (courseElement) {
                    courseElement.textContent = 'æœªçŸ¥';
                }
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å·²è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™
            if (window.loadedStudentsData) {
                console.log('âœ… ä½¿ç”¨å·²è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™æ›´æ–°èª²ç¨‹è³‡è¨Š');
                
                // æ›´æ–°è¬›å¸«è³‡è¨Š
                if (teacherElement) {
                    teacherElement.textContent = window.loadedStudentsData.teacher;
                }
                
                // æ›´æ–°èª²ç¨‹è³‡è¨Š
                if (courseElement) {
                    courseElement.textContent = window.loadedStudentsData.course;
                }
                
                // æ›´æ–°æ™‚é–“è³‡è¨Š - ç›´æ¥ä½¿ç”¨å„²å­˜çš„å€¼
                if (timeElement) {
                    console.log('ğŸ” æ‰¾åˆ°æ™‚é–“å…ƒç´ ï¼Œæº–å‚™æ›´æ–°');
                    if (window.loadedStudentsData.time) {
                        console.log('ğŸ” ä½¿ç”¨ window.loadedStudentsData.time:', window.loadedStudentsData.time);
                        timeElement.textContent = window.loadedStudentsData.time;
                    } else {
                        console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°æ™‚é–“è³‡æ–™');
                    }
                } else {
                    console.log('âŒ æ‰¾ä¸åˆ°æ™‚é–“å…ƒç´ ');
                }
                
                // æ›´æ–°æ—¥æœŸè³‡è¨Š - ç›´æ¥ä½¿ç”¨å„²å­˜çš„å€¼ï¼Œå¦‚æœæ²’æœ‰å‰‡å¾ start è¨ˆç®—
                if (dateElement) {
                    console.log('ğŸ” æ‰¾åˆ°æ—¥æœŸå…ƒç´ ï¼Œæº–å‚™æ›´æ–°');
                    if (window.loadedStudentsData.date) {
                        console.log('ğŸ” ä½¿ç”¨ window.loadedStudentsData.date:', window.loadedStudentsData.date);
                        dateElement.textContent = window.loadedStudentsData.date;
                    } else if (window.loadedStudentsData.start) {
                        console.log('ğŸ” å¾ window.loadedStudentsData.start è¨ˆç®—æ—¥æœŸ:', window.loadedStudentsData.start);
                        const startDate = new Date(window.loadedStudentsData.start);
                        const dateString = startDate.toLocaleDateString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        console.log('ğŸ” è¨ˆç®—å‡ºçš„æ—¥æœŸå­—ä¸²:', dateString);
                        dateElement.textContent = dateString;
                    } else {
                        console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°æ—¥æœŸè³‡æ–™');
                    }
                } else {
                    console.log('âŒ æ‰¾ä¸åˆ°æ—¥æœŸå…ƒç´ ');
                }
                
                // å„²å­˜èª²ç¨‹è³‡è¨Š - å¦‚æœæ²’æœ‰ dateï¼Œå¾ start è¨ˆç®—
                let dateToStore = window.loadedStudentsData.date;
                if (!dateToStore && window.loadedStudentsData.start) {
                    console.log('ğŸ” å¾ start è¨ˆç®—æ—¥æœŸç”¨æ–¼å„²å­˜:', window.loadedStudentsData.start);
                    const startDate = new Date(window.loadedStudentsData.start);
                    dateToStore = startDate.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    console.log('ğŸ” è¨ˆç®—å‡ºçš„å„²å­˜æ—¥æœŸ:', dateToStore);
                }
                
                if (window.loadedStudentsData.teacher && window.loadedStudentsData.course && 
                    window.loadedStudentsData.time && dateToStore) {
                    console.log('ğŸ’¾ æº–å‚™å„²å­˜èª²ç¨‹è³‡è¨Š:', { 
                        teacher: window.loadedStudentsData.teacher, 
                        course: window.loadedStudentsData.course, 
                        time: window.loadedStudentsData.time, 
                        date: dateToStore 
                    });
                    storeCourseInfo(window.loadedStudentsData.teacher, window.loadedStudentsData.course, 
                                  window.loadedStudentsData.time, dateToStore);
                    console.log('ğŸ’¾ å„²å­˜å®Œæˆï¼Œæª¢æŸ¥ storedCourseInfo:', storedCourseInfo);
                } else {
                    console.log('âš ï¸ èª²ç¨‹è³‡è¨Šä¸å®Œæ•´ï¼Œç„¡æ³•å„²å­˜:', { 
                        teacher: window.loadedStudentsData.teacher, 
                        course: window.loadedStudentsData.course, 
                        time: window.loadedStudentsData.time, 
                        date: dateToStore 
                    });
                }
                
                console.log('âœ… èª²ç¨‹è³‡è¨Šæ›´æ–°å®Œæˆ');
            } else if (window.currentAttendanceData) {
                console.log('âœ… ä½¿ç”¨ç•¶å‰èª²ç¨‹è³‡æ–™æ›´æ–°èª²ç¨‹è³‡è¨Š');
                
                // ä½¿ç”¨ç•¶å‰èª²ç¨‹è³‡æ–™
                const currentData = window.currentAttendanceData;
                
                // æ›´æ–°è¬›å¸«è³‡è¨Š
                if (teacherElement) {
                    teacherElement.textContent = currentData.teacher;
                }
                
                // æ›´æ–°èª²ç¨‹è³‡è¨Š
                if (courseElement) {
                    courseElement.textContent = currentData.course;
                }
                
                // æ›´æ–°æ™‚é–“è³‡è¨Š - ç›´æ¥ä½¿ç”¨å„²å­˜çš„å€¼
                if (timeElement) {
                    console.log('ğŸ” æ‰¾åˆ°æ™‚é–“å…ƒç´ ï¼Œæº–å‚™æ›´æ–°ï¼ˆä½¿ç”¨ currentAttendanceDataï¼‰');
                    if (currentData.time) {
                        console.log('ğŸ” ä½¿ç”¨ currentData.time:', currentData.time);
                        timeElement.textContent = currentData.time;
                    } else {
                        console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°æ™‚é–“è³‡æ–™');
                    }
                } else {
                    console.log('âŒ æ‰¾ä¸åˆ°æ™‚é–“å…ƒç´ ');
                }
                
                // æ›´æ–°æ—¥æœŸè³‡è¨Š - ç›´æ¥ä½¿ç”¨å„²å­˜çš„å€¼ï¼Œå¦‚æœæ²’æœ‰å‰‡å¾ start è¨ˆç®—
                if (dateElement) {
                    console.log('ğŸ” æ‰¾åˆ°æ—¥æœŸå…ƒç´ ï¼Œæº–å‚™æ›´æ–°ï¼ˆä½¿ç”¨ currentAttendanceDataï¼‰');
                    if (currentData.date) {
                        console.log('ğŸ” ä½¿ç”¨ currentData.date:', currentData.date);
                        dateElement.textContent = currentData.date;
                    } else if (currentData.start) {
                        console.log('ğŸ” å¾ currentData.start è¨ˆç®—æ—¥æœŸ:', currentData.start);
                        const startDate = new Date(currentData.start);
                        const dateString = startDate.toLocaleDateString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        console.log('ğŸ” è¨ˆç®—å‡ºçš„æ—¥æœŸå­—ä¸²:', dateString);
                        dateElement.textContent = dateString;
                    } else {
                        console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°æ—¥æœŸè³‡æ–™');
                    }
                } else {
                    console.log('âŒ æ‰¾ä¸åˆ°æ—¥æœŸå…ƒç´ ');
                }
                
                // å„²å­˜èª²ç¨‹è³‡è¨Š - å¦‚æœæ²’æœ‰ dateï¼Œå¾ start è¨ˆç®—
                let dateToStore = currentData.date;
                if (!dateToStore && currentData.start) {
                    console.log('ğŸ” å¾ start è¨ˆç®—æ—¥æœŸç”¨æ–¼å„²å­˜ (currentData):', currentData.start);
                    const startDate = new Date(currentData.start);
                    dateToStore = startDate.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    console.log('ğŸ” è¨ˆç®—å‡ºçš„å„²å­˜æ—¥æœŸ (currentData):', dateToStore);
                }
                
                if (currentData.teacher && currentData.course && currentData.time && dateToStore) {
                    console.log('ğŸ’¾ æº–å‚™å„²å­˜èª²ç¨‹è³‡è¨Š (currentData):', { 
                        teacher: currentData.teacher, 
                        course: currentData.course, 
                        time: currentData.time, 
                        date: dateToStore 
                    });
                    storeCourseInfo(currentData.teacher, currentData.course, currentData.time, dateToStore);
                    console.log('ğŸ’¾ å„²å­˜å®Œæˆï¼Œæª¢æŸ¥ storedCourseInfo:', storedCourseInfo);
                } else {
                    console.log('âš ï¸ èª²ç¨‹è³‡è¨Šä¸å®Œæ•´ï¼Œç„¡æ³•å„²å­˜ (currentData):', { 
                        teacher: currentData.teacher, 
                        course: currentData.course, 
                        time: currentData.time, 
                        date: dateToStore 
                    });
                }
                
                console.log('âœ… èª²ç¨‹è³‡è¨Šæ›´æ–°å®Œæˆ');
            } else {
                console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°èª²ç¨‹è³‡æ–™ï¼Œç„¡æ³•æ›´æ–°èª²ç¨‹è³‡è¨Š');
            }
        }

        // æ¢å¾©å­¸ç”Ÿç°½åˆ°å…§å®¹
        function restoreStudentAttendanceContent() {
            console.log('ğŸ”„ æ¢å¾©å­¸ç”Ÿç°½åˆ°å…§å®¹');
            
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å·²è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™ï¼ˆæª¢æŸ¥å…¨åŸŸè®Šæ•¸è€Œä¸æ˜¯DOMå…ƒç´ ï¼‰
            if (window.loadedStudentsData) {
                console.log('âœ… æ‰¾åˆ°å·²è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™ï¼Œæ¢å¾©åŸå…ˆçš„å­¸ç”Ÿç°½åˆ°ç•«é¢');
                
                // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„åŸå§‹å­¸ç”Ÿç°½åˆ°å…§å®¹
                if (window.originalStudentContent) {
                    console.log('âœ… æ‰¾åˆ°ä¿å­˜çš„åŸå§‹å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œç›´æ¥æ¢å¾©');
                    const attendanceContent = document.getElementById('attendanceContent');
                    if (attendanceContent) {
                        attendanceContent.innerHTML = window.originalStudentContent;
                        
                        // é‡æ–°ç¶å®šäº‹ä»¶
                        setupStudentCardDoubleClickListeners();
                        setupAttendanceEventListeners();
                        updateStats();
                        
                        // ç«‹å³æ›´æ–°èª²ç¨‹è³‡è¨Š
                        console.log('ğŸ”„ æ¢å¾©ä¿å­˜çš„å­¸ç”Ÿç°½åˆ°å…§å®¹å¾Œç«‹å³æ›´æ–°èª²ç¨‹è³‡è¨Š');
                        updateCourseInfoDisplay();
                        
                        console.log('âœ… ä¿å­˜çš„åŸå§‹å­¸ç”Ÿç°½åˆ°ç•«é¢å·²æ¢å¾©');
                        return; // ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦ç¹¼çºŒæª¢æŸ¥
                    }
                }
                
                // å¦‚æœæ²’æœ‰ä¿å­˜çš„å…§å®¹ï¼Œæª¢æŸ¥ç•¶å‰çš„ attendanceContent
                const attendanceContent = document.getElementById('attendanceContent');
                if (attendanceContent) {
                    console.log('âœ… æ‰¾åˆ°ç•¶å‰å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºå­¸ç”Ÿç°½åˆ°');
                    
                    // æª¢æŸ¥attendanceContentæ˜¯å¦åŒ…å«å­¸ç”Ÿç°½åˆ°å…§å®¹
                    const hasStudentContent = attendanceContent.querySelector('.student-card') || 
                                            attendanceContent.querySelector('.attendance-btn') ||
                                            attendanceContent.innerHTML.includes('å­¸ç”Ÿç°½åˆ°');
                    
                    if (hasStudentContent) {
                        console.log('âœ… ç¢ºèªæ˜¯å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œç›´æ¥é¡¯ç¤º');
                        // å¦‚æœå·²ç¶“æœ‰åŸå§‹çš„å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œç›´æ¥é¡¯ç¤ºå®ƒ
                        attendanceContent.style.display = 'block';
                        
                        // éš±è—å…¶ä»–å¯èƒ½çš„å…§å®¹
                        const studentsList = document.getElementById('studentsList');
                        if (studentsList) {
                            studentsList.style.display = 'none';
                        }
                        
                        // é‡æ–°ç¶å®šäº‹ä»¶
                        setupStudentCardDoubleClickListeners();
                        setupAttendanceEventListeners();
                        updateStats();
                        
                        // ç«‹å³æ›´æ–°èª²ç¨‹è³‡è¨Š
                        console.log('ğŸ”„ æ¢å¾©å­¸ç”Ÿç°½åˆ°å…§å®¹å¾Œç«‹å³æ›´æ–°èª²ç¨‹è³‡è¨Š');
                        updateCourseInfoDisplay();
                        
                        console.log('âœ… åŸå…ˆçš„å­¸ç”Ÿç°½åˆ°ç•«é¢å·²æ¢å¾©');
                    } else {
                        console.log('âš ï¸ attendanceContentä¸æ˜¯å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œé‡æ–°å‰µå»º');
                        // å¦‚æœattendanceContentä¸æ˜¯å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œé‡æ–°å‰µå»º
                        recreateStudentAttendanceContent();
                    }
                } else {
                    console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°åŸå§‹å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼Œé‡æ–°å‰µå»º');
                    // å¦‚æœæ²’æœ‰åŸå§‹å…§å®¹ï¼Œæ‰é‡æ–°å‰µå»º
                    recreateStudentAttendanceContent();
                }
            } else if (studentListLoadPromise) {
                console.log('â³ å­¸ç”Ÿè³‡æ–™æ­£åœ¨èƒŒæ™¯è¼‰å…¥ä¸­ï¼Œç­‰å¾…è¼‰å…¥å®Œæˆ');
                // å¦‚æœæ­£åœ¨èƒŒæ™¯è¼‰å…¥ï¼Œç­‰å¾…è¼‰å…¥å®Œæˆ
                showStudentLoadingState();
                studentListLoadPromise.then(() => {
                    console.log('âœ… èƒŒæ™¯è¼‰å…¥å®Œæˆï¼Œæ¢å¾©å­¸ç”Ÿç°½åˆ°å…§å®¹');
                    hideStudentLoadingState();
                    restoreStudentAttendanceContent(); // éæ­¸èª¿ç”¨ï¼Œé‡æ–°æª¢æŸ¥
                }).catch((error) => {
                    console.error('âŒ èƒŒæ™¯è¼‰å…¥å¤±æ•—:', error);
                    hideStudentLoadingState();
                    showLoadingContent();
                });
            } else {
                console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°å·²è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™ï¼Œé¡¯ç¤ºè¼‰å…¥ç•«é¢');
                // å¦‚æœæ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œé¡¯ç¤ºè¼‰å…¥ç•«é¢
                showLoadingContent();
            }
        }

        // é‡æ–°å‰µå»ºå­¸ç”Ÿç°½åˆ°å…§å®¹ï¼ˆä¸é‡æ–°è¼‰å…¥ï¼‰
        function recreateStudentAttendanceContent() {
            console.log('ğŸ”„ é‡æ–°å‰µå»ºå­¸ç”Ÿç°½åˆ°å…§å®¹');
            
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // ç²å–å·²å„²å­˜çš„èª²ç¨‹è³‡è¨Š
            const teacher = storedCourseInfo && storedCourseInfo.teacher ? storedCourseInfo.teacher : 'è¼‰å…¥ä¸­...';
            const course = storedCourseInfo && storedCourseInfo.course ? storedCourseInfo.course : 'è¼‰å…¥ä¸­...';
            const time = storedCourseInfo && storedCourseInfo.time ? storedCourseInfo.time : 'è¼‰å…¥ä¸­...';
            const date = storedCourseInfo && storedCourseInfo.date ? storedCourseInfo.date : 'è¼‰å…¥ä¸­...';
            
            console.log('ğŸ” ä½¿ç”¨å„²å­˜çš„èª²ç¨‹è³‡è¨Šå‰µå»ºå…§å®¹:', { teacher, course, time, date });
            
            // é‡æ–°å‰µå»ºå­¸ç”Ÿç°½åˆ°å…§å®¹çµæ§‹
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <h2 style="margin: 0; color: #333333; font-size: 1.5rem; text-shadow: none;">
                            <span style="color: #b8860b; font-weight: 600;">ğŸ“š å­¸ç”Ÿç°½åˆ°ç³»çµ±</span>
                        </h2>
                    </div>
                    <button id="closeModalBtn" style="background: none; border: none; font-size: 1.5rem; color: #666; cursor: pointer; padding: 5px; border-radius: 50%; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">
                        âœ•
                    </button>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div data-field="teacher" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">è¬›å¸«:</strong> <span id="currentTeacher">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="course" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">èª²ç¨‹:</strong> <span id="currentCourse">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="time" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ™‚é–“:</strong> <span id="currentTime">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="date" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ—¥æœŸ:</strong> <span id="currentDate">è¼‰å…¥ä¸­...</span></div>
                    </div>
                </div>
                
                <div id="studentsList" style="max-height: 500px; min-height: 500px; overflow-y: auto; margin-bottom: 20px; padding-right: 10px;">
                    <!-- å­¸ç”Ÿåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 15px; position: sticky; bottom: 0; z-index: 10;">
                    <div style="display: flex; justify-content: space-around; text-align: center; flex-wrap: nowrap;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: #28a745; font-weight: bold; font-size: 1.2rem;">${window.loadedStudentsData ? window.loadedStudentsData.students.filter(s => s.attendance && s.attendance.some(a => a.status === 'present')).length : 0}</div>
                            <div style="color: #666; font-size: 0.9rem;">å‡ºå¸­</div>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: #dc3545; font-weight: bold; font-size: 1.2rem;">${window.loadedStudentsData ? window.loadedStudentsData.students.filter(s => s.attendance && s.attendance.some(a => a.status === 'absent')).length : 0}</div>
                            <div style="color: #666; font-size: 0.9rem;">ç¼ºå¸­</div>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: #ffc107; font-weight: bold; font-size: 1.2rem;">${window.loadedStudentsData ? window.loadedStudentsData.students.filter(s => s.attendance && s.attendance.some(a => a.status === 'leave')).length : 0}</div>
                            <div style="color: #666; font-size: 0.9rem;">è«‹å‡</div>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: #6c757d; font-weight: bold; font-size: 1.2rem;">${window.loadedStudentsData ? window.loadedStudentsData.students.filter(s => !s.attendance || !s.attendance.some(a => a.status)).length : 0}</div>
                            <div style="color: #666; font-size: 0.9rem;">æœªé¸æ“‡</div>
                        </div>
                    </div>
                </div>
            `;
            
            // é‡æ–°ç”Ÿæˆå­¸ç”Ÿåˆ—è¡¨ - ä½¿ç”¨å®Œæ•´çš„åƒæ•¸
            if (window.loadedStudentsData && window.loadedStudentsData.students) {
                console.log('ğŸ” é‡æ–°ç”Ÿæˆå­¸ç”Ÿåˆ—è¡¨ï¼Œä½¿ç”¨å®Œæ•´åƒæ•¸');
                
                // ç›´æ¥ç”Ÿæˆå­¸ç”Ÿåˆ—è¡¨HTMLï¼Œå› ç‚ºdisplayStudentså‡½æ•¸æœƒå°‹æ‰¾attendanceContentå…ƒç´ 
                const studentsList = document.getElementById('studentsList');
                if (studentsList && window.loadedStudentsData.students.length > 0) {
                    console.log('ğŸ“ ç”Ÿæˆå­¸ç”Ÿåˆ—è¡¨HTML');
                    
                    // ç”Ÿæˆå­¸ç”Ÿå¡ç‰‡HTML
                    const studentsHTML = window.loadedStudentsData.students.map((student, index) => {
                        const studentId = student.student_id || student.studentId || student.key || student.name;
                        const studentName = student.name || 'æœªçŸ¥å­¸ç”Ÿ';
                        
                        // ç²å–å­¸ç”Ÿå‡ºç¼ºå‹¤è³‡æ–™
                        const attendanceData = getStudentAttendanceData(student);
                        
                        return `
                            <div class="student-card" data-student-id="${studentId}" style="
                                background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                border-radius: 12px;
                                padding: 15px;
                                margin-bottom: 10px;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                                transition: all 0.3s ease;
                                cursor: pointer;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.1)'">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 8px; font-size: 1.1rem;">
                                            ${studentName}
                                        </div>
                                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                                            ID: ${studentId}
                                        </div>
                                        <!-- æ¡Œé¢ç«¯å‡ºç¼ºå‹¤æ¬¡æ•¸é¡¯ç¤º -->
                                        <div class="attendance-stats-desktop" style="display: flex; gap: 12px; font-size: 0.8rem;">
                                            <span style="color: #28a745; font-weight: 600;">
                                                <i class="fas fa-check-circle"></i> å‡ºå¸­ ${attendanceData.present}æ¬¡
                                            </span>
                                            <span style="color: #dc3545; font-weight: 600;">
                                                <i class="fas fa-times-circle"></i> ç¼ºå¸­ ${attendanceData.absent}æ¬¡
                                            </span>
                                            <span style="color: #ffc107; font-weight: 600;">
                                                <i class="fas fa-clock"></i> é²åˆ° ${attendanceData.late}æ¬¡
                                            </span>
                                            <span style="color: #6c757d; font-weight: 600;">
                                                <i class="fas fa-question-circle"></i> æœªæ¨™è¨˜ ${attendanceData.unmarked}æ¬¡
                                            </span>
                                        </div>
                                        
                                        <!-- æ‰‹æ©Ÿç«¯å‡ºç¼ºå‹¤æ¬¡æ•¸é¡¯ç¤º -->
                                        <div class="attendance-stats-mobile" style="display: none;">
                                            <div class="attendance-stats-row">
                                                <div class="attendance-stat-item present">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span>å‡ºå¸­ ${attendanceData.present}æ¬¡</span>
                                                </div>
                                                <div class="attendance-stat-item absent">
                                                    <i class="fas fa-times-circle"></i>
                                                    <span>ç¼ºå¸­ ${attendanceData.absent}æ¬¡</span>
                                                </div>
                                            </div>
                                            <div class="attendance-stats-row">
                                                <div class="attendance-stat-item late">
                                                    <i class="fas fa-clock"></i>
                                                    <span>é²åˆ° ${attendanceData.late}æ¬¡</span>
                                                </div>
                                                <div class="attendance-stat-item unmarked">
                                                    <i class="fas fa-question-circle"></i>
                                                    <span>æœªæ¨™è¨˜ ${attendanceData.unmarked}æ¬¡</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="attendance-btn present-btn liquid-button" 
                                                data-student-id="${studentId}" 
                                                style="
                                                    background: linear-gradient(135deg, #28a745, #20c997);
                                                    color: white;
                                                    border: none;
                                                    border-radius: 8px;
                                                    padding: 8px 16px;
                                                    font-size: 0.9rem;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.3s ease;
                                                    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
                                                "
                                                onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(40, 167, 69, 0.4)'"
                                                onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(40, 167, 69, 0.3)'">
                                            å‡ºå¸­
                                        </button>
                                        <button class="attendance-btn absent-btn liquid-button" 
                                                data-student-id="${studentId}" 
                                                style="
                                                    background: linear-gradient(135deg, #dc3545, #fd7e14);
                                                    color: white;
                                                    border: none;
                                                    border-radius: 8px;
                                                    padding: 8px 16px;
                                                    font-size: 0.9rem;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.3s ease;
                                                    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
                                                "
                                                onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.4)'"
                                                onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)'">
                                            ç¼ºå¸­
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    studentsList.innerHTML = studentsHTML;
                    console.log('âœ… å­¸ç”Ÿåˆ—è¡¨HTMLç”Ÿæˆå®Œæˆ');
                }
            }
            
            // é‡æ–°ç¶å®šé—œé–‰æŒ‰éˆ•äº‹ä»¶
            const closeBtn = document.getElementById('closeModalBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    console.log('âŒ ç”¨æˆ¶é»æ“Šé—œé–‰æŒ‰éˆ•ï¼ˆé‡æ–°å‰µå»ºå¾Œï¼‰');
                    closeAttendanceModal();
                });
            }
            
            // ç«‹å³æ›´æ–°èª²ç¨‹è³‡è¨Šé¡¯ç¤º
            console.log('ğŸ”„ é‡æ–°å‰µå»ºå¾Œç«‹å³æ›´æ–°èª²ç¨‹è³‡è¨Š');
            updateCourseInfoDisplay();
            
            // é‡æ–°ç¶å®šäº‹ä»¶
            setupStudentCardDoubleClickListeners();
            setupAttendanceEventListeners();
            updateStats();
            
            console.log('âœ… å­¸ç”Ÿç°½åˆ°å…§å®¹é‡æ–°å‰µå»ºå®Œæˆ');
        }

        // æ¢å¾©åŸå§‹å­¸ç”Ÿç°½åˆ°å…§å®¹ï¼ˆæœ‰å­¸ç”Ÿè³‡æ–™æ™‚ï¼‰
        function restoreOriginalStudentContent() {
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // é‡æ–°å‰µå»ºåŸå§‹çš„å­¸ç”Ÿç°½åˆ°å…§å®¹çµæ§‹ï¼Œä½†ä¿æŒå­¸ç”Ÿè³‡æ–™
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <h2 style="margin: 0; color: #333333; font-size: 1.5rem; text-shadow: none;">
                            <i class="fas fa-calendar-check" style="color: #b8860b; margin-right: 10px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                            èª²ç¨‹ç°½åˆ°ç³»çµ±
                        </h2>
                    </div>
                    <button id="closeAttendanceModal" class="close-attendance-modal" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 215, 0, 0.4);
                        font-size: 1.5rem;
                        color: #333333;
                        cursor: pointer;
                        padding: 5px;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s ease;
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                    ">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="course-info" style="
                    margin-bottom: 20px; 
                    padding: 20px; 
                    background: 
                        radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.05) 0%, transparent 70%),
                        linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
                    border-radius: 15px; 
                    border: 1px solid rgba(255, 215, 0, 0.3);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    box-shadow: 
                        0 8px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
                ">
                    <div class="course-info-panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem;">
                        <div data-field="teacher" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">è¬›å¸«:</strong> <span id="currentTeacher">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="course" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">èª²ç¨‹:</strong> <span id="currentCourse">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="time" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ™‚é–“:</strong> <span id="currentTime">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="date" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ—¥æœŸ:</strong> <span id="currentDate">è¼‰å…¥ä¸­...</span></div>
                    </div>
                </div>
                
                <div id="attendanceContent">
                    <div style="
                        display: flex;
                        flex-direction: column;
                        max-height: 90vh;
                        min-height: 500px;
                        overflow-y: auto;
                        -webkit-overflow-scrolling: touch;
                    ">
                        <!-- å­¸ç”Ÿåå–®æ¨™é¡Œ -->
                        <h3 style="margin: 0 0 12px 0; color: #333333; font-size: 1.1rem; text-shadow: none;">
                            <i class="fas fa-users" style="color: #b8860b; margin-right: 8px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                            å­¸ç”Ÿåå–® (è¼‰å…¥ä¸­...)
                        </h3>
                        
                        <!-- å­¸ç”Ÿåˆ—è¡¨ - æ¥çºŒåœ¨æ¨™é¡Œå¾Œé¢ -->
                        <div id="studentsList" style="
                            display: flex; 
                            flex-direction: column; 
                            gap: 8px; 
                            margin-bottom: 16px;
                            max-height: 75vh;
                            min-height: 350px;
                            overflow-y: auto;
                            overflow-x: hidden;
                            -webkit-overflow-scrolling: touch;
                            scroll-behavior: smooth;
                            position: relative;
                        ">
                            <!-- å­¸ç”Ÿåˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                        
                        <!-- çµ±è¨ˆæ¬„ä½ - æ¥çºŒåœ¨å­¸ç”Ÿåˆ—è¡¨å¾Œé¢ -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 12px 16px;
                            background: 
                                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.08) 0%, transparent 70%),
                                linear-gradient(135deg, 
                                    rgba(255, 255, 255, 0.15) 0%, 
                                    rgba(248, 249, 250, 0.1) 50%,
                                    rgba(255, 255, 255, 0.15) 100%);
                            border-radius: 12px;
                            border: 1px solid rgba(255, 215, 0, 0.4);
                            backdrop-filter: blur(25px);
                            -webkit-backdrop-filter: blur(25px);
                            box-shadow: 
                                0 8px 32px rgba(0, 0, 0, 0.15),
                                inset 0 1px 0 rgba(255, 255, 255, 0.2);
                        ">
                            <div id="attendanceStats" style="font-size: 0.85rem; color: #333333; text-shadow: none;">
                                çµ±è¨ˆè¼‰å…¥ä¸­...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // é‡æ–°è¨­ç½®é—œé–‰æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            const closeBtn = document.getElementById('closeAttendanceModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    closeAttendanceModal();
                });
            }
            
            console.log('âœ… åŸå§‹å­¸ç”Ÿç°½åˆ°å…§å®¹å·²æ¢å¾©');
        }

        // é¡¯ç¤ºè¼‰å…¥å…§å®¹ï¼ˆæ²’æœ‰å­¸ç”Ÿè³‡æ–™æ™‚ï¼‰
        function showLoadingContent() {
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // é‡æ–°å‰µå»ºè¼‰å…¥ç•«é¢
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <h2 style="margin: 0; color: #333333; font-size: 1.5rem; text-shadow: none;">
                            <i class="fas fa-calendar-check" style="color: #b8860b; margin-right: 10px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                            èª²ç¨‹ç°½åˆ°ç³»çµ±
                        </h2>
                    </div>
                    <button id="closeAttendanceModal" class="close-attendance-modal" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 215, 0, 0.4);
                        font-size: 1.5rem;
                        color: #333333;
                        cursor: pointer;
                        padding: 5px;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s ease;
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                    ">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="course-info" style="
                    margin-bottom: 20px; 
                    padding: 20px; 
                    background: 
                        radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.05) 0%, transparent 70%),
                        linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
                    border-radius: 15px; 
                    border: 1px solid rgba(255, 215, 0, 0.3);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    box-shadow: 
                        0 8px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
                ">
                    <div class="course-info-panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem;">
                        <div data-field="teacher" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">è¬›å¸«:</strong> <span id="currentTeacher">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="course" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">èª²ç¨‹:</strong> <span id="currentCourse">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="time" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ™‚é–“:</strong> <span id="currentTime">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="date" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ—¥æœŸ:</strong> <span id="currentDate">è¼‰å…¥ä¸­...</span></div>
                    </div>
                </div>
                
                <div id="attendanceContent">
                    <div style="text-align: center; padding: 60px 40px; color: #333333; background: linear-gradient(135deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05)); border-radius: 15px; transition: all 0.5s ease;">
                        <!-- å¡ç‰Œè¼‰å…¥å‹•ç•« -->
                        <div style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            gap: 10px;
                            margin-bottom: 30px;
                            perspective: 1000px;
                        ">
                            <div style="
                                width: 20px;
                                height: 30px;
                                background: linear-gradient(135deg, #b8860b, #daa520);
                                border-radius: 4px;
                                animation: cardBounceIn 0.6s ease-out infinite;
                                animation-delay: 0s;
                                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                            "></div>
                            <div style="
                                width: 20px;
                                height: 30px;
                                background: linear-gradient(135deg, #b8860b, #daa520);
                                border-radius: 4px;
                                animation: cardBounceIn 0.6s ease-out infinite;
                                animation-delay: 0.1s;
                                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                            "></div>
                            <div style="
                                width: 20px;
                                height: 30px;
                                background: linear-gradient(135deg, #b8860b, #daa520);
                                border-radius: 4px;
                                animation: cardBounceIn 0.6s ease-out infinite;
                                animation-delay: 0.2s;
                                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                            "></div>
                        </div>
                        <h3 style="margin: 0; color: #000000; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);">
                            <i class="fas fa-spinner" style="color: #ffd700; margin-right: 8px; animation: spin 1s linear infinite;"></i>
                            è¼‰å…¥å­¸ç”Ÿåå–®ä¸­...
                        </h3>
                        <p style="margin: 10px 0; color: #000000;">
                            æ­£åœ¨å¾è³‡æ–™åº«è¼‰å…¥å­¸ç”Ÿè³‡æ–™ï¼Œè«‹ç¨å€™
                        </p>
                    </div>
                </div>
            `;
            
            // é‡æ–°è¨­ç½®é—œé–‰æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            const closeBtn = document.getElementById('closeAttendanceModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    closeAttendanceModal();
                });
            }
            
            // å¡«å……èª²ç¨‹è³‡è¨Š
            setTimeout(() => {
                updateCourseInfoDisplay();
            }, 100);
            
            console.log('âœ… è¼‰å…¥ç•«é¢å·²é¡¯ç¤º');
        }

        // é¡¯ç¤ºå­¸ç”Ÿè¼‰å…¥ç‹€æ…‹ï¼ˆæ¶²æ…‹ç»ç’ƒè³ªæ„Ÿï¼‰
        function showStudentLoadingState() {
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // å‰µå»ºæ¶²æ…‹ç»ç’ƒè¼‰å…¥é®ç½©
            let loadingOverlay = modalContent.querySelector('.student-loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'student-loading-overlay';
                loadingOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: linear-gradient(135deg, 
                        rgba(255, 255, 255, 0.1) 0%, 
                        rgba(255, 255, 255, 0.05) 50%,
                        rgba(255, 255, 255, 0.1) 100%);
                    backdrop-filter: blur(25px);
                    -webkit-backdrop-filter: blur(25px);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    opacity: 0;
                    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow: 
                        0 8px 32px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
                `;
                
                // å‰µå»ºæ¶²æ…‹ç»ç’ƒè¼‰å…¥å®¹å™¨
                const loadingContainer = document.createElement('div');
                loadingContainer.style.cssText = `
                    background: linear-gradient(135deg, 
                        rgba(255, 255, 255, 0.25) 0%, 
                        rgba(255, 255, 255, 0.1) 50%,
                        rgba(255, 255, 255, 0.2) 100%);
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    border-radius: 24px;
                    padding: 40px 32px;
                    box-shadow: 
                        0 12px 40px rgba(0, 0, 0, 0.15),
                        0 4px 12px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
                    text-align: center;
                    position: relative;
                    overflow: hidden;
                    min-width: 280px;
                    transform: scale(0.9);
                    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                `;
                
                // å‰µå»ºèƒŒæ™¯æµå‹•æ•ˆæœï¼ˆæ·±é‡‘è‰²ç³»ï¼‰
                const liquidBackground = document.createElement('div');
                liquidBackground.style.cssText = `
                    position: absolute;
                    top: -50%;
                    left: -50%;
                    width: 200%;
                    height: 200%;
                    background: linear-gradient(45deg, 
                        rgba(184, 134, 11, 0.15) 0%,
                        rgba(212, 175, 55, 0.15) 25%,
                        rgba(255, 193, 7, 0.15) 50%,
                        rgba(255, 215, 0, 0.15) 75%,
                        rgba(255, 140, 0, 0.15) 100%);
                    animation: liquidFlow 8s ease-in-out infinite;
                    opacity: 0.7;
                `;
                
                // å‰µå»ºæ¶²æ…‹è¼‰å…¥å™¨
                const liquidLoader = document.createElement('div');
                liquidLoader.style.cssText = `
                    width: 60px;
                    height: 60px;
                    margin: 0 auto 20px;
                    position: relative;
                    transform: translateZ(0);
                `;
                
                // å‰µå»ºå¤–å±¤æ¶²æ…‹ç’°ï¼ˆæ·±é‡‘è‰²ï¼‰
                const outerRing = document.createElement('div');
                outerRing.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border: 3px solid transparent;
                    border-top: 3px solid rgba(184, 134, 11, 0.6);
                    border-right: 3px solid rgba(212, 175, 55, 0.6);
                    border-radius: 50%;
                    animation: liquidSpin 2s linear infinite;
                    position: absolute;
                    top: 0;
                    left: 0;
                `;
                
                // å‰µå»ºå…§å±¤æ¶²æ…‹ç’°ï¼ˆæ·±é‡‘è‰²ï¼‰
                const innerRing = document.createElement('div');
                innerRing.style.cssText = `
                    width: 60%;
                    height: 60%;
                    border: 2px solid transparent;
                    border-bottom: 2px solid rgba(255, 193, 7, 0.7);
                    border-left: 2px solid rgba(255, 215, 0, 0.7);
                    border-radius: 50%;
                    animation: liquidSpin 1.5s linear infinite reverse;
                    position: absolute;
                    top: 20%;
                    left: 20%;
                `;
                
                // å‰µå»ºä¸­å¿ƒæ¶²æ…‹çƒï¼ˆæ·±é‡‘è‰²ï¼‰
                const centerBall = document.createElement('div');
                centerBall.style.cssText = `
                    width: 12px;
                    height: 12px;
                    background: linear-gradient(135deg, 
                        rgba(184, 134, 11, 0.9) 0%,
                        rgba(255, 193, 7, 0.9) 50%,
                        rgba(255, 215, 0, 0.9) 100%);
                    border-radius: 50%;
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    animation: liquidPulse 1.5s ease-in-out infinite;
                    box-shadow: 
                        0 0 15px rgba(184, 134, 11, 0.6),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
                `;
                
                // å‰µå»ºè¼‰å…¥æ–‡å­—
                const loadingText = document.createElement('div');
                loadingText.innerHTML = `
                    <div style="
                        font-size: 16px;
                        font-weight: 600;
                        color: #000000;
                        margin-bottom: 8px;
                        text-shadow: 0 2px 4px rgba(255, 255, 255, 0.3);
                        letter-spacing: 0.5px;
                    ">è¼‰å…¥å­¸ç”Ÿåå–®ä¸­</div>
                    <div style="
                        font-size: 13px;
                        color: #333333;
                        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.2);
                    ">è«‹ç¨å€™ï¼Œè¼‰å…¥å®Œæˆå¾Œæœƒè‡ªå‹•é¡¯ç¤º</div>
                `;
                
                // çµ„è£è¼‰å…¥å‹•ç•«
                liquidLoader.appendChild(outerRing);
                liquidLoader.appendChild(innerRing);
                liquidLoader.appendChild(centerBall);
                
                loadingContainer.appendChild(liquidBackground);
                loadingContainer.appendChild(liquidLoader);
                loadingContainer.appendChild(loadingText);
                
                loadingOverlay.appendChild(loadingContainer);
                modalContent.appendChild(loadingOverlay);
            }
            
            // é¡¯ç¤ºå‹•ç•«
            loadingOverlay.style.display = 'flex';
            requestAnimationFrame(() => {
                loadingOverlay.style.opacity = '1';
                const container = loadingOverlay.querySelector('div');
                if (container) {
                    container.style.transform = 'scale(1)';
                }
            });
        }

        // éš±è—å­¸ç”Ÿè¼‰å…¥ç‹€æ…‹
        function hideStudentLoadingState() {
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            const loadingOverlay = modalContent.querySelector('.student-loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }


        // é¡¯ç¤ºè¬›å¸«ç°½åˆ°å…§å®¹
        function showTeacherAttendance() {
            console.log('ğŸ‘¨â€ğŸ« é¡¯ç¤ºè¬›å¸«ç°½åˆ°å…§å®¹');
            
            // ç²å–æ¨¡æ…‹æ¡†å…§å®¹
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) return;
            
            // æ·»åŠ å·¦ç§»å‹•ç•«é¡åˆ¥
            modalContent.classList.add('slide-left');
            
            // åœ¨æ›¿æ›å…§å®¹ä¹‹å‰ï¼Œå…ˆä¿å­˜åŸå§‹çš„å­¸ç”Ÿç°½åˆ°å…§å®¹
            const attendanceContent = document.getElementById('attendanceContent');
            let originalStudentContent = null;
            if (attendanceContent) {
                // æª¢æŸ¥æ˜¯å¦åŒ…å«å­¸ç”Ÿç°½åˆ°å…§å®¹
                const hasStudentContent = attendanceContent.querySelector('.student-card') || 
                                        attendanceContent.querySelector('.attendance-btn') ||
                                        attendanceContent.innerHTML.includes('å­¸ç”Ÿç°½åˆ°');
                
                if (hasStudentContent) {
                    console.log('ğŸ’¾ åœ¨åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°å‰ä¿å­˜åŸå§‹å­¸ç”Ÿç°½åˆ°å…§å®¹');
                    originalStudentContent = attendanceContent.innerHTML;
                    window.originalStudentContent = originalStudentContent;
                    console.log('âœ… åŸå§‹å­¸ç”Ÿç°½åˆ°å…§å®¹å·²ä¿å­˜åˆ° window.originalStudentContent');
                }
            }
            
            // å‰µå»ºè¬›å¸«å ±è¡¨å…§å®¹
            const teacherAttendanceContent = document.createElement('div');
            teacherAttendanceContent.className = 'teacher-attendance-content';
            teacherAttendanceContent.style.opacity = '0';
            teacherAttendanceContent.style.transform = 'translateX(20px)';
            teacherAttendanceContent.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
            teacherAttendanceContent.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    padding: 8px;
                    position: relative;
                ">
                    
                    <!-- èº«ä»½é¸æ“‡å€åŸŸ -->
                    <div class="glass-card" style="
                        background: linear-gradient(135deg, 
                            rgba(255, 255, 255, 0.25) 0%, 
                            rgba(255, 255, 255, 0.1) 50%,
                            rgba(255, 255, 255, 0.2) 100%);
                        backdrop-filter: blur(25px);
                        -webkit-backdrop-filter: blur(25px);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        border-radius: 20px;
                        padding: 12px;
                        box-shadow: 
                            0 8px 32px rgba(0, 0, 0, 0.1),
                            0 2px 8px rgba(0, 0, 0, 0.05),
                            inset 0 1px 0 rgba(255, 255, 255, 0.4),
                            inset 0 -1px 0 rgba(0, 0, 0, 0.05);
                        position: relative;
                    ">
                        <!-- èƒŒæ™¯å…‰æ•ˆ -->
                        <div style="
                            position: absolute;
                            top: -50%;
                            left: -50%;
                            width: 200%;
                            height: 200%;
                            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
                            animation: shimmer 6s ease-in-out infinite;
                            pointer-events: none;
                        "></div>
                        
                        <div style="position: relative; z-index: 1;">
                            <h4 style="
                                margin: 0 0 8px 0;
                                color: #2c3e50;
                                font-size: 1rem;
                                font-weight: 700;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            ">
                                <i class="fas fa-users" style="
                                    color: #ffd700;
                                    font-size: 1.1rem;
                                    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
                                "></i>
                                èº«ä»½é¸æ“‡
                            </h4>
                            <p style="
                                margin: 0 0 12px 0;
                                color: #5a6c7d;
                                font-size: 0.85rem;
                                line-height: 1.4;
                            ">è«‹é¸æ“‡æ‚¨çš„èº«ä»½ä»¥æ­£ç¢ºè¨­å®šäººæ•¸</p>
                        
                        <div style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 12px;
                            margin-bottom: 12px;
                        ">
                            <button class="mode-btn teacher-mode active" id="teacher-mode-btn" style="
                                background: linear-gradient(135deg, 
                                    rgba(59, 130, 246, 0.3) 0%, 
                                    rgba(59, 130, 246, 0.15) 50%,
                                    rgba(59, 130, 246, 0.25) 100%);
                                backdrop-filter: blur(20px);
                                -webkit-backdrop-filter: blur(20px);
                                color: #1e40af;
                                border: 2px solid rgba(59, 130, 246, 0.4);
                                padding: 14px 12px;
                                border-radius: 16px;
                                cursor: pointer;
                                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                                text-align: center;
                                box-shadow: 
                                    0 4px 16px rgba(59, 130, 246, 0.3),
                                    0 2px 4px rgba(0, 0, 0, 0.1),
                                    inset 0 1px 0 rgba(255, 255, 255, 0.5),
                                    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
                                position: relative;
                                overflow: hidden;
                                font-family: inherit;
                            ">
                                <!-- æŒ‰éˆ•å…‰æ•ˆ -->
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: -100%;
                                    width: 100%;
                                    height: 100%;
                                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                                    transition: left 0.6s ease;
                                "></div>
                                
                                <i class="fas fa-chalkboard-teacher" style="
                                    font-size: 1.4rem; 
                                    margin-bottom: 6px; 
                                    display: block; 
                                    color: #ffd700;
                                    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
                                "></i>
                                <div style="
                                    font-weight: 700; 
                                    margin-bottom: 4px; 
                                    font-size: 0.9rem;
                                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                                ">è¬›å¸«æ¨¡å¼</div>
                                <div style="
                                    font-size: 0.65rem; 
                                    opacity: 0.9;
                                    color: #5a6c7d;
                                    line-height: 1.2;
                                ">è‡ªå‹•è¨ˆç®—èª²ç¨‹äººæ•¸</div>
                            </button>
                            
                            <button class="mode-btn assistant-mode" id="assistant-mode-btn" style="
                                background: linear-gradient(135deg, 
                                    rgba(34, 197, 94, 0.3) 0%, 
                                    rgba(34, 197, 94, 0.15) 50%,
                                    rgba(34, 197, 94, 0.25) 100%);
                                backdrop-filter: blur(20px);
                                -webkit-backdrop-filter: blur(20px);
                                color: #166534;
                                border: 2px solid rgba(34, 197, 94, 0.4);
                                padding: 14px 12px;
                                border-radius: 16px;
                                cursor: pointer;
                                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                                text-align: center;
                                box-shadow: 
                                    0 4px 16px rgba(34, 197, 94, 0.3),
                                    0 2px 4px rgba(0, 0, 0, 0.1),
                                    inset 0 1px 0 rgba(255, 255, 255, 0.5),
                                    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
                                position: relative;
                                overflow: hidden;
                                font-family: inherit;
                            ">
                                <!-- æŒ‰éˆ•å…‰æ•ˆ -->
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: -100%;
                                    width: 100%;
                                    height: 100%;
                                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                                    transition: left 0.6s ease;
                                "></div>
                                
                                <i class="fas fa-user-graduate" style="
                                    font-size: 1.4rem; 
                                    margin-bottom: 6px; 
                                    display: block; 
                                    color: #6c757d;
                                    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
                                "></i>
                                <div style="
                                    font-weight: 700; 
                                    margin-bottom: 4px; 
                                    font-size: 0.9rem;
                                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                                ">åŠ©æ•™æ¨¡å¼</div>
                                <div style="
                                    font-size: 0.75rem; 
                                    opacity: 0.9;
                                    color: #5a6c7d;
                                ">äººæ•¸è¨­ç‚º 0</div>
                            </button>
                        </div>
                        
                        <div style="
                            text-align: center;
                            padding: 12px;
                            background: linear-gradient(135deg, 
                                rgba(255, 215, 0, 0.15) 0%, 
                                rgba(255, 215, 0, 0.08) 100%);
                            border-radius: 12px;
                            font-size: 0.85rem;
                            border: 1px solid rgba(255, 215, 0, 0.2);
                            box-shadow: 
                                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                                inset 0 -1px 0 rgba(0, 0, 0, 0.05);
                        ">
                            <span style="color: #5a6c7d; font-weight: 500;">ç›®å‰æ¨¡å¼ï¼š</span>
                            <span id="current-mode-display" style="
                                font-weight: 700; 
                                color: #2c3e50;
                                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            ">è¬›å¸«æ¨¡å¼</span>
                        </div>
                        </div>
                    </div>
                    
                    <!-- èª²ç¨‹å…§å®¹å€åŸŸ -->
                    <div class="glass-card" style="
                        background: linear-gradient(135deg, 
                            rgba(255, 255, 255, 0.25) 0%, 
                            rgba(255, 255, 255, 0.1) 50%,
                            rgba(255, 255, 255, 0.2) 100%);
                        backdrop-filter: blur(25px);
                        -webkit-backdrop-filter: blur(25px);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        border-radius: 20px;
                        padding: 16px;
                        box-shadow: 
                            0 8px 32px rgba(0, 0, 0, 0.1),
                            0 2px 8px rgba(0, 0, 0, 0.05),
                            inset 0 1px 0 rgba(255, 255, 255, 0.4),
                            inset 0 -1px 0 rgba(0, 0, 0, 0.05);
                        position: relative;
                    ">
                        <!-- èƒŒæ™¯å…‰æ•ˆ -->
                        <div style="
                            position: absolute;
                            top: -50%;
                            left: -50%;
                            width: 200%;
                            height: 200%;
                            background: radial-gradient(circle, rgba(52, 152, 219, 0.1) 0%, transparent 70%);
                            animation: shimmer 6s ease-in-out infinite;
                            pointer-events: none;
                        "></div>
                        
                        <div style="position: relative; z-index: 1;">
                            <h3 style="
                                margin: 0 0 8px 0;
                                color: #2c3e50;
                                font-size: 1rem;
                                font-weight: 700;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            ">
                                <i class="fas fa-calendar-day" style="
                                    color: #3498db;
                                    font-size: 1.1rem;
                                    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
                                "></i>
                                ä»Šæ—¥å ±è¡¨
                            </h3>
                        
                        <div style="margin-bottom: 8px;">
                            <label for="course-content" style="
                                display: block;
                                margin-bottom: 6px;
                                font-weight: 600;
                                color: #2c3e50;
                                font-size: 0.9rem;
                                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            ">èª²ç¨‹å…§å®¹ï¼š</label>
                            <textarea 
                                id="course-content" 
                                placeholder="è«‹æè¿°ä»Šå¤©çš„èª²ç¨‹å…§å®¹..."
                                rows="3"
                                maxlength="500"
                                style="
                                    width: 100%;
                                    padding: 10px 12px;
                                    background: linear-gradient(135deg, 
                                        rgba(255, 255, 255, 0.2) 0%, 
                                        rgba(255, 255, 255, 0.1) 100%);
                                    backdrop-filter: blur(15px);
                                    -webkit-backdrop-filter: blur(15px);
                                    border: 2px solid rgba(255, 255, 255, 0.3);
                                    border-radius: 10px;
                                    font-size: 0.85rem;
                                    font-family: inherit;
                                    resize: vertical;
                                    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                                    color: #2c3e50;
                                    box-shadow: 
                                        inset 0 2px 4px rgba(0, 0, 0, 0.1),
                                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                                        0 2px 8px rgba(0, 0, 0, 0.05);
                                    outline: none;
                                "
                            ></textarea>
                            <div class="char-count" style="
                                text-align: right;
                                margin-top: 6px;
                                font-size: 0.75rem;
                                color: #5a6c7d;
                                font-weight: 500;
                            ">
                                <span id="char-count">0</span>/500
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- äººæ•¸é¸æ“‡ï¼ˆåƒ…åœ¨æ²’æœ‰å­¸ç”Ÿæ™‚é¡¯ç¤ºï¼‰ -->
                    <div id="student-count-selection" class="glass-card" style="
                        background: linear-gradient(135deg, 
                            rgba(255, 255, 255, 0.25) 0%, 
                            rgba(255, 255, 255, 0.1) 50%,
                            rgba(255, 255, 255, 0.2) 100%);
                        backdrop-filter: blur(25px);
                        -webkit-backdrop-filter: blur(25px);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        border-radius: 20px;
                        padding: 24px;
                        box-shadow: 
                            0 8px 32px rgba(0, 0, 0, 0.1),
                            0 2px 8px rgba(0, 0, 0, 0.05),
                            inset 0 1px 0 rgba(255, 255, 255, 0.4),
                            inset 0 -1px 0 rgba(0, 0, 0, 0.05);
                        position: relative;
                        overflow: hidden;
                        display: none;
                        max-height: none;
                        overflow-y: visible;
                    ">
                        <!-- èƒŒæ™¯å…‰æ•ˆ -->
                        <div style="
                            position: absolute;
                            top: -50%;
                            left: -50%;
                            width: 200%;
                            height: 200%;
                            background: radial-gradient(circle, rgba(46, 204, 113, 0.1) 0%, transparent 70%);
                            animation: shimmer 6s ease-in-out infinite;
                            pointer-events: none;
                        "></div>
                        
                        <div style="position: relative; z-index: 1;">
                        <h4 style="
                            margin: 0 0 12px 0;
                            color: #333;
                            font-size: 0.9rem;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        ">
                            <i class="fas fa-user-friends"></i>
                            äººæ•¸è¨­å®š
                        </h4>
                        <p style="
                            margin: 0 0 24px 0;
                            color: #666;
                            font-size: 0.8rem;
                        ">æ­¤èª²ç¨‹æ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œè«‹é¸æ“‡å¯¦éš›å‡ºå¸­äººæ•¸</p>
                        
                        <div style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 20px;
                        ">
                            <button class="count-btn" id="count-2-btn" style="
                                background: white;
                                border: 2px solid #e9ecef;
                                border-radius: 10px;
                                padding: 16px 12px;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                text-align: center;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                gap: 6px;
                                min-height: 80px;
                            ">
                                <i class="fas fa-users" style="font-size: 1.5rem; color: #666;"></i>
                                <span style="font-weight: 600; font-size: 0.8rem; color: #333;">2äººï¼ˆå«ï¼‰ä»¥ä¸‹</span>
                                <span style="font-size: 0.7rem; color: #666;">å°ç­æ•™å­¸</span>
                            </button>
                            <button class="count-btn" id="count-30-btn" style="
                                background: white;
                                border: 2px solid #e9ecef;
                                border-radius: 10px;
                                padding: 16px 12px;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                text-align: center;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                gap: 6px;
                                min-height: 80px;
                            ">
                                <i class="fas fa-users" style="font-size: 1.5rem; color: #666;"></i>
                                <span style="font-weight: 600; font-size: 0.8rem; color: #333;">3äººï¼ˆå«ï¼‰ä»¥ä¸Š</span>
                                <span style="font-size: 0.7rem; color: #666;">å¤§ç­æ•™å­¸</span>
                            </button>
                        </div>
                        
                        <div style="
                            text-align: center;
                            padding: 8px;
                            background: rgba(255, 215, 0, 0.1);
                            border-radius: 6px;
                            font-size: 0.8rem;
                        ">
                            <span style="color: #666;">é¸æ“‡äººæ•¸ï¼š</span>
                            <span id="current-count-display" style="font-weight: 600; color: #333;">æœªé¸æ“‡</span>
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰éˆ•å€åŸŸ -->
                    <div style="
                        flex-shrink: 0;
                        text-align: center;
                        padding: 10px;
                        background: linear-gradient(135deg, 
                            rgba(255, 255, 255, 0.1) 0%, 
                            rgba(255, 255, 255, 0.05) 50%,
                            rgba(255, 255, 255, 0.1) 100%);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 15px;
                        box-shadow: 
                            0 4px 15px rgba(0, 0, 0, 0.1),
                            inset 0 1px 0 rgba(255, 255, 255, 0.2);
                    ">
                        <button class="btn-primary" id="submitTeacherReport" style="
                            background: linear-gradient(135deg, 
                                rgba(40, 167, 69, 0.8) 0%, 
                                rgba(32, 201, 151, 0.8) 100%);
                            backdrop-filter: blur(20px);
                            -webkit-backdrop-filter: blur(20px);
                            color: white;
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            padding: 15px 30px;
                            border-radius: 25px;
                            font-size: 0.9rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 
                                0 6px 20px rgba(40, 167, 69, 0.3),
                                inset 0 1px 0 rgba(255, 255, 255, 0.2);
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            width: 100%;
                            max-width: 200px;
                        ">
                            <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>
                            æäº¤è¬›å¸«å ±è¡¨
                        </button>
                    </div>
                    
                    <!-- é€æ˜ç©ºç™½å…ƒä»¶ç¢ºä¿æ»¾å‹•è§¸ç™¼ -->
                    <div style="
                        height: 100px;
                        background: transparent;
                        flex-shrink: 0;
                        pointer-events: none;
                    "></div>
                </div>
            `;
            
            // æ›¿æ›æ•´å€‹æ¨¡æ…‹æ¡†å…§å®¹ï¼Œä¿æŒå°èˆªå™¨
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <h2 style="margin: 0; color: #333333; font-size: 1.5rem; text-shadow: none;">
                            <i class="fas fa-calendar-check" style="color: #b8860b; margin-right: 10px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                            èª²ç¨‹ç°½åˆ°ç³»çµ±
                        </h2>
                    </div>
                    <button id="closeAttendanceModal" class="close-attendance-modal" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 215, 0, 0.4);
                        font-size: 1.5rem;
                        color: #333333;
                        cursor: pointer;
                        padding: 5px;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s ease;
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                    ">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="course-info" style="
                    margin-bottom: 20px; 
                    padding: 20px; 
                    background: 
                        radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.05) 0%, transparent 70%),
                        linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
                    border-radius: 15px; 
                    border: 1px solid rgba(255, 215, 0, 0.3);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    box-shadow: 
                        0 8px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
                ">
                    <div class="course-info-panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem;">
                        <div data-field="teacher" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">è¬›å¸«:</strong> <span id="currentTeacher">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="course" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">èª²ç¨‹:</strong> <span id="currentCourse">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="time" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ™‚é–“:</strong> <span id="currentTime">è¼‰å…¥ä¸­...</span></div>
                        <div data-field="date" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ—¥æœŸ:</strong> <span id="currentDate">è¼‰å…¥ä¸­...</span></div>
                    </div>
                </div>
                
                <div id="attendanceContent" style="
                    padding-right: 8px;
                    max-height: 80vh;
                    overflow-y: auto;
                    display: flex;
                    flex-direction: column;
                ">
                    <!-- è¬›å¸«å ±è¡¨å…§å®¹å°‡å‹•æ…‹æ’å…¥é€™è£¡ï¼Œä¸è¦†è“‹åŸå§‹å­¸ç”Ÿç°½åˆ°å…§å®¹ -->
                </div>
            `;
            
            // é‡æ–°è¨­ç½®é—œé–‰æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            const closeBtn = document.getElementById('closeAttendanceModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    closeAttendanceModal();
                });
            }
            
            // æ’å…¥è¬›å¸«å ±è¡¨å…§å®¹åˆ° attendanceContent
            const newAttendanceContent = document.getElementById('attendanceContent');
            if (newAttendanceContent) {
                console.log('ğŸ”„ æ’å…¥è¬›å¸«å ±è¡¨å…§å®¹åˆ° attendanceContent');
                newAttendanceContent.innerHTML = teacherAttendanceContent.innerHTML;
                
                // ç¢ºä¿æ’å…¥çš„å…§å®¹æœ‰æ­£ç¢ºçš„é¡åˆ¥
                const insertedContent = newAttendanceContent.querySelector('div[style*="overflow-y: auto"]');
                if (insertedContent) {
                    insertedContent.classList.add('teacher-attendance-content');
                }
            }
            
            // å¡«å……èª²ç¨‹è³‡è¨Š - ç«‹å³æ›´æ–°ä¸¦æ·»åŠ å¤šæ¬¡é‡è©¦
            console.log('ğŸ”„ è¬›å¸«å ±è¡¨é é¢é–‹å§‹æ›´æ–°èª²ç¨‹è³‡è¨Š');
            updateCourseInfoDisplay();
            setTimeout(() => {
                console.log('ğŸ”„ è¬›å¸«å ±è¡¨é é¢ç¬¬ä¸€æ¬¡é‡è©¦æ›´æ–°èª²ç¨‹è³‡è¨Š');
                updateCourseInfoDisplay();
            }, 100);
            setTimeout(() => {
                console.log('ğŸ”„ è¬›å¸«å ±è¡¨é é¢ç¬¬äºŒæ¬¡é‡è©¦æ›´æ–°èª²ç¨‹è³‡è¨Š');
                updateCourseInfoDisplay();
            }, 300);
            setTimeout(() => {
                console.log('ğŸ”„ è¬›å¸«å ±è¡¨é é¢ç¬¬ä¸‰æ¬¡é‡è©¦æ›´æ–°èª²ç¨‹è³‡è¨Š');
                updateCourseInfoDisplay();
            }, 500);
            setTimeout(() => {
                console.log('ğŸ”„ è¬›å¸«å ±è¡¨é é¢ç¬¬å››æ¬¡é‡è©¦æ›´æ–°èª²ç¨‹è³‡è¨Š');
                updateCourseInfoDisplay();
            }, 1000);
            
            // è§¸ç™¼è¬›å¸«å ±è¡¨å‹•ç•«
            setTimeout(() => {
                const contentElement = document.querySelector('.teacher-attendance-content');
                if (contentElement) {
                    contentElement.style.opacity = '1';
                    contentElement.style.transform = 'translateX(0)';
                }
            }, 100);
            
            // åˆå§‹åŒ–è¬›å¸«å ±è¡¨åŠŸèƒ½
            initializeTeacherReport();
            
            // äººæ•¸é¸æ“‡å€åŸŸä¸å†è‡ªå‹•æ»¾å‹•
            console.log('ğŸ“œ äººæ•¸é¸æ“‡å€åŸŸé¡¯ç¤ºï¼Œç„¡éœ€è‡ªå‹•æ»¾å‹•');
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šèª²ç¨‹ä¸¦é¡¯ç¤ºæç¤º
            setTimeout(() => {
                const originalTitle = window.currentAttendanceData?.originalTitle || '';
                const isCustomizedCourse = originalTitle.includes('å®¢è£½åŒ–') || 
                                        originalTitle.includes('åˆ°åºœ') || 
                                        originalTitle.includes('å®¢åˆ¶åŒ–') || 
                                        originalTitle.includes('å®¢è£½') || 
                                        originalTitle.includes('å®¢åˆ¶');
                
                // æª¢æŸ¥ç•¶å‰æ¨¡å¼ï¼Œåªæœ‰è¬›å¸«æ¨¡å¼æ‰é¡¯ç¤ºç‰¹æ®Šæç¤º
                const currentModeDisplay = document.getElementById('current-mode-display');
                const currentMode = currentModeDisplay ? currentModeDisplay.textContent : 'è¬›å¸«æ¨¡å¼';
                
                if (isCustomizedCourse && currentMode === 'è¬›å¸«æ¨¡å¼') {
                    // ä½¿ç”¨çµ±ä¸€çš„å‡½æ•¸ä¾†é¡¯ç¤ºç‰¹æ®Šæç¤º
                    checkAndShowSpecialNotice();
                }
            }, 500);
            
            // å¦‚æœå­¸ç”Ÿåå–®æ­£åœ¨è¼‰å…¥ä¸­ï¼Œåœ¨èƒŒæ™¯æŒçºŒè¼‰å…¥
            if (isStudentListLoading && !studentListLoadPromise) {
                console.log('ğŸ”„ å­¸ç”Ÿåå–®æ­£åœ¨è¼‰å…¥ä¸­ï¼Œåœ¨èƒŒæ™¯æŒçºŒè¼‰å…¥...');
                startBackgroundStudentLoading();
            }
        }

        // é–‹å§‹èƒŒæ™¯è¼‰å…¥å­¸ç”Ÿåå–®
        function startBackgroundStudentLoading() {
            console.log('ğŸ”„ é–‹å§‹èƒŒæ™¯è¼‰å…¥å­¸ç”Ÿåå–®...');
            
            // ç²å–ç•¶å‰èª²ç¨‹è³‡æ–™
            const currentData = window.currentAttendanceData;
            if (!currentData) {
                console.error('âŒ æ²’æœ‰ç•¶å‰èª²ç¨‹è³‡æ–™ï¼Œç„¡æ³•èƒŒæ™¯è¼‰å…¥');
                isStudentListLoading = false;
                studentListLoadPromise = null;
                return;
            }
            
            studentListLoadPromise = new Promise(async (resolve) => {
                try {
                    // å¯¦éš›è¼‰å…¥å­¸ç”Ÿè³‡æ–™
                    await loadCourseStudents(
                        currentData.teacher,
                        currentData.course,
                        currentData.time,
                        currentData.start,
                        currentData.end,
                        currentData.minutesUntilStart
                    );
                    
                    console.log('âœ… èƒŒæ™¯è¼‰å…¥å­¸ç”Ÿåå–®å®Œæˆ');
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    // é¡¯ç¤ºè¼‰å…¥å®Œæˆé€šçŸ¥
                    showToast('å­¸ç”Ÿåå–®è¼‰å…¥å®Œæˆï¼', 'success');
                    
                    resolve();
                } catch (error) {
                    console.error('âŒ èƒŒæ™¯è¼‰å…¥å­¸ç”Ÿåå–®å¤±æ•—:', error);
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    // é¡¯ç¤ºè¼‰å…¥å¤±æ•—é€šçŸ¥
                    showToast('å­¸ç”Ÿåå–®è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                    
                    resolve(); // å³ä½¿å¤±æ•—ä¹Ÿè¦resolveï¼Œé¿å…Promise pending
                }
            });
        }

        // å…¨åŸŸè®Šæ•¸ï¼šé¸ä¸­çš„äººæ•¸
        let selectedStudentCount = null;
        
        // è‡ªå‹•æäº¤ç›¸é—œè®Šæ•¸
        let autoSubmitTimer = null;
        let autoSubmitCountdown = 0;
        let isAutoSubmitEnabled = false;
        
        // è¨­å®šå­¸ç”Ÿäººæ•¸
        function setStudentCount(count) {
            // åœæ­¢ç•¶å‰çš„è‡ªå‹•æäº¤è¨ˆæ™‚å™¨
            stopAutoSubmitCountdown();
            
            selectedStudentCount = count;
            updateStudentCountDisplay();
            showToast(`å·²é¸æ“‡ ${count} äººï¼ˆå«ï¼‰${count === 2 ? 'ä»¥ä¸‹' : 'ä»¥ä¸Š'}`, 'info');
            
            // é¸æ“‡äººæ•¸å¾Œæª¢æŸ¥è‡ªå‹•æäº¤æ¢ä»¶ï¼ˆå»¶é²æ›´é•·æ™‚é–“ç¢ºä¿é‡ç½®å®Œæˆï¼‰
            animationManager.setTimeout(() => {
                console.log('ğŸ”„ äººæ•¸é¸æ“‡å®Œæˆï¼Œæª¢æŸ¥è‡ªå‹•æäº¤æ¢ä»¶');
                checkAutoSubmit();
            }, 500);
        }
        
        // æ›´æ–°å­¸ç”Ÿäººæ•¸é¡¯ç¤º
        function updateStudentCountDisplay() {
            const count2Btn = document.getElementById('count-2-btn');
            const count30Btn = document.getElementById('count-30-btn');
            const countDisplay = document.getElementById('current-count-display');
            
            if (!count2Btn || !count30Btn || !countDisplay) return;
            
            // é‡ç½®æ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹
            count2Btn.classList.remove('active');
            count30Btn.classList.remove('active');
            count2Btn.style.borderColor = '#e9ecef';
            count30Btn.style.borderColor = '#e9ecef';
            count2Btn.style.borderWidth = '3px';
            count30Btn.style.borderWidth = '3px';
            
            if (selectedStudentCount === 2) {
                count2Btn.classList.add('active');
                count2Btn.style.borderColor = '#ff6b35';
                count2Btn.style.borderWidth = '4px';
                countDisplay.textContent = '2äººï¼ˆå«ï¼‰ä»¥ä¸‹';
            } else if (selectedStudentCount === 30) {
                count30Btn.classList.add('active');
                count30Btn.style.borderColor = '#ff6b35';
                count30Btn.style.borderWidth = '4px';
                countDisplay.textContent = '3äººï¼ˆå«ï¼‰ä»¥ä¸Š';
            } else {
                countDisplay.textContent = 'æœªé¸æ“‡';
            }
        }
        
        // åˆå§‹åŒ–è¬›å¸«å ±è¡¨åŠŸèƒ½
        function initializeTeacherReport() {
            console.log('ğŸ“ åˆå§‹åŒ–è¬›å¸«å ±è¡¨åŠŸèƒ½');
            
            // é è¨­è¨­ç½®ç‚ºè¬›å¸«æ¨¡å¼
            setTeacherMode();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å‰‡é¡¯ç¤ºäººæ•¸é¸æ“‡
            const studentCountSelection = document.getElementById('student-count-selection');
            if (studentCountSelection) {
                // æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿè³‡æ–™
                const hasStudents = window.loadedStudentsData && 
                                  window.loadedStudentsData.students && 
                                  window.loadedStudentsData.students.length > 0;
                
                if (!hasStudents) {
                    console.log('ğŸ“ æ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œé¡¯ç¤ºäººæ•¸é¸æ“‡');
                    studentCountSelection.style.display = 'block';
                    
                    // äººæ•¸é¸æ“‡å€åŸŸä¸å†è‡ªå‹•æ»¾å‹•
                    console.log('ğŸ“œ äººæ•¸é¸æ“‡å€åŸŸå·²é¡¯ç¤ºï¼Œç„¡éœ€æ»¾å‹•');
                } else {
                    console.log('ğŸ“ æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œéš±è—äººæ•¸é¸æ“‡');
                    studentCountSelection.style.display = 'none';
                    // æœ‰å­¸ç”Ÿè³‡æ–™æ™‚ï¼Œè‡ªå‹•è¨­ç½®äººæ•¸ç‚ºå¯¦éš›å‡ºå¸­çš„å­¸ç”Ÿæ•¸é‡
                    const presentStudents = window.loadedStudentsData.students.filter(student => 
                        student.status === 'present' || student.status === 'attended'
                    );
                    const studentCount = presentStudents.length;
                    selectedStudentCount = studentCount;
                    console.log('ğŸ“Š è‡ªå‹•è¨­ç½®å­¸ç”Ÿäººæ•¸ï¼ˆæ ¹æ“šå¯¦éš›å‡ºå¸­ï¼‰:', {
                        totalStudents: window.loadedStudentsData.students.length,
                        presentStudents: presentStudents.length,
                        presentStudentNames: presentStudents.map(s => s.name)
                    });
                }
            }
            
            // è¨­ç½®å­—æ•¸çµ±è¨ˆå’Œè‡ªå‹•æäº¤
            const courseContent = document.getElementById('course-content');
            const charCount = document.getElementById('char-count');
            
            if (courseContent && charCount) {
                courseContent.addEventListener('input', function() {
                    const count = this.value.length;
                    charCount.textContent = count;
                    
                    // å­—æ•¸æ¥è¿‘é™åˆ¶æ™‚è®Šè‰²
                    if (count > 450) {
                        charCount.style.color = '#dc3545';
                    } else if (count > 400) {
                        charCount.style.color = '#ffc107';
                    } else {
                        charCount.style.color = '#666';
                    }
                });
                
                // ç›£è½è¼¸å…¥äº‹ä»¶ - è¼¸å…¥æ™‚åœæ­¢å€’æ•¸
                courseContent.addEventListener('input', function() {
                    // åœæ­¢ç•¶å‰çš„å€’æ•¸è¨ˆæ™‚
                    stopAutoSubmitCountdown();
                });
                
                // ç›£è½å¤±å»ç„¦é»äº‹ä»¶ - è¼¸å…¥å®Œæˆæ™‚è§¸ç™¼è‡ªå‹•æäº¤æª¢æŸ¥
                courseContent.addEventListener('blur', function() {
                    // å»¶é²ä¸€é»æ™‚é–“å†æª¢æŸ¥ï¼Œç¢ºä¿ç”¨æˆ¶å·²ç¶“å®Œæˆè¼¸å…¥
                    animationManager.setTimeout(() => {
                        checkAutoSubmit();
                    }, 100);
                });
                
                // ç›£è½Enteréµäº‹ä»¶ - æŒ‰Enteræ™‚è§¸ç™¼è‡ªå‹•æäº¤æª¢æŸ¥
                courseContent.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        // é˜»æ­¢æ›è¡Œ
                        event.preventDefault();
                        // è§¸ç™¼è‡ªå‹•æäº¤æª¢æŸ¥
                        animationManager.setTimeout(() => {
                            checkAutoSubmit();
                        }, 100);
                    }
                });
            }
            
            // è¨­ç½®èº«ä»½é¸æ“‡æŒ‰éˆ•
            const teacherModeBtn = document.getElementById('teacher-mode-btn');
            const assistantModeBtn = document.getElementById('assistant-mode-btn');
            const currentModeDisplay = document.getElementById('current-mode-display');
            
            if (teacherModeBtn && assistantModeBtn && currentModeDisplay) {
                // æ·»åŠ è¬›å¸«æ¨¡å¼æŒ‰éˆ•çš„hoveræ•ˆæœ
                teacherModeBtn.addEventListener('mouseenter', () => {
                    teacherModeBtn.style.transform = 'translateY(-2px) scale(1.02)';
                    teacherModeBtn.style.boxShadow = '0 8px 25px rgba(59, 130, 246, 0.4), 0 4px 8px rgba(0, 0, 0, 0.15)';
                });
                
                teacherModeBtn.addEventListener('mouseleave', () => {
                    if (currentModeDisplay.textContent === 'è¬›å¸«æ¨¡å¼') {
                        teacherModeBtn.style.transform = 'translateY(0) scale(1)';
                        teacherModeBtn.style.boxShadow = '0 4px 16px rgba(59, 130, 246, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.5), inset 0 -1px 0 rgba(0, 0, 0, 0.1)';
                    } else {
                        teacherModeBtn.style.transform = 'translateY(0) scale(1)';
                        teacherModeBtn.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.05)';
                    }
                });
                
                // æ·»åŠ åŠ©æ•™æ¨¡å¼æŒ‰éˆ•çš„hoveræ•ˆæœ
                assistantModeBtn.addEventListener('mouseenter', () => {
                    assistantModeBtn.style.transform = 'translateY(-2px) scale(1.02)';
                    assistantModeBtn.style.boxShadow = '0 8px 25px rgba(34, 197, 94, 0.4), 0 4px 8px rgba(0, 0, 0, 0.15)';
                });
                
                assistantModeBtn.addEventListener('mouseleave', () => {
                    if (currentModeDisplay.textContent === 'åŠ©æ•™æ¨¡å¼') {
                        assistantModeBtn.style.transform = 'translateY(0) scale(1)';
                        assistantModeBtn.style.boxShadow = '0 4px 16px rgba(34, 197, 94, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.5), inset 0 -1px 0 rgba(0, 0, 0, 0.1)';
                    } else {
                        assistantModeBtn.style.transform = 'translateY(0) scale(1)';
                        assistantModeBtn.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.05)';
                    }
                });
                
                teacherModeBtn.addEventListener('click', () => {
                    console.log('ğŸ‘¨â€ğŸ« è¬›å¸«æ¨¡å¼æŒ‰éˆ•è¢«é»æ“Š');
                    // æ·»åŠ é»æ“Šæ•ˆæœ
                    teacherModeBtn.style.transform = 'translateY(0) scale(0.98)';
                    setTimeout(() => {
                        teacherModeBtn.style.transform = 'translateY(-2px) scale(1.02)';
                    }, 150);
                    
                    // åœæ­¢ç•¶å‰çš„å€’æ•¸è¨ˆæ™‚
                    stopAutoSubmitCountdown();
                    setTeacherMode();
                    // å»¶é²ä¸€é»æ™‚é–“å†æª¢æŸ¥ï¼Œç¢ºä¿æ¨¡å¼å·²è¨­ç½®å®Œæˆ
                    animationManager.setTimeout(() => {
                        console.log('ğŸ”„ è¬›å¸«æ¨¡å¼è¨­ç½®å®Œæˆï¼Œæª¢æŸ¥è‡ªå‹•æäº¤æ¢ä»¶');
                        checkAutoSubmit();
                    }, 100);
                });
                
                assistantModeBtn.addEventListener('click', () => {
                    console.log('ğŸ‘¨â€ğŸ“ åŠ©æ•™æ¨¡å¼æŒ‰éˆ•è¢«é»æ“Š');
                    // æ·»åŠ é»æ“Šæ•ˆæœ
                    assistantModeBtn.style.transform = 'translateY(0) scale(0.98)';
                    setTimeout(() => {
                        assistantModeBtn.style.transform = 'translateY(-2px) scale(1.02)';
                    }, 150);
                    
                    // åœæ­¢ç•¶å‰çš„å€’æ•¸è¨ˆæ™‚
                    stopAutoSubmitCountdown();
                    setAssistantMode();
                    // å»¶é²ä¸€é»æ™‚é–“å†æª¢æŸ¥ï¼Œç¢ºä¿æ¨¡å¼å·²è¨­ç½®å®Œæˆ
                    animationManager.setTimeout(() => {
                        console.log('ğŸ”„ åŠ©æ•™æ¨¡å¼è¨­ç½®å®Œæˆï¼Œæª¢æŸ¥è‡ªå‹•æäº¤æ¢ä»¶');
                        checkAutoSubmit();
                    }, 100);
                });
            }
            
            // éš±è—æäº¤æŒ‰éˆ•ï¼ˆå› ç‚ºä½¿ç”¨è‡ªå‹•æäº¤ï¼‰
            const submitBtn = document.getElementById('submitTeacherReport');
            if (submitBtn) {
                submitBtn.style.display = 'none';
            }
            
            // æ·»åŠ äººæ•¸é¸æ“‡æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            const count2Btn = document.getElementById('count-2-btn');
            const count30Btn = document.getElementById('count-30-btn');
            
            if (count2Btn) {
                count2Btn.addEventListener('click', () => setStudentCount(2));
            }
            
            if (count30Btn) {
                count30Btn.addEventListener('click', () => setStudentCount(30));
            }
            
            // æ·»åŠ èª²ç¨‹å…§å®¹è¼¸å…¥æ¡†çš„ç„¦é»äº‹ä»¶
            if (courseContent) {
                courseContent.addEventListener('focus', function() {
                    this.style.borderColor = 'rgba(52, 152, 219, 0.5)';
                    this.style.boxShadow = 'inset 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.4), 0 0 0 3px rgba(52, 152, 219, 0.1)';
                    
                    // è‡ªå‹•æ»¾å‹•åˆ°æ–‡å­—è¼¸å…¥æ¡†ä½ç½®
                    scrollToTextInput(this);
                });
                
                courseContent.addEventListener('blur', function() {
                    this.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    this.style.boxShadow = 'inset 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.4), 0 2px 8px rgba(0, 0, 0, 0.05)';
                });
                
                // æ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆç”¨æ–¼è§¸æ§è¨­å‚™ï¼‰
                courseContent.addEventListener('click', function() {
                    // å»¶é²ä¸€é»æ™‚é–“ç¢ºä¿ç„¦é»äº‹ä»¶å…ˆè§¸ç™¼
                    setTimeout(() => {
                        scrollToTextInput(this);
                    }, 50);
                });
            }
        }

        // æ»¾å‹•åˆ°æ–‡å­—è¼¸å…¥æ¡†ä½ç½®
        function scrollToTextInput(textInput) {
            try {
                console.log('ğŸ“œ é–‹å§‹æ»¾å‹•åˆ°æ–‡å­—è¼¸å…¥æ¡†...');
                window.scrollToTextInputCalled = true;
                
                // æ‰¾åˆ°æ»¾å‹•å®¹å™¨ - ä½¿ç”¨æ›´ç©©å®šçš„é¸æ“‡æ–¹å¼
                let scrollContainer = null;
                
                // é¦–å…ˆå˜—è©¦æ‰¾åˆ°æ¨¡æ…‹æ¡†å…§å®¹ï¼ˆæœ€å¸¸è¦‹çš„æ»¾å‹•å®¹å™¨ï¼‰
                const modalContent = document.querySelector('.attendance-modal-content');
                if (modalContent) {
                    // æª¢æŸ¥æ¨¡æ…‹æ¡†å…§å®¹æœ¬èº«æ˜¯å¦å¯æ»¾å‹•
                    if (modalContent.scrollHeight > modalContent.clientHeight) {
                        scrollContainer = modalContent;
                    } else {
                        // å¦‚æœæ¨¡æ…‹æ¡†å…§å®¹ä¸å¯æ»¾å‹•ï¼ŒæŸ¥æ‰¾å…¶å…§éƒ¨çš„æ»¾å‹•å®¹å™¨
                        const innerScrollDiv = modalContent.querySelector('div[style*="overflow-y: auto"]');
                        if (innerScrollDiv && innerScrollDiv.scrollHeight > innerScrollDiv.clientHeight) {
                            scrollContainer = innerScrollDiv;
                        }
                    }
                }
                
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦æ‰¾åˆ°è¬›å¸«å…§å®¹çš„æ»¾å‹•å®¹å™¨
                if (!scrollContainer) {
                    const teacherContent = document.querySelector('.teacher-attendance-content');
                    if (teacherContent) {
                        const scrollDiv = teacherContent.querySelector('div[style*="overflow-y: auto"]');
                        if (scrollDiv && scrollDiv.scrollHeight > scrollDiv.clientHeight) {
                            scrollContainer = scrollDiv;
                        }
                    }
                }
                
                // å¦‚æœé‚„æ˜¯æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦æ‰¾åˆ°ä»»ä½•å¯æ»¾å‹•çš„å®¹å™¨
                if (!scrollContainer) {
                    const allScrollDivs = document.querySelectorAll('div[style*="overflow-y: auto"]');
                    for (const div of allScrollDivs) {
                        if (div.scrollHeight > div.clientHeight) {
                            scrollContainer = div;
                            break;
                        }
                    }
                }
                
                // æœ€å¾Œå˜—è©¦ä½¿ç”¨æ¨¡æ…‹æ¡†å…§å®¹ï¼Œå³ä½¿å®ƒä¸å¯æ»¾å‹•
                if (!scrollContainer && modalContent) {
                    scrollContainer = modalContent;
                }
                
                if (!scrollContainer) {
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°æ»¾å‹•å®¹å™¨');
                    console.log('ğŸ” èª¿è©¦ä¿¡æ¯:', {
                        modalContent: !!document.querySelector('.attendance-modal-content'),
                        teacherContent: !!teacherContent,
                        teacherScrollDiv: teacherContent ? !!teacherContent.querySelector('div[style*="overflow-y: auto"]') : false,
                        anyScrollDiv: !!document.querySelector('div[style*="overflow-y: auto"]')
                    });
                    return;
                }
                
                console.log('âœ… æ‰¾åˆ°æ»¾å‹•å®¹å™¨:', {
                    tagName: scrollContainer.tagName,
                    className: scrollContainer.className,
                    scrollHeight: scrollContainer.scrollHeight,
                    clientHeight: scrollContainer.clientHeight,
                    scrollTop: scrollContainer.scrollTop
                });
                
                // è¨ˆç®—æ–‡å­—è¼¸å…¥æ¡†ç›¸å°æ–¼æ»¾å‹•å®¹å™¨çš„ä½ç½®
                const textInputRect = textInput.getBoundingClientRect();
                const containerRect = scrollContainer.getBoundingClientRect();
                
                // è¨ˆç®—éœ€è¦æ»¾å‹•çš„è·é›¢ï¼ˆè®“æ–‡å­—è¼¸å…¥æ¡†åˆ°å®¹å™¨é ‚éƒ¨ï¼‰
                const scrollTop = scrollContainer.scrollTop + (textInputRect.top - containerRect.top) - 20; // 20px çš„é¡å¤–é–“è·
                
                console.log('ğŸ“Š æ»¾å‹•è¨ˆç®—:', {
                    textInputTop: textInputRect.top,
                    containerTop: containerRect.top,
                    currentScrollTop: scrollContainer.scrollTop,
                    targetScrollTop: scrollTop,
                    containerHeight: containerRect.height
                });
                
                // ä½¿ç”¨å¹³æ»‘æ»¾å‹•ï¼Œå„ªåŒ–å‹•ç•«
                const targetScrollTop = Math.max(0, scrollTop);
                const startScrollTop = scrollContainer.scrollTop;
                const distance = targetScrollTop - startScrollTop;
                const duration = Math.min(500, Math.abs(distance) * 0.5); // å‹•æ…‹èª¿æ•´å‹•ç•«æ™‚é•·
                
                if (duration > 0) {
                    const startTime = performance.now();
                    
                    function animateScroll(currentTime) {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        // ä½¿ç”¨ easeOutCubic ç·©å‹•å‡½æ•¸
                        const easeProgress = 1 - Math.pow(1 - progress, 3);
                        const currentScrollTop = startScrollTop + (distance * easeProgress);
                        
                        scrollContainer.scrollTop = currentScrollTop;
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateScroll);
                        } else {
                            // å‹•ç•«å®Œæˆï¼Œæ¸…ç†è³‡æº
                            console.log('âœ… æ»¾å‹•å‹•ç•«å®Œæˆ');
                        }
                    }
                    
                    requestAnimationFrame(animateScroll);
                } else {
                    scrollContainer.scrollTop = targetScrollTop;
                }
                
                console.log('âœ… æ»¾å‹•åˆ°æ–‡å­—è¼¸å…¥æ¡†å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ æ»¾å‹•åˆ°æ–‡å­—è¼¸å…¥æ¡†å¤±æ•—:', error);
            }
        }

        // æ»¾å‹•åˆ°äººæ•¸é¸æ“‡å€åŸŸ
        function scrollToStudentCountSelection() {
            try {
                console.log('ğŸ“œ é–‹å§‹æ»¾å‹•åˆ°äººæ•¸é¸æ“‡å€åŸŸ...');
                window.scrollToStudentCountSelectionCalled = true; // ç”¨æ–¼æ¸¬è©¦
                
                // æ‰¾åˆ°æ»¾å‹•å®¹å™¨
                const modalContent = document.querySelector('.attendance-modal-content');
                const teacherContent = document.querySelector('.teacher-attendance-content');
                let scrollContainer = null;
                
                // å„ªå…ˆä½¿ç”¨æ¨¡æ…‹æ¡†å…§å®¹ï¼ˆçœŸæ­£çš„æ»¾å‹•å®¹å™¨ï¼‰
                if (modalContent) {
                    scrollContainer = modalContent;
                    console.log('âœ… ä½¿ç”¨æ¨¡æ…‹æ¡†å…§å®¹ä½œç‚ºæ»¾å‹•å®¹å™¨');
                }
                
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦è¬›å¸«å…§å®¹çš„æ»¾å‹•å®¹å™¨
                if (!scrollContainer && teacherContent) {
                    scrollContainer = teacherContent.querySelector('div[style*="overflow-y: auto"]');
                    console.log('âœ… ä½¿ç”¨è¬›å¸«å…§å®¹çš„æ»¾å‹•å®¹å™¨');
                }
                
                if (!scrollContainer) {
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°æ»¾å‹•å®¹å™¨');
                    return;
                }
                
                console.log('ğŸ“Š æ»¾å‹•å®¹å™¨è³‡è¨Š:', {
                    className: scrollContainer.className,
                    scrollTop: scrollContainer.scrollTop,
                    scrollHeight: scrollContainer.scrollHeight,
                    clientHeight: scrollContainer.clientHeight
                });
                
                // æ‰¾åˆ°äººæ•¸é¸æ“‡å€åŸŸ
                const studentCountSelection = document.getElementById('student-count-selection');
                if (!studentCountSelection) {
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°äººæ•¸é¸æ“‡å€åŸŸ');
                    return;
                }
                
                // è¨ˆç®—äººæ•¸é¸æ“‡å€åŸŸç›¸å°æ–¼æ»¾å‹•å®¹å™¨çš„ä½ç½®
                const selectionRect = studentCountSelection.getBoundingClientRect();
                const containerRect = scrollContainer.getBoundingClientRect();
                
                // è¨ˆç®—éœ€è¦æ»¾å‹•çš„è·é›¢ï¼ˆè®“äººæ•¸é¸æ“‡å€åŸŸåˆ°å®¹å™¨é ‚éƒ¨ï¼‰
                // å¢åŠ æ›´å¤šé–“è·ï¼Œç¢ºä¿æŒ‰éˆ•å®Œå…¨å¯è¦‹ï¼ˆæŒ‰éˆ•é«˜åº¦ç´„136pxï¼‰
                // æ ¹æ“šæ¸¬è©¦çµæœï¼ŒæŒ‰éˆ•bottomä½ç½®æ˜¯851ï¼Œè¦–çª—é«˜åº¦æ˜¯812ï¼Œéœ€è¦æ»¾å‹•æ›´å¤š
                const scrollTop = scrollContainer.scrollTop + (selectionRect.top - containerRect.top) - 200; // 200px çš„é¡å¤–é–“è·ï¼Œç¢ºä¿æŒ‰éˆ•å®Œå…¨å¯è¦‹
                
                console.log('ğŸ“Š æ»¾å‹•è¨ˆç®—:', {
                    selectionTop: selectionRect.top,
                    containerTop: containerRect.top,
                    currentScrollTop: scrollContainer.scrollTop,
                    targetScrollTop: scrollTop,
                    containerHeight: containerRect.height
                });
                
                // ä½¿ç”¨å¹³æ»‘æ»¾å‹•
                const targetScrollTop = Math.max(0, scrollTop);
                const startScrollTop = scrollContainer.scrollTop;
                const distance = targetScrollTop - startScrollTop;
                const duration = Math.min(800, Math.abs(distance) * 0.8); // å‹•æ…‹èª¿æ•´å‹•ç•«æ™‚é•·
                
                if (duration > 0) {
                    const startTime = performance.now();
                    
                    function animateScroll(currentTime) {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        // ä½¿ç”¨ easeOutCubic ç·©å‹•å‡½æ•¸
                        const easeProgress = 1 - Math.pow(1 - progress, 3);
                        const currentScrollTop = startScrollTop + (distance * easeProgress);
                        
                        scrollContainer.scrollTop = currentScrollTop;
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateScroll);
                        } else {
                            // å‹•ç•«å®Œæˆï¼Œæ¸…ç†è³‡æº
                            console.log('âœ… æ»¾å‹•å‹•ç•«å®Œæˆ');
                        }
                    }
                    
                    requestAnimationFrame(animateScroll);
                } else {
                    scrollContainer.scrollTop = targetScrollTop;
                }
                
                console.log('âœ… æ»¾å‹•åˆ°äººæ•¸é¸æ“‡å€åŸŸå®Œæˆ');
                
            } catch (error) {
                console.error('âŒ æ»¾å‹•åˆ°äººæ•¸é¸æ“‡å€åŸŸå¤±æ•—:', error);
            }
        }

        // è¨­ç½®è¬›å¸«æ¨¡å¼
        function setTeacherMode() {
            console.log('ğŸ‘¨â€ğŸ« è¨­ç½®è¬›å¸«æ¨¡å¼');
            
            const teacherModeBtn = document.getElementById('teacher-mode-btn');
            const assistantModeBtn = document.getElementById('assistant-mode-btn');
            const currentModeDisplay = document.getElementById('current-mode-display');
            
            if (teacherModeBtn && assistantModeBtn && currentModeDisplay) {
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼ - è¬›å¸«æ¨¡å¼ç‚ºè—è‰²
                teacherModeBtn.style.background = 'linear-gradient(135deg, #3b82f6, #60a5fa)';
                teacherModeBtn.style.color = '#1e40af';
                teacherModeBtn.style.border = '2px solid #3b82f6';
                teacherModeBtn.style.boxShadow = '0 4px 16px rgba(59, 130, 246, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.5), inset 0 -1px 0 rgba(0, 0, 0, 0.1)';
                
                assistantModeBtn.style.background = '#f8f9fa';
                assistantModeBtn.style.color = '#666';
                assistantModeBtn.style.border = '2px solid #e9ecef';
                assistantModeBtn.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.05)';
                
                // æ›´æ–°é¡¯ç¤º
                currentModeDisplay.textContent = 'è¬›å¸«æ¨¡å¼';
                
                // æª¢æŸ¥ä¸¦é¡¯ç¤ºç‰¹æ®Šæç¤ºï¼ˆå¦‚æœæ˜¯ç‰¹æ®Šèª²ç¨‹ï¼‰
                checkAndShowSpecialNotice();
            }
        }

        // è¨­ç½®åŠ©æ•™æ¨¡å¼
        function setAssistantMode() {
            console.log('ğŸ‘¨â€ğŸ“ è¨­ç½®åŠ©æ•™æ¨¡å¼');
            
            const teacherModeBtn = document.getElementById('teacher-mode-btn');
            const assistantModeBtn = document.getElementById('assistant-mode-btn');
            const currentModeDisplay = document.getElementById('current-mode-display');
            
            if (teacherModeBtn && assistantModeBtn && currentModeDisplay) {
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼ - åŠ©æ•™æ¨¡å¼ç‚ºç¶ è‰²
                assistantModeBtn.style.background = 'linear-gradient(135deg, #22c55e, #4ade80)';
                assistantModeBtn.style.color = '#166534';
                assistantModeBtn.style.border = '2px solid #22c55e';
                assistantModeBtn.style.boxShadow = '0 4px 16px rgba(34, 197, 94, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.5), inset 0 -1px 0 rgba(0, 0, 0, 0.1)';
                
                teacherModeBtn.style.background = '#f8f9fa';
                teacherModeBtn.style.color = '#666';
                teacherModeBtn.style.border = '2px solid #e9ecef';
                teacherModeBtn.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.05)';
                
                // æ›´æ–°é¡¯ç¤º
                currentModeDisplay.textContent = 'åŠ©æ•™æ¨¡å¼';
                
                // éš±è—ç‰¹æ®Šæç¤ºï¼ˆåŠ©æ•™æ¨¡å¼ä¸‹ä¸é¡¯ç¤ºï¼‰
                hideSpecialNotice();
            }
        }
        
        // æª¢æŸ¥ä¸¦é¡¯ç¤ºç‰¹æ®Šæç¤º
        function checkAndShowSpecialNotice() {
            const originalTitle = window.currentAttendanceData?.originalTitle || '';
            const isCustomizedCourse = originalTitle.includes('å®¢è£½åŒ–') || 
                                    originalTitle.includes('åˆ°åºœ') || 
                                    originalTitle.includes('å®¢åˆ¶åŒ–') || 
                                    originalTitle.includes('å®¢è£½') || 
                                    originalTitle.includes('å®¢åˆ¶');
            
            if (isCustomizedCourse) {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ç‰¹æ®Šæç¤º
                let specialNotice = document.querySelector('.special-notice');
                if (!specialNotice) {
                    // åœ¨èª²ç¨‹å…§å®¹è¼¸å…¥æ¡†ä¸Šæ–¹é¡¯ç¤ºç‰¹æ®Šæç¤º
                    const courseContentLabel = document.querySelector('label[for="course-content"]');
                    if (courseContentLabel) {
                        specialNotice = document.createElement('div');
                        specialNotice.className = 'special-notice';
                        specialNotice.style.cssText = `
                            background: linear-gradient(135deg, 
                                rgba(255, 193, 7, 0.2) 0%, 
                                rgba(255, 193, 7, 0.1) 100%);
                            border: 2px solid rgba(255, 193, 7, 0.4);
                            border-radius: 10px;
                            padding: 8px 10px;
                            margin-bottom: 8px;
                            font-size: 0.8rem;
                            color: #856404;
                            text-align: center;
                            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
                            line-height: 1.3;
                        `;
                        specialNotice.innerHTML = `
                            <i class="fas fa-star" style="margin-right: 6px; color: #ffc107;"></i>
                            <strong>ç‰¹æ®Šæ¨¡å¼èª²ç¨‹</strong> - åŒ…å«å®¢è£½åŒ–æˆ–åˆ°åºœæœå‹™
                            <br><small>æäº¤æ™‚æœƒè‡ªå‹•æ·»åŠ ç‰¹æ®Šæ¨™è¨˜ï¼Œäººæ•¸è¨­ç‚º99</small>
                        `;
                        courseContentLabel.parentNode.insertBefore(specialNotice, courseContentLabel.nextSibling);
                    }
                    
                    // åœ¨èª²ç¨‹å…§å®¹è¼¸å…¥æ¡†çš„placeholderä¸­æ·»åŠ æç¤º
                    const courseContentInput = document.getElementById('course-content');
                    if (courseContentInput) {
                        courseContentInput.placeholder = 'ğŸ·ï¸ [ç‰¹æ®Šæ¨¡å¼] è«‹æè¿°ä»Šå¤©çš„èª²ç¨‹å…§å®¹...';
                    }
                }
            }
        }
        
        // éš±è—ç‰¹æ®Šæç¤º
        function hideSpecialNotice() {
            const specialNotice = document.querySelector('.special-notice');
            if (specialNotice) {
                specialNotice.remove();
            }
            
            // æ¢å¾©èª²ç¨‹å…§å®¹è¼¸å…¥æ¡†çš„placeholder
            const courseContentInput = document.getElementById('course-content');
            if (courseContentInput) {
                courseContentInput.placeholder = 'è«‹æè¿°ä»Šå¤©çš„èª²ç¨‹å…§å®¹...';
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦æ»¿è¶³è‡ªå‹•æäº¤æ¢ä»¶
        function checkAutoSubmit() {
            const courseContent = document.getElementById('course-content');
            const currentModeDisplay = document.getElementById('current-mode-display');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ–‡å­—å…§å®¹ï¼ˆè‡³å°‘1å€‹å­—ç¬¦ï¼‰
            const hasContent = courseContent && courseContent.value.trim().length >= 1;
            
            // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†èº«ä»½
            const hasMode = currentModeDisplay && 
                           (currentModeDisplay.textContent === 'è¬›å¸«æ¨¡å¼' || 
                            currentModeDisplay.textContent === 'åŠ©æ•™æ¨¡å¼');
            
            // æª¢æŸ¥èª²ç¨‹å…§å®¹æ˜¯å¦æœ‰æ•ˆï¼ˆä¸èƒ½åªæ˜¯ç©ºç™½æˆ–é è¨­æ–‡å­—ï¼‰
            const contentValue = courseContent ? courseContent.value.trim() : '';
            const isValidContent = contentValue.length >= 1 && 
                                 contentValue !== 'è«‹æè¿°ä»Šå¤©çš„èª²ç¨‹å…§å®¹...' && // ä¸èƒ½æ˜¯é è¨­æ–‡å­—
                                 contentValue !== '[ç‰¹æ®Šæ¨¡å¼] è«‹æè¿°ä»Šå¤©çš„èª²ç¨‹å…§å®¹...'; // ä¸èƒ½æ˜¯ç‰¹æ®Šæ¨¡å¼é è¨­æ–‡å­—
            
            // æª¢æŸ¥äººæ•¸é¸æ“‡ï¼ˆåƒ…åœ¨æ²’æœ‰å­¸ç”Ÿè³‡æ–™æ™‚éœ€è¦ï¼‰
            let hasStudentCount = true; // é è¨­ç‚ºtrue
            const hasStudents = window.loadedStudentsData && 
                              window.loadedStudentsData.students && 
                              window.loadedStudentsData.students.length > 0;
            
            if (!hasStudents) {
                // æ²’æœ‰å­¸ç”Ÿè³‡æ–™æ™‚ï¼Œéœ€è¦é¸æ“‡äººæ•¸
                hasStudentCount = selectedStudentCount !== null;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ»¿è¶³è‡ªå‹•æäº¤æ¢ä»¶
            const shouldAutoSubmit = hasContent && hasMode && isValidContent && hasStudentCount;
            
            console.log('ğŸ” è‡ªå‹•æäº¤æª¢æŸ¥:', {
                hasContent,
                hasMode,
                isValidContent,
                hasStudentCount,
                hasStudents,
                selectedStudentCount,
                shouldAutoSubmit,
                content: contentValue,
                contentLength: contentValue.length,
                mode: currentModeDisplay ? currentModeDisplay.textContent : '',
                isCurrentlyCounting: isAutoSubmitEnabled
            });
            
            if (shouldAutoSubmit) {
                // å¦‚æœæ¢ä»¶æ»¿è¶³ä¸”ç•¶å‰æ²’æœ‰åœ¨å€’æ•¸ï¼Œæ‰é–‹å§‹å€’æ•¸
                if (!isAutoSubmitEnabled) {
                    console.log('âœ… æ‰€æœ‰æ¢ä»¶æ»¿è¶³ï¼Œé–‹å§‹è‡ªå‹•æäº¤å€’æ•¸');
                    startAutoSubmitCountdown();
                }
            } else {
                // å¦‚æœæ¢ä»¶ä¸æ»¿è¶³ï¼Œåœæ­¢å€’æ•¸
                if (isAutoSubmitEnabled) {
                    console.log('âŒ æ¢ä»¶ä¸æ»¿è¶³ï¼Œåœæ­¢è‡ªå‹•æäº¤å€’æ•¸');
                    stopAutoSubmitCountdown();
                }
            }
        }
        
        // é–‹å§‹è‡ªå‹•æäº¤å€’æ•¸
        function startAutoSubmitCountdown() {
            // æ¸…é™¤ç¾æœ‰è¨ˆæ™‚å™¨
            if (autoSubmitTimer) {
                clearInterval(autoSubmitTimer);
            }
            
            // é‡ç½®å€’æ•¸
            autoSubmitCountdown = 3;
            isAutoSubmitEnabled = true;
            window.isAutoSubmitEnabled = true; // åŒæ­¥åˆ°å…¨åŸŸè®Šæ•¸
            
            console.log('â° é–‹å§‹è‡ªå‹•æäº¤å€’æ•¸:', autoSubmitCountdown);
            
            // é¡¯ç¤ºå€’æ•¸æç¤º
            showCountdownToast();
            
            // é–‹å§‹å€’æ•¸è¨ˆæ™‚
            autoSubmitTimer = animationManager.setInterval(() => {
                // æª¢æŸ¥æ¢ä»¶æ˜¯å¦ä»ç„¶æ»¿è¶³
                const courseContent = document.getElementById('course-content');
                const currentModeDisplay = document.getElementById('current-mode-display');
                
                const hasContent = courseContent && courseContent.value.trim().length >= 1;
                const hasMode = currentModeDisplay && 
                               (currentModeDisplay.textContent === 'è¬›å¸«æ¨¡å¼' || 
                                currentModeDisplay.textContent === 'åŠ©æ•™æ¨¡å¼');
                
                // æª¢æŸ¥èª²ç¨‹å…§å®¹æ˜¯å¦æœ‰æ•ˆï¼ˆä¸èƒ½åªæ˜¯ç©ºç™½æˆ–é è¨­æ–‡å­—ï¼‰
                const contentValue = courseContent ? courseContent.value.trim() : '';
                const isValidContent = contentValue.length >= 1 && 
                                     contentValue !== 'è«‹æè¿°ä»Šå¤©çš„èª²ç¨‹å…§å®¹...' && // ä¸èƒ½æ˜¯é è¨­æ–‡å­—
                                     contentValue !== '[ç‰¹æ®Šæ¨¡å¼] è«‹æè¿°ä»Šå¤©çš„èª²ç¨‹å…§å®¹...'; // ä¸èƒ½æ˜¯ç‰¹æ®Šæ¨¡å¼é è¨­æ–‡å­—
                
                if (!hasContent || !hasMode || !isValidContent) {
                    // æ¢ä»¶ä¸æ»¿è¶³ï¼Œåœæ­¢å€’æ•¸
                    console.log('â¹ï¸ æ¢ä»¶ä¸æ»¿è¶³ï¼Œåœæ­¢å€’æ•¸');
                    stopAutoSubmitCountdown();
                    return;
                }
                
                autoSubmitCountdown--;
                console.log('â° è‡ªå‹•æäº¤å€’æ•¸:', autoSubmitCountdown);
                
                if (autoSubmitCountdown <= 0) {
                    // å€’æ•¸çµæŸï¼ŒåŸ·è¡Œæäº¤
                    clearInterval(autoSubmitTimer);
                    autoSubmitTimer = null;
                    isAutoSubmitEnabled = false;
                    window.isAutoSubmitEnabled = false; // åŒæ­¥åˆ°å…¨åŸŸè®Šæ•¸
                    
                    console.log('ğŸš€ è‡ªå‹•æäº¤åŸ·è¡Œ');
                    submitTeacherReport();
                    return; // ç¢ºä¿ä¸æœƒç¹¼çºŒåŸ·è¡Œ
                } else {
                    // æ›´æ–°å€’æ•¸æç¤º
                    showCountdownToast();
                }
            }, 1000);
        }
        
        // åœæ­¢è‡ªå‹•æäº¤å€’æ•¸
        function stopAutoSubmitCountdown() {
            if (autoSubmitTimer) {
                animationManager.clearInterval(autoSubmitTimer);
                autoSubmitTimer = null;
            }
            isAutoSubmitEnabled = false;
            window.isAutoSubmitEnabled = false; // åŒæ­¥åˆ°å…¨åŸŸè®Šæ•¸
            autoSubmitCountdown = 0;
            
            console.log('â¹ï¸ åœæ­¢è‡ªå‹•æäº¤å€’æ•¸');
            
            // éš±è—å€’æ•¸æç¤º
            hideCountdownToast();
        }
        
        // é¡¯ç¤ºå€’æ•¸æç¤º
        function showCountdownToast() {
            // ç§»é™¤ç¾æœ‰çš„å€’æ•¸æç¤º
            const existingToast = document.querySelector('.countdown-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // ç²å–ç•¶å‰æ¨¡å¼å’Œèª²ç¨‹å…§å®¹
            const currentModeDisplay = document.getElementById('current-mode-display');
            const courseContent = document.getElementById('course-content');
            
            // ç²å–ç•¶å‰æ¨¡å¼å’Œèª²ç¨‹å…§å®¹çš„æ–‡æœ¬
            const modeText = currentModeDisplay ? currentModeDisplay.textContent : 'æœªçŸ¥';
            const contentText = courseContent ? courseContent.value.substring(0, 20) + (courseContent.value.length > 20 ? '...' : '') : 'ç„¡';
            
            // æ ¹æ“šæ¨¡å¼é¸æ“‡é¡è‰²
            const isTeacherMode = modeText === 'è¬›å¸«æ¨¡å¼';
            const isAssistantMode = modeText === 'åŠ©æ•™æ¨¡å¼';
            
            let backgroundColor, borderColor, iconColor;
            if (isTeacherMode) {
                // è¬›å¸«æ¨¡å¼ - è—è‰²
                backgroundColor = `linear-gradient(135deg, 
                    rgba(52, 152, 219, 0.9) 0%, 
                    rgba(41, 128, 185, 0.8) 50%,
                    rgba(52, 152, 219, 0.9) 100%)`;
                borderColor = 'rgba(52, 152, 219, 0.6)';
                iconColor = '#ffffff';
            } else if (isAssistantMode) {
                // åŠ©æ•™æ¨¡å¼ - ç¶ è‰²
                backgroundColor = `linear-gradient(135deg, 
                    rgba(46, 204, 113, 0.9) 0%, 
                    rgba(39, 174, 96, 0.8) 50%,
                    rgba(46, 204, 113, 0.9) 100%)`;
                borderColor = 'rgba(46, 204, 113, 0.6)';
                iconColor = '#ffffff';
            } else {
                // é è¨­ - ç°è‰²
                backgroundColor = `linear-gradient(135deg, 
                    rgba(149, 165, 166, 0.9) 0%, 
                    rgba(127, 140, 141, 0.8) 50%,
                    rgba(149, 165, 166, 0.9) 100%)`;
                borderColor = 'rgba(149, 165, 166, 0.6)';
                iconColor = '#ffffff';
            }
            
            // å‰µå»ºå€’æ•¸æç¤º
            const toast = document.createElement('div');
            toast.className = 'countdown-toast';
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${backgroundColor};
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                color: #ffffff;
                padding: 24px 36px;
                border-radius: 25px;
                font-size: 18px;
                font-weight: 700;
                z-index: 10000;
                box-shadow: 
                    0 8px 32px rgba(0, 0, 0, 0.2),
                    0 4px 16px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
                border: 2px solid ${borderColor};
                animation: countdownPulse 0.8s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                min-width: 280px;
                text-align: center;
            `;
            
            // æ·»åŠ èƒŒæ™¯å…‰æ•ˆ
            const shimmerEffect = document.createElement('div');
            shimmerEffect.style.cssText = `
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
                animation: shimmerSlide 2.5s ease-in-out infinite;
                pointer-events: none;
            `;
            
            toast.innerHTML = `
                <div style="position: relative; z-index: 1;">
                    <i class="fas fa-clock" style="
                        margin-right: 12px; 
                        font-size: 1.3rem;
                        color: ${iconColor};
                        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
                    "></i>
                    <div style="text-align: center; line-height: 1.4;">
                        <div style="
                            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                            color: #ffffff;
                            font-size: 16px;
                            font-weight: bold;
                            margin-bottom: 4px;
                        ">${autoSubmitCountdown} ç§’å¾Œè‡ªå‹•æäº¤</div>
                        <div style="
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                            color: rgba(255, 255, 255, 0.9);
                            font-size: 12px;
                        ">æ¨¡å¼ï¼š${modeText}</div>
                        <div style="
                            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                            color: rgba(255, 255, 255, 0.9);
                            font-size: 12px;
                            max-width: 200px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        ">å…§å®¹ï¼š${contentText}</div>
                    </div>
                </div>
            `;
            
            toast.appendChild(shimmerEffect);
            document.body.appendChild(toast);
            
            // æ·»åŠ å‹•ç•«æ¨£å¼
            if (!document.querySelector('#countdown-styles')) {
                const style = document.createElement('style');
                style.id = 'countdown-styles';
                style.textContent = `
                    @keyframes countdownPulse {
                        0% { 
                            transform: translate(-50%, -50%) scale(0.7); 
                            opacity: 0; 
                        }
                        50% { 
                            transform: translate(-50%, -50%) scale(1.08); 
                            opacity: 1; 
                        }
                        100% { 
                            transform: translate(-50%, -50%) scale(1); 
                            opacity: 1; 
                        }
                    }
                    @keyframes shimmerSlide {
                        0% { left: -100%; }
                        50% { left: 100%; }
                        100% { left: 100%; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // éš±è—å€’æ•¸æç¤º
        function hideCountdownToast() {
            const toast = document.querySelector('.countdown-toast');
            if (toast) {
                toast.remove();
            }
        }
        
        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        function showLoadingToast(message) {
            // ç§»é™¤ç¾æœ‰çš„è¼‰å…¥æç¤º
            const existingToast = document.querySelector('.loading-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // å‰µå»ºè¼‰å…¥æç¤º
            const toast = document.createElement('div');
            toast.className = 'loading-toast';
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.15) 0%, 
                    rgba(255, 255, 255, 0.08) 50%,
                    rgba(255, 255, 255, 0.15) 100%);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                color: #2c3e50;
                padding: 24px 36px;
                border-radius: 25px;
                font-size: 18px;
                font-weight: 700;
                z-index: 10000;
                text-align: center;
                min-width: 280px;
                box-shadow: 
                    0 8px 32px rgba(0, 0, 0, 0.1),
                    0 4px 16px rgba(0, 0, 0, 0.05),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            
            toast.innerHTML = `
                <div style="position: relative; z-index: 1;">
                    <i class="fas fa-spinner fa-spin" style="
                        margin-right: 12px; 
                        font-size: 1.3rem;
                        color: #3498db;
                    "></i>
                    <span style="
                        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        color: #2c3e50;
                    ">${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
        }
        
        // éš±è—è¼‰å…¥å‹•ç•«
        function hideLoadingToast() {
            const toast = document.querySelector('.loading-toast');
            if (toast) {
                toast.remove();
            }
        }
        
        // é¡¯ç¤ºå±…ä¸­é€šçŸ¥
        function showCenterToast(message, type = 'success') {
            // ç§»é™¤ç¾æœ‰çš„å±…ä¸­é€šçŸ¥
            const existingToast = document.querySelector('.center-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // å‰µå»ºå±…ä¸­é€šçŸ¥
            const toast = document.createElement('div');
            toast.className = 'center-toast';
            
            // æ ¹æ“šé¡å‹è¨­å®šé¡è‰²
            const colors = {
                success: {
                    icon: 'fas fa-check-circle',
                    iconColor: '#28a745',
                    textColor: '#2c3e50'
                },
                error: {
                    icon: 'fas fa-exclamation-circle',
                    iconColor: '#dc3545',
                    textColor: '#2c3e50'
                },
                info: {
                    icon: 'fas fa-info-circle',
                    iconColor: '#3498db',
                    textColor: '#2c3e50'
                },
                warning: {
                    icon: 'fas fa-exclamation-triangle',
                    iconColor: '#ffc107',
                    textColor: '#2c3e50'
                }
            };
            
            const colorScheme = colors[type] || colors.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.15) 0%, 
                    rgba(255, 255, 255, 0.08) 50%,
                    rgba(255, 255, 255, 0.15) 100%);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                color: ${colorScheme.textColor};
                padding: 24px 36px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                z-index: 10000;
                text-align: center;
                min-width: 280px;
                max-width: 400px;
                word-wrap: break-word;
                white-space: pre-line;
                animation: centerToastPulse 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 
                    0 8px 32px rgba(0, 0, 0, 0.1),
                    0 4px 16px rgba(0, 0, 0, 0.05),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            
            toast.innerHTML = `
                <div style="position: relative; z-index: 1;">
                    <i class="${colorScheme.icon}" style="
                        margin-right: 12px; 
                        font-size: 1.3rem;
                        color: ${colorScheme.iconColor};
                        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
                    "></i>
                    <span style="
                        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        color: ${colorScheme.textColor};
                    ">${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // æ·»åŠ å‹•ç•«æ¨£å¼
            if (!document.querySelector('#center-toast-styles')) {
                const style = document.createElement('style');
                style.id = 'center-toast-styles';
                style.textContent = `
                    @keyframes centerToastPulse {
                        0% { 
                            transform: translate(-50%, -50%) scale(0.7); 
                            opacity: 0; 
                        }
                        50% { 
                            transform: translate(-50%, -50%) scale(1.05); 
                            opacity: 1; 
                        }
                        100% { 
                            transform: translate(-50%, -50%) scale(1); 
                            opacity: 1; 
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 4ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }

        // æäº¤è¬›å¸«å ±è¡¨
        async function submitTeacherReport() {
            // é˜²æ­¢é‡è¤‡æäº¤
            if (window.isSubmittingReport) {
                console.log('â³ æ­£åœ¨æäº¤ä¸­ï¼Œè·³éé‡è¤‡æäº¤');
                return;
            }
            
            try {
                window.isSubmittingReport = true;
                console.log('ğŸ“¤ æäº¤è¬›å¸«å ±è¡¨');
                console.log('ğŸ” æª¢æŸ¥å¿…è¦å…ƒç´ ...');
                
                // åœæ­¢è‡ªå‹•æäº¤è¨ˆæ™‚å™¨
                stopAutoSubmitCountdown();
                
                const courseContent = document.getElementById('course-content');
                const currentModeDisplay = document.getElementById('current-mode-display');
                const submitBtn = document.getElementById('submitTeacherReport');
                
                console.log('ğŸ” å…ƒç´ æª¢æŸ¥:');
                console.log('  - courseContent:', !!courseContent);
                console.log('  - currentModeDisplay:', !!currentModeDisplay);
                console.log('  - submitBtn:', !!submitBtn);
                console.log('  - courseContentValue:', courseContent ? courseContent.value : 'N/A');
                
                if (!courseContent || !courseContent.value.trim()) {
                    console.log('âŒ èª²ç¨‹å…§å®¹ç‚ºç©ºï¼Œåœæ­¢æäº¤');
                    showToast('è«‹å¡«å¯«èª²ç¨‹å…§å®¹', 'error');
                    return;
                }
                
                // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
                showLoadingToast('æ­£åœ¨æäº¤è¬›å¸«å ±è¡¨...');
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ï¼ˆå¦‚æœæŒ‰éˆ•å­˜åœ¨ï¼‰
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>æäº¤ä¸­...';
                    submitBtn.disabled = true;
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰èª²ç¨‹è³‡æ–™
                console.log('ğŸ” æª¢æŸ¥èª²ç¨‹è³‡æ–™:', !!window.currentAttendanceData);
                if (!window.currentAttendanceData) {
                    console.log('âŒ æ²’æœ‰èª²ç¨‹è³‡æ–™ï¼Œåœæ­¢æäº¤');
                    showToast('ç„¡æ³•ç²å–èª²ç¨‹è³‡æ–™ï¼Œè«‹é‡æ–°é–‹å•Ÿç°½åˆ°ç³»çµ±', 'error');
                    return;
                }
                console.log('âœ… èª²ç¨‹è³‡æ–™å­˜åœ¨ï¼Œç¹¼çºŒè™•ç†');
                
                // æº–å‚™APIè«‹æ±‚è³‡æ–™
                const currentData = window.currentAttendanceData;
                const today = new Date();
                const dateString = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
                
                // æ ¼å¼åŒ–æ™‚é–“ï¼ˆå¾ start å’Œ end è¨ˆç®—ï¼‰
                let courseTime = '';
                if (currentData.start && currentData.end) {
                    const startDate = new Date(currentData.start);
                    const endDate = new Date(currentData.end);
                    const startTime = startDate.toLocaleTimeString('zh-TW', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    const endTime = endDate.toLocaleTimeString('zh-TW', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    courseTime = `${startTime}-${endTime}`;
                } else {
                    courseTime = currentData.time || 'æœªçŸ¥æ™‚é–“';
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šèª²ç¨‹ï¼ˆå®¢è£½åŒ–ã€åˆ°åºœç­‰ï¼‰
                const originalTitle = window.currentAttendanceData?.originalTitle || '';
                const isCustomizedCourse = originalTitle.includes('å®¢è£½åŒ–') || 
                                        originalTitle.includes('åˆ°åºœ') || 
                                        originalTitle.includes('å®¢åˆ¶åŒ–') || 
                                        originalTitle.includes('å®¢è£½') || 
                                        originalTitle.includes('å®¢åˆ¶');
                
                // æº–å‚™èª²ç¨‹å…§å®¹ï¼Œå¦‚æœæ˜¯ç‰¹æ®Šèª²ç¨‹å‰‡æ·»åŠ ç‰¹æ®Šæ¨™è¨˜
                let finalCourseContent = courseContent.value.trim();
                if (isCustomizedCourse) {
                    const specialMark = 'ğŸ·ï¸ [ç‰¹æ®Šæ¨¡å¼] ';
                    if (!finalCourseContent.startsWith(specialMark)) {
                        finalCourseContent = specialMark + finalCourseContent;
                    }
                    console.log('ğŸ·ï¸ æª¢æ¸¬åˆ°ç‰¹æ®Šèª²ç¨‹ï¼Œæ·»åŠ ç‰¹æ®Šæ¨™è¨˜:', originalTitle);
                }
                
                // ç²å–å¯¦éš›ç°½åˆ°çš„å­¸ç”Ÿäººæ•¸
                let studentCount = 0;
                const currentMode = currentModeDisplay ? currentModeDisplay.textContent : 'è¬›å¸«æ¨¡å¼';
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿè³‡æ–™
                const hasStudents = window.loadedStudentsData && 
                                  window.loadedStudentsData.students && 
                                  window.loadedStudentsData.students.length > 0;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šèª²ç¨‹ï¼ˆå®¢è£½åŒ–ã€åˆ°åºœç­‰ï¼‰
                // originalTitle å’Œ isCustomizedCourse å·²åœ¨ä¸Šé¢å®£å‘Š
                
                if (currentMode === 'åŠ©æ•™æ¨¡å¼') {
                    // åŠ©æ•™æ¨¡å¼ï¼šäººæ•¸è¨­ç‚º 0
                    studentCount = 0;
                    console.log('ğŸ“Š åŠ©æ•™æ¨¡å¼ï¼šäººæ•¸è¨­ç‚º 0');
                } else if (isCustomizedCourse) {
                    // ç‰¹æ®Šèª²ç¨‹ï¼ˆå®¢è£½åŒ–ã€åˆ°åºœç­‰ï¼‰ï¼šäººæ•¸ç›´æ¥è¨­ç‚º99
                    studentCount = 99;
                    console.log('ğŸ“Š ç‰¹æ®Šèª²ç¨‹ï¼Œäººæ•¸è¨­ç‚º99:', originalTitle);
                } else if (!hasStudents) {
                    // ä¸€èˆ¬èª²ç¨‹ä¸”æ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼šä½¿ç”¨é¸æ“‡çš„äººæ•¸
                    if (selectedStudentCount === null) {
                        showToast('è«‹é¸æ“‡å¯¦éš›å‡ºå¸­äººæ•¸', 'error');
                        return;
                    }
                    studentCount = selectedStudentCount;
                    console.log('ğŸ“Š æ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œä½¿ç”¨é¸æ“‡çš„äººæ•¸:', studentCount);
                } else {
                    // è¬›å¸«æ¨¡å¼ä¸”æœ‰å­¸ç”Ÿè³‡æ–™ï¼šè¨ˆç®—å¯¦éš›å‡ºå¸­çš„å­¸ç”Ÿæ•¸é‡
                    const presentStudents = window.loadedStudentsData.students.filter(student => 
                        student.status === 'present' || student.status === 'attended'
                    );
                    studentCount = presentStudents.length;
                    console.log('ğŸ“Š è¬›å¸«æ¨¡å¼å­¸ç”Ÿç°½åˆ°çµ±è¨ˆ:', {
                        totalStudents: window.loadedStudentsData.students.length,
                        presentStudents: presentStudents.length,
                        presentStudentNames: presentStudents.map(s => s.name)
                    });
                }
                
                console.log('ğŸ“Š è¬›å¸«å ±è¡¨è³‡æ–™:', {
                    teacherName: currentData.teacher,
                    courseName: currentData.course,
                    courseTime: courseTime,
                    date: dateString,
                    studentCount: studentCount,
                    courseContent: finalCourseContent,
                    isCustomizedCourse: isCustomizedCourse
                });
                
                // ç²å–è¬›å¸«çš„Web API URL
                const webApiUrl = await getTeacherWebApi(currentData.teacher);
                if (!webApiUrl) {
                    throw new Error(`æ‰¾ä¸åˆ°è¬›å¸« "${currentData.teacher}" çš„Web API URL`);
                }
                
                console.log('ğŸ”— ä½¿ç”¨è¬›å¸«Web API:', webApiUrl);
                
                // èª¿ç”¨è¬›å¸«å ±è¡¨API
                const response = await fetch('/api/teacher-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        teacherName: currentData.teacher,
                        courseName: currentData.course,
                        courseTime: courseTime,
                        date: dateString,
                        studentCount: studentCount,
                        courseContent: finalCourseContent,
                        webApi: webApiUrl,
                        isCustomizedCourse: isCustomizedCourse
                    })
                });
                
                const result = await response.json();
                
                // éš±è—è¼‰å…¥å‹•ç•«
                hideLoadingToast();
                
                if (response.ok && result.success) {
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼ŒåŒ…å«APIå›æ‡‰çš„è©³ç´°ä¿¡æ¯
                    const mode = currentModeDisplay ? currentModeDisplay.textContent : 'è¬›å¸«æ¨¡å¼';
                    let successMessage = `è¬›å¸«å ±è¡¨æäº¤æˆåŠŸï¼(${mode})`;
                    
                    // æ·»åŠ APIå›æ‡‰çš„è©³ç´°ä¿¡æ¯
                    if (result.data) {
                        if (result.data.message) {
                            successMessage += `\n${result.data.message}`;
                        }
                        if (result.data.rowNumber) {
                            successMessage += `\nè¡Œè™Ÿ: ${result.data.rowNumber}`;
                        }
                        if (result.data.action) {
                            const actionText = result.data.action === 'insert' ? 'æ–°å¢' : 'æ›´æ–°';
                            successMessage += `\næ“ä½œ: ${actionText}`;
                        }
                    }
                    
                    showCenterToast(successMessage, 'success');
                    console.log('âœ… è¬›å¸«å ±è¡¨æäº¤æˆåŠŸ:', result.data);
                    
                    // ç™¼é€LINEé€šçŸ¥
                    await sendLineNotification({
                        teacherName: currentData.teacher,
                        courseName: currentData.course,
                        courseTime: courseTime,
                        date: dateString,
                        studentCount: studentCount,
                        courseContent: finalCourseContent,
                        mode: currentModeDisplay ? currentModeDisplay.textContent : 'è¬›å¸«æ¨¡å¼',
                        isCustomizedCourse: isCustomizedCourse
                    });
                } else {
                    throw new Error(result.message || 'APIèª¿ç”¨å¤±æ•—');
                }
                
                // é‡ç½®è¡¨å–®
                if (courseContent) {
                    courseContent.value = '';
                }
                
                const charCount = document.getElementById('char-count');
                if (charCount) {
                    charCount.textContent = '0';
                    charCount.style.color = '#666';
                }
                
                // é‡ç½®èº«ä»½é¸æ“‡
                const teacherModeBtn = document.getElementById('teacher-mode-btn');
                const assistantModeBtn = document.getElementById('assistant-mode-btn');
                
                if (teacherModeBtn && assistantModeBtn && currentModeDisplay) {
                    // é‡ç½®æŒ‰éˆ•æ¨£å¼
                    teacherModeBtn.style.background = '#f8f9fa';
                    teacherModeBtn.style.color = '#666';
                    teacherModeBtn.style.border = '2px solid #e9ecef';
                    
                    assistantModeBtn.style.background = '#f8f9fa';
                    assistantModeBtn.style.color = '#666';
                    assistantModeBtn.style.border = '2px solid #e9ecef';
                    
                    // é‡ç½®é¡¯ç¤º
                    currentModeDisplay.textContent = 'æœªé¸æ“‡';
                }
                
                // é‡ç½®æŒ‰éˆ•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i>æäº¤è¬›å¸«å ±è¡¨';
                    submitBtn.disabled = false;
                }
                
                console.log('âœ… è¬›å¸«å ±è¡¨æäº¤å®Œæˆ');
                
                // é‡ç½®æäº¤ç‹€æ…‹
                window.isSubmittingReport = false;
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showToast('è¬›å¸«å ±è¡¨æäº¤æˆåŠŸï¼', 'success');
                
                // å»¶é²é—œé–‰æ¨¡æ…‹æ¡†ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°æˆåŠŸè¨Šæ¯
                setTimeout(() => {
                    console.log('ğŸ”„ è‡ªå‹•é—œé–‰ç°½åˆ°æ¨¡æ…‹æ¡†');
                    closeAttendanceModal();
                }, 1500);
                
            } catch (error) {
                console.error('âŒ è¬›å¸«å ±è¡¨æäº¤å¤±æ•—:', error);
                
                // é‡ç½®æäº¤ç‹€æ…‹
                window.isSubmittingReport = false;
                
                // åœæ­¢è‡ªå‹•æäº¤è¨ˆæ™‚å™¨
                stopAutoSubmitCountdown();
                
                // é¡¯ç¤ºè©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
                let errorMessage = `è¬›å¸«å ±è¡¨æäº¤å¤±æ•—: ${error.message}`;
                if (error.message.includes('æ‰¾ä¸åˆ°è¬›å¸«')) {
                    errorMessage += '\nè«‹ç¢ºèªè¬›å¸«åç¨±æ˜¯å¦æ­£ç¢º';
                } else if (error.message.includes('æ²’æœ‰é…ç½®Web API')) {
                    errorMessage += '\nè©²è¬›å¸«å°šæœªé…ç½®å ±è¡¨API';
                } else if (error.message.includes('APIèª¿ç”¨å¤±æ•—')) {
                    errorMessage += '\nè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç¨å¾Œé‡è©¦';
                }
                
                showCenterToast(errorMessage, 'error');
                
                // ç¢ºä¿éŒ¯èª¤é€šçŸ¥æœƒè‡ªå‹•æ¶ˆå¤±
                setTimeout(() => {
                    const errorToast = document.querySelector('.toast.error');
                    if (errorToast) {
                        errorToast.remove();
                    }
                }, 5000);
                
                // é‡ç½®æŒ‰éˆ•
                const submitBtn = document.getElementById('submitTeacherReport');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i>æäº¤è¬›å¸«å ±è¡¨';
                    submitBtn.disabled = false;
                }
            }
        }

        // é—œé–‰ç°½åˆ°æ¨¡æ…‹æ¡†
        function closeAttendanceModal() {
            if (currentAttendanceModal) {
                console.log('âŒ é—œé–‰ç°½åˆ°æ¨¡æ…‹æ¡†');
                currentAttendanceModal.remove();
                currentAttendanceModal = null;
                isModalLoading = false;
                
                // ç§»é™¤æ‡¸æµ®å°èˆªå™¨
                const floatingNavigator = document.querySelector('.floating-navigator');
                if (floatingNavigator) {
                    floatingNavigator.remove();
                    console.log('âœ… æ‡¸æµ®å°èˆªå™¨å·²ç§»é™¤');
                }
                
                // é‡ç½®è§¸æ§ç‹€æ…‹
                isCharging = false;
                isTouchActive = false;
                isTouchCancelled = false;
                isScrolling = false;
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                // é‡ç½®é€šçŸ¥ç‹€æ…‹
                attendanceNotificationSent = false;
                studentAttendanceStatus = {};
                if (attendanceCheckTimer) {
                    clearTimeout(attendanceCheckTimer);
                    attendanceCheckTimer = null;
                }
                
                // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„è¼‰å…¥ç‹€æ…‹
                const loadingElements = document.querySelectorAll('.attendance-loading, .loading-spinner');
                loadingElements.forEach(el => el.remove());
                
                // æ¸…é™¤æ‰€æœ‰äº‹ä»¶å¡ç‰‡çš„å‹•ç•«ç‹€æ…‹
                const eventCards = document.querySelectorAll('.event-card');
                eventCards.forEach(card => {
                    card.classList.remove('pressing', 'charging', 'releasing', 'completing');
                    card.style.animation = '';
                    card.style.transition = '';
                });
                
                console.log('âœ… æ¨¡æ…‹æ¡†ç‹€æ…‹å·²å®Œå…¨é‡ç½®');
            }
        }

        // éœ‡å‹•å›é¥‹å‡½æ•¸
        function triggerHapticFeedback(type) {
            // æª¢æŸ¥æ˜¯å¦æ”¯æ´éœ‡å‹•API
            if (!navigator.vibrate) {
                console.log('ğŸ“± è¨­å‚™ä¸æ”¯æ´éœ‡å‹•åŠŸèƒ½');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦åœ¨æ‰‹æ©Ÿç«¯
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (!isMobile) {
                console.log('ğŸ’» éæ‰‹æ©Ÿè¨­å‚™ï¼Œè·³ééœ‡å‹•');
                return;
            }

            try {
                switch (type) {
                    case 'start':
                        // é–‹å§‹é›†æ°£ï¼šè¼•å¾®éœ‡å‹•
                        navigator.vibrate(30);
                        console.log('ğŸ“³ éœ‡å‹•å›é¥‹ï¼šé–‹å§‹é›†æ°£');
                        break;
                    case 'loading':
                        // è¼‰å…¥ä¸­ï¼šæ¼¸å¼·éœ‡å‹•
                        navigator.vibrate([40, 60, 40]);
                        console.log('ğŸ“³ éœ‡å‹•å›é¥‹ï¼šè¼‰å…¥ä¸­');
                        break;
                    case 'complete':
                        // å®Œæˆï¼šå¼·çƒˆéœ‡å‹•
                        navigator.vibrate([80, 50, 80]);
                        console.log('ğŸ“³ éœ‡å‹•å›é¥‹ï¼šå®Œæˆ');
                        break;
                    case 'release':
                        // é‡‹æ”¾ï¼šè¼•å¾®éœ‡å‹•
                        navigator.vibrate(20);
                        console.log('ğŸ“³ éœ‡å‹•å›é¥‹ï¼šé‡‹æ”¾');
                        break;
                    default:
                        // é è¨­ï¼šçŸ­éœ‡å‹•
                        navigator.vibrate(50);
                        console.log('ğŸ“³ éœ‡å‹•å›é¥‹ï¼šé è¨­');
                }
            } catch (error) {
                console.warn('ğŸ“³ éœ‡å‹•åŠŸèƒ½åŸ·è¡Œå¤±æ•—:', error);
            }
        }

        document.addEventListener('mousedown', function(e) {
            // ç¢ºä¿ e.target æœ‰ closest æ–¹æ³•
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && !eventCard.classList.contains('charging')) {
                const title = eventCard.dataset.eventTitle;
                const instructor = eventCard.dataset.eventInstructor;
                const start = eventCard.dataset.eventStart;
                const end = eventCard.dataset.eventEnd;
                
                if (title && instructor && start && end) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºåœèª²èª²ç¨‹
                    if (eventCard.classList.contains('cancelled-event')) {
                        console.log('âš ï¸ åœèª²èª²ç¨‹ç„¡æ³•ç°½åˆ°');
                        alert('âš ï¸ æ­¤èª²ç¨‹å·²åœèª²ï¼Œç„¡æ³•é€²è¡Œç°½åˆ°');
                        return;
                    }
                    
                    // é–‹å§‹é•·æŒ‰è¨ˆæ™‚
                    chargingStartTime = Date.now();
                    isCharging = true;
                    
                    // ç«‹å³æ·»åŠ æŒ‰å£“æ•ˆæœ
                    eventCard.classList.add('pressing');
                    
                    // éœ‡å‹•å›é¥‹ï¼šé–‹å§‹æŒ‰å£“
                    triggerHapticFeedback('start');
                    
                    // 0.3ç§’å¾Œé–‹å§‹é›†æ°£å……èƒ½æ•ˆæœ
                    longPressTimer = setTimeout(() => {
                        if (isCharging) {
                            console.log('ğŸ”‹ è§¸ç™¼å……é›»å‹•ç•«ï¼Œç§»é™¤ pressing é¡åˆ¥ï¼Œæ·»åŠ  charging é¡åˆ¥');
                            eventCard.classList.remove('pressing');
                            eventCard.classList.add('charging');
                            console.log('ğŸ”‹ é–‹å§‹é›†æ°£å……èƒ½...');
                            console.log('ğŸ”‹ ç•¶å‰èª²ç¨‹å¡ç‰‡é¡åˆ¥:', eventCard.className);
                            
                            // éœ‡å‹•å›é¥‹ï¼šé–‹å§‹é›†æ°£
                            triggerHapticFeedback('start');
                            
                            // 0.5ç§’å¾Œé–‹å§‹é›†æ°£å……èƒ½æ•ˆæœ
                            longPressTimer = setTimeout(() => {
                                if (isCharging) {
                                    console.log('ğŸ”‹ æ»‘é¼ è¨­å‚™è§¸ç™¼å……é›»å‹•ç•«ï¼Œç§»é™¤ pressing é¡åˆ¥ï¼Œæ·»åŠ  charging é¡åˆ¥');
                                    eventCard.classList.remove('pressing');
                                    eventCard.classList.add('charging');
                                    console.log('ğŸ”‹ é–‹å§‹é›†æ°£å……èƒ½...');
                                    console.log('ğŸ”‹ ç•¶å‰èª²ç¨‹å¡ç‰‡é¡åˆ¥:', eventCard.className);
                                    
                                    // éœ‡å‹•å›é¥‹ï¼šé–‹å§‹é›†æ°£
                                    triggerHapticFeedback('start');
                                    
                                    // 1ç§’å¾Œé–‹å§‹å¾Œç«¯é è¼‰å…¥ï¼ˆ0.5ç§’å¾Œï¼‰
                                    setTimeout(() => {
                                        if (isCharging) {
                                            console.log('ğŸ“š é–‹å§‹å¾Œç«¯é è¼‰å…¥å­¸ç”Ÿè³‡æ–™...');
                                            // éœ‡å‹•å›é¥‹ï¼šè¼‰å…¥ä¸­
                                            triggerHapticFeedback('loading');
                                        }
                                    }, 500);
                                    
                                    // 1.5ç§’å¾Œè·³å‡ºè¼‰å…¥å‹•ç•«ï¼ˆ1ç§’å¾Œï¼‰
                                    setTimeout(() => {
                                        if (isCharging) {
                                            console.log('ğŸš€ è·³å‡ºè¼‰å…¥ç•«é¢');
                                            eventCard.classList.remove('charging');
                                            // éœ‡å‹•å›é¥‹ï¼šå®Œæˆ
                                            triggerHapticFeedback('complete');
                                            handleDirectAttendance(title, instructor, start, end);
                                        }
                                    }, 1000);
                                }
                            }, 500);
                        }
                    }, 300);
                }
            }
        });

        document.addEventListener('mouseup', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && (longPressTimer || isCharging)) {
                // é˜²æ­¢é‡è¤‡è§¸ç™¼
                if (isAnimating) return;
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                if (isCharging) {
                    isAnimating = true;
                    
                    // éœ‡å‹•å›é¥‹ï¼šé‡‹æ”¾
                    triggerHapticFeedback('release');
                    
                    // å„ªåŒ–çš„é‡‹æ”¾å‹•ç•«é‚è¼¯
                    eventCard.classList.remove('charging', 'pressing');
                    eventCard.classList.add('releasing');
                    
                    // å‹•ç•«å®Œæˆå¾Œæ·»åŠ éæ¸¡ç‹€æ…‹ï¼Œç„¶å¾Œå¹³æ»‘ç§»é™¤
                    setTimeout(() => {
                        eventCard.classList.add('completing');
                        setTimeout(() => {
                            eventCard.classList.remove('releasing', 'completing');
                            // æ¸…é™¤æ‰€æœ‰å‹•ç•«ç›¸é—œçš„æ¨£å¼
                            eventCard.style.animation = '';
                            eventCard.style.transition = '';
                            isAnimating = false;
                            console.log('âœ… æ»‘é¼ é‡‹æ”¾å‹•ç•«å®Œæˆ');
                        }, 150);
                    }, 300);
                    
                    console.log('âŒ é•·æŒ‰ä¸­æ–·ï¼Œæ’­æ”¾é‡‹æ”¾å‹•ç•«');
                } else {
                    eventCard.classList.remove('pressing');
                    console.log('âŒ é•·æŒ‰ä¸­æ–·');
                }
                
                isCharging = false;
            }
        });

        document.addEventListener('mouseleave', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && (longPressTimer || isCharging)) {
                // é˜²æ­¢é‡è¤‡è§¸ç™¼
                if (isAnimating) return;
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                if (isCharging) {
                    isAnimating = true;
                    
                    // éœ‡å‹•å›é¥‹ï¼šé‡‹æ”¾
                    triggerHapticFeedback('release');
                    
                    // å„ªåŒ–çš„é‡‹æ”¾å‹•ç•«é‚è¼¯
                    eventCard.classList.remove('charging', 'pressing');
                    eventCard.classList.add('releasing');
                    
                    // å‹•ç•«å®Œæˆå¾Œæ·»åŠ éæ¸¡ç‹€æ…‹ï¼Œç„¶å¾Œå¹³æ»‘ç§»é™¤
                    setTimeout(() => {
                        eventCard.classList.add('completing');
                        setTimeout(() => {
                            eventCard.classList.remove('releasing', 'completing');
                            // æ¸…é™¤æ‰€æœ‰å‹•ç•«ç›¸é—œçš„æ¨£å¼
                            eventCard.style.animation = '';
                            eventCard.style.transition = '';
                            isAnimating = false;
                            console.log('âœ… æ»‘é¼ é›¢é–‹é‡‹æ”¾å‹•ç•«å®Œæˆ');
                        }, 200);
                    }, 400);
                    
                    console.log('âŒ æ»‘é¼ é›¢é–‹ï¼Œæ’­æ”¾é‡‹æ”¾å‹•ç•«');
                } else {
                    eventCard.classList.remove('pressing');
                    console.log('âŒ æ»‘é¼ é›¢é–‹ï¼Œé•·æŒ‰ä¸­æ–·');
                }
                
                isCharging = false;
            }
        });

        // è§¸æ§è¨­å‚™æ”¯æ´
        document.addEventListener('touchstart', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && !eventCard.classList.contains('charging')) {
                const title = eventCard.dataset.eventTitle;
                const instructor = eventCard.dataset.eventInstructor;
                const start = eventCard.dataset.eventStart;
                const end = eventCard.dataset.eventEnd;
                
                if (title && instructor && start && end) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºåœèª²èª²ç¨‹
                    if (eventCard.classList.contains('cancelled-event')) {
                        console.log('âš ï¸ åœèª²èª²ç¨‹ç„¡æ³•ç°½åˆ°ï¼ˆè§¸æ§ï¼‰');
                        alert('âš ï¸ æ­¤èª²ç¨‹å·²åœèª²ï¼Œç„¡æ³•é€²è¡Œç°½åˆ°');
                        return;
                    }
                    
                    // è¨˜éŒ„è§¸æ§é–‹å§‹ä½ç½®å’Œæ™‚é–“
                    const touch = e.touches[0];
                    touchStartPos.x = touch.clientX;
                    touchStartPos.y = touch.clientY;
                    touchCurrentPos.x = touch.clientX;
                    touchCurrentPos.y = touch.clientY;
                    touchStartTime = Date.now();
                    isScrolling = false;
                    isTouchActive = true;
                    isTouchCancelled = false;
                    
                    chargingStartTime = Date.now();
                    isCharging = true;
                    
                    // ç«‹å³æ·»åŠ æŒ‰å£“æ•ˆæœ
                    eventCard.classList.add('pressing');
                    
                    // éœ‡å‹•å›é¥‹ï¼šé–‹å§‹æŒ‰å£“
                    triggerHapticFeedback('start');
                    
                    // 0.5ç§’å¾Œé–‹å§‹é›†æ°£å……èƒ½æ•ˆæœ
                    longPressTimer = setTimeout(() => {
                        if (isCharging && !isScrolling) {
                            console.log('ğŸ”‹ è§¸æ§è¨­å‚™è§¸ç™¼å……é›»å‹•ç•«ï¼Œç§»é™¤ pressing é¡åˆ¥ï¼Œæ·»åŠ  charging é¡åˆ¥');
                            eventCard.classList.remove('pressing');
                            eventCard.classList.add('charging');
                            console.log('ğŸ”‹ é–‹å§‹é›†æ°£å……èƒ½...');
                            console.log('ğŸ”‹ ç•¶å‰èª²ç¨‹å¡ç‰‡é¡åˆ¥:', eventCard.className);
                            
                            // éœ‡å‹•å›é¥‹ï¼šé–‹å§‹é›†æ°£
                            triggerHapticFeedback('start');
                            
                            // 1ç§’å¾Œé–‹å§‹å¾Œç«¯é è¼‰å…¥ï¼ˆ0.5ç§’å¾Œï¼‰
                            setTimeout(() => {
                                if (isCharging && !isScrolling) {
                                    console.log('ğŸ“š é–‹å§‹å¾Œç«¯é è¼‰å…¥å­¸ç”Ÿè³‡æ–™...');
                                    // éœ‡å‹•å›é¥‹ï¼šè¼‰å…¥ä¸­
                                    triggerHapticFeedback('loading');
                                }
                            }, 500);
                            
                            // 1.5ç§’å¾Œè·³å‡ºè¼‰å…¥å‹•ç•«ï¼ˆ1ç§’å¾Œï¼‰
                            setTimeout(() => {
                                if (isCharging && !isScrolling) {
                                    console.log('ğŸš€ è·³å‡ºè¼‰å…¥ç•«é¢');
                                    eventCard.classList.remove('charging');
                                    // éœ‡å‹•å›é¥‹ï¼šå®Œæˆ
                                    triggerHapticFeedback('complete');
                                    handleDirectAttendance(title, instructor, start, end);
                                }
                            }, 1000);
                        }
                    }, 500);
                }
            }
        });

        // è§¸æ§ç§»å‹•äº‹ä»¶ - æª¢æ¸¬æ»‘å‹•
        document.addEventListener('touchmove', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && isCharging) {
                const touch = e.touches[0];
                touchCurrentPos.x = touch.clientX;
                touchCurrentPos.y = touch.clientY;
                
                // è¨ˆç®—ç§»å‹•è·é›¢å’Œæ–¹å‘
                const deltaX = touchCurrentPos.x - touchStartPos.x;
                const deltaY = touchCurrentPos.y - touchStartPos.y;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                // è¨ˆç®—ç§»å‹•é€Ÿåº¦
                const currentTime = Date.now();
                const timeDelta = currentTime - touchStartTime;
                const velocity = distance / (timeDelta || 1);
                
                // å¦‚æœç§»å‹•è·é›¢è¶…éå–æ¶ˆé–¾å€¼ï¼Œæ¨™è¨˜ç‚ºè§¸æ§å–æ¶ˆ
                if (distance > touchCancelThreshold) {
                    isTouchCancelled = true;
                    console.log('ğŸ“± æª¢æ¸¬åˆ°è§¸æ§å–æ¶ˆï¼Œè·é›¢:', distance);
                    
                    // éœ‡å‹•å›é¥‹ï¼šè§¸æ§å–æ¶ˆ
                    triggerHapticFeedback('release');
                    
                    // ç«‹å³åœæ­¢å……é›»
                    if (eventCard.classList.contains('charging')) {
                        eventCard.classList.remove('charging', 'pressing');
                        eventCard.classList.add('releasing');
                        
                        setTimeout(() => {
                            eventCard.classList.add('completing');
                            setTimeout(() => {
                                eventCard.classList.remove('releasing', 'completing');
                                eventCard.style.animation = '';
                                eventCard.style.transition = '';
                                isAnimating = false;
                            }, 200);
                        }, 400);
                    } else {
                        eventCard.classList.remove('pressing');
                    }
                    
                    // æ¸…é™¤é•·æŒ‰è¨ˆæ™‚å™¨
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    
                    isCharging = false;
                    isTouchActive = false;
                    return;
                }
                
                // å¦‚æœç§»å‹•è·é›¢è¶…éæ»‘å‹•é–¾å€¼æˆ–é€Ÿåº¦éå¿«ï¼Œæ¨™è¨˜ç‚ºæ»‘å‹•
                if (distance > scrollThreshold || velocity > 0.3) {
                    isScrolling = true;
                    console.log('ğŸ“± æª¢æ¸¬åˆ°æ»‘å‹•ï¼Œå–æ¶ˆé•·æŒ‰åŠŸèƒ½', { distance, velocity });
                    
                    // éœ‡å‹•å›é¥‹ï¼šæ»‘å‹•å–æ¶ˆ
                    triggerHapticFeedback('release');
                    
                    // å¦‚æœæ­£åœ¨å……é›»ï¼Œç«‹å³åœæ­¢
                    if (eventCard.classList.contains('charging')) {
                        eventCard.classList.remove('charging', 'pressing');
                        eventCard.classList.add('releasing');
                        
                        setTimeout(() => {
                            eventCard.classList.add('completing');
                            setTimeout(() => {
                                eventCard.classList.remove('releasing', 'completing');
                                // æ¸…é™¤æ‰€æœ‰å‹•ç•«ç›¸é—œçš„æ¨£å¼
                                eventCard.style.animation = '';
                                eventCard.style.transition = '';
                                isAnimating = false;
                            }, 200);
                        }, 400);
                    }
                    
                    // æ¸…é™¤é•·æŒ‰è¨ˆæ™‚å™¨
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    
                    isCharging = false;
                    isTouchActive = false;
                }
            }
        });

        document.addEventListener('touchend', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && (longPressTimer || isCharging)) {
                // é˜²æ­¢é‡è¤‡è§¸ç™¼
                if (isAnimating) return;
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºè§¸æ§å–æ¶ˆ
                if (isTouchCancelled) {
                    console.log('ğŸ“± è§¸æ§çµæŸï¼šè§¸æ§å·²å–æ¶ˆï¼Œä¸è§¸ç™¼é•·æŒ‰åŠŸèƒ½');
                    eventCard.classList.remove('pressing', 'charging');
                    isCharging = false;
                    isScrolling = false;
                    isTouchActive = false;
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ»‘å‹•æ“ä½œ
                if (isScrolling) {
                    console.log('ğŸ“± è§¸æ§çµæŸï¼šæ»‘å‹•æ“ä½œï¼Œä¸è§¸ç™¼é•·æŒ‰åŠŸèƒ½');
                    eventCard.classList.remove('pressing', 'charging');
                    isCharging = false;
                    isScrolling = false;
                    isTouchActive = false;
                    return;
                }
                
                // è¨ˆç®—è§¸æ§æŒçºŒæ™‚é–“
                touchDuration = Date.now() - touchStartTime;
                console.log('ğŸ“± è§¸æ§çµæŸï¼ŒæŒçºŒæ™‚é–“:', touchDuration + 'ms');
                
                // æª¢æŸ¥æœ€å°é•·æŒ‰æ™‚é–“ï¼ˆ1.5ç§’ï¼‰
                if (touchDuration < 1500) {
                    console.log('ğŸ“± è§¸æ§æ™‚é–“å¤ªçŸ­ï¼ˆ< 1.5ç§’ï¼‰ï¼Œä¸è§¸ç™¼é•·æŒ‰åŠŸèƒ½');
                    eventCard.classList.remove('pressing', 'charging');
                    isCharging = false;
                    isScrolling = false;
                    isTouchActive = false;
                    return;
                }
                
                if (isCharging) {
                    isAnimating = true;
                    
                    // éœ‡å‹•å›é¥‹ï¼šé‡‹æ”¾
                    triggerHapticFeedback('release');
                    
                    // å„ªåŒ–çš„é‡‹æ”¾å‹•ç•«é‚è¼¯
                    eventCard.classList.remove('charging', 'pressing');
                    eventCard.classList.add('releasing');
                    
                    // å‹•ç•«å®Œæˆå¾Œæ·»åŠ éæ¸¡ç‹€æ…‹ï¼Œç„¶å¾Œå¹³æ»‘ç§»é™¤
                    setTimeout(() => {
                        eventCard.classList.add('completing');
                        setTimeout(() => {
                            eventCard.classList.remove('releasing', 'completing');
                            // æ¸…é™¤æ‰€æœ‰å‹•ç•«ç›¸é—œçš„æ¨£å¼
                            eventCard.style.animation = '';
                            eventCard.style.transition = '';
                            isAnimating = false;
                            console.log('âœ… è§¸æ§é‡‹æ”¾å‹•ç•«å®Œæˆ');
                        }, 200);
                    }, 400);
                    
                    console.log('âŒ è§¸æ§é•·æŒ‰ä¸­æ–·ï¼Œæ’­æ”¾é‡‹æ”¾å‹•ç•«');
                } else {
                    eventCard.classList.remove('pressing');
                    console.log('âŒ è§¸æ§é•·æŒ‰ä¸­æ–·');
                }
                
                isCharging = false;
                isScrolling = false;
                isTouchActive = false; // é‡ç½®è§¸æ§ç‹€æ…‹
            }
        });

        // è§¸æ§å–æ¶ˆäº‹ä»¶ - è™•ç†æ„å¤–ä¸­æ–·
        document.addEventListener('touchcancel', function(e) {
            if (!e.target || typeof e.target.closest !== 'function') return;
            
            const eventCard = e.target.closest('.event-card');
            if (eventCard && (longPressTimer || isCharging) && isTouchActive) {
                console.log('ğŸ“± è§¸æ§å–æ¶ˆäº‹ä»¶');
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                // éœ‡å‹•å›é¥‹ï¼šå–æ¶ˆ
                triggerHapticFeedback('release');
                
                if (isCharging) {
                    eventCard.classList.remove('charging', 'pressing');
                    eventCard.classList.add('releasing');
                    
                    setTimeout(() => {
                        eventCard.classList.add('completing');
                        setTimeout(() => {
                            eventCard.classList.remove('releasing', 'completing');
                            // æ¸…é™¤æ‰€æœ‰å‹•ç•«ç›¸é—œçš„æ¨£å¼
                            eventCard.style.animation = '';
                            eventCard.style.transition = '';
                            isAnimating = false;
                        }, 200);
                    }, 400);
                } else {
                    eventCard.classList.remove('pressing');
                }
                
                isCharging = false;
                isScrolling = false;
                isTouchActive = false;
                isTouchCancelled = false;
            }
        });

        // ==================== ç°½åˆ°ç³»çµ±åŠŸèƒ½ ====================
        
        // ç‰¹æ®Šèª²ç¨‹é¡å‹å®šç¾©
        const SPECIAL_EVENT_TYPES = {
            "åœèª²": ["åœèª²", "å–æ¶ˆ", "æš«åœ", "ä¼‘æ¯", "æ”¾å‡", "è«‹å‡"],
            "é«”é©—": ["é«”é©—", "é«”é©—èª²", "é«”é©—ç­", "é«”èª²", "é«”"],
            "ä»£èª²": ["ä»£èª²", "ä»£ç†", "æ”¯æ´", "ä»£"],
            "è£œèª²": ["è£œèª²", "èª¿èª²", "å»¶å¾Œ", "æå‰"],
            "å®¢è£½åŒ–": ["å®¢è£½åŒ–", "å®¢åˆ¶åŒ–", "å®¢è£½", "å®¢åˆ¶", "å®¢è£½èª²ç¨‹", "å®¢åˆ¶èª²ç¨‹"],
            "åˆ°åºœ": ["åˆ°åºœ", "åˆ°åºœæœå‹™", "åˆ°åºœæ•™å­¸", "åˆ°åºœèª²ç¨‹", "åˆ°åºœä¸Šèª²"]
        };
        
        // å°‡ç‰¹æ®Šäº‹ä»¶é¡å‹æš´éœ²åˆ°å…¨åŸŸè®Šæ•¸
        window.SPECIAL_EVENT_TYPES = SPECIAL_EVENT_TYPES;

        // æ¨¡ç³ŠåŒ¹é…è¬›å¸«åç¨±
        function findMatchingInstructor(targetInstructor, availableInstructors) {
            if (!targetInstructor || !availableInstructors || availableInstructors.length === 0) {
                return null;
            }

            const target = targetInstructor.trim().toLowerCase();
            
            // 1. å®Œå…¨åŒ¹é…ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
            let exactMatch = availableInstructors.find(instructor => 
                instructor.toLowerCase() === target
            );
            if (exactMatch) {
                console.log(`âœ… å®Œå…¨åŒ¹é…æ‰¾åˆ°è¬›å¸«: ${exactMatch}`);
                return exactMatch;
            }

            // 2. åŒ…å«åŒ¹é…
            let containsMatch = availableInstructors.find(instructor => 
                instructor.toLowerCase().includes(target) || target.includes(instructor.toLowerCase())
            );
            if (containsMatch) {
                console.log(`âœ… åŒ…å«åŒ¹é…æ‰¾åˆ°è¬›å¸«: ${containsMatch}`);
                return containsMatch;
            }

            // 3. æ¨¡ç³ŠåŒ¹é…ï¼ˆä½¿ç”¨ Levenshtein è·é›¢ï¼‰
            let bestMatch = null;
            let bestScore = Infinity;
            const threshold = 3; // æœ€å¤§ç·¨è¼¯è·é›¢

            for (const instructor of availableInstructors) {
                const distance = levenshteinDistance(target, instructor.toLowerCase());
                if (distance <= threshold && distance < bestScore) {
                    bestScore = distance;
                    bestMatch = instructor;
                }
            }

            if (bestMatch) {
                console.log(`âœ… æ¨¡ç³ŠåŒ¹é…æ‰¾åˆ°è¬›å¸«: ${bestMatch} (è·é›¢: ${bestScore})`);
                return bestMatch;
            }

            console.log(`âŒ æ‰¾ä¸åˆ°åŒ¹é…çš„è¬›å¸«: ${targetInstructor}`);
            return null;
        }

        // Levenshtein è·é›¢ç®—æ³•
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;

            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[len2][len1];
        }

        // ç§»é™¤ç‰¹æ®Šèª²ç¨‹é¡å‹
        function removeSpecialEventTypes(timeInfo) {
            if (!timeInfo) return timeInfo;
            
            let cleanedTimeInfo = timeInfo;
            
            // ç§»é™¤ç‰¹æ®Šèª²ç¨‹é¡å‹
            for (const [category, keywords] of Object.entries(SPECIAL_EVENT_TYPES)) {
                for (const keyword of keywords) {
                    const regex = new RegExp(`\\s*${keyword}\\s*`, 'gi');
                    cleanedTimeInfo = cleanedTimeInfo.replace(regex, ' ');
                }
            }
            
            // ç§»é™¤é€±æ•¸è³‡è¨Š
            cleanedTimeInfo = cleanedTimeInfo.replace(/\s*ç¬¬\d+é€±\s*/gi, ' ');
            
            // æ¸…ç†å¤šé¤˜ç©ºæ ¼
            cleanedTimeInfo = cleanedTimeInfo.replace(/\s+/g, ' ').trim();
            
            return cleanedTimeInfo;
        }

        // è§£æèª²ç¨‹æ¨™é¡Œ
        function parseCourseTitle(fullTitle) {
            if (!fullTitle) {
                return { courseName: '', timeInfo: '' };
            }

            console.log(`ğŸ” è§£æèª²ç¨‹æ¨™é¡Œ: "${fullTitle}"`);

            // å®šç¾©å¤šç¨®èª²ç¨‹æ¨™é¡Œæ ¼å¼çš„æ­£å‰‡è¡¨é”å¼
            const patterns = [
                // æ ¼å¼1: "SPIKE PRO æ—¥ 10:00-12:00 ç¬¬3é€±" - è™•ç†åŒ…å«ç©ºæ ¼çš„èª²ç¨‹åç¨±
                /^([A-Z]+(?:\s+[A-Z]+)*)\s+([ä¸€äºŒä¸‰å››äº”å…­æ—¥])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})(?:\s+(.+?))?(?:\s+ç¬¬\d+é€±.*)?$/,
                // æ ¼å¼2: "ESM å…­ 9:30-10:30 åˆ°åºœ ç¬¬4é€±è«‹å‡"
                /^([A-Z]+)\s+([ä¸€äºŒä¸‰å››äº”å…­æ—¥])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})\s+(.+?)(?:\s+ç¬¬\d+é€±.*)?$/,
                // æ ¼å¼3: "SPM ä¸‰1630-1730 åˆ°åºœ ç¬¬3é€±" - è™•ç†æ˜ŸæœŸå¾Œç›´æ¥è·Ÿæ™‚é–“çš„æ ¼å¼
                /^([A-Z]+)\s+([ä¸€äºŒä¸‰å››äº”å…­æ—¥])(\d{4})-(\d{4})\s+(.+?)(?:\s+ç¬¬\d+é€±.*)?$/,
                // æ ¼å¼4: "BOOST å…­ 1530-1700 åˆ°åºœ"
                /^([A-Z]+)\s+([ä¸€äºŒä¸‰å››äº”å…­æ—¥])\s+(\d{4})-(\d{4})\s+(.+?)(?:\s+ç¬¬\d+é€±.*)?$/,
                // æ ¼å¼5: "SPIKE å…­ 9:30-10:30"
                /^([A-Z]+)\s+([ä¸€äºŒä¸‰å››äº”å…­æ—¥])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})(?:\s+(.+?))?(?:\s+ç¬¬\d+é€±.*)?$/,
                // æ ¼å¼6: "ESM å…­ 1530-1700"
                /^([A-Z]+)\s+([ä¸€äºŒä¸‰å››äº”å…­æ—¥])\s+(\d{4})-(\d{4})(?:\s+(.+?))?(?:\s+ç¬¬\d+é€±.*)?$/,
                // æ ¼å¼7: "ESM å…­ 0930-1100 åˆ°åºœ"
                /^([A-Z]+)\s+([ä¸€äºŒä¸‰å››äº”å…­æ—¥])\s+(\d{4})-(\d{4})\s+(.+?)(?:\s+ç¬¬\d+é€±.*)?$/
            ];

            for (const pattern of patterns) {
                const match = fullTitle.match(pattern);
                if (match) {
                    let courseName = match[1];
                    const weekday = match[2];
                    const startTime = match[3];
                    const endTime = match[4];
                    const location = match[5] || '';

                    // è™•ç†èª²ç¨‹åç¨±ï¼šå¦‚æœæ˜¯ "SPIKE PRO" é€™æ¨£çš„æ ¼å¼ï¼Œåªå–ç¬¬ä¸€éƒ¨åˆ†
                    if (courseName.includes(' ')) {
                        const courseParts = courseName.split(' ');
                        // åªå–ç¬¬ä¸€å€‹å–®è©ä½œç‚ºä¸»è¦èª²ç¨‹åç¨±
                        courseName = courseParts[0];
                        console.log(`ğŸ”„ èª²ç¨‹åç¨±ç°¡åŒ–: "${match[1]}" â†’ "${courseName}"`);
                    }

                    // æ ¼å¼åŒ–æ™‚é–“
                    const formattedStartTime = formatTime(startTime);
                    const formattedEndTime = formatTime(endTime);

                    // æ§‹å»ºæ™‚é–“è³‡è¨Šå­—ä¸²
                    let timeInfo = `${weekday}${formattedStartTime}-${formattedEndTime}`;
                    if (location) {
                        timeInfo += ` ${location}`;
                    }

                    // ä¸ç§»é™¤ç‰¹æ®Šèª²ç¨‹é¡å‹ï¼Œä¿ç•™å®Œæ•´ä¿¡æ¯

                    console.log(`âœ… è§£ææˆåŠŸ: èª²ç¨‹="${courseName}", æ™‚é–“è³‡è¨Š="${timeInfo}"`);
                    return { courseName, timeInfo };
                }
            }

            // å¦‚æœæ²’æœ‰åŒ¹é…åˆ°ä»»ä½•æ ¼å¼ï¼Œè¿”å›åŸå§‹æ¨™é¡Œ
            console.log(`âš ï¸ ç„¡æ³•è§£æèª²ç¨‹æ¨™é¡Œæ ¼å¼: "${fullTitle}"`);
            return { courseName: fullTitle, timeInfo: '' };
        }

        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(timeStr) {
            if (!timeStr) return '';
            
            // å¦‚æœå·²ç¶“æ˜¯ HHHH æ ¼å¼ï¼Œç›´æ¥è¿”å›
            if (timeStr.length === 4 && !timeStr.includes(':')) {
                return timeStr;
            }
            
            // å¦‚æœæ˜¯ HH:MM æ ¼å¼ï¼Œè½‰æ›ç‚º HHHH
            if (timeStr.includes(':')) {
                const [hours, minutes] = timeStr.split(':');
                return `${hours.padStart(2, '0')}${minutes.padStart(2, '0')}`;
            }
            
            return timeStr;
        }

        // ç²å–å¯ç”¨è¬›å¸«åˆ—è¡¨
        async function getAvailableInstructors() {
            try {
                const response = await fetch('/api/teachers');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.teachers && data.teachers.length > 0) {
                    console.log('âœ… æˆåŠŸç²å–è¬›å¸«åˆ—è¡¨:', data.teachers.length, 'å€‹è¬›å¸«');
                    return data.teachers.map(teacher => teacher.name);
                } else {
                    console.warn('âš ï¸ è¬›å¸«åˆ—è¡¨ç‚ºç©ºï¼Œä½¿ç”¨é è¨­åˆ—è¡¨');
                    return ['Tim', 'Ted', 'Agnes', 'Hansen', 'James', 'Ivan', 'Xian', 'Eason', 'Bella', 'Gillian', 'Daniel', 'Philp', 'Tony', 'Jacky', 'Weinie', 'test', 'Dirty', 'Melody', 'æ‚£æ°´'];
                }
            } catch (error) {
                console.error('âŒ ç²å–è¬›å¸«åˆ—è¡¨å¤±æ•—:', error.message);
                console.log('ğŸ”„ ä½¿ç”¨é è¨­è¬›å¸«åˆ—è¡¨ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ');
                return ['Tim', 'Ted', 'Agnes', 'Hansen', 'James', 'Ivan', 'Xian', 'Eason', 'Bella', 'Gillian', 'Daniel', 'Philp', 'Tony', 'Jacky', 'Weinie', 'test', 'Dirty', 'Melody', 'æ‚£æ°´'];
            }
        }

        // è™•ç†ç›´æ¥ç°½åˆ°
        async function handleDirectAttendance(title, instructor, start, end) {
            try {
                console.log('ğŸ¯ è™•ç†ç›´æ¥ç°½åˆ°:', { title, instructor, start, end });
                
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ¨¡æ…‹æ¡†åœ¨é¡¯ç¤º
                if (currentAttendanceModal) {
                    console.log('âš ï¸ å·²æœ‰æ¨¡æ…‹æ¡†åœ¨é¡¯ç¤ºï¼Œå–æ¶ˆæ–°çš„ç°½åˆ°è«‹æ±‚');
                    return;
                }
                
                // æª¢æŸ¥èª²ç¨‹æ™‚é–“é™åˆ¶
                const courseStartTime = new Date(start);
                const currentTime = new Date();
                const timeDiff = courseStartTime.getTime() - currentTime.getTime();
                const minutesUntilStart = Math.floor(timeDiff / (1000 * 60));
                
                console.log(`â° èª²ç¨‹é–‹å§‹æ™‚é–“: ${courseStartTime.toLocaleString()}`);
                console.log(`â° ç•¶å‰æ™‚é–“: ${currentTime.toLocaleString()}`);
                console.log(`â° è·é›¢èª²ç¨‹é–‹å§‹: ${minutesUntilStart} åˆ†é˜`);
                
                // è§£æèª²ç¨‹æ¨™é¡Œï¼Œåˆ†é›¢èª²ç¨‹åç¨±å’Œæ™‚é–“è³‡è¨Š
                const { courseName, timeInfo } = parseCourseTitle(title);
                console.log(`ğŸ“ è§£æçµæœ: èª²ç¨‹="${courseName}", æ™‚é–“è³‡è¨Š="${timeInfo}"`);
                
                // ç²å–å¯ç”¨è¬›å¸«åˆ—è¡¨ä¸¦é€²è¡Œæ¨¡ç³Šæ¯”å°
                const availableInstructors = await getAvailableInstructors();
                const matchedInstructor = findMatchingInstructor(instructor, availableInstructors);
                
                if (!matchedInstructor) {
                    const errorMsg = `è¬›å¸« "${instructor}" ä¸å­˜åœ¨ã€‚å¯ç”¨çš„è¬›å¸«ï¼š${availableInstructors.join(', ')}`;
                    console.error('âŒ', errorMsg);
                    alert(errorMsg);
                    return;
                }

                // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„è¬›å¸«ï¼Œä½¿ç”¨åŒ¹é…çš„åç¨±
                if (matchedInstructor !== instructor) {
                    console.log(`ğŸ”„ è¬›å¸«åç¨±å·²ä¿®æ­£: "${instructor}" â†’ "${matchedInstructor}"`);
                    instructor = matchedInstructor;
                }
                
                // ä½¿ç”¨è§£æå¾Œçš„èª²ç¨‹åç¨±å’Œæ™‚é–“è³‡è¨Š
                const finalCourseName = courseName;
                let finalTimeString = timeInfo || `${new Date(start).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} - ${new Date(end).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}`;
                
                // ä¿®å¾©æ™‚é–“æ ¼å¼ï¼šç¢ºä¿æ˜ŸæœŸå’Œæ™‚é–“ä¹‹é–“æœ‰ç©ºæ ¼ï¼Œæ™‚é–“å’Œåœ°é»ä¹‹é–“ä¹Ÿæœ‰ç©ºæ ¼
                if (finalTimeString && finalTimeString.includes(' ')) {
                    // åŒ¹é…æ ¼å¼ï¼šæ˜ŸæœŸ + æ™‚é–“ + ç©ºæ ¼ + åœ°é»ï¼ˆæ²’æœ‰æ˜ŸæœŸå’Œæ™‚é–“ä¹‹é–“çš„ç©ºæ ¼ï¼‰
                    // ä¾‹å¦‚ï¼š"ä¸€1930-2030 åˆ°åºœ" -> "ä¸€ 1930-2030 åˆ°åºœ"
                    finalTimeString = finalTimeString.replace(/^([ä¸€äºŒä¸‰å››äº”å…­æ—¥])(\d{4}-\d{4})\s+(.+)$/, '$1 $2 $3');
                } else if (finalTimeString && !finalTimeString.includes(' ')) {
                    // åŒ¹é…æ ¼å¼ï¼šæ˜ŸæœŸ + æ™‚é–“ï¼ˆå®Œå…¨æ²’æœ‰ç©ºæ ¼ï¼‰
                    // ä¾‹å¦‚ï¼š"ä¸€1930-2030" -> "ä¸€ 1930-2030"
                    finalTimeString = finalTimeString.replace(/^([ä¸€äºŒä¸‰å››äº”å…­æ—¥])(\d{4}-\d{4})$/, '$1 $2');
                }
                
                console.log('ğŸ”§ æ™‚é–“æ ¼å¼ä¿®å¾©:', { original: timeInfo, fixed: finalTimeString });
                
                // é–‹å•ŸåŸç”Ÿç°½åˆ°ç³»çµ±ï¼ˆå‚³å…¥æ™‚é–“é™åˆ¶è³‡è¨Šå’ŒåŸå§‹æ¨™é¡Œï¼‰
                await openNativeAttendanceSystem(matchedInstructor, finalCourseName, finalTimeString, start, end, minutesUntilStart, title);
                
            } catch (error) {
                console.error('âŒ ç›´æ¥ç°½åˆ°å¤±æ•—:', error);
                alert('ç›´æ¥ç°½åˆ°å¤±æ•—: ' + error.message);
            }
        }

        // é–‹å•ŸåŸç”Ÿç°½åˆ°ç³»çµ±
        async function openNativeAttendanceSystem(teacher, course, time, start, end, minutesUntilStart = null, originalTitle = '') {
            try {
                console.log('ğŸ¯ é–‹å•ŸåŸç”Ÿç°½åˆ°ç³»çµ±:', { teacher, course, time, start, end, originalTitle });
                
                // ä¿å­˜ç•¶å‰ç°½åˆ°æ•¸æ“šï¼Œä»¥ä¾¿åœ¨æ¢å¾©å­¸ç”Ÿç°½åˆ°å…§å®¹æ™‚ä½¿ç”¨
                window.currentAttendanceData = { teacher, course, time, start, end, minutesUntilStart, originalTitle };
                
                // å‰µå»ºç°½åˆ°ç³»çµ±æ¨¡æ…‹æ¡†
                const modal = document.createElement('div');
                modal.id = 'attendanceModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease-out;
                `;
                
                modal.innerHTML = `
                    <div class="attendance-modal-content" style="
                        background: 
                            radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.15) 0%, transparent 50%),
                            radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.12) 0%, transparent 50%),
                            linear-gradient(135deg, 
                                rgba(255, 255, 255, 0.95) 0%, 
                                rgba(248, 248, 248, 0.92) 25%,
                                rgba(252, 252, 252, 0.9) 50%,
                                rgba(248, 248, 248, 0.92) 75%,
                                rgba(255, 255, 255, 0.95) 100%);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border-radius: 25px;
                        padding: 30px;
                        max-width: 90%;
                        max-height: 95vh;
                        width: 800px;
                        overflow-y: auto;
                        overflow-x: hidden;
                        /* å„ªåŒ–æ»¾å‹•æ€§èƒ½ */
                        -webkit-overflow-scrolling: touch;
                        scroll-behavior: smooth;
                        will-change: scroll-position;
                        contain: layout style paint;
                        box-shadow: 
                            0 20px 60px rgba(0, 0, 0, 0.4),
                            0 0 0 1px rgba(255, 215, 0, 0.2),
                            inset 0 1px 0 rgba(255, 255, 255, 0.1);
                        animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                        border: 1px solid rgba(255, 215, 0, 0.3);
                        position: relative;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <h2 style="margin: 0; color: #333333; font-size: 1.5rem; text-shadow: none;">
                                    <i class="fas fa-calendar-check" style="color: #b8860b; margin-right: 10px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                                    èª²ç¨‹ç°½åˆ°ç³»çµ±
                                </h2>
                                ${minutesUntilStart !== null ? `
                                    <div style="margin-top: 8px; font-size: 0.9rem; color: ${minutesUntilStart <= 10 ? '#28a745' : '#ffc107'}; font-weight: 600;">
                                        <i class="fas fa-clock" style="margin-right: 5px;"></i>
                                        ${minutesUntilStart > 0 ? 
                                            `è·é›¢èª²ç¨‹é–‹å§‹é‚„æœ‰ ${minutesUntilStart} åˆ†é˜` : 
                                            minutesUntilStart === 0 ? 
                                                'èª²ç¨‹å³å°‡é–‹å§‹' : 
                                                'èª²ç¨‹å·²é–‹å§‹'
                                        }
                                    </div>
                                ` : ''}
                            </div>
                            <button id="closeAttendanceModal" class="close-attendance-modal" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 215, 0, 0.4);
                                font-size: 1.5rem;
                                color: #333333;
                                cursor: pointer;
                                padding: 5px;
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.3s ease;
                                backdrop-filter: blur(10px);
                                -webkit-backdrop-filter: blur(10px);
                            ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        
                        <div class="course-info" style="
                            margin-bottom: 20px; 
                            padding: 20px; 
                            background: 
                                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.05) 0%, transparent 70%),
                                linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
                            border-radius: 15px; 
                            border: 1px solid rgba(255, 215, 0, 0.3);
                            backdrop-filter: blur(10px);
                            -webkit-backdrop-filter: blur(10px);
                            box-shadow: 
                                0 8px 32px rgba(0, 0, 0, 0.2),
                                inset 0 1px 0 rgba(255, 255, 255, 0.1);
                        ">
                            <div class="course-info-panel" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem;">
                                <div data-field="teacher" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">è¬›å¸«:</strong> ${teacher}</div>
                                <div data-field="course" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">èª²ç¨‹:</strong> ${course}</div>
                                <div data-field="time" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ™‚é–“:</strong> ${time}</div>
                                <div data-field="date" style="color: #333333;"><strong style="color: #b8860b; font-weight: 600;">æ—¥æœŸ:</strong> ${new Date(start).toLocaleDateString('zh-TW')}</div>
                            </div>
                        </div>
                        
                        <div id="attendanceContent">
                            <div style="text-align: center; padding: 60px 40px; color: #333333; background: linear-gradient(135deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05)); border-radius: 15px; transition: all 0.5s ease;">
                                <!-- å¡ç‰Œè¼‰å…¥å‹•ç•« -->
                                <div style="
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    gap: 10px;
                                    margin-bottom: 30px;
                                    perspective: 1000px;
                                ">
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0.1s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0.2s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0.3s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                    <div style="
                                        width: 20px;
                                        height: 30px;
                                        background: linear-gradient(135deg, #b8860b, #daa520);
                                        border-radius: 4px;
                                        animation: cardBounceIn 0.6s ease-out infinite;
                                        animation-delay: 0.4s;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
                                    "></div>
                                </div>
                                
                                <h3 style="margin: 0; color: #333333; animation: fadeIn 0.6s ease-out; text-shadow: none;">
                                    <i class="fas fa-id-card" style="margin-right: 8px; color: #b8860b; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                                    æ­£åœ¨ç™¼ç‰Œä¸­...
                                </h3>
                                
                                <p style="margin: 10px 0; color: #666666; font-size: 0.9rem;">
                                    æº–å‚™å­¸ç”Ÿå¡ç‰Œï¼Œè«‹ç¨å€™
                                </p>
                                
                                <div style="
                                    width: 200px;
                                    height: 4px;
                                    background: linear-gradient(90deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
                                    margin: 20px auto 0;
                                    border-radius: 2px;
                                    position: relative;
                                    overflow: hidden;
                                    box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
                                ">
                                    <div style="
                                        position: absolute;
                                        top: 0;
                                        left: -100%;
                                        width: 100%;
                                        height: 100%;
                                        background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.8), transparent);
                                        animation: shimmer 2s infinite;
                                    "></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // å‰µå»ºæ‡¸æµ®å°èˆªå™¨
                const floatingNavigator = document.createElement('div');
                floatingNavigator.className = 'floating-navigator';
                floatingNavigator.innerHTML = `
                    <div class="nav-item active" data-tab="student-attendance">
                        <i class="fas fa-user-graduate icon"></i>
                        <span class="text">å­¸ç”Ÿç°½åˆ°</span>
                    </div>
                    <div class="nav-item" data-tab="teacher-attendance">
                        <i class="fas fa-chalkboard-teacher icon"></i>
                        <span class="text">è¬›å¸«ç°½åˆ°</span>
                    </div>
                `;

                document.body.appendChild(modal);
                document.body.appendChild(floatingNavigator);
                currentAttendanceModal = modal;
                isModalLoading = true;

                // æ·»åŠ å°èˆªå™¨é»æ“Šäº‹ä»¶
                const navItems = floatingNavigator.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰æ´»å‹•ç‹€æ…‹
                        navItems.forEach(nav => nav.classList.remove('active'));
                        // æ·»åŠ ç•¶å‰æ´»å‹•ç‹€æ…‹
                        this.classList.add('active');
                        
                        const tab = this.dataset.tab;
                        console.log('ğŸ”„ åˆ‡æ›åˆ°æ¨™ç±¤:', tab);
                        
                        if (tab === 'teacher-attendance') {
                            // é¡¯ç¤ºè¬›å¸«ç°½åˆ°å…§å®¹
                            console.log('ğŸ”„ åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°ï¼Œåœæ­¢å­¸ç”Ÿè³‡æ–™è¼‰å…¥');
                            isStudentListLoading = false;
                            if (studentListLoadPromise) {
                                studentListLoadPromise = null;
                            }
                            showTeacherAttendance();
                        } else {
                            // é¡¯ç¤ºå­¸ç”Ÿç°½åˆ°å…§å®¹
                            showStudentAttendance();
                        }
                    });
                });
                
                // è¨­ç½®é—œé–‰æŒ‰éˆ•èª²ç¨‹
                const closeBtn = document.getElementById('closeAttendanceModal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        console.log('âŒ ç”¨æˆ¶é»æ“Šé—œé–‰æŒ‰éˆ•ï¼Œå–æ¶ˆè¼‰å…¥');
                        closeAttendanceModal();
                    });
                }
                
                // é»æ“ŠèƒŒæ™¯é—œé–‰ï¼ˆä½†ä¸åœ¨è‡ªå‹•æäº¤æ™‚é—œé–‰ï¼‰
                modal.addEventListener('click', function(e) {
                    // æª¢æŸ¥æ˜¯å¦é»æ“Šçš„æ˜¯èƒŒæ™¯ï¼ˆä¸æ˜¯æ¨¡æ…‹æ¡†å…§å®¹ï¼‰
                    if (e.target === modal || e.target.classList.contains('attendance-modal-content')) {
                        // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è‡ªå‹•æäº¤å€’æ•¸
                        if (isAutoSubmitEnabled || window.isAutoSubmitEnabled) {
                            console.log('â° æ­£åœ¨è‡ªå‹•æäº¤å€’æ•¸ä¸­ï¼Œåœæ­¢å€’æ•¸ä½†ä¸é—œé–‰æ¨¡æ…‹æ¡†');
                            stopAutoSubmitCountdown();
                            return;
                        }
                        console.log('âŒ ç”¨æˆ¶é»æ“ŠèƒŒæ™¯ï¼Œå–æ¶ˆè¼‰å…¥');
                        closeAttendanceModal();
                    }
                });
                
                // è¼‰å…¥å­¸ç”Ÿåå–®ï¼ˆåœ¨å¾Œå°åŸ·è¡Œï¼Œä¸é˜»å¡UIï¼‰
                loadCourseStudents(teacher, course, time, start, end, minutesUntilStart).then(() => {
                    console.log('âœ… å­¸ç”Ÿè³‡æ–™è¼‰å…¥å®Œæˆ');
                    // è¼‰å…¥å®Œæˆï¼Œæ›´æ–°ç‹€æ…‹
                    isModalLoading = false;
                }).catch(error => {
                    console.log('ğŸ“š å­¸ç”Ÿè³‡æ–™è¼‰å…¥å¤±æ•—ï¼ˆå¾Œå°ï¼‰:', error);
                    // è¼‰å…¥å¤±æ•—ï¼Œä¹Ÿè¦æ›´æ–°ç‹€æ…‹
                    isModalLoading = false;
                });
                
            } catch (error) {
                console.error('âŒ é–‹å•Ÿç°½åˆ°ç³»çµ±å¤±æ•—:', error);
                alert('é–‹å•Ÿç°½åˆ°ç³»çµ±å¤±æ•—: ' + error.message);
            }
        }

        // è¼‰å…¥èª²ç¨‹å­¸ç”Ÿ - å„ªåŒ–ç‰ˆæœ¬
        async function loadCourseStudents(teacher, course, time, start, end, minutesUntilStart = null, retryCount = 0) {
            // å®šç¾©é‡è©¦å’Œè¶…æ™‚è®Šæ•¸
            const maxRetries = 3;
            let loadingTimeout = null;
            const loadStartTime = performance.now();
            
            try {
                console.log('ğŸ“š è¼‰å…¥èª²ç¨‹å­¸ç”Ÿ (å„ªåŒ–ç‰ˆ):', { teacher, course, time, start, end, retryCount });
                
                // è¨˜éŒ„è¼‰å…¥å˜—è©¦
                if (window.PerformanceOptimizer) {
                    window.PerformanceOptimizer.recordAttendanceLoad(false, 0); // å…ˆè¨˜éŒ„å˜—è©¦
                }
                
                // è¨­ç½®å­¸ç”Ÿåå–®è¼‰å…¥ç‹€æ…‹
                isStudentListLoading = true;
                studentListLoadPromise = null;
                
                // æª¢æŸ¥æ¨¡æ…‹æ¡†æ˜¯å¦ä»ç„¶å­˜åœ¨
                if (!currentAttendanceModal || !isModalLoading) {
                    console.log('âŒ æ¨¡æ…‹æ¡†å·²è¢«é—œé–‰ï¼Œå–æ¶ˆè¼‰å…¥');
                    isStudentListLoading = false;
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°æ¨¡å¼
                const floatingNavigator = document.querySelector('.floating-navigator');
                const activeTab = floatingNavigator ? floatingNavigator.querySelector('.nav-item.active') : null;
                if (activeTab && activeTab.dataset.tab === 'teacher-attendance') {
                    console.log('ğŸ”„ å·²åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°æ¨¡å¼ï¼Œå–æ¶ˆå­¸ç”Ÿè³‡æ–™è¼‰å…¥');
                    isStudentListLoading = false;
                    return;
                }
                
                // é¡¯ç¤ºå„ªåŒ–çš„è¼‰å…¥å‹•ç•«
                showOptimizedLoadingAnimation();
                
                // ä½¿ç”¨å„ªåŒ–çš„APIè«‹æ±‚
                const result = await apiOptimizer.fetchWithRetry('/api/proxy/google-sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'getRosterAttendance',
                        course: course,
                        period: time
                    })
                }, 3); // å¢åŠ é‡è©¦æ¬¡æ•¸åˆ°3æ¬¡
                
                const data = result.data;
                const fromCache = result.fromCache;
                
                console.log('ğŸ“Š å­¸ç”Ÿè³‡æ–™å›æ‡‰:', { data, fromCache });
                
                // æª¢æŸ¥APIå›æ‡‰æ˜¯å¦æˆåŠŸ
                if (!data.success) {
                    console.log('âŒ APIå›æ‡‰å¤±æ•—:', data.message || 'æœªçŸ¥éŒ¯èª¤');
                    
                    // å¦‚æœæ˜¯è«‹æ±‚è¢«ä¸­æ–·ï¼Œå˜—è©¦é‡è©¦
                    if (data.error === 'REQUEST_ABORTED') {
                        console.log('ğŸ”„ è«‹æ±‚è¢«ä¸­æ–·ï¼Œå˜—è©¦é‡è©¦...');
                        throw new Error('è«‹æ±‚è¢«ä¸­æ–·ï¼Œéœ€è¦é‡è©¦');
                    }
                    
                    // å…¶ä»–éŒ¯èª¤ï¼Œç›´æ¥è·³åˆ°è¬›å¸«ç°½åˆ°
                    console.log('ğŸ“š APIå¤±æ•—ï¼Œç›´æ¥è·³åˆ°è¬›å¸«ç°½åˆ°é é¢');
                    
                    // è¼‰å…¥å®Œæˆï¼Œæ›´æ–°ç‹€æ…‹
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    // éš±è—è¼‰å…¥å‹•ç•«
                    hideOptimizedLoadingAnimation();
                    
                    // ç›´æ¥åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°é é¢
                    const teacherTab = document.querySelector('[data-tab="teacher-attendance"]');
                    if (teacherTab) {
                        teacherTab.click();
                    }
                    
                    // è¨­ç½®ç‚ºæ²’æœ‰å­¸ç”Ÿè³‡æ–™çš„ç‹€æ…‹
                    window.loadedStudentsData = null;
                    
                    return;
                }
                
                // å¦‚æœ API è¿”å›ç©ºå­¸ç”Ÿåˆ—è¡¨ï¼Œç›´æ¥è·³åˆ°è¬›å¸«ç°½åˆ°
                if (data.success && (!data.students || data.students.length === 0)) {
                    console.log('ğŸ“š API è¿”å›ç©ºå­¸ç”Ÿåˆ—è¡¨ï¼Œç›´æ¥è·³åˆ°è¬›å¸«ç°½åˆ°é é¢');
                    
                    // è¼‰å…¥å®Œæˆï¼Œæ›´æ–°ç‹€æ…‹
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    // éš±è—è¼‰å…¥å‹•ç•«
                    hideOptimizedLoadingAnimation();
                    
                    // ç›´æ¥åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°é é¢
                    const teacherTab = document.querySelector('[data-tab="teacher-attendance"]');
                    if (teacherTab) {
                        teacherTab.click();
                    }
                    
                    // è¨­ç½®ç‚ºæ²’æœ‰å­¸ç”Ÿè³‡æ–™çš„ç‹€æ…‹
                    window.loadedStudentsData = null;
                    
                    return;
                }
                
                // å†æ¬¡æª¢æŸ¥æ¨¡æ…‹æ¡†æ˜¯å¦ä»ç„¶å­˜åœ¨
                if (!currentAttendanceModal) {
                    console.log('âŒ æ¨¡æ…‹æ¡†å·²è¢«é—œé–‰ï¼Œå–æ¶ˆè™•ç†å­¸ç”Ÿè³‡æ–™');
                    // æ¸…ç†ç‹€æ…‹
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    hideOptimizedLoadingAnimation();
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°æ¨¡å¼
                const floatingNavigatorCheck = document.querySelector('.floating-navigator');
                const activeTabCheck = floatingNavigatorCheck ? floatingNavigatorCheck.querySelector('.nav-item.active') : null;
                if (activeTabCheck && activeTabCheck.dataset.tab === 'teacher-attendance') {
                    console.log('ğŸ”„ å·²åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°æ¨¡å¼ï¼Œå–æ¶ˆå­¸ç”Ÿè³‡æ–™è™•ç†');
                    // æ¸…ç†ç‹€æ…‹
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    hideOptimizedLoadingAnimation();
                    return;
                }
                
                if (data.success && data.students) {
                    console.log('ğŸ” å­¸ç”Ÿæ•¸æ“šçµæ§‹æª¢æŸ¥:', data.students.map(s => ({
                        name: s.name,
                        id: s.id,
                        studentId: s.studentId,
                        student_id: s.student_id,
                        key: s.key,
                        present: s.present,
                        absent: s.absent,
                        late: s.late,
                        unmarked: s.unmarked,
                        attendance: s.attendance,
                        attendance_history: s.attendance_history,
                        allKeys: Object.keys(s)
                    })));
                    
                    // æª¢æŸ¥å‡ºç¼ºå‹¤è³‡æ–™
                    console.log('ğŸ“Š å‡ºç¼ºå‹¤è³‡æ–™æª¢æŸ¥:', data.students.map(s => ({
                        name: s.name,
                        present: s.present || s.attendance?.present || 0,
                        absent: s.absent || s.attendance?.absent || 0,
                        late: s.late || s.attendance?.late || 0,
                        unmarked: s.unmarked || s.attendance?.unmarked || 0,
                        hasHistory: !!(s.attendance_history && s.attendance_history.length > 0),
                        historyCount: s.attendance_history ? s.attendance_history.length : 0
                    })));
                    
                    // è¼‰å…¥å®Œæˆï¼Œæ›´æ–°ç‹€æ…‹
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    // éš±è—è¼‰å…¥å‹•ç•«
                    hideOptimizedLoadingAnimation();
                    
                    console.log('ğŸ¯ æº–å‚™èª¿ç”¨ displayStudents å‡½æ•¸');
                    displayStudents(data.students, teacher, course, time, start, end, minutesUntilStart);
                    console.log('âœ… displayStudents å‡½æ•¸èª¿ç”¨å®Œæˆ');
                    
                    // è¨˜éŒ„æˆåŠŸçš„è¼‰å…¥
                    const loadEndTime = performance.now();
                    const loadTime = loadEndTime - loadStartTime;
                    if (window.PerformanceOptimizer) {
                        window.PerformanceOptimizer.recordAttendanceLoad(true, loadTime);
                    }
                } else {
                    // è¼‰å…¥å¤±æ•—ï¼Œæ›´æ–°ç‹€æ…‹
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    
                    // éš±è—è¼‰å…¥å‹•ç•«
                    hideOptimizedLoadingAnimation();
                    
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°æ¨¡å¼
                    const floatingNavigator = document.querySelector('.floating-navigator');
                    const activeTab = floatingNavigator ? floatingNavigator.querySelector('.nav-item.active') : null;
                    if (activeTab && activeTab.dataset.tab === 'teacher-attendance') {
                        console.log('ğŸ”„ å·²åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°æ¨¡å¼ï¼Œä¸é¡¯ç¤ºå­¸ç”Ÿè¼‰å…¥éŒ¯èª¤');
                        return;
                    }
                    
                    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œæä¾›æ›´å¤šé¸é …
                    console.error('âŒ ç„¡æ³•è¼‰å…¥å­¸ç”Ÿè³‡æ–™:', data);
                    const attendanceContent = document.getElementById('attendanceContent');
                    if (attendanceContent) {
                        attendanceContent.innerHTML = `
                            <div style="text-align: center; padding: 60px 40px; color: rgba(255, 255, 255, 0.8);">
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    border: 4px solid rgba(220, 53, 69, 0.3);
                                    border-top: 4px solid #dc3545;
                                    border-radius: 50%;
                                    animation: spin 1s linear infinite;
                                    margin: 0 auto 20px;
                                    box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
                                "></div>
                                <h3 style="margin: 0; color: rgba(255, 255, 255, 0.95); text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);">
                                    <i class="fas fa-exclamation-triangle" style="color: #dc3545; margin-right: 8px;"></i>
                                    ç„¡æ³•è¼‰å…¥å­¸ç”Ÿè³‡æ–™
                                </h3>
                                <p style="margin: 10px 0; color: rgba(255, 255, 255, 0.7);">
                                    æ­¤èª²ç¨‹å¯èƒ½æ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œæˆ–èª²ç¨‹è³‡è¨Šä¸æ­£ç¢º
                                </p>
                                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                                    <button id="error-teacher-btn" style="
                                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(59, 130, 246, 0.6));
                                        color: white;
                                        border: 1px solid rgba(59, 130, 246, 0.5);
                                        padding: 12px 24px;
                                        border-radius: 20px;
                                        cursor: pointer;
                                        font-weight: 600;
                                        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(59, 130, 246, 0.3)'">
                                        <i class="fas fa-chalkboard-teacher" style="margin-right: 8px;"></i> è¬›å¸«ç°½åˆ°
                                    </button>
                                    <button id="error-reload-btn" style="
                                        background: linear-gradient(135deg, rgba(255, 215, 0, 0.8), rgba(255, 215, 0, 0.6));
                                        color: rgba(0, 0, 0, 0.8);
                                        border: 1px solid rgba(255, 215, 0, 0.5);
                                        padding: 12px 24px;
                                        border-radius: 20px;
                                        cursor: pointer;
                                        font-weight: 600;
                                        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 215, 0, 0.3)'">
                                        <i class="fas fa-redo" style="margin-right: 8px;"></i> é‡æ–°è¼‰å…¥
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // æ¸…é™¤è¼‰å…¥è¶…æ™‚è¨ˆæ™‚å™¨
                clearTimeout(loadingTimeout);
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥å­¸ç”Ÿå¤±æ•—:', error);
                
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°æ¨¡å¼
                const floatingNavigatorError = document.querySelector('.floating-navigator');
                const activeTabError = floatingNavigatorError ? floatingNavigatorError.querySelector('.nav-item.active') : null;
                if (activeTabError && activeTabError.dataset.tab === 'teacher-attendance') {
                    console.log('ğŸ”„ å·²åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°æ¨¡å¼ï¼Œä¸é¡¯ç¤ºå­¸ç”Ÿè¼‰å…¥éŒ¯èª¤');
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    clearTimeout(loadingTimeout);
                    return;
                }
                
                // æª¢æŸ¥éŒ¯èª¤é¡å‹æ±ºå®šæ˜¯å¦é‡è©¦
                const shouldRetry = error.message.includes('è«‹æ±‚è¢«ä¸­æ–·') || 
                                 error.message.includes('ç¶²è·¯é€£æ¥éŒ¯èª¤') ||
                                 error.name === 'AbortError';
                
                // æª¢æŸ¥æ˜¯å¦é‚„æœ‰é‡è©¦æ¬¡æ•¸
                if (shouldRetry && retryCount < maxRetries) {
                    console.log(`ğŸ”„ è‡ªå‹•é‡è©¦è¼‰å…¥å­¸ç”Ÿè³‡æ–™ (${retryCount + 1}/${maxRetries})`);
                    
                    // æ›´æ–°ç‹€æ…‹
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    clearTimeout(loadingTimeout);
                    
                    // å»¶é²å¾Œé‡è©¦ï¼Œä½¿ç”¨æŒ‡æ•¸é€€é¿
                    const delay = Math.min(1000 * Math.pow(2, retryCount), 10000); // æœ€å¤š10ç§’
                    setTimeout(() => {
                        loadCourseStudents(teacher, course, time, start, end, minutesUntilStart, retryCount + 1);
                    }, delay);
                    
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºã€Œæ‰¾ä¸åˆ°èª²ç¨‹ã€çš„éŒ¯èª¤
                if (error.message.includes('æ‰¾ä¸åˆ°èª²ç¨‹') || error.message.includes('æ‰¾ä¸åˆ°è©²å ‚èª²ç¨‹')) {
                    console.log('ğŸ“š æ‰¾ä¸åˆ°èª²ç¨‹ï¼Œç›´æ¥è·³åˆ°è¬›å¸«ç°½åˆ°é é¢');
                    
                    // è¼‰å…¥å¤±æ•—ï¼Œæ›´æ–°ç‹€æ…‹
                    isStudentListLoading = false;
                    studentListLoadPromise = null;
                    clearTimeout(loadingTimeout);
                    
                    // ç›´æ¥åˆ‡æ›åˆ°è¬›å¸«ç°½åˆ°é é¢
                    const teacherTab = document.querySelector('[data-tab="teacher-attendance"]');
                    if (teacherTab) {
                        teacherTab.click();
                    }
                    
                    // è¨­ç½®ç‚ºæ²’æœ‰å­¸ç”Ÿè³‡æ–™çš„ç‹€æ…‹ï¼Œé¡¯ç¤ºäººæ•¸é¸æ“‡
                    window.loadedStudentsData = null;
                    
                    return;
                }
                
                // ä½¿ç”¨éŒ¯èª¤è™•ç†å™¨é¡¯ç¤ºéŒ¯èª¤
                errorHandler.showError('è¼‰å…¥å­¸ç”Ÿåå–®å¤±æ•—: ' + error.message, error);
                
                // è¼‰å…¥å¤±æ•—ï¼Œæ›´æ–°ç‹€æ…‹
                isStudentListLoading = false;
                studentListLoadPromise = null;
                
                // æ¸…é™¤è¼‰å…¥è¶…æ™‚è¨ˆæ™‚å™¨
                clearTimeout(loadingTimeout);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œæä¾›æ›´å¤šé¸é …
                const attendanceContent = document.getElementById('attendanceContent');
                if (attendanceContent) {
                    attendanceContent.innerHTML = `
                        <div style="text-align: center; padding: 60px 40px; color: rgba(255, 255, 255, 0.8);">
                            <div style="
                                width: 60px;
                                height: 60px;
                                border: 4px solid rgba(220, 53, 69, 0.3);
                                border-top: 4px solid #dc3545;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin: 0 auto 20px;
                                box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
                            "></div>
                            <h3 style="margin: 0; color: rgba(255, 255, 255, 0.95); text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);">
                                <i class="fas fa-exclamation-triangle" style="color: #dc3545; margin-right: 8px;"></i>
                                è¼‰å…¥å­¸ç”Ÿè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤
                            </h3>
                            <p style="margin: 10px 0; color: rgba(255, 255, 255, 0.7);">
                                éŒ¯èª¤è¨Šæ¯: ${error.message}
                            </p>
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                                <button id="error-teacher-btn-2" style="
                                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(59, 130, 246, 0.6));
                                    color: white;
                                    border: 1px solid rgba(59, 130, 246, 0.5);
                                    padding: 12px 24px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(59, 130, 246, 0.3)'">
                                    <i class="fas fa-chalkboard-teacher" style="margin-right: 8px;"></i> è¬›å¸«ç°½åˆ°
                                </button>
                                <button id="error-reload-btn-2" style="
                                    background: linear-gradient(135deg, rgba(255, 215, 0, 0.8), rgba(255, 215, 0, 0.6));
                                    color: rgba(0, 0, 0, 0.8);
                                    border: 1px solid rgba(255, 215, 0, 0.5);
                                    padding: 12px 24px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 215, 0, 0.3)'">
                                    <i class="fas fa-redo" style="margin-right: 8px;"></i> é‡æ–°è¼‰å…¥
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // é¡¯ç¤ºå­¸ç”Ÿåˆ—è¡¨
        function displayStudents(students, teacher, course, time, start, end, minutesUntilStart = null) {
            console.log('ğŸ¯ displayStudents å‡½æ•¸é–‹å§‹åŸ·è¡Œ');
            const attendanceContent = document.getElementById('attendanceContent');
            if (!attendanceContent) {
                console.log('âŒ æ‰¾ä¸åˆ° attendanceContent å…ƒç´ ');
                return;
            }
            console.log('âœ… æ‰¾åˆ° attendanceContent å…ƒç´ ');
            
            // è™•ç†å‡ºç¼ºå‹¤è¨˜éŒ„
            const attendanceRecords = {};
            students.forEach(student => {
                const studentId = student.id || student.student_id || student.name;
                if (studentId) {
                    attendanceRecords[studentId] = {
                        present: student.present || student.attendance?.present || 0,
                        absent: student.absent || student.attendance?.absent || 0,
                        late: student.late || student.attendance?.late || 0,
                        unmarked: student.unmarked || student.attendance?.unmarked || 0,
                        history: student.attendance_history || student.records || [],
                        stats: student.stats || {}
                    };
                }
            });
            
            // ä¿å­˜å­¸ç”Ÿè³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾›å¾ŒçºŒä½¿ç”¨
            window.loadedStudentsData = {
                students: students,
                teacher: teacher,
                course: course,
                time: time,
                start: start,
                end: end,
                minutesUntilStart: minutesUntilStart,
                attendanceRecords: attendanceRecords,
                date: new Date().toISOString().split('T')[0]
            };
            
            console.log('ğŸ’¾ å·²ä¿å­˜å‡ºç¼ºå‹¤è¨˜éŒ„:', attendanceRecords);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿï¼Œå¦‚æœæ²’æœ‰å­¸ç”Ÿç›´æ¥é¡¯ç¤ºè¬›å¸«ç°½åˆ°
            if (!students || students.length === 0) {
                console.log('ğŸ“ èª²ç¨‹æ²’æœ‰å­¸ç”Ÿï¼Œç›´æ¥é¡¯ç¤ºè¬›å¸«ç°½åˆ°');
                showTeacherAttendance();
                return;
            }
            
            // æ·»åŠ è¼‰å…¥å®Œæˆçš„éæ¸¡æ•ˆæœ
            attendanceContent.style.background = 'transparent';
            attendanceContent.style.transition = 'all 0.5s ease';
            
            // é‡æ–°è¨­ç½®é—œé–‰æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨ï¼ˆå› ç‚ºå…§å®¹è¢«é‡æ–°ç”Ÿæˆï¼‰
            const closeBtn = document.getElementById('closeAttendanceModal');
            if (closeBtn) {
                // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
                closeBtn.replaceWith(closeBtn.cloneNode(true));
                // é‡æ–°ç²å–æŒ‰éˆ•ä¸¦æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const newCloseBtn = document.getElementById('closeAttendanceModal');
                if (newCloseBtn) {
                    newCloseBtn.addEventListener('click', function() {
                        console.log('âŒ ç”¨æˆ¶é»æ“Šé—œé–‰æŒ‰éˆ•ï¼ˆå­¸ç”Ÿè¼‰å…¥å¾Œï¼‰');
                        closeAttendanceModal();
                    });
                }
            }
            
            // ä½¿ç”¨èª²ç¨‹çš„å¯¦éš›æ—¥æœŸè€Œä¸æ˜¯ç•¶å‰æ—¥æœŸ
            const courseDate = new Date(start).toISOString().split('T')[0];
            console.log('ğŸ“… èª²ç¨‹æ—¥æœŸ:', courseDate, 'ç•¶å‰æ—¥æœŸ:', new Date().toISOString().split('T')[0]);
            
            // æ·»åŠ æ™‚é–“é™åˆ¶æç¤º
            let timeRestrictionMessage = '';
            if (minutesUntilStart !== null && minutesUntilStart > 10) {
                timeRestrictionMessage = `
                    <div style="
                        background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 193, 7, 0.1));
                        border: 1px solid rgba(255, 193, 7, 0.4);
                        border-radius: 15px;
                        padding: 10px;
                        margin-bottom: 20px;
                        text-align: center;
                        color: #856404;
                        font-weight: 600;
                    ">
                        <i class="fas fa-info-circle" style="margin-right: 8px; color: #ffc107;"></i>
                        èª²ç¨‹é–‹å§‹å‰10åˆ†é˜æ‰èƒ½é€²è¡Œç°½åˆ°ï¼Œç›®å‰åªèƒ½æŸ¥çœ‹å­¸ç”Ÿåå–®
                    </div>
                `;
            }
            
            const studentsHtml = students.map((student, index) => {
                // ç¢ºä¿å­¸ç”Ÿæœ‰IDï¼Œå„ªå…ˆä½¿ç”¨å§“åï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ç´¢å¼•
                const studentId = student.name || student.id || student.studentId || student.student_id || student.key || `student_${index}`;
                console.log(`ğŸ” å­¸ç”Ÿ ${index + 1} ID è™•ç†:`, {
                    originalId: student.id,
                    studentId: student.studentId,
                    student_id: student.student_id,
                    key: student.key,
                    name: student.name,
                    finalId: studentId,
                    allKeys: Object.keys(student)
                });
                
                // æª¢æŸ¥èª²ç¨‹æ—¥æœŸçš„ç°½åˆ°ç‹€æ…‹
                const courseDateAttendance = student.attendance.find(record => record.date === courseDate);
                let currentStatus = null;
                let statusText = '';
                
                if (courseDateAttendance) {
                    if (courseDateAttendance.present === true) {
                        currentStatus = 'present';
                        statusText = 'âœ… å·²å‡ºå¸­';
                    } else if (courseDateAttendance.present === false) {
                        currentStatus = 'absent';
                        statusText = 'âŒ å·²ç¼ºå¸­';
                    } else if (courseDateAttendance.present === 'leave') {
                        currentStatus = 'leave';
                        statusText = 'âš ï¸ å·²è«‹å‡';
                    }
                } else {
                    currentStatus = 'pending';
                    statusText = 'â° å¾…ç°½åˆ°';
                }
                
                // æ ¹æ“šç‹€æ…‹è¨­å®šæ¨£å¼
                let statusStyles = {
                    border: '#e9ecef',
                    background: 'white',
                    icon: 'fas fa-clock',
                    iconColor: '#6c757d',
                    statusColor: '#6c757d'
                };
                
                if (currentStatus === 'present') {
                    statusStyles = {
                        border: '#28a745',
                        background: 'linear-gradient(135deg, rgba(40, 167, 69, 0.25), rgba(32, 201, 151, 0.2))',
                        icon: 'fas fa-check-circle',
                        iconColor: '#28a745',
                        statusColor: '#28a745',
                        emoji: 'âœ…'
                    };
                } else if (currentStatus === 'absent') {
                    statusStyles = {
                        border: '#dc3545',
                        background: 'linear-gradient(135deg, rgba(220, 53, 69, 0.25), rgba(231, 76, 60, 0.2))',
                        icon: 'fas fa-times-circle',
                        iconColor: '#dc3545',
                        statusColor: '#dc3545',
                        emoji: 'âŒ'
                    };
                } else if (currentStatus === 'leave') {
                    statusStyles = {
                        border: '#ffc107',
                        background: 'linear-gradient(135deg, rgba(255, 193, 7, 0.25), rgba(243, 156, 18, 0.2))',
                        icon: 'fas fa-exclamation-triangle',
                        iconColor: '#ffc107',
                        statusColor: '#ffc107',
                        emoji: 'âš ï¸'
                    };
                } else if (currentStatus === 'pending') {
                    statusStyles = {
                        border: '#6c757d',
                        background: 'linear-gradient(135deg, rgba(108, 117, 125, 0.2), rgba(73, 80, 87, 0.15))',
                        icon: 'fas fa-clock',
                        iconColor: '#6c757d',
                        statusColor: '#6c757d',
                        emoji: 'â°'
                    };
                }
                
                return `
                    <div class="student-card student-item attendance-student-item ${currentStatus ? currentStatus : ''}" data-student-id="${studentId}" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 16px;
                        border: 1px solid ${statusStyles.border};
                        border-radius: 12px;
                        background: ${statusStyles.background};
                        backdrop-filter: blur(25px);
                        -webkit-backdrop-filter: blur(25px);
                        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        position: relative;
                        overflow: hidden;
                        box-shadow: 
                            0 4px 20px rgba(0, 0, 0, 0.08),
                            inset 0 1px 0 rgba(255, 255, 255, 0.9);
                        transform-style: preserve-3d;
                        perspective: 1000px;
                        min-height: 60px;
                        margin-bottom: 3px;
                        animation: cardSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                    ">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <div style="
                                width: 28px;
                                height: 28px;
                                border-radius: 50%;
                                background: linear-gradient(135deg, #b8860b, #daa520);
                                color: rgba(0, 0, 0, 0.8);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                font-size: 0.8rem;
                                box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
                                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            ">
                                ${student.name.charAt(0)}
                            </div>
                            <div style="flex: 1;">
                                <div class="student-name" style="font-weight: 600; color: rgba(0, 0, 0, 0.9); font-size: 0.85rem; margin-bottom: 4px;">${student.name}</div>
                                <!-- å‡ºç¼ºå‹¤æ¬¡æ•¸çµ±è¨ˆ -->
                                ${(() => {
                                    const attendanceData = getStudentAttendanceData(student);
                                    return `
                                        <!-- æ¡Œé¢ç«¯å‡ºç¼ºå‹¤æ¬¡æ•¸é¡¯ç¤º -->
                                        <div class="attendance-stats-desktop" style="display: flex; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                                            <span style="color: #28a745; font-size: 0.65rem; font-weight: 600;">
                                                <i class="fas fa-check-circle"></i> ${attendanceData.present}æ¬¡
                                            </span>
                                            <span style="color: #dc3545; font-size: 0.65rem; font-weight: 600;">
                                                <i class="fas fa-times-circle"></i> ${attendanceData.absent}æ¬¡
                                            </span>
                                            <span style="color: #ffc107; font-size: 0.65rem; font-weight: 600;">
                                                <i class="fas fa-clock"></i> ${attendanceData.late}æ¬¡
                                            </span>
                                            <span style="color: #6c757d; font-size: 0.65rem; font-weight: 600;">
                                                <i class="fas fa-question-circle"></i> ${attendanceData.unmarked}æ¬¡
                                            </span>
                                        </div>
                                        
                                        <!-- æ‰‹æ©Ÿç«¯å‡ºç¼ºå‹¤æ¬¡æ•¸é¡¯ç¤º -->
                                        <div class="attendance-stats-mobile" style="display: none;">
                                            <div class="attendance-stats-row">
                                                <div class="attendance-stat-item present">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span>å‡ºå¸­ ${attendanceData.present}æ¬¡</span>
                                                </div>
                                                <div class="attendance-stat-item absent">
                                                    <i class="fas fa-times-circle"></i>
                                                    <span>ç¼ºå¸­ ${attendanceData.absent}æ¬¡</span>
                                                </div>
                                            </div>
                                            <div class="attendance-stats-row">
                                                <div class="attendance-stat-item late">
                                                    <i class="fas fa-clock"></i>
                                                    <span>é²åˆ° ${attendanceData.late}æ¬¡</span>
                                                </div>
                                                <div class="attendance-stat-item unmarked">
                                                    <i class="fas fa-question-circle"></i>
                                                    <span>æœªæ¨™è¨˜ ${attendanceData.unmarked}æ¬¡</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                })()}
                                <!-- ç‹€æ…‹æ¨™ç±¤ - åå­—ä¸‹æ–¹ -->
                                <div class="status-tag" style="
                                    background: ${statusStyles.statusColor};
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 8px;
                                    font-size: 0.65rem;
                                    font-weight: 600;
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 3px;
                                    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
                                ">
                                    <span style="font-size: 0.7rem;">${statusStyles.emoji}</span>
                                    <span>${statusText}</span>
                                </div>
                                ${student.id ? `<div style="color: rgba(0, 0, 0, 0.6); font-size: 0.7rem; margin-top: 2px;">${student.id}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; flex-wrap: nowrap; min-width: 0;">
                            <button class="attendance-btn present-btn liquid-button" data-student-id="${studentId}" 
                                data-minutes-until-start="${minutesUntilStart}"
                                data-disabled="${minutesUntilStart !== null && minutesUntilStart > 10}"
                                data-is-disabled="${minutesUntilStart !== null && minutesUntilStart > 10}"
                                style="
                                background: ${currentStatus === 'present' 
                                    ? 'linear-gradient(135deg, rgba(40, 167, 69, 1), rgba(32, 201, 151, 0.9))' 
                                    : minutesUntilStart !== null && minutesUntilStart > 10
                                        ? 'linear-gradient(135deg, rgba(108, 117, 125, 0.3), rgba(108, 117, 125, 0.2))'
                                        : 'linear-gradient(135deg, rgba(40, 167, 69, 0.6), rgba(32, 201, 151, 0.5))'};
                                color: ${minutesUntilStart !== null && minutesUntilStart > 10 ? 'rgba(0, 0, 0, 0.4)' : 'white'};
                                border: 1px solid ${currentStatus === 'present' ? 'rgba(40, 167, 69, 0.8)' : minutesUntilStart !== null && minutesUntilStart > 10 ? 'rgba(108, 117, 125, 0.3)' : 'rgba(255, 255, 255, 0.4)'};
                                padding: 6px 12px;
                                border-radius: 15px;
                                cursor: ${minutesUntilStart !== null && minutesUntilStart > 10 ? 'not-allowed' : 'pointer'};
                                font-size: 0.75rem;
                                font-weight: 600;
                                transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                opacity: 1;
                                position: relative;
                                overflow: hidden;
                                backdrop-filter: blur(15px);
                                -webkit-backdrop-filter: blur(15px);
                                box-shadow: ${currentStatus === 'present' 
                                    ? '0 6px 20px rgba(40, 167, 69, 0.5)' 
                                    : '0 3px 12px rgba(40, 167, 69, 0.3)'};
                                transform: ${currentStatus === 'present' ? 'scale(1.05)' : 'scale(1)'};
                                white-space: nowrap;
                                flex-shrink: 0;
                                pointer-events: ${minutesUntilStart !== null && minutesUntilStart > 10 ? 'none' : 'auto'};
                                disabled: ${minutesUntilStart !== null && minutesUntilStart > 10};
                            ">
                                <span style="margin-right: 4px; font-size: 0.8rem;">âœ…</span> å‡ºå¸­
                            </button>
                            <button class="attendance-btn absent-btn liquid-button" data-student-id="${studentId}" 
                                data-minutes-until-start="${minutesUntilStart}"
                                data-disabled="${minutesUntilStart !== null && minutesUntilStart > 10}"
                                data-is-disabled="${minutesUntilStart !== null && minutesUntilStart > 10}"
                                style="
                                background: ${currentStatus === 'absent' 
                                    ? 'linear-gradient(135deg, rgba(220, 53, 69, 1), rgba(231, 76, 60, 0.9))' 
                                    : minutesUntilStart !== null && minutesUntilStart > 10
                                        ? 'linear-gradient(135deg, rgba(108, 117, 125, 0.3), rgba(108, 117, 125, 0.2))'
                                        : 'linear-gradient(135deg, rgba(220, 53, 69, 0.6), rgba(231, 76, 60, 0.5))'};
                                color: ${minutesUntilStart !== null && minutesUntilStart > 10 ? 'rgba(0, 0, 0, 0.4)' : 'white'};
                                border: 1px solid ${currentStatus === 'absent' ? 'rgba(220, 53, 69, 0.8)' : minutesUntilStart !== null && minutesUntilStart > 10 ? 'rgba(108, 117, 125, 0.3)' : 'rgba(255, 255, 255, 0.4)'};
                                padding: 6px 12px;
                                border-radius: 15px;
                                cursor: ${minutesUntilStart !== null && minutesUntilStart > 10 ? 'not-allowed' : 'pointer'};
                                font-size: 0.75rem;
                                font-weight: 600;
                                transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                opacity: 1;
                                position: relative;
                                overflow: hidden;
                                backdrop-filter: blur(15px);
                                -webkit-backdrop-filter: blur(15px);
                                box-shadow: ${currentStatus === 'absent' 
                                    ? '0 6px 20px rgba(220, 53, 69, 0.5)' 
                                    : '0 3px 12px rgba(220, 53, 69, 0.3)'};
                                transform: ${currentStatus === 'absent' ? 'scale(1.05)' : 'scale(1)'};
                                white-space: nowrap;
                                flex-shrink: 0;
                                pointer-events: ${minutesUntilStart !== null && minutesUntilStart > 10 ? 'none' : 'auto'};
                                disabled: ${minutesUntilStart !== null && minutesUntilStart > 10};
                            ">
                                <span style="margin-right: 4px; font-size: 0.8rem;">âŒ</span> ç¼ºå¸­
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // é‡ç½®é€šçŸ¥ç‹€æ…‹
            resetAttendanceNotification();
            
            attendanceContent.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    max-height: 90vh;
                    min-height: 500px;
                    overflow-y: auto;
                    -webkit-overflow-scrolling: touch;
                ">
                    <!-- å­¸ç”Ÿåå–®æ¨™é¡Œ -->
                    <h3 style="margin: 0 0 12px 0; color: #333333; font-size: 1.1rem; text-shadow: none;">
                        <i class="fas fa-users" style="color: #b8860b; margin-right: 8px; text-shadow: 0 0 10px rgba(184, 134, 11, 0.5);"></i>
                        å­¸ç”Ÿåå–® (${students.length} äºº)
                    </h3>
                    ${timeRestrictionMessage}
                    
                    <!-- å­¸ç”Ÿåˆ—è¡¨ - æ¥çºŒåœ¨æ¨™é¡Œå¾Œé¢ -->
                    <div id="studentsList" style="
                        display: flex; 
                        flex-direction: column; 
                        gap: 8px; 
                        margin-bottom: 16px;
                        height: 500px;
                        max-height: 500px;
                        min-height: 500px;
                        overflow-y: scroll;
                        overflow-x: hidden;
                        -webkit-overflow-scrolling: touch;
                        scroll-behavior: smooth;
                        position: relative;
                        padding-right: 8px;
                        /* ç¢ºä¿æ»¾å‹•æ¢å¯è¦‹ */
                        scrollbar-width: thin;
                        scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
                        /* è¨­ç½®å›ºå®šé«˜åº¦ä»¥ç¢ºä¿æ»¾å‹• */
                        flex: 1;
                        box-sizing: border-box;
                    ">
                        ${studentsHtml}
                        <!-- é€æ˜çš„è™›æ“¬å­¸ç”Ÿå¡ç‰‡ï¼Œç”¨æ–¼å¢åŠ æ»¾å‹•é«˜åº¦ï¼ˆç¸®å°ç‰ˆï¼‰ -->
                        <div class="virtual-student-card" style="
                            height: 100px !important;
                            background: transparent;
                            border: none;
                            margin: 0;
                            padding: 0;
                            pointer-events: none;
                            opacity: 0.01;
                            visibility: visible;
                            width: 100%;
                            overflow: hidden;
                            position: relative;
                            min-height: 100px;
                            max-height: 100px;
                        "></div>
                    </div>
                    
                    <!-- çµ±è¨ˆæ¬„ä½ - æ¥çºŒåœ¨å­¸ç”Ÿåˆ—è¡¨å¾Œé¢ -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 16px;
                        background: 
                            radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.08) 0%, transparent 70%),
                            linear-gradient(135deg, 
                                rgba(255, 255, 255, 0.15) 0%, 
                                rgba(248, 249, 250, 0.1) 50%,
                                rgba(255, 255, 255, 0.15) 100%);
                        border-radius: 12px;
                        border: 1px solid rgba(255, 215, 0, 0.4);
                        backdrop-filter: blur(25px);
                        -webkit-backdrop-filter: blur(25px);
                        box-shadow: 
                            0 8px 32px rgba(0, 0, 0, 0.15),
                            inset 0 1px 0 rgba(255, 255, 255, 0.2);
                    ">
                        <div id="attendanceStats" style="font-size: 0.85rem; color: #333333; text-shadow: none;">
                            çµ±è¨ˆè¼‰å…¥ä¸­...
                        </div>
                    </div>
                </div>
            `;
            
        // è¨­ç½®èª²ç¨‹ç›£è½å™¨ï¼ˆå»¶é²åŸ·è¡Œç¢ºä¿DOMå·²æ¸²æŸ“ï¼‰
        setTimeout(() => {
            // å…ˆè¨­ç½®å­¸ç”Ÿå¡ç‰‡é›™æ“Šèª²ç¨‹ç›£è½å™¨ï¼ˆå› ç‚ºå®ƒæœƒé‡æ–°å‰µå»ºå…ƒç´ ï¼‰
            setupStudentCardDoubleClickListeners();
            
            // å†è¨­ç½®æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            setupAttendanceEventListeners(teacher, course, time, start, end);
            
            updateAttendanceStats();
        }, 100);
        }

        // è¨­ç½®ç°½åˆ°èª²ç¨‹ç›£è½å™¨
        function setupAttendanceEventListeners(teacher, course, time, start, end) {
            console.log('ğŸ”§ è¨­ç½®ç°½åˆ°äº‹ä»¶ç›£è½å™¨ï¼Œæ‰¾åˆ°æŒ‰éˆ•æ•¸é‡:', {
                presentBtns: document.querySelectorAll('.present-btn').length,
                absentBtns: document.querySelectorAll('.absent-btn').length,
                studentCards: document.querySelectorAll('.student-card').length
            });
            
            // æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.present-btn, .absent-btn').forEach((btn, index) => {
                console.log(`ğŸ” æŒ‰éˆ• ${index + 1} ç‹€æ…‹:`, {
                    studentId: btn.dataset.studentId,
                    disabled: btn.disabled,
                    dataDisabled: btn.dataset.disabled,
                    dataIsDisabled: btn.dataset.isDisabled,
                    pointerEvents: btn.style.pointerEvents,
                    className: btn.className,
                    minutesUntilStart: btn.dataset.minutesUntilStart,
                    hasDisabledAttribute: btn.hasAttribute('disabled'),
                    innerHTML: btn.innerHTML.substring(0, 50) + '...'
                });
            });
            
            // å…ˆç§»é™¤æ‰€æœ‰ç¾æœ‰çš„äº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('.present-btn').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            document.querySelectorAll('.absent-btn').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            // é‡æ–°æŸ¥è©¢æŒ‰éˆ•ï¼ˆå› ç‚º replaceWith å‰µå»ºäº†æ–°å…ƒç´ ï¼‰
            const presentBtns = document.querySelectorAll('.present-btn');
            const absentBtns = document.querySelectorAll('.absent-btn');
            
            console.log('ğŸ”„ é‡æ–°æŸ¥è©¢æŒ‰éˆ•:', {
                presentBtns: presentBtns.length,
                absentBtns: absentBtns.length
            });
            
            // å‹•æ…‹è¨­ç½®æŒ‰éˆ•çš„ disabled å±¬æ€§
            [...presentBtns, ...absentBtns].forEach(btn => {
                const minutesUntilStart = parseInt(btn.dataset.minutesUntilStart);
                const shouldDisable = minutesUntilStart !== null && minutesUntilStart > 10;
                
                console.log(`ğŸ”§ è¨­ç½®æŒ‰éˆ• disabled å±¬æ€§:`, {
                    studentId: btn.dataset.studentId,
                    minutesUntilStart: minutesUntilStart,
                    shouldDisable: shouldDisable,
                    currentDisabled: btn.disabled
                });
                
                if (shouldDisable) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
            });
            
            // å‡ºå¸­æŒ‰éˆ•
            presentBtns.forEach((btn, index) => {
                console.log(`ğŸ”§ ç¶å®šå‡ºå¸­æŒ‰éˆ• ${index + 1}:`, { 
                    studentId: btn.dataset.studentId, 
                    button: btn,
                    disabled: btn.disabled,
                    pointerEvents: btn.style.pointerEvents
                });
                
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('ğŸ¯ å‡ºå¸­æŒ‰éˆ•è¢«é»æ“Šäº†ï¼');
                    
                    const studentId = this.dataset.studentId;
                    console.log('ğŸ¯ å‡ºå¸­æŒ‰éˆ•é»æ“Š:', { studentId, button: this, disabled: this.disabled });
                    
                    // æª¢æŸ¥æŒ‰éˆ•æ˜¯å¦è¢«ç¦ç”¨
                    if (this.disabled) {
                        console.log('âš ï¸ æŒ‰éˆ•è¢«ç¦ç”¨ï¼Œç„¡æ³•é»æ“Š');
                        return;
                    }
                    
                    const studentItem = document.querySelector(`.student-card[data-student-id="${studentId}"]`);
                    console.log('ğŸ” æ‰¾åˆ°å­¸ç”Ÿå¡ç‰‡:', { studentItem, studentId });
                    
                    const studentName = studentItem ? 
                        studentItem.querySelector('.student-name')?.textContent || studentId : 
                        studentId;
                    
                    // æ·»åŠ æŒ‰éˆ•è¼‰å…¥å‹•ç•«
                    this.style.animation = 'buttonPress 0.3s ease-out';
                    this.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> è™•ç†ä¸­...';
                    this.style.pointerEvents = 'none';
                    
                    try {
                        console.log('ğŸš€ é–‹å§‹èª¿ç”¨ saveSingleAttendanceRecord API');
                        // ç«‹å³ç™¼é€å‡ºå¸­è¨˜éŒ„
                        await saveSingleAttendanceRecord(teacher, course, time, start, end, studentId, studentName, 'present');
                        console.log('âœ… saveSingleAttendanceRecord API èª¿ç”¨å®Œæˆ');
                        
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        setTimeout(() => {
                            this.innerHTML = '<span style="margin-right: 8px; font-size: 1rem;">âœ…</span> å‡ºå¸­';
                            this.style.pointerEvents = 'auto';
                            this.style.animation = '';
                        }, 1000);
                    } catch (error) {
                        console.error('âŒ å‡ºå¸­æŒ‰éˆ•è™•ç†å¤±æ•—:', error);
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        this.innerHTML = '<span style="margin-right: 8px; font-size: 1rem;">âœ…</span> å‡ºå¸­';
                        this.style.pointerEvents = 'auto';
                        this.style.animation = '';
                    }
                });
            });
            
            // ç¼ºå¸­æŒ‰éˆ•
            absentBtns.forEach((btn, index) => {
                console.log(`ğŸ”§ ç¶å®šç¼ºå¸­æŒ‰éˆ• ${index + 1}:`, { 
                    studentId: btn.dataset.studentId, 
                    button: btn,
                    disabled: btn.disabled,
                    pointerEvents: btn.style.pointerEvents
                });
                
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('ğŸ¯ ç¼ºå¸­æŒ‰éˆ•è¢«é»æ“Šäº†ï¼');
                    
                    const studentId = this.dataset.studentId;
                    console.log('ğŸ¯ ç¼ºå¸­æŒ‰éˆ•é»æ“Š:', { studentId, button: this, disabled: this.disabled });
                    
                    // æª¢æŸ¥æŒ‰éˆ•æ˜¯å¦è¢«ç¦ç”¨
                    if (this.disabled) {
                        console.log('âš ï¸ æŒ‰éˆ•è¢«ç¦ç”¨ï¼Œç„¡æ³•é»æ“Š');
                        return;
                    }
                    
                    const studentItem = document.querySelector(`.student-card[data-student-id="${studentId}"]`);
                    console.log('ğŸ” æ‰¾åˆ°å­¸ç”Ÿå¡ç‰‡:', { studentItem, studentId });
                    
                    const studentName = studentItem ? 
                        studentItem.querySelector('.student-name')?.textContent || studentId : 
                        studentId;
                    
                    // æ·»åŠ æŒ‰éˆ•è¼‰å…¥å‹•ç•«
                    this.style.animation = 'buttonPress 0.3s ease-out';
                    this.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> è™•ç†ä¸­...';
                    this.style.pointerEvents = 'none';
                    
                    try {
                        console.log('ğŸš€ é–‹å§‹èª¿ç”¨ saveSingleAttendanceRecord API (ç¼ºå¸­)');
                        // ç«‹å³ç™¼é€ç¼ºå¸­è¨˜éŒ„
                        await saveSingleAttendanceRecord(teacher, course, time, start, end, studentId, studentName, 'absent');
                        console.log('âœ… saveSingleAttendanceRecord API èª¿ç”¨å®Œæˆ (ç¼ºå¸­)');
                        
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        setTimeout(() => {
                            this.innerHTML = '<span style="margin-right: 8px; font-size: 1rem;">âŒ</span> ç¼ºå¸­';
                            this.style.pointerEvents = 'auto';
                            this.style.animation = '';
                        }, 1000);
                    } catch (error) {
                        console.error('âŒ ç¼ºå¸­æŒ‰éˆ•è™•ç†å¤±æ•—:', error);
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        this.innerHTML = '<span style="margin-right: 8px; font-size: 1rem;">âŒ</span> ç¼ºå¸­';
                        this.style.pointerEvents = 'auto';
                        this.style.animation = '';
                    }
                });
            });
        }

        // é€šçŸ¥ç›¸é—œè®Šæ•¸
        let attendanceNotificationSent = false;
        let studentAttendanceStatus = {};
        let attendanceCheckTimer = null;

        // å„²å­˜å–®ç­†ç°½åˆ°è¨˜éŒ„ - ä½¿ç”¨æ–°çš„Google Sheets API
        async function saveSingleAttendanceRecord(teacher, course, time, start, end, studentId, studentName, status) {
            try {
                console.log('ğŸ’¾ ç«‹å³å„²å­˜å–®ç­†ç°½åˆ°è¨˜éŒ„:', { teacher, course, time, start, end, studentId, studentName, status });
                
                // ç²å–ä»Šå¤©çš„æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                
                // ä½¿ç”¨å¾Œç«¯ä»£ç†ä¾†èª¿ç”¨Google Sheets APIï¼ˆé¿å…CORSå•é¡Œï¼‰
                const proxyUrl = '/api/proxy/google-sheets';
                
                // æ§‹å»ºç¬¦åˆæ–°APIæ ¼å¼çš„payload
                const payload = {
                    action: "update",
                    name: studentName,  // ä½¿ç”¨å­¸ç”Ÿå§“åä½œç‚ºname
                    date: today,
                    present: status === 'present' ? true : false,
                    // æ·»åŠ é¡å¤–è³‡è¨Š
                    teacher: teacher,
                    course: course,
                    period: time
                };
                
                console.log('ğŸ“¤ æº–å‚™ç™¼é€åˆ°Google Sheets API (é€šéä»£ç†):', payload);
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'updateAttendance',
                        googleSheetsUrl: "https://script.google.com/macros/s/AKfycbxfj5fwNIc8ncbqkOm763yo6o06wYPHm2nbfd_1yLkHlakoS9FtYfYJhvGCaiAYh_vjIQ/dev",
                        payload: payload
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Google Sheets API è«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('ğŸ“¥ Google Sheets API å›æ‡‰:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.log('âš ï¸ å›æ‡‰ä¸æ˜¯JSONæ ¼å¼ï¼Œä½¿ç”¨åŸå§‹æ–‡å­—:', responseText);
                    data = { success: true, message: responseText };
                }
                
                // æª¢æŸ¥APIå›æ‡‰æ˜¯å¦æˆåŠŸ
                if (data.success !== false) {
                    console.log('âœ… Google Sheets API èª¿ç”¨æˆåŠŸ');
                    
                    // æ›´æ–°UIç‹€æ…‹
                    updateStudentStatus(studentId, status);
                    updateAttendanceStats();
                    
                    // æ›´æ–°å­¸ç”Ÿç°½åˆ°ç‹€æ…‹ä¸¦è§¸ç™¼é€šçŸ¥æª¢æŸ¥
                    studentAttendanceStatus[studentId] = status;
                    updateAttendanceProgress(); // æ›´æ–°é€²åº¦é¡¯ç¤º
                    startAttendanceCheckTimer();
                    
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    const statusText = status === 'present' ? 'å‡ºå¸­' : 'ç¼ºå¸­';
                    showToast(`âœ… ${studentName} ${statusText}è¨˜éŒ„å·²å„²å­˜`, 'success', 2000);
                    
                    return;
                } else {
                    // APIè¿”å›å¤±æ•—
                    console.error('âŒ Google Sheets API è¿”å›å¤±æ•—:', data);
                    const errorMessage = data.message || data.error || 'æœªçŸ¥éŒ¯èª¤';
                    showToast(`âŒ å„²å­˜å¤±æ•—: ${errorMessage}`, 'error', 3000);
                    return;
                }
                
            } catch (error) {
                console.error('âŒ å„²å­˜å–®ç­†ç°½åˆ°è¨˜éŒ„å¤±æ•—:', error);
                alert(`å„²å­˜å¤±æ•—: ${error.message}\n\nè«‹é‡è©¦ã€‚`);
            }
        }

        // æª¢æ¸¬æ˜¯å¦æ‰€æœ‰å­¸ç”Ÿéƒ½å·²ç°½åˆ°
        function checkAllStudentsMarked() {
            const studentCards = document.querySelectorAll('.student-card');
            const totalStudents = studentCards.length;
            
            // è¨ˆç®—æœ‰é€²åº¦çš„å­¸ç”Ÿæ•¸é‡ï¼ˆé™¤äº†"æœªç°½åˆ°"ä»¥å¤–çš„æ‰€æœ‰ç‹€æ…‹éƒ½ç®—é€²åº¦ï¼‰
            let markedStudents = 0;
            studentCards.forEach(card => {
                const studentName = card.querySelector('.student-name')?.textContent?.trim();
                if (studentName) {
                    // æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦æœ‰ä»»ä½•ç‹€æ…‹ï¼ˆç•¶æ¬¡ç°½åˆ°æˆ–æ­·å²ç‹€æ…‹ï¼‰
                    const currentStatus = studentAttendanceStatus[studentName];
                    const hasStatus = card.querySelector('.status-tag');
                    const statusText = hasStatus ? hasStatus.textContent.trim() : '';
                    
                    // å¦‚æœæœ‰ç•¶æ¬¡ç°½åˆ°ç‹€æ…‹ï¼Œæˆ–è€…æœ‰æ­·å²ç‹€æ…‹æ¨™ç±¤ï¼ˆåŒ…å«å‡ºå¸­ã€ç¼ºå¸­ã€è«‹å‡ç­‰ï¼‰ï¼Œå°±ç®—æœ‰é€²åº¦
                    // æ’é™¤"å¾…ç°½åˆ°"ã€"æœªç°½åˆ°"ç­‰ç„¡é€²åº¦ç‹€æ…‹
                    if (currentStatus || 
                        (statusText && 
                         !statusText.includes('å¾…ç°½åˆ°') && !statusText.includes('æœªç°½åˆ°') && !statusText.includes('å¾…é¸æ“‡') &&
                         (statusText.includes('å‡ºå¸­') || statusText.includes('Present') || statusText.includes('âœ…') || statusText.includes('å·²å‡ºå¸­') ||
                          statusText.includes('ç¼ºå¸­') || statusText.includes('Absent') || statusText.includes('âŒ') || statusText.includes('å·²ç¼ºå¸­') ||
                          statusText.includes('è«‹å‡') || statusText.includes('Leave') || statusText.includes('âš ï¸') || statusText.includes('å·²è«‹å‡')))) {
                        markedStudents++;
                        console.log(`âœ… å­¸ç”Ÿ ${studentName} æœ‰é€²åº¦: ç•¶æ¬¡=${currentStatus}, æ­·å²=${statusText}`);
                    } else {
                        console.log(`â³ å­¸ç”Ÿ ${studentName} ç„¡é€²åº¦: ç•¶æ¬¡=${currentStatus}, æ­·å²=${statusText}`);
                    }
                }
            });
            
            console.log(`ğŸ” ç°½åˆ°å®Œæˆæª¢æ¸¬: ${markedStudents}/${totalStudents} å­¸ç”Ÿæœ‰é€²åº¦`);
            console.log('ğŸ“‹ ç•¶æ¬¡æ¨™è¨˜å­¸ç”Ÿ:', Object.keys(studentAttendanceStatus));
            console.log('ğŸ“‹ å­¸ç”Ÿå¡ç‰‡æ•¸é‡:', studentCards.length);
            
            const isComplete = markedStudents === totalStudents;
            console.log(`âœ… ç°½åˆ°å®Œæˆç‹€æ…‹: ${isComplete ? 'å®Œæˆ' : 'æœªå®Œæˆ'}`);
            
            return isComplete;
        }

        // å•Ÿå‹•ç°½åˆ°æª¢æŸ¥å®šæ™‚å™¨
        function startAttendanceCheckTimer() {
            // æ¸…é™¤èˆŠçš„å®šæ™‚å™¨
            if (attendanceCheckTimer) {
                clearTimeout(attendanceCheckTimer);
            }
            
            // ç­‰å¾…3ç§’å¾Œæª¢æŸ¥ä¸¦ç™¼é€é€šçŸ¥ï¼ˆçµ¦ç”¨æˆ¶æ™‚é–“é‡æ–°ä¿®æ­£ç‹€æ…‹ï¼‰
            console.log('â° ç­‰å¾…3ç§’å¾Œç™¼é€é€šçŸ¥...');
            attendanceCheckTimer = setTimeout(() => {
                sendBatchAttendanceNotification();
            }, 3000);
        }

        // æ‰¹é‡ç™¼é€å­¸ç”Ÿç°½åˆ°é€šçŸ¥
        async function sendBatchAttendanceNotification() {
            // å¦‚æœå·²ç¶“ç™¼é€éé€šçŸ¥ï¼Œä¸å†é‡è¤‡ç™¼é€
            if (attendanceNotificationSent) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å­¸ç”Ÿè¢«æ¨™è¨˜
            const hasMarkedStudents = Object.keys(studentAttendanceStatus).length > 0;
            if (!hasMarkedStudents) return;
            
            console.log('ğŸ“¤ æº–å‚™ç™¼é€å­¸ç”Ÿç°½åˆ°é€šçŸ¥...');
            
            // ç²å–ç•¶å‰èª²ç¨‹ä¿¡æ¯
            const currentEvent = getCurrentEventInfo();
            if (!currentEvent) {
                console.log('âŒ ç„¡æ³•ç²å–ç•¶å‰èª²ç¨‹ä¿¡æ¯');
                return;
            }
            
            const { teacher, course, time } = currentEvent;
            
            // åˆ†é¡å­¸ç”Ÿç‹€æ…‹
            const presentStudents = [];
            const absentStudents = [];
            const unmarkedStudents = [];
            
            // ç²å–æ‰€æœ‰å­¸ç”Ÿå¡ç‰‡
            const studentCards = document.querySelectorAll('.student-card');
            studentCards.forEach(card => {
                const studentName = card.querySelector('.student-name')?.textContent?.trim();
                if (studentName) {
                    // å„ªå…ˆä½¿ç”¨ç•¶æ¬¡ç°½åˆ°ç‹€æ…‹ï¼Œå¦‚æœæ²’æœ‰å‰‡æª¢æŸ¥æ­·å²ç‹€æ…‹æ¨™ç±¤
                    let status = studentAttendanceStatus[studentName];
                    
                    if (!status) {
                        // æª¢æŸ¥æ­·å²ç‹€æ…‹æ¨™ç±¤
                        const statusTag = card.querySelector('.status-tag');
                        if (statusTag) {
                            const statusText = statusTag.textContent.trim();
                            console.log(`ğŸ” æª¢æŸ¥å­¸ç”Ÿ ${studentName} çš„æ­·å²ç‹€æ…‹: "${statusText}"`);
                            
                            // æ’é™¤"å¾…ç°½åˆ°"ã€"æœªç°½åˆ°"ç­‰ç„¡é€²åº¦ç‹€æ…‹
                            if (!statusText.includes('å¾…ç°½åˆ°') && !statusText.includes('æœªç°½åˆ°') && !statusText.includes('å¾…é¸æ“‡')) {
                                if (statusText.includes('å‡ºå¸­') || statusText.includes('Present') || statusText.includes('âœ…') || statusText.includes('å·²å‡ºå¸­')) {
                                    status = 'present';
                                    console.log(`âœ… å­¸ç”Ÿ ${studentName} æ­·å²ç‹€æ…‹ç‚ºå‡ºå¸­`);
                                } else if (statusText.includes('ç¼ºå¸­') || statusText.includes('Absent') || statusText.includes('âŒ') || statusText.includes('å·²ç¼ºå¸­')) {
                                    status = 'absent';
                                    console.log(`âŒ å­¸ç”Ÿ ${studentName} æ­·å²ç‹€æ…‹ç‚ºç¼ºå¸­`);
                                } else if (statusText.includes('è«‹å‡') || statusText.includes('Leave') || statusText.includes('âš ï¸') || statusText.includes('å·²è«‹å‡')) {
                                    status = 'leave';
                                    console.log(`âš ï¸ å­¸ç”Ÿ ${studentName} æ­·å²ç‹€æ…‹ç‚ºè«‹å‡`);
                                }
                            } else {
                                console.log(`â³ å­¸ç”Ÿ ${studentName} æ­·å²ç‹€æ…‹ç‚ºå¾…ç°½åˆ°ï¼Œä¸ç®—é€²åº¦`);
                            }
                        }
                    } else {
                        console.log(`ğŸ“ å­¸ç”Ÿ ${studentName} ç•¶æ¬¡ç°½åˆ°ç‹€æ…‹: ${status}`);
                    }
                    
                    // æ ¹æ“šç‹€æ…‹åˆ†é¡
                    if (status === 'present') {
                        presentStudents.push(studentName);
                        console.log(`âœ… å­¸ç”Ÿ ${studentName} æ­¸é¡ç‚ºå‡ºå¸­`);
                    } else if (status === 'absent') {
                        absentStudents.push(studentName);
                        console.log(`âŒ å­¸ç”Ÿ ${studentName} æ­¸é¡ç‚ºç¼ºå¸­`);
                    } else if (status === 'leave') {
                        // è«‹å‡ä¹Ÿç®—é€²åº¦ï¼Œå¯ä»¥å–®ç¨åˆ†é¡æˆ–æ­¸é¡åˆ°ç¼ºå¸­
                        absentStudents.push(studentName + '(è«‹å‡)');
                        console.log(`âš ï¸ å­¸ç”Ÿ ${studentName} æ­¸é¡ç‚ºè«‹å‡`);
                    } else {
                        unmarkedStudents.push(studentName);
                        console.log(`â³ å­¸ç”Ÿ ${studentName} æ­¸é¡ç‚ºæœªé¸æ“‡`);
                    }
                }
            });
            
            console.log(`ğŸ“Š å­¸ç”Ÿç‹€æ…‹åˆ†é¡çµæœ:`, {
                present: presentStudents,
                absent: absentStudents,
                unmarked: unmarkedStudents,
                total: presentStudents.length + absentStudents.length + unmarkedStudents.length
            });
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å­¸ç”Ÿéƒ½å·²ç°½åˆ°
            const allStudentsMarked = checkAllStudentsMarked();
            const totalStudents = presentStudents.length + absentStudents.length + unmarkedStudents.length;
            
            // æ§‹å»ºé€šçŸ¥è¨Šæ¯
            let message = `ğŸ“š å­¸ç”Ÿç°½åˆ°é€šçŸ¥\n\n`;
            message += `ğŸ‘¨â€ğŸ« è¬›å¸«ï¼š${teacher || 'æœªçŸ¥è¬›å¸«'}\n`;
            message += `ğŸ“– èª²ç¨‹ï¼š${course || 'æœªçŸ¥èª²ç¨‹'}\n`;
            message += `ğŸ“… æ—¥æœŸï¼š${new Date().toLocaleDateString('zh-TW')}\n\n`;
            
            // ç°½åˆ°å®Œæˆç‹€æ…‹
            if (allStudentsMarked) {
                message += `ğŸ‰ ç°½åˆ°å®Œæˆï¼æ‰€æœ‰å­¸ç”Ÿå·²æ¨™è¨˜\n\n`;
            } else {
                // è¨ˆç®—ç¸½é€²åº¦ï¼ˆåŒ…æ‹¬æ­·å²ç‹€æ…‹ï¼‰
                let totalProgress = 0;
                studentCards.forEach(card => {
                    const studentName = card.querySelector('.student-name')?.textContent?.trim();
                    if (studentName) {
                        const currentStatus = studentAttendanceStatus[studentName];
                        const hasStatus = card.querySelector('.status-tag');
                        const statusText = hasStatus ? hasStatus.textContent.trim() : '';
                        
                        if (currentStatus || (statusText && statusText !== 'æœªç°½åˆ°' && statusText !== 'å¾…ç°½åˆ°')) {
                            totalProgress++;
                        }
                    }
                });
                
                message += `â³ ç°½åˆ°é€²è¡Œä¸­ (${totalProgress}/${totalStudents} æœ‰é€²åº¦)\n\n`;
            }
            
            if (presentStudents.length > 0) {
                message += `âœ… å‡ºå¸­ (${presentStudents.length}äºº)ï¼š\n${presentStudents.join('ã€')}\n\n`;
            }
            
            if (absentStudents.length > 0) {
                message += `âŒ ç¼ºå¸­ (${absentStudents.length}äºº)ï¼š\n${absentStudents.join('ã€')}\n\n`;
            }
            
            if (unmarkedStudents.length > 0) {
                message += `â³ æœªé¸æ“‡ (${unmarkedStudents.length}äºº)ï¼š\n${unmarkedStudents.join('ã€')}\n\n`;
            }
            
            message += `â° ç°½åˆ°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`;
            
            try {
                // ç™¼é€é€šçŸ¥
                const response = await fetch('/api/student-attendance-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        teacherName: teacher,
                        courseName: course,
                        presentStudents: presentStudents,
                        absentStudents: absentStudents,
                        unmarkedStudents: unmarkedStudents
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    attendanceNotificationSent = true;
                    console.log('âœ… å­¸ç”Ÿç°½åˆ°é€šçŸ¥å·²ç™¼é€ï¼');
                    showToast('âœ… å­¸ç”Ÿç°½åˆ°é€šçŸ¥å·²ç™¼é€ï¼');
                } else {
                    console.error('âŒ é€šçŸ¥ç™¼é€å¤±æ•—:', data.error);
                    showToast('âŒ é€šçŸ¥ç™¼é€å¤±æ•—');
                }
            } catch (error) {
                console.error('ç™¼é€é€šçŸ¥éŒ¯èª¤:', error);
                showToast('âŒ é€šçŸ¥ç™¼é€å¤±æ•—');
            }
        }

        // ç²å–ç•¶å‰èª²ç¨‹ä¿¡æ¯
        function getCurrentEventInfo() {
            console.log('ğŸ” å˜—è©¦ç²å–ç•¶å‰èª²ç¨‹ä¿¡æ¯...');
            
            // å¾æ¨¡æ…‹æ¡†å…§å®¹ä¸­ç²å–èª²ç¨‹ä¿¡æ¯
            const modalContent = document.querySelector('.attendance-modal-content');
            if (!modalContent) {
                console.log('âŒ æ‰¾ä¸åˆ°ç°½åˆ°æ¨¡æ…‹æ¡†');
                return null;
            }
            
            // å˜—è©¦å¾èª²ç¨‹ä¿¡æ¯é¢æ¿ç²å–
            const courseInfoPanel = modalContent.querySelector('.course-info-panel');
            if (courseInfoPanel) {
                const teacherElement = courseInfoPanel.querySelector('[data-field="teacher"]');
                const courseElement = courseInfoPanel.querySelector('[data-field="course"]');
                const timeElement = courseInfoPanel.querySelector('[data-field="time"]');
                
                if (teacherElement && courseElement && timeElement) {
                    const teacher = teacherElement.textContent.replace('è¬›å¸«:', '').trim();
                    const course = courseElement.textContent.replace('èª²ç¨‹:', '').trim();
                    const time = timeElement.textContent.replace('æ™‚é–“:', '').trim();
                    
                    console.log('âœ… å¾èª²ç¨‹ä¿¡æ¯é¢æ¿ç²å–:', { teacher, course, time });
                    return { teacher, course, time };
                }
            }
            
            // å‚™ç”¨æ–¹æ¡ˆï¼šå¾æ¨¡æ…‹æ¡†æ¨™é¡Œè§£æ
            const modalTitle = modalContent.querySelector('h2');
            if (modalTitle) {
                const titleText = modalTitle.textContent;
                console.log('ğŸ” å¾æ¨™é¡Œè§£æ:', titleText);
                
                // è§£ææ¨™é¡Œç²å–è¬›å¸«å’Œèª²ç¨‹ä¿¡æ¯
                const teacherMatch = titleText.match(/è¬›å¸«[ï¼š:]\s*([^èª²ç¨‹]+)/);
                const courseMatch = titleText.match(/èª²ç¨‹[ï¼š:]\s*([^æ™‚é–“]+)/);
                const timeMatch = titleText.match(/æ™‚é–“[ï¼š:]\s*([^æ—¥æœŸ]+)/);
                
                const result = {
                    teacher: teacherMatch ? teacherMatch[1].trim() : 'æœªçŸ¥è¬›å¸«',
                    course: courseMatch ? courseMatch[1].trim() : 'æœªçŸ¥èª²ç¨‹',
                    time: timeMatch ? timeMatch[1].trim() : 'æœªçŸ¥æ™‚é–“'
                };
                
                console.log('âœ… å¾æ¨™é¡Œè§£æçµæœ:', result);
                return result;
            }
            
            console.log('âŒ ç„¡æ³•ç²å–èª²ç¨‹ä¿¡æ¯');
            return null;
        }

        // æ›´æ–°ç°½åˆ°é€²åº¦é¡¯ç¤º
        function updateAttendanceProgress() {
            const studentCards = document.querySelectorAll('.student-card');
            const totalStudents = studentCards.length;
            
            // è¨ˆç®—æœ‰é€²åº¦çš„å­¸ç”Ÿæ•¸é‡ï¼ˆåŒ…æ‹¬æ­·å²ç‹€æ…‹ï¼‰
            let markedStudents = 0;
            studentCards.forEach(card => {
                const studentName = card.querySelector('.student-name')?.textContent?.trim();
                if (studentName) {
                    // æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦æœ‰ä»»ä½•ç‹€æ…‹ï¼ˆç•¶æ¬¡ç°½åˆ°æˆ–æ­·å²ç‹€æ…‹ï¼‰
                    const currentStatus = studentAttendanceStatus[studentName];
                    const hasStatus = card.querySelector('.status-tag');
                    const statusText = hasStatus ? hasStatus.textContent.trim() : '';
                    
                    // å¦‚æœæœ‰ç•¶æ¬¡ç°½åˆ°ç‹€æ…‹ï¼Œæˆ–è€…æœ‰æ­·å²ç‹€æ…‹æ¨™ç±¤ï¼ˆåŒ…å«å‡ºå¸­ã€ç¼ºå¸­ã€è«‹å‡ç­‰ï¼‰ï¼Œå°±ç®—æœ‰é€²åº¦
                    // æ’é™¤"å¾…ç°½åˆ°"ã€"æœªç°½åˆ°"ç­‰ç„¡é€²åº¦ç‹€æ…‹
                    if (currentStatus || 
                        (statusText && 
                         !statusText.includes('å¾…ç°½åˆ°') && !statusText.includes('æœªç°½åˆ°') && !statusText.includes('å¾…é¸æ“‡') &&
                         (statusText.includes('å‡ºå¸­') || statusText.includes('Present') || statusText.includes('âœ…') || statusText.includes('å·²å‡ºå¸­') ||
                          statusText.includes('ç¼ºå¸­') || statusText.includes('Absent') || statusText.includes('âŒ') || statusText.includes('å·²ç¼ºå¸­') ||
                          statusText.includes('è«‹å‡') || statusText.includes('Leave') || statusText.includes('âš ï¸') || statusText.includes('å·²è«‹å‡')))) {
                        markedStudents++;
                    }
                }
            });
            
            const progress = totalStudents > 0 ? (markedStudents / totalStudents) * 100 : 0;
            
            console.log(`ğŸ“Š æ›´æ–°é€²åº¦é¡¯ç¤º: ${markedStudents}/${totalStudents} (${progress}%)`);
            console.log(`ğŸ“Š ç•¶æ¬¡æ¨™è¨˜: ${Object.keys(studentAttendanceStatus).length}, ç¸½é€²åº¦: ${markedStudents}`);
            
            // ç§»é™¤èˆŠçš„æµ®å‹•é€šçŸ¥
            const existingNotification = document.querySelector('.floating-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // å‰µå»ºæ–°çš„æµ®å‹•é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'floating-notification progress';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">ğŸ“Š</div>
                    <div class="notification-text">
                        <div>ç°½åˆ°é€²åº¦</div>
                        <div class="progress-bar-floating">
                            <div class="progress-fill-floating" style="width: ${progress}%"></div>
                        </div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${markedStudents}/${totalStudents} å­¸ç”Ÿå·²æ¨™è¨˜</div>
                    </div>
                    <button class="notification-close">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // è§¸ç™¼é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // å¦‚æœæ‰€æœ‰å­¸ç”Ÿéƒ½å·²ç°½åˆ°ï¼Œé¡¯ç¤ºå®Œæˆé€šçŸ¥
            if (markedStudents === totalStudents && totalStudents > 0) {
                setTimeout(() => {
                    showCompletionNotification();
                }, 500);
            }
            
            console.log('âœ… æµ®å‹•é€²åº¦é€šçŸ¥å·²é¡¯ç¤º');
        }
        
        // é¡¯ç¤ºå®Œæˆé€šçŸ¥
        function showCompletionNotification() {
            // ç§»é™¤é€²åº¦é€šçŸ¥
            const progressNotification = document.querySelector('.floating-notification.progress');
            if (progressNotification) {
                progressNotification.remove();
            }
            
            // å‰µå»ºå®Œæˆé€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'floating-notification completion';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">ğŸ‰</div>
                    <div class="notification-text">
                        <div>ç°½åˆ°å®Œæˆï¼</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">æ‰€æœ‰å­¸ç”Ÿå·²æ¨™è¨˜</div>
                    </div>
                    <button class="notification-close">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // è§¸ç™¼é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // 5ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 400);
                }
            }, 5000);
            
            console.log('âœ… æµ®å‹•å®Œæˆé€šçŸ¥å·²é¡¯ç¤º');
        }

        // é‡ç½®ç°½åˆ°é€šçŸ¥ç‹€æ…‹ï¼ˆç•¶é–‹å§‹æ–°çš„ç°½åˆ°æ™‚ï¼‰
        function resetAttendanceNotification() {
            attendanceNotificationSent = false;
            studentAttendanceStatus = {};
            
            // æ¸…é™¤å®šæ™‚å™¨
            if (attendanceCheckTimer) {
                clearTimeout(attendanceCheckTimer);
                attendanceCheckTimer = null;
            }
        }

        // é¡¯ç¤º Toast é€šçŸ¥
        function showToast(message, type = 'success') {
            // å‰µå»º toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = 'glass-toast';
            
            // æ ¹æ“šé¡å‹è¨­å®šé¡è‰²
            const colors = {
                success: {
                    bg: 'rgba(40, 167, 69, 0.25)',
                    border: 'rgba(40, 167, 69, 0.4)',
                    icon: '#28a745',
                    text: '#2c3e50'
                },
                error: {
                    bg: 'rgba(220, 53, 69, 0.25)',
                    border: 'rgba(220, 53, 69, 0.4)',
                    icon: '#dc3545',
                    text: '#2c3e50'
                },
                info: {
                    bg: 'rgba(52, 152, 219, 0.25)',
                    border: 'rgba(52, 152, 219, 0.4)',
                    icon: '#3498db',
                    text: '#2c3e50'
                },
                warning: {
                    bg: 'rgba(255, 193, 7, 0.25)',
                    border: 'rgba(255, 193, 7, 0.4)',
                    icon: '#ffc107',
                    text: '#2c3e50'
                }
            };
            
            const colorScheme = colors[type] || colors.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, 
                    ${colorScheme.bg} 0%, 
                    rgba(255, 255, 255, 0.1) 50%,
                    ${colorScheme.bg} 100%);
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                color: ${colorScheme.text};
                padding: 16px 24px;
                border-radius: 20px;
                box-shadow: 
                    0 8px 32px rgba(0, 0, 0, 0.1),
                    0 4px 16px rgba(0, 0, 0, 0.05),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
                border: 2px solid ${colorScheme.border};
                z-index: 10000;
                font-size: 15px;
                font-weight: 600;
                max-width: 350px;
                word-wrap: break-word;
                opacity: 0;
                transform: translateX(100%) scale(0.8);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            `;
            
            // æ·»åŠ åœ–æ¨™
            const iconMap = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle',
                warning: 'fas fa-exclamation-triangle'
            };
            
            const iconClass = iconMap[type] || iconMap.info;
            
            toast.innerHTML = `
                <div style="position: relative; z-index: 1; display: flex; align-items: center; gap: 12px;">
                    <i class="${iconClass}" style="
                        font-size: 1.2rem;
                        color: ${colorScheme.icon};
                        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
                    "></i>
                    <span style="
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                        flex: 1;
                    ">${message}</span>
                </div>
            `;
            
            // æ·»åŠ èƒŒæ™¯å…‰æ•ˆ
            const shimmerEffect = document.createElement('div');
            shimmerEffect.style.cssText = `
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                animation: shimmerSlide 3s ease-in-out infinite;
                pointer-events: none;
            `;
            
            toast.appendChild(shimmerEffect);
            document.body.appendChild(toast);
            
            // æ·»åŠ å‹•ç•«æ¨£å¼
            if (!document.querySelector('#toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    @keyframes shimmerSlide {
                        0% { left: -100%; }
                        50% { left: 100%; }
                        100% { left: 100%; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0) scale(1)';
            }, 100);
            
            // 4ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%) scale(0.8)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400);
            }, 4000);
        }

        // ç²å–è¬›å¸«Web API URL
        async function getTeacherWebApi(teacherName) {
            try {
                console.log('ğŸ” æŸ¥æ‰¾è¬›å¸«Web API:', teacherName);
                
                // ä½¿ç”¨å¾Œç«¯APIç²å–è¬›å¸«Web API URL
                const response = await fetch('/api/teacher-web-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        teacherName: teacherName
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ç„¡æ³•å¾å¾Œç«¯APIç²å–è¬›å¸«Web API');
                }
                
                const data = await response.json();
                console.log('ğŸ“‹ å¾Œç«¯APIå›æ‡‰:', data);
                
                if (data.success && data.webApi) {
                    console.log('âœ… æ‰¾åˆ°è¬›å¸«Web API:', data.webApi);
                    return data.webApi;
                } else {
                    console.log('âš ï¸ è¬›å¸«æ²’æœ‰é…ç½®Web API:', data.message);
                    return null;
                }
                
            } catch (error) {
                console.error('âŒ ç²å–è¬›å¸«Web APIå¤±æ•—:', error);
                
                // å¦‚æœå¾Œç«¯APIå¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨æœ¬åœ°CSVæ–‡ä»¶ä½œç‚ºå‚™ç”¨
                console.log('ğŸ”„ å˜—è©¦ä½¿ç”¨æœ¬åœ°CSVæ–‡ä»¶ä½œç‚ºå‚™ç”¨...');
                return await getTeacherWebApiFromCSV(teacherName);
            }
        }

        // å¾æœ¬åœ°CSVæ–‡ä»¶ç²å–è¬›å¸«Web APIï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
        async function getTeacherWebApiFromCSV(teacherName) {
            try {
                console.log('ğŸ” å¾CSVæ–‡ä»¶æŸ¥æ‰¾è¬›å¸«Web API:', teacherName);
                
                // è®€å–CSVæ–‡ä»¶
                const response = await fetch('114-1 è¬›å¸«å ±è¡¨web read api.csv');
                if (!response.ok) {
                    throw new Error('ç„¡æ³•è®€å–è¬›å¸«APIé…ç½®æ–‡ä»¶');
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                // è·³éæ¨™é¡Œè¡Œï¼Œå¾ç¬¬äºŒè¡Œé–‹å§‹è™•ç†
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const columns = line.split(',');
                    if (columns.length >= 3) {
                        const csvTeacherName = columns[0].trim();
                        const webApi = columns[2].trim();
                        
                        // æ¨¡ç³ŠåŒ¹é…è¬›å¸«åç¨±ï¼ˆå¿½ç•¥ç©ºæ ¼å’Œå¤§å°å¯«ï¼‰
                        if (csvTeacherName.toLowerCase().replace(/\s+/g, '') === 
                            teacherName.toLowerCase().replace(/\s+/g, '')) {
                            
                            if (webApi && webApi !== '') {
                                console.log('âœ… å¾CSVæ‰¾åˆ°è¬›å¸«Web API:', webApi);
                                return webApi;
                            } else {
                                console.log('âš ï¸ è¬›å¸«æ²’æœ‰é…ç½®Web API:', csvTeacherName);
                                return null;
                            }
                        }
                    }
                }
                
                console.log('âŒ åœ¨CSVä¸­æ‰¾ä¸åˆ°è¬›å¸«:', teacherName);
                return null;
                
            } catch (error) {
                console.error('âŒ å¾CSVç²å–è¬›å¸«Web APIå¤±æ•—:', error);
                return null;
            }
        }

        // éŒ¯èª¤è™•ç†å„ªåŒ–
        class ErrorHandler {
            constructor() {
                this.retryCount = 0;
                this.maxRetries = 3;
                this.retryDelay = 1000;
            }

            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            showError(message, error = null) {
                console.error('âŒ éŒ¯èª¤:', message, error);
                
                // å‰µå»ºéŒ¯èª¤é€šçŸ¥
                const errorToast = document.createElement('div');
                errorToast.className = 'error-toast';
                errorToast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #f44336, #d32f2f);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
                    z-index: 10001;
                    font-size: 14px;
                    font-weight: 500;
                    max-width: 350px;
                    word-wrap: break-word;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                    border-left: 4px solid #ffcdd2;
                    animation: errorShake 0.5s ease;
                `;
                
                errorToast.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 16px;"></i>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">éŒ¯èª¤</div>
                            <div>${message}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(errorToast);
                
                // é¡¯ç¤ºå‹•ç•«
                setTimeout(() => {
                    errorToast.style.opacity = '1';
                    errorToast.style.transform = 'translateX(0)';
                }, 100);
                
                // 5ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    errorToast.style.opacity = '0';
                    errorToast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (errorToast.parentNode) {
                            errorToast.parentNode.removeChild(errorToast);
                        }
                    }, 300);
                }, 5000);
            }

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            showSuccess(message) {
                console.log('âœ… æˆåŠŸ:', message);
                
                const successToast = document.createElement('div');
                successToast.className = 'success-toast';
                successToast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #4CAF50, #45a049);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
                    z-index: 10001;
                    font-size: 14px;
                    font-weight: 500;
                    max-width: 350px;
                    word-wrap: break-word;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                    border-left: 4px solid #c8e6c9;
                    animation: successPulse 0.6s ease;
                `;
                
                successToast.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-check-circle" style="font-size: 16px;"></i>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">æˆåŠŸ</div>
                            <div>${message}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(successToast);
                
                // é¡¯ç¤ºå‹•ç•«
                setTimeout(() => {
                    successToast.style.opacity = '1';
                    successToast.style.transform = 'translateX(0)';
                }, 100);
                
                // 3ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    successToast.style.opacity = '0';
                    successToast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (successToast.parentNode) {
                            successToast.parentNode.removeChild(successToast);
                        }
                    }, 300);
                }, 3000);
            }

            // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
            showWarning(message) {
                console.warn('âš ï¸ è­¦å‘Š:', message);
                
                const warningToast = document.createElement('div');
                warningToast.className = 'warning-toast';
                warningToast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #ff9800, #f57c00);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
                    z-index: 10001;
                    font-size: 14px;
                    font-weight: 500;
                    max-width: 350px;
                    word-wrap: break-word;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                    border-left: 4px solid #ffe0b2;
                `;
                
                warningToast.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 16px;"></i>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">è­¦å‘Š</div>
                            <div>${message}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(warningToast);
                
                // é¡¯ç¤ºå‹•ç•«
                setTimeout(() => {
                    warningToast.style.opacity = '1';
                    warningToast.style.transform = 'translateX(0)';
                }, 100);
                
                // 4ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    warningToast.style.opacity = '0';
                    warningToast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (warningToast.parentNode) {
                            warningToast.parentNode.removeChild(warningToast);
                        }
                    }, 300);
                }, 4000);
            }

            // é‡è©¦æ©Ÿåˆ¶
            async retry(fn, context = null) {
                try {
                    const result = await fn();
                    this.retryCount = 0; // é‡ç½®é‡è©¦è¨ˆæ•¸
                    return result;
                } catch (error) {
                    this.retryCount++;
                    
                    if (this.retryCount <= this.maxRetries) {
                        console.warn(`âš ï¸ é‡è©¦ ${this.retryCount}/${this.maxRetries}:`, error.message);
                        this.showWarning(`æ­£åœ¨é‡è©¦... (${this.retryCount}/${this.maxRetries})`);
                        
                        // ç­‰å¾…å¾Œé‡è©¦
                        await new Promise(resolve => setTimeout(resolve, this.retryDelay * this.retryCount));
                        return this.retry(fn, context);
                    } else {
                        console.error('âŒ é‡è©¦å¤±æ•—ï¼Œå·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸:', error);
                        this.showError(`æ“ä½œå¤±æ•—ï¼Œå·²é‡è©¦ ${this.maxRetries} æ¬¡`);
                        throw error;
                    }
                }
            }

            // å…¨åŸŸéŒ¯èª¤æ•ç²
            setupGlobalErrorHandling() {
                // æ•ç²æœªè™•ç†çš„PromiseéŒ¯èª¤
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('âŒ æœªè™•ç†çš„PromiseéŒ¯èª¤:', event.reason);
                    this.showError('ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                    event.preventDefault();
                });

                // æ•ç²JavaScriptéŒ¯èª¤
                window.addEventListener('error', (event) => {
                    console.error('âŒ JavaScriptéŒ¯èª¤:', event.error);
                    this.showError('ç™¼ç”ŸJavaScriptéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°');
                });
            }
        }

        // å‰µå»ºå…¨åŸŸéŒ¯èª¤è™•ç†å™¨
        const errorHandler = new ErrorHandler();
        errorHandler.setupGlobalErrorHandling();

        // æ›´æ–°å­¸ç”Ÿç‹€æ…‹
        function updateStudentStatus(studentId, status) {
            // ç²¾ç¢ºæŸ¥æ‰¾å­¸ç”Ÿå¡ç‰‡ï¼Œé¿å…æ‰¾åˆ°æŒ‰éˆ•
            let studentItem = document.querySelector(`.student-card[data-student-id="${studentId}"]`);
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦é€šéå­¸ç”Ÿå§“åæŸ¥æ‰¾
            if (!studentItem) {
                console.log(`ğŸ” é€šéIDæ‰¾ä¸åˆ°å­¸ç”Ÿå¡ç‰‡ï¼Œå˜—è©¦é€šéå§“åæŸ¥æ‰¾: ${studentId}`);
                // æŸ¥æ‰¾æ‰€æœ‰å­¸ç”Ÿå¡ç‰‡ï¼Œé€šéå§“ååŒ¹é…
                const allStudentCards = document.querySelectorAll('.student-card');
                for (let card of allStudentCards) {
                    const studentName = card.querySelector('.student-name')?.textContent?.trim();
                    if (studentName === studentId) {
                        studentItem = card;
                        console.log(`âœ… é€šéå§“åæ‰¾åˆ°å­¸ç”Ÿå¡ç‰‡: ${studentName}`);
                        break;
                    }
                }
            }
            
            if (!studentItem) {
                console.error(`âŒ æ‰¾ä¸åˆ°å­¸ç”Ÿå¡ç‰‡: ${studentId}`);
                console.log('ğŸ” å¯ç”¨çš„å­¸ç”Ÿå¡ç‰‡:', Array.from(document.querySelectorAll('.student-card')).map(card => ({
                    id: card.dataset.studentId,
                    name: card.querySelector('.student-name')?.textContent?.trim()
                })));
                return;
            }

            // æ·»åŠ ç‹€æ…‹è®Šæ›´å‹•ç•«
            studentItem.style.animation = 'statusChange 0.6s ease-out';
            studentItem.classList.remove('present', 'absent', 'leave', 'pending');

            // é‡ç½®æ‰€æœ‰æŒ‰éˆ•æ¨£å¼
            const presentBtn = studentItem.querySelector('.present-btn');
            const absentBtn = studentItem.querySelector('.absent-btn');
            
            if (presentBtn) {
                presentBtn.style.transform = 'scale(1)';
                presentBtn.style.boxShadow = '0 4px 15px rgba(40, 167, 69, 0.3)';
            }
            if (absentBtn) {
                absentBtn.style.transform = 'scale(1)';
                absentBtn.style.boxShadow = '0 4px 15px rgba(220, 53, 69, 0.3)';
            }

            if (status) {
                studentItem.classList.add(status);
                
                // æ ¹æ“šç‹€æ…‹è¨­å®šæ¨£å¼
                let statusStyles = {
                    border: '#e9ecef',
                    background: 'white',
                    icon: 'fas fa-clock',
                    iconColor: '#6c757d',
                    statusColor: '#6c757d',
                    statusText: 'å¾…ç°½åˆ°'
                };
                
                if (status === 'present') {
                    statusStyles = {
                        border: '#28a745',
                        background: 'linear-gradient(135deg, rgba(40, 167, 69, 0.25), rgba(32, 201, 151, 0.2))',
                        icon: 'fas fa-check-circle',
                        iconColor: '#28a745',
                        statusColor: '#28a745',
                        statusText: 'âœ… å·²å‡ºå¸­',
                        emoji: 'âœ…'
                    };
                } else if (status === 'absent') {
                    statusStyles = {
                        border: '#dc3545',
                        background: 'linear-gradient(135deg, rgba(220, 53, 69, 0.25), rgba(231, 76, 60, 0.2))',
                        icon: 'fas fa-times-circle',
                        iconColor: '#dc3545',
                        statusColor: '#dc3545',
                        statusText: 'âŒ å·²ç¼ºå¸­',
                        emoji: 'âŒ'
                    };
                } else if (status === 'leave') {
                    statusStyles = {
                        border: '#ffc107',
                        background: 'linear-gradient(135deg, rgba(255, 193, 7, 0.25), rgba(243, 156, 18, 0.2))',
                        icon: 'fas fa-exclamation-triangle',
                        iconColor: '#ffc107',
                        statusColor: '#ffc107',
                        statusText: 'âš ï¸ å·²è«‹å‡',
                        emoji: 'âš ï¸'
                    };
                }
                
                // æ›´æ–°å­¸ç”Ÿé …ç›®çš„æ¨£å¼
                studentItem.style.border = `2px solid ${statusStyles.border}`;
                studentItem.style.background = statusStyles.background;
                
                // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                const statusDisplay = studentItem.querySelector('.student-name').nextElementSibling;
                if (statusDisplay) {
                    statusDisplay.innerHTML = `
                        <span style="font-size: 1.1rem;">${statusStyles.emoji}</span>
                        <span>${statusStyles.statusText}</span>
                    `;
                    statusDisplay.style.background = statusStyles.statusColor;
                    statusDisplay.style.color = 'white';
                }
                
                // é«˜äº®é¸ä¸­çš„æŒ‰éˆ•ä¸¦æ·»åŠ æˆåŠŸå‹•ç•«
                const selectedBtn = studentItem.querySelector(`.${status}-btn`);
                if (selectedBtn) {
                    selectedBtn.style.transform = 'scale(1.05)';
                    selectedBtn.style.boxShadow = status === 'present' ? 
                        '0 8px 25px rgba(40, 167, 69, 0.5)' : 
                        '0 8px 25px rgba(220, 53, 69, 0.5)';
                    selectedBtn.style.animation = 'successPulse 0.8s ease-out';
                }
            }
            
            // æ¸…é™¤å‹•ç•«
            setTimeout(() => {
                studentItem.style.animation = '';
                if (studentItem.querySelector('.present-btn')) {
                    studentItem.querySelector('.present-btn').style.animation = '';
                }
                if (studentItem.querySelector('.absent-btn')) {
                    studentItem.querySelector('.absent-btn').style.animation = '';
                }
            }, 600);
            
            // æ›´æ–°çµ±è¨ˆ
            updateAttendanceStats();
        }

        // æ›´æ–°ç°½åˆ°çµ±è¨ˆ
        function updateAttendanceStats() {
            console.log('ğŸ“Š é–‹å§‹æ›´æ–°ç°½åˆ°çµ±è¨ˆ');
            const studentsList = document.getElementById('studentsList');
            if (!studentsList) {
                console.log('âŒ æ‰¾ä¸åˆ°å­¸ç”Ÿåˆ—è¡¨å…ƒç´ ');
                return;
            }
            
            const students = studentsList.querySelectorAll('.student-item');
            console.log('ğŸ“Š æ‰¾åˆ°å­¸ç”Ÿå…ƒç´ æ•¸é‡:', students.length);
            
            let presentCount = 0;
            let absentCount = 0;
            let leaveCount = 0;
            let pendingCount = 0;
            
            students.forEach(student => {
                if (student.classList.contains('present')) presentCount++;
                else if (student.classList.contains('absent')) absentCount++;
                else if (student.classList.contains('leave')) leaveCount++;
                else pendingCount++;
            });
            
            const totalCount = students.length;
            const attendanceStats = document.getElementById('attendanceStats');
            if (attendanceStats) {
                console.log('ğŸ“Š æ›´æ–°çµ±è¨ˆæ¬„ä½:', { presentCount, absentCount, leaveCount, pendingCount });
                
                // æ·»åŠ çµ±è¨ˆå‹•ç•«
                attendanceStats.classList.add('stats-animation');
                setTimeout(() => {
                    attendanceStats.classList.remove('stats-animation');
                }, 600);
                
                attendanceStats.innerHTML = `
                    <div style="display: flex; gap: 6px; align-items: center; flex-wrap: nowrap; justify-content: center; overflow-x: auto; white-space: nowrap;">
                        <span class="stats-item" style="color: #28a745; text-shadow: none; padding: 2px 4px; border-radius: 4px; background: rgba(40, 167, 69, 0.1); font-size: 0.7rem; white-space: nowrap; flex-shrink: 0;"><i class="fas fa-check-circle"></i> å‡ºå¸­: ${presentCount}</span>
                        <span class="stats-item" style="color: #dc3545; text-shadow: none; padding: 2px 4px; border-radius: 4px; background: rgba(220, 53, 69, 0.1); font-size: 0.7rem; white-space: nowrap; flex-shrink: 0;"><i class="fas fa-times-circle"></i> ç¼ºå¸­: ${absentCount}</span>
                        <span class="stats-item" style="color: #ffc107; text-shadow: none; padding: 2px 4px; border-radius: 4px; background: rgba(255, 193, 7, 0.1); font-size: 0.7rem; white-space: nowrap; flex-shrink: 0;"><i class="fas fa-exclamation-triangle"></i> è«‹å‡: ${leaveCount}</span>
                        <span class="stats-item" style="color: #6c757d; text-shadow: none; padding: 2px 4px; border-radius: 4px; background: rgba(108, 117, 125, 0.1); font-size: 0.7rem; white-space: nowrap; flex-shrink: 0;"><i class="fas fa-clock"></i> å¾…ç°½: ${pendingCount}</span>
                    </div>
                `;
            } else {
                console.log('âŒ æ‰¾ä¸åˆ°çµ±è¨ˆæ¬„ä½å…ƒç´ ');
            }
        }

        // è¨­ç½®å­¸ç”Ÿå¡ç‰‡é›™æ“Šèª²ç¨‹ç›£è½å™¨
        function setupStudentCardDoubleClickListeners() {
            console.log('ğŸ”§ è¨­ç½®å­¸ç”Ÿå¡ç‰‡äº‹ä»¶ç›£è½å™¨');
            // ç›´æ¥ç¶å®šå­¸ç”Ÿå¡ç‰‡äº‹ä»¶ç›£è½å™¨ï¼Œä¸é‡æ–°å‰µå»ºå…ƒç´ 
            
            const studentCards = document.querySelectorAll('.student-card');
            studentCards.forEach(card => {
                let clickCount = 0;
                let clickTimer = null;
                
                card.addEventListener('click', function(e) {
                    // é˜²æ­¢èª²ç¨‹å†’æ³¡åˆ°æŒ‰éˆ•
                    if (e.target.classList.contains('present-btn') || 
                        e.target.classList.contains('absent-btn') ||
                        e.target.closest('.present-btn') || 
                        e.target.closest('.absent-btn')) {
                        console.log('ğŸš« å­¸ç”Ÿå¡ç‰‡é»æ“Šè¢«é˜»æ­¢ï¼Œå› ç‚ºé»æ“Šäº†æŒ‰éˆ•');
                        return;
                    }
                    
                    clickCount++;
                    
                    if (clickCount === 1) {
                        // ç¬¬ä¸€æ¬¡é»æ“Šï¼Œè¨­ç½®å®šæ™‚å™¨
                        clickTimer = setTimeout(() => {
                            clickCount = 0;
                        }, 300); // 300ms å…§æ²’æœ‰ç¬¬äºŒæ¬¡é»æ“Šå‰‡é‡ç½®
                    } else if (clickCount === 2) {
                        // ç¬¬äºŒæ¬¡é»æ“Šï¼Œè§¸ç™¼é›™æ“Šèª²ç¨‹
                        clearTimeout(clickTimer);
                        clickCount = 0;
                        
                        // æ·»åŠ é›™æ“Šå‹•ç•«
                        card.classList.add('double-click-animation');
                        setTimeout(() => {
                            card.classList.remove('double-click-animation');
                        }, 600);
                        
                        // æŸ¥è©¢ç¼ºå‹¤ç´€éŒ„
                        const studentName = card.querySelector('.student-name')?.textContent;
                        if (studentName) {
                            queryStudentAttendanceRecord(studentName);
                        }
                    }
                });
            });
        }

        // è¨ˆç®—å‡ºå¸­ç‡
        function calculateAttendanceRate(student) {
            // æ ¹æ“š API å›æ‡‰çš„è³‡æ–™çµæ§‹è¨ˆç®—å‡ºå¸­ç‡
            const present = student.present || student.attendance?.present || 0;
            const absent = student.absent || student.attendance?.absent || 0;
            const late = student.late || student.attendance?.late || 0;
            const unmarked = student.unmarked || student.attendance?.unmarked || 0;
            
            const total = present + absent + late + unmarked;
            if (total === 0) return 0;
            
            return Math.round((present / total) * 100);
        }
        
        // ç²å–å­¸ç”Ÿå‡ºç¼ºå‹¤è³‡æ–™
        function getStudentAttendanceData(student) {
            console.log('ğŸ” è™•ç†å­¸ç”Ÿå‡ºç¼ºå‹¤è³‡æ–™:', student);
            
            // æ”¯æ´å¤šç¨®è³‡æ–™çµæ§‹
            const attendanceData = {
                present: student.present || student.attendance?.present || 0,
                absent: student.absent || student.attendance?.absent || 0,
                late: student.late || student.attendance?.late || 0,
                unmarked: student.unmarked || student.attendance?.unmarked || 0
            };
            
            console.log('ğŸ“Š åˆå§‹å‡ºç¼ºå‹¤è³‡æ–™:', attendanceData);
            
            // å¦‚æœæ²’æœ‰å‡ºç¼ºå‹¤è³‡æ–™ï¼Œå˜—è©¦å¾å…¶ä»–æ¬„ä½è¨ˆç®—
            if (attendanceData.present === 0 && attendanceData.absent === 0 && 
                attendanceData.late === 0 && attendanceData.unmarked === 0) {
                
                console.log('ğŸ” æ²’æœ‰ç›´æ¥å‡ºç¼ºå‹¤è³‡æ–™ï¼Œæª¢æŸ¥å…¶ä»–æ¬„ä½...');
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²è¨˜éŒ„
                if (student.attendance_history && Array.isArray(student.attendance_history)) {
                    console.log('ğŸ“š æ‰¾åˆ°æ­·å²è¨˜éŒ„:', student.attendance_history);
                    student.attendance_history.forEach(record => {
                        if (record.status === 'present') attendanceData.present++;
                        else if (record.status === 'absent') attendanceData.absent++;
                        else if (record.status === 'late') attendanceData.late++;
                        else attendanceData.unmarked++;
                    });
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯èƒ½çš„æ¬„ä½
                if (student.records && Array.isArray(student.records)) {
                    console.log('ğŸ“‹ æ‰¾åˆ°è¨˜éŒ„è³‡æ–™:', student.records);
                    student.records.forEach(record => {
                        if (record.type === 'present' || record.attendance === 'present') attendanceData.present++;
                        else if (record.type === 'absent' || record.attendance === 'absent') attendanceData.absent++;
                        else if (record.type === 'late' || record.attendance === 'late') attendanceData.late++;
                        else attendanceData.unmarked++;
                    });
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰çµ±è¨ˆè³‡æ–™
                if (student.stats) {
                    console.log('ğŸ“ˆ æ‰¾åˆ°çµ±è¨ˆè³‡æ–™:', student.stats);
                    attendanceData.present = student.stats.present || attendanceData.present;
                    attendanceData.absent = student.stats.absent || attendanceData.absent;
                    attendanceData.late = student.stats.late || attendanceData.late;
                    attendanceData.unmarked = student.stats.unmarked || attendanceData.unmarked;
                }
                
                // å¦‚æœä»ç„¶æ²’æœ‰è³‡æ–™ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰èª²ç¨‹ç›¸é—œçš„å‡ºå¸­è¨˜éŒ„
                if (window.loadedStudentsData && window.loadedStudentsData.attendanceRecords) {
                    console.log('ğŸ“ æª¢æŸ¥èª²ç¨‹å‡ºå¸­è¨˜éŒ„...');
                    const courseRecords = window.loadedStudentsData.attendanceRecords[student.id || student.student_id];
                    if (courseRecords) {
                        console.log('ğŸ“ æ‰¾åˆ°èª²ç¨‹è¨˜éŒ„:', courseRecords);
                        courseRecords.forEach(record => {
                            if (record.status === 'present') attendanceData.present++;
                            else if (record.status === 'absent') attendanceData.absent++;
                            else if (record.status === 'late') attendanceData.late++;
                            else attendanceData.unmarked++;
                        });
                    }
                }
            }
            
            console.log('âœ… æœ€çµ‚å‡ºç¼ºå‹¤è³‡æ–™:', attendanceData);
            return attendanceData;
        }
        
        // æŸ¥è©¢å­¸ç”Ÿç¼ºå‹¤ç´€éŒ„ - ä½¿ç”¨ç¾æœ‰è³‡æ–™ç‰ˆæœ¬
        function queryStudentAttendanceRecord(studentName) {
            try {
                console.log('ğŸ” æŸ¥è©¢å­¸ç”Ÿç¼ºå‹¤ç´€éŒ„:', studentName);
                console.log('ğŸ“Š ç•¶å‰è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™:', window.loadedStudentsData);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™
                if (!window.loadedStudentsData || !window.loadedStudentsData.students) {
                    console.log('âš ï¸ æ²’æœ‰è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™');
                    showToast('âš ï¸ æ²’æœ‰è¼‰å…¥çš„å­¸ç”Ÿè³‡æ–™ï¼Œè«‹å…ˆè¼‰å…¥èª²ç¨‹å­¸ç”Ÿ', 'warning', 3000);
                    return;
                }
                
                // å¾ç¾æœ‰è³‡æ–™ä¸­æŸ¥æ‰¾å­¸ç”Ÿ
                const student = window.loadedStudentsData.students.find(s => 
                    s.name === studentName || s.student_name === studentName
                );
                
                if (!student) {
                    console.log('âš ï¸ æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™:', studentName);
                    console.log('ğŸ“‹ å¯ç”¨çš„å­¸ç”Ÿåˆ—è¡¨:', window.loadedStudentsData.students.map(s => s.name));
                    showToast(`âš ï¸ æ‰¾ä¸åˆ°å­¸ç”Ÿ "${studentName}" çš„è³‡æ–™`, 'warning', 3000);
                    return;
                }
                
                console.log('âœ… æ‰¾åˆ°å­¸ç”Ÿè³‡æ–™:', student);
                
                // å‰µå»ºæ¨¡æ…‹æ¡†
                const modal = document.createElement('div');
                modal.className = 'attendance-record-modal';
                modal.innerHTML = `
                    <div class="attendance-record-content">
                        <div class="attendance-record-header">
                            <h3 class="attendance-record-title">
                                <i class="fas fa-user-graduate"></i> ${studentName} çš„å‡ºç¼ºå‹¤ç´€éŒ„
                            </h3>
                            <button class="close-attendance-record-btn" id="closeAttendanceRecordBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="attendance-record-body">
                            <div class="student-info">
                                <div class="info-item">
                                    <span class="info-label">å­¸ç”Ÿå§“åï¼š</span>
                                    <span class="info-value">${student.name || student.student_name || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">å­¸ç”ŸIDï¼š</span>
                                    <span class="info-value">${student.id || student.student_id || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">èª²ç¨‹ï¼š</span>
                                    <span class="info-value">${window.loadedStudentsData.course || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ™‚æ®µï¼š</span>
                                    <span class="info-value">${window.loadedStudentsData.time || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ—¥æœŸï¼š</span>
                                    <span class="info-value">${window.loadedStudentsData.date || 'æœªçŸ¥'}</span>
                                </div>
                            </div>
                            
                            <div class="attendance-status">
                                <h4>å‡ºç¼ºå‹¤ç‹€æ…‹</h4>
                                <div class="status-grid">
                                    ${(() => {
                                        const attendanceData = getStudentAttendanceData(student);
                                        return `
                                            <div class="status-item present">
                                                <i class="fas fa-check-circle"></i>
                                                <span>å‡ºå¸­</span>
                                                <span class="status-count">${attendanceData.present} æ¬¡</span>
                                            </div>
                                            <div class="status-item absent">
                                                <i class="fas fa-times-circle"></i>
                                                <span>ç¼ºå¸­</span>
                                                <span class="status-count">${attendanceData.absent} æ¬¡</span>
                                            </div>
                                            <div class="status-item late">
                                                <i class="fas fa-clock"></i>
                                                <span>é²åˆ°</span>
                                                <span class="status-count">${attendanceData.late} æ¬¡</span>
                                            </div>
                                            <div class="status-item unmarked">
                                                <i class="fas fa-question-circle"></i>
                                                <span>æœªæ¨™è¨˜</span>
                                                <span class="status-count">${attendanceData.unmarked} æ¬¡</span>
                                            </div>
                                        `;
                                    })()}
                                </div>
                            </div>
                            
                            <div class="attendance-details">
                                <h4>è©³ç´°è³‡è¨Š</h4>
                                <div class="details-list">
                                    <div class="detail-item">
                                        <span class="detail-label">ç¸½å‡ºå¸­ç‡ï¼š</span>
                                        <span class="detail-value">${calculateAttendanceRate(student)}%</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">æœ€å¾Œæ›´æ–°ï¼š</span>
                                        <span class="detail-value">${new Date().toLocaleString('zh-TW')}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">è³‡æ–™ä¾†æºï¼š</span>
                                        <span class="detail-value">å·²è¼‰å…¥çš„èª²ç¨‹è³‡æ–™</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // è¨­ç½®é—œé–‰æŒ‰éˆ•èª²ç¨‹
                const closeBtn = modal.querySelector('#closeAttendanceRecordBtn');
                closeBtn.addEventListener('click', () => {
                    modal.remove();
                });
                
                // é»æ“ŠèƒŒæ™¯é—œé–‰
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                console.log('âœ… å­¸ç”Ÿç¼ºå‹¤ç´€éŒ„é¡¯ç¤ºå®Œæˆ');
                
            } catch (error) {
                console.error('æŸ¥è©¢ç¼ºå‹¤ç´€éŒ„éŒ¯èª¤:', error);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                if (modal) {
                    displayAttendanceRecordError(modal, 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }
        }

        // é¡¯ç¤ºç¼ºå‹¤ç´€éŒ„
        function displayAttendanceRecords(modal, studentName, records) {
            const content = modal.querySelector('.attendance-record-content');
            const loading = modal.querySelector('.attendance-record-loading');
            
            if (loading) {
                loading.remove();
            }
            
            const recordsList = document.createElement('div');
            recordsList.className = 'attendance-record-list';
            
            if (records.length === 0) {
                recordsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 20px;"></i>
                        <h4>æ²’æœ‰ç¼ºå‹¤ç´€éŒ„</h4>
                        <p>${studentName} çš„å‡ºå‹¤ç‹€æ³è‰¯å¥½ï¼</p>
                    </div>
                `;
            } else {
                recordsList.innerHTML = records.map(record => {
                    const statusClass = record.present ? 'present' : 'absent';
                    const statusText = record.present ? 'å‡ºå¸­' : 'ç¼ºå¸­';
                    const statusIcon = record.present ? 'fa-check-circle' : 'fa-times-circle';
                    
                    return `
                        <div class="attendance-record-item">
                            <div class="attendance-record-date">
                                <i class="fas fa-calendar-alt"></i>
                                ${new Date(record.date).toLocaleDateString('zh-TW')}
                            </div>
                            <div class="attendance-record-status ${statusClass}">
                                <i class="fas ${statusIcon}"></i>
                                ${statusText}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            content.appendChild(recordsList);
        }

        // é¡¯ç¤ºç¼ºå‹¤ç´€éŒ„éŒ¯èª¤
        function displayAttendanceRecordError(modal, errorMessage) {
            const content = modal.querySelector('.attendance-record-content');
            const loading = modal.querySelector('.attendance-record-loading');
            
            if (loading) {
                loading.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'attendance-record-error';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h4>æŸ¥è©¢å¤±æ•—</h4>
                <p>${errorMessage}</p>
            `;
            
            content.appendChild(errorDiv);
        }

        // åˆå§‹åŒ–æ‡¸æµ®é¸å–®æ»¾å‹•ç›£è½
        function initializeFloatingMenu() {
            const floatingMenu = document.getElementById('floatingStatsMenu');
            const statsText = document.getElementById('statsText');
            
            if (!floatingMenu || !statsText) return;
            
            let isFloatingVisible = false;
            let ticking = false;
            
            // æ»¾å‹•ç›£è½å‡½æ•¸
            function handleScroll() {
                if (!ticking) {
                    requestAnimationFrame(() => {
                        const statsRect = statsText.getBoundingClientRect();
                        const shouldShow = statsRect.bottom < 0; // ç•¶çµ±è¨ˆå€åŸŸæ»¾å‹•å‡ºè¦–çª—æ™‚é¡¯ç¤ºæ‡¸æµ®é¸å–®
                        
                        if (shouldShow && !isFloatingVisible) {
                            showFloatingMenu();
                            isFloatingVisible = true;
                        } else if (!shouldShow && isFloatingVisible) {
                            hideFloatingMenu();
                            isFloatingVisible = false;
                        }
                        
                        ticking = false;
                    });
                    ticking = true;
                }
            }
            
            // æ·»åŠ æ»¾å‹•ç›£è½å™¨
            window.addEventListener('scroll', handleScroll, { passive: true });
            
            // é¡¯ç¤ºæ‡¸æµ®é¸å–®
            function showFloatingMenu() {
                floatingMenu.classList.add('show');
                updateFloatingMenuContent();
            }
            
            // éš±è—æ‡¸æµ®é¸å–®
            function hideFloatingMenu() {
                floatingMenu.classList.remove('show');
            }
            
            // æ›´æ–°æ‡¸æµ®é¸å–®å…§å®¹
            function updateFloatingMenuContent() {
                const totalEventsText = document.getElementById('totalEventsText');
                const instructorCountText = document.getElementById('instructorCountText');
                const dateRangeText = document.getElementById('dateRangeText');
                
                const floatingTotalEvents = document.getElementById('floatingTotalEvents');
                const floatingInstructorCount = document.getElementById('floatingInstructorCount');
                const floatingDateRange = document.getElementById('floatingDateRange');
                
                if (totalEventsText && floatingTotalEvents) {
                    floatingTotalEvents.textContent = totalEventsText.textContent;
                }
                if (instructorCountText && floatingInstructorCount) {
                    floatingInstructorCount.textContent = instructorCountText.textContent;
                }
                if (dateRangeText && floatingDateRange) {
                    floatingDateRange.textContent = dateRangeText.textContent;
                }
            }
            
            // ç›£è½çµ±è¨ˆæ›´æ–°èª²ç¨‹
            document.addEventListener('statsUpdated', updateFloatingMenuContent);
            
            // åˆå§‹åŒ–ç¯©é¸æŒ‰éˆ•
            initializeFloatingFilterButtons();
        }
        
        // åˆå§‹åŒ–æ‡¸æµ®é¸å–®ç¯©é¸æŒ‰éˆ•
        function initializeFloatingFilterButtons() {
            const filterButtons = document.querySelectorAll('.floating-filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    
                    // æ·»åŠ é»æ“Šå‹•ç•«
                    this.classList.add('clicked');
                    setTimeout(() => {
                        this.classList.remove('clicked');
                    }, 600);
                    
                    // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active é¡åˆ¥
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // æ·»åŠ ç•¶å‰æŒ‰éˆ•çš„ active é¡åˆ¥
                    this.classList.add('active');
                    
                    // åŸ·è¡Œç¯©é¸
                    applyDateFilter(filter);
                });
            });
        }
        
        // æ‡‰ç”¨æ—¥æœŸç¯©é¸
        function applyDateFilter(filter) {
            console.log('ğŸ”„ æ‡¸æµ®é¸å–®ç¯©é¸:', filter);
            
            // æ‰¾åˆ°å°æ‡‰çš„ç¯©é¸æŒ‰éˆ•ä¸¦æ›´æ–°ç‹€æ…‹
            const filterButtons = document.querySelectorAll('.filter-btn, .floating-filter-btn');
            const targetButton = Array.from(filterButtons).find(btn => 
                btn.getAttribute('data-filter') === filter || 
                btn.textContent.trim() === filter
            );
            
            // æ›´æ–°æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
            filterButtons.forEach(btn => btn.classList.remove('active'));
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // ç›´æ¥åˆ‡æ›è¦–åœ–
            if (window.switchView) {
                console.log('ğŸ”„ åˆ‡æ›è¦–åœ–åˆ°:', filter);
                window.switchView(filter);
            }
            
            // åŸ·è¡Œç¯©é¸é‚è¼¯
            const today = new Date();
            let startDate, endDate;
            
            switch(filter) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay()); // æœ¬é€±é–‹å§‹ï¼ˆé€±æ—¥ï¼‰
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6); // æœ¬é€±çµæŸï¼ˆé€±å…­ï¼‰
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1); // æœ¬æœˆç¬¬ä¸€å¤©
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); // æœ¬æœˆæœ€å¾Œä¸€å¤©
                    break;
                case 'all':
                    // å…¨éƒ¨ï¼šæ¸…é™¤æ—¥æœŸç¯©é¸
                    startDate = null;
                    endDate = null;
                    break;
                default:
                    return;
            }
            
            // æ›´æ–°æ—¥æœŸç¯„åœç¯©é¸
            if (window.updateDateRange) {
                window.updateDateRange(startDate, endDate);
            }
            
            // è§¸ç™¼èª²ç¨‹é‡æ–°è¼‰å…¥
            if (window.loadEvents) {
                window.loadEvents();
            }
            
            // æ»¾å‹•åˆ°ç¬¬ä¸€ç­†è¡Œäº‹æ›†
            setTimeout(() => {
                const firstEvent = document.querySelector('.event-card');
                if (firstEvent) {
                    firstEvent.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }
            }, 500);
        }

        // å‹•ç•«ç®¡ç†å™¨ - å„ªåŒ–å‹•ç•«æ€§èƒ½
        class AnimationManager {
            constructor() {
                this.animations = new Map();
                this.isPageVisible = true;
                this.rafId = null;
                this.performanceMode = false;
                this.frameCount = 0;
                this.lastFpsTime = 0;
                this.fps = 60;
                this.throttleMap = new Map();
                this.init();
            }
            
            init() {
                // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
                document.addEventListener('visibilitychange', () => {
                    this.isPageVisible = !document.hidden;
                    if (this.isPageVisible) {
                        this.resumeAnimations();
                    } else {
                        this.pauseAnimations();
                    }
                });
                
                // ç›£è½è¨­å‚™æ€§èƒ½
                this.detectDevicePerformance();
            }
            
            detectDevicePerformance() {
                // æª¢æ¸¬è¨­å‚™æ€§èƒ½
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                const isLowEnd = !gl || navigator.hardwareConcurrency <= 2;
                
                // æª¢æ¸¬è¨˜æ†¶é«”ä½¿ç”¨æƒ…æ³
                const memoryInfo = performance.memory;
                const isMemoryConstrained = memoryInfo && memoryInfo.usedJSHeapSize > memoryInfo.totalJSHeapSize * 0.8;
                
                if (isLowEnd || isMemoryConstrained) {
                    console.log('ğŸ”‹ æª¢æ¸¬åˆ°ä½ç«¯è¨­å‚™æˆ–è¨˜æ†¶é«”ä¸è¶³ï¼Œå•Ÿç”¨æ€§èƒ½å„ªåŒ–æ¨¡å¼');
                    this.enablePerformanceMode();
                }
                
                // é–‹å§‹FPSç›£æ§
                this.startFpsMonitoring();
            }
            
            startFpsMonitoring() {
                const checkFps = () => {
                    this.frameCount++;
                    const now = performance.now();
                    
                    if (now - this.lastFpsTime >= 1000) {
                        this.fps = this.frameCount;
                        this.frameCount = 0;
                        this.lastFpsTime = now;
                        
                        // å¦‚æœFPSéä½ï¼Œå•Ÿç”¨æ€§èƒ½æ¨¡å¼
                        if (this.fps < 30 && !this.performanceMode) {
                            console.log(`ğŸ”‹ FPSéä½ (${this.fps})ï¼Œå•Ÿç”¨æ€§èƒ½å„ªåŒ–æ¨¡å¼`);
                            this.enablePerformanceMode();
                        }
                    }
                    
                    requestAnimationFrame(checkFps);
                };
                
                requestAnimationFrame(checkFps);
            }
            
            enablePerformanceMode() {
                this.performanceMode = true;
                // æ¸›å°‘å‹•ç•«è¤‡é›œåº¦
                document.documentElement.style.setProperty('--animation-duration', '0.2s');
                document.documentElement.style.setProperty('--transition-duration', '0.15s');
                
                // æ¸›å°‘å‹•ç•«æ•¸é‡
                this.animations.forEach((animation, id) => {
                    if (animation.interval < 32) { // ä½æ–¼30fpsçš„å‹•ç•«
                        animation.interval = 32; // é™åˆ¶åˆ°30fps
                    }
                });
            }
            
            // ç¯€æµå‡½æ•¸
            throttle(func, delay) {
                const key = func.toString();
                if (!this.throttleMap.has(key)) {
                    this.throttleMap.set(key, { lastCall: 0, timeout: null });
                }
                
                const throttleInfo = this.throttleMap.get(key);
                const now = performance.now();
                
                if (now - throttleInfo.lastCall >= delay) {
                    throttleInfo.lastCall = now;
                    return func();
                } else if (!throttleInfo.timeout) {
                    throttleInfo.timeout = setTimeout(() => {
                        throttleInfo.lastCall = performance.now();
                        throttleInfo.timeout = null;
                        func();
                    }, delay - (now - throttleInfo.lastCall));
                }
            }
            
            // é˜²æŠ–å‡½æ•¸
            debounce(func, delay) {
                const key = func.toString();
                if (!this.throttleMap.has(key)) {
                    this.throttleMap.set(key, { timeout: null });
                }
                
                const debounceInfo = this.throttleMap.get(key);
                
                if (debounceInfo.timeout) {
                    clearTimeout(debounceInfo.timeout);
                }
                
                debounceInfo.timeout = setTimeout(() => {
                    debounceInfo.timeout = null;
                    func();
                }, delay);
            }
            
            addAnimation(id, animationFn, interval = 16) {
                if (this.animations.has(id)) {
                    this.removeAnimation(id);
                }
                
                this.animations.set(id, {
                    fn: animationFn,
                    interval: interval,
                    lastTime: 0,
                    active: true
                });
                
                if (!this.rafId) {
                    this.startAnimationLoop();
                }
            }
            
            removeAnimation(id) {
                this.animations.delete(id);
                if (this.animations.size === 0 && this.rafId) {
                    cancelAnimationFrame(this.rafId);
                    this.rafId = null;
                }
            }
            
            startAnimationLoop() {
                const animate = (currentTime) => {
                    if (!this.isPageVisible) {
                        this.rafId = requestAnimationFrame(animate);
                        return;
                    }
                    
                    // æ€§èƒ½æ¨¡å¼ä¸‹çš„å„ªåŒ–
                    const skipFrame = this.performanceMode && this.fps < 45;
                    const criticalFps = this.fps < 30; // æ¥µä½FPSæ™‚æ›´åš´æ ¼çš„é™åˆ¶
                    
                    this.animations.forEach((animation, id) => {
                        if (animation.active && currentTime - animation.lastTime >= animation.interval) {
                            // æ€§èƒ½æ¨¡å¼ä¸‹è·³éæŸäº›å‹•ç•«
                            if (skipFrame && Math.random() > 0.5) {
                                return;
                            }
                            
                            // æ¥µä½FPSæ™‚è·³éæ›´å¤šå‹•ç•«
                            if (criticalFps && Math.random() > 0.3) {
                                return;
                            }
                            
                            try {
                                animation.fn(currentTime);
                                animation.lastTime = currentTime;
                                
                                // æª¢æŸ¥å‹•ç•«æ˜¯å¦æ‡‰è©²çµæŸ
                                if (animation.duration && currentTime - animation.startTime > animation.duration) {
                                    this.removeAnimation(id);
                                }
                            } catch (error) {
                                console.warn(`å‹•ç•« ${id} åŸ·è¡ŒéŒ¯èª¤:`, error);
                                this.removeAnimation(id);
                            }
                        }
                    });
                    
                    this.rafId = requestAnimationFrame(animate);
                };
                
                this.rafId = requestAnimationFrame(animate);
            }
            
            pauseAnimations() {
                this.animations.forEach(animation => {
                    animation.active = false;
                });
            }
            
            resumeAnimations() {
                this.animations.forEach(animation => {
                    animation.active = true;
                    animation.lastTime = performance.now();
                });
            }
            
            // å„ªåŒ–çš„setTimeoutæ›¿ä»£
            setTimeout(callback, delay) {
                const startTime = performance.now();
                const id = `timeout_${Date.now()}_${Math.random()}`;
                
                this.addAnimation(id, (currentTime) => {
                    if (currentTime - startTime >= delay) {
                        callback();
                        this.removeAnimation(id);
                    }
                }, 16);
                
                return id;
            }
            
            // å„ªåŒ–çš„setIntervalæ›¿ä»£
            setInterval(callback, interval) {
                const id = `interval_${Date.now()}_${Math.random()}`;
                let lastTime = performance.now();
                
                this.addAnimation(id, (currentTime) => {
                    if (currentTime - lastTime >= interval) {
                        callback();
                        lastTime = currentTime;
                    }
                }, 16);
                
                return id;
            }
            
            clearTimeout(id) {
                this.removeAnimation(id);
            }
            
            clearInterval(id) {
                this.removeAnimation(id);
            }
        }
        
        // å‰µå»ºå…¨å±€å‹•ç•«ç®¡ç†å™¨
        const animationManager = new AnimationManager();
        window.animationManager = animationManager;
        
        // APIè¼‰å…¥å„ªåŒ–ç®¡ç†å™¨ï¼ˆå…¨ç›¤å„ªåŒ–ç‰ˆï¼‰
        class APILoadingOptimizer {
            constructor() {
                this.cache = new Map();
                this.cacheTimeout = 5 * 60 * 1000; // 5åˆ†é˜ç·©å­˜
                this.requestQueue = new Map();
                this.concurrentLimit = 8; // å¢åŠ ä¸¦è¡Œè«‹æ±‚é™åˆ¶
                this.activeRequests = 0;
                this.retryDelays = [300, 600, 1200]; // å„ªåŒ–é‡è©¦å»¶é²
                this.caldavCache = new Map(); // CALDAVå°ˆç”¨å¿«å–
                this.caldavCacheTimeout = 10 * 60 * 1000; // 10åˆ†é˜CALDAVå¿«å–
                this.preloadQueue = []; // é è¼‰å…¥éšŠåˆ—
                this.connectionPool = new Map(); // é€£æ¥æ± 
                this.errorCount = new Map(); // éŒ¯èª¤è¨ˆæ•¸
                this.circuitBreaker = new Map(); // ç†”æ–·å™¨
                this.performanceMetrics = new Map(); // æ€§èƒ½æŒ‡æ¨™
            }
            
            // ç”Ÿæˆç·©å­˜éµ
            getCacheKey(endpoint, params) {
                return `${endpoint}_${JSON.stringify(params)}`;
            }
            
            // æª¢æŸ¥ç·©å­˜ï¼ˆå„ªåŒ–ç‰ˆï¼‰
            getFromCache(key) {
                const cached = this.cache.get(key);
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    console.log('ğŸ“¦ å¾ç·©å­˜è¼‰å…¥:', key);
                    return cached.data;
                }
                if (cached) {
                    this.cache.delete(key);
                }
                return null;
            }
            
            // CALDAVå°ˆç”¨å¿«å–æª¢æŸ¥
            getCaldavCache(key) {
                const cached = this.caldavCache.get(key);
                if (cached && Date.now() - cached.timestamp < this.caldavCacheTimeout) {
                    console.log('ğŸ“¦ å¾CALDAVå¿«å–è¼‰å…¥:', key);
                    return cached.data;
                }
                if (cached) {
                    this.caldavCache.delete(key);
                }
                return null;
            }
            
            // è¨­ç½®CALDAVå¿«å–
            setCaldavCache(key, data) {
                this.caldavCache.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
            }
            
            // è¨­ç½®ç·©å­˜
            setCache(key, data) {
                this.cache.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
            }
            
            // ç†”æ–·å™¨æª¢æŸ¥
            isCircuitOpen(endpoint) {
                const breaker = this.circuitBreaker.get(endpoint);
                if (!breaker) return false;
                
                const now = Date.now();
                if (now - breaker.lastFailureTime > breaker.timeout) {
                    // ç†”æ–·å™¨è¶…æ™‚ï¼Œé‡ç½®
                    this.circuitBreaker.delete(endpoint);
                    return false;
                }
                
                return breaker.failureCount >= breaker.threshold;
            }
            
            // è¨˜éŒ„éŒ¯èª¤
            recordError(endpoint) {
                const errorCount = this.errorCount.get(endpoint) || 0;
                this.errorCount.set(endpoint, errorCount + 1);
                
                if (errorCount >= 3) {
                    this.circuitBreaker.set(endpoint, {
                        failureCount: errorCount,
                        lastFailureTime: Date.now(),
                        timeout: 30000, // 30ç§’ç†”æ–·
                        threshold: 3
                    });
                }
            }
            
            // è¨˜éŒ„æˆåŠŸ
            recordSuccess(endpoint) {
                this.errorCount.delete(endpoint);
                this.circuitBreaker.delete(endpoint);
            }
            
            // æ€§èƒ½ç›£æ§
            recordPerformance(endpoint, duration) {
                if (!this.performanceMetrics.has(endpoint)) {
                    this.performanceMetrics.set(endpoint, []);
                }
                
                const metrics = this.performanceMetrics.get(endpoint);
                metrics.push(duration);
                
                // åªä¿ç•™æœ€è¿‘100æ¬¡è¨˜éŒ„
                if (metrics.length > 100) {
                    metrics.shift();
                }
            }
            
            // ç²å–å¹³å‡éŸ¿æ‡‰æ™‚é–“
            getAverageResponseTime(endpoint) {
                const metrics = this.performanceMetrics.get(endpoint);
                if (!metrics || metrics.length === 0) return 0;
                
                return metrics.reduce((sum, time) => sum + time, 0) / metrics.length;
            }
            
            // å„ªåŒ–çš„fetchè«‹æ±‚ï¼ˆCALDAVé€Ÿåº¦å„ªåŒ–ç‰ˆï¼‰
            async optimizedFetch(url, options = {}, useCache = true) {
                const cacheKey = this.getCacheKey(url, options.body);
                
                // CALDAVå°ˆç”¨å¿«å–æª¢æŸ¥
                if (url.includes('/api/events') && useCache) {
                    const caldavCached = this.getCaldavCache(cacheKey);
                    if (caldavCached) {
                        return { data: caldavCached, fromCache: true };
                    }
                }
                
                // æª¢æŸ¥ä¸€èˆ¬ç·©å­˜
                if (useCache) {
                    const cached = this.getFromCache(cacheKey);
                    if (cached) {
                        return { data: cached, fromCache: true };
                    }
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„è«‹æ±‚æ­£åœ¨é€²è¡Œ
                if (this.requestQueue.has(cacheKey)) {
                    console.log('â³ ç­‰å¾…ç›¸åŒè«‹æ±‚å®Œæˆ:', cacheKey);
                    return await this.requestQueue.get(cacheKey);
                }
                
                // å‰µå»ºæ–°çš„è«‹æ±‚Promise
                const requestPromise = this.executeRequest(url, options, cacheKey);
                this.requestQueue.set(cacheKey, requestPromise);
                
                try {
                    const result = await requestPromise;
                    
                    // CALDAVå°ˆç”¨å¿«å–è¨­ç½®
                    if (url.includes('/api/events') && result.data && result.data.success) {
                        this.setCaldavCache(cacheKey, result.data);
                    }
                    
                    return result;
                } finally {
                    this.requestQueue.delete(cacheKey);
                }
            }
            
            // åŸ·è¡Œå¯¦éš›è«‹æ±‚ï¼ˆCALDAVé€Ÿåº¦å„ªåŒ–ç‰ˆï¼‰
            async executeRequest(url, options, cacheKey) {
                // ç­‰å¾…ä¸¦è¡Œè«‹æ±‚é™åˆ¶
                while (this.activeRequests >= this.concurrentLimit) {
                    await new Promise(resolve => setTimeout(resolve, 30)); // æ¸›å°‘ç­‰å¾…æ™‚é–“
                }
                
                this.activeRequests++;
                
                try {
                    const controller = new AbortController();
                    // æ ¹æ“šè«‹æ±‚é¡å‹è¨­ç½®ä¸åŒçš„è¶…æ™‚æ™‚é–“
                    let timeout;
                    if (url.includes('/api/events')) {
                        timeout = 20000; // CALDAVè«‹æ±‚ï¼š20ç§’
                    } else if (url.includes('/api/proxy/google-sheets')) {
                        timeout = 30000; // Google Sheets APIï¼š30ç§’
                    } else {
                        timeout = 15000; // å…¶ä»–APIï¼š15ç§’
                    }
                    
                    const timeoutId = setTimeout(() => {
                        console.log(`â° APIè«‹æ±‚è¶…æ™‚: ${url}`);
                        controller.abort();
                    }, timeout);
                    
                    // å„ªåŒ–è«‹æ±‚é¸é …
                    const optimizedOptions = {
                        ...options,
                        signal: controller.signal,
                        // æ·»åŠ æ€§èƒ½å„ªåŒ–æ¨™é ­
                        headers: {
                            'Accept-Encoding': 'gzip, deflate, br',
                            'Connection': 'keep-alive',
                            'Cache-Control': 'no-cache',
                            ...options.headers
                        }
                    };
                    
                    const startTime = performance.now();
                    const response = await fetch(url, optimizedOptions);
                    const endTime = performance.now();
                    const responseTime = endTime - startTime;
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        // è¨˜éŒ„å¤±æ•—çš„APIè«‹æ±‚
                        if (window.PerformanceOptimizer) {
                            window.PerformanceOptimizer.recordApiRequest(false, responseTime);
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // è¨˜éŒ„æˆåŠŸçš„APIè«‹æ±‚
                    if (window.PerformanceOptimizer) {
                        window.PerformanceOptimizer.recordApiRequest(data.success, responseTime);
                    }
                    
                    // ç·©å­˜æˆåŠŸçš„éŸ¿æ‡‰
                    if (data.success) {
                        this.setCache(cacheKey, data);
                    }
                    
                    return { data, fromCache: false };
                    
                } catch (error) {
                    console.error('âŒ APIè«‹æ±‚å¤±æ•—:', error);
                    
                    // è©³ç´°çš„éŒ¯èª¤è™•ç†
                    if (error.name === 'AbortError') {
                        console.log('â° è«‹æ±‚è¢«ä¸­æ–·ï¼Œå¯èƒ½æ˜¯è¶…æ™‚æˆ–ç”¨æˆ¶å–æ¶ˆ');
                        // å°æ–¼AbortErrorï¼Œä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè€Œæ˜¯è¿”å›ä¸€å€‹ç‰¹æ®Šçš„éŸ¿æ‡‰
                        return {
                            data: {
                                success: false,
                                error: 'REQUEST_ABORTED',
                                message: 'è«‹æ±‚è¢«ä¸­æ–·'
                            },
                            fromCache: false
                        };
                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        console.log('ğŸŒ ç¶²è·¯é€£æ¥éŒ¯èª¤');
                        return {
                            data: {
                                success: false,
                                error: 'NETWORK_ERROR',
                                message: 'ç¶²è·¯é€£æ¥éŒ¯èª¤'
                            },
                            fromCache: false
                        };
                    } else {
                        console.log('âŒ å…¶ä»–éŒ¯èª¤:', error.message);
                        return {
                            data: {
                                success: false,
                                error: 'UNKNOWN_ERROR',
                                message: error.message
                            },
                            fromCache: false
                        };
                    }
                } finally {
                    this.activeRequests--;
                }
            }
            
            // å¸¶é‡è©¦çš„è«‹æ±‚
            async fetchWithRetry(url, options = {}, maxRetries = 3) {
                for (let attempt = 0; attempt <= maxRetries; attempt++) {
                    try {
                        const result = await this.optimizedFetch(url, options);
                        return result;
                    } catch (error) {
                        if (attempt === maxRetries) {
                            throw error;
                        }
                        
                        const delay = this.retryDelays[attempt] || 2000;
                        console.log(`ğŸ”„ è«‹æ±‚å¤±æ•—ï¼Œ${delay}mså¾Œé‡è©¦ (${attempt + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            // æ¸…ç†éæœŸç·©å­˜
            cleanExpiredCache() {
                const now = Date.now();
                for (const [key, value] of this.cache.entries()) {
                    if (now - value.timestamp > this.cacheTimeout) {
                        this.cache.delete(key);
                    }
                }
            }
            
            // é è¼‰å…¥API
            async preloadAPI(endpoint, params) {
                try {
                    const result = await this.optimizedFetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(params)
                    });
                    console.log('ğŸš€ é è¼‰å…¥å®Œæˆ:', endpoint);
                    return result;
                } catch (error) {
                    console.log('âš ï¸ é è¼‰å…¥å¤±æ•—:', endpoint, error.message);
                }
            }
            
            // CALDAVæ™ºèƒ½é è¼‰å…¥
            async preloadCaldavData() {
                try {
                    console.log('ğŸš€ é–‹å§‹CALDAVæ™ºèƒ½é è¼‰å…¥...');
                    
                    // é è¼‰å…¥ä»Šæ—¥äº‹ä»¶
                    const todayResult = await this.optimizedFetch('/api/events', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (todayResult.data && todayResult.data.success) {
                        console.log('âœ… CALDAVé è¼‰å…¥æˆåŠŸ');
                        return todayResult;
                    }
                } catch (error) {
                    console.log('âš ï¸ CALDAVé è¼‰å…¥å¤±æ•—:', error.message);
                }
            }
            
            // æ™ºèƒ½å¿«å–æ¸…ç†
            cleanExpiredCaldavCache() {
                const now = Date.now();
                for (const [key, value] of this.caldavCache.entries()) {
                    if (now - value.timestamp > this.caldavCacheTimeout) {
                        this.caldavCache.delete(key);
                    }
                }
            }
            
            // ç²å–CALDAVå¿«å–çµ±è¨ˆ
            getCaldavCacheStats() {
                return {
                    size: this.caldavCache.size,
                    keys: Array.from(this.caldavCache.keys()),
                    oldestEntry: Math.min(...Array.from(this.caldavCache.values()).map(v => v.timestamp)),
                    newestEntry: Math.max(...Array.from(this.caldavCache.values()).map(v => v.timestamp))
                };
            }
        }
        
        // å‰µå»ºå…¨å±€APIå„ªåŒ–å™¨
        const apiOptimizer = new APILoadingOptimizer();
        window.apiOptimizer = apiOptimizer;
        
        // é è¼‰å…¥å­¸ç”Ÿè³‡æ–™
        function preloadStudentData(course, time) {
            console.log('ğŸš€ é è¼‰å…¥å­¸ç”Ÿè³‡æ–™:', { course, time });
            
            // åœ¨èƒŒæ™¯é è¼‰å…¥ï¼Œä¸é˜»å¡UI
            setTimeout(() => {
                apiOptimizer.preloadAPI('/api/proxy/google-sheets', {
                    action: 'getRosterAttendance',
                    course: course,
                    period: time
                });
            }, 100);
        }
        
        // æ™ºèƒ½é è¼‰å…¥ï¼šåœ¨ç”¨æˆ¶æ‡¸åœæ™‚é è¼‰å…¥
        function addPreloadToEventCards() {
            const eventCards = document.querySelectorAll('.event-card');
            eventCards.forEach(card => {
                // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
                card.removeEventListener('mouseenter', card._preloadHandler);
                
                // æ·»åŠ æ–°çš„é è¼‰å…¥è™•ç†å™¨
                card._preloadHandler = function() {
                    const title = this.dataset.eventTitle;
                    const instructor = this.dataset.eventInstructor;
                    const start = this.dataset.eventStart;
                    const end = this.dataset.eventEnd;
                    
                    if (title && instructor && start && end) {
                        // è§£æèª²ç¨‹æ¨™é¡Œç²å–èª²ç¨‹åç¨±å’Œæ™‚é–“
                        const parsed = parseCourseTitle(title);
                        if (parsed.course && parsed.timeInfo) {
                            preloadStudentData(parsed.course, parsed.timeInfo);
                        }
                    }
                };
                
                card.addEventListener('mouseenter', card._preloadHandler);
            });
        }
        
        // å®šæœŸæ¸…ç†ç·©å­˜
        setInterval(() => {
            apiOptimizer.cleanExpiredCache();
        }, 60000); // æ¯åˆ†é˜æ¸…ç†ä¸€æ¬¡
        
        // å„ªåŒ–çš„å‹•ç•«å·¥å…·å‡½æ•¸
        function optimizedAnimate(element, keyframes, options = {}) {
            if (!element) return;
            
            // å•Ÿç”¨ç¡¬é«”åŠ é€Ÿ
            element.style.willChange = 'transform, opacity';
            element.style.transform = 'translateZ(0)';
            
            // ä½¿ç”¨åŸç”ŸWeb Animations API
            const animation = element.animate(keyframes, {
                duration: options.duration || 300,
                easing: options.easing || 'cubic-bezier(0.4, 0, 0.2, 1)',
                fill: options.fill || 'forwards',
                ...options
            });
            
            // å‹•ç•«å®Œæˆå¾Œæ¸…ç†
            animation.addEventListener('finish', () => {
                element.style.willChange = 'auto';
            });
            
            return animation;
        }
        
        // é«˜æ€§èƒ½çš„æ»¾å‹•å‹•ç•«
        function smoothScrollTo(element, targetY, duration = 500) {
            if (!element) return;
            
            const startY = element.scrollTop;
            const distance = targetY - startY;
            const startTime = performance.now();
            
            function animateScroll(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ä½¿ç”¨easeOutCubicç·©å‹•å‡½æ•¸
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const currentY = startY + (distance * easeProgress);
                
                element.scrollTop = currentY;
                
                if (progress < 1) {
                    requestAnimationFrame(animateScroll);
                }
            }
            
            requestAnimationFrame(animateScroll);
        }
        
        // ç¯€æµçš„å‹•ç•«å‡½æ•¸
        function throttledAnimate(element, keyframes, options = {}) {
            const throttleKey = `animate_${element.id || Math.random()}`;
            return animationManager.throttle(() => {
                return optimizedAnimate(element, keyframes, options);
            }, options.throttle || 16);
        }
        
        // æš´éœ²å‹•ç•«å‡½æ•¸åˆ°å…¨å±€
        window.optimizedAnimate = optimizedAnimate;
        window.smoothScrollTo = smoothScrollTo;
        window.throttledAnimate = throttledAnimate;
        window.showOptimizedLoadingAnimation = showOptimizedLoadingAnimation;
        window.hideOptimizedLoadingAnimation = hideOptimizedLoadingAnimation;
        window.showStudentLoadingState = showStudentLoadingState;
        window.hideStudentLoadingState = hideStudentLoadingState;
        
        // æ¶²æ…‹ç»ç’ƒè³ªæ„Ÿè¼‰å…¥å‹•ç•«ï¼ˆå…¨ç›¤å„ªåŒ–ç‰ˆæœ¬ï¼‰
        function showOptimizedLoadingAnimation() {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨è¼‰å…¥å‹•ç•«
            if (document.getElementById('optimized-loading-overlay')) {
                return;
            }
            
            // å„ªå…ˆä½¿ç”¨æ¨¡æ…‹æ¡†å…§å®¹ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨body
            const container = document.querySelector('.attendance-modal-content') || document.body;
            if (!container) return;
            
            // å‰µå»ºæ¶²æ…‹ç»ç’ƒè¼‰å…¥é®ç½©
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'optimized-loading-overlay';
            loadingOverlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.15) 0%, 
                    rgba(255, 255, 255, 0.05) 50%,
                    rgba(255, 255, 255, 0.1) 100%);
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                opacity: 0;
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 
                    0 8px 32px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            `;
            
            // å‰µå»ºæ¶²æ…‹ç»ç’ƒè¼‰å…¥å®¹å™¨
            const loadingContainer = document.createElement('div');
            loadingContainer.style.cssText = `
                background: linear-gradient(135deg, 
                    rgba(255, 255, 255, 0.25) 0%, 
                    rgba(255, 255, 255, 0.1) 50%,
                    rgba(255, 255, 255, 0.2) 100%);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 24px;
                padding: 40px 32px;
                box-shadow: 
                    0 12px 40px rgba(0, 0, 0, 0.15),
                    0 4px 12px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.05);
                text-align: center;
                position: relative;
                overflow: hidden;
                min-width: 280px;
                transform: scale(0.9);
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            `;
            
            // å‰µå»ºèƒŒæ™¯æµå‹•æ•ˆæœï¼ˆæ·±é‡‘è‰²ç³»ï¼‰
            const liquidBackground = document.createElement('div');
            liquidBackground.style.cssText = `
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: linear-gradient(45deg, 
                    rgba(184, 134, 11, 0.15) 0%,
                    rgba(212, 175, 55, 0.15) 25%,
                    rgba(255, 193, 7, 0.15) 50%,
                    rgba(255, 215, 0, 0.15) 75%,
                    rgba(255, 140, 0, 0.15) 100%);
                animation: liquidFlow 8s ease-in-out infinite;
                opacity: 0.7;
            `;
            
            // å‰µå»ºæ¶²æ…‹ç»ç’ƒè¼‰å…¥å™¨ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼‰
            const liquidLoader = document.createElement('div');
            liquidLoader.className = 'liquid-loader';
            liquidLoader.style.cssText = `
                width: 80px;
                height: 80px;
                margin: 0 auto 24px;
                position: relative;
                transform: translateZ(0);
                will-change: transform;
                contain: layout style paint;
            `;
            
            // å‰µå»ºå¤–å±¤æ¶²æ…‹ç’°ï¼ˆæ·±é‡‘è‰²ï¼Œæ•ˆèƒ½å„ªåŒ–ï¼‰
            const outerRing = document.createElement('div');
            outerRing.className = 'liquid-ring';
            outerRing.style.cssText = `
                width: 100%;
                height: 100%;
                border: 3px solid transparent;
                border-top: 3px solid rgba(184, 134, 11, 0.6);
                border-right: 3px solid rgba(212, 175, 55, 0.6);
                border-radius: 50%;
                animation: liquidSpin 2s linear infinite;
                position: absolute;
                top: 0;
                left: 0;
                transform: translateZ(0);
                will-change: transform;
                contain: layout style paint;
            `;
            
            // å‰µå»ºä¸­å±¤æ¶²æ…‹ç’°ï¼ˆæ·±é‡‘è‰²ï¼Œæ•ˆèƒ½å„ªåŒ–ï¼‰
            const middleRing = document.createElement('div');
            middleRing.className = 'liquid-ring';
            middleRing.style.cssText = `
                width: 70%;
                height: 70%;
                border: 2px solid transparent;
                border-bottom: 2px solid rgba(255, 193, 7, 0.7);
                border-left: 2px solid rgba(255, 215, 0, 0.7);
                border-radius: 50%;
                animation: liquidSpin 1.5s linear infinite reverse;
                position: absolute;
                top: 15%;
                left: 15%;
                transform: translateZ(0);
                will-change: transform;
                contain: layout style paint;
            `;
            
            // å‰µå»ºå…§å±¤æ¶²æ…‹ç’°ï¼ˆæ·±é‡‘è‰²ï¼Œæ•ˆèƒ½å„ªåŒ–ï¼‰
            const innerRing = document.createElement('div');
            innerRing.className = 'liquid-ring';
            innerRing.style.cssText = `
                width: 40%;
                height: 40%;
                border: 2px solid transparent;
                border-top: 2px solid rgba(255, 140, 0, 0.8);
                border-right: 2px solid rgba(184, 134, 11, 0.8);
                border-radius: 50%;
                animation: liquidSpin 1s linear infinite;
                position: absolute;
                top: 30%;
                left: 30%;
                transform: translateZ(0);
                will-change: transform;
                contain: layout style paint;
            `;
            
            // å‰µå»ºä¸­å¿ƒæ¶²æ…‹çƒï¼ˆæ·±é‡‘è‰²ï¼Œæ•ˆèƒ½å„ªåŒ–ï¼‰
            const centerBall = document.createElement('div');
            centerBall.className = 'liquid-ball';
            centerBall.style.cssText = `
                width: 16px;
                height: 16px;
                background: linear-gradient(135deg, 
                    rgba(184, 134, 11, 0.9) 0%,
                    rgba(255, 193, 7, 0.9) 50%,
                    rgba(255, 215, 0, 0.9) 100%);
                border-radius: 50%;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) translateZ(0);
                animation: liquidPulse 1.5s ease-in-out infinite;
                box-shadow: 
                    0 0 20px rgba(184, 134, 11, 0.6),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
                will-change: transform, opacity;
                contain: layout style paint;
            `;
            
            // å‰µå»ºè¼‰å…¥æ–‡å­—
            const loadingText = document.createElement('div');
            loadingText.innerHTML = `
                <div style="
                    font-size: 18px;
                    font-weight: 600;
                    color: rgba(255, 255, 255, 0.9);
                    margin-bottom: 8px;
                    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                    letter-spacing: 0.5px;
                ">è¼‰å…¥å­¸ç”Ÿè³‡æ–™ä¸­</div>
                <div style="
                    font-size: 14px;
                    color: rgba(255, 255, 255, 0.7);
                    margin-bottom: 20px;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                ">æ­£åœ¨å¾è³‡æ–™åº«è¼‰å…¥å­¸ç”Ÿåå–®...</div>
            `;
            
            // å‰µå»ºæ¶²æ…‹é€²åº¦æ¢
            const progressContainer = document.createElement('div');
            progressContainer.style.cssText = `
                width: 200px;
                height: 6px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                overflow: hidden;
                margin: 0 auto;
                position: relative;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            
            const progressFill = document.createElement('div');
            progressFill.style.cssText = `
                height: 100%;
                background: linear-gradient(90deg, 
                    rgba(184, 134, 11, 0.9) 0%,
                    rgba(255, 193, 7, 0.9) 50%,
                    rgba(255, 215, 0, 0.9) 100%);
                border-radius: 3px;
                width: 0%;
                transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                box-shadow: 0 0 10px rgba(184, 134, 11, 0.5);
            `;
            
            // å‰µå»ºé€²åº¦æ¢å…‰æ•ˆ
            const progressShimmer = document.createElement('div');
            progressShimmer.style.cssText = `
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, 
                    transparent 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    transparent 100%);
                animation: shimmer 2s ease-in-out infinite;
            `;
            
            // æ·»åŠ CSSå‹•ç•«
            const style = document.createElement('style');
            style.textContent = `
                @keyframes liquidSpin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                @keyframes liquidPulse {
                    0%, 100% { 
                        transform: translate(-50%, -50%) scale(1);
                        opacity: 0.8;
                    }
                    50% { 
                        transform: translate(-50%, -50%) scale(1.2);
                        opacity: 1;
                    }
                }
                
                @keyframes shimmer {
                    0% { transform: translateX(-100%); }
                    100% { transform: translateX(200%); }
                }
                
                @keyframes liquidFlow {
                    0%, 100% { transform: rotate(0deg) scale(1); }
                    25% { transform: rotate(90deg) scale(1.1); }
                    50% { transform: rotate(180deg) scale(1); }
                    75% { transform: rotate(270deg) scale(1.1); }
                }
            `;
            document.head.appendChild(style);
            
            // çµ„è£è¼‰å…¥å‹•ç•«
            liquidLoader.appendChild(outerRing);
            liquidLoader.appendChild(middleRing);
            liquidLoader.appendChild(innerRing);
            liquidLoader.appendChild(centerBall);
            
            progressFill.appendChild(progressShimmer);
            progressContainer.appendChild(progressFill);
            
            loadingContainer.appendChild(liquidBackground);
            loadingContainer.appendChild(liquidLoader);
            loadingContainer.appendChild(loadingText);
            loadingContainer.appendChild(progressContainer);
            
            loadingOverlay.appendChild(loadingContainer);
            container.appendChild(loadingOverlay);
            
            // é¡¯ç¤ºå‹•ç•«
            requestAnimationFrame(() => {
                loadingOverlay.style.opacity = '1';
                loadingContainer.style.transform = 'scale(1)';
            });
            
            // æ¨¡æ“¬é€²åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 12 + 3;
                if (progress > 95) progress = 95;
                progressFill.style.width = progress + '%';
            }, 300);
            
            // å­˜å„²æ¸…ç†å‡½æ•¸
            window.clearOptimizedLoading = () => {
                clearInterval(progressInterval);
                if (loadingOverlay && loadingOverlay.parentNode) {
                    loadingOverlay.style.opacity = '0';
                    loadingContainer.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        if (loadingOverlay.parentNode) {
                            loadingOverlay.parentNode.removeChild(loadingOverlay);
                        }
                    }, 500);
                }
            };
        }
        
        // éš±è—å„ªåŒ–çš„è¼‰å…¥å‹•ç•«
        function hideOptimizedLoadingAnimation() {
            if (window.clearOptimizedLoading) {
                window.clearOptimizedLoading();
                window.clearOptimizedLoading = null;
            }
        }
        
        // å„ªåŒ–çš„CSSå‹•ç•«é¡
        function addOptimizedAnimationClass(element, className, duration = 300) {
            if (!element) return;
            
            element.classList.add(className);
            
            animationManager.setTimeout(() => {
                element.classList.remove(className);
            }, duration);
        }

        // æ·»åŠ éŒ¯èª¤é é¢æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        function addErrorPageEventListeners() {
            // ä½¿ç”¨äº‹ä»¶å§”è¨—ä¾†è™•ç†å‹•æ…‹å‰µå»ºçš„æŒ‰éˆ•
            document.addEventListener('click', function(event) {
                if (event.target.id === 'error-teacher-btn' || event.target.id === 'error-teacher-btn-2') {
                    showTeacherAttendance();
                } else if (event.target.id === 'error-reload-btn' || event.target.id === 'error-reload-btn-2') {
                    location.reload();
                } else if (event.target.classList.contains('notification-close')) {
                    event.target.parentElement.parentElement.remove();
                }
            });
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œæ·»åŠ äº‹ä»¶ç›£è½å™¨
        document.addEventListener('DOMContentLoaded', addErrorPageEventListeners);
        
        // å¦‚æœé é¢å·²ç¶“è¼‰å…¥å®Œæˆï¼Œç«‹å³æ·»åŠ äº‹ä»¶ç›£è½å™¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addErrorPageEventListeners);
        } else {
            addErrorPageEventListeners();
        }

        // ç™¼é€LINEé€šçŸ¥
        async function sendLineNotification(reportData) {
            try {
                console.log('ğŸ“± ç™¼é€LINEé€šçŸ¥:', reportData);
                
                // æ§‹å»ºé€šçŸ¥è¨Šæ¯
                const modeEmoji = reportData.mode === 'è¬›å¸«æ¨¡å¼' ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ‘¨â€ğŸ“';
                const specialMark = reportData.isCustomizedCourse ? 'ğŸ·ï¸ [ç‰¹æ®Šæ¨¡å¼] ' : '';
                
                const message = `${modeEmoji} è¬›å¸«å ±è¡¨æäº¤æˆåŠŸï¼

ğŸ“… æ—¥æœŸï¼š${reportData.date}
â° æ™‚é–“ï¼š${reportData.courseTime}
ğŸ‘¨â€ğŸ« è¬›å¸«ï¼š${reportData.teacherName}
ğŸ“š èª²ç¨‹ï¼š${reportData.courseName}
ğŸ‘¥ äººæ•¸ï¼š${reportData.studentCount}äºº
ğŸ“ å…§å®¹ï¼š${specialMark}${reportData.courseContent}

âœ… å ±è¡¨å·²æˆåŠŸæäº¤åˆ°ç³»çµ±`;

                // ç™¼é€é€šçŸ¥çµ¦ç®¡ç†å“¡å’Œè¬›å¸«
                const notificationData = {
                    message: message,
                    teacherName: reportData.teacherName,
                    courseName: reportData.courseName,
                    presentStudents: [], // è¬›å¸«å ±è¡¨æ²’æœ‰å­¸ç”Ÿåå–®
                    absentStudents: [],
                    unmarkedStudents: []
                };

                // èª¿ç”¨å¾Œç«¯APIç™¼é€LINEé€šçŸ¥
                const response = await fetch('/api/student-attendance-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(notificationData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('âœ… LINEé€šçŸ¥ç™¼é€æˆåŠŸ:', result.message);
                        showToast('ğŸ“± LINEé€šçŸ¥å·²ç™¼é€', 'success', 2000);
                    } else {
                        console.log('âš ï¸ LINEé€šçŸ¥ç™¼é€å¤±æ•—:', result.message);
                        showToast('âš ï¸ LINEé€šçŸ¥ç™¼é€å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿å ±è¡¨æäº¤', 'warning', 3000);
                    }
                } else {
                    console.log('âš ï¸ LINEé€šçŸ¥APIèª¿ç”¨å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿å ±è¡¨æäº¤');
                    showToast('âš ï¸ LINEé€šçŸ¥ç™¼é€å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿å ±è¡¨æäº¤', 'warning', 3000);
                }
                
            } catch (error) {
                console.error('âŒ LINEé€šçŸ¥ç™¼é€éŒ¯èª¤:', error);
                // ä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½ï¼Œåªè¨˜éŒ„éŒ¯èª¤
            }
        }

    </script>
</body>
  </html>
