<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>講師行事曆檢視</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: rgba(44, 44, 44, 0.9);
            min-height: 100vh;
            color: rgba(51, 51, 51, 0.9);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 頂部標題區域 */
        .header {
            background: rgba(44, 44, 44, 0.9);
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
        }

        .header h1 {
            color: rgba(255, 193, 7, 1);
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex: 1;
            text-align: center;
        }

        .header-logo {
            height: 50px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }



        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

            .user-info span {
                color: rgba(51, 51, 51, 0.9);
                font-weight: 500;
            }

            .user-details {
                align-items: center;
                text-align: center;
            }

            .user-name {
                font-size: 0.9rem;
                margin-bottom: 3px;
            }

            .user-id {
                font-size: 0.7rem;
                padding: 2px 4px;
            }

            .user-info-section {
                margin-top: 20px;
                padding: 15px;
            }

            .user-info-container h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }


        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .user-name {
            color: rgba(51, 51, 51, 0.9);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .user-id {
            color: rgba(102, 102, 102, 0.8);
            font-size: 0.8rem;
            font-family: monospace;
            background: rgba(248, 249, 250, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }

        /* 用戶資訊區域 */
        .user-info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .user-info-container h3 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 15px 0;
            text-align: center;
        }

        /* 日期時間顯示區域 */
        .datetime-display {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .datetime-item {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255, 223, 102, 0.3);
            text-align: center;
        }

        .datetime-item i {
            font-size: 1.1rem;
        }

        /* 進度指示器 */
        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .step.active .step-circle {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
        }

        .step.completed .step-circle {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
        }

        .step.pending .step-circle {
            background: rgba(85, 85, 85, 0.9);
            color: rgba(255, 255, 255, 0.9);
        }

        .step-label {
            color: rgba(204, 204, 204, 0.9);
            font-size: 0.9rem;
            text-align: center;
        }

        .step.active .step-label {
            color: rgba(255, 223, 102, 0.9);
        }

        /* 主內容區域 */
        .main-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .content-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .content-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .content-header i {
            color: rgba(255, 223, 102, 0.9);
            font-size: 1.3rem;
        }

        /* 控制面板 */
        .controls {
            background: rgba(248, 249, 250, 0.9);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            font-size: 0.9rem;
        }

        select, input {
            padding: 10px 12px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: rgba(51, 51, 51, 0.9);
        }

        select:focus, input:focus {
            outline: none;
            border-color: rgba(255, 223, 102, 0.9);
            box-shadow: 0 0 0 3px rgba(255, 223, 102, 0.2);
        }

        /* 視圖按鈕組 */
        .view-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
        }

        .btn-primary {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-primary:hover {
            background: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 223, 102, 0.3);
        }

        .btn-primary.active {
            background: rgba(255, 193, 7, 1);
            border-color: rgba(255, 193, 7, 1);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5);
            transform: translateY(-2px);
            font-weight: 700;
        }

        .btn-primary.active::after {
            content: '✓';
            position: absolute;
            top: -5px;
            right: -5px;
            background: rgba(255, 255, 255, 1);
            color: rgba(255, 193, 7, 1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid rgba(255, 193, 7, 1);
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.9);
            color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(108, 117, 125, 0.9);
        }

        .btn-secondary:hover {
            background: rgba(90, 98, 104, 0.9);
            border-color: rgba(90, 98, 104, 0.9);
            transform: translateY(-1px);
        }

        .btn-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* 統計區域 */
        .stats {
            background: rgba(248, 249, 250, 0.9);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-item h3 {
            font-size: 1.5rem;
            margin: 0 0 5px 0;
            font-weight: 700;
            color: rgba(255, 193, 7, 1);
        }

        .stat-item p {
            font-size: 0.85rem;
            color: rgba(51, 51, 51, 0.9);
            margin: 0;
            font-weight: 500;
        }

        .events-container {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr;
        }

        .event-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(233, 236, 239, 0.9);
            transition: all 0.3s ease;
            position: relative;
        }

        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .event-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: rgba(255, 223, 102, 0.9);
            border-radius: 2px 0 0 2px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 5px;
        }

        .event-instructor {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(255, 255, 255, 0.95);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(102, 102, 102, 0.9);
            font-size: 0.9rem;
        }

        .event-detail i {
            width: 20px;
            color: rgba(255, 223, 102, 0.9);
            text-align: center;
        }

        .event-description {
            background: rgba(248, 249, 250, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid rgba(255, 223, 102, 0.9);
        }

        .event-description h4 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: 600;
        }

        .event-description p {
            color: rgba(102, 102, 102, 0.9);
            line-height: 1.5;
            font-size: 0.9rem;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .lesson-section {
            margin-top: 15px;
        }

        .lesson-label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .lesson-button {
            display: inline-block;
            background: rgba(255, 223, 102, 0.9);
            color: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .lesson-button:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .no-events i {
            font-size: 4rem;
            color: rgba(255, 223, 102, 0.9);
            margin-bottom: 20px;
        }

        .no-events h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: rgba(51, 51, 51, 0.9);
        }

        .no-events p {
            font-size: 1.1rem;
            color: rgba(102, 102, 102, 0.9);
        }

        /* 設置畫面樣式 */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .settings-modal {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(240, 240, 240, 0.9);
        }

        .settings-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .close-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            transform: scale(1.1);
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .color-picker-item label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            min-width: 80px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .instructor-color-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .instructor-color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .instructor-color-item label {
            font-size: 0.9rem;
            color: rgba(51, 51, 51, 0.9);
            min-width: 60px;
            font-weight: 600;
        }

        .instructor-color-picker {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .instructor-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .instructor-color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .save-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .save-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
                max-width: 100%;
                overflow-x: hidden;
            }

            .header {
                padding: 12px;
                margin-bottom: 12px;
            }

            .header h1 {
                font-size: 1.4rem;
                line-height: 1.2;
            }

            .header-logo {
                height: 35px;
            }

            .header-left {
                gap: 8px;
                justify-content: center;
                text-align: center;
            }


            .control-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .control-group {
                width: 100%;
            }

            .control-group label {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }

            .control-group select,
            .control-group input {
                padding: 8px;
                font-size: 0.9rem;
                border-radius: 6px;
            }

            .view-buttons {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                width: 100%;
            }

            .btn-primary {
                padding: 8px 4px;
                font-size: 0.75rem;
                text-align: center;
                min-height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .events-container {
                gap: 8px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-header {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                margin-bottom: 12px;
            }

            .event-title {
                font-size: 1rem;
                line-height: 1.3;
                word-wrap: break-word;
            }

            .event-instructor {
                padding: 4px 8px;
                font-size: 0.8rem;
                align-self: flex-start;
            }

            .event-details {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-bottom: 12px;
            }

            .event-detail {
                font-size: 0.8rem;
                padding: 4px 0;
            }

            .event-detail i {
                margin-right: 6px;
                width: 14px;
            }

            .event-description {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 6px;
            }

            .event-description h4 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }

            .event-description p {
                font-size: 0.8rem;
                line-height: 1.4;
                word-wrap: break-word;
            }

            .lesson-button {
                padding: 6px 12px;
                font-size: 0.8rem;
                border-radius: 6px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .stat-item {
                padding: 8px 6px;
                border-radius: 6px;
            }

            .stat-item h3 {
                font-size: 1.1rem;
                margin-bottom: 4px;
            }

            .stat-item p {
                font-size: 0.7rem;
                line-height: 1.2;
            }

            .settings-modal {
                width: 95%;
                padding: 16px;
                margin: 10px auto;
            }

            .color-picker-group {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .instructor-color-group {
                grid-template-columns: 1fr;
            }

            .datetime-display {
                flex-direction: column;
                gap: 6px;
                justify-content: center;
                align-items: center;
            }

            .datetime-item {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .progress-steps {
                gap: 8px;
                margin: 12px 0;
                justify-content: center;
            }

            .progress-step {
                font-size: 0.7rem;
                padding: 6px 8px;
            }
        }

        /* 超小屏幕響應式設計 */
        @media (max-width: 480px) {
            .container {
                padding: 6px;
            }

            .header {
                padding: 8px;
                margin-bottom: 8px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .header-logo {
                height: 30px;
            }

            .header-left {
                justify-content: center;
                text-align: center;
            }


            .control-group label {
                font-size: 0.8rem;
            }

            .control-group select,
            .control-group input {
                padding: 6px;
                font-size: 0.85rem;
            }

            .view-buttons {
                gap: 4px;
            }

            .btn-primary {
                padding: 6px 2px;
                font-size: 0.7rem;
                min-height: 32px;
            }

            .events-container {
                gap: 6px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 10px;
                margin-bottom: 6px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-title {
                font-size: 0.9rem;
            }

            .event-instructor {
                padding: 3px 6px;
                font-size: 0.75rem;
            }

            .event-detail {
                font-size: 0.75rem;
            }

            .event-description {
                padding: 8px;
            }

            .event-description h4 {
                font-size: 0.85rem;
            }

            .event-description p {
                font-size: 0.75rem;
            }

            .lesson-button {
                padding: 5px 10px;
                font-size: 0.75rem;
            }

            .stat-item {
                padding: 6px 4px;
            }

            .stat-item h3 {
                font-size: 1rem;
            }

            .stat-item p {
                font-size: 0.65rem;
            }

            .datetime-item {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .progress-step {
                font-size: 0.65rem;
                padding: 4px 6px;
            }

            .user-info-section {
                margin-top: 15px;
                padding: 12px;
            }

            .user-info-container h3 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
        }

        /* 載入動畫樣式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 44, 44, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loading-container {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 223, 102, 0.3);
            border-top: 4px solid rgba(255, 223, 102, 0.9);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text h3 {
            color: rgba(255, 223, 102, 0.9);
            font-size: 1.5rem;
            margin: 0 0 10px 0;
            font-weight: 600;
        }

        .loading-text p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            margin: 0;
        }

        /* 馬卡龍配色變數 */
        :root {
            --esm-color: #ff6b9d;
            --spm-color: #2c3e50;
            --boost-color: #74b9ff;
            --spike-color: #fdcb6e;
            --ev3-color: #e17055;
            --minecraft-color: #00b894;
        }

        /* 教案按鈕顏色 */
        .lesson-button.esm {
            background: linear-gradient(135deg, var(--esm-color) 0%, #ff8fab 100%);
        }

        .lesson-button.spm {
            background: linear-gradient(135deg, var(--spm-color) 0%, #34495e 100%);
        }

        .lesson-button.boost {
            background: linear-gradient(135deg, var(--boost-color) 0%, #a29bfe 100%);
        }

        .lesson-button.spike {
            background: linear-gradient(135deg, var(--spike-color) 0%, #fdcb6e 100%);
        }

        .lesson-button.ev3 {
            background: linear-gradient(135deg, var(--ev3-color) 0%, #fd79a8 100%);
        }

        .lesson-button.minecraft {
            background: linear-gradient(135deg, var(--minecraft-color) 0%, #55efc4 100%);
        }

        /* 講師底色 */
        .event-instructor.custom-color {
            background: var(--instructor-color) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }
    </style>
</head>
<body>
    <!-- 載入動畫 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                <h3>載入中...</h3>
                <p>正在初始化系統，請稍候</p>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- 頂部標題區域 -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <img src="logo.jpg" alt="FLB Logo" class="header-logo">
                    <div>
                        <h1>FLB講師行事曆檢視系統</h1>
                        <p class="header-subtitle">即時查看所有講師的行程安排</p>
                    </div>
                </div>
        </div>

            <!-- 日期時間顯示 -->
            <div class="datetime-display">
                <div class="datetime-item">
                    <i class="fas fa-calendar"></i>
                    <span id="currentDate">2025年01月16日 星期四</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime">13:58:43</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-calendar-week"></i>
                    <span id="currentWeek">2025年第3週</span>
                </div>
            </div>
            
            <!-- 進度指示器 -->
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-circle">1</div>
                    <div class="step-label">選擇講師</div>
                </div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">查看行事曆</div>
                </div>
                <div class="step pending">
                    <div class="step-circle">3</div>
                    <div class="step-label">管理行程</div>
                </div>
            </div>
        </div>

        <!-- 主內容區域 -->
        <div class="main-content">
            <div class="content-header">
                <i class="fas fa-calendar-alt"></i>
                <h2>講師行事曆檢視</h2>
            </div>

            <!-- 控制面板 -->
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="instructorSelect">選擇講師</label>
                    <select id="instructorSelect">
                        <option value="">全部講師</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="timeFilter">時段篩選</label>
                        <select id="timeFilter">
                            <option value="">全部時段</option>
                            <option value="morning">早上 (06:00-12:00)</option>
                            <option value="afternoon">下午 (12:00-18:00)</option>
                            <option value="evening">晚上 (18:00-24:00)</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="dateFilter">指定日期</label>
                        <input type="date" id="dateFilter" />
                </div>
                <div class="control-group">
                        <label for="sortOrder">排序方式</label>
                        <select id="sortOrder">
                            <option value="time">按時間排序</option>
                            <option value="instructor">按講師排序</option>
                            <option value="title">按標題排序</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <div class="view-buttons">
                            <button class="btn btn-primary active" data-view="today">今日</button>
                            <button class="btn btn-primary" data-view="week">本週</button>
                            <button class="btn btn-primary" data-view="month">本月</button>
                            <button class="btn btn-primary" data-view="all">全部</button>
                        </div>
                </div>
            </div>
        </div>

            <!-- 統計區域 -->
        <div class="stats" id="statsContainer">
            <div class="stats-grid">
                <div class="stat-item">
                    <h3 id="totalEvents">0</h3>
                    <p>總事件數</p>
                </div>
                <div class="stat-item">
                    <h3 id="instructorCount">0</h3>
                    <p>講師數量</p>
                </div>
                <div class="stat-item">
                    <h3 id="dateRange">-</h3>
                    <p>日期範圍</p>
                </div>
            </div>
        </div>

            <!-- 事件列表 -->
        <div class="events-container" id="eventsContainer">
            <div class="no-events">
                <i class="fas fa-calendar-times"></i>
                <h3>載入中...</h3>
                <p>正在獲取行事曆資料</p>
                </div>
            </div>

            <!-- 用戶資訊區域 -->
            <div class="user-info-section" id="userInfoGroup" style="display: block;">
                <div class="user-info-container">
                    <h3>LINE 用戶資訊</h3>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="userDisplayName">未綁定</div>
                            <div class="user-id" id="userDisplayId" style="display: none;"></div>
                        </div>
                        <button class="btn btn-secondary" id="bindUserBtn">綁定帳號</button>
                        <button class="btn btn-primary" id="testUserBtn" style="margin-left: 10px;">測試用戶</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設置畫面 -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <h2><i class="fas fa-palette"></i> 顏色設置</h2>
                <button class="close-settings" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="settings-section">
                <h3>教案類型顏色</h3>
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label>ESM</label>
                        <input type="color" class="color-picker" id="esmColor" value="#ff6b9d">
                    </div>
                    <div class="color-picker-item">
                        <label>SPM</label>
                        <input type="color" class="color-picker" id="spmColor" value="#2c3e50">
                    </div>
                    <div class="color-picker-item">
                        <label>BOOST</label>
                        <input type="color" class="color-picker" id="boostColor" value="#74b9ff">
                    </div>
                    <div class="color-picker-item">
                        <label>SPIKE</label>
                        <input type="color" class="color-picker" id="spikeColor" value="#fdcb6e">
                    </div>
                    <div class="color-picker-item">
                        <label>EV3</label>
                        <input type="color" class="color-picker" id="ev3Color" value="#e17055">
                    </div>
                    <div class="color-picker-item">
                        <label>MINECRAFT</label>
                        <input type="color" class="color-picker" id="minecraftColor" value="#00b894">
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>講師底色設置</h3>
                <div class="color-picker-group" id="instructorColorGroup">
                    <!-- 講師顏色設置將由 JavaScript 動態生成 -->
                </div>
            </div>

            <button class="save-settings" onclick="saveSettings()">
                <i class="fas fa-save"></i> 儲存設置
            </button>
        </div>
    </div>

    <script>
        // 全域變數
        let allEvents = [];
        let allInstructors = [];
        let currentView = 'today';
        let currentUser = null;
        let colorSettings = {
            esm: 'rgba(255, 182, 193, 0.8)',
            spm: 'rgba(116, 185, 255, 0.8)',
            boost: 'rgba(116, 185, 255, 0.8)',
            spike: 'rgba(255, 223, 102, 0.8)',
            ev3: 'rgba(180, 167, 214, 0.8)',
            minecraft: 'rgba(0, 184, 148, 0.8)'
        };
        let instructorColors = {};

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成，開始初始化...');
            
            // 顯示載入動畫
            showLoadingAnimation();
            
            // 設置事件監聽器
            setupEventListeners();
            
            // 初始化系統
            initializeSystem();
            
            // 備用初始化機制（10秒後強制完成）
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay && loadingOverlay.style.display !== 'none') {
                    console.warn('強制完成初始化，避免載入動畫卡住');
                    hideLoadingAnimation();
                }
            }, 10000);
        });

        // 顯示載入動畫
        function showLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }
        }

        // 隱藏載入動畫
        function hideLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            if (mainContainer) {
                mainContainer.style.display = 'block';
            }
        }

        // 初始化系統
        async function initializeSystem() {
            try {
                console.log('開始初始化系統...');
                
                // 載入設定
                loadSettings();
                
                // 更新日期時間
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                // 並行執行LIFF初始化和載入行事曆資料
                const initPromises = [
                    initLineUser().catch(error => {
                        console.error('LIFF 初始化失敗:', error);
                        return Promise.resolve();
                    }),
                    loadEvents().catch(error => {
                        console.error('載入行事曆資料失敗:', error);
                        return Promise.resolve();
                    })
                ];
                
                // 等待所有初始化完成，最多等待8秒
                await Promise.race([
                    Promise.all(initPromises),
                    new Promise(resolve => setTimeout(resolve, 8000))
                ]);
                
                console.log('所有初始化任務完成，準備隱藏載入動畫...');
                
                // 隱藏載入動畫
                setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('系統初始化完成');
                        
                        // 在系統初始化完成後執行自動比對
                        if (currentUser && currentUser.userId && currentUser.displayName) {
                            console.log('=== 系統初始化完成，開始自動比對講師 ===');
                            console.log('用戶資料:', currentUser);
                            
                            try {
                                autoMatchTeacher(currentUser.userId, currentUser.displayName);
                            } catch (error) {
                                console.error('自動比對講師失敗:', error);
                            }
                        } else {
                            console.log('沒有用戶資料，跳過自動比對');
                        }
                    } catch (error) {
                        console.error('隱藏載入動畫或自動比對失敗:', error);
                    }
                }, 1000); // 至少顯示1秒載入動畫
                
            } catch (error) {
                console.error('系統初始化失敗:', error);
                // 即使失敗也要隱藏載入動畫
                setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('系統初始化失敗，但已隱藏載入動畫');
                    } catch (hideError) {
                        console.error('隱藏載入動畫失敗:', hideError);
                    }
                }, 1000);
            }
        }

        // 更新日期時間顯示
        function updateDateTime() {
            const now = new Date();
            
            // 更新日期
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', dateOptions);
            
            // 更新時間
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW', timeOptions);
            
            // 更新週數
            const weekNumber = getWeekNumber(now);
            document.getElementById('currentWeek').textContent = `${now.getFullYear()}年第${weekNumber}週`;
        }

        // 獲取週數
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // LINE UserID 相關函數
        async function initLineUser() {
            console.log('開始初始化LINE用戶...');
            console.log('當前URL:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
            
            return new Promise((resolve) => {
                // 設置超時保護（5秒）
                const timeout = setTimeout(() => {
                    console.warn('LIFF 初始化超時，顯示綁定按鈕');
                    showBindButton();
                    resolve();
                }, 5000);
                
                // 檢查是否在LINE環境中
                if (typeof liff !== 'undefined') {
                    console.log('LIFF SDK 已載入');
                    
                    // 初始化LIFF - 這裡需要您的LIFF ID
                    liff.init({
                        liffId: '1657746214-qp0y8NwZ', // 請替換為您的LIFF ID
                        withLoginOnExternalBrowser: true
                    }).then(() => {
                        console.log('LIFF 初始化成功');
                        console.log('是否在LINE客戶端:', liff.isInClient());
                        console.log('是否已登入:', liff.isLoggedIn());
                        
                        if (liff.isLoggedIn()) {
                            console.log('用戶已登入，獲取用戶資料...');
                            liff.getProfile().then(profile => {
                                clearTimeout(timeout);
                                console.log('獲取到用戶資料:', profile);
                                currentUser = {
                                    userId: profile.userId,
                                    displayName: profile.displayName,
                                    pictureUrl: profile.pictureUrl
                                };
                                updateUserDisplay();
                                console.log('updateUserDisplay() 執行完成');
                                
                                // 添加手動測試按鈕
                                addManualTestButton(profile.userId, profile.displayName);
                                
                                // 將自動比對移到系統初始化完成後執行
                                console.log('準備在系統初始化完成後執行自動比對');
                                
                                resolve();
                            }).catch(error => {
                                console.error('獲取用戶資料失敗:', error);
                                clearTimeout(timeout);
                                showBindButton();
                                resolve();
                            });
                        } else {
                            console.log('用戶未登入，顯示綁定按鈕');
                            clearTimeout(timeout);
                            showBindButton();
                            resolve();
                        }
                    }).catch(error => {
                        console.error('LIFF 初始化失敗:', error);
                        clearTimeout(timeout);
                        showBindButton();
                        resolve();
                    });
                    
                } else {
                    clearTimeout(timeout);
                    console.log('LIFF SDK 未載入，顯示綁定按鈕');
                    showBindButton();
                    resolve();
                }
            });
        }

        function updateUserDisplay() {
            console.log('更新用戶顯示，當前用戶:', currentUser);
            
            try {
                const userInfoGroup = document.getElementById('userInfoGroup');
                const userDisplayName = document.getElementById('userDisplayName');
                const userDisplayId = document.getElementById('userDisplayId');
                const bindUserBtn = document.getElementById('bindUserBtn');
                
                if (!userInfoGroup || !userDisplayName || !userDisplayId || !bindUserBtn) {
                    console.error('找不到用戶資訊元素');
                    return;
                }
                
                if (currentUser) {
                    console.log('顯示用戶資訊:', currentUser.displayName, currentUser.userId);
                    
                    try {
                        userDisplayName.textContent = currentUser.displayName;
                        console.log('設置用戶名稱完成');
                    } catch (error) {
                        console.error('設置用戶名稱失敗:', error);
                    }
                    
                    try {
                        userDisplayId.textContent = `ID: ${currentUser.userId}`;
                        console.log('設置用戶ID完成');
                    } catch (error) {
                        console.error('設置用戶ID失敗:', error);
                    }
                    
                    try {
                        userDisplayId.style.display = 'block';
                        console.log('設置ID顯示完成');
                    } catch (error) {
                        console.error('設置ID顯示失敗:', error);
                    }
                    
                    try {
                        bindUserBtn.textContent = '重新綁定';
                        console.log('設置按鈕文字完成');
                    } catch (error) {
                        console.error('設置按鈕文字失敗:', error);
                    }
                    
                    try {
                        userInfoGroup.style.display = 'block';
                        console.log('設置用戶資訊組顯示完成');
                    } catch (error) {
                        console.error('設置用戶資訊組顯示失敗:', error);
                    }
                } else {
                    console.log('顯示未綁定狀態');
                    userDisplayName.textContent = '未綁定';
                    userDisplayId.style.display = 'none';
                    bindUserBtn.textContent = '綁定帳號';
                    userInfoGroup.style.display = 'block';
                }
                console.log('updateUserDisplay 函數執行完成');
            } catch (error) {
                console.error('updateUserDisplay 函數執行錯誤:', error);
            }
        }

        function showBindButton() {
            updateUserDisplay();
        }

        function bindUser() {
            console.log('用戶點擊綁定按鈕');
            
            if (typeof liff !== 'undefined') {
                try {
                    if (liff.isLoggedIn()) {
                        console.log('用戶已登入，獲取用戶資料');
                        liff.getProfile().then(profile => {
                            console.log('獲取到用戶資料:', profile);
                            currentUser = {
                                userId: profile.userId,
                                displayName: profile.displayName,
                                pictureUrl: profile.pictureUrl
                            };
                            updateUserDisplay();
                            
                            // 自動比對講師
                            console.log('準備執行自動比對講師...');
                            autoMatchTeacher(profile.userId, profile.displayName);
                        }).catch(error => {
                            console.error('獲取用戶資料失敗:', error);
                            alert('獲取用戶資料失敗，請重試');
                        });
                    } else {
                        console.log('用戶未登入，嘗試登入');
                        // 這會觸發LINE的授權流程
                        liff.login().catch(error => {
                            console.error('登入失敗:', error);
                            alert('登入失敗，請重試');
                        });
                    }
                } catch (error) {
                    console.error('LIFF 操作異常:', error);
                    alert('綁定失敗，請重試');
                }
            } else {
                console.log('LIFF SDK 未載入');
                alert('請在LINE應用程式中開啟此頁面');
            }
        }

        // 自動比對講師
        async function autoMatchTeacher(userId, displayName) {
            console.log('開始自動比對講師...', { userId, displayName });
            console.log('函數被調用，參數:', { userId, displayName });
            
            // 在頁面上顯示比對過程
            showMatchingProcess('開始比對講師...', 'info');
            
            try {
                console.log('準備調用Google Apps Script API...');
                showMatchingProcess('正在調用Google Apps Script API...', 'info');
                
                // 調用Google Apps Script API
                const response = await fetch('https://script.google.com/macros/s/AKfycbyDKCdRNc7oulsTOfvb9v2xW242stGb1Ckl4TmsrZHfp8JJQU7ZP6dUmi8ty_M1WSxboQ/exec?action=listBindings&limit=50&offset=0', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    redirect: 'follow'  // 自動跟隨重定向
                });
                
                console.log('API回應狀態:', response.status);
                console.log('API回應OK:', response.ok);
                showMatchingProcess(`API回應狀態: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`API請求失敗: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API回應:', data);
                showMatchingProcess('API回應成功，開始比對講師...', 'success');
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    showMatchingProcess(`找到 ${data.data.length} 個講師，開始比對...`, 'info');
                    
                    // 顯示比對過程
                    showMatchingProcess(`比對條件: UserID=${userId}, DisplayName=${displayName}`, 'info');
                    
                    // 尋找匹配的講師
                    const matchedTeacher = data.data.find(teacher => {
                        // 精確比對userId（不區分大小寫）
                        if (teacher.userId && userId && teacher.userId.toLowerCase() === userId.toLowerCase()) {
                            showMatchingProcess(`✅ 精確匹配UserID: ${teacher.userId}`, 'success');
                            return true;
                        }
                        // 模糊比對teacherName與displayName（不區分大小寫）
                        if (teacher.teacherName && displayName) {
                            const teacherName = teacher.teacherName.toLowerCase().trim();
                            const userName = displayName.toLowerCase().trim();
                            
                            // 完全匹配（不區分大小寫）
                            if (teacherName === userName) {
                                showMatchingProcess(`✅ 完全匹配名稱: ${teacher.teacherName}`, 'success');
                                return true;
                            }
                            
                            // 包含匹配（不區分大小寫）
                            if (teacherName.includes(userName) || userName.includes(teacherName)) {
                                showMatchingProcess(`✅ 包含匹配: ${teacher.teacherName}`, 'success');
                                return true;
                            }
                            
                            // 部分匹配（至少3個字符，不區分大小寫）
                            if (teacherName.length >= 3 && userName.length >= 3) {
                                const commonChars = [...teacherName].filter(char => userName.includes(char)).length;
                                const similarity = commonChars / Math.max(teacherName.length, userName.length);
                                if (similarity >= 0.6) { // 60%相似度
                                    showMatchingProcess(`✅ 相似度匹配: ${teacher.teacherName} (${Math.round(similarity * 100)}%)`, 'success');
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                    
                    if (matchedTeacher) {
                        console.log('找到匹配的講師:', matchedTeacher);
                        showMatchingProcess(`🎉 找到匹配講師: ${matchedTeacher.teacherName}`, 'success');
                        
                        // 自動選擇講師
                        const instructorSelect = document.getElementById('instructorFilter');
                        if (instructorSelect) {
                            // 尋找對應的選項
                            for (let option of instructorSelect.options) {
                                if (option.value === matchedTeacher.teacherName) {
                                    instructorSelect.value = matchedTeacher.teacherName;
                                    console.log('自動選擇講師:', matchedTeacher.teacherName);
                                    
                                    // 觸發篩選更新
                                    instructorSelect.dispatchEvent(new Event('change'));
                                    
                                    // 跳轉到第二步驟
                                    showStep(2);
                                    
                                    showMatchingProcess(`✅ 自動選擇講師成功: ${matchedTeacher.teacherName}`, 'success');
                                    return;
                                }
                            }
                        }
                        
                        console.log('未找到對應的講師選項');
                        showMatchingProcess(`⚠️ 找到匹配講師但未在列表中: ${matchedTeacher.teacherName}`, 'warning');
                    } else {
                        console.log('未找到匹配的講師');
                        showMatchingProcess('❌ 未找到匹配的講師，請手動選擇', 'error');
                    }
                } else {
                    console.error('API回應格式錯誤:', data);
                    showMatchingProcess('❌ API回應格式錯誤', 'error');
                }
            } catch (error) {
                console.error('自動比對講師失敗:', error);
                showMatchingProcess(`❌ 自動比對失敗: ${error.message}`, 'error');
            }
        }

        // 顯示比對過程
        function showMatchingProcess(message, type = 'info') {
            console.log(`[比對過程] ${message}`);
            
            // 創建或更新比對過程顯示區域
            let processDiv = document.getElementById('matchingProcess');
            if (!processDiv) {
                processDiv = document.createElement('div');
                processDiv.id = 'matchingProcess';
                processDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    width: 300px;
                    max-height: 400px;
                    overflow-y: auto;
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 15px;
                    border-radius: 8px;
                    font-size: 12px;
                    z-index: 10000;
                    border: 2px solid #333;
                `;
                document.body.appendChild(processDiv);
            }
            
            // 添加新消息
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin: 5px 0;
                padding: 5px;
                border-radius: 4px;
                background: ${type === 'success' ? 'rgba(0, 255, 0, 0.2)' : 
                           type === 'error' ? 'rgba(255, 0, 0, 0.2)' : 
                           type === 'warning' ? 'rgba(255, 255, 0, 0.2)' : 
                           'rgba(0, 100, 255, 0.2)'};
                border-left: 3px solid ${type === 'success' ? '#0f0' : 
                                    type === 'error' ? '#f00' : 
                                    type === 'warning' ? '#ff0' : 
                                    '#00f'};
            `;
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            processDiv.appendChild(messageDiv);
            
            // 滾動到底部
            processDiv.scrollTop = processDiv.scrollHeight;
            
            // 限制顯示的消息數量
            const messages = processDiv.querySelectorAll('div');
            if (messages.length > 20) {
                messages[0].remove();
            }
        }

        // 添加手動測試按鈕
        function addManualTestButton(userId, displayName) {
            // 檢查是否已經有測試按鈕
            if (document.getElementById('manualTestBtn')) {
                return;
            }
            
            const testBtn = document.createElement('button');
            testBtn.id = 'manualTestBtn';
            testBtn.textContent = '手動測試比對';
            testBtn.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                padding: 10px 15px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                z-index: 10001;
                font-size: 14px;
            `;
            
            testBtn.addEventListener('click', () => {
                showMatchingProcess('手動觸發比對測試...', 'info');
                autoMatchTeacher(userId, displayName);
            });
            
            document.body.appendChild(testBtn);
        }

        // 顯示指定步驟
        function showStep(stepNumber) {
            console.log('跳轉到步驟:', stepNumber);
            
            // 更新步驟狀態
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed', 'pending');
                
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
            
            // 根據步驟顯示/隱藏相關內容
            if (stepNumber === 2) {
                // 第二步：查看行事曆 - 確保行事曆區域可見
                const calendarSection = document.querySelector('.calendar-section');
                if (calendarSection) {
                    calendarSection.style.display = 'block';
                }
                
                // 滾動到行事曆區域
                setTimeout(() => {
                    calendarSection?.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        }

        function testUser() {
            console.log('用戶點擊測試按鈕');
            
            const testUserId = prompt('請輸入測試用戶ID:', 'U1234567890abcdef');
            const testDisplayName = prompt('請輸入測試用戶名稱:', '測試用戶');
            
            if (testUserId && testDisplayName) {
                currentUser = {
                    userId: testUserId,
                    displayName: testDisplayName,
                    pictureUrl: null
                };
                updateUserDisplay();
                
                // 自動比對講師
                autoMatchTeacher(testUserId, testDisplayName);
            }
        }

        // 設置事件監聽器
        function setupEventListeners() {
            document.getElementById('instructorSelect').addEventListener('change', function() {
                updateStats();
                renderEvents();
            });
            
            // 時段篩選事件監聽器
            document.getElementById('timeFilter').addEventListener('change', function() {
                updateStats();
                renderEvents();
            });
            
            // 日期篩選事件監聽器
            document.getElementById('dateFilter').addEventListener('change', function() {
                updateStats();
                renderEvents();
            });
            
            // 排序方式事件監聽器
            document.getElementById('sortOrder').addEventListener('change', function() {
                renderEvents();
            });
            
            // 為視圖按鈕添加事件監聽器
            document.querySelectorAll('.view-buttons .btn-primary').forEach(button => {
                button.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    switchView(view);
                });
            });
            
            // 綁定用戶按鈕事件監聽器
            document.getElementById('bindUserBtn').addEventListener('click', bindUser);
            
            // 測試用戶按鈕事件監聽器
            document.getElementById('testUserBtn').addEventListener('click', testUser);
        }

        // 生成隨機馬卡龍顏色
        function generateRandomMacaronColor() {
            const macaronColors = [
                'rgba(255, 182, 193, 0.8)', 'rgba(116, 185, 255, 0.8)', 'rgba(255, 223, 102, 0.8)', 
                'rgba(180, 167, 214, 0.8)', 'rgba(0, 184, 148, 0.8)', 'rgba(255, 192, 203, 0.8)',
                'rgba(162, 155, 254, 0.8)', 'rgba(85, 239, 196, 0.8)', 'rgba(255, 118, 117, 0.8)', 
                'rgba(108, 92, 231, 0.8)', 'rgba(232, 67, 147, 0.8)', 'rgba(0, 206, 201, 0.8)',
                'rgba(255, 159, 67, 0.8)', 'rgba(255, 107, 107, 0.8)', 'rgba(46, 204, 113, 0.8)',
                'rgba(155, 89, 182, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(241, 196, 15, 0.8)'
            ];
            return macaronColors[Math.floor(Math.random() * macaronColors.length)];
        }

        // 載入設置
        function loadSettings() {
            const saved = localStorage.getItem('calendarSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                colorSettings = { ...colorSettings, ...settings.colors };
                instructorColors = settings.instructorColors || {};
                applyColorSettings();
            }
            // 注意：講師顏色將在 loadEvents 完成後生成
        }

        // 為講師生成隨機馬卡龍顏色
        function generateRandomInstructorColors() {
            allInstructors.forEach(instructor => {
                if (!instructorColors[instructor]) {
                    instructorColors[instructor] = generateRandomMacaronColor();
                }
            });
        }

        // 儲存設置
        function saveSettings() {
            // 更新顏色設置（將 hex 轉換為 rgba）
            colorSettings.esm = hexToRgba(document.getElementById('esmColor').value, 0.8);
            colorSettings.spm = hexToRgba(document.getElementById('spmColor').value, 0.8);
            colorSettings.boost = hexToRgba(document.getElementById('boostColor').value, 0.8);
            colorSettings.spike = hexToRgba(document.getElementById('spikeColor').value, 0.8);
            colorSettings.ev3 = hexToRgba(document.getElementById('ev3Color').value, 0.8);
            colorSettings.minecraft = hexToRgba(document.getElementById('minecraftColor').value, 0.8);

            const settings = {
                colors: colorSettings,
                instructorColors: instructorColors
            };
            localStorage.setItem('calendarSettings', JSON.stringify(settings));
            applyColorSettings();
            closeSettings();
        }

        // 應用顏色設置
        function applyColorSettings() {
            // 更新CSS變數
            document.documentElement.style.setProperty('--esm-color', colorSettings.esm);
            document.documentElement.style.setProperty('--spm-color', colorSettings.spm);
            document.documentElement.style.setProperty('--boost-color', colorSettings.boost);
            document.documentElement.style.setProperty('--spike-color', colorSettings.spike);
            document.documentElement.style.setProperty('--ev3-color', colorSettings.ev3);
            document.documentElement.style.setProperty('--minecraft-color', colorSettings.minecraft);
            
            // 重新渲染事件
            if (allEvents.length > 0) {
                renderEvents();
            }
        }

        // 打開設置畫面
        function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            
            // 確保講師顏色已經生成
            if (allInstructors && allInstructors.length > 0) {
                generateRandomInstructorColors();
            }
            
            populateSettingsModal();
        }

        // 填充設置模態框
        function populateSettingsModal() {
            // 設置課程類型顏色（將 rgba 轉換為 hex）
            document.getElementById('esmColor').value = rgbaToHex(colorSettings.esm);
            document.getElementById('spmColor').value = rgbaToHex(colorSettings.spm);
            document.getElementById('boostColor').value = rgbaToHex(colorSettings.boost);
            document.getElementById('spikeColor').value = rgbaToHex(colorSettings.spike);
            document.getElementById('ev3Color').value = rgbaToHex(colorSettings.ev3);
            document.getElementById('minecraftColor').value = rgbaToHex(colorSettings.minecraft);
            
            // 填充講師顏色設置
            populateInstructorColorSettings();
        }

        // 關閉設置畫面
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }

        // 填充講師顏色設置
        function populateInstructorColorSettings() {
            const container = document.getElementById('instructorColorGroup');
            container.innerHTML = '';
            
            // 確保 allInstructors 已經載入
            if (!allInstructors || allInstructors.length === 0) {
                console.log('講師列表尚未載入，無法填充顏色設置');
                return;
            }
            
            console.log('填充講師顏色設置，講師列表:', allInstructors);
            console.log('當前講師顏色:', instructorColors);
            
            allInstructors.forEach(instructor => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-picker-item'; // 使用與教案類型顏色相同的 class
                const currentColor = instructorColors[instructor] || generateRandomMacaronColor();
                const hexColor = rgbaToHex(currentColor);
                console.log(`講師 ${instructor} 的顏色: ${currentColor} -> ${hexColor}`);
                
                colorItem.innerHTML = `
                    <label>${instructor}</label>
                    <input type="color" class="color-picker" 
                           id="instructor_${instructor}" 
                           value="${hexColor}"
                           onchange="updateInstructorColor('${instructor}', this.value)">
                `;
                container.appendChild(colorItem);
            });
        }

        // 更新講師顏色
        function updateInstructorColor(instructor, color) {
            // 將 hex 顏色轉換為 rgba 格式
            const rgbaColor = hexToRgba(color, 0.8);
            instructorColors[instructor] = rgbaColor;
        }

        // 將 hex 顏色轉換為 rgba 格式
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // 將 rgba 顏色轉換為 hex 格式（用於顏色選擇器）
        function rgbaToHex(rgba) {
            const values = rgba.match(/\d+/g);
            if (values && values.length >= 3) {
                const r = parseInt(values[0]);
                const g = parseInt(values[1]);
                const b = parseInt(values[2]);
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            return '#000000';
        }

        // 載入事件資料
        async function loadEvents() {
            try {
                const response = await fetch('/api/events');
                const data = await response.json();
                
                if (data.success) {
                    allEvents = data.data;
                    allInstructors = [...new Set(allEvents.map(event => event.instructor).filter(Boolean))];
                    
                    // 為新講師生成隨機馬卡龍顏色（如果沒有保存的設置）
                    if (Object.keys(instructorColors).length === 0) {
                        generateRandomInstructorColors();
                    }
                    
                    populateInstructorDropdown();
                    renderEvents();
                    updateStats();
                } else {
                    showError('載入事件失敗: ' + data.message);
                }
            } catch (error) {
                console.error('載入事件錯誤:', error);
                showError('無法連接到服務器');
            }
        }

        // 填充講師下拉選單
        function populateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            select.innerHTML = '<option value="">全部講師</option>';
            
            allInstructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor;
                option.textContent = instructor;
                select.appendChild(option);
            });
        }

        // 切換檢視模式
        function switchView(view) {
            currentView = view;
            
            // 更新按鈕狀態 - 只針對視圖按鈕
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            viewButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 找到對應的按鈕並設為活躍
            viewButtons.forEach(btn => {
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                }
            });
            
            // 更新統計資訊（包括日期範圍）
            updateStats();
            renderEvents();
        }

        // 渲染事件
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            let filteredEvents = allEvents.filter(event => {
                // 講師篩選
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // 時段篩選
                if (timeFilter) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getUTCHours();
                    let timeMatch = false;
                    
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    
                    if (!timeMatch) {
                    return false;
                    }
                }
                
                // 指定日期篩選
                if (dateFilter) {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    
                    // 使用UTC時間進行日期比較
                    const eventYear = eventDate.getUTCFullYear();
                    const eventMonth = eventDate.getUTCMonth();
                    const eventDay = eventDate.getUTCDate();
                    const filterYear = filterDate.getUTCFullYear();
                    const filterMonth = filterDate.getUTCMonth();
                    const filterDay = filterDate.getUTCDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // 日期篩選
                const eventDate = new Date(event.start);
                const now = new Date();
                
                let shouldShow = false;
                switch (currentView) {
                    case 'today':
                        // 使用UTC時間進行日期比較，避免時區問題
                        const eventYear = eventDate.getUTCFullYear();
                        const eventMonth = eventDate.getUTCMonth();
                        const eventDay = eventDate.getUTCDate();
                        const nowYear = now.getUTCFullYear();
                        const nowMonth = now.getUTCMonth();
                        const nowDay = now.getUTCDate();
                        shouldShow = eventYear === nowYear && eventMonth === nowMonth && eventDay === nowDay;
                        console.log(`事件篩選 - 標題: ${event.title}, 事件日期: ${eventYear}-${eventMonth+1}-${eventDay}, 今天: ${nowYear}-${nowMonth+1}-${nowDay}, 顯示: ${shouldShow}`);
                        break;
                    case 'week':
                        // 使用UTC時間進行本週篩選
                        const weekStart = new Date(now);
                        weekStart.setUTCDate(now.getUTCDate() - now.getUTCDay());
                        weekStart.setUTCHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setUTCDate(weekStart.getUTCDate() + 6);
                        weekEnd.setUTCHours(23, 59, 59, 999);
                        shouldShow = eventDate >= weekStart && eventDate <= weekEnd;
                        break;
                    case 'month':
                        // 使用UTC時間進行本月篩選
                        shouldShow = eventDate.getUTCMonth() === now.getUTCMonth() && eventDate.getUTCFullYear() === now.getUTCFullYear();
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                        break;
                }
                
                return shouldShow;
            });
            
            // 排序事件
            filteredEvents.sort((a, b) => {
                switch (sortOrder) {
                    case 'time':
                        return new Date(a.start) - new Date(b.start);
                    case 'instructor':
                        return a.instructor.localeCompare(b.instructor);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    default:
                        return new Date(a.start) - new Date(b.start);
                }
            });
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="no-events">
                        <i class="fas fa-calendar-times"></i>
                        <h3>沒有找到事件</h3>
                        <p>請嘗試調整篩選條件</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredEvents.map(event => createEventCard(event)).join('');
        }

        // 創建事件卡片
        function createEventCard(event) {
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            
            // 格式化時間
            const timeString = `${startDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} - ${endDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}`;
            
            // 清理描述內容
            let cleanDescription = event.description || '';
            
            // 移除技術標籤和重複資訊
            cleanDescription = cleanDescription
                .replace(/\[NOTION_SYNC\]/g, '')
                .replace(/時間:.*?講師:/g, '')
                .replace(/講師:.*?TA:/g, '')
                .replace(/TA:.*?第一期:/g, '')
                .replace(/第一期:/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            // 尋找教案連結 - 從原始描述中提取
            const notionUrlRegex = /https:\/\/www\.notion\.so\/([^)\s]+)/;
            const notionMatch = event.description.match(notionUrlRegex);
            
            let lessonButton = '';
            if (notionMatch) {
                const lessonUrl = `https://www.notion.so/${notionMatch[1]}`;
                
                // 提取教案名稱和類型
                let lessonName = '查看教案';
                let lessonType = '教案';
                
                // 從原始描述中提取教案資訊
                const originalDescription = event.description;
                
                // 匹配各種教案格式
                const lessonMatch = originalDescription.match(/(ESM教案|SPM教案|SPIKE教案|BOOST教案|EV3教案|MINECRAFT教案)[:\s]*([^(]+?)(?:\s*\(https:\/\/www\.notion\.so)/);
                if (lessonMatch && lessonMatch[2]) {
                    lessonName = lessonMatch[2].trim();
                    lessonType = lessonMatch[1].replace('教案', '');
                }
                
                lessonButton = `
                    <div class="lesson-section">
                        <div class="lesson-label">${lessonType}教案</div>
                        <a href="${lessonUrl}" target="_blank" class="lesson-button ${lessonType.toLowerCase()}">
                            <i class="fas fa-book"></i> ${lessonName}
                        </a>
                    </div>
                `;
            }
            
            // 處理位置資訊
            let location = event.location;
            if (!location || location === 'nan' || location === 'null' || location === '' || location.trim() === '') {
                location = 'FLB工作室';
            }
            
            // 講師底色
            const instructorColor = instructorColors[event.instructor] || '#667eea';
            const instructorStyle = instructorColors[event.instructor] ? 'custom-color' : '';
            
            return `
                <div class="event-card">
                    <div class="event-header">
                        <div>
                            <div class="event-title">${event.title}</div>
                            <div class="event-instructor ${instructorStyle}" style="--instructor-color: ${instructorColor}">
                                <i class="fas fa-user"></i> ${event.instructor}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-details">
                        <div class="event-detail">
                            <i class="fas fa-calendar"></i>
                            <span>${startDate.toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-clock"></i>
                            <span>${timeString}</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${location}</span>
                        </div>
                    </div>
                    
                    <div class="event-description">
                        <h4><i class="fas fa-info-circle"></i> 課程描述</h4>
                        <p>${cleanDescription || '無描述'}</p>
                    </div>
                    
                    ${lessonButton}
                </div>
            `;
        }

        // 更新統計資訊
        function updateStats() {
            // 獲取當前篩選後的事件
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const filteredEvents = allEvents.filter(event => {
                // 講師篩選
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // 時段篩選
                if (timeFilter) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getUTCHours();
                    let timeMatch = false;
                    
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    
                    if (!timeMatch) {
                        return false;
                    }
                }
                
                // 指定日期篩選
                if (dateFilter) {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    
                    // 使用UTC時間進行日期比較
                    const eventYear = eventDate.getUTCFullYear();
                    const eventMonth = eventDate.getUTCMonth();
                    const eventDay = eventDate.getUTCDate();
                    const filterYear = filterDate.getUTCFullYear();
                    const filterMonth = filterDate.getUTCMonth();
                    const filterDay = filterDate.getUTCDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // 日期篩選
                const eventDate = new Date(event.start);
                const now = new Date();
                
                let shouldShow = false;
                switch (currentView) {
                    case 'today':
                        // 使用UTC時間進行日期比較，避免時區問題
                        const eventYear = eventDate.getUTCFullYear();
                        const eventMonth = eventDate.getUTCMonth();
                        const eventDay = eventDate.getUTCDate();
                        const nowYear = now.getUTCFullYear();
                        const nowMonth = now.getUTCMonth();
                        const nowDay = now.getUTCDate();
                        shouldShow = eventYear === nowYear && eventMonth === nowMonth && eventDay === nowDay;
                        break;
                    case 'week':
                        // 使用UTC時間進行本週篩選
                        const weekStart = new Date(now);
                        weekStart.setUTCDate(now.getUTCDate() - now.getUTCDay());
                        weekStart.setUTCHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setUTCDate(weekStart.getUTCDate() + 6);
                        weekEnd.setUTCHours(23, 59, 59, 999);
                        shouldShow = eventDate >= weekStart && eventDate <= weekEnd;
                        break;
                    case 'month':
                        // 使用UTC時間進行本月篩選
                        shouldShow = eventDate.getUTCMonth() === now.getUTCMonth() && eventDate.getUTCFullYear() === now.getUTCFullYear();
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                        break;
                }
                
                return shouldShow;
            });
            
            // 計算篩選後的講師數量
            const uniqueInstructors = new Set(filteredEvents.map(event => event.instructor));
            const instructorCount = uniqueInstructors.size;
            
            // 根據當前篩選模式計算日期範圍
            let dateRange = '-';
            const now = new Date();
            
            switch (currentView) {
                case 'today':
                    dateRange = now.toLocaleDateString('zh-TW');
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    dateRange = `${weekStart.toLocaleDateString('zh-TW')} - ${weekEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    dateRange = `${monthStart.toLocaleDateString('zh-TW')} - ${monthEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case 'all':
                default:
            if (allEvents.length > 0) {
                const dates = allEvents.map(event => new Date(event.start));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                        dateRange = `${minDate.toLocaleDateString('zh-TW')} - ${maxDate.toLocaleDateString('zh-TW')}`;
                    }
                    break;
            }
            
            document.getElementById('dateRange').textContent = dateRange;
            document.getElementById('totalEvents').textContent = filteredEvents.length;
            document.getElementById('instructorCount').textContent = instructorCount;
        }

        // 顯示錯誤訊息
        function showError(message) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `
                <div class="no-events">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>載入失敗</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // 點擊外部關閉設置畫面
        document.getElementById('settingsOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });
    </script>
</body>
</html>