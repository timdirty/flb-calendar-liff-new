<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>講師行事曆檢視</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                linear-gradient(135deg, 
                    rgba(0, 0, 0, 0.98) 0%, 
                    rgba(15, 15, 15, 0.95) 25%,
                    rgba(25, 25, 25, 0.92) 50%,
                    rgba(15, 15, 15, 0.95) 75%,
                    rgba(0, 0, 0, 0.98) 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 20s ease infinite, subtleGlow 8s ease-in-out infinite;
            min-height: 100vh;
            color: rgba(255, 255, 255, 0.95);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.03) 50%, transparent 70%),
                linear-gradient(-45deg, transparent 30%, rgba(255, 215, 0, 0.02) 50%, transparent 70%);
            animation: shimmer 12s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes subtleGlow {
            0%, 100% { 
                background-position: 0% 0%, 0% 0%, 0% 0%, 0% 50%;
            }
            50% { 
                background-position: 0% 0%, 0% 0%, 0% 0%, 100% 50%;
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.2),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            z-index: 2;
        }

        /* 頂部標題區域 */
        .header {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.8) 0%, 
                rgba(20, 20, 20, 0.9) 50%,
                rgba(0, 0, 0, 0.8) 100%);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            padding: 30px;
            margin-bottom: 25px;
            border-radius: 25px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: headerFloat 6s ease-in-out infinite;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.1) 0%, 
                transparent 25%,
                transparent 75%,
                rgba(255, 215, 0, 0.1) 100%);
            animation: shimmer 3s ease-in-out infinite;
            z-index: 1;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.05) 0%, 
                transparent 70%);
            animation: rotate 20s linear infinite;
            z-index: 0;
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
        }

        .header h1 {
            color: rgba(255, 215, 0, 0.95);
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.3), 
                0 0 30px rgba(255, 215, 0, 0.4),
                0 0 60px rgba(255, 215, 0, 0.2);
            animation: titleGlow 4s ease-in-out infinite alternate;
            position: relative;
            z-index: 2;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 8px 0 0 0;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2;
        }

        .header-tim-note {
            display: none; /* 隱藏底下的字 */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex: 1;
            text-align: center;
        }

        .header-logo {
            height: 50px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }



        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

            .user-info span {
                color: rgba(51, 51, 51, 0.9);
                font-weight: 500;
            }

            .user-details {
                align-items: center;
                text-align: center;
            }

            .user-name {
                font-size: 0.9rem;
                margin-bottom: 3px;
            }

            .user-id {
                font-size: 0.7rem;
                padding: 2px 4px;
            }

            .user-info-section {
                margin-top: 20px;
                padding: 15px;
            }

            .user-info-container h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }


        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .user-name {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .user-id {
            color: rgba(102, 102, 102, 0.8);
            font-size: 0.8rem;
            font-family: monospace;
            background: rgba(248, 249, 250, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }

        /* 用戶資訊區域 */
        .user-info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .user-info-container h3 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 15px 0;
            text-align: center;
        }

        /* 日期時間顯示區域 */
        .datetime-display {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .datetime-item {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255, 223, 102, 0.3);
            text-align: center;
        }

        .datetime-item i {
            font-size: 1.1rem;
        }

        /* 進度指示器 */
        .progress-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                transparent 50%,
                rgba(255, 255, 255, 0.1) 100%);
            animation: stepShimmer 3s ease-in-out infinite;
            z-index: 1;
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 2;
        }

        .step.completed .step-circle {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 2;
        }

        .step.pending .step-circle {
            background: linear-gradient(135deg, 
                rgba(85, 85, 85, 0.6) 0%, 
                rgba(60, 60, 60, 0.8) 100%);
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            z-index: 2;
        }

        .step-label {
            color: rgba(204, 204, 204, 0.9);
            font-size: 0.9rem;
            text-align: center;
        }

        .step.active .step-label {
            color: rgba(255, 223, 102, 0.9);
        }

        /* 主內容區域 */
        .main-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .content-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .content-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .content-header i {
            color: rgba(255, 223, 102, 0.9);
            font-size: 1.3rem;
        }

        /* 控制面板 */
        .controls {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.15) 0%, 
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            overflow: hidden;
            animation: controlsFloat 8s ease-in-out infinite;
        }

        .controls::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.08) 0%, 
                transparent 30%,
                transparent 70%,
                rgba(255, 215, 0, 0.08) 100%);
            animation: controlsShimmer 4s ease-in-out infinite;
            z-index: 1;
        }

        .controls::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.03) 0%, 
                transparent 70%);
            animation: controlsRotate 25s linear infinite;
            z-index: 0;
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 700;
            color: rgba(0, 0, 0, 0.8);
            font-size: 0.95rem;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 2;
        }

        select, input {
            padding: 12px 16px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 2;
        }

        select:focus, input:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 
                0 0 0 3px rgba(255, 215, 0, 0.2),
                0 4px 20px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }


        /* 視圖按鈕組 */
        .view-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            z-index: 2;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }






        .btn-primary {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-primary:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            color: rgba(255, 215, 0, 1);
        }

        .btn-primary:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }

        .btn-primary.active {
            background: rgba(255, 193, 7, 1);
            border-color: rgba(255, 193, 7, 1);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5);
            transform: translateY(-2px);
            font-weight: 700;
            color: rgba(0, 0, 0, 0.9) !important; /* 確保選中時字體為深色 */
        }

        .btn-primary.active::after {
            content: '✓';
            position: absolute;
            top: -5px;
            right: -5px;
            background: rgba(255, 255, 255, 1);
            color: rgba(255, 193, 7, 1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid rgba(255, 193, 7, 1);
        }

        .btn-export {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-export:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }

        .btn-export i {
            font-size: 1rem;
        }

        /* 即將到來課程的高亮樣式 */
        .event-card.upcoming-event {
            position: relative;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            border: 3px solid #FF6B35;
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
            transform: scale(1.02);
            animation: upcomingPulse 2s ease-in-out infinite;
        }

        .event-card.upcoming-event::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #FF6B35, #F7931E, #FF6B35, #F7931E);
            border-radius: 12px;
            z-index: -1;
            animation: upcomingGlow 2s ease-in-out infinite;
        }

        .event-card.upcoming-event .event-title {
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .event-card.upcoming-event .event-instructor {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .event-card.upcoming-event .event-detail {
            color: rgba(255, 255, 255, 0.9);
        }

        .event-card.upcoming-event .event-detail i {
            color: rgba(255, 255, 255, 0.8);
        }

        .event-card.upcoming-event .countdown-timer {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 8px 0;
        }

        .event-card.upcoming-event .event-description {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
        }

        .event-card.upcoming-event .event-description h4 {
            color: white;
        }

        .event-card.upcoming-event .event-description p {
            color: rgba(255, 255, 255, 0.9);
        }

        /* 即將到來課程標記 */
        .upcoming-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #FF6B35;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: upcomingBadgePulse 1.5s ease-in-out infinite;
        }

        .upcoming-badge i {
            font-size: 0.9rem;
        }

        /* 動畫效果 */
        @keyframes upcomingPulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
                transform: scale(1.02);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(255, 107, 53, 0.6);
                transform: scale(1.03);
            }
        }

        @keyframes upcomingGlow {
            0%, 100% { 
                opacity: 0.8;
            }
            50% { 
                opacity: 1;
            }
        }

        @keyframes upcomingBadgePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.9);
            color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(108, 117, 125, 0.9);
        }

        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateY(-1px);
            color: rgba(255, 215, 0, 0.9);
        }

        .btn-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .btn-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* 統計區域 */
        .stats {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.15) 0%, 
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            overflow: hidden;
            animation: statsFloat 7s ease-in-out infinite;
        }

        .stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.08) 0%, 
                transparent 30%,
                transparent 70%,
                rgba(255, 215, 0, 0.08) 100%);
            animation: statsShimmer 5s ease-in-out infinite;
            z-index: 1;
        }

        .stats::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.03) 0%, 
                transparent 70%);
            animation: statsRotate 30s linear infinite;
            z-index: 0;
        }


        .events-container {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr;
        }

        .event-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 250, 252, 0.9) 50%,
                rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                0 0 0 1px rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.3);
            margin-bottom: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.6s ease-out forwards;
            z-index: 3;
            overflow: hidden;
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                rgba(255, 215, 0, 0.8), 
                rgba(255, 193, 7, 0.6),
                rgba(255, 215, 0, 0.8));
            border-radius: 16px 16px 0 0;
        }

        .event-card.animated {
            opacity: 1;
            transform: translateY(0);
        }

        .event-card:nth-child(1) { animation-delay: 0.1s; }
        .event-card:nth-child(2) { animation-delay: 0.2s; }
        .event-card:nth-child(3) { animation-delay: 0.3s; }
        .event-card:nth-child(4) { animation-delay: 0.4s; }
        .event-card:nth-child(5) { animation-delay: 0.5s; }

        /* 停課狀態樣式 - 加強版 */
        .event-card.cancelled-event {
            background: rgba(248, 249, 250, 0.9);
            border: 3px solid #dc3545;
            opacity: 0.8;
            position: relative;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
        }

        .event-card.cancelled-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(220, 53, 69, 0.15) 8px,
                rgba(220, 53, 69, 0.15) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.cancelled-event::after {
            content: '⚠️ 停課 ⚠️';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            animation: bounce 1.5s infinite;
        }

        /* 代課狀態樣式 */
        .event-card.substitute-event {
            background: rgba(227, 242, 253, 0.9);
            border: 3px solid #2196F3;
            position: relative;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.4);
        }

        .event-card.substitute-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(33, 150, 243, 0.1) 8px,
                rgba(33, 150, 243, 0.1) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.substitute-event::after {
            content: '🔄 代課';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            animation: substituteBounce 2s infinite;
            border: 2px solid #0D47A1;
        }

        @keyframes substituteBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-10px) scale(1.1);
            }
            60% {
                transform: translateY(-5px) scale(1.05);
            }
        }

        /* 體驗狀態樣式 */
        .experience-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #8B4513;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            animation: experiencePulse 3s infinite;
            border: 2px solid #B8860B;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        @keyframes experiencePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            }
            30% {
                transform: scale(1.2);
                color: #FFD700;
                font-weight: bold;
                text-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
            }
            70% {
                transform: scale(1.1);
                color: #FFA500;
                font-weight: bold;
                text-shadow: 0 0 6px rgba(255, 165, 0, 0.3);
            }
        }

        .event-card.experience-event {
            background: rgba(255, 248, 220, 0.9);
            border: 3px solid #FFD700;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }

        .event-card.experience-event::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(255, 215, 0, 0.1) 8px,
                rgba(255, 215, 0, 0.1) 16px
            );
            pointer-events: none;
            border-radius: 12px;
        }

        .event-card.experience-event::after {
            content: '⭐ 體驗';
            position: absolute;
            top: -15px;
            right: -10px;
            background: #FFD700;
            color: #8B4513;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            animation: experienceBounce 2s infinite;
            border: 2px solid #B8860B;
        }

        @keyframes experienceBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-10px) scale(1.1);
            }
            60% {
                transform: translateY(-5px) scale(1.05);
            }
        }

        .cancelled-badge {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            animation: pulse 1.5s infinite;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            border: 2px solid white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .substitute-badge {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            animation: substitutePulse 3s infinite;
            border: 2px solid #0D47A1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        @keyframes substitutePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(33, 150, 243, 0.7);
            }
        }

        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
            transform: translateY(-5px);
            }
        }

        .event-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .event-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: rgba(255, 223, 102, 0.9);
            border-radius: 2px 0 0 2px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .event-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: rgba(0, 0, 0, 0.9);
            margin-bottom: 12px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
            letter-spacing: 0.5px;
        }

        .event-instructor {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 193, 7, 0.8) 100%);
            color: rgba(0, 0, 0, 0.9);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 
                0 4px 12px rgba(255, 215, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(0, 0, 0, 0.8);
            font-size: 0.95rem;
            font-weight: 500;
            padding: 8px 12px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }

        .event-detail:hover {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.3);
            transform: translateY(-1px);
        }

        .event-detail i {
            width: 22px;
            color: rgba(255, 215, 0, 0.8);
            text-align: center;
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .location-link {
            color: #0066cc !important;
            text-decoration: underline !important;
            text-decoration-color: #0066cc !important;
            text-decoration-thickness: 2px !important;
            text-underline-offset: 3px !important;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            position: relative;
            font-weight: 600;
            border: 2px solid rgba(0, 102, 204, 0.2);
            box-shadow: 0 2px 4px rgba(0, 102, 204, 0.1);
        }

        .location-link:hover {
            color: #ffffff !important;
            background: linear-gradient(135deg, #0066cc, #004499) !important;
            text-decoration: none !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
            border-color: #0066cc;
        }

        .location-link:active {
            color: #ffffff !important;
            background: linear-gradient(135deg, #004499, #003366) !important;
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 102, 204, 0.3);
        }

        .location-external-icon {
            font-size: 0.8rem;
            opacity: 1;
            color: #0066cc;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .location-link:hover .location-external-icon {
            opacity: 1;
            transform: scale(1.2);
            color: #ffffff;
        }

        .location-map-icon {
            font-size: 0.9rem;
            opacity: 1;
            color: #0066cc;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .location-link:hover .location-map-icon {
            opacity: 1;
            transform: scale(1.2);
            color: #ffffff;
        }

        .countdown-timer {
            background: rgba(255, 193, 7, 0.15);
            border: 2px solid rgba(255, 193, 7, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            margin-top: 12px;
            text-align: center;
            font-weight: 700;
            color: rgba(255, 193, 7, 1);
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 12px rgba(255, 193, 7, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .countdown-timer.upcoming {
            background: rgba(76, 175, 80, 0.15);
            border-color: rgba(76, 175, 80, 0.4);
            color: rgba(76, 175, 80, 1);
            box-shadow: 
                0 4px 12px rgba(76, 175, 80, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-timer.ongoing {
            background: rgba(33, 150, 243, 0.15);
            border-color: rgba(33, 150, 243, 0.4);
            color: rgba(33, 150, 243, 1);
            box-shadow: 
                0 4px 12px rgba(33, 150, 243, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-timer.overdue {
            background: rgba(244, 67, 54, 0.15);
            border-color: rgba(244, 67, 54, 0.4);
            color: rgba(244, 67, 54, 1);
            box-shadow: 
                0 4px 12px rgba(244, 67, 54, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .countdown-text {
            font-size: 0.9rem;
            margin: 0;
        }

        .countdown-icon {
            margin-right: 6px;
            font-size: 0.8rem;
        }

        .event-description {
            background: rgba(248, 249, 250, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid rgba(255, 223, 102, 0.9);
        }

        .event-description h4 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: 600;
        }

        .event-description p {
            color: rgba(102, 102, 102, 0.9);
            line-height: 1.5;
            font-size: 0.9rem;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .lesson-section {
            margin-top: 15px;
        }

        .lesson-label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .lesson-button {
            display: inline-block;
            background: rgba(255, 223, 102, 0.9);
            color: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 223, 102, 0.9);
        }

        .lesson-button:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .no-events i {
            font-size: 4rem;
            color: rgba(255, 223, 102, 0.9);
            margin-bottom: 20px;
        }

        .no-events h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: rgba(51, 51, 51, 0.9);
        }

        .no-events p {
            font-size: 1.1rem;
            color: rgba(102, 102, 102, 0.9);
        }

        /* 設置畫面樣式 */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .settings-modal {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(240, 240, 240, 0.9);
        }

        .settings-header h2 {
            color: rgba(51, 51, 51, 0.9);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .close-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            transform: scale(1.1);
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: rgba(51, 51, 51, 0.9);
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .color-picker-item label {
            font-weight: 600;
            color: rgba(51, 51, 51, 0.9);
            min-width: 80px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .instructor-color-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .instructor-color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(233, 236, 239, 0.9);
        }

        .instructor-color-item label {
            font-size: 0.9rem;
            color: rgba(51, 51, 51, 0.9);
            min-width: 60px;
            font-weight: 600;
        }

        .instructor-color-picker {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(221, 221, 221, 0.9);
            border-radius: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .instructor-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .instructor-color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .save-settings {
            background: rgba(255, 223, 102, 0.9);
            color: rgba(44, 44, 44, 0.9);
            border: 2px solid rgba(255, 223, 102, 0.9);
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .save-settings:hover {
            background: rgba(255, 235, 120, 0.9);
            border-color: rgba(255, 235, 120, 0.9);
            transform: translateY(-1px);
        }

        /* 重新整理浮動按鈕 - 蘋果 iOS 16 液態玻璃效果 */
        .refresh-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            user-select: none;
            overflow: hidden;
        }

        .refresh-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .refresh-button:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .refresh-button:hover::before {
            opacity: 1;
        }

        .refresh-button:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 
                0 6px 24px rgba(0, 0, 0, 0.12),
                0 2px 6px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .refresh-button i {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .refresh-button.loading i {
            animation: spin 1s linear infinite;
        }

        .refresh-button.loading {
            background: rgba(0, 122, 255, 0.2);
            border-color: rgba(0, 122, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 122, 255, 0.2),
                0 2px 8px rgba(0, 122, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            /* 整個頁面可以滑動 */
            body {
                overflow-x: hidden;
                overflow-y: auto;
                margin: 0;
                padding: 0;
            }
            
            .container {
                padding: 0;
                max-width: 100%;
                margin: 0;
            }
            
            /* 篩選區域完全固定，絕對不會移動 */
            .control-section {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 9999 !important;
                background: white !important;
                padding: 6px !important; /* 減少內邊距 */
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
                width: 100% !important;
                height: auto !important;
                /* 確保篩選區域永遠固定在頂部，絕對不會移動 */
                transform: translateZ(0) !important; /* 強制硬體加速 */
                will-change: auto !important; /* 優化渲染性能 */
                backface-visibility: hidden !important; /* 防止閃爍 */
                /* 確保篩選區塊覆蓋在標題區塊上方 */
                margin: 0 !important;
                border-radius: 0 !important;
            }
            
            /* 主內容區域，為固定篩選區域留出空間 */
            .main-content {
                margin-top: 0 !important; /* 移除頂部間距，讓內容緊貼篩選區塊 */
                padding: 8px 8px 4px 8px; /* 減少底部間距 */
                /* 讓整個頁面可以正常滑動 */
            }
            
            /* 移除視圖按鈕的 sticky 定位，因為篩選區域已經固定 */
            .view-buttons {
                position: static !important;
                /* 添加滑動提示 */
                position: relative;
                margin: 4px 0 !important; /* 減少上下間距 */
            }
            
            /* 移除原本的滑動提示指示器 */
            .view-buttons::after {
                display: none;
            }
            
            
            /* 按鈕脈衝動畫 */
            @keyframes buttonPulse {
                0% { 
                    transform: scale(1.1); 
                    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
                }
                50% { 
                    transform: scale(1.15); 
                    box-shadow: 0 8px 16px rgba(0, 123, 255, 0.5);
                }
                100% { 
                    transform: scale(1.1); 
                    box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
                }
            }
            
            /* 視圖按鈕選中效果 */
            .view-buttons .btn-primary.active {
                background: linear-gradient(135deg, #ffc107, #ff9800) !important;
                color: rgba(0, 0, 0, 0.9) !important;
                border: 2px solid #ff9800 !important;
                box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3) !important;
                transform: scale(1.05) !important;
                font-weight: 600 !important;
            }
            
            .view-buttons .btn-primary:not(.active) {
                background: rgba(255, 193, 7, 0.3) !important;
                color: rgba(0, 0, 0, 0.7) !important;
                border: 1px solid rgba(255, 193, 7, 0.5) !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            }
            
            .view-buttons .btn-primary:hover {
                background: rgba(255, 193, 7, 0.6) !important;
                transform: scale(1.02) !important;
                transition: all 0.2s ease !important;
            }

            .header {
                padding: 12px;
                margin-bottom: 0 !important; /* 移除底部間距，避免與篩選區塊重疊 */
                position: relative !important; /* 確保標題區塊不會影響篩選區塊 */
            }

            .header h1 {
                font-size: 1.4rem;
                line-height: 1.2;
            }

            .header-logo {
                height: 35px;
            }

            .header-left {
                gap: 8px;
                justify-content: center;
                text-align: center;
            }


            .control-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .control-group {
                width: 100%;
            }

            .control-group label {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }

            .control-group select,
            .control-group input {
                padding: 8px;
                font-size: 0.9rem;
                border-radius: 6px;
            }

            .view-buttons {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                width: 100%;
            }


            .btn-primary {
                padding: 8px 4px;
                font-size: 0.75rem;
                text-align: center;
                min-height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-export {
                padding: 8px 12px;
                font-size: 0.75rem;
                min-height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }
            
            .btn-primary.active {
                color: rgba(0, 0, 0, 0.9) !important; /* 確保選中時字體為深色 */
            }

            .events-container {
                gap: 8px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-header {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                margin-bottom: 12px;
            }

            .event-title {
                font-size: 1rem;
                line-height: 1.3;
                word-wrap: break-word;
            }

            .event-instructor {
                padding: 4px 8px;
                font-size: 0.8rem;
                align-self: flex-start;
            }

            .event-details {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-bottom: 12px;
            }

            .event-detail {
                font-size: 0.8rem;
                padding: 4px 0;
            }

            .event-detail i {
                margin-right: 6px;
                width: 14px;
            }

            .event-description {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 6px;
            }

            .event-description h4 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }

            .event-description p {
                font-size: 0.8rem;
                line-height: 1.4;
                word-wrap: break-word;
            }

            .lesson-button {
                padding: 6px 12px;
                font-size: 0.8rem;
                border-radius: 6px;
            }


            .settings-modal {
                width: 95%;
                padding: 16px;
                margin: 10px auto;
            }

            .color-picker-group {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .instructor-color-group {
                grid-template-columns: 1fr;
            }

            .datetime-display {
                flex-direction: column;
                gap: 6px;
                justify-content: center;
                align-items: center;
            }

            .datetime-item {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .progress-steps {
                gap: 8px;
                margin: 12px 0;
                justify-content: center;
            }

            .progress-step {
                font-size: 0.7rem;
                padding: 6px 8px;
            }

            /* 手機版重新整理按鈕 - 蘋果 iOS 16 液態玻璃效果 */
            .refresh-button {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
                font-size: 20px;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 
                    0 6px 24px rgba(0, 0, 0, 0.12),
                    0 2px 6px rgba(0, 0, 0, 0.06),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }

            .refresh-button:hover {
                background: rgba(255, 255, 255, 0.25);
                border-color: rgba(255, 255, 255, 0.4);
                box-shadow: 
                    0 8px 28px rgba(0, 0, 0, 0.15),
                    0 3px 8px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5);
            }

            .refresh-button.loading {
                background: rgba(0, 122, 255, 0.25);
                border-color: rgba(0, 122, 255, 0.4);
                box-shadow: 
                    0 6px 24px rgba(0, 122, 255, 0.25),
                    0 2px 6px rgba(0, 122, 255, 0.12),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }

        /* 超小屏幕響應式設計 */
        @media (max-width: 480px) {
            .container {
                padding: 6px;
            }

            .header {
                padding: 8px;
                margin-bottom: 8px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .header-logo {
                height: 30px;
            }

            .header-left {
                justify-content: center;
                text-align: center;
            }


            .control-group label {
                font-size: 0.8rem;
            }

            .control-group select,
            .control-group input {
                padding: 6px;
                font-size: 0.85rem;
            }

            .view-buttons {
                gap: 4px;
            }

            .btn-primary {
                padding: 6px 2px;
                font-size: 0.7rem;
                min-height: 32px;
            }

            .btn-export {
                padding: 6px 8px;
                font-size: 0.7rem;
                min-height: 32px;
                gap: 4px;
            }
            
            .btn-primary.active {
                color: rgba(0, 0, 0, 0.9) !important; /* 確保選中時字體為深色 */
            }


            .events-container {
                gap: 6px;
                grid-template-columns: 1fr;
            }

            .event-card {
                padding: 10px;
                margin-bottom: 6px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-title {
                font-size: 0.9rem;
            }

            .event-instructor {
                padding: 3px 6px;
                font-size: 0.75rem;
            }

            .event-detail {
                font-size: 0.75rem;
            }

            .event-description {
                padding: 8px;
            }

            .event-description h4 {
                font-size: 0.85rem;
            }

            .event-description p {
                font-size: 0.75rem;
            }

            .lesson-button {
                padding: 5px 10px;
                font-size: 0.75rem;
            }


            .datetime-item {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .progress-step {
                font-size: 0.65rem;
                padding: 4px 6px;
            }

            .user-info-section {
                margin-top: 15px;
                padding: 12px;
            }

            .user-info-container h3 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }
        }

        /* 載入動畫樣式 - 液態玻璃效果 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.95) 0%, 
                rgba(20, 20, 20, 0.95) 25%,
                rgba(255, 215, 0, 0.15) 50%,
                rgba(20, 20, 20, 0.95) 75%,
                rgba(0, 0, 0, 0.95) 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(1.1);
        }

        .loading-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 30px;
            padding: 40px 50px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.2),
                0 0 0 1px rgba(255, 215, 0, 0.1),
                0 0 30px rgba(255, 215, 0, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(1deg); }
            50% { transform: translateY(-5px) rotate(0deg); }
            75% { transform: translateY(-15px) rotate(-1deg); }
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 215, 0, 0.3),
                0 0 20px rgba(255, 215, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            animation: logoPulse 3s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 
                    0 15px 35px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 215, 0, 0.3),
                    0 0 20px rgba(255, 215, 0, 0.2);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 
                    0 20px 40px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 215, 0, 0.5),
                    0 0 40px rgba(255, 215, 0, 0.4),
                    0 0 60px rgba(255, 215, 0, 0.2);
            }
        }

        .loading-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent, 
                rgba(255, 215, 0, 0.2), 
                transparent);
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .loading-logo img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            position: relative;
            z-index: 1;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin-bottom: 20px;
            position: relative;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid transparent;
            border-top: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: rgba(255, 215, 0, 0.95);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .loading-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        .loading-progress {
            width: 250px;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 25px;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, 
                rgba(255, 215, 0, 0.9), 
                rgba(255, 193, 7, 0.8),
                rgba(255, 215, 0, 0.9));
            border-radius: 3px;
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .loading-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.8), 
                transparent);
            animation: progressShimmer 1.5s linear infinite;
        }

        @keyframes progressShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .loading-logs {
            max-height: 200px;
            overflow-y: auto;
            color: rgba(255, 255, 255, 0.85);
            font-size: 13px;
            text-align: center;
            width: 320px;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 215, 0, 0.1);
        }

        .loading-log-item {
            margin-bottom: 6px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            opacity: 0;
            animation: logFadeIn 0.5s ease-in forwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-log-item:last-child {
            border-bottom: none;
        }

        .loading-log-item.success {
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .loading-log-item.error {
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        .loading-log-item.warning {
            color: #ffd93d;
            text-shadow: 0 0 10px rgba(255, 217, 61, 0.3);
        }

        .loading-log-item.info {
            color: #45b7d1;
            text-shadow: 0 0 10px rgba(69, 183, 209, 0.3);
        }

        .loading-log-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
        }

        @keyframes logFadeIn {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        .loading-percentage {
            color: rgba(255, 215, 0, 0.9);
            font-size: 0.9rem;
            margin-top: 20px;
            margin-bottom: 20px;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .loading-signature {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 215, 0, 0.8);
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
            animation: signatureGlow 3s ease-in-out infinite;
        }

        @keyframes signatureGlow {
            0%, 100% { 
                opacity: 0.8;
                transform: scale(1);
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1.02);
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.6);
            }
        }

        /* 過場動畫效果 */
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.8s ease-out;
        }

        .bounce-in {
            animation: bounceIn 1s ease-out;
        }

        .scale-in {
            animation: scaleIn 0.5s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .float {
            animation: float 3s ease-in-out infinite;
        }

        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        /* 動畫關鍵幀 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            0% { 
                opacity: 0;
                transform: translateY(30px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(255, 223, 102, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 223, 102, 0.8);
            }
        }

        @keyframes headerFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes titleGlow {
            0% { 
                text-shadow: 
                    0 2px 10px rgba(0, 0, 0, 0.3), 
                    0 0 30px rgba(255, 215, 0, 0.4),
                    0 0 60px rgba(255, 215, 0, 0.2);
            }
            100% { 
                text-shadow: 
                    0 2px 15px rgba(0, 0, 0, 0.4), 
                    0 0 40px rgba(255, 215, 0, 0.6),
                    0 0 80px rgba(255, 215, 0, 0.3);
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes controlsFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        @keyframes controlsShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes controlsRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes statsFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }

        @keyframes statsShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes statsRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes stepShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* 統計數字動畫 */
        .stats-text span {
            display: inline-block;
            transition: all 0.3s ease;
        }

        .stats-text span.animate {
            animation: counterBounce 0.6s ease-out;
        }

        @keyframes counterBounce {
            0% {
                transform: scale(1);
                color: rgba(51, 51, 51, 0.8);
            }
            30% {
                transform: scale(1.2);
                color: #2196F3;
                font-weight: bold;
                text-shadow: 0 0 8px rgba(33, 150, 243, 0.4);
            }
            70% {
                transform: scale(1.1);
                color: #1976D2;
                font-weight: bold;
                text-shadow: 0 0 6px rgba(25, 118, 210, 0.3);
            }
            100% {
                transform: scale(1);
                color: rgba(51, 51, 51, 0.8);
            }
        }

        /* 馬卡龍配色變數 */
        :root {
            --esm-color: #ff6b9d;
            --spm-color: #2c3e50;
            --boost-color: #74b9ff;
            --spike-color: #fdcb6e;
            --ev3-color: #e17055;
            --minecraft-color: #00b894;
        }

        /* 教案按鈕顏色 */
        .lesson-button.esm {
            background: linear-gradient(135deg, var(--esm-color) 0%, #ff8fab 100%);
        }

        .lesson-button.spm {
            background: linear-gradient(135deg, var(--spm-color) 0%, #34495e 100%);
        }

        .lesson-button.boost {
            background: linear-gradient(135deg, var(--boost-color) 0%, #a29bfe 100%);
        }

        .lesson-button.spike {
            background: linear-gradient(135deg, var(--spike-color) 0%, #fdcb6e 100%);
        }

        .lesson-button.ev3 {
            background: linear-gradient(135deg, var(--ev3-color) 0%, #fd79a8 100%);
        }

        .lesson-button.minecraft {
            background: linear-gradient(135deg, var(--minecraft-color) 0%, #55efc4 100%);
        }

        /* 講師底色 */
        .event-instructor.custom-color {
            background: var(--instructor-color) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }
    </style>
</head>
<body>
    <!-- 載入動畫 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-logo">
                <img src="logo.jpg" alt="FLB Logo" />
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-text">🚀 載入中...</div>
            <div class="loading-subtitle">正在初始化系統，請稍候</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loadingProgressBar"></div>
            </div>
            <div class="loading-percentage" id="loadingPercentage">0%</div>
            <div class="loading-logs" id="loadingLogs">
                <div class="loading-log-item info">
                    <span class="loading-log-icon">ℹ️</span>
                    <span>系統初始化中...</span>
                </div>
            </div>
        </div>
        <div class="loading-signature">Tim感恩戴德🙏🏻</div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- 頂部標題區域 -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <img src="logo.jpg" alt="FLB Logo" class="header-logo">
                    <div>
                        <h1>FLB講師行事曆檢視系統</h1>
                        <p class="header-subtitle">即時查看所有講師的行程安排</p>
                        <p class="header-tim-note">Tim感恩戴德🙏🏻</p>
                    </div>
                </div>
        </div>

            <!-- 日期時間顯示 -->
            <div class="datetime-display">
                <div class="datetime-item">
                    <i class="fas fa-calendar"></i>
                    <span id="currentDate">2025年01月16日 星期四</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime">13:58:43</span>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-calendar-week"></i>
                    <span id="currentWeek">2025年第3週</span>
                </div>
            </div>
            
            <!-- 進度指示器 -->
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-circle">1</div>
                    <div class="step-label">選擇講師</div>
                </div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">查看行事曆</div>
                </div>
                <div class="step pending">
                    <div class="step-circle">3</div>
                    <div class="step-label">管理行程</div>
                </div>
            </div>
        </div>

        <!-- 主內容區域 -->
        <div class="main-content">
            <div class="content-header">
                <i class="fas fa-calendar-alt"></i>
                <h2>講師行事曆檢視</h2>
            </div>

            <!-- 控制面板 -->
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="instructorSelect">選擇講師</label>
                    <select id="instructorSelect">
                        <option value="">全部講師</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="timeFilter">時段篩選</label>
                        <select id="timeFilter">
                            <option value="">全部時段</option>
                            <option value="morning">早上 (06:00-12:00)</option>
                            <option value="afternoon">下午 (12:00-18:00)</option>
                            <option value="evening">晚上 (18:00-24:00)</option>
                    </select>
                </div>
                <div class="control-group">
                        <label for="dateFilter">指定日期</label>
                        <input type="date" id="dateFilter" />
                </div>
                <div class="control-group">
                        <button id="exportCalendarBtn" class="btn btn-export" title="匯出行事曆到手機">
                            <i class="fas fa-download"></i>
                            匯出行事曆
                    </button>
                </div>
                <div class="control-group">
                        <div class="view-buttons">
                            <button class="btn btn-primary active" data-view="today">今日</button>
                            <button class="btn btn-primary" data-view="week">本週</button>
                            <button class="btn btn-primary" data-view="month">本月</button>
                            <button class="btn btn-primary" data-view="all">全部</button>
                </div>
            </div>
        </div>

                    <!-- 統計信息文字顯示 -->
                    <div class="stats-text" id="statsText" style="text-align: center; margin-top: 8px; padding: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; font-size: 0.75rem; color: rgba(51, 51, 51, 0.8); max-width: 100%;">
                        <div class="stats-row" style="margin-bottom: 4px;">
                            <span id="totalEventsText">總事件: 0</span> | 
                            <span id="instructorCountText">講師: 0</span>
                </div>
                        <div class="stats-row">
                            <span id="dateRangeText">日期: -</span>
                </div>
                </div>
                    

            </div>
        </div>


            <!-- 事件列表 -->
        <div class="events-container" id="eventsContainer">
            <div class="no-events">
                <i class="fas fa-calendar-times"></i>
                <h3>載入中...</h3>
                <p>正在獲取行事曆資料</p>
                </div>
            </div>

            <!-- 用戶資訊區域 -->
            <div class="user-info-section" id="userInfoGroup" style="display: block;">
                <div class="user-info-container">
                    <h3>LINE 用戶資訊</h3>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="userDisplayName">未綁定</div>
                            <div class="user-id" id="userDisplayId" style="display: none;"></div>
                        </div>
                        <button class="btn btn-secondary" id="bindUserBtn">綁定帳號</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設置畫面 -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <h2><i class="fas fa-palette"></i> 顏色設置</h2>
                <button class="close-settings" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="settings-section">
                <h3>教案類型顏色</h3>
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label>ESM</label>
                        <input type="color" class="color-picker" id="esmColor" value="#ff6b9d">
                    </div>
                    <div class="color-picker-item">
                        <label>SPM</label>
                        <input type="color" class="color-picker" id="spmColor" value="#2c3e50">
                    </div>
                    <div class="color-picker-item">
                        <label>BOOST</label>
                        <input type="color" class="color-picker" id="boostColor" value="#74b9ff">
                    </div>
                    <div class="color-picker-item">
                        <label>SPIKE</label>
                        <input type="color" class="color-picker" id="spikeColor" value="#fdcb6e">
                    </div>
                    <div class="color-picker-item">
                        <label>EV3</label>
                        <input type="color" class="color-picker" id="ev3Color" value="#e17055">
                    </div>
                    <div class="color-picker-item">
                        <label>MINECRAFT</label>
                        <input type="color" class="color-picker" id="minecraftColor" value="#00b894">
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>講師底色設置</h3>
                <div class="color-picker-group" id="instructorColorGroup">
                    <!-- 講師顏色設置將由 JavaScript 動態生成 -->
                </div>
            </div>

            <button class="save-settings" onclick="saveSettings()">
                <i class="fas fa-save"></i> 儲存設置
            </button>
        </div>
    </div>

    <!-- 重新整理浮動按鈕 -->
    <div id="refreshButton" class="refresh-button" title="重新整理行事曆">
        <i class="fas fa-sync-alt"></i>
    </div>

    <script>
        // 全域變數
        let allEvents = [];
        let allInstructors = [];
        let currentView = '今日'; // 統一使用中文
        let currentUser = null;
        let colorSettings = {
            esm: 'rgba(255, 182, 193, 0.8)',
            spm: 'rgba(116, 185, 255, 0.8)',
            boost: 'rgba(116, 185, 255, 0.8)',
            spike: 'rgba(255, 223, 102, 0.8)',
            ev3: 'rgba(180, 167, 214, 0.8)',
            minecraft: 'rgba(0, 184, 148, 0.8)'
        };
        let instructorColors = {};

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成，開始初始化...');
            
            // 顯示載入動畫
            showLoadingAnimation();
            
            // 設置事件監聽器
            setupEventListeners();
            
            // 初始化系統
            initializeSystem();
        });

        // 顯示載入動畫
        function showLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }
            
            // 重置進度條
            updateLoadingProgress(0);
        }

        // 更新載入進度
        function updateLoadingProgress(percentage) {
            const progressBar = document.getElementById('loadingProgressBar');
            const percentageText = document.getElementById('loadingPercentage');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (percentageText) {
                percentageText.textContent = Math.round(percentage) + '%';
            }
        }

        // 隱藏載入動畫
        function hideLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContainer = document.getElementById('mainContainer');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            if (mainContainer) {
                mainContainer.style.display = 'block';
                // 觸發主容器的進入動畫
                mainContainer.classList.add('fade-in');
            }
        }

        // 為元素添加動畫效果
        function addAnimationToElement(element, animationClass, delay = 0) {
            if (element) {
                setTimeout(() => {
                    element.classList.add(animationClass);
                }, delay);
            }
        }

        // 為事件卡片添加進入動畫
        function animateEventCards() {
            const eventCards = document.querySelectorAll('.event-card');
            eventCards.forEach((card, index) => {
                // 重置動畫狀態
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.animation = 'none';
                
                // 強制重排
                card.offsetHeight;
                
                // 重新啟動動畫
                card.style.animation = `slideUp 0.6s ease-out forwards`;
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }

        // 計算倒數計時
        function calculateCountdown(startTime, endTime) {
            const now = new Date();
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            const timeDiff = start.getTime() - now.getTime();
            const endDiff = end.getTime() - now.getTime();
            
            // 如果課程已結束
            if (endDiff <= 0) {
                return {
                    text: '課程已結束',
                    status: 'overdue',
                    icon: 'fas fa-check-circle'
                };
            }
            
            // 如果課程正在進行中
            if (timeDiff <= 0 && endDiff > 0) {
                const remainingMinutes = Math.floor(endDiff / (1000 * 60));
                const remainingHours = Math.floor(remainingMinutes / 60);
                const remainingMins = remainingMinutes % 60;
                
                if (remainingHours > 0) {
                    return {
                        text: `進行中，剩餘 ${remainingHours}小時${remainingMins}分鐘`,
                        status: 'ongoing',
                        icon: 'fas fa-play-circle'
                    };
                } else {
                    return {
                        text: `進行中，剩餘 ${remainingMins}分鐘`,
                        status: 'ongoing',
                        icon: 'fas fa-play-circle'
                    };
                }
            }
            
            // 如果課程尚未開始
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return {
                    text: `還有 ${days}天${hours}小時`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            } else if (hours > 0) {
                return {
                    text: `還有 ${hours}小時${minutes}分鐘`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            } else {
                return {
                    text: `還有 ${minutes}分鐘`,
                    status: 'upcoming',
                    icon: 'fas fa-clock'
                };
            }
        }

        // 更新所有倒數計時
        function updateAllCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown-timer');
            countdownElements.forEach(element => {
                const startTime = element.dataset.startTime;
                const endTime = element.dataset.endTime;
                
                if (startTime && endTime) {
                    const countdown = calculateCountdown(startTime, endTime);
                    element.className = `countdown-timer ${countdown.status}`;
                    element.innerHTML = `
                        <i class="${countdown.icon} countdown-icon"></i>
                        <span class="countdown-text">${countdown.text}</span>
                    `;
                }
            });
        }

        // 初始化系統
        async function initializeSystem() {
            try {
                console.log('開始初始化系統...');
                addLoadingLog('🚀 開始初始化系統...', 'info');
                updateLoadingProgress(10);
                
                // 初始化全局變量
                window.currentView = '今日';
                
                // 載入設定
                addLoadingLog('⚙️ 載入系統設定...', 'info');
                loadSettings();
                updateLoadingProgress(20);
                
                // 更新日期時間（移除背景監聽）
                addLoadingLog('🕐 初始化時間系統...', 'info');
                updateDateTime();
                updateLoadingProgress(30);
                
                // 先載入行事曆資料，再初始化LIFF
                addLoadingLog('📅 正在載入行事曆資料...', 'info');
                await loadEvents().catch(error => {
                    console.error('載入行事曆資料失敗:', error);
                    addLoadingLog('❌ 載入行事曆資料失敗: ' + error.message, 'error');
                });
                addLoadingLog('✅ 行事曆資料載入完成', 'success');
                updateLoadingProgress(60);
                
                addLoadingLog('🔐 正在初始化 LINE 登入...', 'info');
                await initLineUser().catch(error => {
                    console.error('LIFF 初始化失敗:', error);
                    addLoadingLog('❌ LINE 登入初始化失敗: ' + error.message, 'error');
                });
                addLoadingLog('✅ LINE 登入初始化完成', 'success');
                updateLoadingProgress(80);
                
                console.log('所有初始化任務完成，開始講師比對...');
                addLoadingLog('👨‍🏫 開始講師身份比對...', 'info');
                updateLoadingProgress(90);
                
                // 檢查是否在本地環境
                const isLocal = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.hostname === '0.0.0.0' ||
                               window.location.protocol === 'file:';
                
                if (isLocal) {
                    console.log('🌐 本地環境模式，跳過講師自動比對');
                    addLoadingLog('🌐 本地環境模式，跳過講師自動比對', 'info');
                    console.log('講師比對完成');
                    addLoadingLog('✅ 本地模式初始化完成', 'success');
                } else if (currentUser && currentUser.userId && currentUser.displayName) {
                    console.log('=== 開始自動比對講師 ===');
                    console.log('用戶資料:', currentUser);
                    addLoadingLog('🔍 正在比對講師身份...', 'info');
                    
                    try {
                        await autoMatchTeacher(currentUser.userId, currentUser.displayName);
                        console.log('講師比對完成');
                        addLoadingLog('✅ 講師身份比對完成', 'success');
                    } catch (error) {
                        console.error('自動比對講師失敗:', error);
                        addLoadingLog('⚠️ 講師身份比對失敗: ' + error.message, 'warning');
                    }
                } else {
                    console.log('沒有用戶資料，跳過自動比對');
                    addLoadingLog('⚠️ 沒有用戶資料，跳過講師比對', 'warning');
                }
                
                addLoadingLog('🎉 系統初始化完成！', 'success');
                updateLoadingProgress(100);
                
                // 比對完成後隱藏載入動畫
                setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('系統初始化完成');
                        
                        // 綁定視圖按鈕（移除重複綁定）
                        console.log('🔄 系統初始化完成，開始綁定按鈕...');
                        bindViewButtons();
                        bindRefreshButton();
                        bindExportButton();
                        
                        // 設置今日按鈕的預設按下效果
                        updateViewButtonStates();
                        console.log('🔄 今日按鈕預設狀態已設置');
                        
                        // 更新時段篩選選項（智慧算法）
                        updateTimeFilterOptions();
                        console.log('🕐 時段篩選智慧算法已更新');
                        
                        // 自動滑動到行事曆區域（僅行動裝置）
                        autoScrollToCalendar();
                    } catch (error) {
                        console.error('隱藏載入動畫失敗:', error);
                    }
                }, 500);
                
            } catch (error) {
                console.error('系統初始化失敗:', error);
                // 即使失敗也要隱藏載入動畫
                setTimeout(() => {
                    try {
                        hideLoadingAnimation();
                        console.log('系統初始化失敗，但已隱藏載入動畫');
                    } catch (hideError) {
                        console.error('隱藏載入動畫失敗:', hideError);
                    }
                }, 1000);
            }
        }

        // 更新日期時間顯示
        function updateDateTime() {
            const now = new Date();
            
            // 更新日期
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', dateOptions);
            
            // 更新時間
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW', timeOptions);
            
            // 更新週數
            const weekNumber = getWeekNumber(now);
            document.getElementById('currentWeek').textContent = `${now.getFullYear()}年第${weekNumber}週`;
        }

        // 獲取週數
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // LINE UserID 相關函數
        async function initLineUser() {
            console.log('開始初始化LINE用戶...');
            console.log('當前URL:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
            
            return new Promise((resolve) => {
                // 檢查是否在本地環境
                const isLocal = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.hostname === '0.0.0.0' ||
                               window.location.protocol === 'file:';
                
                if (isLocal) {
                    console.log('🌐 檢測到本地環境，跳過 LINE 認證');
                    addLoadingLog('🌐 本地環境模式，跳過 LINE 認證', 'info');
                    
                    // 設置模擬用戶資料
                    currentUser = {
                        userId: 'local-test-user',
                        displayName: '本地測試用戶',
                        pictureUrl: ''
                    };
                    
                    updateUserDisplay();
                    console.log('本地模式用戶顯示完成');
                    resolve();
                    return;
                }
                
                // 設置超時保護（3秒，減少等待時間）
                const timeout = setTimeout(() => {
                    console.warn('LIFF 初始化超時，顯示綁定按鈕');
                    addLoadingLog('⏰ LINE 登入超時，請手動綁定', 'warning');
                    showBindButton();
                    resolve();
                }, 3000);
                
                // 檢查是否在LINE環境中
                if (typeof liff !== 'undefined') {
                    console.log('LIFF SDK 已載入');
                    
                    // 初始化LIFF - 這裡需要您的LIFF ID
                    liff.init({
                        liffId: '1657746214-qp0y8NwZ', // 請替換為您的LIFF ID
                        withLoginOnExternalBrowser: true
                    }).then(() => {
                        console.log('LIFF 初始化成功');
                        console.log('是否在LINE客戶端:', liff.isInClient());
                        console.log('是否已登入:', liff.isLoggedIn());
                        
                        if (liff.isLoggedIn()) {
                            console.log('用戶已登入，獲取用戶資料...');
                            liff.getProfile().then(async (profile) => {
                                clearTimeout(timeout);
                                console.log('獲取到用戶資料:', profile);
                                currentUser = {
                                    userId: profile.userId,
                                    displayName: profile.displayName,
                                    pictureUrl: profile.pictureUrl
                                };
                                updateUserDisplay();
                                console.log('updateUserDisplay() 執行完成');
                                
                                
                                // 將自動比對移到系統初始化完成後執行
                                console.log('準備在系統初始化完成後執行自動比對');
                                
                                resolve();
                            }).catch(error => {
                                console.error('獲取用戶資料失敗:', error);
                                clearTimeout(timeout);
                                showBindButton();
                                resolve();
                            });
                        } else {
                            console.log('用戶未登入，顯示綁定按鈕');
                            clearTimeout(timeout);
                            showBindButton();
                            resolve();
                        }
                    }).catch(error => {
                        console.error('LIFF 初始化失敗:', error);
                        clearTimeout(timeout);
                        showBindButton();
                        resolve();
                    });
                    
                } else {
                    clearTimeout(timeout);
                    console.log('LIFF SDK 未載入，顯示綁定按鈕');
                    showBindButton();
                    resolve();
                }
            });
        }

        function updateUserDisplay() {
            console.log('更新用戶顯示，當前用戶:', currentUser);
            
            try {
                const userInfoGroup = document.getElementById('userInfoGroup');
                const userDisplayName = document.getElementById('userDisplayName');
                const userDisplayId = document.getElementById('userDisplayId');
                const bindUserBtn = document.getElementById('bindUserBtn');
                
                if (!userInfoGroup || !userDisplayName || !userDisplayId || !bindUserBtn) {
                    console.error('找不到用戶資訊元素');
                    return;
                }
                
                if (currentUser) {
                    console.log('顯示用戶資訊:', currentUser.displayName, currentUser.userId);
                    
                    try {
                        userDisplayName.textContent = currentUser.displayName;
                        console.log('設置用戶名稱完成');
                    } catch (error) {
                        console.error('設置用戶名稱失敗:', error);
                    }
                    
                    try {
                        userDisplayId.textContent = `ID: ${currentUser.userId}`;
                        console.log('設置用戶ID完成');
                    } catch (error) {
                        console.error('設置用戶ID失敗:', error);
                    }
                    
                    try {
                        userDisplayId.style.display = 'block';
                        console.log('設置ID顯示完成');
                    } catch (error) {
                        console.error('設置ID顯示失敗:', error);
                    }
                    
                    try {
                        bindUserBtn.textContent = '重新綁定';
                        console.log('設置按鈕文字完成');
                    } catch (error) {
                        console.error('設置按鈕文字失敗:', error);
                    }
                    
                    try {
                        userInfoGroup.style.display = 'block';
                        console.log('設置用戶資訊組顯示完成');
                    } catch (error) {
                        console.error('設置用戶資訊組顯示失敗:', error);
                    }
                } else {
                    console.log('顯示未綁定狀態');
                    userDisplayName.textContent = '未綁定';
                    userDisplayId.style.display = 'none';
                    bindUserBtn.textContent = '綁定帳號';
                    userInfoGroup.style.display = 'block';
                }
                console.log('updateUserDisplay 函數執行完成');
            } catch (error) {
                console.error('updateUserDisplay 函數執行錯誤:', error);
            }
        }

        function showBindButton() {
            updateUserDisplay();
        }

        async function bindUser() {
            console.log('用戶點擊綁定按鈕');
            
            if (typeof liff !== 'undefined') {
                try {
                    if (liff.isLoggedIn()) {
                        console.log('用戶已登入，獲取用戶資料');
                        liff.getProfile().then(async (profile) => {
                            console.log('獲取到用戶資料:', profile);
                            currentUser = {
                                userId: profile.userId,
                                displayName: profile.displayName,
                                pictureUrl: profile.pictureUrl
                            };
                            updateUserDisplay();
                            
                            // 自動比對講師
                            console.log('準備執行自動比對講師...');
                            await autoMatchTeacher(profile.userId, profile.displayName);
                        }).catch(error => {
                            console.error('獲取用戶資料失敗:', error);
                            alert('獲取用戶資料失敗，請重試');
                        });
                    } else {
                        console.log('用戶未登入，嘗試登入');
                        // 這會觸發LINE的授權流程
                        liff.login().catch(error => {
                            console.error('登入失敗:', error);
                            alert('登入失敗，請重試');
                        });
                    }
                } catch (error) {
                    console.error('LIFF 操作異常:', error);
                    alert('綁定失敗，請重試');
                }
            } else {
                console.log('LIFF SDK 未載入');
                alert('請在LINE應用程式中開啟此頁面');
            }
        }

        // 自動比對講師
        async function autoMatchTeacher(userId, displayName) {
            console.log('開始自動比對講師...', { userId, displayName });
            console.log('函數被調用，參數:', { userId, displayName });
            
            // 在頁面上顯示比對過程
            showMatchingProcess('開始比對講師...', 'info');
            addLoadingLog('🔍 開始講師身份比對...', 'info');
            
            // 獲取講師選擇元素
            const instructorSelect = document.getElementById('instructorSelect');
            
            return new Promise(async (resolve) => {
            
            try {
                console.log('準備調用講師 API...');
                showMatchingProcess('正在調用講師 API...', 'info');
                addLoadingLog('🌐 正在連接講師資料庫...', 'info');
                
                // 設置 API 調用超時（10秒）
                const apiTimeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('API 調用超時')), 10000);
                });
                
                // 暫時使用現有的講師 API（避免 404 問題）
                const apiCall = fetch('/api/teachers', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    redirect: 'follow'  // 自動跟隨重定向
                });
                
                const response = await Promise.race([apiCall, apiTimeout]);
                
                console.log('API回應狀態:', response.status);
                console.log('API回應OK:', response.ok);
                showMatchingProcess(`API回應狀態: ${response.status}`, response.ok ? 'success' : 'error');
                addLoadingLog(`📡 API 回應: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`API請求失敗: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API回應:', data);
                showMatchingProcess('API回應成功，開始比對講師...', 'success');
                addLoadingLog('✅ 講師資料載入成功', 'success');
                
                // 處理 /api/teachers 的回應格式
                if (data.success && data.teachers && Array.isArray(data.teachers)) {
                    showMatchingProcess(`找到 ${data.teachers.length} 個講師，開始比對...`, 'info');
                    addLoadingLog(`👥 找到 ${data.teachers.length} 個講師，開始比對...`, 'info');
                    
                    // 顯示比對過程
                    showMatchingProcess(`比對條件: UserID=${userId}, DisplayName=${displayName}`, 'info');
                    addLoadingLog(`🔍 比對條件: ${displayName} (${userId})`, 'info');
                    
                    // 尋找匹配的講師
                    addLoadingLog('🔍 開始逐一比對講師...', 'info');
                    const matchedTeacher = data.teachers.find((teacher, index) => {
                        addLoadingLog(`📝 比對第 ${index + 1} 位講師: ${teacher.name}`, 'info');
                        
                        // 精確比對userId（不區分大小寫）
                        if (teacher.userId && userId && teacher.userId.toLowerCase() === userId.toLowerCase()) {
                            showMatchingProcess(`✅ 精確匹配UserID: ${teacher.userId}`, 'success');
                            addLoadingLog(`🎯 精確匹配 UserID: ${teacher.userId}`, 'success');
                            return true;
                        }
                        // 模糊比對name與displayName（不區分大小寫）
                        if (teacher.name && displayName) {
                            const teacherName = teacher.name.toLowerCase().trim();
                            const userName = displayName.toLowerCase().trim();
                            
                            // 完全匹配（不區分大小寫）
                            if (teacherName === userName) {
                                showMatchingProcess(`✅ 完全匹配名稱: ${teacher.name}`, 'success');
                                addLoadingLog(`🎯 完全匹配名稱: ${teacher.name}`, 'success');
                                return true;
                            }
                            
                            // 包含匹配（不區分大小寫）
                            if (teacherName.includes(userName) || userName.includes(teacherName)) {
                                showMatchingProcess(`✅ 包含匹配: ${teacher.name}`, 'success');
                                addLoadingLog(`🎯 包含匹配: ${teacher.name}`, 'success');
                                return true;
                            }
                            
                            // 部分匹配（至少3個字符，不區分大小寫）
                            if (teacherName.length >= 3 && userName.length >= 3) {
                                const commonChars = [...teacherName].filter(char => userName.includes(char)).length;
                                const similarity = commonChars / Math.max(teacherName.length, userName.length);
                                if (similarity >= 0.6) { // 60%相似度
                                    showMatchingProcess(`✅ 相似度匹配: ${teacher.name} (${Math.round(similarity * 100)}%)`, 'success');
                                    addLoadingLog(`🎯 相似度匹配: ${teacher.name} (${Math.round(similarity * 100)}%)`, 'success');
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                    
                    if (matchedTeacher) {
                        console.log('找到匹配的講師:', matchedTeacher);
                        showMatchingProcess(`🎉 找到匹配講師: ${matchedTeacher.name}`, 'success');
                        
                        // 自動選擇講師
                        if (instructorSelect) {
                            // 模糊比對講師選項
                            const matchedOption = findBestMatchingOption(instructorSelect, matchedTeacher.name);
                            
                            if (matchedOption) {
                                instructorSelect.value = matchedOption.value;
                                console.log('自動選擇講師:', matchedOption.value);
                                
                                // 立即更新統計和渲染事件（在跳轉前）
                                updateStats();
                                renderEvents();
                                
                                // 跳轉到第二步驟
                                showStep(2);
                                
                                showMatchingProcess(`✅ 自動選擇講師成功: ${matchedOption.value}`, 'success');
                                addLoadingLog(`🎯 自動選擇講師: ${matchedOption.value}`, 'success');
                                
                                // 比對成功，顯示個人行事曆
                                console.log('比對成功，將顯示個人行事曆');
                                resolve();
                                return;
                            }
                        }
                        
                        console.log('未找到對應的講師選項');
                        showMatchingProcess(`⚠️ 找到匹配講師但未在列表中: ${matchedTeacher.name}`, 'warning');
                        addLoadingLog(`⚠️ 找到匹配講師但未在列表中: ${matchedTeacher.name}`, 'warning');
                        
                        // 比對失敗，顯示全部講師
                        console.log('比對失敗，將顯示全部講師');
                        if (instructorSelect) {
                            instructorSelect.value = ''; // 選擇全部講師
                            // 立即更新統計和渲染事件
                            updateStats();
                            renderEvents();
                        }
                    } else {
                        console.log('未找到匹配的講師');
                        showMatchingProcess('❌ 未找到匹配的講師，請手動選擇', 'error');
                        addLoadingLog('❌ 未找到匹配的講師，請手動選擇', 'error');
                        
                        // 比對失敗，顯示全部講師
                        console.log('比對失敗，將顯示全部講師');
                        if (instructorSelect) {
                            instructorSelect.value = ''; // 選擇全部講師
                            // 立即更新統計和渲染事件
                            updateStats();
                            renderEvents();
                        }
                    }
                } else {
                    console.error('API回應格式錯誤:', data);
                    showMatchingProcess('❌ API回應格式錯誤', 'error');
                }
            } catch (error) {
                console.error('自動比對講師失敗:', error);
                showMatchingProcess(`❌ 自動比對失敗: ${error.message}`, 'error');
                
                if (error.message.includes('超時')) {
                    addLoadingLog('⏰ API 調用超時，請檢查網路連接', 'error');
                } else if (error.message.includes('404')) {
                    addLoadingLog('❌ 講師 API 不存在，請聯繫管理員', 'error');
                } else {
                    addLoadingLog(`❌ 比對失敗: ${error.message}`, 'error');
                }
            } finally {
                // 無論比對成功與否，都解析 Promise
                addLoadingLog('🏁 講師比對流程結束', 'info');
                resolve();
            }
            });
        }

        // 顯示比對過程
        function showMatchingProcess(message, type = 'info') {
            console.log(`[比對過程] ${message}`);
        }

        // 自動滑動到行事曆區域（所有裝置）
        function autoScrollToCalendar() {
            // 延遲一點時間確保頁面完全載入
            setTimeout(() => {
                // 滑動到視圖按鈕區域，讓今日本週每月按鈕切齊頂部
                const viewButtons = document.querySelector('.view-buttons');
                
                if (viewButtons) {
                    // 計算視圖按鈕的位置，讓按鈕齊平頂部
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // 滑動到視圖按鈕區域，讓按鈕齊平頂部
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`已自動滑動到視圖按鈕區域，讓今日本週每月按鈕切齊頂部`);
                } else {
                    // 如果沒有找到視圖按鈕，則滑動到主內容區域
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`已自動滑動到主內容區域，篩選區塊高度: ${controlHeight}px`);
                    }
                }
            }, 1000);
        }

        // 自動滾動到視圖按鈕（通用函數）
        function autoScrollToViewButtons() {
            console.log('🔄 開始自動滾動到視圖按鈕');
            
            // 使用與第一次載入時相同的滑動邏輯
            setTimeout(() => {
                // 滑動到視圖按鈕區域，讓今日本週每月按鈕切齊頂部
                const viewButtons = document.querySelector('.view-buttons');
                
                if (viewButtons) {
                    // 計算視圖按鈕的位置，讓按鈕齊平頂部
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // 滑動到視圖按鈕區域，讓按鈕齊平頂部
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`已自動滑動到視圖按鈕區域，讓今日本週每月按鈕切齊頂部`);
                } else {
                    // 如果沒有找到視圖按鈕，則滑動到主內容區域
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`已自動滑動到主內容區域，篩選區塊高度: ${controlHeight}px`);
                    }
                }
            }, 100);
        }

        // 模糊比對講師選項
        function findBestMatchingOption(selectElement, targetName) {
            if (!selectElement || !targetName) return null;
            
            const options = Array.from(selectElement.options);
            const target = targetName.toLowerCase().trim();
            
            console.log(`開始模糊比對講師選項，目標名稱: "${targetName}"`);
            
            // 1. 精確匹配
            for (let option of options) {
                if (option.value.toLowerCase().trim() === target) {
                    console.log(`✅ 精確匹配: ${option.value}`);
                    return option;
                }
            }
            
            // 2. 包含匹配
            for (let option of options) {
                const optionValue = option.value.toLowerCase().trim();
                if (optionValue.includes(target) || target.includes(optionValue)) {
                    console.log(`✅ 包含匹配: ${option.value}`);
                    return option;
                }
            }
            
            // 3. 相似度匹配
            let bestMatch = null;
            let bestSimilarity = 0;
            
            for (let option of options) {
                const optionValue = option.value.toLowerCase().trim();
                const similarity = calculateSimilarity(target, optionValue);
                
                console.log(`比對 "${option.value}": 相似度 ${Math.round(similarity * 100)}%`);
                
                if (similarity > bestSimilarity && similarity >= 0.5) { // 50% 相似度閾值
                    bestMatch = option;
                    bestSimilarity = similarity;
                }
            }
            
            if (bestMatch) {
                console.log(`✅ 相似度匹配: ${bestMatch.value} (${Math.round(bestSimilarity * 100)}%)`);
                return bestMatch;
            }
            
            console.log('❌ 未找到匹配的講師選項');
            return null;
        }

        // 計算字串相似度
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            if (str1.length === 0 || str2.length === 0) return 0;
            
            // 使用 Levenshtein 距離計算相似度
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;
            
            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            const maxLen = Math.max(len1, len2);
            return (maxLen - matrix[len2][len1]) / maxLen;
        }


        // 綁定重新整理按鈕事件
        function bindRefreshButton() {
            const refreshButton = document.getElementById('refreshButton');
            if (refreshButton) {
                // 移除舊的事件監聽器
                refreshButton.removeEventListener('click', handleRefreshClick);
                // 添加新的事件監聽器
                refreshButton.addEventListener('click', handleRefreshClick);
                console.log('✅ 重新整理按鈕事件已綁定');
            } else {
                console.warn('⚠️ 重新整理按鈕元素未找到');
            }
        }

        // 重新整理按鈕點擊處理函數
        function handleRefreshClick(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('🔄 重新整理按鈕被點擊');
            forceRefresh();
        }

        // 綁定匯出行事曆按鈕事件
        function bindExportButton() {
            const exportButton = document.getElementById('exportCalendarBtn');
            if (exportButton) {
                // 移除舊的事件監聽器
                exportButton.removeEventListener('click', handleExportClick);
                // 添加新的事件監聽器
                exportButton.addEventListener('click', handleExportClick);
                console.log('✅ 匯出行事曆按鈕事件已綁定');
            } else {
                console.warn('⚠️ 匯出行事曆按鈕元素未找到');
            }
        }

        // 匯出按鈕點擊處理函數
        function handleExportClick(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('📥 匯出行事曆按鈕被點擊');
            exportCalendar();
        }

        // 匯出行事曆功能
        function exportCalendar() {
            try {
                console.log('📥 開始匯出行事曆...');
                
                // 獲取當前篩選後的事件
                const filteredEvents = getFilteredEvents();
                
                if (filteredEvents.length === 0) {
                    alert('目前沒有可匯出的事件，請調整篩選條件後再試。');
                    return;
                }

                // 生成 iCal 格式的內容
                const icalContent = generateICalContent(filteredEvents);
                
                // 創建下載連結
                const blob = new Blob([icalContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // 創建下載連結
                const link = document.createElement('a');
                link.href = url;
                link.download = `講師行事曆_${new Date().toISOString().split('T')[0]}.ics`;
                
                // 觸發下載
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 清理 URL 物件
                URL.revokeObjectURL(url);
                
                console.log('✅ 行事曆匯出完成');
                
                // 顯示成功訊息
                showExportSuccessMessage();
                
            } catch (error) {
                console.error('❌ 匯出行事曆失敗:', error);
                alert('匯出行事曆時發生錯誤，請稍後再試。');
            }
        }

        // 生成 iCal 格式內容
        function generateICalContent(events) {
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            let ical = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//講師行事曆系統//講師行事曆檢視//ZH',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:講師行事曆',
                'X-WR-CALDESC:講師行事曆檢視系統匯出',
                'X-WR-TIMEZONE:Asia/Taipei'
            ];

            events.forEach(event => {
                if (!event || !event.start) return;

                const startDate = new Date(event.start);
                const endDate = event.end ? new Date(event.end) : new Date(startDate.getTime() + 60 * 60 * 1000); // 預設1小時
                
                // 格式化日期為 iCal 格式
                const formatDate = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                const startFormatted = formatDate(startDate);
                const endFormatted = formatDate(endDate);
                const createdFormatted = formatDate(now);

                // 清理事件標題和描述
                const title = (event.title || '未命名事件').replace(/[,;\\]/g, '\\$&');
                const description = (event.description || '').replace(/[,;\\]/g, '\\$&');
                const location = (event.location || '').replace(/[,;\\]/g, '\\$&');
                const instructor = (event.instructor || '').replace(/[,;\\]/g, '\\$&');

                ical.push('BEGIN:VEVENT');
                ical.push(`UID:${event.id || Date.now() + Math.random()}@instructor-calendar.local`);
                ical.push(`DTSTART:${startFormatted}`);
                ical.push(`DTEND:${endFormatted}`);
                ical.push(`DTSTAMP:${createdFormatted}`);
                ical.push(`SUMMARY:${title}`);
                ical.push(`DESCRIPTION:${description}\\n講師: ${instructor}`);
                ical.push(`LOCATION:${location}`);
                ical.push(`STATUS:CONFIRMED`);
                ical.push(`TRANSP:OPAQUE`);
                ical.push('END:VEVENT');
            });

            ical.push('END:VCALENDAR');
            
            return ical.join('\r\n');
        }

        // 顯示匯出成功訊息
        function showExportSuccessMessage() {
            // 創建成功訊息元素
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
                z-index: 10000;
                font-size: 16px;
                font-weight: 600;
                text-align: center;
                animation: fadeInOut 3s ease-in-out;
            `;
            
            successMsg.innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                行事曆已成功匯出！
                <br>
                <small style="opacity: 0.9; font-size: 14px;">請檢查您的下載資料夾</small>
            `;
            
            // 添加動畫樣式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
                    80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(successMsg);
            
            // 3秒後移除訊息
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
                if (style.parentNode) {
                    style.parentNode.removeChild(style);
                }
            }, 3000);
        }

        // 計算每位講師的下一個即將到來的課程
        function getUpcomingEventsByInstructor() {
            const now = new Date();
            const upcomingEvents = {};
            
            // 獲取所有有效的未來事件
            const futureEvents = allEvents.filter(event => {
                if (!event || !event.start || !event.instructor) return false;
                const eventDate = new Date(event.start);
                return eventDate > now; // 只考慮未來的事件
            });
            
            // 按講師分組並找到每個講師的下一個課程
            futureEvents.forEach(event => {
                const instructor = event.instructor;
                if (!upcomingEvents[instructor]) {
                    upcomingEvents[instructor] = event;
                } else {
                    // 比較時間，保留更早的課程
                    const currentUpcoming = new Date(upcomingEvents[instructor].start);
                    const newEvent = new Date(event.start);
                    if (newEvent < currentUpcoming) {
                        upcomingEvents[instructor] = event;
                    }
                }
            });
            
            console.log('📅 每位講師的下一個課程:', upcomingEvents);
            return upcomingEvents;
        }

        // 檢查事件是否為即將到來的課程
        function isUpcomingEvent(event) {
            if (!event || !event.start || !event.instructor) return false;
            
            const upcomingEvents = getUpcomingEventsByInstructor();
            const instructor = event.instructor;
            
            // 檢查是否為該講師的下一個課程
            if (upcomingEvents[instructor] && upcomingEvents[instructor].id === event.id) {
                return true;
            }
            
            return false;
        }

        // 計算距離課程開始的時間
        function getTimeUntilEvent(event) {
            if (!event || !event.start) return null;
            
            const now = new Date();
            const eventDate = new Date(event.start);
            const timeDiff = eventDate - now;
            
            if (timeDiff <= 0) return null; // 課程已開始或結束
            
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days}天${hours}小時`;
            } else if (hours > 0) {
                return `${hours}小時${minutes}分鐘`;
            } else {
                return `${minutes}分鐘`;
            }
        }

        // 強制重新整理行事曆
        async function forceRefresh() {
            const refreshButton = document.getElementById('refreshButton');
            const icon = refreshButton.querySelector('i');
            
            // 添加載入動畫
            refreshButton.classList.add('loading');
            icon.style.animation = 'spin 1s linear infinite';
            
            try {
                console.log('🔄 開始強制重新整理行事曆...');
                
                // 顯示載入動畫
                showLoadingAnimation();
                
                // 重新載入事件數據
                await loadTodayEvents();
                
                // 重新綁定所有事件監聽器
                bindViewButtons();
                updateViewButtonStates();
                
                // 更新統計和渲染
                updateStats();
                renderEvents();
                
                // 自動滾動到行事曆區域
                autoScrollToCalendar();
                
                console.log('✅ 行事曆重新整理完成');
                
                // 顯示成功提示
                addLoadingLog('✅ 行事曆已重新整理', 'success');
                
            } catch (error) {
                console.error('❌ 重新整理失敗:', error);
                addLoadingLog('❌ 重新整理失敗: ' + error.message, 'error');
            } finally {
                // 移除載入動畫
                refreshButton.classList.remove('loading');
                icon.style.animation = '';
                
                // 隱藏載入動畫
                setTimeout(() => {
                    hideLoadingAnimation();
                }, 500);
            }
        }

        // 顯示指定步驟
        function showStep(stepNumber) {
            console.log('跳轉到步驟:', stepNumber);
            
            // 更新步驟狀態
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed', 'pending');
                
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
            
            // 根據步驟顯示/隱藏相關內容
            if (stepNumber === 2) {
                // 第二步：查看行事曆 - 確保行事曆區域可見
                const calendarSection = document.querySelector('.calendar-section');
                if (calendarSection) {
                    calendarSection.style.display = 'block';
                }
                
                // 自動滑動到視圖按鈕區域，讓今日本週每月按鈕切齊頂部
                const viewButtons = document.querySelector('.view-buttons');
                if (viewButtons) {
                    // 計算視圖按鈕的位置，讓按鈕齊平頂部
                    const viewButtonsRect = viewButtons.getBoundingClientRect();
                    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetScrollTop = currentScrollTop + viewButtonsRect.top;
                    
                    // 滑動到視圖按鈕區域，讓按鈕齊平頂部
                    window.scrollTo({
                        top: targetScrollTop,
                        behavior: 'smooth'
                    });
                    console.log(`已自動滑動到視圖按鈕區域，讓今日本週每月按鈕切齊頂部`);
                } else {
                    // 如果沒有找到視圖按鈕，則滑動到主內容區域
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const controlSection = document.querySelector('.control-section');
                        const controlHeight = controlSection ? controlSection.offsetHeight : 0;
                        
                        window.scrollTo({
                            top: controlHeight + 10,
                            behavior: 'smooth'
                        });
                        console.log(`已自動滑動到主內容區域，篩選區塊高度: ${controlHeight}px`);
                    }
                }
            }
        }


        // 高亮視圖按鈕
        function highlightViewButton(viewName) {
            // 移除所有按鈕的 active 狀態
            const allButtons = document.querySelectorAll('.view-buttons .btn');
            allButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '';
                btn.style.transition = 'all 0.3s ease';
            });
            
            // 添加目標按鈕的 active 狀態
            const targetButton = document.querySelector(`[data-view="${viewName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
                
                // 添加高亮動畫 - 更明顯的效果
                targetButton.style.transform = 'scale(1.1)';
                targetButton.style.boxShadow = '0 6px 12px rgba(0, 123, 255, 0.4)';
                targetButton.style.transition = 'all 0.3s ease';
                targetButton.style.zIndex = '10';
                
                // 添加脈衝動畫
                targetButton.style.animation = 'buttonPulse 0.6s ease-out';
                
                setTimeout(() => {
                    targetButton.style.transform = 'scale(1.05)';
                    targetButton.style.boxShadow = '0 4px 8px rgba(0, 123, 255, 0.3)';
                    targetButton.style.animation = '';
                }, 300);
            }
        }

        // 滑動功能已移除 - 避免與按鈕點擊衝突

        // 設置事件監聽器
        function setupEventListeners() {
            // 滑動功能已移除
            
            // 講師篩選事件監聽器
            const instructorSelect = document.getElementById('instructorSelect');
            if (instructorSelect) {
                instructorSelect.addEventListener('change', function() {
                    const selectedInstructor = this.value;
                    console.log('📱 講師選擇變更:', selectedInstructor);
                    
                    if (selectedInstructor) {
                        // 智慧判斷：檢查講師在不同視圖下的事件數量
                        const instructorEvents = allEvents.filter(event => 
                            event && event.instructor === selectedInstructor
                        );
                        
                        if (instructorEvents.length === 0) {
                            console.log('⚠️ 該講師沒有任何事件');
                            currentView = '全部';
                            window.currentView = '全部';
                        } else {
                            // 檢查今日是否有事件
                            const now = new Date();
                            const todayEvents = instructorEvents.filter(event => {
                                const eventDate = new Date(event.start);
                                return eventDate.getFullYear() === now.getFullYear() &&
                                       eventDate.getMonth() === now.getMonth() &&
                                       eventDate.getDate() === now.getDate();
                            });
                            
                            if (todayEvents.length > 0) {
                                console.log('✅ 講師今日有事件，保持今日視圖');
                                currentView = '今日';
                                window.currentView = '今日';
                            } else {
                                // 檢查本週是否有事件
                                const weekStart = new Date(now);
                                const dayOfWeek = now.getDay();
                                const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                                weekStart.setDate(now.getDate() + daysToMonday);
                                weekStart.setHours(0, 0, 0, 0);
                                const weekEnd = new Date(weekStart);
                                weekEnd.setDate(weekStart.getDate() + 6);
                                weekEnd.setHours(23, 59, 59, 999);
                                
                                const weekEvents = instructorEvents.filter(event => {
                                    const eventDate = new Date(event.start);
                                    return eventDate >= weekStart && eventDate <= weekEnd;
                                });
                                
                                if (weekEvents.length > 0) {
                                    console.log('✅ 講師本週有事件，切換到本週視圖');
                                    currentView = '本週';
                                    window.currentView = '本週';
                                } else {
                                    // 檢查本月是否有事件
                                    const monthEvents = instructorEvents.filter(event => {
                                        const eventDate = new Date(event.start);
                                        return eventDate.getFullYear() === now.getFullYear() &&
                                               eventDate.getMonth() === now.getMonth();
                                    });
                                    
                                    if (monthEvents.length > 0) {
                                        console.log('✅ 講師本月有事件，切換到本月視圖');
                                        currentView = '本月';
                                        window.currentView = '本月';
                                    } else {
                                        console.log('✅ 講師只有其他月份的事件，切換到全部視圖');
                                        currentView = '全部';
                                        window.currentView = '全部';
                                    }
                                }
                            }
                        }
                    } else {
                        // 選擇全部講師時重置為今日視圖
                        currentView = '今日';
                        window.currentView = '今日';
                    }
                    
                    updateViewButtonStates();
                    updateTimeFilterOptions(); // 更新時段篩選選項
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // 自動滾動到視圖按鈕
                    console.log('📱 講師選擇後智慧切換視圖:', currentView);
                });
            }
            
            // 時段篩選事件監聽器
            const timeFilter = document.getElementById('timeFilter');
            if (timeFilter) {
                timeFilter.addEventListener('change', function() {
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // 自動滾動到視圖按鈕
                });
            }
            
            // 日期篩選事件監聽器
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    updateStats();
                    renderEvents();
                    autoScrollToViewButtons(); // 自動滾動到視圖按鈕
                });
            }
            
            
            
            
            
            // 設置初始選中狀態（移除延遲）
            updateViewButtonStates();
            
            // 快速篩選功能已移除
            
            // 綁定用戶按鈕事件監聽器
            const bindUserBtn = document.getElementById('bindUserBtn');
            if (bindUserBtn) {
                bindUserBtn.addEventListener('click', bindUser);
            }
        }



        // 生成隨機馬卡龍顏色
        function generateRandomMacaronColor() {
            const macaronColors = [
                'rgba(255, 182, 193, 0.8)', 'rgba(116, 185, 255, 0.8)', 'rgba(255, 223, 102, 0.8)', 
                'rgba(180, 167, 214, 0.8)', 'rgba(0, 184, 148, 0.8)', 'rgba(255, 192, 203, 0.8)',
                'rgba(162, 155, 254, 0.8)', 'rgba(85, 239, 196, 0.8)', 'rgba(255, 118, 117, 0.8)', 
                'rgba(108, 92, 231, 0.8)', 'rgba(232, 67, 147, 0.8)', 'rgba(0, 206, 201, 0.8)',
                'rgba(255, 159, 67, 0.8)', 'rgba(255, 107, 107, 0.8)', 'rgba(46, 204, 113, 0.8)',
                'rgba(155, 89, 182, 0.8)', 'rgba(52, 152, 219, 0.8)', 'rgba(241, 196, 15, 0.8)'
            ];
            return macaronColors[Math.floor(Math.random() * macaronColors.length)];
        }

        // 載入設置
        function loadSettings() {
            const saved = localStorage.getItem('calendarSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                colorSettings = { ...colorSettings, ...settings.colors };
                instructorColors = settings.instructorColors || {};
                applyColorSettings();
            }
            // 注意：講師顏色將在 loadEvents 完成後生成
        }

        // 為講師生成隨機馬卡龍顏色
        function generateRandomInstructorColors() {
            allInstructors.forEach(instructor => {
                if (!instructorColors[instructor]) {
                    instructorColors[instructor] = generateRandomMacaronColor();
                }
            });
        }

        // 儲存設置
        function saveSettings() {
            // 更新顏色設置（將 hex 轉換為 rgba）
            colorSettings.esm = hexToRgba(document.getElementById('esmColor').value, 0.8);
            colorSettings.spm = hexToRgba(document.getElementById('spmColor').value, 0.8);
            colorSettings.boost = hexToRgba(document.getElementById('boostColor').value, 0.8);
            colorSettings.spike = hexToRgba(document.getElementById('spikeColor').value, 0.8);
            colorSettings.ev3 = hexToRgba(document.getElementById('ev3Color').value, 0.8);
            colorSettings.minecraft = hexToRgba(document.getElementById('minecraftColor').value, 0.8);

            const settings = {
                colors: colorSettings,
                instructorColors: instructorColors
            };
            localStorage.setItem('calendarSettings', JSON.stringify(settings));
            applyColorSettings();
            closeSettings();
        }

        // 應用顏色設置
        function applyColorSettings() {
            // 更新CSS變數
            document.documentElement.style.setProperty('--esm-color', colorSettings.esm);
            document.documentElement.style.setProperty('--spm-color', colorSettings.spm);
            document.documentElement.style.setProperty('--boost-color', colorSettings.boost);
            document.documentElement.style.setProperty('--spike-color', colorSettings.spike);
            document.documentElement.style.setProperty('--ev3-color', colorSettings.ev3);
            document.documentElement.style.setProperty('--minecraft-color', colorSettings.minecraft);
            
            // 重新渲染事件
            if (allEvents.length > 0) {
                renderEvents();
            }
        }

        // 打開設置畫面
        function openSettings() {
            document.getElementById('settingsOverlay').style.display = 'flex';
            
            // 確保講師顏色已經生成
            if (allInstructors && allInstructors.length > 0) {
                generateRandomInstructorColors();
            }
            
            populateSettingsModal();
        }

        // 填充設置模態框
        function populateSettingsModal() {
            // 設置課程類型顏色（將 rgba 轉換為 hex）
            document.getElementById('esmColor').value = rgbaToHex(colorSettings.esm);
            document.getElementById('spmColor').value = rgbaToHex(colorSettings.spm);
            document.getElementById('boostColor').value = rgbaToHex(colorSettings.boost);
            document.getElementById('spikeColor').value = rgbaToHex(colorSettings.spike);
            document.getElementById('ev3Color').value = rgbaToHex(colorSettings.ev3);
            document.getElementById('minecraftColor').value = rgbaToHex(colorSettings.minecraft);
            
            // 填充講師顏色設置
            populateInstructorColorSettings();
        }

        // 關閉設置畫面
        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }

        // 填充講師顏色設置
        function populateInstructorColorSettings() {
            const container = document.getElementById('instructorColorGroup');
            container.innerHTML = '';
            
            // 確保 allInstructors 已經載入
            if (!allInstructors || allInstructors.length === 0) {
                console.log('講師列表尚未載入，無法填充顏色設置');
                return;
            }
            
            console.log('填充講師顏色設置，講師列表:', allInstructors);
            console.log('當前講師顏色:', instructorColors);
            
            allInstructors.forEach(instructor => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-picker-item'; // 使用與教案類型顏色相同的 class
                const currentColor = instructorColors[instructor] || generateRandomMacaronColor();
                const hexColor = rgbaToHex(currentColor);
                console.log(`講師 ${instructor} 的顏色: ${currentColor} -> ${hexColor}`);
                
                colorItem.innerHTML = `
                    <label>${instructor}</label>
                    <input type="color" class="color-picker" 
                           id="instructor_${instructor}" 
                           value="${hexColor}"
                           onchange="updateInstructorColor('${instructor}', this.value)">
                `;
                container.appendChild(colorItem);
            });
        }

        // 更新講師顏色
        function updateInstructorColor(instructor, color) {
            // 將 hex 顏色轉換為 rgba 格式
            const rgbaColor = hexToRgba(color, 0.8);
            instructorColors[instructor] = rgbaColor;
        }

        // 將 hex 顏色轉換為 rgba 格式
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // 將 rgba 顏色轉換為 hex 格式（用於顏色選擇器）
        function rgbaToHex(rgba) {
            const values = rgba.match(/\d+/g);
            if (values && values.length >= 3) {
                const r = parseInt(values[0]);
                const g = parseInt(values[1]);
                const b = parseInt(values[2]);
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            return '#000000';
        }

// 載入當日事件（直接載入完整數據）
async function loadTodayEvents() {
    try {
        console.log('🚀 開始載入完整事件數據...');
        addLoadingLog('🌐 正在連接 CalDAV 伺服器...', 'info');
        
                const response = await fetch('/api/events');
        addLoadingLog('📡 正在獲取行事曆資料...', 'info');
        
                const data = await response.json();
                
                if (data.success) {
            addLoadingLog(`📊 成功獲取 ${data.data.length} 個事件`, 'success');
            
                    // 過濾掉 null 值和無效事件
                    allEvents = data.data.filter(event => {
                        if (!event) {
                            console.warn('⚠️ loadTodayEvents: 發現 null 事件，已過濾');
                            return false;
                        }
                        if (!event.start || !event.end || !event.title || !event.instructor) {
                            console.warn('⚠️ loadTodayEvents: 事件缺少必要屬性，已過濾', event);
                            return false;
                        }
                        return true;
                    });
                    
                    console.log('🔍 loadTodayEvents: allEvents 過濾完成，數量:', allEvents.length);
                    console.log('🔍 loadTodayEvents: allEvents 前5個事件:', allEvents.slice(0, 5));
                    
                    // 調試 allEvents 的狀態
                    console.log('🔍 loadTodayEvents: 開始填充 allInstructors');
                    console.log('🔍 loadTodayEvents: allEvents 長度:', allEvents.length);
                    console.log('🔍 loadTodayEvents: allEvents 前3個事件的講師:', allEvents.slice(0, 3).map(event => event.instructor));
                    
                    allInstructors = [...new Set(allEvents.map(event => event.instructor).filter(Boolean))];
            
            console.log('🔍 loadTodayEvents: allInstructors 填充完成:', allInstructors);
            addLoadingLog(`👥 發現 ${allInstructors.length} 位講師`, 'info');
                    
                    // 為新講師生成隨機馬卡龍顏色（如果沒有保存的設置）
                    if (Object.keys(instructorColors).length === 0) {
                addLoadingLog('🎨 正在生成講師顏色配置...', 'info');
                        generateRandomInstructorColors();
                    }
                    
                    addLoadingLog('🔄 正在渲染事件列表...', 'info');
                    await populateInstructorDropdown();
                    renderEvents();
                    updateStats();
                    
            
            console.log(`✅ 完整事件載入完成: ${allEvents.length} 個事件`);
            addLoadingLog(`✅ 載入完成！共 ${allEvents.length} 個事件`, 'success');
            hideLoadingMessage();
                } else {
                    showError('載入事件失敗: ' + data.message);
                }
            } catch (error) {
                console.error('載入事件錯誤:', error);
                showError('無法連接到服務器');
    }
}


        // 載入事件資料（向後相容）
        async function loadEvents() {
            return loadTodayEvents();
        }

        // 載入日誌管理
        let loadingLogs = [];
        
        function addLoadingLog(message, type = 'info') {
            const logItem = {
                message,
                type,
                timestamp: new Date().toLocaleTimeString()
            };
            loadingLogs.push(logItem);
            
            const logsContainer = document.getElementById('loadingLogs');
            if (logsContainer) {
                const logElement = document.createElement('div');
                logElement.className = `loading-log-item ${type}`;
                
                const icon = {
                    'success': '✅',
                    'warning': '⚠️',
                    'error': '❌',
                    'info': 'ℹ️'
                }[type] || 'ℹ️';
                
                logElement.innerHTML = `
                    <span class="loading-log-icon">${icon}</span>
                    <span>[${logItem.timestamp}] ${message}</span>
                `;
                
                logsContainer.appendChild(logElement);
                
                // 自動滾動到最新日誌
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        // 顯示載入進度提示
        function showLoadingMessage(message) {
            addLoadingLog(message, 'info');
            // 移除現有的載入提示
            const existingMessage = document.getElementById('loading-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // 創建載入提示元素
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 123, 255, 0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            loadingDiv.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                ${message}
            `;
            
            document.body.appendChild(loadingDiv);
        }

        // 隱藏載入進度提示
        function hideLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (loadingMessage.parentNode) {
                        loadingMessage.remove();
                    }
                }, 300);
            }
        }

        // 填充講師下拉選單
        async function populateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            const currentValue = select.value; // 保存當前選擇
            
            console.log('🔄 填充講師下拉選單，當前選擇:', currentValue);
            console.log('🔄 可用講師列表:', allInstructors);
            
            try {
            select.innerHTML = '<option value="">全部講師</option>';
            
                let instructors = [];
                
                // 方法1: 使用 allInstructors
                if (allInstructors && allInstructors.length > 0) {
                    console.log('✅ 使用 allInstructors，數量:', allInstructors.length);
                    instructors = [...allInstructors];
                } else {
                    // 方法2: 直接從 API 獲取並提取講師列表
                    console.log('⚠️ allInstructors 為空，直接從 API 獲取講師列表');
                    try {
                        const response = await fetch('/api/events');
                        const data = await response.json();
                        
                        if (data.success && data.data) {
                            instructors = [...new Set(data.data
                                .filter(event => event && event.instructor)
                                .map(event => event.instructor)
                            )].sort();
                            
                            console.log('📡 從 API 獲取的講師列表:', instructors);
                        } else {
                            // 方法3: 使用硬編碼的測試講師
                            console.log('⚠️ API 獲取失敗，使用測試講師');
                            instructors = ['AGNES', 'BELLA', 'TIM', 'ALICE'];
                        }
                    } catch (apiError) {
                        console.error('❌ API 調用失敗:', apiError);
                        // 方法3: 使用硬編碼的測試講師
                        instructors = ['AGNES', 'BELLA', 'TIM', 'ALICE'];
                    }
                }
                
                // 排序講師列表：已選擇的講師排在前面
                if (currentValue && instructors.includes(currentValue)) {
                    // 將當前選擇的講師移到最前面
                    instructors = [currentValue, ...instructors.filter(inst => inst !== currentValue)];
                    console.log('🔄 已選擇講師優先排序:', instructors);
                }
                
                // 創建選項
                instructors.forEach(instructor => {
                    const option = document.createElement('option');
                    option.value = instructor;
                    option.textContent = instructor;
                    select.appendChild(option);
                });
                
                // 恢復之前的選擇
                if (currentValue) {
                    select.value = currentValue;
                    console.log('🔄 恢復講師選擇:', currentValue);
                }
                
                console.log('✅ populateInstructorDropdown 執行完成，講師選項數量:', select.options.length);
            } catch (error) {
                console.error('❌ populateInstructorDropdown 執行失敗:', error);
                // 即使失敗也要確保有基本選項
                select.innerHTML = '<option value="">全部講師</option><option value="ERROR">發生錯誤</option><option value="AGNES">[測試] AGNES</option><option value="BELLA">[測試] BELLA</option>';
            }
        }

        // 更新講師下拉選單（不重新渲染整個畫面）
        function updateInstructorDropdown() {
            const select = document.getElementById('instructorSelect');
            const currentValue = select.value;
            
            // 清空現有選項（除了"全部講師"）
            select.innerHTML = '<option value="">全部講師</option>';

            // 添加所有講師選項
            allInstructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor;
                option.textContent = instructor;
                select.appendChild(option);
            });
            
            // 恢復之前選中的值
            if (currentValue && allInstructors.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // 更新時段篩選選項（智慧算法）
        function updateTimeFilterOptions() {
            const timeFilter = document.getElementById('timeFilter');
            const instructorFilter = document.getElementById('instructorSelect').value;
            
            if (!timeFilter) return;
            
            // 保存當前選擇
            const currentValue = timeFilter.value;
            
            // 清空現有選項
            timeFilter.innerHTML = '<option value="">全部時段</option>';
            
            // 獲取要統計的事件（根據講師篩選）
            let eventsToAnalyze = allEvents;
            if (instructorFilter) {
                eventsToAnalyze = allEvents.filter(event => 
                    event && event.instructor === instructorFilter
                );
            }
            
            // 統計時段分布
            const timeSlots = {
                morning: 0,
                afternoon: 0,
                evening: 0
            };
            
            eventsToAnalyze.forEach(event => {
                if (event.start) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    
                    if (hour >= 6 && hour < 12) {
                        timeSlots.morning++;
                    } else if (hour >= 12 && hour < 18) {
                        timeSlots.afternoon++;
                    } else if (hour >= 18 && hour < 24) {
                        timeSlots.evening++;
                    }
                }
            });
            
            // 只添加有事件的時段選項
            if (timeSlots.morning > 0) {
                const option = document.createElement('option');
                option.value = 'morning';
                option.textContent = `上午 (${timeSlots.morning})`;
                timeFilter.appendChild(option);
            }
            
            if (timeSlots.afternoon > 0) {
                const option = document.createElement('option');
                option.value = 'afternoon';
                option.textContent = `下午 (${timeSlots.afternoon})`;
                timeFilter.appendChild(option);
            }
            
            if (timeSlots.evening > 0) {
                const option = document.createElement('option');
                option.value = 'evening';
                option.textContent = `晚上 (${timeSlots.evening})`;
                timeFilter.appendChild(option);
            }
            
            console.log('🕐 智慧時段篩選更新:', timeSlots, '講師:', instructorFilter || '全部');
            
            // 恢復之前的選擇（如果該選項仍然存在）
            if (currentValue && timeFilter.querySelector(`option[value="${currentValue}"]`)) {
                timeFilter.value = currentValue;
            } else {
                timeFilter.value = '';
            }
        }

        // 視圖按鈕點擊處理函數
        function handleViewButtonClick(e) {
            console.log('🎯 handleViewButtonClick 被調用', {
                eventType: e.type,
                target: this,
                dataView: this.getAttribute('data-view'),
                currentView: currentView,
                timestamp: new Date().toISOString()
            });
            
            // 防止滑動事件干擾點擊
            e.preventDefault();
            e.stopPropagation();
            
            const view = this.getAttribute('data-view');
            console.log(`📱 按鈕點擊：切換到 ${view}`, {
                eventType: e.type,
                target: this,
                currentView: currentView,
                buttonText: this.textContent,
                buttonClass: this.className
            });
            
            // 觸發按鈕高亮動畫
            highlightViewButton(view);
            
            // 切換視圖
            switchView(view);
            
            // 更新按鈕狀態和重新渲染（移除延遲）
            updateViewButtonStates();
            updateStats();
            renderEvents();
            autoScrollToViewButtons(); // 自動滾動到視圖按鈕
            console.log(`📱 視圖已切換到 ${view}，事件已重新渲染`);
        }

        // 為視圖按鈕添加事件監聽器
        function bindViewButtons() {
            console.log('🔗 開始綁定視圖按鈕...');
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            console.log(`🔗 找到 ${viewButtons.length} 個視圖按鈕`);
            
            // 檢查用戶代理
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
            console.log('📱 設備檢測:', { userAgent, isIOS, isSafari });
            
            if (viewButtons.length === 0) {
                console.error('❌ 找不到視圖按鈕，請檢查 HTML 結構');
                // 檢查 DOM 結構
                const viewButtonsContainer = document.querySelector('.view-buttons');
                if (viewButtonsContainer) {
                    console.log('❌ view-buttons 容器存在，但沒有按鈕');
                    console.log('❌ 容器內容:', viewButtonsContainer.innerHTML);
                } else {
                    console.log('❌ view-buttons 容器不存在');
                }
                return;
            }
            
            viewButtons.forEach((button, index) => {
                console.log(`🔗 綁定按鈕 ${index + 1}: ${button.getAttribute('data-view')}`);
                
                // 清除所有舊的事件監聽器和屬性
                button.removeEventListener('click', handleViewButtonClick);
                button.removeEventListener('touchstart', handleViewButtonClick);
                button.removeEventListener('touchend', handleViewButtonClick);
                button.removeEventListener('mousedown', handleViewButtonClick);
                button.removeEventListener('touchend', handleViewButtonClick);
                button.onclick = null;
                
                // iOS Safari 特殊樣式設置
                button.style.pointerEvents = 'auto';
                button.style.cursor = 'pointer';
                button.style.userSelect = 'none';
                button.style.webkitUserSelect = 'none';
                button.style.webkitTouchCallout = 'none';
                button.style.webkitTapHighlightColor = 'transparent';
                button.style.position = 'relative';
                button.style.zIndex = '10';
                button.style.display = 'block';
                button.style.width = '100%';
                button.style.height = 'auto';
                button.style.minHeight = '44px'; // iOS 最小觸控區域
                
                // iOS Safari 觸控優化
                if (isIOS) {
                    button.style.touchAction = 'manipulation';
                    button.style.webkitTouchCallout = 'none';
                    button.style.webkitUserSelect = 'none';
                    button.style.webkitTapHighlightColor = 'rgba(0, 0, 0, 0.1)';
                    button.style.border = 'none';
                    button.style.outline = 'none';
                    button.style.appearance = 'none';
                    button.style.webkitAppearance = 'none';
                } else {
                    button.style.touchAction = 'manipulation';
                }
                
                // 簡化的按鈕事件處理 - 確保按鈕可以正常點擊
                const buttonClickHandler = function(e) {
                    console.log(`📱 按鈕點擊觸發: ${button.getAttribute('data-view')}`);
                    e.preventDefault();
                    e.stopPropagation();
                    handleViewButtonClick.call(this, e);
                };
                
                // 清除所有舊的事件監聽器
                button.removeEventListener('click', buttonClickHandler);
                button.removeEventListener('touchstart', buttonClickHandler);
                button.removeEventListener('touchend', buttonClickHandler);
                button.removeEventListener('mousedown', buttonClickHandler);
                
                // 添加新的事件監聽器
                button.addEventListener('click', buttonClickHandler, { passive: false });
                button.addEventListener('touchstart', buttonClickHandler, { passive: false });
                button.addEventListener('touchend', buttonClickHandler, { passive: false });
                
                // 強制 onclick 作為備用方案
                button.onclick = buttonClickHandler;
                
                console.log(`✅ 按鈕 ${index + 1} 綁定完成: ${button.getAttribute('data-view')}`);
            });
            
            // 更新按鈕狀態（移除延遲）
            updateViewButtonStates();
            console.log('📱 按鈕狀態已更新');
        }

        // 更新視圖按鈕狀態
        function updateViewButtonStates() {
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            
            // 中英文對應關係
            const viewMap = {
                '今日': 'today',
                '本週': 'week', 
                '本月': 'month',
                '全部': 'all'
            };
            
            const englishCurrentView = viewMap[currentView] || currentView;
            
            viewButtons.forEach(button => {
                const view = button.getAttribute('data-view');
                if (view === englishCurrentView) {
                    button.classList.add('active');
                    console.log(`✅ 按鈕 ${view} (${currentView}) 設為選中狀態`);
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // iOS Safari 按鈕測試函數
        function testIOSButtons() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            
            if (isIOS) {
                console.log('🍎 開始 iOS Safari 按鈕測試...');
                const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
                
                viewButtons.forEach((button, index) => {
                    console.log(`🍎 測試按鈕 ${index + 1}: ${button.getAttribute('data-view')}`);
                    console.log(`🍎 按鈕樣式:`, {
                        pointerEvents: button.style.pointerEvents,
                        touchAction: button.style.touchAction,
                        webkitUserSelect: button.style.webkitUserSelect,
                        minHeight: button.style.minHeight,
                        display: button.style.display,
                        width: button.style.width
                    });
                    
                    // 強制觸發測試
                    button.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                    setTimeout(() => {
                        button.style.backgroundColor = '';
                    }, 1000);
                });
            }
        }

        // 切換檢視模式
        function switchView(view) {
            // 將英文視圖轉換為中文
            const viewMap = {
                'today': '今日',
                'week': '本週',
                'month': '本月',
                'all': '全部'
            };
            
            const chineseView = viewMap[view] || view;
            currentView = chineseView;
            
            console.log('🔄 switchView - 切換到視圖:', chineseView, '原始視圖:', view);
            
            // 更新按鈕選中狀態
            updateViewButtonStates();
            window.currentView = chineseView; // 設置全局變量
            
            // 更新按鈕狀態 - 只針對視圖按鈕
            const viewButtons = document.querySelectorAll('.view-buttons .btn-primary');
            viewButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 找到對應的按鈕並設為活躍
            viewButtons.forEach(btn => {
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                }
            });
            
            
            
            // 更新統計資訊（包括日期範圍）
            updateStats();
            renderEvents();
        }


        // 通用篩選函數，根據當前篩選條件篩選事件（不包含視圖篩選）
        function getFilteredEvents() {
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            console.log('🔍 getFilteredEvents - 篩選條件:', {
                instructorFilter,
                timeFilter,
                dateFilter,
                totalEvents: allEvents.length
            });
            
            const filtered = allEvents.filter(event => {
                const eventDate = new Date(event.start);
                
                // 講師篩選
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // 時段篩選
                if (timeFilter) {
                    const hour = eventDate.getHours();
                    let timeMatch = false;
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    if (!timeMatch) return false;
                }
                
                // 指定日期篩選
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const eventYear = eventDate.getFullYear();
                    const eventMonth = eventDate.getMonth();
                    const eventDay = eventDate.getDate();
                    const filterYear = filterDate.getFullYear();
                    const filterMonth = filterDate.getMonth();
                    const filterDay = filterDate.getDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // 快速篩選日期範圍
                if (window.currentQuickFilterRange) {
                    const range = window.currentQuickFilterRange;
                    const eventTime = eventDate.getTime();
                    if (eventTime < range.start.getTime() || eventTime > range.end.getTime()) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log('🔍 getFilteredEvents - 篩選結果:', filtered.length);
            return filtered;
        }

        // 未使用的 getViewFilteredEvents 函數已移除


        // 移除快速篩選功能 - 所有快速篩選相關代碼已移除
        
        // 渲染事件列表
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            console.log('🎨 renderEvents - 開始篩選，總事件數:', allEvents.length, '當前視圖:', currentView);
            
            // 使用簡單直接的篩選邏輯，先過濾掉 null 值
            let filteredEvents = allEvents.filter(event => {
                // 先檢查事件是否為 null 或 undefined
                if (!event) {
                    console.warn('⚠️ renderEvents: 發現 null 事件，已過濾');
                    return false;
                }
                
                // 檢查必要屬性是否存在
                if (!event.start || !event.end || !event.title || !event.instructor) {
                    console.warn('⚠️ renderEvents: 事件缺少必要屬性，已過濾', event);
                    return false;
                }
                
                return true;
            }).filter(event => {
                // 講師篩選
                if (instructorFilter && event.instructor !== instructorFilter) {
                    return false;
                }
                
                // 時段篩選
                if (timeFilter) {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    let timeMatch = false;
                    
                    switch (timeFilter) {
                        case 'morning':
                            timeMatch = hour >= 6 && hour < 12;
                            break;
                        case 'afternoon':
                            timeMatch = hour >= 12 && hour < 18;
                            break;
                        case 'evening':
                            timeMatch = hour >= 18 && hour < 24;
                            break;
                    }
                    
                    if (!timeMatch) {
                    return false;
                    }
                }
                
                // 指定日期篩選
                if (dateFilter) {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    const eventYear = eventDate.getFullYear();
                    const eventMonth = eventDate.getMonth();
                    const eventDay = eventDate.getDate();
                    const filterYear = filterDate.getFullYear();
                    const filterMonth = filterDate.getMonth();
                    const filterDay = filterDate.getDate();
                    
                    if (eventYear !== filterYear || eventMonth !== filterMonth || eventDay !== filterDay) {
                        return false;
                    }
                }
                
                // 視圖篩選
                const eventDate = new Date(event.start);
                const now = new Date();
                
                let shouldShow = false;
                switch (currentView) {
                    case '今日':
                        const eventYear = eventDate.getFullYear();
                        const eventMonth = eventDate.getMonth();
                        const eventDay = eventDate.getDate();
                        const nowYear = now.getFullYear();
                        const nowMonth = now.getMonth();
                        const nowDay = now.getDate();
                        shouldShow = eventYear === nowYear && eventMonth === nowMonth && eventDay === nowDay;
                        break;
                    case '本週':
                        const weekStart = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        weekStart.setDate(now.getDate() + daysToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        weekEnd.setHours(23, 59, 59, 999);
                        shouldShow = eventDate >= weekStart && eventDate <= weekEnd;
                        break;
                    case '本月':
                        shouldShow = eventDate.getFullYear() === now.getFullYear() && 
                                   eventDate.getMonth() === now.getMonth();
                        break;
                    case '全部':
                    default:
                        shouldShow = true;
                }
                
                return shouldShow;
            });
            
            console.log('🎨 renderEvents - 篩選後事件數量:', filteredEvents.length, '當前視圖:', currentView);
            
            // 清空容器
            if (container) {
                container.innerHTML = '';
            }
            
            // 排序事件
            filteredEvents.sort((a, b) => {
                const now = new Date();
                const eventA = new Date(a.start);
                const eventB = new Date(b.start);
                const endA = new Date(a.end);
                const endB = new Date(b.end);
                
                // 判斷事件狀態
                const isEventAOngoing = eventA <= now && endA > now;
                const isEventBOngoing = eventB <= now && endB > now;
                const isEventAPast = endA < now;
                const isEventBPast = endB < now;
                const isEventAUpcoming = eventA > now;
                const isEventBUpcoming = eventB > now;
                
                // 優先排序：正在進行中 > 即將開始 > 已結束
                if (isEventAOngoing && !isEventBOngoing) return -1;
                if (!isEventAOngoing && isEventBOngoing) return 1;
                
                if (isEventAUpcoming && isEventBPast) return -1;
                if (isEventAPast && isEventBUpcoming) return 1;
                
                // 在相同狀態下，按時間排序
                return eventA - eventB;
            });
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="no-events">
                        <i class="fas fa-calendar-times"></i>
                        <h3>沒有找到事件</h3>
                        <p>請嘗試調整篩選條件</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredEvents.map(event => createEventCard(event)).join('');
            
            // 觸發事件卡片動畫（移除延遲）
            animateEventCards();
            // 更新倒數計時
            updateAllCountdowns();
        }
        
        // 從標題解析時間
        function parseTimeFromTitle(title) {
            // 匹配格式如 "18:30-20:30", "14:30-15:30", "16:30-17:30", "1630-1730" 等
            const timeMatch = title.match(/(\d{1,2}):?(\d{2})-(\d{1,2}):?(\d{2})/);
            if (timeMatch) {
                const startHour = timeMatch[1];
                const startMin = timeMatch[2];
                const endHour = timeMatch[3];
                const endMin = timeMatch[4];
                
                // 格式化時間為 HH:MM 格式
                const startTime = `${startHour.padStart(2, '0')}:${startMin}`;
                const endTime = `${endHour.padStart(2, '0')}:${endMin}`;
                
                return {
                    startTime: startTime,
                    endTime: endTime,
                    timeString: `${startTime} - ${endTime}`
                };
            }
            return null;
        }
        
        // 從標題解析日期（根據星期幾）
        function parseDateFromTitle(title, baseDate = new Date()) {
            // 直接使用 CalDAV 的日期，不重新計算
            // 因為 CalDAV 已經提供了正確的日期
            return baseDate;
        }

        // 計算週次（ISO 8601 標準）
        function getWeekNumber(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        // 獲取星期幾（中文）
        function getWeekday(date) {
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            return weekdays[date.getDay()];
        }
        
        // 檢查是否為停課/請假
        function isCancelled(event) {
            const title = event.title.toLowerCase();
            const description = (event.description || '').toLowerCase();
            const cancelledKeywords = ['請假', '停課', '取消', '暫停', '休息', '放假'];
            
            return cancelledKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // 檢查是否為代課/帶班事件
        function isSubstitute(event) {
            const title = event.title || '';
            const description = event.description || '';
            
            const substituteKeywords = ['代課', '帶班', '代理', '支援'];
            
            return substituteKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // 獲取代課/帶班信息
        function getSubstituteInfo(event) {
            const title = event.title || '';
            const description = event.description || '';
            
            // 從標題中提取代課信息
            const titleMatch = title.match(/\[(代課|帶班|代理|支援)\]([^\[\]]+)/);
            if (titleMatch) {
                return {
                    type: titleMatch[1],
                    originalInstructor: titleMatch[2].trim()
                };
            }
            
            // 從描述中提取代課信息
            const descMatch = description.match(/\[(代課|帶班|代理|支援)\]([^\[\]]+)/);
            if (descMatch) {
                return {
                    type: descMatch[1],
                    originalInstructor: descMatch[2].trim()
                };
            }
            
            return null;
        }

        // 檢查是否為體驗事件
        function isExperience(event) {
            if (!event || !event.title) return false;
            
            const title = event.title || '';
            const description = event.description || '';
            
            // 更精確的體驗關鍵字檢測，避免誤判
            const experienceKeywords = ['體驗'];
            
            return experienceKeywords.some(keyword => 
                title.includes(keyword) || description.includes(keyword)
            );
        }

        // 獲取體驗信息
        function getExperienceInfo(event) {
            if (!isExperience(event)) return null;
            
            const title = event.title || '';
            const description = event.description || '';
            
            // 從標題中提取體驗信息
            const titleMatch = title.match(/\[(體驗|體)\]([^\[\]]+)/);
            if (titleMatch) {
                return {
                    type: titleMatch[1]
                };
            }
            
            // 從描述中提取體驗信息
            const descMatch = description.match(/\[(體驗|體)\]([^\[\]]+)/);
            if (descMatch) {
                return {
                    type: descMatch[1]
                };
            }
            
            // 如果沒有方括號格式，檢查是否包含關鍵字
            if (title.includes('體驗')) {
                return { type: '體驗' };
            } else if (title.includes('體')) {
                return { type: '體' };
            }
            
            return null;
        }

        // 創建事件卡片
        function createEventCard(event) {
            // 檢查事件是否為 null 或 undefined
            if (!event) {
                console.error('❌ createEventCard: 事件為 null 或 undefined');
                return '';
            }
            
            // 檢查必要屬性是否存在
            if (!event.start || !event.end || !event.title || !event.instructor) {
                console.error('❌ createEventCard: 事件缺少必要屬性', event);
                return '';
            }
            
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            const isCancelledEvent = isCancelled(event);
            
            // 檢測是否為代課/帶班事件
            const isSubstituteEvent = isSubstitute(event);
            const substituteInfo = isSubstituteEvent ? getSubstituteInfo(event) : null;
            
            // 檢測是否為體驗事件
            const isExperienceEvent = isExperience(event);
            const experienceInfo = isExperienceEvent ? getExperienceInfo(event) : null;
            
            // 檢測是否為即將到來的課程
            const isUpcomingEventFlag = isUpcomingEvent(event);
            const timeUntilEvent = isUpcomingEventFlag ? getTimeUntilEvent(event) : null;
            
            // 從標題解析時間
            const titleTime = parseTimeFromTitle(event.title);
            
            // 統一使用 CalDAV 的日期，確保日期正確
            const displayDate = startDate.toLocaleDateString('zh-TW');
            let timeString;
            
            if (titleTime) {
                // 使用標題解析的時間，但日期使用 CalDAV
                timeString = titleTime.timeString;
            } else {
                // 使用 CalDAV 的時間
                timeString = `${startDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })} - ${endDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })}`;
            }
            
            // 清理描述內容
            let cleanDescription = event.description || '';
            
            // 移除技術標籤和重複資訊
            cleanDescription = cleanDescription
                .replace(/\[NOTION_SYNC\]/g, '')
                .replace(/時間:.*?講師:/g, '')
                .replace(/講師:.*?TA:/g, '')
                .replace(/TA:.*?第一期:/g, '')
                .replace(/第一期:/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            // 尋找教案連結 - 從原始描述中提取
            const notionUrlRegex = /\(https:\/\/www\.notion\.so\/([^)]+)\)/;
            let notionMatch = event.description.match(notionUrlRegex);
            
            // 如果沒有找到括號內的連結，則匹配一般的 Notion 連結
            if (!notionMatch) {
                const generalNotionRegex = /https:\/\/www\.notion\.so\/([^)\s]+)/;
                notionMatch = event.description.match(generalNotionRegex);
            }
            
            let lessonButton = '';
            if (notionMatch) {
                const lessonUrl = `https://www.notion.so/${notionMatch[1]}`;
                
                // 提取教案名稱和類型
                let lessonName = '查看教案';
                let lessonType = '教案';
                
                // 從原始描述中提取教案資訊
                const originalDescription = event.description;
                
                // 匹配各種教案格式，優先匹配括號前的教案名稱
                const lessonMatch = originalDescription.match(/(ESM教案|SPM教案|SPIKE教案|BOOST教案|EV3教案|MINECRAFT教案)[:\s]*([^(]+?)(?:\s*\(https:\/\/www\.notion\.so)/);
                if (lessonMatch && lessonMatch[2]) {
                    lessonName = lessonMatch[2].trim();
                    lessonType = lessonMatch[1].replace('教案', '');
                }
                
                lessonButton = `
                    <div class="lesson-section">
                        <div class="lesson-label">${lessonType}教案</div>
                        <a href="${lessonUrl}" target="_blank" class="lesson-button ${lessonType.toLowerCase()}">
                            <i class="fas fa-book"></i> ${lessonName}
                        </a>
                    </div>
                `;
            }
            
            // 處理位置資訊
            let location = event.location;
            if (!location || location === 'nan' || location === 'null' || location === '' || location.trim() === '') {
                location = '樂程坊 FunLearnBar';
            }
        
            // 統一地址為樂程坊 FunLearnBar
            if (location === '站前教室' || location === '台北市中正區開封街1段2號9樓' || location === '台北市中正區開封街一段2號9樓') {
                location = '樂程坊 FunLearnBar';
            }
            
            // 講師底色
            const instructorColor = instructorColors[event.instructor] || '#667eea';
            const instructorStyle = instructorColors[event.instructor] ? 'custom-color' : '';
            
            return `
                <div class="event-card ${isCancelledEvent ? 'cancelled-event' : ''} ${isSubstituteEvent ? 'substitute-event' : ''} ${isExperienceEvent ? 'experience-event' : ''} ${isUpcomingEventFlag ? 'upcoming-event' : ''}">
                    <div class="event-header">
                        <div>
                            <div class="event-title">
                                ${event.title}
                                ${isCancelledEvent ? '<span class="cancelled-badge"><i class="fas fa-ban"></i> ⚠️ 停課 ⚠️</span>' : ''}
                                ${isSubstituteEvent && substituteInfo ? `<span class="substitute-badge"><i class="fas fa-exchange-alt"></i> ${substituteInfo.type} ${substituteInfo.originalInstructor}</span>` : ''}
                                ${isExperienceEvent && experienceInfo ? `<span class="experience-badge"><i class="fas fa-star"></i> ${experienceInfo.type}</span>` : ''}
                                ${isUpcomingEventFlag ? `<span class="upcoming-badge"><i class="fas fa-clock"></i> 即將上課</span>` : ''}
                            </div>
                            <div class="event-instructor ${instructorStyle}" style="--instructor-color: ${instructorColor}">
                                <i class="fas fa-user"></i> ${event.instructor}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-details">
                        <div class="event-detail">
                            <i class="fas fa-calendar"></i>
                            <span>${displayDate} (${getWeekday(startDate)}, 第${getWeekNumber(startDate)}週)</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-clock"></i>
                            <span>${timeString}</span>
                        </div>
                        <div class="event-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}" 
                               target="_blank" 
                               class="location-link"
                               title="點擊查看地圖">
                                <i class="fas fa-map-marked-alt location-map-icon"></i>
                            <span>${location}</span>
                                <i class="fas fa-external-link-alt location-external-icon"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="countdown-timer" 
                         data-start-time="${event.start}" 
                         data-end-time="${event.end}">
                        <i class="fas fa-clock countdown-icon"></i>
                        <span class="countdown-text">${isUpcomingEventFlag && timeUntilEvent ? `距離上課還有 ${timeUntilEvent}` : '計算中...'}</span>
                    </div>
                    
                    <div class="event-description">
                        <h4><i class="fas fa-info-circle"></i> 課程描述</h4>
                        <p>${cleanDescription || '無描述'}</p>
                    </div>
                    
                    ${lessonButton}
                </div>
            `;
        }

        // 更新統計信息
        function updateStats() {
            // 獲取當前篩選條件
            const instructorFilter = document.getElementById('instructorSelect').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            // 先過濾掉 null 值
            let filteredEvents = allEvents.filter(event => {
                if (!event) return false;
                if (!event.start || !event.end || !event.title || !event.instructor) return false;
                return true;
            });
            
            // 應用講師篩選
            if (instructorFilter) {
                filteredEvents = filteredEvents.filter(event => event.instructor === instructorFilter);
            }
            
            // 應用時段篩選
            if (timeFilter) {
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const hour = eventDate.getHours();
                    switch (timeFilter) {
                        case 'morning':
                            return hour >= 6 && hour < 12;
                        case 'afternoon':
                            return hour >= 12 && hour < 18;
                        case 'evening':
                            return hour >= 18 && hour < 24;
                        default:
                            return true;
                    }
                });
            }
            
            // 應用指定日期篩選
            if (dateFilter) {
                filteredEvents = filteredEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const filterDate = new Date(dateFilter);
                    return eventDate.getFullYear() === filterDate.getFullYear() &&
                           eventDate.getMonth() === filterDate.getMonth() &&
                           eventDate.getDate() === filterDate.getDate();
                });
            }
            
            // 應用視圖篩選（今日/本週/本月/全部）
            const now = new Date();
            filteredEvents = filteredEvents.filter(event => {
                const eventDate = new Date(event.start);
                
                switch (currentView) {
                    case '今日':
                        return eventDate.getFullYear() === now.getFullYear() &&
                               eventDate.getMonth() === now.getMonth() &&
                               eventDate.getDate() === now.getDate();
                    case '本週':
                        const weekStart = new Date(now);
                        const dayOfWeek = now.getDay();
                        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        weekStart.setDate(now.getDate() + daysToMonday);
                        weekStart.setHours(0, 0, 0, 0);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        weekEnd.setHours(23, 59, 59, 999);
                        return eventDate >= weekStart && eventDate <= weekEnd;
                    case '本月':
                        return eventDate.getFullYear() === now.getFullYear() &&
                               eventDate.getMonth() === now.getMonth();
                    case '全部':
                    default:
                        return true;
                }
            });
            
            // 計算篩選後的講師數量
            const uniqueInstructors = new Set(filteredEvents.map(event => event.instructor));
            const instructorCount = uniqueInstructors.size;
            
            // 調試日誌：顯示篩選結果
            console.log(`📊 統計更新 - 模式: ${currentView}, 總事件: ${allEvents.length}, 篩選後: ${filteredEvents.length}`);
            
            // 根據當前篩選模式計算日期範圍
            let dateRange = '-';
            
            switch (currentView) {
                case '今日':
                    dateRange = now.toLocaleDateString('zh-TW');
                    break;
                case '本週':
                    const weekStart = new Date(now);
                    const dayOfWeek = now.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    weekStart.setDate(now.getDate() + daysToMonday);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    dateRange = `${weekStart.toLocaleDateString('zh-TW')} - ${weekEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case '本月':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    dateRange = `${monthStart.toLocaleDateString('zh-TW')} - ${monthEnd.toLocaleDateString('zh-TW')}`;
                    break;
                case '全部':
                default:
                    if (filteredEvents.length > 0) {
                        const dates = filteredEvents.map(event => new Date(event.start));
                        const minDate = new Date(Math.min(...dates));
                        const maxDate = new Date(Math.max(...dates));
                        dateRange = `${minDate.toLocaleDateString('zh-TW')} - ${maxDate.toLocaleDateString('zh-TW')}`;
                    } else if (allEvents.length > 0) {
                const dates = allEvents.map(event => new Date(event.start));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                        dateRange = `${minDate.toLocaleDateString('zh-TW')} - ${maxDate.toLocaleDateString('zh-TW')}`;
                    }
                    break;
            }
            
            // 更新文字形式的統計信息
            const totalEventsText = document.getElementById('totalEventsText');
            const instructorCountText = document.getElementById('instructorCountText');
            const dateRangeText = document.getElementById('dateRangeText');
            
            // 動畫更新統計數字
            if (totalEventsText) {
                animateCounter(totalEventsText, `總事件: ${filteredEvents.length}`);
            }
            if (instructorCountText) {
                animateCounter(instructorCountText, `講師: ${instructorCount}`);
            }
            if (dateRangeText) {
                animateCounter(dateRangeText, `日期: ${dateRange}`);
            }
        }

        // 動畫更新計數器
        function animateCounter(element, newText) {
            if (element.textContent !== newText) {
                // 添加動畫類
                element.classList.add('animate');
                
                // 更新文字
                element.textContent = newText;
                
                // 移除動畫類
                setTimeout(() => {
                    element.classList.remove('animate');
                }, 600);
            }
        }

        // 顯示錯誤訊息
        function showError(message) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `
                <div class="no-events">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>載入失敗</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // 點擊外部關閉設置畫面
        const settingsOverlay = document.getElementById('settingsOverlay');
        if (settingsOverlay) {
            settingsOverlay.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });
        }
    </script>
</body>
</html>
