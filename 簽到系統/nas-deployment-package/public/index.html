<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLB è¬›å¸«ç°½åˆ°ç³»çµ±</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <header class="header">
            <div class="logo-container">
                <img src="logo.jpg" alt="FLB Logo" class="logo">
            </div>
            <div class="header-text">
                <h1>FLB è¬›å¸«ç°½åˆ°ç³»çµ±</h1>
            </div>
            <p>å­¸ç”Ÿç°½åˆ°ç®¡ç†ç³»çµ±</p>
            <!-- å³æ™‚æ—¥æœŸæ™‚é–“é¡¯ç¤º -->
            <div class="datetime-display">
                <div class="date-info">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="current-date"></span>
                </div>
                <div class="time-info">
                    <i class="fas fa-clock"></i>
                    <span id="current-time"></span>
                </div>
                <div class="week-info">
                    <i class="fas fa-calendar-week"></i>
                    <span id="current-week"></span>
                </div>
            </div>
        </header>

        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-text">é¸æ“‡è¬›å¸«</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-text">é¸æ“‡èª²ç¨‹</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-text">å­¸ç”Ÿç°½åˆ°</div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ1ï¼šè¬›å¸«é¸æ“‡ -->
        <div class="step-content active" id="step1-content">
            <div class="card">
                <h2><i class="fas fa-user-tie"></i> é¸æ“‡è¬›å¸«</h2>
                <div class="loading" id="teacher-loading">
                    <i class="fas fa-spinner"></i>
                    <div class="loading-text">è¼‰å…¥è¬›å¸«åˆ—è¡¨ä¸­...</div>
                </div>
                <div class="teacher-grid" id="teacher-grid"></div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ2ï¼šèª²ç¨‹é¸æ“‡ -->
        <div class="step-content" id="step2-content">
            <div class="card">
                <h2><i class="fas fa-book"></i> é¸æ“‡èª²ç¨‹</h2>
                <div class="selected-teacher">
                    <strong>å·²é¸æ“‡è¬›å¸«ï¼š</strong><span id="selected-teacher-name"></span>
                    <button class="btn-secondary" onclick="backToStep1()">
                        <i class="fas fa-arrow-left"></i> é‡æ–°é¸æ“‡
                    </button>
                </div>
                <div class="loading" id="course-loading">
                    <i class="fas fa-spinner"></i>
                    <div class="loading-text">è¼‰å…¥èª²ç¨‹ä¸­...</div>
                </div>
                <div class="course-grid" id="course-grid"></div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ3ï¼šå­¸ç”Ÿç°½åˆ° -->
        <div class="step-content" id="step3-content">
            <div class="card">
                <h2><i class="fas fa-users"></i> å­¸ç”Ÿç°½åˆ°</h2>
                <div class="course-info">
                    <strong>èª²ç¨‹ï¼š</strong><span id="selected-course-name"></span><br>
                    <strong>æ™‚æ®µï¼š</strong><span id="selected-course-time"></span>
                    <button class="btn-secondary" onclick="backToStep2()">
                        <i class="fas fa-arrow-left"></i> é‡æ–°é¸æ“‡
                    </button>
                </div>
                


                <!-- å­¸ç”Ÿåˆ—è¡¨ -->
                <div class="student-section">
                    <h3><i class="fas fa-list"></i> å­¸ç”Ÿåå–®</h3>
                    <div class="loading" id="student-loading">
                        <i class="fas fa-spinner"></i>
                        <div class="loading-text">è¼‰å…¥å­¸ç”Ÿåå–®ä¸­...</div>
                    </div>
                    <div class="student-list" id="student-list"></div>
                </div>

                <!-- è£œç°½åˆ°åŠŸèƒ½ -->
                <div class="makeup-attendance-section">
                    <div class="makeup-toggle" onclick="toggleMakeupSection()">
                        <h3><i class="fas fa-calendar-plus"></i> å­¸ç”Ÿè£œç°½åˆ°</h3>
                        <i class="fas fa-chevron-down makeup-toggle-icon" id="makeup-toggle-icon"></i>
                    </div>
                    <div class="makeup-form" id="makeup-form" style="display: none;">
                        <div class="form-group">
                            <label for="makeup-date">è£œç°½åˆ°æ—¥æœŸï¼š</label>
                            <input 
                                type="date" 
                                id="makeup-date" 
                                max=""
                                onchange="loadMakeupCourses()"
                            >
                            <small class="form-help">é¸æ“‡éœ€è¦è£œç°½åˆ°çš„æ—¥æœŸ</small>
                        </div>
                        <div class="makeup-courses" id="makeup-courses" style="display: none;">
                            <h4><i class="fas fa-list"></i> å¯è£œç°½åˆ°çš„èª²ç¨‹</h4>
                            <div class="makeup-course-list" id="makeup-course-list"></div>
                        </div>
                    </div>
                </div>

                <!-- è¬›å¸«å ±è¡¨èˆ‡è£œç°½åˆ° -->
                <div class="teacher-section">
                    <h3><i class="fas fa-clipboard-list"></i> è¬›å¸«å ±è¡¨</h3>
                    
                    <!-- ä»Šæ—¥å ±è¡¨ -->
                    <div class="today-report-section">
                        <h4><i class="fas fa-calendar-day"></i> ä»Šæ—¥å ±è¡¨</h4>
                        <div class="report-form">
                            <div class="form-group">
                                <label for="course-content">èª²ç¨‹å…§å®¹ï¼š</label>
                                <textarea 
                                    id="course-content" 
                                    placeholder="è«‹æè¿°ä»Šå¤©çš„èª²ç¨‹å…§å®¹..."
                                    rows="4"
                                    maxlength="500"
                                ></textarea>
                                <div class="char-count">
                                    <span id="char-count">0</span>/500
                                </div>
                            </div>
                            <div class="assistant-toggle">
                                <div class="mode-header">
                                    <h4><i class="fas fa-users"></i> èº«ä»½é¸æ“‡</h4>
                                    <p class="mode-description">è«‹é¸æ“‡æ‚¨çš„èº«ä»½ä»¥æ­£ç¢ºè¨­å®šäººæ•¸</p>
                                </div>
                                <div class="mode-buttons">
                                    <button class="mode-btn teacher-mode" id="teacher-mode-btn" onclick="setTeacherMode()">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                        <span class="mode-title">è¬›å¸«æ¨¡å¼</span>
                                        <span class="mode-desc">äººæ•¸æ ¹æ“šå­¸ç”Ÿæ•¸é‡è¨ˆç®—</span>
                                    </button>
                                    <button class="mode-btn assistant-mode" id="assistant-mode-btn" onclick="setAssistantMode()">
                                        <i class="fas fa-user-graduate"></i>
                                        <span class="mode-title">åŠ©æ•™æ¨¡å¼</span>
                                        <span class="mode-desc">äººæ•¸è‡ªå‹•è¨­ç‚º 0</span>
                                    </button>
                                </div>
                                <div class="current-mode-display">
                                    <span class="mode-label">ç›®å‰æ¨¡å¼ï¼š</span>
                                    <span class="mode-value" id="current-mode-display">è¬›å¸«æ¨¡å¼</span>
                                </div>
                            </div>
                            <button class="btn-primary complete" id="submit-report-btn" onclick="submitTeacherReport()">
                                <i class="fas fa-paper-plane"></i> æäº¤å ±è¡¨
                            </button>
                        </div>
                    </div>

                    <!-- è£œç°½åˆ°å ±è¡¨ -->
                    <div class="makeup-report-section">
                        <div class="makeup-report-toggle" onclick="toggleMakeupReport()">
                            <h4><i class="fas fa-calendar-plus"></i> è£œç°½åˆ°å ±è¡¨</h4>
                            <i class="fas fa-chevron-down toggle-icon" id="makeup-report-toggle-icon"></i>
                        </div>
                        <div class="makeup-report-form" id="makeup-report-form" style="display: none;">
                            <div class="form-group">
                                <label for="teacher-makeup-date">è£œç°½åˆ°æ—¥æœŸï¼š</label>
                                <input 
                                    type="date" 
                                    id="teacher-makeup-date" 
                                    max=""
                                    placeholder="è«‹é¸æ“‡æ—¥æœŸ"
                                    onchange="loadTeacherMakeupCourses()"
                                >
                                <small class="form-help">è«‹å…ˆé¸æ“‡éœ€è¦è£œç°½åˆ°çš„æ—¥æœŸ</small>
                            </div>
                            
                            <!-- èº«ä»½é¸æ“‡ -->
                            <div class="teacher-makeup-identity">
                                <h4><i class="fas fa-users"></i> èº«ä»½é¸æ“‡</h4>
                                <p class="identity-description">è«‹é¸æ“‡æ‚¨çš„èº«ä»½ä»¥æ­£ç¢ºè¨­å®šäººæ•¸</p>
                                <div class="identity-buttons">
                                    <button class="identity-btn teacher-identity" id="teacher-identity-btn" onclick="setTeacherMakeupIdentity(false)">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                        <span class="identity-title">è¬›å¸«æ¨¡å¼</span>
                                        <span class="identity-desc">äººæ•¸æ ¹æ“šèª²ç¨‹é¡å‹è¨ˆç®—</span>
                                    </button>
                                    <button class="identity-btn assistant-identity" id="assistant-identity-btn" onclick="setTeacherMakeupIdentity(true)">
                                        <i class="fas fa-user-graduate"></i>
                                        <span class="identity-title">åŠ©æ•™æ¨¡å¼</span>
                                        <span class="identity-desc">äººæ•¸è‡ªå‹•è¨­ç‚º 0</span>
                                    </button>
                                </div>
                                <div class="current-identity-display">
                                    <span class="identity-label">ç›®å‰èº«ä»½ï¼š</span>
                                    <span class="identity-value" id="current-identity-display">è¬›å¸«æ¨¡å¼</span>
                                </div>
                            </div>
                            
                            <!-- èª²ç¨‹å…§å®¹è¼¸å…¥ -->
                            <div class="form-group">
                                <label for="teacher-makeup-content">èª²ç¨‹å…§å®¹ï¼š</label>
                                <textarea 
                                    id="teacher-makeup-content" 
                                    placeholder="è«‹æè¿°è£œç°½åˆ°èª²ç¨‹çš„å…§å®¹..."
                                    rows="4"
                                    maxlength="500"
                                ></textarea>
                                <div class="char-count">
                                    <span id="teacher-makeup-char-count">0</span>/500
                                </div>
                            </div>
                            
                            <div class="teacher-makeup-courses" id="teacher-makeup-courses" style="display: none;">
                                <h4><i class="fas fa-list"></i> å¯è£œç°½åˆ°çš„èª²ç¨‹</h4>
                                <div class="teacher-makeup-course-list" id="teacher-makeup-course-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å°èˆªæŒ‰éˆ• -->
        <div class="navigation">
            <button class="btn-secondary" id="prev-btn" onclick="previousStep()" style="display: none;">
                <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
            </button>
            <div class="nav-buttons-right">
                <button class="btn-report-query" onclick="openReportQueryModal()">
                    <i class="fas fa-chart-line"></i> æŸ¥è©¢å ±è¡¨
                </button>
                <button class="btn-primary" id="next-btn" onclick="nextStep()" style="display: none;">
                    ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div class="toast" id="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <!-- å ±è¡¨æŸ¥è©¢å½ˆçª— -->
    <div class="modal" id="report-query-modal">
        <div class="modal-content report-modal">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> æŸ¥è©¢å ±è¡¨</h3>
                <button class="modal-close" onclick="closeReportQueryModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- é¸æ“‡è¬›å¸«ä¸¦æŸ¥è©¢ -->
                <div class="query-step" id="step-select-teacher">
                    <h4><i class="fas fa-user-tie"></i> é¸æ“‡è¬›å¸«æŸ¥è©¢å ±è¡¨</h4>
                    <div class="form-group">
                        <label for="report-teacher-select">é¸æ“‡è¬›å¸«ï¼š</label>
                        <select id="report-teacher-select" onchange="onTeacherSelectChange()">
                            <option value="">è«‹é¸æ“‡è¬›å¸«</option>
                        </select>
                        <small class="form-help">é¸æ“‡è¦æŸ¥è©¢å ±è¡¨çš„è¬›å¸«ï¼Œå°‡ç›´æ¥æŸ¥è©¢æ‰€æœ‰è³‡æ–™</small>
                    </div>
                    
                    <!-- é€²éšç¯©é¸é¸é …ï¼ˆå¯é¸ï¼‰ -->
                    <div class="advanced-filters" id="advanced-filters" style="display: none;">
                        <div class="filter-toggle">
                            <button class="btn-toggle-filters" onclick="toggleAdvancedFilters()">
                                <i class="fas fa-chevron-down"></i> é€²éšç¯©é¸é¸é …
                            </button>
                        </div>
                        
                        <div class="query-filters" id="query-filters" style="display: none;">
                            <div class="form-group">
                                <label for="name-contains">èª²ç¨‹åç¨±ï¼ˆæ¨¡ç³Šæœå°‹ï¼‰ï¼š</label>
                                <input type="text" id="name-contains" placeholder="ä¾‹å¦‚ï¼šSPM" maxlength="50">
                                <small class="form-help">æ‰¾å‡ºæ‰€æœ‰ã€Œèª²ç¨‹åç¨±ã€åŒ…å«è©²å­—ä¸²çš„è³‡æ–™</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="topic-contains">èª²ç¨‹ä¸»é¡Œï¼ˆæ¨¡ç³Šæœå°‹ï¼‰ï¼š</label>
                                <input type="text" id="topic-contains" placeholder="ä¾‹å¦‚ï¼šæµ·ç›œ" maxlength="50">
                                <small class="form-help">æ‰¾å‡ºæ‰€æœ‰ã€Œèª²ç¨‹å…§å®¹/ä¸»é¡Œã€åŒ…å«è©²å­—ä¸²çš„è³‡æ–™</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="query-date">æ—¥æœŸï¼ˆç²¾æº–æ¯”å°ï¼‰ï¼š</label>
                                <input type="date" id="query-date">
                                <small class="form-help">åªå›å‚³æŒ‡å®šæ—¥æœŸçš„èª²ç¨‹ï¼ˆæ ¼å¼ï¼šyyyy-MM-ddï¼‰ï¼Œè‹¥åŒæ™‚è¨­å®šæ—¥æœŸå€é–“å‰‡ä»¥å€é–“ç‚ºå„ªå…ˆ</small>
                            </div>
                            
                            <div class="date-range-group">
                                <div class="form-group">
                                    <label for="date-range-start">æ—¥æœŸå€é–“é–‹å§‹ï¼š</label>
                                    <input type="date" id="date-range-start">
                                    <small class="form-help">èµ·å§‹æ—¥æœŸï¼ˆå«ï¼‰</small>
                                </div>
                                <div class="date-range-separator">è‡³</div>
                                <div class="form-group">
                                    <label for="date-range-end">æ—¥æœŸå€é–“çµæŸï¼š</label>
                                    <input type="date" id="date-range-end">
                                    <small class="form-help">çµæŸæ—¥æœŸï¼ˆå«ï¼‰</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="course-time">ä¸Šèª²æ™‚é–“ï¼ˆç²¾æº–æ¯”å°ï¼‰ï¼š</label>
                                <input type="text" id="course-time" placeholder="ä¾‹å¦‚ï¼š14:30-15:30" maxlength="20">
                                <small class="form-help">åªå›å‚³æŒ‡å®šä¸Šèª²æ™‚é–“çš„èª²ç¨‹</small>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="query-limit">å›å‚³ç­†æ•¸é™åˆ¶ï¼š</label>
                                    <input type="number" id="query-limit" placeholder="0=ä¸é™åˆ¶" min="0" max="1000">
                                </div>
                                <div class="form-group">
                                    <label for="query-offset">å¾ç¬¬å¹¾ç­†é–‹å§‹ï¼š</label>
                                    <input type="number" id="query-offset" placeholder="0=å¾é ­é–‹å§‹" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn-secondary" onclick="closeReportQueryModal()">å–æ¶ˆ</button>
                        <button class="btn-primary" onclick="queryReport()" id="query-report-btn" disabled>
                            <i class="fas fa-search"></i> æŸ¥è©¢å ±è¡¨
                        </button>
                    </div>
                </div>

            </div>
            
            <div class="modal-footer" id="report-query-results" style="display: none;">
                <div class="results-header">
                    <h4><i class="fas fa-list"></i> æŸ¥è©¢çµæœ</h4>
                    <!-- æœˆä»½å¿«é€Ÿé¸æ“‡ -->
                    <div class="month-filter-section">
                        <div class="month-filter-label">
                            <i class="fas fa-calendar-alt"></i> å¿«é€Ÿç¯©é¸æœˆä»½ï¼š
                        </div>
                        <div class="month-buttons" id="month-buttons">
                            <!-- æœˆä»½æŒ‰éˆ•å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        <div class="filter-actions">
                            <button class="btn-secondary btn-sm" onclick="clearMonthFilter()">
                                <i class="fas fa-times"></i> æ¸…é™¤ç¯©é¸
                            </button>
                            <button class="btn-primary btn-sm" onclick="showAllResults()">
                                <i class="fas fa-eye"></i> é¡¯ç¤ºå…¨éƒ¨
                            </button>
                        </div>
                    </div>
                </div>
                <div class="report-results" id="report-results-content"></div>
            </div>
        </div>
    </div>

     <!-- ç‰ˆæœ¬è™Ÿ -->
     <div class="version-info">
         <span class="version-text">Timæ„Ÿæ©æˆ´å¾·ç‰ˆæœ¬è™Ÿ: 20250903</span>
     </div>

     <!-- LINEä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤ºå€åŸŸ -->
     <div class="user-info-footer hidden" id="userInfoFooter">
         <div class="footer-content">
             <h4><i class="fas fa-user"></i> LINEä½¿ç”¨è€…è³‡è¨Š</h4>
             <div class="user-details">
                 <div class="user-detail-item">
                     <span class="label">ä½¿ç”¨è€…åç¨±:</span>
                     <span class="value" id="footerUserName">-</span>
                 </div>
                 <div class="user-detail-item">
                     <span class="label">User ID:</span>
                     <span class="value" id="footerUserId">-</span>
                 </div>
                 <div class="user-detail-item">
                     <button class="btn-unbind" id="unbind-btn" onclick="unbindTeacher()" style="display: none;">
                         <i class="fas fa-unlink"></i> è§£é™¤è¬›å¸«ç¶å®š
                     </button>
                 </div>
             </div>
         </div>
     </div>

     <script src="script.js"></script>
     
     <!-- LIFF æ•´åˆ -->
     <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
     <script>
         let liffId = '1657746214-wPgd2qQn'; // LIFF ID
         let liffInitialized = false;
         let currentUser = null;

        // åˆå§‹åŒ–LIFF
        async function initializeLiff() {
            try {
                console.log('é–‹å§‹åˆå§‹åŒ–LIFFï¼ŒID:', liffId);
                await liff.init({ liffId: liffId });
                liffInitialized = true;
                console.log('LIFFåˆå§‹åŒ–æˆåŠŸ');

                if (liff.isLoggedIn()) {
                    console.log('ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œé–‹å§‹è™•ç†ä½¿ç”¨è€…è³‡è¨Š');
                    await handleLoggedInUser();
                } else {
                    console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥æŒ‰éˆ•');
                    // å¦‚æœæœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                    showLoginPrompt();
                }
            } catch (error) {
                console.error('LIFFåˆå§‹åŒ–å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', error.message);
                // å³ä½¿LIFFå¤±æ•—ï¼Œä¹Ÿå…è¨±ä½¿ç”¨ç³»çµ±
                showToast('LIFFåˆå§‹åŒ–å¤±æ•—ï¼Œå°‡ä»¥è¨ªå®¢æ¨¡å¼ä½¿ç”¨', 'warning');
                
                // æ·»åŠ æ‰‹å‹•æ¸¬è©¦æŒ‰éˆ•
                addTestButton();
            }
        }

        // æ·»åŠ æ¸¬è©¦æŒ‰éˆ•
        function addTestButton() {
            const testButton = document.createElement('button');
            testButton.textContent = 'æ¸¬è©¦LINEä½¿ç”¨è€…è¨»å†Š';
            testButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #00B900;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                z-index: 1000;
            `;
            testButton.onclick = testLineUserRegistration;
            document.body.appendChild(testButton);
            
            // æ·»åŠ LIFFèª¿è©¦æŒ‰éˆ•
            const debugButton = document.createElement('button');
            debugButton.textContent = 'LIFFèª¿è©¦';
            debugButton.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                z-index: 1000;
                font-size: 14px;
            `;
            debugButton.onclick = debugLiff;
            document.body.appendChild(debugButton);
        }
        
        // LIFFèª¿è©¦å‡½æ•¸
        function debugLiff() {
            console.log('=== LIFFèª¿è©¦è³‡è¨Š ===');
            console.log('LIFF ID:', liffId);
            console.log('LIFFåˆå§‹åŒ–ç‹€æ…‹:', liffInitialized);
            console.log('LIFFæ˜¯å¦å¯ç”¨:', typeof liff !== 'undefined');
            
            if (typeof liff !== 'undefined') {
                console.log('LIFFæ˜¯å¦å·²ç™»å…¥:', liff.isLoggedIn());
                if (liff.isLoggedIn()) {
                    console.log('ä½¿ç”¨è€…ID:', liff.getContext().userId);
                    liff.getProfile().then(profile => {
                        console.log('ä½¿ç”¨è€…è³‡è¨Š:', profile);
                    }).catch(error => {
                        console.error('ç²å–ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', error);
                    });
                }
            }
            
            console.log('ç•¶å‰ä½¿ç”¨è€…:', currentUser);
            console.log('é è…³ä½¿ç”¨è€…è³‡è¨Šå…ƒç´ :', document.getElementById('userInfoFooter'));
            console.log('========================');
            
            showToast('LIFFèª¿è©¦è³‡è¨Šå·²è¼¸å‡ºåˆ°æ§åˆ¶å°', 'info');
        }

        // æ¸¬è©¦LINEä½¿ç”¨è€…è¨»å†ŠåŠŸèƒ½
        async function testLineUserRegistration() {
            const testUser = {
                userId: 'test-user-' + Date.now(),
                displayName: 'æ¸¬è©¦ä½¿ç”¨è€…',
                pictureUrl: '',
                userName: 'æ¸¬è©¦ä½¿ç”¨è€…',
                email: 'test@example.com'
            };

            try {
                console.log('é–‹å§‹æ¸¬è©¦ä½¿ç”¨è€…è¨»å†Š:', testUser);
                
                // å…ˆæª¢æŸ¥ä½¿ç”¨è€…
                const checkResponse = await fetch('/api/check-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: testUser.userId,
                        displayName: testUser.displayName,
                        pictureUrl: testUser.pictureUrl
                    })
                });

                const checkResult = await checkResponse.json();
                console.log('æª¢æŸ¥ä½¿ç”¨è€…çµæœ:', checkResult);

                if (!checkResult.isRegistered) {
                    // è¨»å†Šä½¿ç”¨è€…
                    const registerResponse = await fetch('/api/register-user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(testUser)
                    });

                    const registerResult = await registerResponse.json();
                    console.log('è¨»å†Šçµæœ:', registerResult);

                    if (registerResult.success) {
                        showToast('æ¸¬è©¦è¨»å†ŠæˆåŠŸï¼', 'success');
                        displayFooterUserInfo(registerResult.userData);
                    } else {
                        showToast('æ¸¬è©¦è¨»å†Šå¤±æ•—ï¼š' + (registerResult.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                    }
                } else {
                    showToast('æ¸¬è©¦ä½¿ç”¨è€…å·²å­˜åœ¨', 'info');
                    displayFooterUserInfo(checkResult.userData);
                }
            } catch (error) {
                console.error('æ¸¬è©¦è¨»å†Šå¤±æ•—:', error);
                showToast('æ¸¬è©¦è¨»å†Šå¤±æ•—ï¼š' + error.message, 'error');
            }
        }

         // è™•ç†å·²ç™»å…¥çš„ä½¿ç”¨è€…
         async function handleLoggedInUser() {
             try {
                 const profile = await liff.getProfile();
                 const userId = liff.getContext().userId;
                 
                 console.log('ä½¿ç”¨è€…è³‡è¨Š:', profile);
                 console.log('ä½¿ç”¨è€…ID:', userId);

                 currentUser = {
                     userId: userId,
                     displayName: profile.displayName,
                     pictureUrl: profile.pictureUrl
                 };

                 // å…ˆé¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
                 displayFooterUserInfo({
                     userName: profile.displayName,
                     userId: userId,
                     isTeacherBound: false
                 });

                 // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²è¨»å†Š
                 await checkUserRegistration(userId, profile);

             } catch (error) {
                 console.error('å–å¾—ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', error);
                 showToast('ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š', 'error');
             }
         }

         // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²è¨»å†Š
         async function checkUserRegistration(userId, profile) {
             try {
                 const response = await fetch('/api/check-user', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                         userId: userId,
                         displayName: profile.displayName,
                         pictureUrl: profile.pictureUrl
                     })
                 });

                 const result = await response.json();

                if (result.success) {
                    if (result.isRegistered) {
                        // æª¢æŸ¥è¬›å¸«ç¶å®šç‹€æ…‹
                        await checkTeacherBinding(userId);
                    } else {
                        // å¦‚æœæœªè¨»å†Šï¼Œé¡¯ç¤ºè¨»å†Šæç¤º
                        showRegistrationPrompt(profile);
                    }
                }
             } catch (error) {
                 console.error('æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—:', error);
             }
         }

         // é¡¯ç¤ºç™»å…¥æç¤º
         function showLoginPrompt() {
             showToast('è«‹å…ˆç™»å…¥æ‚¨çš„ LINE å¸³è™Ÿä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½', 'info');
         }

         // é¡¯ç¤ºè¨»å†Šæç¤º
         function showRegistrationPrompt(profile) {
             const shouldRegister = confirm(`æ­¡è¿ä½¿ç”¨ FLB è¬›å¸«ç°½åˆ°ç³»çµ±ï¼\n\næ‚¨çš„ LINE è³‡è¨Šï¼š\né¡¯ç¤ºåç¨±ï¼š${profile.displayName}\nä½¿ç”¨è€…IDï¼š${liff.getContext().userId}\n\næ˜¯å¦è¦è¨»å†Šä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½ï¼Ÿ`);
             
             if (shouldRegister) {
                 registerUser();
             }
         }

         // è¨»å†Šä½¿ç”¨è€…
         async function registerUser() {
             try {
                 const profile = await liff.getProfile();
                 const userId = liff.getContext().userId;

                 const response = await fetch('/api/register-user', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                         userId: userId,
                         displayName: profile.displayName,
                         pictureUrl: profile.pictureUrl,
                         userName: profile.displayName,
                         email: ''
                     })
                 });

                 const result = await response.json();

                if (result.success) {
                    showToast('è¨»å†ŠæˆåŠŸï¼', 'success');
                    
                    // å…ˆé¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
                    displayFooterUserInfo({
                        userName: profile.displayName,
                        userId: userId,
                        isTeacherBound: false
                    });
                    
                    // è¨»å†ŠæˆåŠŸå¾Œæª¢æŸ¥è¬›å¸«ç¶å®šç‹€æ…‹
                    await checkTeacherBinding(userId);
                } else {
                    showToast('è¨»å†Šå¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
             } catch (error) {
                 console.error('è¨»å†Šå¤±æ•—:', error);
                 showToast('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
             }
         }

        // æª¢æŸ¥è¬›å¸«ç¶å®šç‹€æ…‹
        async function checkTeacherBinding(userId) {
            try {
                const response = await fetch('/api/check-teacher-binding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: userId })
                });

                const result = await response.json();
                console.log('è¬›å¸«ç¶å®šç‹€æ…‹:', result);

                if (result.success) {
                    if (result.isBound) {
                        // å·²ç¶å®šè¬›å¸«ï¼Œç›´æ¥è·³åˆ°ç¬¬äºŒæ­¥é©Ÿ
                        displayFooterUserInfo({
                            userName: result.teacherName,
                            userId: userId,
                            isTeacherBound: true
                        });
                        showToast(`æ­¡è¿å›ä¾†ï¼Œ${result.teacherName}ï¼`, 'success');
                        
                        // è‡ªå‹•é¸æ“‡å·²ç¶å®šçš„è¬›å¸«èº«ä»½
                        selectTeacherIdentity(result.teacherName, result.teacherId);
                    } else {
                        // æœªç¶å®šè¬›å¸«ï¼Œå…ˆé¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Šï¼Œç„¶å¾Œé¡¯ç¤ºè¬›å¸«é¸æ“‡å½ˆçª—
                        displayFooterUserInfo({
                            userName: currentUser?.displayName || 'æœªç¶å®šè¬›å¸«',
                            userId: userId,
                            isTeacherBound: false
                        });
                        showTeacherSelectionModal(userId);
                    }
                }
            } catch (error) {
                console.error('æª¢æŸ¥è¬›å¸«ç¶å®šç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºè¬›å¸«é¸æ“‡å½ˆçª—
        async function showTeacherSelectionModal(userId) {
            // å…ˆè¼‰å…¥è¬›å¸«åˆ—è¡¨
            console.log('é–‹å§‹è¼‰å…¥è¬›å¸«åˆ—è¡¨...');
            const teacherData = await loadTeacherListData();
            
            // å‰µå»ºé®ç½©å±¤
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;

            // å‰µå»ºå½ˆçª—
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;

            // æ ¹æ“šè¼‰å…¥çµæœé¡¯ç¤ºå…§å®¹
            if (teacherData.success && teacherData.teachers && teacherData.teachers.length > 0) {
                modal.innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 20px; color: #333;">
                        <i class="fas fa-user-graduate"></i> é¸æ“‡æ‚¨çš„è¬›å¸«èº«ä»½
                    </h2>
                    <p style="text-align: center; margin-bottom: 25px; color: #666;">
                        è«‹é¸æ“‡æ‚¨å°æ‡‰çš„è¬›å¸«èº«ä»½ï¼Œä»¥ä¾¿å¿«é€Ÿä½¿ç”¨ç°½åˆ°åŠŸèƒ½
                    </p>
                    <div id="teacher-list" style="margin-bottom: 25px;">
                        ${teacherData.teachers.map(teacher => `
                            <div class="teacher-item" style="
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                padding: 15px;
                                margin-bottom: 10px;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " data-teacher-id="${teacher.userId || teacher.name}" data-teacher-name="${teacher.name}">
                                <div style="font-weight: bold; color: #333;">${teacher.name}</div>
                                <div style="font-size: 14px; color: #666;">ID: ${teacher.userId || teacher.name}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align: center;">
                        <button id="skip-binding" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">ç¨å¾Œè¨­å®š</button>
                    </div>
                `;
            } else {
                modal.innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 20px; color: #333;">
                        <i class="fas fa-user-graduate"></i> é¸æ“‡æ‚¨çš„è¬›å¸«èº«ä»½
                    </h2>
                    <p style="text-align: center; margin-bottom: 25px; color: #666;">
                        è«‹é¸æ“‡æ‚¨å°æ‡‰çš„è¬›å¸«èº«ä»½ï¼Œä»¥ä¾¿å¿«é€Ÿä½¿ç”¨ç°½åˆ°åŠŸèƒ½
                    </p>
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <i class="fas fa-exclamation-circle"></i> ç„¡æ³•è¼‰å…¥è¬›å¸«åˆ—è¡¨
                    </div>
                    <div style="text-align: center;">
                        <button id="skip-binding" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">ç¨å¾Œè¨­å®š</button>
                    </div>
                `;
            }

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // ç¶å®šäº‹ä»¶
            document.getElementById('skip-binding').onclick = () => {
                document.body.removeChild(overlay);
                displayFooterUserInfo({ userName: 'æœªç¶å®šè¬›å¸«', userId: userId });
            };

            // å¦‚æœæˆåŠŸè¼‰å…¥è¬›å¸«åˆ—è¡¨ï¼Œç¶å®šé»æ“Šäº‹ä»¶
            if (teacherData.success && teacherData.teachers && teacherData.teachers.length > 0) {
                document.querySelectorAll('.teacher-item').forEach(item => {
                    item.onclick = () => {
                        const teacherId = item.dataset.teacherId;
                        const teacherName = item.dataset.teacherName;
                        bindTeacher(userId, teacherName, teacherId);
                        document.body.removeChild(overlay);
                    };

                    // æ·»åŠ æ‡¸åœæ•ˆæœ
                    item.onmouseenter = () => {
                        item.style.background = '#f8f9fa';
                        item.style.borderColor = '#007bff';
                    };
                    item.onmouseleave = () => {
                        item.style.background = 'white';
                        item.style.borderColor = '#ddd';
                    };
                });
            }
        }

        // è¼‰å…¥è¬›å¸«åˆ—è¡¨æ•¸æ“š
        async function loadTeacherListData() {
            try {
                console.log('æ­£åœ¨è¼‰å…¥è¬›å¸«åˆ—è¡¨...');
                const response = await fetch('/api/teachers');
                const result = await response.json();
                console.log('è¬›å¸«åˆ—è¡¨è¼‰å…¥çµæœ:', result);
                return result;
            } catch (error) {
                console.error('è¼‰å…¥è¬›å¸«åˆ—è¡¨å¤±æ•—:', error);
                return { success: false, error: error.message };
            }
        }

        // è¼‰å…¥è¬›å¸«åˆ—è¡¨ (èˆŠç‰ˆæœ¬ï¼Œä¿ç•™ä»¥å‚™ç”¨)
        async function loadTeacherList(userId, modal) {
            try {
                const response = await fetch('/api/teachers');
                const result = await response.json();

                const teacherList = document.getElementById('teacher-list');
                
                if (result.success && result.teachers && result.teachers.length > 0) {
                    teacherList.innerHTML = result.teachers.map(teacher => `
                        <div class="teacher-item" style="
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 10px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " data-teacher-id="${teacher.userId || teacher.name}" data-teacher-name="${teacher.name}">
                            <div style="font-weight: bold; color: #333;">${teacher.name}</div>
                            <div style="font-size: 14px; color: #666;">ID: ${teacher.userId || teacher.name}</div>
                        </div>
                    `).join('');

                    // æ·»åŠ é»æ“Šäº‹ä»¶
                    document.querySelectorAll('.teacher-item').forEach(item => {
                        item.onclick = () => {
                            const teacherId = item.dataset.teacherId;
                            const teacherName = item.dataset.teacherName;
                            bindTeacher(userId, teacherName, teacherId);
                            document.body.removeChild(document.querySelector('div[style*="position: fixed"]'));
                        };

                        // æ·»åŠ æ‡¸åœæ•ˆæœ
                        item.onmouseenter = () => {
                            item.style.background = '#f8f9fa';
                            item.style.borderColor = '#007bff';
                        };
                        item.onmouseleave = () => {
                            item.style.background = 'white';
                            item.style.borderColor = '#ddd';
                        };
                    });
                } else {
                    teacherList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-exclamation-triangle"></i> ç„¡æ³•è¼‰å…¥è¬›å¸«åˆ—è¡¨
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è¼‰å…¥è¬›å¸«åˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('teacher-list').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <i class="fas fa-exclamation-circle"></i> è¼‰å…¥è¬›å¸«åˆ—è¡¨å¤±æ•—
                    </div>
                `;
            }
        }

        // ç¶å®šè¬›å¸«
        async function bindTeacher(userId, teacherName, teacherId) {
            try {
                const response = await fetch('/api/bind-teacher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        teacherName: teacherName,
                        teacherId: teacherId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    let message = `è¬›å¸«èº«ä»½ç¶å®šæˆåŠŸï¼æ­¡è¿ï¼Œ${teacherName}ï¼`;
                    
                    // é¡¯ç¤ºRich Menuç¶å®šçµæœ
                    if (result.richMenuResult) {
                        if (result.richMenuResult.success) {
                            message += '\nğŸ“± Rich Menuå·²æˆåŠŸç¶å®šï¼';
                        } else {
                            message += `\nğŸ“± Rich Menuç¶å®šå¤±æ•—ï¼š${result.richMenuResult.error || 'æœªçŸ¥éŒ¯èª¤'}`;
                        }
                    }
                    
                    showToast(message, 'success');
                    displayFooterUserInfo({
                        userName: teacherName,
                        userId: userId,
                        isTeacherBound: true
                    });
                    
                    // ç¶å®šæˆåŠŸå¾Œè‡ªå‹•é¸æ“‡è¬›å¸«èº«ä»½
                    selectTeacherIdentity(teacherName, teacherId);
                } else {
                    showToast('ç¶å®šå¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                console.error('ç¶å®šè¬›å¸«å¤±æ•—:', error);
                showToast('ç¶å®šå¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // è‡ªå‹•é¸æ“‡è¬›å¸«èº«ä»½ä¸¦è·³è½‰åˆ°ç¬¬äºŒæ­¥é©Ÿ
        function selectTeacherIdentity(teacherName, teacherId) {
            console.log('è‡ªå‹•é¸æ“‡è¬›å¸«èº«ä»½ä¸¦è·³è½‰åˆ°ç¬¬äºŒæ­¥é©Ÿ:', teacherName, teacherId);
            
            // æ›´æ–°èº«ä»½é¡¯ç¤º
            const identityDisplay = document.getElementById('current-identity-display');
            if (identityDisplay) {
                identityDisplay.textContent = teacherName;
            }
            
            // æ›´æ–°è¬›å¸«æŒ‰éˆ•ç‹€æ…‹
            const teacherBtn = document.getElementById('teacher-identity-btn');
            if (teacherBtn) {
                teacherBtn.classList.add('active');
                teacherBtn.innerHTML = `<i class="fas fa-user-graduate"></i> ${teacherName}`;
            }
            
            // ç§»é™¤åŠ©æ•™æŒ‰éˆ•çš„activeç‹€æ…‹
            const assistantBtn = document.getElementById('assistant-identity-btn');
            if (assistantBtn) {
                assistantBtn.classList.remove('active');
            }
            
            // æ¨¡æ“¬é»æ“Šè¬›å¸«æŒ‰éˆ•ï¼Œè§¸ç™¼è·³è½‰åˆ°ç¬¬äºŒæ­¥é©Ÿ
            if (teacherBtn) {
                // è¨­ç½®é¸ä¸­çš„è¬›å¸«è³‡è¨Šï¼ˆä½¿ç”¨å…¨åŸŸè®Šæ•¸ï¼‰
                selectedTeacher = teacherName;
                
                // æŸ¥æ‰¾è¬›å¸«çš„ Web API é€£çµ
                const teacher = teachers.find(t => t.name === teacherName);
                if (teacher) {
                    webApi = teacher.webApi || ''; // å„²å­˜è¬›å¸«çš„ Web API é€£çµ
                }
                
                // æ›´æ–°é¸ä¸­çš„è¬›å¸«åç¨±é¡¯ç¤º
                const selectedTeacherName = document.getElementById('selected-teacher-name');
                if (selectedTeacherName) {
                    selectedTeacherName.textContent = teacherName;
                }
                
                // æ¸…é™¤èª²ç¨‹å’Œå­¸ç”Ÿè³‡æ–™ï¼ˆèˆ‡æ‰‹å‹•é¸æ“‡ä¿æŒä¸€è‡´ï¼‰
                clearCourseData();
                clearStudentData();
                
                // è·³è½‰åˆ°ç¬¬äºŒæ­¥é©Ÿ
                goToStep(2);
                
                // è¼‰å…¥èª²ç¨‹åˆ—è¡¨
                loadTeacherCourses();
                
                // æ›´æ–°å°èˆªç‹€æ…‹
                updateNavigation();
                
                // å¦‚æœè£œç°½åˆ°åŠŸèƒ½å·²ç¶“å±•é–‹ï¼Œè‡ªå‹•åˆå§‹åŒ–
                const makeupForm = document.getElementById('makeup-form');
                if (makeupForm && makeupForm.style.display !== 'none') {
                    initializeMakeupForSelectedTeacher();
                }
            }
            
            // é¡¯ç¤ºé¸æ“‡è¬›å¸«çš„è¨Šæ¯ï¼ŒåŒ…å« API è³‡è¨Šï¼ˆèˆ‡æ‰‹å‹•é¸æ“‡ä¿æŒä¸€è‡´ï¼‰
            if (webApi && webApi.trim() !== '') {
                showToast(`å·²è‡ªå‹•é¸æ“‡è¬›å¸«ï¼š${teacherName} (ä½¿ç”¨å°ˆå±¬ API)ï¼Œæ­£åœ¨è¼‰å…¥èª²ç¨‹...`, 'success');
            } else {
                showToast(`å·²è‡ªå‹•é¸æ“‡è¬›å¸«ï¼š${teacherName} (ä½¿ç”¨é è¨­ API)ï¼Œæ­£åœ¨è¼‰å…¥èª²ç¨‹...`, 'info');
            }
            
            console.log('è¬›å¸«èº«ä»½é¸æ“‡å®Œæˆï¼Œå·²è·³è½‰åˆ°ç¬¬äºŒæ­¥é©Ÿ');
        }

        // é¡¯ç¤ºé è…³ä½¿ç”¨è€…è³‡è¨Š
        function displayFooterUserInfo(userData) {
            if (userData) {
                document.getElementById('footerUserName').textContent = userData.userName || 'ç„¡';
                document.getElementById('footerUserId').textContent = userData.userId || 'ç„¡';
                document.getElementById('userInfoFooter').classList.remove('hidden');
                
                // å¦‚æœä½¿ç”¨è€…å·²ç¶å®šè¬›å¸«ï¼Œé¡¯ç¤ºè§£é™¤ç¶å®šæŒ‰éˆ•
                const unbindBtn = document.getElementById('unbind-btn');
                if (unbindBtn) {
                    if (userData.isTeacherBound) {
                        unbindBtn.style.display = 'flex';
                    } else {
                        unbindBtn.style.display = 'none';
                    }
                }
            }
        }

        // è§£é™¤è¬›å¸«ç¶å®š
        async function unbindTeacher() {
            if (!currentUserId) {
                showToast('ç„¡æ³•å–å¾—ä½¿ç”¨è€…ID', 'error');
                return;
            }

            if (!confirm('ç¢ºå®šè¦è§£é™¤è¬›å¸«ç¶å®šå—ï¼Ÿè§£é™¤å¾Œéœ€è¦é‡æ–°é¸æ“‡è¬›å¸«èº«ä»½ã€‚')) {
                return;
            }

            try {
                showToast('æ­£åœ¨è§£é™¤ç¶å®š...', 'info');
                
                const response = await fetch('/api/unbind-teacher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    let message = 'è¬›å¸«ç¶å®šå·²è§£é™¤ï¼';
                    
                    // é¡¯ç¤ºRich Menuè§£é™¤çµæœ
                    if (result.richMenuResult) {
                        if (result.richMenuResult.success) {
                            message += '\nğŸ“± Rich Menuå·²æˆåŠŸè§£é™¤ï¼';
                        } else {
                            message += `\nğŸ“± Rich Menuè§£é™¤å¤±æ•—ï¼š${result.richMenuResult.error || 'æœªçŸ¥éŒ¯èª¤'}`;
                        }
                    }
                    
                    showToast(message, 'success');
                    
                    // éš±è—è§£é™¤ç¶å®šæŒ‰éˆ•
                    const unbindBtn = document.getElementById('unbind-btn');
                    if (unbindBtn) {
                        unbindBtn.style.display = 'none';
                    }
                    
                    // é‡æ–°é¡¯ç¤ºè¬›å¸«é¸æ“‡é¸å–®
                    setTimeout(() => {
                        showTeacherSelectionModal(currentUserId);
                    }, 2000);
                } else {
                    showToast(`è§£é™¤ç¶å®šå¤±æ•—ï¼š${result.error}`, 'error');
                }
            } catch (error) {
                console.error('è§£é™¤ç¶å®šéŒ¯èª¤:', error);
                showToast('è§£é™¤ç¶å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

         // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
         window.addEventListener('load', () => {
             // åˆå§‹åŒ–LIFF
             initializeLiff();
         });
     </script>
</body>
</html> 