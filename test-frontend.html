<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <h1>ğŸ§ª å‰ç«¯åŠŸèƒ½æ¸¬è©¦</h1>
    
    <div class="test-container">
        <h2>API é€£æ¥æ¸¬è©¦</h2>
        <button class="test-button" onclick="testAPI()">æ¸¬è©¦ API é€£æ¥</button>
        <div id="apiResult" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>äº‹ä»¶è¼‰å…¥æ¸¬è©¦</h2>
        <button class="test-button" onclick="testLoadEvents()">è¼‰å…¥æ‰€æœ‰äº‹ä»¶</button>
        <button class="test-button" onclick="testLoadEventsByInstructor()">è¼‰å…¥è¬›å¸«äº‹ä»¶</button>
        <div id="eventsResult" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>ç¯©é¸åŠŸèƒ½æ¸¬è©¦</h2>
        <button class="test-button" onclick="testFiltering()">æ¸¬è©¦ç¯©é¸é‚è¼¯</button>
        <div id="filterResult" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>è¦–åœ–åˆ‡æ›æ¸¬è©¦</h2>
        <button class="test-button" onclick="testViewSwitching()">æ¸¬è©¦è¦–åœ–åˆ‡æ›</button>
        <div id="viewResult" class="result"></div>
    </div>

    <script>
        let allEvents = [];
        let allInstructors = [];
        
        // æ¸¬è©¦ API é€£æ¥
        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦ API é€£æ¥...';
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… API é€£æ¥æˆåŠŸ\nç‹€æ…‹: ${data.status}\näº‹ä»¶æ•¸é‡: ${data.events_count}\nè¬›å¸«æ•¸é‡: ${data.teachers_count}\nè³‡æ–™ä¾†æº: ${data.data_source}`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ API é€£æ¥å¤±æ•—: ${error.message}`;
            }
        }
        
        // æ¸¬è©¦äº‹ä»¶è¼‰å…¥
        async function testLoadEvents() {
            const resultDiv = document.getElementById('eventsResult');
            resultDiv.textContent = 'æ­£åœ¨è¼‰å…¥äº‹ä»¶...';
            
            try {
                const response = await fetch('/api/events');
                const data = await response.json();
                
                if (data.success) {
                    allEvents = data.data;
                    allInstructors = [...new Set(allEvents.map(event => event.instructor).filter(Boolean))];
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… äº‹ä»¶è¼‰å…¥æˆåŠŸ\nç¸½äº‹ä»¶æ•¸: ${allEvents.length}\nè¬›å¸«åˆ—è¡¨: ${allInstructors.join(', ')}\nè³‡æ–™ä¾†æº: ${data.data_source}\n\nå‰5å€‹äº‹ä»¶:\n${allEvents.slice(0, 5).map((event, i) => `${i+1}. ${event.title} (${event.instructor})`).join('\n')}`;
                } else {
                    throw new Error(data.message || 'è¼‰å…¥å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ äº‹ä»¶è¼‰å…¥å¤±æ•—: ${error.message}`;
            }
        }
        
        // æ¸¬è©¦è¬›å¸«äº‹ä»¶è¼‰å…¥
        async function testLoadEventsByInstructor() {
            const resultDiv = document.getElementById('eventsResult');
            
            if (allInstructors.length === 0) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è«‹å…ˆè¼‰å…¥æ‰€æœ‰äº‹ä»¶';
                return;
            }
            
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦è¬›å¸«äº‹ä»¶è¼‰å…¥...';
            
            try {
                const results = [];
                
                for (const instructor of allInstructors) {
                    const response = await fetch(`/api/events/${instructor}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        results.push(`${instructor}: ${data.data.length} å€‹äº‹ä»¶`);
                    } else {
                        results.push(`${instructor}: è¼‰å…¥å¤±æ•—`);
                    }
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… è¬›å¸«äº‹ä»¶è¼‰å…¥æ¸¬è©¦å®Œæˆ\n\n${results.join('\n')}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¬›å¸«äº‹ä»¶è¼‰å…¥å¤±æ•—: ${error.message}`;
            }
        }
        
        // æ¸¬è©¦ç¯©é¸é‚è¼¯
        function testFiltering() {
            const resultDiv = document.getElementById('filterResult');
            
            if (allEvents.length === 0) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è«‹å…ˆè¼‰å…¥æ‰€æœ‰äº‹ä»¶';
                return;
            }
            
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦ç¯©é¸é‚è¼¯...';
            
            try {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                // æ¸¬è©¦ä»Šæ—¥ç¯©é¸
                const todayEvents = allEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                    return eventDay.getTime() === today.getTime();
                });
                
                // æ¸¬è©¦æœ¬é€±ç¯©é¸
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay() + 1);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                const weekEvents = allEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                    return eventDay >= weekStart && eventDay <= weekEnd;
                });
                
                // æ¸¬è©¦æœ¬æœˆç¯©é¸
                const monthEvents = allEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    return eventDate.getFullYear() === now.getFullYear() && 
                           eventDate.getMonth() === now.getMonth();
                });
                
                // æ¸¬è©¦è¬›å¸«ç¯©é¸
                const instructorStats = {};
                allInstructors.forEach(instructor => {
                    instructorStats[instructor] = allEvents.filter(event => event.instructor === instructor).length;
                });
                
                // æ¸¬è©¦æ™‚æ®µç¯©é¸
                const morningEvents = allEvents.filter(event => {
                    const hour = new Date(event.start).getHours();
                    return hour >= 6 && hour < 12;
                });
                
                const afternoonEvents = allEvents.filter(event => {
                    const hour = new Date(event.start).getHours();
                    return hour >= 12 && hour < 18;
                });
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… ç¯©é¸é‚è¼¯æ¸¬è©¦å®Œæˆ
                
ğŸ“… æ—¥æœŸç¯©é¸:
- ä»Šæ—¥äº‹ä»¶: ${todayEvents.length} å€‹
- æœ¬é€±äº‹ä»¶: ${weekEvents.length} å€‹  
- æœ¬æœˆäº‹ä»¶: ${monthEvents.length} å€‹
- å…¨éƒ¨äº‹ä»¶: ${allEvents.length} å€‹

ğŸ‘¥ è¬›å¸«ç¯©é¸:
${Object.entries(instructorStats).map(([instructor, count]) => `- ${instructor}: ${count} å€‹äº‹ä»¶`).join('\n')}

ğŸ• æ™‚æ®µç¯©é¸:
- æ—©ä¸Š (06:00-12:00): ${morningEvents.length} å€‹äº‹ä»¶
- ä¸‹åˆ (12:00-18:00): ${afternoonEvents.length} å€‹äº‹ä»¶

ğŸ“‹ ä»Šæ—¥äº‹ä»¶è©³æƒ…:
${todayEvents.map(event => `- ${new Date(event.start).toLocaleTimeString()} ${event.title} (${event.instructor})`).join('\n') || 'ç„¡ä»Šæ—¥äº‹ä»¶'}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç¯©é¸é‚è¼¯æ¸¬è©¦å¤±æ•—: ${error.message}`;
            }
        }
        
        // æ¸¬è©¦è¦–åœ–åˆ‡æ›
        function testViewSwitching() {
            const resultDiv = document.getElementById('viewResult');
            
            if (allEvents.length === 0) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è«‹å…ˆè¼‰å…¥æ‰€æœ‰äº‹ä»¶';
                return;
            }
            
            resultDiv.textContent = 'æ­£åœ¨æ¸¬è©¦è¦–åœ–åˆ‡æ›...';
            
            try {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                // æ¨¡æ“¬è¦–åœ–åˆ‡æ›é‚è¼¯
                const views = ['ä»Šæ—¥', 'æœ¬é€±', 'æœ¬æœˆ', 'å…¨éƒ¨'];
                const results = [];
                
                views.forEach(view => {
                    let filteredEvents = [];
                    
                    switch (view) {
                        case 'ä»Šæ—¥':
                            filteredEvents = allEvents.filter(event => {
                                const eventDate = new Date(event.start);
                                const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                                return eventDay.getTime() === today.getTime();
                            });
                            break;
                        case 'æœ¬é€±':
                            const weekStart = new Date(today);
                            weekStart.setDate(today.getDate() - today.getDay() + 1);
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            
                            filteredEvents = allEvents.filter(event => {
                                const eventDate = new Date(event.start);
                                const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
                                return eventDay >= weekStart && eventDay <= weekEnd;
                            });
                            break;
                        case 'æœ¬æœˆ':
                            filteredEvents = allEvents.filter(event => {
                                const eventDate = new Date(event.start);
                                return eventDate.getFullYear() === now.getFullYear() && 
                                       eventDate.getMonth() === now.getMonth();
                            });
                            break;
                        case 'å…¨éƒ¨':
                            filteredEvents = allEvents;
                            break;
                    }
                    
                    results.push(`${view}: ${filteredEvents.length} å€‹äº‹ä»¶`);
                });
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… è¦–åœ–åˆ‡æ›æ¸¬è©¦å®Œæˆ
                
${results.join('\n')}

ğŸ“Š è¦–åœ–åˆ‡æ›é‚è¼¯æ­£å¸¸é‹ä½œï¼Œæ‰€æœ‰è¦–åœ–éƒ½èƒ½æ­£ç¢ºç¯©é¸äº‹ä»¶ã€‚`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¦–åœ–åˆ‡æ›æ¸¬è©¦å¤±æ•—: ${error.message}`;
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦ API é€£æ¥
        window.onload = function() {
            testAPI();
        };
    </script>
</body>
</html>