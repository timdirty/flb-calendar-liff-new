/Users/apple/Library/CloudStorage/SynologyDrive-樂程坊計畫/課程資料/Cursor/FLB簽到系統（line）<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>講師行事曆檢視系統 - 測試版 (含簽到功能)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                linear-gradient(135deg, 
                    rgba(0, 0, 0, 0.98) 0%, 
                    rgba(15, 15, 15, 0.95) 25%,
                    rgba(25, 25, 25, 0.92) 50%,
                    rgba(15, 15, 15, 0.95) 75%,
                    rgba(0, 0, 0, 0.98) 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 400% 400%;
            animation: gradientShift 20s ease infinite, subtleGlow 8s ease-in-out infinite;
            min-height: 100vh;
            color: rgba(255, 255, 255, 0.95);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.03) 50%, transparent 70%),
                linear-gradient(-45deg, transparent 30%, rgba(255, 215, 0, 0.02) 50%, transparent 70%);
            animation: shimmer 12s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes subtleGlow {
            0%, 100% { 
                background-position: 0% 0%, 0% 0%, 0% 0%, 0% 50%;
            }
            50% { 
                background-position: 0% 0%, 0% 0%, 0% 0%, 100% 50%;
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.2),
                0 0 0 1px rgba(255, 215, 0, 0.1);
            position: relative;
            z-index: 2;
        }

        /* 測試版標識 */
        .test-banner {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 頂部標題區域 */
        .header {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.8) 0%, 
                rgba(20, 20, 20, 0.9) 50%,
                rgba(0, 0, 0, 0.8) 100%);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            padding: 30px;
            margin-bottom: 25px;
            border-radius: 25px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 215, 0, 0.3),
                0 0 0 1px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: headerFloat 6s ease-in-out infinite;
        }

        @keyframes headerFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: headerShimmer 3s ease-in-out infinite;
        }

        @keyframes headerShimmer {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 10px;
            animation: textShimmer 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        @keyframes textShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            text-align: center;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }

        /* 統計資訊區域 */
        .stats-section {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }

        .stats-card {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            text-align: center;
            flex: 1;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.2);
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* 控制區域 */
        .control-section {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .control-group label {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            min-width: 80px;
        }

        select, input {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* 視圖按鈕 */
        .view-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.1));
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 165, 0, 0.3));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .btn.active {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
        }

        /* 事件卡片 */
        .events-container {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .event-card {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .event-instructor {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        .event-detail {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .event-description {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 215, 0, 0.2);
        }

        .event-description h4 {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 5px;
        }

        .event-description p {
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }

        /* 簽到系統整合區域 */
        .attendance-section {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .attendance-section h3 {
            color: #00ff00;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .attendance-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-attendance {
            background: linear-gradient(135deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-attendance:hover {
            background: linear-gradient(135deg, #00cc00, #009900);
            transform: translateY(-2px);
        }

        /* 事件卡片中的直接簽到按鈕 */
        .event-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 215, 0, 0.2);
            text-align: center;
        }

        .btn-direct-attendance {
            background: linear-gradient(135deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-direct-attendance:hover {
            background: linear-gradient(135deg, #00cc00, #009900);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 255, 0, 0.3);
        }

        .btn-direct-attendance:active {
            transform: translateY(0);
        }

        /* 動畫效果 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* 學生狀態樣式 */
        .student-item.present {
            border-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
        }

        .student-item.absent {
            border-color: #dc3545;
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(231, 76, 60, 0.1));
        }

        .student-item.leave {
            border-color: #ffc107;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(243, 156, 18, 0.1));
        }

        /* 浮動按鈕 */
        .refresh-button {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 32px rgba(255, 255, 255, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            will-change: transform, box-shadow;
        }

        .attendance-menu {
            position: fixed;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            user-select: none;
        }

        .attendance-menu-button {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 0.9) 0%, 
                rgba(69, 160, 73, 0.8) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 8px 32px rgba(76, 175, 80, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            will-change: transform, box-shadow;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .view-buttons {
                justify-content: center;
            }
            
            .stats-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 測試版標識 -->
        <div class="test-banner">
            <i class="fas fa-flask"></i> 測試版本 - 整合簽到系統功能
        </div>

        <!-- 頂部標題區域 -->
        <div class="header">
            <h1><i class="fas fa-calendar-alt"></i> 講師行事曆檢視系統</h1>
            <p>整合簽到功能的完整解決方案</p>
        </div>

        <!-- 統計資訊區域 -->
        <div class="stats-section">
            <div class="stats-card">
                <div class="stats-number" id="totalEvents">0</div>
                <div class="stats-label">總事件數</div>
            </div>
            <div class="stats-card">
                <div class="stats-number" id="instructorCount">0</div>
                <div class="stats-label">講師數量</div>
            </div>
            <div class="stats-card">
                <div class="stats-number" id="dateRange">-</div>
                <div class="stats-label">日期範圍</div>
            </div>
        </div>

        <!-- 控制區域 -->
        <div class="control-section">
            <div class="control-group">
                <label for="instructorSelect">講師：</label>
                <select id="instructorSelect">
                    <option value="">載入中...</option>
                </select>
                
                <label for="timeFilter">時段：</label>
                <select id="timeFilter">
                    <option value="">全部時段</option>
                </select>
                
                <label for="dateFilter">日期：</label>
                <input type="date" id="dateFilter">
            </div>
            
            <div class="view-buttons">
                <button class="btn active" data-view="today">今日</button>
                <button class="btn" data-view="week">本週</button>
                <button class="btn" data-view="month">本月</button>
                <button class="btn" data-view="all">全部</button>
            </div>
        </div>

        <!-- 簽到系統整合區域 -->
        <div class="attendance-section">
            <h3><i class="fas fa-calendar-check"></i> 快速簽到功能</h3>
            <div class="attendance-buttons">
                <button class="btn-attendance" id="openAttendanceBtn">
                    <i class="fas fa-sign-in-alt"></i> 開啟簽到系統
                </button>
                <button class="btn-attendance" id="quickAttendanceBtn">
                    <i class="fas fa-bolt"></i> 快速簽到
                </button>
                <button class="btn-attendance" id="viewReportBtn">
                    <i class="fas fa-chart-bar"></i> 查看報表
                </button>
            </div>
        </div>

        <!-- 事件列表區域 -->
        <div class="events-container" id="eventsContainer">
            <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                <p>載入行事曆資料中...</p>
            </div>
        </div>
    </div>

    <!-- 重新整理浮動按鈕 -->
    <div id="refreshButton" class="refresh-button" title="重新整理行事曆">
        <i class="fas fa-sync-alt"></i>
    </div>

    <!-- 簽到系統懸浮選單 -->
    <div id="attendanceMenu" class="attendance-menu" title="簽到系統">
        <div class="attendance-menu-button">
            <i class="fas fa-calendar-check"></i>
        </div>
        <div class="attendance-menu-tooltip">
            <span>簽到系統</span>
        </div>
    </div>

    <script>
        // 全域變數
        let allEvents = [];
        let currentView = '今日';
        let currentInstructor = '';
        let currentTimeFilter = '';
        let currentDateFilter = '';

        // 初始化系統
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 測試版系統初始化開始');
            
            // 測試課程解析功能
            testCourseParsing();
            
            initializeSystem();
        });

        async function initializeSystem() {
            try {
                console.log('📅 開始載入行事曆資料...');
                await loadCalendarData();
                
                console.log('👥 開始載入講師列表...');
                await loadInstructors();
                
                console.log('🎛️ 初始化控制項...');
                initializeControls();
                
                console.log('📊 更新統計資訊...');
                updateStats();
                
                console.log('🎨 渲染事件...');
                renderEvents();
                
                console.log('✅ 測試版系統初始化完成');
            } catch (error) {
                console.error('❌ 系統初始化失敗:', error);
                showError('系統初始化失敗，請重新整理頁面');
            }
        }

        // 載入行事曆資料
        async function loadCalendarData() {
            try {
                console.log('🚀 開始載入完整事件數據...');
                const response = await fetch('/api/events');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.success && data.data) {
                    allEvents = data.data;
                    console.log(`✅ 載入 ${allEvents.length} 個事件`);
                } else {
                    throw new Error(data.error || '載入行事曆資料失敗');
                }
            } catch (error) {
                console.error('❌ 載入行事曆資料失敗:', error);
                // 使用測試資料
                allEvents = generateTestEvents();
                console.log('📝 使用測試資料');
            }
        }

        // 載入講師列表
        async function loadInstructors() {
            try {
                const response = await fetch('/api/teachers');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.success && data.teachers) {
                    const instructorNames = data.teachers.map(teacher => teacher.name);
                    populateInstructorDropdown(instructorNames);
                    console.log(`✅ 載入 ${instructorNames.length} 個講師`);
                } else {
                    throw new Error(data.error || '載入講師列表失敗');
                }
            } catch (error) {
                console.error('❌ 載入講師列表失敗:', error);
                // 使用測試講師
                const testInstructors = ['Tim', 'BELLA', 'AGNES', 'Hansen', 'Eason'];
                populateInstructorDropdown(testInstructors);
                console.log('📝 使用測試講師資料');
            }
        }

        // 填充講師下拉選單
        function populateInstructorDropdown(instructors) {
            const select = document.getElementById('instructorSelect');
            select.innerHTML = '<option value="">全部講師</option>';
            
            instructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor;
                option.textContent = instructor;
                select.appendChild(option);
            });
        }

        // 初始化控制項
        function initializeControls() {
            // 講師選擇
            document.getElementById('instructorSelect').addEventListener('change', function() {
                currentInstructor = this.value;
                updateStats();
                renderEvents();
            });

            // 時段篩選
            document.getElementById('timeFilter').addEventListener('change', function() {
                currentTimeFilter = this.value;
                updateStats();
                renderEvents();
            });

            // 日期篩選
            document.getElementById('dateFilter').addEventListener('change', function() {
                currentDateFilter = this.value;
                updateStats();
                renderEvents();
            });

            // 視圖按鈕
            document.querySelectorAll('.view-buttons .btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.view-buttons .btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.dataset.view;
                    updateStats();
                    renderEvents();
                });
            });

            // 重新整理按鈕
            document.getElementById('refreshButton').addEventListener('click', function() {
                forceRefresh();
            });

            // 簽到系統選單
            document.getElementById('attendanceMenu').addEventListener('click', function() {
                openAttendanceSystem();
            });

            // 簽到功能按鈕
            document.getElementById('openAttendanceBtn').addEventListener('click', function() {
                openAttendanceSystem();
            });

            document.getElementById('quickAttendanceBtn').addEventListener('click', function() {
                quickAttendance();
            });

            document.getElementById('viewReportBtn').addEventListener('click', function() {
                viewAttendanceReport();
            });
        }

        // 更新統計資訊
        function updateStats() {
            const filteredEvents = getFilteredEvents();
            
            document.getElementById('totalEvents').textContent = filteredEvents.length;
            document.getElementById('instructorCount').textContent = getUniqueInstructors(filteredEvents).length;
            document.getElementById('dateRange').textContent = getDateRange(filteredEvents);
        }

        // 獲取篩選後的事件
        function getFilteredEvents() {
            let filtered = [...allEvents];

            // 講師篩選
            if (currentInstructor) {
                filtered = filtered.filter(event => event.instructor === currentInstructor);
            }

            // 時段篩選
            if (currentTimeFilter) {
                filtered = filtered.filter(event => {
                    const hour = new Date(event.start).getHours();
                    switch (currentTimeFilter) {
                        case 'morning': return hour >= 6 && hour < 12;
                        case 'afternoon': return hour >= 12 && hour < 18;
                        case 'evening': return hour >= 18 && hour < 24;
                        default: return true;
                    }
                });
            }

            // 日期篩選
            if (currentDateFilter) {
                const filterDate = new Date(currentDateFilter);
                filtered = filtered.filter(event => {
                    const eventDate = new Date(event.start);
                    return eventDate.toDateString() === filterDate.toDateString();
                });
            }

            // 視圖篩選
            const now = new Date();
            switch (currentView) {
                case '今日':
                    filtered = filtered.filter(event => {
                        const eventDate = new Date(event.start);
                        return eventDate.toDateString() === now.toDateString();
                    });
                    break;
                case '本週':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    filtered = filtered.filter(event => {
                        const eventDate = new Date(event.start);
                        return eventDate >= weekStart && eventDate <= weekEnd;
                    });
                    break;
                case '本月':
                    filtered = filtered.filter(event => {
                        const eventDate = new Date(event.start);
                        return eventDate.getMonth() === now.getMonth() && eventDate.getFullYear() === now.getFullYear();
                    });
                    break;
                case '全部':
                    // 不進行額外篩選
                    break;
            }

            return filtered;
        }

        // 獲取唯一講師列表
        function getUniqueInstructors(events) {
            const instructors = new Set();
            events.forEach(event => {
                if (event.instructor) {
                    instructors.add(event.instructor);
                }
            });
            return Array.from(instructors);
        }

        // 獲取日期範圍
        function getDateRange(events) {
            if (events.length === 0) return '-';
            
            const dates = events.map(event => new Date(event.start)).sort((a, b) => a - b);
            const startDate = dates[0];
            const endDate = dates[dates.length - 1];
            
            if (startDate.toDateString() === endDate.toDateString()) {
                return startDate.toLocaleDateString('zh-TW');
            } else {
                return `${startDate.toLocaleDateString('zh-TW')} - ${endDate.toLocaleDateString('zh-TW')}`;
            }
        }

        // 渲染事件
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const filteredEvents = getFilteredEvents();

            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                        <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>沒有找到符合條件的事件</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredEvents.map(event => createEventCard(event)).join('');
            
            // 添加直接簽到按鈕的事件監聽器
            setTimeout(() => {
                const directAttendanceBtns = container.querySelectorAll('.btn-direct-attendance');
                directAttendanceBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const title = this.dataset.eventTitle;
                        const instructor = this.dataset.eventInstructor;
                        const start = this.dataset.eventStart;
                        const end = this.dataset.eventEnd;
                        handleDirectAttendance(title, instructor, start, end);
                    });
                });
            }, 100);
        }

        // 創建事件卡片
        function createEventCard(event) {
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            
            const timeString = `${startDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} - ${endDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}`;
            const dateString = startDate.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                weekday: 'long'
            });

            // 檢查是否為今日課程
            const today = new Date();
            const isToday = startDate.toDateString() === today.toDateString();
            const isFuture = startDate > today;

            return `
                <div class="event-card" data-event-title="${event.title || '未命名事件'}" data-event-instructor="${event.instructor || '未知講師'}" data-event-start="${event.start}" data-event-end="${event.end}">
                    <div class="event-title">
                        <i class="fas fa-calendar-day"></i>
                        ${event.title || '未命名事件'}
                    </div>
                    <div class="event-instructor">
                        <i class="fas fa-user"></i> ${event.instructor || '未知講師'}
                    </div>
                    <div class="event-detail">
                        <i class="fas fa-clock"></i> ${timeString}
                    </div>
                    <div class="event-detail">
                        <i class="fas fa-calendar"></i> ${dateString}
                    </div>
                    ${event.location ? `
                        <div class="event-detail">
                            <i class="fas fa-map-marker-alt"></i> ${event.location}
                        </div>
                    ` : ''}
                    ${event.description ? `
                        <div class="event-description">
                            <h4>說明</h4>
                            <p>${event.description}</p>
                        </div>
                    ` : ''}
                    ${(isToday || isFuture) ? `
                        <div class="event-actions">
                            <button class="btn-attendance btn-direct-attendance" data-event-title="${event.title || '未命名事件'}" data-event-instructor="${event.instructor || '未知講師'}" data-event-start="${event.start}" data-event-end="${event.end}">
                                <i class="fas fa-sign-in-alt"></i> 直接簽到
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // 生成測試事件
        function generateTestEvents() {
            const now = new Date();
            const events = [];
            
            for (let i = 0; i < 10; i++) {
                const eventDate = new Date(now);
                eventDate.setDate(now.getDate() + i);
                
                events.push({
                    title: `測試課程 ${i + 1}`,
                    instructor: ['Tim', 'BELLA', 'AGNES', 'Hansen', 'Eason'][i % 5],
                    start: eventDate.toISOString(),
                    end: new Date(eventDate.getTime() + 2 * 60 * 60 * 1000).toISOString(),
                    location: `教室 ${i + 1}`,
                    description: `這是第 ${i + 1} 個測試課程的描述`
                });
            }
            
            return events;
        }

        // 簽到系統功能
        function openAttendanceSystem() {
            const attendanceUrl = 'https://liff.line.me/1657746214-wPgd2qQn';
            
            try {
                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    liff.openWindow({
                        url: attendanceUrl,
                        external: false
                    });
                    console.log('✅ 使用 LIFF 在 LINE 內開啟簽到系統');
                } else {
                    window.open(attendanceUrl, '_blank', 'noopener,noreferrer');
                    console.log('✅ 使用一般方式開啟簽到系統');
                }
            } catch (error) {
                console.error('❌ 開啟簽到系統失敗:', error);
                window.open(attendanceUrl, '_blank', 'noopener,noreferrer');
            }
        }

        // 快速簽到功能
        async function quickAttendance() {
            try {
                // 獲取當前選中的講師
                const selectedInstructor = document.getElementById('instructorSelect').value;
                if (!selectedInstructor) {
                    alert('請先選擇講師');
                    return;
                }

                // 獲取可用講師列表並進行模糊比對
                const availableInstructors = await getAvailableInstructors();
                const matchedInstructor = findMatchingInstructor(selectedInstructor, availableInstructors);
                
                if (!matchedInstructor) {
                    const errorMsg = `講師 "${selectedInstructor}" 不存在。可用的講師：${availableInstructors.join(', ')}`;
                    console.error('❌', errorMsg);
                    alert(errorMsg);
                    return;
                }

                // 如果找到匹配的講師，使用匹配的名稱
                const finalInstructor = matchedInstructor !== selectedInstructor ? matchedInstructor : selectedInstructor;
                if (matchedInstructor !== selectedInstructor) {
                    console.log(`🔄 講師名稱已修正: "${selectedInstructor}" → "${matchedInstructor}"`);
                }

                // 獲取今日事件（使用模糊比對）
                const todayEvents = allEvents.filter(event => {
                    const eventDate = new Date(event.start);
                    const today = new Date();
                    const isToday = eventDate.toDateString() === today.toDateString();
                    
                    // 使用模糊比對來匹配講師
                    const eventInstructorMatch = findMatchingInstructor(event.instructor, [finalInstructor]);
                    return isToday && eventInstructorMatch === finalInstructor;
                });

                if (todayEvents.length === 0) {
                    alert(`今日沒有 ${finalInstructor} 的課程`);
                    return;
                }

                // 如果只有一個課程，直接開啟簽到系統
                if (todayEvents.length === 1) {
                    const event = todayEvents[0];
                    const { courseName, timeInfo } = parseCourseTitle(event.title);
                    const finalTimeString = timeInfo || `${new Date(event.start).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} - ${new Date(event.end).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}`;
                    
                    await openNativeAttendanceSystem(finalInstructor, courseName, finalTimeString, event.start, event.end);
                } else {
                    // 多個課程時顯示選擇對話框
                    showCourseSelectionDialog(todayEvents);
                }
            } catch (error) {
                console.error('❌ 快速簽到失敗:', error);
                alert('快速簽到失敗: ' + error.message);
            }
        }

        // 顯示課程選擇對話框
        function showCourseSelectionDialog(events) {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: rgba(0, 0, 0, 0.9);
                border: 2px solid #00ff00;
                border-radius: 15px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;

            content.innerHTML = `
                <h3 style="color: #00ff00; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-calendar-check"></i> 選擇要簽到的課程
                </h3>
                <div id="courseList">
                    ${events.map((event, index) => `
                        <div style="
                            background: rgba(0, 255, 0, 0.1);
                            border: 1px solid rgba(0, 255, 0, 0.3);
                            border-radius: 10px;
                            padding: 15px;
                            margin-bottom: 10px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " data-course-title="${event.title}" data-course-start="${event.start}" data-course-end="${event.end}">
                            <div style="font-weight: bold; color: #00ff00; margin-bottom: 5px;">
                                ${event.title}
                            </div>
                            <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">
                                ${new Date(event.start).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} - 
                                ${new Date(event.end).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                            ${event.location ? `<div style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">${event.location}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="closeCourseDialogBtn" style="
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                    ">取消</button>
                </div>
            `;

            dialog.appendChild(content);
            document.body.appendChild(dialog);

            // 存儲對話框引用
            window.currentCourseDialog = dialog;

            // 添加事件監聽器
            setTimeout(() => {
                // 課程選擇事件
                const courseItems = dialog.querySelectorAll('[data-course-title]');
                courseItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const title = this.dataset.courseTitle;
                        const start = this.dataset.courseStart;
                        const end = this.dataset.courseEnd;
                        selectCourseForAttendance(title, start, end);
                    });
                });

                // 取消按鈕事件
                const closeBtn = dialog.querySelector('#closeCourseDialogBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        closeCourseDialog();
                    });
                }
            }, 100);
        }

        // 選擇課程進行簽到
        async function selectCourseForAttendance(title, start, end) {
            try {
                const selectedInstructor = document.getElementById('instructorSelect').value;
                
                // 解析課程標題，分離課程名稱和時間資訊
                const { courseName, timeInfo } = parseCourseTitle(title);
                console.log(`📝 解析結果: 課程="${courseName}", 時間資訊="${timeInfo}"`);
                
                // 獲取可用講師列表並進行模糊比對
                const availableInstructors = await getAvailableInstructors();
                const matchedInstructor = findMatchingInstructor(selectedInstructor, availableInstructors);
                
                if (!matchedInstructor) {
                    const errorMsg = `講師 "${selectedInstructor}" 不存在。可用的講師：${availableInstructors.join(', ')}`;
                    console.error('❌', errorMsg);
                    alert(errorMsg);
                    return;
                }

                // 使用匹配的講師名稱
                const finalInstructor = matchedInstructor !== selectedInstructor ? matchedInstructor : selectedInstructor;
                if (matchedInstructor !== selectedInstructor) {
                    console.log(`🔄 講師名稱已修正: "${selectedInstructor}" → "${matchedInstructor}"`);
                }
                
                // 使用解析後的課程名稱和時間資訊
                const finalCourseName = courseName;
                const finalTimeString = timeInfo || `${new Date(start).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} - ${new Date(end).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}`;
                
                // 關閉對話框
                closeCourseDialog();
                
                // 開啟原生簽到系統
                await openNativeAttendanceSystem(finalInstructor, finalCourseName, finalTimeString, start, end);
                
                console.log('✅ 開啟課程簽到:', { finalInstructor, finalCourseName, finalTimeString });
            } catch (error) {
                console.error('❌ 選擇課程簽到失敗:', error);
                alert('選擇課程簽到失敗: ' + error.message);
            }
        }

        // 關閉課程選擇對話框
        function closeCourseDialog() {
            if (window.currentCourseDialog) {
                document.body.removeChild(window.currentCourseDialog);
                window.currentCourseDialog = null;
            }
        }

        // 查看簽到報表
        async function viewAttendanceReport() {
            try {
                const selectedInstructor = document.getElementById('instructorSelect').value;
                if (!selectedInstructor) {
                    alert('請先選擇講師');
                    return;
                }

                // 獲取可用講師列表並進行模糊比對
                const availableInstructors = await getAvailableInstructors();
                const matchedInstructor = findMatchingInstructor(selectedInstructor, availableInstructors);
                
                if (!matchedInstructor) {
                    const errorMsg = `講師 "${selectedInstructor}" 不存在。可用的講師：${availableInstructors.join(', ')}`;
                    console.error('❌', errorMsg);
                    alert(errorMsg);
                    return;
                }

                // 使用匹配的講師名稱
                const finalInstructor = matchedInstructor !== selectedInstructor ? matchedInstructor : selectedInstructor;
                if (matchedInstructor !== selectedInstructor) {
                    console.log(`🔄 講師名稱已修正: "${selectedInstructor}" → "${matchedInstructor}"`);
                }

                // 構建報表查詢URL
                const reportUrl = `https://liff.line.me/1657746214-wPgd2qQn?step=report&teacher=${encodeURIComponent(finalInstructor)}`;
                
                // 開啟報表查詢
                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    liff.openWindow({
                        url: reportUrl,
                        external: false
                    });
                } else {
                    window.open(reportUrl, '_blank', 'noopener,noreferrer');
                }

                console.log('✅ 開啟簽到報表:', finalInstructor);
            } catch (error) {
                console.error('❌ 開啟簽到報表失敗:', error);
                alert('開啟簽到報表失敗: ' + error.message);
            }
        }

        // 模糊比對講師名稱
        function findMatchingInstructor(targetInstructor, availableInstructors) {
            if (!targetInstructor || !availableInstructors || availableInstructors.length === 0) {
                return null;
            }

            const target = targetInstructor.trim().toLowerCase();
            
            // 1. 完全匹配（不區分大小寫）
            let exactMatch = availableInstructors.find(instructor => 
                instructor.toLowerCase() === target
            );
            if (exactMatch) {
                console.log(`✅ 完全匹配找到講師: ${exactMatch}`);
                return exactMatch;
            }

            // 2. 包含匹配
            let containsMatch = availableInstructors.find(instructor => 
                instructor.toLowerCase().includes(target) || target.includes(instructor.toLowerCase())
            );
            if (containsMatch) {
                console.log(`✅ 包含匹配找到講師: ${containsMatch}`);
                return containsMatch;
            }

            // 3. 模糊匹配（使用 Levenshtein 距離）
            let bestMatch = null;
            let bestScore = Infinity;
            const threshold = 3; // 最大編輯距離

            for (const instructor of availableInstructors) {
                const distance = levenshteinDistance(target, instructor.toLowerCase());
                if (distance <= threshold && distance < bestScore) {
                    bestScore = distance;
                    bestMatch = instructor;
                }
            }

            if (bestMatch) {
                console.log(`✅ 模糊匹配找到講師: ${bestMatch} (距離: ${bestScore})`);
                return bestMatch;
            }

            console.log(`❌ 找不到匹配的講師: ${targetInstructor}`);
            return null;
        }

        // Levenshtein 距離算法
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;

            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[len2][len1];
        }

        // 特殊事件類型定義
        const SPECIAL_EVENT_TYPES = {
            "停課": ["停課", "取消", "暫停", "休息", "放假", "請假"],
            "體驗": ["體驗", "體驗課", "體驗班", "體課", "體"],
            "代課": ["代課", "代理", "支援", "代"],
            "補課": ["補課", "調課", "延後", "提前"]
        };

        // 從時間資訊中移除特殊事件類型和週次
        function removeSpecialEventTypes(timeInfo) {
            if (!timeInfo) return timeInfo;
            
            let cleanedTimeInfo = timeInfo;
            
            // 移除所有特殊事件類型
            Object.values(SPECIAL_EVENT_TYPES).forEach(keywords => {
                keywords.forEach(keyword => {
                    // 移除特殊事件關鍵字（包括前後的空白）
                    const regex = new RegExp(`\\s*${keyword}\\s*`, 'g');
                    cleanedTimeInfo = cleanedTimeInfo.replace(regex, ' ');
                });
            });
            
            // 移除週次（第X週、第X周、Week X等）
            const weekPatterns = [
                /第\d+週/g,
                /第\d+周/g,
                /Week\s*\d+/gi,
                /週\d+/g,
                /周\d+/g
            ];
            
            weekPatterns.forEach(pattern => {
                cleanedTimeInfo = cleanedTimeInfo.replace(pattern, ' ').trim();
            });
            
            // 清理多餘的空白
            cleanedTimeInfo = cleanedTimeInfo.replace(/\s+/g, ' ').trim();
            
            console.log(`🧹 清理特殊事件和週次: "${timeInfo}" → "${cleanedTimeInfo}"`);
            return cleanedTimeInfo;
        }

        // 解析課程標題，分離課程名稱和時間資訊（符合 API 格式）
        function parseCourseTitle(fullTitle) {
            if (!fullTitle) {
                return { courseName: '未命名課程', timeInfo: '' };
            }

            console.log(`📝 開始解析課程標題: "${fullTitle}"`);

            // 常見的時間模式（按照 API 文檔格式）
            const timePatterns = [
                // 六 16:00-18:00 第2週 代課
                /([一二三四五六日])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})\s+第(\d+)週\s*(.+)/,
                // 六 16:00-18:00 代課
                /([一二三四五六日])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})\s+(.+)/,
                // 六 16:00-18:00
                /([一二三四五六日])\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/,
                // 六 1530-1700 到府 (沒有冒號的格式)
                /([一二三四五六日])\s+(\d{3,4})-(\d{3,4})\s+(.+)/,
                // 六 1530-1700
                /([一二三四五六日])\s+(\d{3,4})-(\d{3,4})/,
                // 16:00-18:00 到府
                /(\d{1,2}:\d{2})-(\d{1,2}:\d{2})\s+(.+)/,
                // 16:00-18:00
                /(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/,
                // 1530-1700 到府 (沒有冒號的格式)
                /(\d{3,4})-(\d{3,4})\s+(.+)/,
                // 1530-1700
                /(\d{3,4})-(\d{3,4})/,
                // 第X週
                /第(\d+)週/,
                // 請假
                /請假/
            ];

            let courseName = fullTitle;
            let timeInfo = '';

            // 嘗試匹配各種時間模式
            for (const pattern of timePatterns) {
                const match = fullTitle.match(pattern);
                if (match) {
                    console.log(`🔍 匹配到模式: ${pattern.source}`, match);
                    
                    if (pattern.source.includes('請假')) {
                        // 處理請假情況
                        courseName = fullTitle.replace(/請假.*$/, '').trim();
                        timeInfo = '請假';
                        break;
                    } else if (pattern.source.includes('第') && pattern.source.includes('週') && pattern.source.includes('一二三四五六日')) {
                        // 處理包含星期、時間和週次的情況：六 16:00-18:00 第2週 代課
                        const weekday = match[1];
                        const startTime = match[2];
                        const endTime = match[3];
                        const week = match[4];
                        const location = match[5] || '';
                        
                        // 轉換時間格式：09:30 -> 0930, 16:00 -> 1600
                        const formatTime = (time) => {
                            const [hours, minutes] = time.split(':');
                            return hours.padStart(2, '0') + minutes;
                        };
                        const formattedStartTime = formatTime(startTime);
                        const formattedEndTime = formatTime(endTime);
                        
                        courseName = fullTitle.replace(new RegExp(`${weekday}\\s+${startTime}-${endTime}\\s*第${week}週\\s*${location}.*$`), '').trim();
                        timeInfo = `${weekday} ${formattedStartTime}-${formattedEndTime}${location ? ' ' + location : ''}`;
                        break;
                    } else if (pattern.source.includes('一二三四五六日') && pattern.source.includes('\\d{1,2}:\\d{2}')) {
                        // 處理包含星期和時間的情況：六 16:00-18:00 代課
                        const weekday = match[1];
                        const startTime = match[2];
                        const endTime = match[3];
                        const location = match[4] || '';
                        
                        // 轉換時間格式：09:30 -> 0930, 16:00 -> 1600
                        const formatTime = (time) => {
                            const [hours, minutes] = time.split(':');
                            return hours.padStart(2, '0') + minutes;
                        };
                        const formattedStartTime = formatTime(startTime);
                        const formattedEndTime = formatTime(endTime);
                        
                        courseName = fullTitle.replace(new RegExp(`${weekday}\\s+${startTime}-${endTime}\\s*${location}.*$`), '').trim();
                        timeInfo = `${weekday} ${formattedStartTime}-${formattedEndTime}${location ? ' ' + location : ''}`;
                        break;
                    } else if (pattern.source.includes('一二三四五六日') && pattern.source.includes('\\d{3,4}')) {
                        // 處理星期和沒有冒號的時間格式：六 1530-1700 到府
                        const weekday = match[1];
                        const startTime = match[2];
                        const endTime = match[3];
                        const location = match[4] || '';
                        
                        // 確保時間格式正確（補零）
                        const formatTime = (time) => {
                            const timeStr = time.toString();
                            return timeStr.padStart(4, '0');
                        };
                        const formattedStartTime = formatTime(startTime);
                        const formattedEndTime = formatTime(endTime);
                        
                        courseName = fullTitle.replace(new RegExp(`${weekday}\\s+${startTime}-${endTime}\\s*${location}.*$`), '').trim();
                        timeInfo = `${weekday} ${formattedStartTime}-${formattedEndTime}${location ? ' ' + location : ''}`;
                        break;
                    } else if (pattern.source.includes('一二三四五六日')) {
                        // 處理只有星期和時間的情況：六 16:00-18:00
                        const weekday = match[1];
                        const startTime = match[2];
                        const endTime = match[3];
                        
                        // 轉換時間格式：09:30 -> 0930, 16:00 -> 1600
                        const formatTime = (time) => {
                            const [hours, minutes] = time.split(':');
                            return hours.padStart(2, '0') + minutes;
                        };
                        const formattedStartTime = formatTime(startTime);
                        const formattedEndTime = formatTime(endTime);
                        
                        courseName = fullTitle.replace(new RegExp(`${weekday}\\s+${startTime}-${endTime}.*$`), '').trim();
                        timeInfo = `${weekday} ${formattedStartTime}-${formattedEndTime}`;
                        break;
                    } else if (pattern.source.includes('\\d{3,4}') && !pattern.source.includes('一二三四五六日')) {
                        // 處理沒有冒號的純時間格式：1530-1700 到府
                        const startTime = match[1];
                        const endTime = match[2];
                        const location = match[3] || '';
                        
                        // 確保時間格式正確（補零）
                        const formatTime = (time) => {
                            const timeStr = time.toString();
                            return timeStr.padStart(4, '0');
                        };
                        const formattedStartTime = formatTime(startTime);
                        const formattedEndTime = formatTime(endTime);
                        
                        courseName = fullTitle.replace(new RegExp(`${startTime}-${endTime}\\s*${location}.*$`), '').trim();
                        timeInfo = `${formattedStartTime}-${formattedEndTime}${location ? ' ' + location : ''}`;
                        break;
                    } else if (pattern.source.includes('\\d{1,2}:\\d{2}')) {
                        // 處理只有時間的情況：16:00-18:00 到府
                        const startTime = match[1];
                        const endTime = match[2];
                        const location = match[3] || '';
                        
                        // 轉換時間格式：09:30 -> 0930, 16:00 -> 1600
                        const formatTime = (time) => {
                            const [hours, minutes] = time.split(':');
                            return hours.padStart(2, '0') + minutes;
                        };
                        const formattedStartTime = formatTime(startTime);
                        const formattedEndTime = formatTime(endTime);
                        
                        courseName = fullTitle.replace(new RegExp(`${startTime}-${endTime}\\s*${location}.*$`), '').trim();
                        timeInfo = `${formattedStartTime}-${formattedEndTime}${location ? ' ' + location : ''}`;
                        break;
                    }
                }
            }

            // 如果沒有匹配到時間模式，嘗試簡單的分割
            if (timeInfo === '') {
                // 檢查是否包含時間格式
                const timeMatch = fullTitle.match(/(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/);
                if (timeMatch) {
                    const timeIndex = fullTitle.indexOf(timeMatch[0]);
                    courseName = fullTitle.substring(0, timeIndex).trim();
                    timeInfo = fullTitle.substring(timeIndex).trim();
                }
            }

            // 清理課程名稱
            courseName = courseName.replace(/[第\d+週請假].*$/, '').trim();
            
            // 如果課程名稱為空，使用原始標題
            if (!courseName) {
                courseName = fullTitle;
                timeInfo = '';
            }

            // 從時間資訊中移除特殊事件類型
            timeInfo = removeSpecialEventTypes(timeInfo);

            console.log(`✅ 解析結果: 課程="${courseName}", 時間="${timeInfo}"`);
            
            return { courseName, timeInfo };
        }

        // 獲取可用講師列表
        async function getAvailableInstructors() {
            try {
                const response = await fetch('/api/teachers');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.teachers) {
                        return data.teachers.map(teacher => teacher.name);
                    }
                }
            } catch (error) {
                console.warn('無法獲取講師列表，使用預設列表:', error);
            }
            
            // 返回預設講師列表
            return ['Yoki', 'Tim', 'Ted', 'Agnes', 'Hansen', 'James', 'Ivan', 'Xian', 'Eason', 'Bella', 'Gillian', 'Daniel', 'Philp', 'Tony', 'Jacky', 'Weinie', 'test', 'Dirty', 'Melody'];
        }

        // 處理直接簽到
        async function handleDirectAttendance(title, instructor, start, end) {
            try {
                console.log('🎯 處理直接簽到:', { title, instructor, start, end });
                
                // 解析課程標題，分離課程名稱和時間資訊
                const { courseName, timeInfo } = parseCourseTitle(title);
                console.log(`📝 解析結果: 課程="${courseName}", 時間資訊="${timeInfo}"`);
                
                // 獲取可用講師列表並進行模糊比對
                const availableInstructors = await getAvailableInstructors();
                const matchedInstructor = findMatchingInstructor(instructor, availableInstructors);
                
                if (!matchedInstructor) {
                    const errorMsg = `講師 "${instructor}" 不存在。可用的講師：${availableInstructors.join(', ')}`;
                    console.error('❌', errorMsg);
                    alert(errorMsg);
                    return;
                }

                // 如果找到匹配的講師，使用匹配的名稱
                if (matchedInstructor !== instructor) {
                    console.log(`🔄 講師名稱已修正: "${instructor}" → "${matchedInstructor}"`);
                    instructor = matchedInstructor;
                }
                
                // 使用解析後的課程名稱和時間資訊
                const finalCourseName = courseName;
                const finalTimeString = timeInfo || `${new Date(start).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })} - ${new Date(end).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}`;
                
                // 開啟原生簽到系統
                await openNativeAttendanceSystem(matchedInstructor, finalCourseName, finalTimeString, start, end);
                
            } catch (error) {
                console.error('❌ 直接簽到失敗:', error);
                alert('直接簽到失敗: ' + error.message);
            }
        }

        // 開啟原生簽到系統
        async function openNativeAttendanceSystem(teacher, course, time, start, end) {
            try {
                console.log('🎯 開啟原生簽到系統:', { teacher, course, time, start, end });
                
                // 創建簽到系統模態框
                const modal = document.createElement('div');
                modal.id = 'attendanceModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease-out;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 15px;
                        padding: 30px;
                        max-width: 90%;
                        max-height: 90%;
                        width: 800px;
                        overflow-y: auto;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        animation: slideInUp 0.3s ease-out;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #333; font-size: 1.5rem;">
                                <i class="fas fa-calendar-check" style="color: #667eea; margin-right: 10px;"></i>
                                課程簽到系統
                            </h2>
                            <button id="closeAttendanceModal" style="
                                background: none;
                                border: none;
                                font-size: 1.5rem;
                                color: #999;
                                cursor: pointer;
                                padding: 5px;
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">×</button>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="font-weight: bold; color: #666; font-size: 0.9rem;">講師</label>
                                    <div style="font-size: 1.1rem; color: #333;">${teacher}</div>
                                </div>
                                <div>
                                    <label style="font-weight: bold; color: #666; font-size: 0.9rem;">課程</label>
                                    <div style="font-size: 1.1rem; color: #333;">${course}</div>
                                </div>
                                <div>
                                    <label style="font-weight: bold; color: #666; font-size: 0.9rem;">時間</label>
                                    <div style="font-size: 1.1rem; color: #333;">${time}</div>
                                </div>
                                <div>
                                    <label style="font-weight: bold; color: #666; font-size: 0.9rem;">日期</label>
                                    <div style="font-size: 1.1rem; color: #333;">${new Date(start).toLocaleDateString('zh-TW')}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="attendanceContent">
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea; margin-bottom: 15px;"></i>
                                <p style="color: #666; margin: 0;">載入學生名單中...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 添加關閉按鈕事件
                document.getElementById('closeAttendanceModal').addEventListener('click', () => {
                    closeAttendanceModal();
                });
                
                // 點擊背景關閉
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeAttendanceModal();
                    }
                });
                
                // 載入學生名單
                await loadCourseStudents(teacher, course, time, start, end);
                
            } catch (error) {
                console.error('❌ 開啟原生簽到系統失敗:', error);
                alert('開啟簽到系統失敗: ' + error.message);
            }
        }
        
        // 載入課程學生名單
        async function loadCourseStudents(teacher, course, time, start, end) {
            try {
                console.log('📚 載入課程學生名單:', { teacher, course, time });
                
                // 模擬學生名單（實際應用中應該從 API 獲取）
                const students = await getCourseStudents(teacher, course, time);
                
                const content = document.getElementById('attendanceContent');
                if (!content) return;
                
                if (students.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                            <h3 style="margin: 0 0 10px 0;">暫無學生名單</h3>
                            <p style="margin: 0;">此課程目前沒有學生註冊</p>
                        </div>
                    `;
                    return;
                }
                
                // 獲取今天的日期
                const today = new Date().toISOString().split('T')[0];
                
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #333;">
                            <i class="fas fa-users" style="color: #667eea; margin-right: 8px;"></i>
                            學生名單 (${students.length} 人)
                        </h3>
                    </div>
                    
                    <div id="studentsList" style="display: grid; gap: 15px; margin-bottom: 20px;">
                        ${students.map(student => {
                            // 檢查今天的簽到狀態
                            const todayAttendance = student.attendance.find(record => record.date === today);
                            let currentStatus = null;
                            let statusText = '';
                            
                            if (todayAttendance) {
                                if (todayAttendance.present === true) {
                                    currentStatus = 'present';
                                    statusText = '已出席';
                                } else if (todayAttendance.present === false) {
                                    currentStatus = 'absent';
                                    statusText = '已缺席';
                                } else if (todayAttendance.present === 'leave') {
                                    currentStatus = 'leave';
                                    statusText = '已請假';
                                }
                            }
                            
                            return `
                                <div class="student-item ${currentStatus ? currentStatus : ''}" data-student-id="${student.id}" style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    padding: 15px 20px;
                                    border: 2px solid ${currentStatus ? 
                                        (currentStatus === 'present' ? '#28a745' : 
                                         currentStatus === 'absent' ? '#dc3545' : '#ffc107') : '#e9ecef'};
                                    border-radius: 10px;
                                    background: ${currentStatus ? 
                                        (currentStatus === 'present' ? 'linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1))' : 
                                         currentStatus === 'absent' ? 'linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(231, 76, 60, 0.1))' : 
                                         'linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(243, 156, 18, 0.1))') : 'white'};
                                    transition: all 0.3s ease;
                                ">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <div style="
                                            width: 40px;
                                            height: 40px;
                                            border-radius: 50%;
                                            background: linear-gradient(135deg, #667eea, #764ba2);
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            font-weight: bold;
                                            font-size: 1.1rem;
                                        ">
                                            ${student.name.charAt(0)}
                                        </div>
                                        <div>
                                            <div style="font-weight: bold; color: #333; font-size: 1.1rem;">${student.name}</div>
                                            <div style="color: #666; font-size: 0.9rem;">${student.id}</div>
                                            ${statusText ? `<div style="color: #666; font-size: 0.8rem; margin-top: 2px;">${statusText}</div>` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="attendance-btn present-btn" data-student-id="${student.id}" style="
                                            background: linear-gradient(135deg, #28a745, #20c997);
                                            color: white;
                                            border: none;
                                            padding: 8px 16px;
                                            border-radius: 20px;
                                            cursor: pointer;
                                            font-size: 0.9rem;
                                            font-weight: 500;
                                            transition: all 0.3s ease;
                                            opacity: 1;
                                            ${currentStatus === 'present' ? 'transform: scale(1.05); box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);' : ''}
                                        ">
                                            <i class="fas fa-check"></i> 出席
                                        </button>
                                        <button class="attendance-btn absent-btn" data-student-id="${student.id}" style="
                                            background: linear-gradient(135deg, #dc3545, #e74c3c);
                                            color: white;
                                            border: none;
                                            padding: 8px 16px;
                                            border-radius: 20px;
                                            cursor: pointer;
                                            font-size: 0.9rem;
                                            font-weight: 500;
                                            transition: all 0.3s ease;
                                            opacity: 1;
                                            ${currentStatus === 'absent' ? 'transform: scale(1.05); box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);' : ''}
                                        ">
                                            <i class="fas fa-times"></i> 缺席
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <div style="color: #666;">
                            <span id="attendanceStats">已簽到: 0 / ${students.length}</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="saveAttendance" style="
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 25px;
                                cursor: pointer;
                                font-weight: 600;
                                transition: all 0.3s ease;
                            ">
                                <i class="fas fa-save"></i> 儲存簽到記錄
                            </button>
                        </div>
                    </div>
                `;
                
                // 添加事件監聽器
                setupAttendanceEventListeners(teacher, course, time, start, end);
                
            } catch (error) {
                console.error('❌ 載入學生名單失敗:', error);
                const content = document.getElementById('attendanceContent');
                if (content) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h3 style="margin: 0 0 10px 0;">載入失敗</h3>
                            <p style="margin: 0;">無法載入學生名單，請稍後再試</p>
                        </div>
                    `;
                }
            }
        }
        
        // 獲取課程學生名單（通過後端代理）
        async function getCourseStudents(teacher, course, time) {
            try {
                console.log('📚 通過後端代理獲取學生名單:', { teacher, course, time });
                
                // 清理課程名稱和時間格式
                const cleanCourse = course.trim();
                const cleanTime = time.trim();
                
                console.log('🔍 清理後的參數:', { cleanCourse, cleanTime });
                
                // 使用後端代理 API
                const proxyUrl = '/api/proxy/google-sheets';
                const payload = {
                    action: 'getRosterAttendance',
                    course: cleanCourse,
                    period: cleanTime
                };
                
                console.log('📤 發送代理請求:', { proxyUrl, payload });
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`代理 API 請求失敗: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📥 代理 API 回應:', data);
                
                if (!data.success) {
                    throw new Error(`API 錯誤: ${data.error || '未知錯誤'}`);
                }
                
                if (!data.students || !Array.isArray(data.students)) {
                    console.log('⚠️ 沒有學生資料，返回空陣列');
                    return [];
                }
                
                // 轉換 API 資料格式
                const students = data.students.map((student, index) => {
                    return {
                        id: student.id || `S${String(index + 1).padStart(3, '0')}`,
                        name: student.name || '未知學生',
                        attendance: student.attendance || [],
                        remaining: student.remaining || 0,
                        foundInCourseSheet: student.foundInCourseSheet || false
                    };
                });
                
                console.log('✅ 成功獲取學生名單:', students.length, '人');
                return students;
                
            } catch (error) {
                console.error('❌ 獲取學生名單失敗:', error);
                
                // 如果 API 失敗，返回模擬資料作為備用
                console.log('🔄 使用模擬資料作為備用');
                const mockStudents = [
                    { id: 'S001', name: '張小明', attendance: [], remaining: 0, foundInCourseSheet: false },
                    { id: 'S002', name: '李美華', attendance: [], remaining: 0, foundInCourseSheet: false },
                    { id: 'S003', name: '王大偉', attendance: [], remaining: 0, foundInCourseSheet: false },
                    { id: 'S004', name: '陳小芳', attendance: [], remaining: 0, foundInCourseSheet: false },
                    { id: 'S005', name: '林志強', attendance: [], remaining: 0, foundInCourseSheet: false },
                    { id: 'S006', name: '黃淑芬', attendance: [], remaining: 0, foundInCourseSheet: false },
                    { id: 'S007', name: '劉建國', attendance: [], remaining: 0, foundInCourseSheet: false },
                    { id: 'S008', name: '吳雅婷', attendance: [], remaining: 0, foundInCourseSheet: false }
                ];
                
                return mockStudents;
            }
        }
        
        // 設置簽到事件監聽器
        function setupAttendanceEventListeners(teacher, course, time, start, end) {
            const attendanceData = new Map();
            
            // 出席按鈕
            document.querySelectorAll('.present-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.dataset.studentId;
                    const currentStatus = attendanceData.get(studentId);
                    
                    // 如果已經是出席狀態，則取消選擇
                    if (currentStatus === 'present') {
                        attendanceData.delete(studentId);
                        updateStudentStatus(studentId, null);
                    } else {
                        // 設定為出席狀態
                        attendanceData.set(studentId, 'present');
                        updateStudentStatus(studentId, 'present');
                    }
                    updateAttendanceStats();
                });
            });
            
            // 缺席按鈕
            document.querySelectorAll('.absent-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.dataset.studentId;
                    const currentStatus = attendanceData.get(studentId);
                    
                    // 如果已經是缺席狀態，則取消選擇
                    if (currentStatus === 'absent') {
                        attendanceData.delete(studentId);
                        updateStudentStatus(studentId, null);
                    } else {
                        // 設定為缺席狀態
                        attendanceData.set(studentId, 'absent');
                        updateStudentStatus(studentId, 'absent');
                    }
                    updateAttendanceStats();
                });
            });
            
            
            // 儲存按鈕
            document.getElementById('saveAttendance').addEventListener('click', async function() {
                await saveAttendanceRecords(teacher, course, time, start, end, attendanceData);
            });
        }
        
        // 更新學生狀態
        function updateStudentStatus(studentId, status) {
            const studentItem = document.querySelector(`[data-student-id="${studentId}"]`);
            if (!studentItem) return;
            
            // 移除所有狀態樣式
            studentItem.classList.remove('present', 'absent', 'leave');
            
            // 更新按鈕狀態
            const buttons = studentItem.querySelectorAll('.attendance-btn');
            buttons.forEach(btn => {
                // 重置所有按鈕樣式
                btn.style.opacity = '1';
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = 'none';
            });
            
            // 如果有選擇狀態，則添加樣式和高亮
            if (status) {
                studentItem.classList.add(status);
                
                // 高亮選中的按鈕
                const selectedBtn = studentItem.querySelector(`.${status}-btn`);
                if (selectedBtn) {
                    selectedBtn.style.transform = 'scale(1.05)';
                    selectedBtn.style.boxShadow = status === 'present' ? 
                        '0 4px 8px rgba(40, 167, 69, 0.3)' : 
                        '0 4px 8px rgba(220, 53, 69, 0.3)';
                }
            }
        }
        
        // 更新簽到統計
        function updateAttendanceStats() {
            const stats = document.getElementById('attendanceStats');
            if (!stats) return;
            
            const totalStudents = document.querySelectorAll('.student-item').length;
            const attendedStudents = document.querySelectorAll('.student-item.present, .student-item.absent, .student-item.leave').length;
            
            // 計算各種狀態的數量
            const presentCount = document.querySelectorAll('.student-item.present').length;
            const absentCount = document.querySelectorAll('.student-item.absent').length;
            const leaveCount = document.querySelectorAll('.student-item.leave').length;
            
            let statusText = `已簽到: ${attendedStudents} / ${totalStudents}`;
            if (attendedStudents > 0) {
                statusText += ` (出席: ${presentCount}, 缺席: ${absentCount}, 請假: ${leaveCount})`;
            }
            
            stats.textContent = statusText;
        }
        
        // 儲存簽到記錄（通過後端代理）
        async function saveAttendanceRecords(teacher, course, time, start, end, attendanceData) {
            try {
                console.log('💾 通過後端代理儲存簽到記錄:', { teacher, course, time, attendanceData });
                
                if (attendanceData.size === 0) {
                    alert('請先選擇學生的簽到狀態');
                    return;
                }
                
                // 獲取今天的日期
                const today = new Date().toISOString().split('T')[0];
                
                // 構建簽到記錄（使用學生姓名）
                const attendanceRecords = [];
                for (const [studentId, status] of attendanceData) {
                    // 獲取學生姓名
                    const studentItem = document.querySelector(`[data-student-id="${studentId}"]`);
                    const studentName = studentItem ? 
                        studentItem.querySelector('.student-name')?.textContent || studentId : 
                        studentId;
                    
                    attendanceRecords.push({
                        studentName: studentName,
                        studentId: studentId,
                        date: today,
                        present: status === 'present' ? true : status === 'absent' ? false : 'leave',
                        teacher: teacher,
                        course: course,
                        time: time
                    });
                }
                
                console.log('📤 準備儲存的簽到記錄:', attendanceRecords);
                
                // 使用後端代理 API
                const proxyUrl = '/api/proxy/google-sheets';
                const payload = {
                    action: 'updateAttendance',
                    records: attendanceRecords
                };
                
                console.log('📤 發送代理請求:', { proxyUrl, payload });
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`代理 API 請求失敗: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📥 代理 API 回應:', data);
                
                if (!data.success) {
                    throw new Error(`API 錯誤: ${data.error || '未知錯誤'}`);
                }
                
                // 顯示成功訊息
                const successCount = data.results ? data.results.filter(r => r.success !== false).length : attendanceData.size;
                showSuccessMessage(`簽到記錄已儲存！成功 ${successCount}/${attendanceData.size} 筆記錄`);
                
                // 關閉模態框
                closeAttendanceModal();
                
            } catch (error) {
                console.error('❌ 儲存簽到記錄失敗:', error);
                
                // 如果 API 失敗，顯示警告但繼續
                console.log('⚠️ API 儲存失敗，但本地狀態已更新');
                showSuccessMessage(`簽到記錄已更新（本地）！共 ${attendanceData.size} 筆記錄`);
                
                // 關閉模態框
                closeAttendanceModal();
            }
        }
        
        // 關閉簽到模態框
        function closeAttendanceModal() {
            const modal = document.getElementById('attendanceModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-in';
                setTimeout(() => {
                    if (modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                }, 300);
            }
        }
        
        // 顯示成功訊息
        function showSuccessMessage(message) {
            // 創建臨時提示訊息
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #00ff00, #00cc00);
                color: #000;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 255, 0, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 3秒後自動移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // 測試課程解析功能
        function testCourseParsing() {
            console.log('🧪 測試課程解析功能...');
            
            const testCases = [
                'SPIKE 六 16:00-18:00 第2週 代課',
                'SPM 六 9:30-10:30 到府 第4週請假',
                '數學 一 14:00-15:30 教室A',
                '英文 9:30-10:30 線上',
                '物理 第3週',
                '化學 請假',
                '生物 9:30-10:30',
                '簡單課程',
                // 特殊事件類型測試
                'SPIKE 六 16:00-18:00 代課',
                'SPM 六 9:30-10:30 停課',
                '數學 一 14:00-15:30 體驗',
                '英文 9:30-10:30 補課',
                '物理 16:00-18:00 代理',
                '化學 9:30-10:30 支援',
                '生物 14:00-15:30 體課',
                '歷史 16:00-18:00 調課'
            ];
            
            testCases.forEach(testCase => {
                const result = parseCourseTitle(testCase);
                console.log(`📝 測試: "${testCase}"`);
                console.log(`   課程: "${result.courseName}"`);
                console.log(`   時間: "${result.timeInfo}"`);
                console.log('---');
            });
        }
        
        // 強制重新整理
        async function forceRefresh() {
            console.log('🔄 開始強制重新整理...');
            
            const refreshButton = document.getElementById('refreshButton');
            refreshButton.style.transform = 'rotate(360deg)';
            refreshButton.style.opacity = '0.7';
            
            try {
                await loadCalendarData();
                await loadInstructors();
                updateStats();
                renderEvents();
                
                console.log('✅ 重新整理完成');
            } catch (error) {
                console.error('❌ 重新整理失敗:', error);
            } finally {
                setTimeout(() => {
                    refreshButton.style.transform = '';
                    refreshButton.style.opacity = '';
                }, 1000);
            }
        }

        // 錯誤處理
        function showError(message) {
            console.error('❌ 錯誤:', message);
            alert('錯誤: ' + message);
        }
    </script>
</body>
</html>
