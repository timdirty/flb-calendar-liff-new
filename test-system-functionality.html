<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦ç³»çµ±åŠŸèƒ½é©—è­‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .test-section h3 {
            color: #007bff;
            margin-top: 0;
        }
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .test-item:last-child {
            border-bottom: none;
        }
        .test-name {
            font-weight: 500;
            color: #333;
        }
        .test-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 10px 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-success {
            color: #28a745;
        }
        .log-error {
            color: #dc3545;
        }
        .log-info {
            color: #007bff;
        }
        .log-warning {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æ¸¬è©¦ç³»çµ±åŠŸèƒ½é©—è­‰</h1>
            <p>é©—è­‰æ¸¬è©¦ç³»çµ±çš„å„é …åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œ</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“¡ API é€£æ¥æ¸¬è©¦</h3>
            <div class="test-item">
                <span class="test-name">è¡Œäº‹æ›†è³‡æ–™ API (/api/events)</span>
                <span class="test-status status-pending" id="calendar-api-status">æ¸¬è©¦ä¸­...</span>
            </div>
            <div class="test-item">
                <span class="test-name">è¬›å¸«åˆ—è¡¨ API (/api/teachers)</span>
                <span class="test-status status-pending" id="teachers-api-status">æ¸¬è©¦ä¸­...</span>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ¨ å‰ç«¯åŠŸèƒ½æ¸¬è©¦</h3>
            <div class="test-item">
                <span class="test-name">äº‹ä»¶ç›£è½å™¨ç¶å®š</span>
                <span class="test-status status-pending" id="event-listeners-status">æ¸¬è©¦ä¸­...</span>
            </div>
            <div class="test-item">
                <span class="test-name">CSP åˆè¦æ€§</span>
                <span class="test-status status-pending" id="csp-status">æ¸¬è©¦ä¸­...</span>
            </div>
            <div class="test-item">
                <span class="test-name">ç›´æ¥ç°½åˆ°æŒ‰éˆ•ç”Ÿæˆ</span>
                <span class="test-status status-pending" id="direct-attendance-status">æ¸¬è©¦ä¸­...</span>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”— å¤–éƒ¨æœå‹™æ¸¬è©¦</h3>
            <div class="test-item">
                <span class="test-name">LIFF ç°½åˆ°ç³»çµ±é€£æ¥</span>
                <span class="test-status status-pending" id="liff-status">æ¸¬è©¦ä¸­...</span>
            </div>
            <div class="test-item">
                <span class="test-name">CalDAV è³‡æ–™æ ¼å¼</span>
                <span class="test-status status-pending" id="caldav-format-status">æ¸¬è©¦ä¸­...</span>
            </div>
            <div class="test-item">
                <span class="test-name">æ¨¡ç³Šæ¯”å°åŠŸèƒ½</span>
                <span class="test-status status-pending" id="fuzzy-matching-status">æ¸¬è©¦ä¸­...</span>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="runAllTests()">ğŸš€ åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <button class="btn btn-success" onclick="openTestSystem()">ğŸ“± é–‹å•Ÿæ¸¬è©¦ç³»çµ±</button>
            <button class="btn btn-warning" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
        </div>

        <div class="log" id="test-log">
            <div class="log-entry log-info">æº–å‚™é–‹å§‹æ¸¬è©¦...</div>
        </div>
    </div>

    <script>
        let testResults = {
            calendarApi: false,
            teachersApi: false,
            eventListeners: false,
            cspCompliant: false,
            directAttendance: false,
            liffConnection: false,
            caldavFormat: false,
            fuzzyMatching: false
        };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `test-status status-${status}`;
        }

        async function testCalendarAPI() {
            try {
                log('æ¸¬è©¦è¡Œäº‹æ›† API...', 'info');
                const response = await fetch('/api/events');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        testResults.calendarApi = true;
                        updateStatus('calendar-api-status', 'success', `âœ… æˆåŠŸ (${data.data.length} å€‹äº‹ä»¶)`);
                        log(`è¡Œäº‹æ›† API æ¸¬è©¦æˆåŠŸ: ${data.data.length} å€‹äº‹ä»¶`, 'success');
                    } else {
                        throw new Error('è³‡æ–™æ ¼å¼ä¸æ­£ç¢º');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                testResults.calendarApi = false;
                updateStatus('calendar-api-status', 'error', `âŒ å¤±æ•—: ${error.message}`);
                log(`è¡Œäº‹æ›† API æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testTeachersAPI() {
            try {
                log('æ¸¬è©¦è¬›å¸« API...', 'info');
                const response = await fetch('/api/teachers');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.teachers) {
                        testResults.teachersApi = true;
                        updateStatus('teachers-api-status', 'success', `âœ… æˆåŠŸ (${data.teachers.length} å€‹è¬›å¸«)`);
                        log(`è¬›å¸« API æ¸¬è©¦æˆåŠŸ: ${data.teachers.length} å€‹è¬›å¸«`, 'success');
                    } else {
                        throw new Error('è³‡æ–™æ ¼å¼ä¸æ­£ç¢º');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                testResults.teachersApi = false;
                updateStatus('teachers-api-status', 'error', `âŒ å¤±æ•—: ${error.message}`);
                log(`è¬›å¸« API æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testEventListeners() {
            try {
                log('æ¸¬è©¦äº‹ä»¶ç›£è½å™¨...', 'info');
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å…§è¯äº‹ä»¶è™•ç†å™¨
                const inlineHandlers = document.querySelectorAll('[onclick]');
                if (inlineHandlers.length > 0) {
                    throw new Error(`ç™¼ç¾ ${inlineHandlers.length} å€‹å…§è¯äº‹ä»¶è™•ç†å™¨`);
                }

                // æª¢æŸ¥æ˜¯å¦æœ‰å…§è¯æ¨£å¼
                const inlineStyles = document.querySelectorAll('[style]');
                const problematicStyles = Array.from(inlineStyles).filter(el => 
                    el.getAttribute('style').includes('javascript:') || 
                    el.getAttribute('style').includes('onclick')
                );
                
                if (problematicStyles.length > 0) {
                    throw new Error(`ç™¼ç¾ ${problematicStyles.length} å€‹å•é¡Œæ¨£å¼`);
                }

                testResults.eventListeners = true;
                updateStatus('event-listeners-status', 'success', 'âœ… é€šé');
                log('äº‹ä»¶ç›£è½å™¨æ¸¬è©¦é€šé', 'success');
            } catch (error) {
                testResults.eventListeners = false;
                updateStatus('event-listeners-status', 'error', `âŒ å¤±æ•—: ${error.message}`);
                log(`äº‹ä»¶ç›£è½å™¨æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testCSPCompliance() {
            try {
                log('æ¸¬è©¦ CSP åˆè¦æ€§...', 'info');
                
                // æª¢æŸ¥å…§è¯äº‹ä»¶è™•ç†å™¨
                const inlineEvents = document.querySelectorAll('[onclick], [onload], [onerror]');
                if (inlineEvents.length > 0) {
                    throw new Error(`ç™¼ç¾ ${inlineEvents.length} å€‹å…§è¯äº‹ä»¶è™•ç†å™¨`);
                }

                // æª¢æŸ¥å…§è¯æ¨£å¼ä¸­çš„ JavaScript
                const inlineStyles = document.querySelectorAll('[style]');
                const jsInStyles = Array.from(inlineStyles).filter(el => 
                    el.getAttribute('style').toLowerCase().includes('javascript:')
                );
                
                if (jsInStyles.length > 0) {
                    throw new Error(`ç™¼ç¾ ${jsInStyles.length} å€‹æ¨£å¼ä¸­çš„ JavaScript`);
                }

                testResults.cspCompliant = true;
                updateStatus('csp-status', 'success', 'âœ… åˆè¦');
                log('CSP åˆè¦æ€§æ¸¬è©¦é€šé', 'success');
            } catch (error) {
                testResults.cspCompliant = false;
                updateStatus('csp-status', 'error', `âŒ ä¸åˆè¦: ${error.message}`);
                log(`CSP åˆè¦æ€§æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testDirectAttendance() {
            try {
                log('æ¸¬è©¦ç›´æ¥ç°½åˆ°åŠŸèƒ½...', 'info');
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ç›´æ¥ç°½åˆ°æŒ‰éˆ•çš„æ¨£å¼
                const styleSheet = document.styleSheets[0];
                let hasDirectAttendanceStyle = false;
                
                try {
                    for (let rule of styleSheet.cssRules) {
                        if (rule.selectorText && rule.selectorText.includes('btn-direct-attendance')) {
                            hasDirectAttendanceStyle = true;
                            break;
                        }
                    }
                } catch (e) {
                    // è·¨åŸŸæ¨£å¼è¡¨ç„¡æ³•è¨ªå•
                    hasDirectAttendanceStyle = true; // å‡è¨­å­˜åœ¨
                }

                if (!hasDirectAttendanceStyle) {
                    throw new Error('ç¼ºå°‘ç›´æ¥ç°½åˆ°æŒ‰éˆ•æ¨£å¼');
                }

                testResults.directAttendance = true;
                updateStatus('direct-attendance-status', 'success', 'âœ… å¯ç”¨');
                log('ç›´æ¥ç°½åˆ°åŠŸèƒ½æ¸¬è©¦é€šé', 'success');
            } catch (error) {
                testResults.directAttendance = false;
                updateStatus('direct-attendance-status', 'error', `âŒ ä¸å¯ç”¨: ${error.message}`);
                log(`ç›´æ¥ç°½åˆ°åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testLiffConnection() {
            try {
                log('æ¸¬è©¦ LIFF é€£æ¥...', 'info');
                
                // æª¢æŸ¥ LIFF URL æ˜¯å¦å¯è¨ªå•
                const liffUrl = 'https://liff.line.me/1657746214-wPgd2qQn';
                const response = await fetch(liffUrl, { method: 'HEAD' });
                
                if (response.ok) {
                    testResults.liffConnection = true;
                    updateStatus('liff-status', 'success', 'âœ… å¯é€£æ¥');
                    log('LIFF é€£æ¥æ¸¬è©¦æˆåŠŸ', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                testResults.liffConnection = false;
                updateStatus('liff-status', 'error', `âŒ ç„¡æ³•é€£æ¥: ${error.message}`);
                log(`LIFF é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testCalDAVFormat() {
            try {
                log('æ¸¬è©¦ CalDAV è³‡æ–™æ ¼å¼...', 'info');
                
                // æª¢æŸ¥æ¸¬è©¦è³‡æ–™æ ¼å¼
                const testEvent = {
                    title: 'æ¸¬è©¦èª²ç¨‹',
                    instructor: 'æ¸¬è©¦è¬›å¸«',
                    start: new Date().toISOString(),
                    end: new Date(Date.now() + 3600000).toISOString(),
                    location: 'æ¸¬è©¦åœ°é»',
                    description: 'æ¸¬è©¦æè¿°'
                };

                // é©—è­‰å¿…è¦æ¬„ä½
                const requiredFields = ['title', 'instructor', 'start', 'end'];
                const missingFields = requiredFields.filter(field => !testEvent[field]);
                
                if (missingFields.length > 0) {
                    throw new Error(`ç¼ºå°‘å¿…è¦æ¬„ä½: ${missingFields.join(', ')}`);
                }

                // é©—è­‰æ—¥æœŸæ ¼å¼
                const startDate = new Date(testEvent.start);
                const endDate = new Date(testEvent.end);
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    throw new Error('æ—¥æœŸæ ¼å¼ä¸æ­£ç¢º');
                }

                testResults.caldavFormat = true;
                updateStatus('caldav-format-status', 'success', 'âœ… æ ¼å¼æ­£ç¢º');
                log('CalDAV è³‡æ–™æ ¼å¼æ¸¬è©¦é€šé', 'success');
            } catch (error) {
                testResults.caldavFormat = false;
                updateStatus('caldav-format-status', 'error', `âŒ æ ¼å¼éŒ¯èª¤: ${error.message}`);
                log(`CalDAV è³‡æ–™æ ¼å¼æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦æ¨¡ç³Šæ¯”å°åŠŸèƒ½
        function testFuzzyMatching() {
            try {
                log('æ¸¬è©¦æ¨¡ç³Šæ¯”å°åŠŸèƒ½...', 'info');
                
                // æ¨¡æ“¬æ¨¡ç³Šæ¯”å°å‡½æ•¸
                function levenshteinDistance(str1, str2) {
                    const matrix = [];
                    const len1 = str1.length;
                    const len2 = str2.length;

                    for (let i = 0; i <= len2; i++) {
                        matrix[i] = [i];
                    }

                    for (let j = 0; j <= len1; j++) {
                        matrix[0][j] = j;
                    }

                    for (let i = 1; i <= len2; i++) {
                        for (let j = 1; j <= len1; j++) {
                            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                                matrix[i][j] = matrix[i - 1][j - 1];
                            } else {
                                matrix[i][j] = Math.min(
                                    matrix[i - 1][j - 1] + 1,
                                    matrix[i][j - 1] + 1,
                                    matrix[i - 1][j] + 1
                                );
                            }
                        }
                    }

                    return matrix[len2][len1];
                }

                function findMatchingInstructor(targetInstructor, availableInstructors) {
                    if (!targetInstructor || !availableInstructors || availableInstructors.length === 0) {
                        return null;
                    }

                    const target = targetInstructor.trim().toLowerCase();
                    
                    // 1. å®Œå…¨åŒ¹é…ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                    let exactMatch = availableInstructors.find(instructor => 
                        instructor.toLowerCase() === target
                    );
                    if (exactMatch) return exactMatch;

                    // 2. åŒ…å«åŒ¹é…
                    let containsMatch = availableInstructors.find(instructor => 
                        instructor.toLowerCase().includes(target) || target.includes(instructor.toLowerCase())
                    );
                    if (containsMatch) return containsMatch;

                    // 3. æ¨¡ç³ŠåŒ¹é…ï¼ˆä½¿ç”¨ Levenshtein è·é›¢ï¼‰
                    let bestMatch = null;
                    let bestScore = Infinity;
                    const threshold = 3;

                    for (const instructor of availableInstructors) {
                        const distance = levenshteinDistance(target, instructor.toLowerCase());
                        if (distance <= threshold && distance < bestScore) {
                            bestScore = distance;
                            bestMatch = instructor;
                        }
                    }

                    return bestMatch;
                }

                // æ¸¬è©¦æ¡ˆä¾‹
                const availableInstructors = ['Yoki', 'Tim', 'Ted', 'Agnes', 'Hansen', 'James', 'Ivan', 'Xian', 'Eason', 'Bella', 'Gillian', 'Daniel', 'Philp', 'Tony', 'Jacky', 'Weinie', 'test', 'Dirty', 'Melody'];
                
                const testCases = [
                    { input: 'TED', expected: 'Ted' },
                    { input: 'ted', expected: 'Ted' },
                    { input: 'BELLA', expected: 'Bella' },
                    { input: 'bella', expected: 'Bella' },
                    { input: 'AGNES', expected: 'Agnes' },
                    { input: 'agnes', expected: 'Agnes' },
                    { input: 'Tim', expected: 'Tim' },
                    { input: 'tim', expected: 'Tim' }
                ];

                let passedTests = 0;
                for (const testCase of testCases) {
                    const result = findMatchingInstructor(testCase.input, availableInstructors);
                    if (result === testCase.expected) {
                        passedTests++;
                        log(`âœ… æ¨¡ç³Šæ¯”å°æ¸¬è©¦é€šé: "${testCase.input}" â†’ "${result}"`, 'success');
                    } else {
                        log(`âŒ æ¨¡ç³Šæ¯”å°æ¸¬è©¦å¤±æ•—: "${testCase.input}" â†’ "${result}" (æœŸæœ›: "${testCase.expected}")`, 'error');
                    }
                }

                if (passedTests === testCases.length) {
                    testResults.fuzzyMatching = true;
                    updateStatus('fuzzy-matching-status', 'success', 'âœ… é€šé');
                    log('æ¨¡ç³Šæ¯”å°åŠŸèƒ½æ¸¬è©¦é€šé', 'success');
                } else {
                    throw new Error(`${passedTests}/${testCases.length} å€‹æ¸¬è©¦æ¡ˆä¾‹é€šé`);
                }
            } catch (error) {
                testResults.fuzzyMatching = false;
                updateStatus('fuzzy-matching-status', 'error', `âŒ å¤±æ•—: ${error.message}`);
                log(`æ¨¡ç³Šæ¯”å°åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            log('ğŸš€ é–‹å§‹åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦...', 'info');
            
            await testCalendarAPI();
            await testTeachersAPI();
            testEventListeners();
            testCSPCompliance();
            testDirectAttendance();
            await testLiffConnection();
            testCalDAVFormat();
            testFuzzyMatching();

            // è¨ˆç®—æ¸¬è©¦çµæœ
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result).length;
            const successRate = Math.round((passedTests / totalTests) * 100);

            log(`ğŸ“Š æ¸¬è©¦å®Œæˆ: ${passedTests}/${totalTests} é€šé (${successRate}%)`, 
                successRate >= 80 ? 'success' : 'warning');

            if (successRate === 100) {
                log('ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼ç³»çµ±é‹è¡Œæ­£å¸¸', 'success');
            } else if (successRate >= 80) {
                log('âš ï¸ å¤§éƒ¨åˆ†æ¸¬è©¦é€šéï¼Œç³»çµ±åŸºæœ¬æ­£å¸¸', 'warning');
            } else {
                log('âŒ å¤šé …æ¸¬è©¦å¤±æ•—ï¼Œéœ€è¦æª¢æŸ¥ç³»çµ±', 'error');
            }
        }

        function openTestSystem() {
            window.open('/test', '_blank');
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '<div class="log-entry log-info">æ—¥èªŒå·²æ¸…é™¤</div>';
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œæ¸¬è©¦
        document.addEventListener('DOMContentLoaded', function() {
            log('é é¢è¼‰å…¥å®Œæˆï¼Œæº–å‚™é–‹å§‹æ¸¬è©¦', 'info');
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>
