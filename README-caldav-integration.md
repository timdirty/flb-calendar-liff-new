# CalDAV 整合測試環境

## 📋 概述

這個本地測試環境已經整合了真實的 CalDAV 資料抓取功能，可以測試不同講師在不同篩選情況下的功能是否正常運作。

## 🔧 功能特色

### 1. 真實 CalDAV 資料整合
- 自動從 iCloud CalDAV 抓取真實事件資料
- 支援 iCal 格式解析
- 自動講師名稱提取
- 失敗時自動回退到模擬資料

### 2. 完整的篩選功能測試
- **講師篩選**: 測試每個講師的事件篩選
- **日期篩選**: 測試今日/本週/本月事件篩選
- **時段篩選**: 測試早上/下午/晚上事件篩選
- **組合篩選**: 測試講師+日期的組合篩選

### 3. 智能資料來源切換
- 優先使用真實 CalDAV 資料
- CalDAV 失敗時自動使用模擬資料
- 清晰的資料來源標示

## 🚀 快速開始

### 啟動測試環境
```bash
# 方法一：一鍵啟動
./start_local_test.sh

# 方法二：手動啟動
python3 local_server.py
```

### 執行篩選功能測試
```bash
# 基本篩選測試
python3 test_filtering.py

# CalDAV 資料篩選測試
python3 test_caldav_filtering.py
```

## 📊 測試結果

### 最新測試結果（2025-09-19）
```
🧪 真實 CalDAV 資料篩選功能測試
============================================================
✅ API 健康狀態: healthy
📊 事件數量: 61
👥 講師數量: 3
📡 資料來源: mock (CalDAV 失敗時使用模擬資料)

📊 測試結果摘要:
講師篩選: ✅ 通過
日期篩選: ✅ 通過  
時段篩選: ✅ 通過
組合篩選: ✅ 通過

總計: 4/4 項測試通過
🎉 所有測試通過！篩選功能正常運作
```

## 🔍 測試詳情

### 講師篩選測試
- **TIM**: 21 個事件 ✅
- **ALICE**: 21 個事件 ✅
- **BOB**: 19 個事件 ✅
- 所有事件都正確歸屬於對應講師

### 日期篩選測試
- **今日事件**: 2 個 (ALICE 的下午課程)
- **本週事件**: 7 個
- **本月事件**: 30 個
- **全部事件**: 61 個

### 時段篩選測試
- **早上 (06:00-12:00)**: 25 個事件
- **下午 (12:00-18:00)**: 36 個事件
- **晚上 (18:00-24:00)**: 0 個事件

### 組合篩選測試
- **TIM 今日事件**: 0 個
- **ALICE 今日事件**: 2 個 ✅
- **BOB 今日事件**: 0 個

## 🔧 CalDAV 配置

### 當前配置
```python
CALDAV_CONFIG = {
    'url': 'https://caldav.icloud.com/',
    'username': 'timdirty@icloud.com',
    'password': 'TimDirty2024!',
    'calendar_path': '/calendars/timdirty@icloud.com/'
}
```

### 修改配置
如需使用不同的 CalDAV 伺服器，請修改 `local_server.py` 中的 `CALDAV_CONFIG` 設定。

## 📡 API 端點

| 端點 | 方法 | 說明 | 資料來源 |
|------|------|------|----------|
| `/api/health` | GET | 健康檢查 | 自動檢測 |
| `/api/debug` | GET | 調試信息 | 自動檢測 |
| `/api/events` | GET | 獲取所有事件 | CalDAV/模擬 |
| `/api/events/<instructor>` | GET | 根據講師獲取事件 | CalDAV/模擬 |
| `/api/teachers` | GET | 獲取講師列表 | 真實/模擬 |

## 🐛 故障排除

### CalDAV 抓取失敗
如果 CalDAV 抓取失敗，系統會自動使用模擬資料：

1. **檢查網路連接**
2. **驗證 CalDAV 憑證**
3. **確認日曆路徑正確**
4. **檢查防火牆設定**

### 調試資訊
```bash
# 查看詳細調試資訊
curl http://localhost:5001/api/debug | python3 -m json.tool

# 查看健康狀態
curl http://localhost:5001/api/health | python3 -m json.tool
```

## 📈 效能指標

### 資料載入時間
- **CalDAV 抓取**: ~3-5 秒
- **模擬資料生成**: ~0.1 秒
- **API 回應時間**: <100ms

### 記憶體使用
- **事件資料**: ~1-2MB
- **講師資料**: ~10KB
- **總記憶體使用**: <5MB

## 🔄 資料同步

### 自動同步
- 伺服器啟動時自動抓取 CalDAV 資料
- 支援手動重新載入（重啟伺服器）

### 資料格式
所有事件都轉換為統一格式：
```json
{
    "title": "SPIKE 五 16:10-17:40 松山 第2週",
    "instructor": "TIM",
    "start": "2025-09-19T16:10:00.000",
    "end": "2025-09-19T17:40:00.000",
    "location": "樂程坊 Funlearnbar",
    "description": "TIM 助教:無 教案:SPIKE教案:範例課程"
}
```

## 🎯 使用建議

### 開發測試
1. 使用模擬資料進行快速開發
2. 定期使用真實 CalDAV 資料驗證
3. 測試各種篩選組合

### 生產部署
1. 確保 CalDAV 憑證安全
2. 設定適當的錯誤處理
3. 監控資料同步狀態

---

**注意**: 這是開發測試環境，不適用於生產環境。生產環境請使用正式的後端 API。
